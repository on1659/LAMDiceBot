<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>LAM Horse Race üêé</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Yeon+Sung&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #8e99a4 0%, #7a8b99 50%, #6b7c8a 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            position: relative;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px auto;
        }
        
        body.lobby-active .container {
            margin-left: auto;
            margin-right: auto;
        }
        
        body.game-active .container {
            margin-left: calc((100vw - 1140px) / 2 + 160px);
            margin-right: auto;
            max-width: 800px;
        }
        
        body.game-active header,
        body.game-active footer {
            display: none;
        }

        h1 {
            text-align: center;
            color: #8b4513;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .lobby-section, .game-section, .create-room-section {
            display: none;
        }

        .lobby-section.active, .game-section.active, .create-room-section.active {
            display: block;
        }
        
        .rooms-list {
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
        }
        
        .room-item {
            background: white;
            border: 2px solid #8b4513;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .room-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 69, 19, 0.3);
        }
        
        .room-item.active {
            background: #f5e6d3;
            border-color: #8b4513;
        }
        
        .room-item.my-room {
            background: #fff3cd;
            border-color: #ffc107;
            border-width: 3px;
        }
        
        .my-room-badge {
            display: inline-block;
            background: #ffc107;
            color: #333;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .room-info {
            flex: 1;
        }
        
        .room-name {
            font-size: 18px;
            font-weight: 600;
            color: #8b4513;
            margin-bottom: 5px;
        }
        
        .room-details {
            font-size: 14px;
            color: #666;
        }
        
        .room-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            margin-top: 5px;
            display: inline-block;
        }
        
        .room-status.playing {
            background: #d4edda;
            color: #155724;
        }
        
        .room-status.waiting {
            background: #e0e0e0;
            color: #666;
        }
        
        .room-action {
            margin-left: 15px;
        }
        
        .room-action button {
            width: auto;
            padding: 10px 20px;
            color: #000;
            font-weight: 600;
        }
        
        .create-room-section {
            background: #f8f9fa;
            border: 2px solid #8b4513;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        button {
            background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%);
            color: #000;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-top: 10px;
            font-weight: 600;
        }
        #cameraSwitchBtn {
            width: auto;
            padding: 2px 8px;
            margin-top: 0;
            font-size: 10px;
            border-radius: 4px;
            background: rgba(0,0,0,0.65);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.3);
            font-weight: normal;
            top: 6px; bottom: auto;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(139, 69, 19, 0.3);
        }

        button:disabled {
            background: #ccc;
            color: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin-bottom: 10px;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus, input[type="password"]:focus {
            border-color: #8b4513;
            outline: none;
        }

        .connection-status {
            text-align: center;
            padding: 5px;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .connection-status.connected {
            color: #28a745;
        }

        .connection-status.disconnected {
            color: #dc3545;
        }

        .connection-sound-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        /* Î≥ºÎ•® Ïª®Ìä∏Î°§ Ïä§ÌÉÄÏùº */
        .volume-control {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #555;
        }
        .volume-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 2px 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .volume-btn:hover {
            background: rgba(0,0,0,0.1);
        }
        .volume-slider {
            width: 60px;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: #ddd;
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: #667eea;
            border-radius: 50%;
            cursor: pointer;
        }
        .volume-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: #667eea;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        .volume-slider.muted {
            opacity: 0.5;
        }

        /* Í≤ΩÏ£º Ìä∏Îûô Ïª®ÌÖåÏù¥ÎÑà - Ïä§ÌÅ¨Î°§ÏùÄ Ïú†ÏßÄ, Ïä§ÌÅ¨Î°§Î∞îÎßå Ïà®ÍπÄ */
        .race-track-container {
            position: relative;
            width: 100%;
            height: 400px;
            margin: 20px 0;
            overflow-x: auto;
            overflow-y: hidden;
            scrollbar-width: none;
            -ms-overflow-style: none;
            border-radius: 12px;
            background: linear-gradient(to bottom, #87CEEB 0%, #98D8C8 50%, #7CB342 100%);
        }
        .race-track-container::-webkit-scrollbar {
            display: none;
        }
        
        /* ÏàúÏúÑ ÌëúÏãú Ïù¥ÌéôÌä∏ */
        .finish-effect {
            /* z-indexÎäî Ïù∏ÎùºÏù∏ Ïä§ÌÉÄÏùºÎ°ú Ï†úÏñ¥ */
        }

        /* Í≤∞ÏäπÏÑ† Ïä§ÌÉÄÏùº */
        .finish-line {
            position: absolute;
            width: 6px;
            background: linear-gradient(to right, #ff0000, #cc0000);
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.8), inset 0 0 10px rgba(255, 255, 255, 0.3);
            z-index: 200;
            pointer-events: none;
            animation: finishLinePulse 1.5s ease-in-out infinite;
        }

        @keyframes countPop {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            70% { transform: scale(0.95); }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.2; }
        }
        @keyframes obstacleJump {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-12px); }
        }
        @keyframes trapSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes finishLinePulse {
            0%, 100% {
                opacity: 1;
                box-shadow: 0 0 10px rgba(255, 0, 0, 0.8), inset 0 0 10px rgba(255, 255, 255, 0.3);
            }
            50% {
                opacity: 0.8;
                box-shadow: 0 0 20px rgba(255, 0, 0, 1), inset 0 0 15px rgba(255, 255, 255, 0.5);
            }
        }

        .race-track {
            position: relative;
            width: 100%;
            height: 100%;
            background-image: url('assets/backgrounds/race_track.png');
            background-repeat: repeat-x;
            background-size: auto 100%;
            background-position: 0 0;
        }

        /* Fallback: Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏùÑ Í≤ΩÏö∞ CSS Í∑∏ÎùºÎç∞Ïù¥ÏÖò */
        .race-track:not([style*="background-image"]) {
            background: linear-gradient(to bottom, 
                #87CEEB 0%, 
                #87CEEB 20%,
                #98D8C8 20%,
                #98D8C8 40%,
                #7CB342 40%,
                #7CB342 60%,
                #98D8C8 60%,
                #98D8C8 80%,
                #87CEEB 80%,
                #87CEEB 100%);
        }

        /* Îßê Ïª®ÌÖåÏù¥ÎÑà */
        .horse {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            z-index: 10;
        }

        /* ÌÉàÍ≤É Ïä§ÌîÑÎùºÏù¥Ìä∏ Ïï†ÎãàÎ©îÏù¥ÏÖò - 2ÌîÑÎ†àÏûÑ */
        .vehicle-sprite {
            position: relative;
            width: 60px;
            height: 45px;
        }
        
        .vehicle-sprite .frame1,
        .vehicle-sprite .frame2 {
            position: absolute;
            top: 0;
            left: 0;
            width: 60px;
            height: 45px;
        }
        
        /* Ï†ïÏßÄ ÏÉÅÌÉú: ÌîÑÎ†àÏûÑ 1Îßå Î≥¥ÏûÑ */
        .vehicle-sprite .frame1 { opacity: 1; }
        .vehicle-sprite .frame2 { opacity: 0; }
        
        /* Îã¨Î¶¨Îäî ÏÉÅÌÉú: 2ÌîÑÎ†àÏûÑ ÍµêÏ∞® */
        @keyframes frame1Anim {
            0%, 49% { opacity: 1; }
            50%, 100% { opacity: 0; }
        }
        @keyframes frame2Anim {
            0%, 49% { opacity: 0; }
            50%, 100% { opacity: 1; }
        }
        
        /* ÎåÄÍ∏∞ ÏÉÅÌÉú: ÎäêÎ¶∞ 2ÌîÑÎ†àÏûÑ ÍµêÏ∞® (Î∞úÍµ¨Î•¥Í∏∞) */
        .horse.idle .vehicle-sprite .frame1 { animation: frame1Anim 0.6s steps(1) infinite; }
        .horse.idle .vehicle-sprite .frame2 { animation: frame2Anim 0.6s steps(1) infinite; }

        /* Îã¨Î¶¨Îäî ÏÉÅÌÉú: Îπ†Î•∏ 2ÌîÑÎ†àÏûÑ ÍµêÏ∞® */
        .horse.racing .vehicle-sprite .frame1 { animation: frame1Anim 0.15s steps(1) infinite; }
        .horse.racing .vehicle-sprite .frame2 { animation: frame2Anim 0.15s steps(1) infinite; }

        /* Ïâ¨Îäî ÏÉÅÌÉú: Îß§Ïö∞ ÎäêÎ¶∞ Ìò∏Ìù° Ïï†ÎãàÎ©îÏù¥ÏÖò */
        .horse.rest .vehicle-sprite .frame1 { animation: frame1Anim 1.5s steps(1) infinite; }
        .horse.rest .vehicle-sprite .frame2 { animation: frame2Anim 1.5s steps(1) infinite; }
        .horse.rest { opacity: 0.7; filter: grayscale(30%); }

        /* ===== Í∏∞ÎØπ Ïù¥ÌéôÌä∏ Ïä§ÌÉÄÏùº ===== */
        
        /* Ïä§ÌîÑÎ¶∞Ìä∏ Î∂àÍΩÉ Ïù¥ÌéôÌä∏ */
        .gimmick-effect-sprint {
            position: absolute;
            left: -35px;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 30px;
            pointer-events: none;
            z-index: 1;
        }
        
        .flame {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-bottom: 25px solid #ff6600;
            filter: blur(1px);
            animation: flameFlicker 0.1s ease-in-out infinite alternate;
        }
        
        .flame:nth-child(1) { left: 0; animation-delay: 0s; border-bottom-color: #ff4400; }
        .flame:nth-child(2) { left: 10px; animation-delay: 0.05s; border-bottom-color: #ff6600; }
        .flame:nth-child(3) { left: 20px; animation-delay: 0.1s; border-bottom-color: #ffaa00; }
        
        .flame-core {
            position: absolute;
            left: 5px;
            top: 5px;
            width: 30px;
            height: 20px;
            background: radial-gradient(ellipse at right, #fff 0%, #ffff00 20%, #ff6600 50%, transparent 70%);
            filter: blur(2px);
            animation: flamePulse 0.15s ease-in-out infinite alternate;
        }
        
        @keyframes flameFlicker {
            0% { transform: scaleY(0.8) rotate(-5deg); opacity: 0.8; }
            100% { transform: scaleY(1.2) rotate(5deg); opacity: 1; }
        }
        
        @keyframes flamePulse {
            0% { transform: scaleX(0.8); opacity: 0.9; }
            100% { transform: scaleX(1.2); opacity: 1; }
        }
        
        /* ÏÜçÎèÑÏÑ† Ïù¥ÌéôÌä∏ */
        .speed-lines {
            position: absolute;
            left: -50px;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 40px;
            pointer-events: none;
            z-index: 0;
        }
        
        .speed-line {
            position: absolute;
            height: 2px;
            background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,100,50,0.8) 50%, rgba(255,200,100,0.5) 100%);
            animation: speedLineMove 0.2s linear infinite;
        }
        
        .speed-line:nth-child(1) { top: 5px; width: 30px; animation-delay: 0s; }
        .speed-line:nth-child(2) { top: 12px; width: 40px; animation-delay: 0.05s; }
        .speed-line:nth-child(3) { top: 19px; width: 35px; animation-delay: 0.1s; }
        .speed-line:nth-child(4) { top: 26px; width: 45px; animation-delay: 0.15s; }
        .speed-line:nth-child(5) { top: 33px; width: 25px; animation-delay: 0.08s; }
        
        @keyframes speedLineMove {
            0% { opacity: 0; transform: translateX(10px); }
            50% { opacity: 1; }
            100% { opacity: 0; transform: translateX(-20px); }
        }
        
        /* Î©àÏ∂§ Î∏åÎ†àÏù¥ÌÅ¨ Ïó∞Í∏∞ Ïù¥ÌéôÌä∏ */
        .gimmick-effect-stop {
            position: absolute;
            left: -20px;
            bottom: -5px;
            width: 50px;
            height: 30px;
            pointer-events: none;
            z-index: 1;
        }
        
        .brake-smoke {
            position: absolute;
            width: 15px;
            height: 15px;
            background: radial-gradient(circle, rgba(100,100,100,0.6) 0%, transparent 70%);
            border-radius: 50%;
            animation: smokeRise 0.5s ease-out infinite;
        }
        
        .brake-smoke:nth-child(1) { left: 0; animation-delay: 0s; }
        .brake-smoke:nth-child(2) { left: 15px; animation-delay: 0.1s; }
        .brake-smoke:nth-child(3) { left: 30px; animation-delay: 0.2s; }
        
        @keyframes smokeRise {
            0% { transform: translateY(0) scale(0.5); opacity: 0.8; }
            100% { transform: translateY(-20px) scale(1.5); opacity: 0; }
        }
        
        /* ÎäêÎ¶º ÌîºÎ°ú Ïù¥ÌéôÌä∏ (ÎïÄÎ∞©Ïö∏) */
        .gimmick-effect-slow {
            position: absolute;
            right: -5px;
            top: -10px;
            width: 20px;
            height: 20px;
            pointer-events: none;
            z-index: 2;
        }
        
        .sweat-drop {
            position: absolute;
            width: 6px;
            height: 10px;
            background: linear-gradient(to bottom, rgba(100,200,255,0.8) 0%, rgba(50,150,255,0.6) 100%);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            animation: sweatFall 0.6s ease-in infinite;
        }
        
        .sweat-drop:nth-child(1) { left: 0; animation-delay: 0s; }
        .sweat-drop:nth-child(2) { left: 10px; animation-delay: 0.3s; }
        
        @keyframes sweatFall {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(15px); opacity: 0; }
        }
        
        /* ÎØ∏ÎÅÑÎü¨Ïßê Î®ºÏßÄ Ïù¥ÌéôÌä∏ */
        .gimmick-effect-slip {
            position: absolute;
            right: -25px;
            bottom: 0;
            width: 40px;
            height: 25px;
            pointer-events: none;
            z-index: 1;
        }
        
        .dust-cloud {
            position: absolute;
            width: 20px;
            height: 15px;
            background: radial-gradient(ellipse, rgba(180,140,100,0.7) 0%, transparent 70%);
            border-radius: 50%;
            animation: dustBurst 0.3s ease-out infinite;
        }
        
        .dust-cloud:nth-child(1) { left: 0; bottom: 0; animation-delay: 0s; }
        .dust-cloud:nth-child(2) { left: 15px; bottom: 5px; animation-delay: 0.1s; }
        
        @keyframes dustBurst {
            0% { transform: scale(0.5) translateX(0); opacity: 0.8; }
            100% { transform: scale(1.5) translateX(15px); opacity: 0; }
        }
        
        /* ÏßÄÍ∑∏Ïû¨Í∑∏ Ïñ¥ÏßÄÎü¨ÏõÄ Ïù¥ÌéôÌä∏ */
        .gimmick-effect-wobble {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 16px;
            pointer-events: none;
            z-index: 2;
            animation: wobbleStars 0.3s ease-in-out infinite;
        }
        
        @keyframes wobbleStars {
            0%, 100% { transform: translateX(-50%) rotate(-10deg); }
            50% { transform: translateX(-50%) rotate(10deg); }
        }
        
        /* Í≤∞Í≥º Ïò§Î≤ÑÎ†àÏù¥ visible ÏÉÅÌÉú */
        .result-overlay.visible {
            display: flex !important;
        }

        /* Îßê ÏÑ†ÌÉù UI */
        .horse-selection-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .horse-selection-button {
            background: white;
            border: 3px solid #8b4513;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 48px;
        }

        .horse-selection-button:hover:not(:disabled) {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(139, 69, 19, 0.3);
            border-color: #a0522d;
        }

        .horse-selection-button.selected {
            background: #f5e6d3;
            border-color: #8b4513;
            border-width: 4px;
        }

        .horse-selection-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            filter: grayscale(80%);
            background: #f0f0f0;
            border-color: #999;
        }

        /* Ï§ÄÎπÑ ÏÑπÏÖò */
        .ready-section {
            background: #f5e6d3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #8b4513;
            font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* Ï§ÄÎπÑ Î≤ÑÌäº hover Ìö®Í≥º */
        #readyButton:hover {
            background: linear-gradient(135deg, #a0522d 0%, #8b4513 100%) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(139, 69, 19, 0.3);
        }

        .users-list {
            background: #faf5ef;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 50px;
        }
        
        /* Ï§ÄÎπÑ ÏÑπÏÖò ÎÇ¥Î∂Ä Î¶¨Ïä§Ìä∏ÎèÑ Í∞àÏÉâÌÜ§ */
        .ready-section .users-list {
            background: #faf5ef;
        }

        .user-tag {
            background: white;
            border: 2px solid #8b4513;
            color: #8b4513;
            padding: 6px 12px;
            font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .user-tag.host {
            background: white;
            color: #8b4513;
        }

        .user-tag.me {
            background: #8b4513;
            color: white;
        }
        
        /* Ï£ºÎ¨∏Î∞õÍ∏∞ ÏÑπÏÖò Ïä§ÌÉÄÏùº */
        .orders-section {
            margin-bottom: 20px;
            display: none;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .orders-section.active {
            display: block;
        }

        .my-order-box {
            background: #fff9e6;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .my-order-title {
            font-size: 16px;
            font-weight: 600;
            color: #856404;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .order-input-group {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            position: relative;
        }

        .order-input-wrapper {
            position: relative;
            width: 100%;
        }

        .autocomplete-suggestion {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 12px;
            color: #999;
            pointer-events: none;
            font-family: inherit;
            font-size: 16px;
            line-height: 1.5;
            border: 2px solid transparent;
            border-radius: 8px;
            z-index: 1;
        }

        #myOrderInput {
            position: relative;
            z-index: 2;
            background-color: transparent;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #8b4513;
            border-radius: 8px;
            margin-top: 4px;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        .autocomplete-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background-color: #fff9e6;
        }

        .menu-manager {
            display: none;
            background: #f8f9fa;
            border: 2px solid #8b4513;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .menu-manager.active {
            display: block;
        }

        .menu-manager-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: bold;
            color: #8b4513;
        }

        .menu-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 5px;
            background: white;
            border: 1px solid #ddd;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
        }

        .menu-item .delete-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 14px;
            padding: 0;
            margin-left: 5px;
        }

        .order-list-container {
            max-height: 300px;
            overflow-y: auto;
        }

        .order-item {
            background: white;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 3px solid #d2b48c;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .order-item:last-child {
            margin-bottom: 0;
        }

        .order-item-left {
            flex: 1;
        }

        .order-user {
            font-weight: 600;
            color: #8b4513;
            margin-bottom: 4px;
        }

        .order-text {
            color: #666;
            font-size: 20px;
            font-weight: 600;
            word-break: break-word;
        }

        .order-text.empty {
            color: #999;
            font-style: italic;
        }

        .order-count {
            font-size: 48px;
            font-weight: bold;
            color: #8b4513;
            margin-left: 15px;
        }

        .sort-buttons {
            display: flex;
            gap: 5px;
        }

        .sort-button {
            padding: 6px 12px;
            font-size: 12px;
            background: #e9ecef;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sort-button:hover {
            background: #dee2e6;
        }

        .sort-button.active {
            background: #8b4513;
            color: white;
        }

        .not-ordered-section {
            margin-bottom: 15px;
            padding: 12px;
            background: #fff5e6;
            border-radius: 8px;
            border-left: 4px solid #ff6b6b;
        }

        .not-ordered-title {
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .not-ordered-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .not-ordered-item {
            background: #ffe6e6;
            color: #cc0000;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Í≤åÏûÑ Í∏∞Î°ù */
        .history-section {
            position: fixed;
            right: 20px;
            top: 20px;
            width: 320px;
            max-height: calc(100vh - 40px);
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            overflow-y: auto;
            display: none;
            z-index: 100;
        }

        .history-section.visible,
        body.game-active .history-section {
            display: block;
        }

        .history-title {
            font-size: 18px;
            font-weight: bold;
            color: #8b4513;
            margin-bottom: 15px;
            font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
        }

        .history-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #8b4513;
        }

        .history-round {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .history-participants {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .history-winner {
            font-size: 16px;
            font-weight: bold;
            color: #8b4513;
        }

        /* Ï±ÑÌåÖ ÏÑπÏÖò */
        .chat-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            border: 2px solid #8b4513;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .chat-messages {
            max-height: 480px;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .chat-message.system {
            margin-bottom: 10px;
            padding: 12px;
            background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%);
            color: white;
            text-align: center;
            font-weight: bold;
            border-radius: 8px;
        }

        .chat-message.winner {
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
            color: #333;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            padding: 15px;
            animation: celebrate 0.5s ease-in-out infinite alternate;
            border-radius: 8px;
        }

        @keyframes celebrate {
            from { transform: scale(1); }
            to { transform: scale(1.02); }
        }

        /* Ï†ëÏÜçÏûê Î™©Î°ù */
        .users-section {
            margin-bottom: 20px;
        }

        .users-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #8b4513;
            font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Î∞© Ï†ïÎ≥¥ Ìó§Îçî */
        .room-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .room-title {
            font-size: 24px;
            color: #8b4513;
            font-weight: bold;
            margin-bottom: 5px;
            font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .host-badge {
            display: none;
            background: #ffc107;
            color: #333;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        /* Ìò∏Ïä§Ìä∏ Ïª®Ìä∏Î°§ */
        .host-controls {
            display: none;
            background: linear-gradient(135deg, #fff3cd 0%, #ffe082 100%);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #ffc107;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .start-button {
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
            color: #000;
            font-size: 20px;
            padding: 15px 30px;
            font-weight: 600;
        }

        .start-button:disabled {
            background: #ccc;
            color: #666;
        }

        .end-button {
            background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
            color: #fff;
            font-weight: 600;
            font-size: 16px;
            padding: 15px 30px;
        }

        /* Í≤∞Í≥º Ïò§Î≤ÑÎ†àÏù¥ */
        .result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .result-overlay.visible {
            display: flex;
        }

        .result-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            animation: popup 0.5s ease-out;
            max-width: 90vw;
            max-height: 85vh;
            overflow-y: auto;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
        }
        
        @media (max-width: 768px) {
            .result-card {
                padding: 20px 15px;
                max-height: 80vh;
                font-size: 14px;
            }
            
            .result-card .result-title {
                font-size: 20px;
            }
        }

        @keyframes popup {
            from {
                transform: scale(0.5);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* ÎèÑÏ∞© Ïï†ÎãàÎ©îÏù¥ÏÖò */
        @keyframes finishBounce {
            0% { transform: scale(0) translateY(20px); opacity: 0; }
            50% { transform: scale(1.3) translateY(-10px); opacity: 1; }
            70% { transform: scale(0.9) translateY(0); }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }
        
        @keyframes finishGlow {
            0%, 100% { text-shadow: 0 0 10px gold, 0 0 20px gold, 2px 2px 4px rgba(0,0,0,0.5); }
            50% { text-shadow: 0 0 20px gold, 0 0 40px gold, 0 0 60px gold, 2px 2px 4px rgba(0,0,0,0.5); }
        }
        
        @keyframes finishFade {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes sparkleRing {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
        }
        
        /* Íº¥Îì± ÏÇ¨Îßù Ïï†ÎãàÎ©îÏù¥ÏÖò */
        @keyframes soulRise {
            0% { transform: translateY(0); opacity: 0.8; }
            100% { transform: translateY(-100px); opacity: 0; }
        }
        
        @keyframes arrowBounce {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-5px); }
        }

        @keyframes tombstoneDrop {
            0% { transform: translateY(-150px); opacity: 0; }
            60% { transform: translateY(10px); opacity: 1; }
            80% { transform: translateY(-5px); }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes deathFade {
            0% { opacity: 1; filter: grayscale(0); }
            100% { opacity: 0; filter: grayscale(100%); visibility: hidden; }
        }
        
        @keyframes confettiFall {
            0% { opacity: 1; transform: translateY(0) rotate(0deg); }
            100% { opacity: 0; transform: translateY(80px) rotate(720deg); }
        }

        .result-title {
            font-size: 24px;
            color: #8b4513;
            margin-bottom: 20px;
            font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .result-winner {
            font-size: 48px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }

        .result-message {
            font-size: 18px;
            color: #666;
            margin-bottom: 30px;
        }

        /* ÏàúÏúÑ Î∞úÌëú 1¬∑2¬∑3Îì± Î∏îÎ°ù Ïï†ÎãàÎ©îÏù¥ÏÖò */
        @keyframes resultRankBounce {
            0% { transform: scale(0.95); opacity: 0.9; }
            50% { transform: scale(1.02); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .result-rank-1 { animation: resultRankBounce 0.6s ease-out, resultRankPulse 2s ease-in-out 0.6s infinite; }
        .result-rank-2 { animation: resultRankBounce 0.5s ease-out 0.1s both; }
        .result-rank-3 { animation: resultRankBounce 0.5s ease-out 0.2s both; }
        @keyframes resultRankPulse {
            0%, 100% { box-shadow: 0 4px 15px rgba(255,215,0,0.4); }
            50% { box-shadow: 0 6px 25px rgba(255,215,0,0.6); }
        }

        /* Î∞© Ìè≠Ìåå Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ */
        .room-expiry-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        /* Îßê ÏÑ†ÌÉù ÏÑπÏÖò */
        .horse-selection-section {
            display: none;
            background: #f8f9fa;
            border: 2px solid #8b4513;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .horse-selection-section.active {
            display: block;
        }

        /* Í≤åÏûÑ Î™®Îìú ÏÑ†ÌÉù */
        .game-mode-section {
            background: #f5e6d3;
            border: 2px solid #8b4513;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .game-mode-section label:hover {
            background: #faf5ef;
            transform: translateX(2px);
        }
        
        .game-mode-section label input[type="radio"]:checked + span {
            color: #8b4513;
            font-weight: 600;
        }

        @media (max-width: 1200px) {
            body.game-active .container {
                margin-left: auto;
                margin-right: auto;
            }
            
            .history-section {
                position: static;
                width: 100%;
                max-height: none;
                margin-top: 20px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
                border-radius: 15px;
            }

            h1 {
                font-size: 1.8em;
            }

            .race-track-container {
                height: 300px;
            }

            .horse-selection-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* ========== ÎÇ†Ïî® Ìö®Í≥º CSS ========== */
        .weather-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 500;
            transition: opacity 0.8s ease;
        }

        /* ÎπÑ Ìö®Í≥º */
        .weather-rain {
            background: linear-gradient(transparent 0%, rgba(100, 150, 200, 0.1) 100%);
        }
        .weather-rain::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 40'%3E%3Cline x1='10' y1='0' x2='10' y2='15' stroke='%2387CEEB' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
            background-size: 20px 40px;
            animation: rainFall 0.4s linear infinite;
            opacity: 0.6;
        }
        @keyframes rainFall {
            0% { background-position: 0 0; }
            100% { background-position: 10px 40px; }
        }

        /* Î∞îÎûå Ìö®Í≥º */
        .weather-wind::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 20'%3E%3Cpath d='M0,10 Q25,5 50,10 T100,10' fill='none' stroke='rgba(200,200,200,0.3)' stroke-width='2'/%3E%3C/svg%3E");
            background-size: 100px 20px;
            animation: windBlow 0.8s linear infinite;
            opacity: 0.5;
        }
        @keyframes windBlow {
            0% { background-position: 0 0; }
            100% { background-position: 100px 0; }
        }

        /* ÏïàÍ∞ú Ìö®Í≥º */
        .weather-fog {
            background: linear-gradient(90deg,
                rgba(255,255,255,0.25) 0%,
                rgba(255,255,255,0.35) 30%,
                rgba(255,255,255,0.25) 60%,
                rgba(255,255,255,0.35) 100%);
            animation: fogMove 4s ease-in-out infinite;
        }
        @keyframes fogMove {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 0.9; }
        }

        /* ÎÇ†Ïî® Î∞∞ÎÑà */
        .weather-banner {
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
            z-index: 600;
            animation: bannerFadeIn 0.3s ease;
            white-space: nowrap;
        }
        @keyframes bannerFadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(-10px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        /* ÎÇ†Ïî® ÌÜ†Ïä§Ìä∏ Î©îÏãúÏßÄ */
        .weather-toast {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #ffd700;
            padding: 8px 20px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 601;
            animation: toastSlide 3s ease forwards;
            white-space: nowrap;
        }
        @keyframes toastSlide {
            0% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
            10% { opacity: 1; transform: translateX(-50%) translateY(0); }
            80% { opacity: 1; }
            100% { opacity: 0; transform: translateX(-50%) translateY(-5px); }
        }

        /* Î≤ÑÌîÑ/ÎîîÎ≤ÑÌîÑ ÏÇºÍ∞ÅÌòï */
        .weather-indicator {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 14px;
            font-weight: bold;
            z-index: 200;
            animation: indicatorPulse 2s ease-out forwards;
            text-shadow: 0 0 4px rgba(0,0,0,0.5);
        }
        .weather-buff {
            color: #3B82F6;
        }
        .weather-nerf {
            color: #EF4444;
        }
        @keyframes indicatorPulse {
            0% { opacity: 0; transform: translateX(-50%) scale(1.5); }
            20% { opacity: 1; transform: translateX(-50%) scale(1); }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
    </style>
</head>
<body class="lobby-active">
    <!-- Î°úÎî© ÌôîÎ©¥ -->
    <div id="loadingScreen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center;">
        <div style="text-align: center; color: white;">
            <div style="font-size: 80px; margin-bottom: 20px; animation: bounce 1s infinite;">üêé</div>
            <h2 style="font-size: 24px; margin-bottom: 10px;">Î∞©Ïóê ÏûÖÏû• Ï§ë...</h2>
            <p style="font-size: 16px; opacity: 0.8;">Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî</p>
            <div style="margin-top: 30px;">
                <div style="width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
            </div>
        </div>
    </div>
    <style>
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
    </style>

    <div class="container">
        <!-- Î°úÎπÑ ÏÑπÏÖò -->
        <section class="lobby-section active" id="lobbySection">
            <h1>üêé LAM Horse Race</h1>
            <div class="connection-sound-row">
                <div class="connection-status connected" id="connectionStatus">‚óè Ïó∞Í≤∞Îê®</div>
                <div class="volume-control" id="volumeControl">
                    <button class="volume-btn" id="volumeBtn" title="ÏùåÏÜåÍ±∞ ÌÜ†Í∏Ä">üîá</button>
                    <input type="range" class="volume-slider muted" id="volumeSlider" min="0" max="100" value="50">
                </div>
            </div>
            
            <!-- Ïù¥Î¶Ñ ÏûÖÎ†• -->
            <div style="background: #f5e6d3; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <label style="font-weight: bold; color: #8b4513; display: block; margin-bottom: 8px;">üë§ ÎÇ¥ Ïù¥Î¶Ñ</label>
                <input type="text" id="globalUserNameInput" placeholder="Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" maxlength="20">
            </div>
            
            <!-- Î∞© ÎßåÎì§Í∏∞ Î≤ÑÌäº -->
            <button onclick="showCreateRoomSection()" style="margin-bottom: 20px; color: #000; font-weight: 600;">üêé ÏÉà Í≤ΩÎßà Î∞© ÎßåÎì§Í∏∞</button>
            
            <!-- Î∞© Î™©Î°ù -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="color: #8b4513;">üêé Î∞© Î™©Î°ù</h3>
                <button onclick="refreshRooms()" style="width: auto; padding: 8px 15px; font-size: 14px; color: #000; font-weight: 600;">üîÑ ÏÉàÎ°úÍ≥†Ïπ®</button>
            </div>
            <div class="rooms-list" id="roomsList">
                <div style="color: #999; text-align: center; padding: 20px;">Î∞© Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
            </div>
            
            <!-- Ï£ºÏÇ¨ÏúÑ Í≤åÏûÑ ÎßÅÌÅ¨ -->
            <div style="text-align: center; margin-top: 20px;">
                <a href="/dice-game-multiplayer.html" style="color: #8b4513; text-decoration: none;">üé≤ Ï£ºÏÇ¨ÏúÑ Í≤åÏûÑÏúºÎ°ú Ïù¥Îèô</a>
            </div>
        </section>

        <!-- Î∞© ÏÉùÏÑ± ÏÑπÏÖò -->
        <section class="create-room-section" id="createRoomSection">
            <h2 style="color: #8b4513; margin-bottom: 20px;">üêé ÏÉà Í≤ΩÎßà Î∞© ÎßåÎì§Í∏∞</h2>
            <div class="connection-status connected" id="createRoomConnectionStatus">‚óè Ïó∞Í≤∞Îê®</div>
            
            <div style="margin-bottom: 15px;">
                <label style="font-weight: bold; color: #333; display: block; margin-bottom: 5px;">Ìò∏Ïä§Ìä∏ Ïù¥Î¶Ñ</label>
                <input type="text" id="createRoomHostNameInput" placeholder="Ìò∏Ïä§Ìä∏ Ïù¥Î¶Ñ" maxlength="20">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="font-weight: bold; color: #333; display: block; margin-bottom: 5px;">Î∞© Ï†úÎ™©</label>
                <input type="text" id="createRoomNameInput" placeholder="Î∞© Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" maxlength="30">
            </div>
            
            <!-- ÎπÑÍ≥µÍ∞ú Î∞© ÏÑ§Ï†ï -->
            <div style="margin-bottom: 15px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="createRoomPrivateCheckbox" style="width: auto; margin: 0;">
                    <span style="font-weight: bold; color: #333;">üîí ÎπÑÍ≥µÍ∞ú Î∞©</span>
                </label>
                <div id="createRoomPasswordContainer" style="display: none; margin-top: 10px;">
                    <input type="password" id="createRoomPasswordInput" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏ (4~20Ïûê)" maxlength="20">
                </div>
            </div>
            
            <!-- Î∞© Ïú†ÏßÄ ÏãúÍ∞Ñ -->
            <div style="margin-bottom: 15px;">
                <label style="font-weight: bold; color: #333; display: block; margin-bottom: 8px;">‚è∞ Î∞© Ïú†ÏßÄ ÏãúÍ∞Ñ</label>
                <div style="display: flex; gap: 15px;">
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="radio" name="roomExpiryTime" value="1" style="width: auto; margin: 0;">
                        <span>1ÏãúÍ∞Ñ</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="radio" name="roomExpiryTime" value="3" checked style="width: auto; margin: 0;">
                        <span>3ÏãúÍ∞Ñ</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="radio" name="roomExpiryTime" value="6" style="width: auto; margin: 0;">
                        <span>6ÏãúÍ∞Ñ</span>
                    </label>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="goBackToLobby()" style="background: #6c757d; flex: 1; color: #000; font-weight: 600;">‚Üê Ï∑®ÏÜå</button>
                <button onclick="finalizeRoomCreation()" style="flex: 2; color: #000; font-weight: 600;">üêé Î∞© ÎßåÎì§Í∏∞</button>
            </div>
        </section>

        <!-- Í≤åÏûÑ ÏÑπÏÖò -->
        <section class="game-section" id="gameSection">
            <!-- Î∞© Ï†ïÎ≥¥ Ìó§Îçî -->
            <div class="room-header">
                <div style="display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <span class="room-title" id="roomTitle">Í≤ΩÎßà Î∞©</span>
                    <span class="host-badge" id="hostBadge" style="display: none;">üëë Ìò∏Ïä§Ìä∏</span>
                    <div class="volume-control" id="gameSectionVolumeControl">
                        <button class="volume-btn" id="gameSectionVolumeBtn" title="ÏùåÏÜåÍ±∞ ÌÜ†Í∏Ä">üîá</button>
                        <input type="range" class="volume-slider muted" id="gameSectionVolumeSlider" min="0" max="100" value="50">
                    </div>
                </div>
                <div style="text-align: center; margin-top: 10px;">
                    <button onclick="leaveRoom()" style="width: auto; padding: 8px 15px; font-size: 12px; background: #6c757d; color: #000; font-weight: 600; border: none; border-radius: 8px; cursor: pointer;">üö™ ÎÇòÍ∞ÄÍ∏∞</button>
                </div>
            </div>

            <!-- Î∞© Ìè≠Ìåå Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ -->
            <div class="room-expiry-section" id="roomExpirySection" style="display: none;">
                <div style="color: #856404; font-weight: bold; font-size: 14px;">
                    ‚è∞ Î∞© Ìè≠ÌååÍπåÏßÄ ÎÇ®ÏùÄ ÏãúÍ∞Ñ: <span id="roomExpiryCountdown" style="color: #d9534f;">--:--:--</span>
                </div>
            </div>

            <!-- Ï†ëÏÜçÏûê Î™©Î°ù -->
            <div class="users-section" id="usersSection">
                <div class="users-title">
                    üë• Ï†ëÏÜçÏûê (<span id="usersCount">0</span>Î™Ö)
                    <span id="dragHint" style="display: none; font-size: 12px; color: #8b4513; font-weight: normal; margin-left: 10px;">
                        üí° ÎìúÎûòÍ∑∏Î°ú Ï§ÄÎπÑ ÏãúÌÇ¨ Ïàò ÏûàÏäµÎãàÎã§.
                    </span>
                </div>
                <div class="users-list" id="usersList"></div>
            </div>

            <!-- Ï§ÄÎπÑ ÏÑπÏÖò -->
            <div class="ready-section" id="readySection">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="users-title" style="margin: 0;">‚úÖ Ï§ÄÎπÑÌïú ÏÇ¨Îûå (<span id="readyCount">0</span>Î™Ö)</div>
                    <button id="readyButton" onclick="toggleReady()" style="width: auto; padding: 10px 20px; background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%); color: #fff; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s;">Ï§ÄÎπÑ</button>
                </div>
                <div class="users-list" id="readyUsersList">
                    <div style="color: #999; text-align: center; padding: 10px; width: 100%;">ÏïÑÏßÅ Ï§ÄÎπÑÌïú ÏÇ¨ÎûåÏù¥ ÏóÜÏäµÎãàÎã§</div>
                </div>
            </div>

            <!-- Í≤åÏûÑ Î™®Îìú: Î¨¥Ï°∞Í±¥ Íº¥Îì± Ï∞æÍ∏∞ (Î™®Îìú ÏÑ†ÌÉù Ï†úÍ±∞) -->

            <!-- ÌÉàÍ≤É ÏÑ†ÌÉù ÏÑπÏÖò -->
            <div class="horse-selection-section" id="horseSelectionSection">
                <div class="users-title" style="margin-bottom: 15px;">üèÅ ÌÉàÍ≤É ÏÑ†ÌÉù</div>
                <div id="horseSelectionGrid" class="horse-selection-grid">
                    <!-- ÌÉàÍ≤É ÏÑ†ÌÉù Î≤ÑÌäºÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê® -->
                </div>
                <div id="horseSelectionInfo" style="text-align: center; margin-top: 15px; color: #666; font-size: 14px;">
                    ÌÉàÍ≤ÉÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî
                </div>
                <!-- ÌÉàÍ≤É ÏÑ†ÌÉù ÏïàÌïú ÏÇ¨Îûå -->
                <div id="notSelectedVehicleSection" style="display: none; margin-top: 10px; padding: 10px; background: #fff5e6; border-radius: 8px;">
                    <div style="font-weight: bold; color: #ff6b6b; margin-bottom: 8px; font-size: 13px;">‚è≥ ÏÑ†ÌÉù ÏïàÌïú ÏÇ¨Îûå</div>
                    <div id="notSelectedVehicleList" style="display: flex; flex-wrap: wrap; gap: 5px;"></div>
                </div>
            </div>

            <!-- Ìò∏Ïä§Ìä∏ Ïª®Ìä∏Î°§ -->
            <div class="host-controls" id="hostControls" style="display: none; margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button class="start-button" id="startHorseRaceButton" onclick="startHorseRace()" disabled style="flex: 1;">
                        Í≤åÏûÑ ÏãúÏûë
                    </button>
                    <button onclick="OrderModule.startOrder()" id="startOrderButton" style="flex: 1; background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: #fff; font-weight: 600; font-size: 16px; padding: 15px;">Ï£ºÎ¨∏Î∞õÍ∏∞ ÏãúÏûë</button>
                    <button onclick="OrderModule.endOrder()" id="endOrderButton" style="display: none; flex: 1; background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%); color: #fff; font-weight: 600; font-size: 16px; padding: 15px;">Ï£ºÎ¨∏Î∞õÍ∏∞ Ï¢ÖÎ£å</button>
                </div>
                <button onclick="clearHorseRaceData()" id="clearDataButton" style="width: 100%; background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%); color: #fff; font-weight: 600; font-size: 14px; padding: 12px;">Ïù¥Ï†Ñ Í≤åÏûÑ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú</button>
            </div>

            <!-- Ï£ºÎ¨∏Î∞õÍ∏∞ ÏÑπÏÖò -->
            <div class="orders-section" id="ordersSection" style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="users-title" style="font-weight: bold; color: #8b4513; font-size: 16px; margin: 0;">üçî Ï£ºÎ¨∏Î∞õÍ∏∞</div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="OrderModule.showOrderList()" id="showOrderListButton" style="width: auto; padding: 8px 16px; font-size: 14px; background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%); color: #000; font-weight: 600;">üìã Ï£ºÎ¨∏Î¶¨Ïä§Ìä∏</button>
                        <button onclick="OrderModule.sortOrders('asc')" class="sort-btn" style="padding: 6px 10px; font-size: 12px; background: #d2b48c; color: #333; border: none; border-radius: 4px; cursor: pointer;">Í∞ÄÎÇòÎã§Ïàú</button>
                        <button onclick="OrderModule.sortOrders('count')" class="sort-btn" style="padding: 6px 10px; font-size: 12px; background: #d2b48c; color: #333; border: none; border-radius: 4px; cursor: pointer;">Ï£ºÎ¨∏ ÎßéÏùÄ Ïàú</button>
                    </div>
                </div>
                
                <!-- Ï£ºÎ¨∏ÌïòÏßÄ ÏïäÏùÄ ÏÇ¨Îûå Î™©Î°ù -->
                <div id="notOrderedSection" style="display: none; margin-bottom: 10px; padding: 10px; background: #fff5e6; border-radius: 8px;">
                    <div style="font-weight: bold; color: #ff6b6b; margin-bottom: 8px; font-size: 13px;">‚è≥ Ï£ºÎ¨∏ÌïòÏßÄ ÏïäÏùÄ ÏÇ¨Îûå</div>
                    <div id="notOrderedList" style="display: flex; flex-wrap: wrap; gap: 5px;"></div>
                </div>
                
                <!-- ÎÇ¥ Ï£ºÎ¨∏ ÏûÖÎ†• -->
                <div style="background: #fff9e6; border: 2px solid #ffc107; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="font-size: 16px; font-weight: 600; color: #856404; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span>üìù</span>
                            <span>ÎÇ¥ Ï£ºÎ¨∏</span>
                        </div>
                        <button onclick="OrderModule.toggleMenuManager()" style="width: auto; padding: 6px 12px; font-size: 12px; background: #f8f9fa; color: #8b4513; border: 1px solid #8b4513; border-radius: 4px; cursor: pointer;">Î©îÎâ¥ Í¥ÄÎ¶¨</button>
                    </div>
                    
                    <!-- ÏûêÏ£º Ïì∞Îäî Î©îÎâ¥ Í¥ÄÎ¶¨ -->
                    <div id="menuManager" style="display: none; background: #f8f9fa; border: 2px solid #8b4513; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="font-weight: bold; color: #8b4513;">üìã ÏûêÏ£º Ïì∞Îäî Î©îÎâ¥</span>
                            <button onclick="OrderModule.toggleMenuManager()" style="padding: 4px 8px; font-size: 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Îã´Í∏∞</button>
                        </div>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" id="newMenuInput" placeholder="ÏÉà Î©îÎâ¥ ÏûÖÎ†•" maxlength="50" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <button onclick="OrderModule.addMenu()" style="padding: 8px 16px; background: #8b4513; color: white; border: none; border-radius: 4px; cursor: pointer;">Ï∂îÍ∞Ä</button>
                        </div>
                        <div id="menuList" style="display: flex; flex-wrap: wrap; gap: 8px; max-height: 100px; overflow-y: auto;">
                            <div style="color: #999; text-align: center; padding: 10px;">Îì±Î°ùÎêú Î©îÎâ¥Í∞Ä ÏóÜÏäµÎãàÎã§</div>
                        </div>
                    </div>
                    
                    <div class="order-input-group">
                        <div class="order-input-wrapper">
                            <div class="autocomplete-suggestion" id="autocompleteSuggestion"></div>
                            <input type="text" id="myOrderInput" placeholder="Ï£ºÎ¨∏Ìï† ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" maxlength="100" disabled>
                            <div class="autocomplete-dropdown" id="autocompleteDropdown" style="display: none;"></div>
                        </div>
                        <button onclick="OrderModule.updateMyOrder()" id="orderSaveButton" style="width: auto; padding: 12px 20px; height: fit-content; margin: 0; color: #000; font-weight: 600;" disabled>Ï†ÄÏû•</button>
                    </div>
                </div>

                <!-- Ï†ÑÏ≤¥ Ï£ºÎ¨∏ Î™©Î°ù -->
                <div id="orderList" style="background: #f8f9fa; border-radius: 8px; padding: 12px; max-height: 200px; overflow-y: auto;">
                    <div style="color: #999; text-align: center; padding: 10px;">ÏïÑÏßÅ Ï£ºÎ¨∏Ïù¥ ÏóÜÏäµÎãàÎã§</div>
                </div>
                <!-- Í¥ÄÏ†ÑÏûê Ï£ºÎ¨∏ -->
                <div id="spectatorOrdersSection" style="display: none; margin-top: 10px;">
                    <div style="font-size: 13px; color: #999; margin-bottom: 5px;">Í¥ÄÏ†ÑÏûê Ï£ºÎ¨∏</div>
                    <div id="spectatorOrderList" style="background: #f8f9fa; border-radius: 8px; padding: 12px;"></div>
                </div>
            </div>
            
            <!-- Í≤åÏûÑ ÏÉÅÌÉú ÌëúÏãú -->
            <div class="game-status waiting" id="gameStatus" style="padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; margin-bottom: 20px; background: #e9ecef; color: #495057;">
                ÎåÄÍ∏∞ Ï§ë...
            </div>

            <!-- Í≤ΩÏ£º Ìä∏Îûô Ïª®ÌÖåÏù¥ÎÑà -->
            <div class="race-track-container" id="raceTrackContainer" style="display: none; position: relative;">
                <!-- Ïπ¥Î©îÎùº Ï†ÑÌôò Î≤ÑÌäº (Ìä∏Îûô Ï¢åÌïòÎã®) -->
                <button id="cameraSwitchBtn" style="display: none; position: absolute; top: 6px; right: 6px; z-index: 110; padding: 2px 8px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.3); background: rgba(0,0,0,0.65); color: #fff; font-size: 10px; cursor: pointer; font-family: 'Jua', sans-serif; backdrop-filter: blur(4px);">üì∑ ÏãúÏä§ÌÖú Ïπ¥Î©îÎùº</button>
                <div class="race-track" id="raceTrack">
                    <!-- ÎßêÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê® -->
                </div>
                <!-- ÎØ∏ÎãàÎßµ -->
                <div id="raceMinimap" style="display: none; position: absolute; bottom: 8px; right: 8px; width: 180px; background: rgba(0,0,0,0.75); border-radius: 8px; padding: 8px 10px; z-index: 100; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.15);">
                    <div style="font-size: 9px; color: rgba(255,255,255,0.5); margin-bottom: 4px; text-align: center;">TRACK MAP</div>
                    <div id="minimapTrack" style="position: relative; width: 100%; height: 6px; background: rgba(255,255,255,0.15); border-radius: 3px; margin-bottom: 2px;">
                        <!-- Í±∞Î¶¨ ÎßàÏª§ + Îßê ÏúÑÏπò ÎèôÏ†Å ÏÉùÏÑ± -->
                    </div>
                    <div id="minimapMarkers" style="position: relative; width: 100%; height: 10px;">
                        <!-- Í±∞Î¶¨ ÌÖçÏä§Ìä∏ -->
                    </div>
                    <div id="minimapDots" style="position: relative; width: 100%; min-height: 14px; margin-top: 2px;">
                        <!-- Îßê ÏïÑÏù¥ÏΩò Î≤îÎ°Ä -->
                    </div>
                </div>
            </div>

            <!-- Îã§ÏãúÎ≥¥Í∏∞ + Í≤åÏûÑ Ï¢ÖÎ£å Î≤ÑÌäº (Í≤∞Í≥º ÌõÑ ÌëúÏãú) -->
            <div id="replaySection" style="display: none; text-align: center; margin-top: 20px;">
                <button id="mainReplayButton" onclick="playLastReplay()" style="width: 100%; padding: 12px; font-size: 15px; background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(255, 107, 107, 0.4); font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">üé¨ Îã§ÏãúÎ≥¥Í∏∞</button>
            </div>
            <div id="endGameSection" style="display: none; text-align: center; margin-top: 10px;">
                <button class="end-button" onclick="endHorseRaceGame()">üèÅ Í≤åÏûÑ Ï¢ÖÎ£å</button>
            </div>

            <!-- Îã§ÏãúÎ≥¥Í∏∞ Î≤ÑÌäº (ÌôîÎ©¥ Ïà®ÍπÄ ÏÉÅÌÉúÏóêÏÑú Í≤ΩÏ£ºÍ∞Ä ÏßÑÌñâÎêú Í≤ΩÏö∞ ÌëúÏãú) -->
            <div id="horseReplaySection" style="display: none; text-align: center; margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #8b4513 0%, #d2691e 100%); border-radius: 12px; box-shadow: 0 4px 15px rgba(139, 69, 19, 0.4);">
                <div style="color: white; margin-bottom: 12px; font-size: 14px; font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                    üé¨ ÌôîÎ©¥ÏùÑ Î≥¥ÏßÄ ÏïäÎäî ÎèôÏïà Í≤ΩÏ£ºÍ∞Ä ÏßÑÌñâÎêòÏóàÏäµÎãàÎã§
                </div>
                <button onclick="replayMissedRace()" style="background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%); border: none; padding: 12px 25px; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; font-size: 15px; box-shadow: 0 4px 10px rgba(255, 107, 107, 0.4); font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                    üîÑ Îã§ÏãúÎ≥¥Í∏∞
                </button>
            </div>

            <!-- Ï±ÑÌåÖ ÏÑπÏÖò -->
            <div class="chat-section">
                <div style="font-weight: bold; color: #8b4513; margin-bottom: 10px; font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">üí¨ Ï±ÑÌåÖ</div>
                <div class="chat-messages" id="chatMessages"></div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="chatInput" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." style="flex: 1; margin: 0;" onkeypress="handleChatKeypress(event)">
                    <button onclick="sendMessage()" style="width: auto; padding: 10px 20px; color: #000; font-weight: 600;">Ï†ÑÏÜ°</button>
                </div>
            </div>
        </section>
    </div>

    <!-- Í∏∞Î°ù ÏÑπÏÖò -->
    <div class="history-section" id="historySection">
        <div class="history-title">üìú Í≤åÏûÑ Í∏∞Î°ù</div>
        <div id="historyList"></div>
        
        <!-- Ïã§ÏãúÍ∞Ñ ÏàúÏúÑ Ìå®ÎÑê (Í≤åÏûÑ Í∏∞Î°ù ÌïòÎã®) -->
        <div id="liveRankingPanel" style="display: none; background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 12px 15px; border-radius: 10px; margin-top: 15px; font-size: 13px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
            <div style="font-weight: bold; margin-bottom: 10px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 8px; font-size: 14px; font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">üèÉ Ïã§ÏãúÍ∞Ñ ÏàúÏúÑ</div>
            <div id="liveRankingList"></div>
        </div>
    </div>

    <!-- Í≤∞Í≥º Ïò§Î≤ÑÎ†àÏù¥ -->
    <div class="result-overlay" id="resultOverlay">
        <div class="result-card">
            <div class="result-title">üéä ÏàúÏúÑ Î∞úÌëú üéä</div>
            <div id="resultRankings" style="margin-bottom: 20px;"></div>
            <button onclick="closeResultOverlay()" style="width: auto; padding: 12px 30px; color: #000; font-weight: 600;">ÌôïÏù∏</button>
        </div>
    </div>

    <!-- ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†• Î™®Îã¨ -->
    <div id="passwordModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%;">
            <h3 style="color: #8b4513; margin-bottom: 15px;">üîí ÎπÑÍ≥µÍ∞ú Î∞©</h3>
            <p style="margin-bottom: 15px; color: #666;">ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî</p>
            <input type="password" id="roomPasswordInput" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏" style="margin-bottom: 15px;">
            <div style="display: flex; gap: 10px;">
                <button onclick="closePasswordModal()" style="background: #6c757d; flex: 1; color: #000; font-weight: 600;">Ï∑®ÏÜå</button>
                <button onclick="submitPassword()" style="flex: 1; color: #000; font-weight: 600;">ÏûÖÏû•</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/chat-shared.js"></script>
    <script src="/ready-shared.js"></script>
    <script src="/order-shared.js"></script>
    <script src="/assets/sounds/sound-manager.js"></script>
    <script>
        // localhost Ï≤¥ÌÅ¨
        const isLocalhost = window.location.hostname === 'localhost' || 
                           window.location.hostname === '127.0.0.1' ||
                           window.location.hostname === '';
        
        // Î°úÏª¨ÏóêÏÑúÎäî Î∞© Ï†úÎ™© Í∏∞Î≥∏Í∞íÏùÑ "test"Î°ú ÏÑ§Ï†ï
        if (isLocalhost) {
            const roomNameInput = document.getElementById('createRoomNameInput');
            if (roomNameInput) {
                roomNameInput.value = 'test';
            }
        }
        
        // ÎîîÎ≤ÑÍ∑∏ Î°úÍ∑∏ ÏÑ§Ï†ï
        let debugLogEnabled = isLocalhost;
        
        // ÎîîÎ≤ÑÍ∑∏ Î°úÍ∑∏ Ìï®Ïàò (Î®ºÏ†Ä Ï†ïÏùò)
        const MAX_LOG_LINES = 100;
        function addDebugLog(message, type = 'info') {
            if (!debugLogEnabled) return;
            
            const logSection = document.getElementById('debugLogSection');
            const logContent = document.getElementById('debugLogContent');
            
            if (!logSection || !logContent) return;
            
            const timestamp = new Date().toLocaleTimeString('ko-KR', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3 });
            const colors = {
                'info': '#0f0',
                'warn': '#ff0',
                'error': '#f00',
                'race': '#0ff',
                'selection': '#ff0',
            };
            const color = colors[type] || '#0f0';
            
            const logLine = document.createElement('div');
            logLine.style.color = color;
            logLine.style.marginBottom = '2px';
            logLine.innerHTML = `[${timestamp}] ${message}`;
            logContent.appendChild(logLine);
            
            // ÏµúÎåÄ Î°úÍ∑∏ ÎùºÏù∏ Ïàò Ï†úÌïú
            while (logContent.children.length > MAX_LOG_LINES) {
                logContent.removeChild(logContent.firstChild);
            }
            
            // ÏûêÎèô Ïä§ÌÅ¨Î°§
            logContent.scrollTop = logContent.scrollHeight;
            
            // Î°úÍ∑∏ ÏÑπÏÖò ÌëúÏãú
            logSection.style.display = 'block';
        }
        
        // ÏÉÅÌÉú Î≥ÄÏàò
        let currentRoomId = null;
        let currentUser = '';
        let isHost = false;
        let isReady = false;
        let readyUsers = [];
        let roomsList = [];
        let selectedRoomId = null;
        let horseRaceHistory = [];
        let isRaceActive = false;
        let roomExpiryInterval = null;
        let pendingRoomId = null;
        let isOrderActive = false;
        let everPlayedUsers = [];
        let availableHorses = [];
        let userHorseBets = {};
        let selectedUsersFromServer = [];  // ÏÑ†ÌÉù ÏôÑÎ£åÏûê Î™©Î°ù (ÏÑúÎ≤ÑÏóêÏÑú Ï†ÑÏÜ°)
        let mySelectedHorse = null;
        let horseRaceMode = 'last'; // Î¨¥Ï°∞Í±¥ Íº¥Îì± Ï∞æÍ∏∞
        let currentTrackLength = 'medium'; // Ìä∏Îûô Í∏∏Ïù¥ ÏòµÏÖò
        let pendingRaceResultMessages = []; // ÎÜìÏπú Í≤ΩÏ£º Í≤∞Í≥º Î©îÏãúÏßÄ Î≥¥Í¥Ä ÌÅê
        let currentTrackDistanceMeters = 500; // Ìä∏Îûô Í±∞Î¶¨(m)
        let trackPresetsFromServer = { short: 500, medium: 700, long: 1000 }; // ÏÑúÎ≤ÑÏóêÏÑú Î∞õÏùÄ ÌîÑÎ¶¨ÏÖã
        let selectedVehicleTypes = null; // ÏÑ†ÌÉùÎêú ÌÉàÍ≤É ÌÉÄÏûÖ (nullÏù¥Î©¥ ÎûúÎç§)
        let popularVehicles = []; // Ïù∏Í∏∞Îßê vehicle_id Î™©Î°ù
        let vehicleStatsData = []; // ÌÉàÍ≤ÉÎ≥Ñ ÌÜµÍ≥Ñ Îç∞Ïù¥ÌÑ∞
        let missedHorseRace = false; // Í≤ΩÏ£ºÎ•º ÎÜìÏ≥§ÎäîÏßÄ Ïó¨Î∂Ä (ÌôîÎ©¥ Ïà®ÍπÄ ÏÉÅÌÉúÏòÄÎäîÏßÄ)
        let lastHorseRaceData = null; // ÎßàÏßÄÎßâ Í≤ΩÏ£º Îç∞Ïù¥ÌÑ∞ (Îã§ÏãúÎ≥¥Í∏∞Ïö©)
        let countdownVisibilityHandler = null; // Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ Ï§ë ÌÉ≠ Î≥µÍ∑Ä Í∞êÏßÄ Î¶¨Ïä§ÎÑà
        let isReplayActive = false; // Îã§ÏãúÎ≥¥Í∏∞ ÏßÑÌñâ Ï§ë Ïó¨Î∂Ä
        let raceResultShown = false; // ÌòÑÏû¨ ÎùºÏö¥Îìú Í≤∞Í≥º Ïù¥ÎØ∏ ÌëúÏãú Ïó¨Î∂Ä
        // Í≤ΩÎßà ÏÇ¨Ïö¥Îìú Î≥ºÎ•® Í¥ÄÎ¶¨
        const HORSE_SOUND_KEY = 'horseSoundEnabled';
        const HORSE_VOLUME_KEY = 'horseSoundVolume';
        let horseMasterVolume = 0; // 0 = ÏùåÏÜåÍ±∞ (Í∏∞Î≥∏)
        let horseStoredVolume = 0.5; // ÏùåÏÜåÍ±∞ Ìï¥Ï†ú Ïãú Î≥µÏõêÌï† Î≥ºÎ•® (Í∏∞Î≥∏ 50%)

        function getHorseSoundEnabled() {
            return horseMasterVolume > 0;
        }

        function getHorseMasterVolume() {
            return horseMasterVolume;
        }

        function initVolumeFromStorage() {
            const storedMuted = localStorage.getItem(HORSE_SOUND_KEY);
            const storedVolume = localStorage.getItem(HORSE_VOLUME_KEY);
            horseStoredVolume = storedVolume ? parseFloat(storedVolume) : 0.5;
            const isEnabled = storedMuted === 'true';
            horseMasterVolume = isEnabled ? horseStoredVolume : 0;
        }

        function updateVolumeUI() {
            const isMuted = horseMasterVolume === 0;
            const volumePercent = Math.round(horseStoredVolume * 100);

            // Î°úÎπÑ Î≥ºÎ•® Ïª®Ìä∏Î°§
            const btn1 = document.getElementById('volumeBtn');
            const slider1 = document.getElementById('volumeSlider');
            if (btn1) btn1.textContent = isMuted ? 'üîá' : (horseMasterVolume < 0.5 ? 'üîà' : 'üîä');
            if (slider1) {
                slider1.value = volumePercent;
                slider1.classList.toggle('muted', isMuted);
            }

            // Í≤åÏûÑ ÏÑπÏÖò Î≥ºÎ•® Ïª®Ìä∏Î°§
            const btn2 = document.getElementById('gameSectionVolumeBtn');
            const slider2 = document.getElementById('gameSectionVolumeSlider');
            if (btn2) btn2.textContent = isMuted ? 'üîá' : (horseMasterVolume < 0.5 ? 'üîà' : 'üîä');
            if (slider2) {
                slider2.value = volumePercent;
                slider2.classList.toggle('muted', isMuted);
            }
        }

        function toggleMute() {
            if (horseMasterVolume > 0) {
                horseMasterVolume = 0;
                localStorage.setItem(HORSE_SOUND_KEY, 'false');
            } else {
                horseMasterVolume = horseStoredVolume;
                localStorage.setItem(HORSE_SOUND_KEY, 'true');
            }
            updateVolumeUI();
            applyMasterVolumeToAll();
        }

        function setMasterVolume(volumePercent) {
            const vol = volumePercent / 100;
            horseStoredVolume = vol;
            horseMasterVolume = vol;
            localStorage.setItem(HORSE_VOLUME_KEY, vol.toString());
            localStorage.setItem(HORSE_SOUND_KEY, vol > 0 ? 'true' : 'false');
            updateVolumeUI();
            applyMasterVolumeToAll();
        }

        function applyMasterVolumeToAll() {
            if (!window.SoundManager) return;
            SoundManager.applyMasterVolume();
        }

        // Í∏∞Ï°¥ Ìò∏ÌôòÏÑ± Ïú†ÏßÄ
        function setHorseSoundCheckboxes() { updateVolumeUI(); }
        function onHorseSoundChange(checked) {
            horseMasterVolume = checked ? horseStoredVolume : 0;
            localStorage.setItem(HORSE_SOUND_KEY, checked ? 'true' : 'false');
            updateVolumeUI();
        }

        // ÎîîÎ≤ÑÍ∑∏ Î°úÍ∑∏ Ï¥àÍ∏∞Ìôî
        addDebugLog('Í≤ΩÎßà Í≤åÏûÑ Ï¥àÍ∏∞Ìôî', 'info');
        
        // ÌÉàÍ≤É ÌÖåÎßà Îç∞Ïù¥ÌÑ∞ (JSONÏóêÏÑú Î°úÎìú)
        let vehicleThemes = {};
        let ALL_VEHICLES = [];
        
        // JSON ÌååÏùº Î°úÎìú
        async function loadVehicleThemes() {
            try {
                const response = await fetch('assets/vehicle-themes.json');
                const data = await response.json();
                vehicleThemes = data.vehicleThemes;
                
                // ALL_VEHICLES Î∞∞Ïó¥ ÏÉùÏÑ±
                ALL_VEHICLES = Object.values(vehicleThemes).map(theme => ({
                    id: theme.id,
                    name: theme.name,
                    emoji: theme.emoji,
                    bgType: theme.theme
                }));
                
                addDebugLog(`ÌÉàÍ≤É ÌÖåÎßà Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å: ${ALL_VEHICLES.length}Í∞ú`, 'info');
                console.log('ALL_VEHICLES Î°úÎìú ÏôÑÎ£å:', ALL_VEHICLES);
            } catch (error) {
                addDebugLog(`ÌÖåÎßà Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®: ${error.message}`, 'error');
                // Í∏∞Î≥∏Í∞íÏúºÎ°ú Ìè¥Î∞±
                ALL_VEHICLES = [
                    { id: 'car', name: 'ÏûêÎèôÏ∞®', emoji: 'üöó', bgType: 'expressway' },
                    { id: 'rocket', name: 'Î°úÏºì', emoji: 'üöÄ', bgType: 'sky' },
                    { id: 'bird', name: 'ÏÉà', emoji: 'üê¶', bgType: 'sky' },
                    { id: 'boat', name: 'Î≥¥Ìä∏', emoji: 'üö§', bgType: 'ocean' },
                    { id: 'bicycle', name: 'ÏûêÏ†ÑÍ±∞', emoji: 'üö¥', bgType: 'road' },
                    { id: 'rabbit', name: 'ÌÜ†ÎÅº', emoji: 'üêá', bgType: 'forest' },
                    { id: 'turtle', name: 'Í±∞Î∂ÅÏù¥', emoji: 'üê¢', bgType: 'forest' },
                    { id: 'eagle', name: 'ÎèÖÏàòÎ¶¨', emoji: 'ü¶Ö', bgType: 'sky' },
                    { id: 'scooter', name: 'ÌÇ•Î≥¥Îìú', emoji: 'üõ¥', bgType: 'road' },
                    { id: 'helicopter', name: 'Ìó¨Î¶¨ÏΩ•ÌÑ∞', emoji: 'üöÅ', bgType: 'sky' },
                    { id: 'horse', name: 'Îßê', emoji: 'üêé', bgType: 'forest' }
                ];
            }
        }
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÌÖåÎßà Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        loadVehicleThemes();
        let ordersData = {};
        let currentUsers = [];

        // ÎîîÎ∞îÏù¥Ïä§ ID ÏÉùÏÑ±/Í∞ÄÏ†∏Ïò§Í∏∞
        function getDeviceId() {
            let deviceId = localStorage.getItem('horseRaceDeviceId');
            if (!deviceId) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('horseRaceDeviceId', deviceId);
            }
            return deviceId;
        }

        // ÏÜåÏºì Ïó∞Í≤∞
        const socket = io({
            reconnection: true,
            reconnectionAttempts: 10,
            reconnectionDelay: 1000
        });

        // Î∞© ÏÉùÏÑ± ÏÑπÏÖò ÌëúÏãú
        function showCreateRoomSection() {
            const globalName = document.getElementById('globalUserNameInput').value.trim();
            
            document.getElementById('lobbySection').classList.remove('active');
            document.getElementById('createRoomSection').classList.add('active');
            
            // Ìò∏Ïä§Ìä∏ Ïù¥Î¶Ñ ÏûêÎèô ÏÑ§Ï†ï
            const hostNameInput = document.getElementById('createRoomHostNameInput');
            if (globalName) {
                hostNameInput.value = globalName;
                // Î°úÏª¨ÏóêÏÑúÎäî "test", Í∑∏ Ïô∏ÏóêÎäî ÏûêÎèô ÏÉùÏÑ±
                if (isLocalhost) {
                    document.getElementById('createRoomNameInput').value = 'test';
                } else {
                    document.getElementById('createRoomNameInput').value = globalName + 'ÎãòÏùò Horse Race';
                }
            }
        }

        // Î°úÎπÑÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
        function goBackToLobby() {
            document.getElementById('createRoomSection').classList.remove('active');
            document.getElementById('lobbySection').classList.add('active');
        }

        // Î∞© ÏÉùÏÑ±
        function finalizeRoomCreation() {
            const hostName = document.getElementById('createRoomHostNameInput').value.trim();
            const roomName = document.getElementById('createRoomNameInput').value.trim();
            const isPrivate = document.getElementById('createRoomPrivateCheckbox').checked;
            const password = document.getElementById('createRoomPasswordInput').value.trim();
            const expiryTimeRadio = document.querySelector('input[name="roomExpiryTime"]:checked');
            const expiryHours = expiryTimeRadio ? parseInt(expiryTimeRadio.value) : 3;

            if (!hostName) {
                alert('Ìò∏Ïä§Ìä∏ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }

            if (!roomName) {
                alert('Î∞© Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }

            if (isPrivate && (!password || password.length < 4)) {
                alert('ÎπÑÍ≥µÍ∞ú Î∞©ÏùÄ 4Ïûê Ïù¥ÏÉÅÏùò ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§!');
                return;
            }

            // Ïù¥Î¶Ñ Ï†ÄÏû•
            localStorage.setItem('horseRaceUserName', hostName);

            socket.emit('createRoom', {
                userName: hostName,
                roomName: roomName,
                isPrivate: isPrivate,
                password: isPrivate ? password : '',
                gameType: 'horse-race',
                expiryHours: expiryHours,
                blockIPPerUser: false,
                deviceId: getDeviceId()
            });
        }

        // Î∞© Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
        function refreshRooms() {
            socket.emit('getRooms');
        }

        // Î∞© Î™©Î°ù Î†åÎçîÎßÅ
        function renderRoomsList() {
            const roomsListEl = document.getElementById('roomsList');
            
            // Í≤ΩÎßà Î∞©Îßå ÌïÑÌÑ∞ÎßÅ
            const horseRaceRooms = roomsList.filter(room => room.gameType === 'horse-race');
            
            if (horseRaceRooms.length === 0) {
                roomsListEl.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">ÏÉùÏÑ±Îêú Í≤ΩÎßà Î∞©Ïù¥ ÏóÜÏäµÎãàÎã§</div>';
                return;
            }

            roomsListEl.innerHTML = '';

            horseRaceRooms.forEach(room => {
                const roomItem = document.createElement('div');
                const isMyRoom = room.roomId === currentRoomId;
                let className = 'room-item';
                if (isMyRoom) className += ' my-room';
                else if (room.roomId === selectedRoomId) className += ' active';
                roomItem.className = className;

                let statusClass = 'waiting';
                let statusText = 'ÎåÄÍ∏∞ Ï§ë';
                if (room.isGameActive) {
                    statusClass = 'playing';
                    statusText = 'Í≤åÏûÑ ÏßÑÌñâ Ï§ë';
                }

                const roomNameHtml = isMyRoom 
                    ? `${room.roomName}<span class="my-room-badge">Ï∞∏Ïó¨ Ï§ë</span>`
                    : room.roomName;

                const privateBadge = room.isPrivate 
                    ? '<span style="color: #ff6b6b; font-weight: bold; margin-left: 5px;">üîí</span>' 
                    : '';

                const buttonText = isMyRoom ? 'Ïû¨ÏûÖÏû•' : 'ÏûÖÏû•';

                roomItem.innerHTML = `
                    <div class="room-info">
                        <div class="room-name"><span style="font-size: 20px; margin-right: 5px;">üêé</span>${roomNameHtml}${privateBadge}</div>
                        <div class="room-details">Ìò∏Ïä§Ìä∏: ${room.hostName} | Ïù∏Ïõê: ${room.playerCount}Î™Ö</div>
                        <span class="room-status ${statusClass}">${statusText}</span>
                    </div>
                    <div class="room-action">
                        <button onclick="joinRoomDirectly('${room.roomId}')" style="color: #000; font-weight: 600;">${buttonText}</button>
                    </div>
                `;

                roomsListEl.appendChild(roomItem);
            });
        }

        // Î∞© ÏûÖÏû•
        function joinRoomDirectly(roomId) {
            const userName = document.getElementById('globalUserNameInput').value.trim();
            
            if (!userName) {
                alert('Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                document.getElementById('globalUserNameInput').focus();
                return;
            }

            const room = roomsList.find(r => r.roomId === roomId);
            if (room && room.isPrivate) {
                pendingRoomId = roomId;
                pendingUserName = userName;
                document.getElementById('passwordModal').style.display = 'flex';
                document.getElementById('roomPasswordInput').focus();
            } else {
                socket.emit('joinRoom', {
                    roomId: roomId,
                    userName: userName,
                    isHost: false,
                    password: '',
                    deviceId: getDeviceId()
                });
            }

            localStorage.setItem('horseRaceUserName', userName);
        }

        // ÎπÑÎ∞ÄÎ≤àÌò∏ Î™®Îã¨ Îã´Í∏∞
        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('roomPasswordInput').value = '';
            pendingRoomId = null;
            pendingUserName = null;
        }

        // ÎπÑÎ∞ÄÎ≤àÌò∏ Ï†úÏ∂ú
        function submitPassword() {
            const password = document.getElementById('roomPasswordInput').value;
            
            if (pendingRoomId && pendingUserName) {
                socket.emit('joinRoom', {
                    roomId: pendingRoomId,
                    userName: pendingUserName,
                    isHost: false,
                    password: password,
                    deviceId: getDeviceId()
                });
            }
            
            closePasswordModal();
        }

        // Î∞© ÎÇòÍ∞ÄÍ∏∞
        function leaveRoom() {
            if (confirm('Î∞©ÏùÑ ÎÇòÍ∞ÄÏãúÍ≤†ÏäµÎãàÍπå?')) {
                socket.emit('leaveRoom');
            }
        }

        // Ï§ÄÎπÑ Ìï®Ïàò (ReadyModule ÏúÑÏûÑ)
        function toggleReady() {
            ReadyModule.toggleReady();
        }
        function updateReadyButton() {
            ReadyModule.updateReadyButton();
        }
        function renderReadyUsers() {
            ReadyModule.renderReadyUsers();
        }
        
        // ÏãúÏûë Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        function updateStartButton() {
            const btn = document.getElementById('startHorseRaceButton');
            if (btn && isHost) {
                if (readyUsers.length >= 2 && !isRaceActive) {
                    btn.disabled = false;
                    btn.textContent = 'üêé Í≤ΩÎßà ÏãúÏûë!';
                } else {
                    btn.disabled = true;
                    btn.textContent = `üêé Í≤ΩÎßà ÏãúÏûë (${readyUsers.length}/2Î™Ö Ï§ÄÎπÑ)`;
                }
            }
        }

        // Í≤ΩÎßà ÏãúÏûë
        function startHorseRace() {
            addDebugLog('Í≤ΩÏ£º ÏãúÏûë ÏöîÏ≤≠', 'race');
            socket.emit('startHorseRace');
        }

        // Í≤åÏûÑ Î™®Îìú: Î¨¥Ï°∞Í±¥ Íº¥Îì± Ï∞æÍ∏∞ (Î™®Îìú ÏÑ†ÌÉù Ï†úÍ±∞)
        function updateGameMode() {
            socket.emit('updateGameRules', { horseRaceMode: 'last' });
        }

        // Îßê ÏÑ†ÌÉù
        function selectHorse(horseIndex) {
            addDebugLog(`ÌÉàÍ≤É ÏÑ†ÌÉù: ${horseIndex}`, 'selection');
            // Ïù¥ÎØ∏ ÏÑ†ÌÉùÌïú ÌÉàÍ≤ÉÏùÑ Îã§Ïãú ÏÑ†ÌÉùÌïòÎ©¥ Ï∑®ÏÜå
            // Îã§Î•∏ ÌÉàÍ≤ÉÏùÑ ÏÑ†ÌÉùÌïòÎ©¥ Ïû¨ÏÑ†ÌÉù (ÏÑúÎ≤ÑÏóêÏÑú Í≤ÄÏ¶ù)
            socket.emit('selectHorse', {
                horseIndex: horseIndex
            });
        }

        // ÌÉàÍ≤É ÏÑ†ÌÉù ÌôîÎ©¥Ïóê Ìä∏Îûô ÌëúÏãú (Ï¥àÍ∏∞ ÏÉÅÌÉú)
        function renderTrackForSelection() {
            const track = document.getElementById('raceTrack');
            const trackContainer = document.getElementById('raceTrackContainer');
            
            if (!track || !trackContainer) {
                console.warn('[renderTrackForSelection] track ÎòêÎäî trackContainerÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                return;
            }
            
            trackContainer.style.display = 'block';
            track.innerHTML = '';
            
            const trackWidth = trackContainer.offsetWidth || 700;
            const horseCount = availableHorses.length;
            
            if (horseCount === 0) {
                console.warn('[renderTrackForSelection] availableHorsesÍ∞Ä ÎπÑÏñ¥ÏûàÏùå');
                return;
            }
            
            const wallHeight = 6;
            const laneHeight = Math.min(75, Math.floor((350 - wallHeight * (horseCount - 1)) / horseCount));
            const totalLaneHeight = laneHeight + wallHeight;
            
            console.log('[renderTrackForSelection] ÏãúÏûë:', {
                horseCount,
                selectedVehicleTypes: selectedVehicleTypes,
                ALL_VEHICLES: ALL_VEHICLES.length,
                vehicleThemes: Object.keys(vehicleThemes).length
            });
            
            availableHorses.forEach((horseIndex, rank) => {
                // selectedVehicleTypesÍ∞Ä ÏûàÏúºÎ©¥ ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ ALL_VEHICLESÏóêÏÑú Í∞ÄÏ†∏Ïò§Í∏∞
                // Îßê ÏÑ†ÌÉù ÌôîÎ©¥ÏóêÏÑúÎäî availableHorses ÏàúÏÑúÎåÄÎ°ú ÌëúÏãúÌïòÎØÄÎ°ú horseIndexÎ•º Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©
                const vehicleId = selectedVehicleTypes && selectedVehicleTypes[horseIndex] 
                    ? selectedVehicleTypes[horseIndex] 
                    : (ALL_VEHICLES.length > 0 ? ALL_VEHICLES[horseIndex % ALL_VEHICLES.length].id : 'car');
                
                console.log(`[renderTrackForSelection] Îßê ${horseIndex} (rank ${rank}): vehicleId=${vehicleId}`);
                
                const vehicle = ALL_VEHICLES.find(v => v.id === vehicleId) || ALL_VEHICLES[0];

                const { lane, vehicleBg } = createLane({ vehicleId, topPx: rank * totalLaneHeight, laneHeight, isRacing: false });
                track.appendChild(lane);

                if (rank < horseCount - 1) {
                    track.appendChild(createWall({ topPx: rank * totalLaneHeight + laneHeight, wallHeight }));
                }
                
                // ÌÉàÍ≤É ÌëúÏãú (ÏãúÏûë ÏúÑÏπò)
                const horse = document.createElement('div');
                horse.className = 'horse idle';
                horse.id = `horse_preview_${horseIndex}`;
                horse.className = 'horse idle';
                horse.style.cssText = `
                    position: absolute;
                    left: 10px;
                    top: ${rank * totalLaneHeight + 10}px;
                    width: 80px;
                    height: ${laneHeight - 10}px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    z-index: ${100 - rank};
                `;
                
                // ÏÑ†ÌÉùÌïú Î™®Îì† ÏÇ¨Ïö©Ïûê Ïù¥Î¶Ñ ÌëúÏãú (Ï§ëÎ≥µ ÏÑ†ÌÉù Í∞ÄÎä•)
                const selectedUsers = Object.entries(userHorseBets)
                    .filter(([_, h]) => h === horseIndex)
                    .map(([name, _]) => name);
                
                // ÌÉàÍ≤É Ïä§ÌîÑÎùºÏù¥Ìä∏
                const vehicleContent = document.createElement('div');
                vehicleContent.className = 'vehicle-sprite';

                const frame1 = document.createElement('div');
                frame1.className = 'frame1';
                const frame2 = document.createElement('div');
                frame2.className = 'frame2';
                const vehicleSVGs = getVehicleSVG(vehicleId);
                const idleData = vehicleSVGs.idle || vehicleSVGs.run || vehicleSVGs;
                frame1.innerHTML = idleData.frame1 || vehicleSVGs.frame1;
                frame2.innerHTML = (idleData.frame2 || vehicleSVGs.frame2) || '';

                vehicleContent.appendChild(frame1);
                vehicleContent.appendChild(frame2);
                horse.appendChild(vehicleContent);
                horse.dataset.vehicleId = vehicleId;

                // ÎÇ¥Í∞Ä ÏÑ†ÌÉùÌïú ÌÉàÍ≤É ÏúÑÏóê ÌôîÏÇ¥Ìëú ÌëúÏãú
                if (userHorseBets[currentUser] === horseIndex) {
                    const arrow = document.createElement('div');
                    arrow.className = 'my-horse-arrow';
                    arrow.innerHTML = '‚ñº';
                    arrow.style.cssText = `
                        position: absolute;
                        top: -18px;
                        left: 50%;
                        transform: translateX(-50%);
                        font-size: 16px;
                        color: #ffd700;
                        text-shadow: 0 0 6px rgba(255,215,0,0.8);
                        animation: arrowBounce 0.8s ease-in-out infinite;
                        pointer-events: none;
                        z-index: 300;
                    `;
                    horse.style.overflow = 'visible';
                    horse.appendChild(arrow);
                }

                track.appendChild(horse);

                // Ïù¥Î¶Ñ ÎùºÎ≤®ÏùÑ Î†àÏù∏ ÏôºÏ™ΩÏóê ÌëúÏãú
                if (selectedUsers.length > 0) {
                    const namesContainer = document.createElement('div');
                    namesContainer.className = 'names-container';
                    namesContainer.style.cssText = `
                        position: absolute;
                        top: ${rank * totalLaneHeight + 5}px;
                        left: 5px;
                        display: flex;
                        flex-wrap: wrap;
                        gap: 3px;
                        z-index: 200;
                        max-width: 250px;
                    `;

                    // ÎÇ¥ Ïù¥Î¶ÑÏù¥ Î®ºÏ†Ä Ïò§ÎèÑÎ°ù Ï†ïÎ†¨
                    const sortedUsers = [...selectedUsers].sort((a, b) => {
                        if (a === currentUser) return -1;
                        if (b === currentUser) return 1;
                        return 0;
                    });

                    sortedUsers.forEach(userName => {
                        const nameTag = document.createElement('span');
                        const isMe = userName === currentUser;

                        if (isMe) {
                            // ÎÇ¥ ÌÉàÍ≤É: Í∏àÏÉâ Î∞∞Í≤Ω + Í≤ÄÏùÄ Í∏ÄÏî® + ÌÖåÎëêÎ¶¨ + ÌÅ∞ Ìè∞Ìä∏
                            nameTag.style.cssText = `
                                background: linear-gradient(135deg, #ffd700, #ffaa00);
                                color: #000;
                                padding: 2px 6px;
                                border-radius: 4px;
                                font-size: 11px;
                                line-height: 16px;
                                font-weight: bold;
                                white-space: nowrap;
                                border: 2px solid #fff;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.5), 0 0 8px rgba(255,215,0,0.6);
                                text-shadow: 0 1px 1px rgba(255,255,255,0.5);
                            `;
                            nameTag.textContent = '‚≠ê ' + userName;
                        } else {
                            // Îã§Î•∏ ÏÇ¨Ïö©Ïûê: Í∞úÏÑ†Îêú Í∞ÄÎèÖÏÑ±
                            nameTag.style.cssText = `
                                background: rgba(0,0,0,0.75);
                                color: #fff;
                                padding: 2px 5px;
                                border-radius: 3px;
                                font-size: 10px;
                                line-height: 15px;
                                font-weight: bold;
                                white-space: nowrap;
                                border: 1px solid rgba(255,255,255,0.3);
                                text-shadow: 0 1px 2px rgba(0,0,0,0.8);
                            `;
                            nameTag.textContent = userName;
                        }
                        namesContainer.appendChild(nameTag);
                    });

                    track.appendChild(namesContainer);
                }
            });
        }
        
        // ÌÉàÍ≤É ÏÑ†ÌÉù UI Î†åÎçîÎßÅ
        function renderHorseSelection() {
            const grid = document.getElementById('horseSelectionGrid');
            const info = document.getElementById('horseSelectionInfo');
            
            console.log('[renderHorseSelection] ÏãúÏûë', {
                grid: !!grid,
                availableHorses: availableHorses.length,
                ALL_VEHICLES: ALL_VEHICLES.length,
                selectedVehicleTypes: selectedVehicleTypes,
                vehicleThemes_loaded: Object.keys(vehicleThemes).length
            });
            
            if (!grid) {
                console.error('[renderHorseSelection] grid ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                return;
            }
            
            grid.innerHTML = '';

            // Ìä∏Îûô Í∏∏Ïù¥ ÏÑ†ÌÉù UI (Î∞©Ïû• Ï†ÑÏö©)
            let trackLengthContainer = document.getElementById('trackLengthSelector');
            if (!trackLengthContainer) {
                trackLengthContainer = document.createElement('div');
                trackLengthContainer.id = 'trackLengthSelector';
                trackLengthContainer.style.cssText = 'display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px;';
                grid.parentElement.insertBefore(trackLengthContainer, grid);
            }
            if (isHost) {
                const trackColors = { short: '#4ade80', medium: '#60a5fa', long: '#fbbf24' };
                const trackLabels = { short: 'ÏßßÍ≤å', medium: 'Î≥¥ÌÜµ', long: 'Í∏∏Í≤å' };
                const presets = trackPresetsFromServer;
                let btnsHtml = '<span style="font-size: 12px; color: #ccc;">Ìä∏Îûô:</span>';
                for (const key of ['short', 'medium', 'long']) {
                    const isActive = currentTrackLength === key;
                    btnsHtml += `<button class="track-length-btn" data-length="${key}"
                        style="padding: 4px 10px; border-radius: 12px; border: 1px solid #555; background: ${isActive ? trackColors[key] : '#333'}; color: ${isActive ? '#000' : '#ccc'}; cursor: pointer; font-size: 11px; font-weight: bold;">
                        ${trackLabels[key]} (${presets[key]}m)
                    </button>`;
                }
                trackLengthContainer.innerHTML = btnsHtml;
                trackLengthContainer.querySelectorAll('.track-length-btn').forEach(btn => {
                    btn.onclick = () => {
                        // Ï¶âÏãú Î≥ÄÏàò Í∞±Ïã† (ÎÇôÍ¥ÄÏ†Å ÏóÖÎç∞Ïù¥Ìä∏)
                        currentTrackLength = btn.dataset.length;
                        currentTrackDistanceMeters = trackPresetsFromServer[btn.dataset.length] || 500;

                        // Ï¶âÏãú ÏÑ†ÌÉù ÌîºÎìúÎ∞±
                        trackLengthContainer.querySelectorAll('.track-length-btn').forEach(b => {
                            b.style.background = '#333';
                            b.style.color = '#ccc';
                            b.style.boxShadow = 'none';
                        });
                        const colors = { short: '#4ade80', medium: '#60a5fa', long: '#fbbf24' };
                        btn.style.background = colors[btn.dataset.length] || '#4ade80';
                        btn.style.color = '#000';
                        btn.style.boxShadow = '0 0 8px ' + (colors[btn.dataset.length] || '#4ade80') + '80';
                        socket.emit('setTrackLength', { trackLength: btn.dataset.length });

                        // Ìä∏Îûô ÎØ∏Î¶¨Î≥¥Í∏∞ Ï¶âÏãú Í∞±Ïã†
                        renderTrackForSelection();
                    };
                });
                trackLengthContainer.style.display = 'flex';
            } else {
                trackLengthContainer.innerHTML = `<span style="display: inline-block; padding: 6px 16px; border-radius: 12px; background: linear-gradient(135deg, #1e293b, #334155); border: 1px solid #475569; font-size: 14px; font-weight: bold; color: #e2e8f0; letter-spacing: 1px;">üèÅ <span id="trackLengthInfo" style="color: #60a5fa;">${currentTrackDistanceMeters}m</span></span>`;
                trackLengthContainer.style.display = 'flex';
            }

            // Ìä∏Îûô ÌëúÏãú (Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ Ìè¨Ìï®)
            // selectedVehicleTypesÍ∞Ä ÏÑ§Ï†ïÎêòÏñ¥ ÏûàÏñ¥Ïïº Î∞∞Í≤ΩÏù¥ Ï†úÎåÄÎ°ú ÌëúÏãúÎê®
            console.log('[renderHorseSelection] renderTrackForSelection Ìò∏Ï∂ú Ï†Ñ:', {
                selectedVehicleTypes: selectedVehicleTypes,
                availableHorses: availableHorses.length,
                vehicleThemes_loaded: Object.keys(vehicleThemes).length > 0
            });
            
            // vehicleThemesÍ∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏúºÎ©¥ Î°úÎìú ÎåÄÍ∏∞
            if (Object.keys(vehicleThemes).length === 0) {
                console.warn('[renderHorseSelection] vehicleThemesÍ∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏùå, Î°úÎìú ÎåÄÍ∏∞...');
                loadVehicleThemes().then(() => {
                    renderTrackForSelection();
                }).catch(() => {
                    renderTrackForSelection(); // Ìè¥Î∞±ÏúºÎ°ú Î†åÎçîÎßÅ
                });
            } else {
                renderTrackForSelection();
            }
            
            if (availableHorses.length === 0) {
                info.textContent = 'ÌÉàÍ≤É Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...';
                console.warn('[renderHorseSelection] availableHorsesÍ∞Ä ÎπÑÏñ¥ÏûàÏùå');
                return;
            }
            
            // ALL_VEHICLESÍ∞Ä ÏïÑÏßÅ Î°úÎìúÎêòÏßÄ ÏïäÏïòÏúºÎ©¥ Ìè¥Î∞± Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©
            if (ALL_VEHICLES.length === 0) {
                console.warn('[renderHorseSelection] ALL_VEHICLESÍ∞Ä ÎπÑÏñ¥ÏûàÏùå, Ìè¥Î∞± Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©');
                // Ìè¥Î∞± Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï
                ALL_VEHICLES = [
                    { id: 'car', name: 'ÏûêÎèôÏ∞®', emoji: 'üöó', bgType: 'expressway' },
                    { id: 'rocket', name: 'Î°úÏºì', emoji: 'üöÄ', bgType: 'sky' },
                    { id: 'bird', name: 'ÏÉà', emoji: 'üê¶', bgType: 'sky' },
                    { id: 'boat', name: 'Î≥¥Ìä∏', emoji: 'üö§', bgType: 'ocean' },
                    { id: 'bicycle', name: 'ÏûêÏ†ÑÍ±∞', emoji: 'üö¥', bgType: 'road' },
                    { id: 'rabbit', name: 'ÌÜ†ÎÅº', emoji: 'üêá', bgType: 'forest' },
                    { id: 'turtle', name: 'Í±∞Î∂ÅÏù¥', emoji: 'üê¢', bgType: 'forest' },
                    { id: 'eagle', name: 'ÎèÖÏàòÎ¶¨', emoji: 'ü¶Ö', bgType: 'sky' },
                    { id: 'scooter', name: 'ÌÇ•Î≥¥Îìú', emoji: 'üõ¥', bgType: 'road' },
                    { id: 'helicopter', name: 'Ìó¨Î¶¨ÏΩ•ÌÑ∞', emoji: 'üöÅ', bgType: 'sky' },
                    { id: 'horse', name: 'Îßê', emoji: 'üêé', bgType: 'forest' }
                ];
                // ÎπÑÎèôÍ∏∞Î°ú Î°úÎìú ÏãúÎèÑ (ÎÇòÏ§ëÏóê ÏóÖÎç∞Ïù¥Ìä∏Îê®)
                loadVehicleThemes().catch(err => {
                    console.error('[renderHorseSelection] ÌÖåÎßà Î°úÎìú Ïã§Ìå®:', err);
                });
            }

            // Ï∂îÏ≤ú ÌÉàÍ≤É Í≥ÑÏÇ∞: ÌòÑÏû¨ Î∞∞ÌåÖ Í∞ÄÎä•Ìïú ÌÉàÍ≤É Ï§ë 1Îì± ÎπÑÏú®Ïù¥ Í∞ÄÏû• ÎÇÆÏùÄ Í≤É (ÏäπÎ•† ÌèâÏ§ÄÌôî)
            let recommendedVehicleId = null;
            if (vehicleStatsData.length > 0) {
                let lowestWinRate = Infinity;
                availableHorses.forEach(hi => {
                    const vid = selectedVehicleTypes ? selectedVehicleTypes[hi] : ALL_VEHICLES[hi % ALL_VEHICLES.length].id;
                    const st = vehicleStatsData.find(s => s.vehicle_id === vid);
                    if (st && st.appearance_count >= 5) {
                        const winRate = st.rank_1 / st.appearance_count;
                        if (winRate < lowestWinRate) {
                            lowestWinRate = winRate;
                            recommendedVehicleId = vid;
                        }
                    }
                });
            }

            availableHorses.forEach((horseIndex, index) => {
                const button = document.createElement('button');
                button.className = 'horse-selection-button';
                button.id = `horseButton_${horseIndex}`;
                
                // ÌÉàÍ≤É ÌÉÄÏûÖ Í∞ÄÏ†∏Ïò§Í∏∞
                const vehicleId = selectedVehicleTypes ? selectedVehicleTypes[horseIndex] : ALL_VEHICLES[horseIndex % ALL_VEHICLES.length].id;
                const vehicle = ALL_VEHICLES.find(v => v.id === vehicleId) || ALL_VEHICLES[0];
                
                // ÎÇ¥ ÏÑ†ÌÉù Ïó¨Î∂ÄÎßå ÌôïÏù∏ (ÌÉÄÏù∏ ÏÑ†ÌÉù Ï†ïÎ≥¥Îäî ÏÑúÎ≤ÑÏóêÏÑú Ïà®ÍπÄ)
                const isMyHorse = userHorseBets[currentUser] === horseIndex;

                // Ï∞∏Í∞ÄÏûê Ïàò Í≥ÑÏÇ∞
                const totalPlayers = currentUsers.length > 0 ? currentUsers.length :
                                    (readyUsers.length > 0 ? readyUsers.length : 1);

                // ÎîîÎ≤ÑÍπÖÏö© Î°úÍ∑∏
                if (index === 0) {
                    console.log('[Îßê ÏÑ†ÌÉù]', {
                        availableHorses: availableHorses.length,
                        totalPlayers,
                        currentUsers: currentUsers.length,
                        readyUsers: readyUsers.length,
                        isHost: isHost,
                        currentUser: currentUser,
                        selectedUsersFromServer: selectedUsersFromServer.length
                    });
                }

                // ÌÉÄÏù∏ ÏÑ†ÌÉù Ïó¨Î∂ÄÎ•º Ïïå Ïàò ÏóÜÏúºÎØÄÎ°ú ÎπÑÌôúÏÑ±ÌôîÌïòÏßÄ ÏïäÏùå
                // ÏÑúÎ≤ÑÏóêÏÑú Ï§ëÎ≥µ ÏÑ†ÌÉù Ïãú ÏóêÎü¨ Ï≤òÎ¶¨ ("Ïù¥ÎØ∏ ÏÑ†ÌÉùÎêú ÎßêÏûÖÎãàÎã§!" Î∞òÌôò)
                button.disabled = false;
                
                if (isMyHorse) {
                    button.classList.add('selected');
                    mySelectedHorse = horseIndex;
                }
                
                // ÌÉàÍ≤É Î≤ÑÌäº ÎÇ¥Ïö© ÏÉùÏÑ± (SVG idle Ïï†ÎãàÎ©îÏù¥ÏÖò - 4ÌîÑÎ†àÏûÑ)
                const svgData = getVehicleSVG(vehicleId);
                const idleData = svgData.idle || svgData.run || svgData;
                let vehicleDisplay = '';
                if (idleData && idleData.frame1) {
                    const uid = `idle_${horseIndex}`;
                    // 4ÌîÑÎ†àÏûÑ: frame1(ÏõêÏúÑÏπò) ‚Üí frame2(ÏÇ¥ÏßùÏúÑ) ‚Üí frame1(ÏõêÏúÑÏπò) ‚Üí frame2(ÏÇ¥ÏßùÏïÑÎûò)
                    vehicleDisplay = `<div style="width: 60px; height: 45px; margin: 0 auto; position: relative;">
                        <div id="${uid}_wrap" style="position:absolute;inset:0;transition:transform 0.3s ease-in-out;">
                            <div id="${uid}_f1" style="position:absolute;inset:0;">${idleData.frame1}</div>
                            <div id="${uid}_f2" style="position:absolute;inset:0;opacity:0;">${idleData.frame2 || idleData.frame1}</div>
                        </div>
                    </div>`;
                } else {
                    vehicleDisplay = `<div style="font-size: 48px;">${vehicle.emoji}</div>`;
                }
                let content = vehicleDisplay;
                const isPopular = popularVehicles.includes(vehicleId);
                content += `<div style="font-size: 14px; margin-top: 5px; font-weight: 600;">${vehicle.name}${isPopular ? ' <span style="font-size: 10px; background: #ff6b35; color: #fff; padding: 1px 5px; border-radius: 8px; vertical-align: middle;">Ïù∏Í∏∞</span>' : ''}</div>`;

                // Ï∂îÏ≤ú Î±ÉÏßÄ ÌëúÏãú (1Îì± ÎπÑÏú®Ïù¥ Í∞ÄÏû• ÎÇÆÏùÄ ÌÉàÍ≤É = ÏäπÎ•† ÌèâÏ§ÄÌôî Î™©Ï†Å)
                if (vehicleId === recommendedVehicleId) {
                    content += `<div style="margin-top: 3px;"><span style="font-size: 10px; background: #e74c3c; color: #fff; padding: 1px 6px; border-radius: 8px;">Ï∂îÏ≤ú!</span></div>`;
                }

                // ÎÇ¥ ÏÑ†ÌÉùÎßå ÌëúÏãú (ÌÉÄÏù∏ ÏÑ†ÌÉùÏùÄ Ïà®ÍπÄ - Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ ÌõÑ Í≥µÍ∞ú)
                if (isMyHorse) {
                    content += `<div style="font-size: 12px; margin-top: 5px; color: #8b4513; font-weight: bold;">‚úì ÎÇ¥Í∞Ä ÏÑ†ÌÉù</div>`;
                }
                // ÌÉÄÏù∏ ÏÑ†ÌÉùÏùÄ ÌÉàÍ≤É Î≤ÑÌäºÏóê ÌëúÏãúÌïòÏßÄ ÏïäÏùå (Ïú†Ï∂î Î∞©ÏßÄ)
                
                button.innerHTML = content;
                
                button.onclick = () => {
                    // ÎπÑÌôúÏÑ±ÌôîÎêú Î≤ÑÌäºÏùÄ ÏÑ†ÌÉù Î∂àÍ∞Ä
                    if (button.disabled) {
                        console.log(`[Îßê ÏÑ†ÌÉù] ${vehicle.name}ÏùÄ(Îäî) ÏÑ†ÌÉùÌï† Ïàò ÏóÜÏäµÎãàÎã§ (Ïù¥ÎØ∏ Îã§Î•∏ ÏÇ¨ÎûåÏù¥ ÏÑ†ÌÉùÌï®)`);
                        return;
                    }
                    
                    // Í∞ôÏùÄ ÌÉàÍ≤ÉÏùÑ Îã§Ïãú ÏÑ†ÌÉùÌïòÎ©¥ Ï∑®ÏÜå, Îã§Î•∏ ÌÉàÍ≤ÉÏùÑ ÏÑ†ÌÉùÌïòÎ©¥ Ïû¨ÏÑ†ÌÉù
                    selectHorse(horseIndex);
                };
                
                grid.appendChild(button);
            });
            
            console.log('[renderHorseSelection] ÏôÑÎ£å', {
                ÏÉùÏÑ±Îêú_Î≤ÑÌäº_Ïàò: grid.children.length,
                availableHorses: availableHorses.length
            });

            // ÏÑ†ÌÉù Ï†ïÎ≥¥Îäî "ÌÉàÍ≤É ÏÑ†ÌÉù ÏïàÌïú ÏÇ¨Îûå" ÏÑπÏÖòÏóêÏÑú ÌëúÏãú (Ï£ºÏÇ¨ÏúÑ Í≤åÏûÑÍ≥º ÎèôÏùºÌïú Î∞©Ïãù)
            info.innerHTML = '';

            // idle Ïï†ÎãàÎ©îÏù¥ÏÖò (4ÌîÑÎ†àÏûÑ ÏÇ¨Ïù¥ÌÅ¥: f1‚Üë ‚Üí f2‚Üí ‚Üí f1‚Üì ‚Üí f2‚Üí)
            if (window._idleAnimInterval) clearInterval(window._idleAnimInterval);
            let idleFrame = 0;
            const idleYOffsets = [0, -2, 0, 2]; // ÏúÑÏïÑÎûò ÌùîÎì§Î¶º
            window._idleAnimInterval = setInterval(() => {
                const phase = idleFrame % 4;
                const showF1 = phase === 0 || phase === 2;
                const yOff = idleYOffsets[phase];
                availableHorses.forEach((hi) => {
                    const wrap = document.getElementById(`idle_${hi}_wrap`);
                    const f1 = document.getElementById(`idle_${hi}_f1`);
                    const f2 = document.getElementById(`idle_${hi}_f2`);
                    if (wrap && f1 && f2) {
                        wrap.style.transform = `translateY(${yOff}px)`;
                        f1.style.opacity = showF1 ? '1' : '0';
                        f2.style.opacity = showF1 ? '0' : '1';
                    }
                });
                idleFrame++;
            }, 300);

            // ÌÉàÍ≤É ÏÑ†ÌÉù ÏïàÌïú ÏÇ¨Îûå ÌëúÏãú (Ï£ºÏÇ¨ÏúÑ Í≤åÏûÑÏùò "Ï£ºÏÇ¨ÏúÑ Ïïà Íµ¥Î¶∞ ÏÇ¨Îûå"Í≥º ÎèôÏùºÌïú Î∞©Ïãù)
            const notSelectedSection = document.getElementById('notSelectedVehicleSection');
            const notSelectedList = document.getElementById('notSelectedVehicleList');
            if (notSelectedSection && notSelectedList) {
                const notSelectedUsers = readyUsers.filter(name => !selectedUsersFromServer.includes(name));
                if (notSelectedUsers.length > 0 && readyUsers.length > 0) {
                    notSelectedSection.style.display = 'block';
                    notSelectedList.innerHTML = '';
                    notSelectedUsers.sort((a, b) => a.localeCompare(b, 'ko')).forEach(name => {
                        const tag = document.createElement('div');
                        tag.className = 'not-rolled-tag';
                        tag.textContent = name + (name === currentUser ? ' (ÎÇò)' : '');
                        notSelectedList.appendChild(tag);
                    });
                } else {
                    notSelectedSection.style.display = 'none';
                }
            }
        }

        // Í≤ΩÏ£º Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë (ÏÑúÎ≤ÑÏóêÏÑú Î∞õÏùÄ Í∏∞ÎØπ Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©)
        // Í≤åÏûÑ Ï¢ÖÎ£å Î≤ÑÌäº ÌÅ¨Í∏∞ Í≥ÑÏÇ∞ Ìï®Ïàò
        function getEndButtonWidth() {
            const endButton = document.querySelector('.end-button');
            return endButton ? endButton.offsetWidth : 200;
        }

        // ÏûêÎèô Ïä§ÌÅ¨Î°§ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateTrackScroll(trackContainer, leaderPosition, centerPosition) {
            if (!trackContainer) return;
            
            // ÎßêÏù¥ Ï§ëÏïôÏùÑ ÎÑòÏñ¥Í∞ÄÎ©¥ Ïä§ÌÅ¨Î°§ ÏãúÏûë
            if (leaderPosition > centerPosition) {
                const scrollAmount = leaderPosition - centerPosition;
                trackContainer.scrollLeft = scrollAmount;
            } else {
                // ÎßêÏù¥ Ï§ëÏïôÏóê ÎèÑÎã¨ÌïòÍ∏∞ Ï†ÑÏóêÎäî Ïä§ÌÅ¨Î°§ÌïòÏßÄ ÏïäÏùå
                trackContainer.scrollLeft = 0;
            }
        }

        // Í±∞Î¶¨ ÏãúÏä§ÌÖú ÏÉÅÏàò
        const PIXELS_PER_METER = 10;

        function startRaceAnimation(horseRankings, speeds, serverGimmicks, onComplete, trackOptions) {
            // idle Ïï†ÎãàÎ©îÏù¥ÏÖò Ï†ïÎ¶¨
            if (window._idleAnimInterval) { clearInterval(window._idleAnimInterval); window._idleAnimInterval = null; }
            // Ïù¥Ï†Ñ Í≤ΩÏ£ºÏùò ÏàúÏúÑ Ïù¥ÌéôÌä∏ Ï†ïÎ¶¨
            clearFinishEffects();
            
            const track = document.getElementById('raceTrack');
            const trackContainer = document.getElementById('raceTrackContainer');
            
            if (!track || !trackContainer) {
                console.error('Ìä∏Îûô Ïª®ÌÖåÏù¥ÎÑàÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
                if (onComplete) onComplete();
                return 5000;
            }
            
            if (!horseRankings || horseRankings.length === 0) {
                console.error('Îßê ÏàúÏúÑ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§', horseRankings);
                if (onComplete) onComplete();
                return 5000;
            }
            
            trackContainer.style.display = 'block';
            track.innerHTML = '';
            
            // Ïù¥Ï†Ñ ÎèÑÏ∞© Ïù¥ÌéôÌä∏ Ï†úÍ±∞
            document.querySelectorAll('.finish-effect').forEach(el => el.remove());
            
            // Ïª®ÌÖåÏù¥ÎÑà ÎÑàÎπÑ (Ïä§ÌÅ¨Î°§ ÏòÅÏó≠Ïùò Î∑∞Ìè¨Ìä∏ ÌÅ¨Í∏∞)
            const trackWidth = trackContainer.offsetWidth || 700;
            // ÏÑúÎ≤ÑÏóêÏÑú Î∞õÏùÄ Ìä∏Îûô Í±∞Î¶¨(m) Í∏∞Î∞ò finishLine, ÏóÜÏúºÎ©¥ Í∏∞Ï°¥ Î∞©Ïãù
            const trackDistanceMeters = (trackOptions && trackOptions.trackDistanceMeters) || 500;
            const finishLine = trackDistanceMeters * PIXELS_PER_METER;

            // ========== ÎÇ†Ïî® ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî ==========
            const weatherSchedule = (trackOptions && trackOptions.weatherSchedule) || [];
            const weatherConfig = (trackOptions && trackOptions.weatherConfig) || {};
            let currentWeather = weatherSchedule.length > 0 ? weatherSchedule[0].weather : 'sunny';
            let lastWeatherChangeIndex = 0;

            // ÎÇ†Ïî® Ïò§Î≤ÑÎ†àÏù¥ ÏÉùÏÑ±
            const weatherOverlay = document.createElement('div');
            weatherOverlay.className = 'weather-overlay';
            weatherOverlay.id = 'weatherOverlay';
            trackContainer.style.position = 'relative';
            trackContainer.appendChild(weatherOverlay);

            // ÎÇ†Ïî® Î∞∞ÎÑà ÏÉùÏÑ±
            const weatherBanner = document.createElement('div');
            weatherBanner.className = 'weather-banner';
            weatherBanner.id = 'weatherBanner';
            const weatherEmojis = { sunny: '‚òÄÔ∏è', rain: 'üåßÔ∏è', wind: 'üí®', fog: 'üå´Ô∏è' };
            const weatherNames = { sunny: 'ÎßëÏùå', rain: 'ÎπÑ', wind: 'Î∞îÎûå', fog: 'ÏïàÍ∞ú' };
            weatherBanner.textContent = `${weatherEmojis[currentWeather]} ${weatherNames[currentWeather]}`;
            // sunnyÏùº ÎïåÎäî Î∞∞ÎÑà Ïà®ÍπÄ
            if (currentWeather === 'sunny') {
                weatherBanner.style.display = 'none';
            }
            trackContainer.appendChild(weatherBanner);

            // ÎÇ†Ïî® ÌÜ†Ïä§Ìä∏ ÏΩîÎ©òÌä∏ (ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÎèÖÎ¶ΩÏ†Å - ÏÑúÎ≤Ñ ÎèôÍ∏∞Ìôî X)
            const weatherComments = {
                rain: [
                    "üåßÔ∏è ÎπÑÍ∞Ä ÎÇ¥Î¶¨Í∏∞ ÏãúÏûëÌï©ÎãàÎã§!",
                    "üö§ Î≥¥Ìä∏Í∞Ä Ïã†ÎÇòÌïòÎÑ§Ïöî!",
                    "üê∞ ÌÜ†ÎÅºÍ∞Ä ÎπÑÎ•º Ïã´Ïñ¥Ìï©ÎãàÎã§...",
                    "üö≤ ÏûêÏ†ÑÍ±∞ Ï°∞Ïã¨! ÎØ∏ÎÅÑÎü¨ÏõåÏöî!",
                    "üê¢ Í±∞Î∂ÅÏù¥ÏóêÍ≤ê Ï¢ãÏùÄ ÎÇ†Ïî®ÎÑ§Ïöî~"
                ],
                wind: [
                    "üí® Î∞îÎûåÏù¥ Î∂àÍ∏∞ ÏãúÏûëÌï©ÎãàÎã§!",
                    "ü¶Ö ÎèÖÏàòÎ¶¨Í∞Ä ÎÇ†Í∞úÎ•º ÌéºÏπ©ÎãàÎã§!",
                    "üöÅ Ìó¨Î¶¨ÏΩ•ÌÑ∞Í∞Ä ÌùîÎì§Î¶¨Í≥† ÏûàÏñ¥Ïöî!",
                    "üö≤ ÏûêÏ†ÑÍ±∞Í∞Ä ÌûòÎì§Ïñ¥Ìï©ÎãàÎã§..."
                ],
                fog: [
                    "üå´Ô∏è ÏïàÍ∞úÍ∞Ä ÎÅºÍ∏∞ ÏãúÏûëÌï©ÎãàÎã§!",
                    "üëÄ ÏïûÏù¥ Ïïà Î≥¥Ïó¨Ïöî!",
                    "üöÄ Î°úÏºìÏùÄ ÏïàÍ∞ú Îî∞ÏúÑ...",
                    "üê¶ ÏÉàÎì§Ïù¥ Î∞©Ìñ•ÏùÑ ÏûÉÏóàÏñ¥Ïöî!"
                ],
                sunny: [
                    "‚òÄÔ∏è ÎÇ†Ïî®Í∞Ä ÎßëÏïÑÏ°åÏäµÎãàÎã§!",
                    "üê∞ ÌÜ†ÎÅºÍ∞Ä Í∏∞ÎªêÌï©ÎãàÎã§!",
                    "‚òÄÔ∏è Îã¨Î¶¨Í∏∞ Ï¢ãÏùÄ ÎÇ†Ïî®ÎÑ§Ïöî!"
                ]
            };

            // ÎÇ†Ïî® Ìö®Í≥º Ï†ÅÏö© Ìï®Ïàò
            function applyWeatherEffect(weather) {
                weatherOverlay.className = 'weather-overlay';
                if (weather === 'rain') {
                    weatherOverlay.classList.add('weather-rain');
                } else if (weather === 'wind') {
                    weatherOverlay.classList.add('weather-wind');
                } else if (weather === 'fog') {
                    weatherOverlay.classList.add('weather-fog');
                }
                // sunnyÎäî Ìö®Í≥º ÏóÜÏùå (Í∏∞Î≥∏)
            }

            // ÎÇ†Ïî® ÌÜ†Ïä§Ìä∏ ÌëúÏãú Ìï®Ïàò
            function showWeatherToast(weather) {
                // sunnyÏùº ÎïåÎäî ÌÜ†Ïä§Ìä∏ ÌëúÏãú Ïïà Ìï®
                if (weather === 'sunny') return;
                const comments = weatherComments[weather] || [];
                if (comments.length === 0) return;
                const randomComment = comments[Math.floor(Math.random() * comments.length)];

                const toast = document.createElement('div');
                toast.className = 'weather-toast';
                toast.textContent = randomComment;
                trackContainer.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }

            // Î≤ÑÌîÑ/ÎîîÎ≤ÑÌîÑ ÌëúÏãú Ìï®Ïàò
            function showWeatherIndicators(horseStates, weather) {
                // sunnyÏùº ÎïåÎäî Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ ÌëúÏãú Ïïà Ìï®
                if (weather === 'sunny') return;
                const vehicleModifiers = weatherConfig.vehicleModifiers || {};

                horseStates.forEach(state => {
                    // Í∏∞Ï°¥ indicator Ï†úÍ±∞
                    const oldIndicator = state.horse.querySelector('.weather-indicator');
                    if (oldIndicator) oldIndicator.remove();

                    const vehicleId = selectedVehicleTypes && selectedVehicleTypes[state.horseIndex];
                    if (!vehicleId) return;

                    const mods = vehicleModifiers[vehicleId];
                    if (!mods) return;

                    const modifier = mods[weather] || 1;
                    const buffThreshold = 1.08; // +8% Ïù¥ÏÉÅÏù¥Î©¥ Î≤ÑÌîÑ
                    const nerfThreshold = 0.92; // -8% Ïù¥ÌïòÎ©¥ ÎîîÎ≤ÑÌîÑ

                    if (modifier >= buffThreshold) {
                        const indicator = document.createElement('div');
                        indicator.className = 'weather-indicator weather-buff';
                        indicator.textContent = '‚ñ≤';
                        state.horse.appendChild(indicator);
                    } else if (modifier <= nerfThreshold) {
                        const indicator = document.createElement('div');
                        indicator.className = 'weather-indicator weather-nerf';
                        indicator.textContent = '‚ñº';
                        state.horse.appendChild(indicator);
                    }
                });
            }

            // ÌòÑÏû¨ ÎÇ†Ïî® Í∞ÄÏ†∏Ïò§Í∏∞ Ìï®Ïàò
            function getCurrentWeatherFromSchedule(progress) {
                let weather = 'sunny';
                for (let i = 0; i < weatherSchedule.length; i++) {
                    if (progress >= weatherSchedule[i].progress) {
                        weather = weatherSchedule[i].weather;
                    } else {
                        break;
                    }
                }
                return weather;
            }

            // Ï¥àÍ∏∞ ÎÇ†Ïî® Ìö®Í≥º Ï†ÅÏö©
            applyWeatherEffect(currentWeather);

            // Ìä∏ÎûôÏùò ÎÑàÎπÑ: ÎèÑÏ∞© ÏßÄÏ†êÏùÄ Í∑∏ÎåÄÎ°ú, Í≤∞ÏäπÏÑ† Îí§ Ïó¨Ïú†Îßå ÏµúÏÜåÌôîÌï¥ Ïä§ÌÅ¨Î°§ Ïñë Ï§ÑÏûÑ
            track.style.width = `${finishLine + 30}px`; // Í≤∞ÏäπÏÑ† Îí§ Ïó¨Ïú†Îßå ÏÜåÎüâ
            
            const horseCount = horseRankings.length;
            const wallHeight = 6; // Î≤Ω ÎÜíÏù¥
            const laneHeight = Math.min(75, Math.floor((350 - wallHeight * (horseCount - 1)) / horseCount));
            const totalLaneHeight = laneHeight + wallHeight; // Î†àÏù∏ + Î≤Ω ÎÜíÏù¥
            
            console.log('Í≤ΩÏ£º ÏãúÏûë:', { horseRankings, speeds, trackWidth, finishLine, trackDistanceMeters });

            // Í±∞Î¶¨ ÎßàÏª§ ÏÉùÏÑ± (50m Í∞ÑÍ≤©)
            const markerInterval = 50; // 50mÎßàÎã§
            for (let m = markerInterval; m < trackDistanceMeters; m += markerInterval) {
                const markerPx = m * PIXELS_PER_METER;
                const marker = document.createElement('div');
                marker.className = 'distance-marker';
                marker.style.cssText = `position: absolute; left: ${markerPx}px; top: 0; height: 100%; width: 1px; background: rgba(255,255,255,0.08); z-index: 1; pointer-events: none;`;
                const label = document.createElement('span');
                label.style.cssText = `position: absolute; top: -14px; left: -12px; font-size: 9px; color: rgba(255,255,255,0.35); white-space: nowrap;`;
                label.textContent = `${m}m`;
                marker.appendChild(label);
                track.appendChild(marker);
            }

            // Í∞Å Îßê ÏÉùÏÑ± Î∞è Ïï†ÎãàÎ©îÏù¥ÏÖò (Î™®Îì† ÎßêÏùÑ Î®ºÏ†Ä ÏÉùÏÑ±)
            const horseElements = [];
            let maxDuration = 0;
            
            // ÏÑ†ÌÉù ÌôîÎ©¥ÏóêÏÑú Î≥∏ ÏõêÎûò ÏàúÏÑú Ïú†ÏßÄ (availableHorses ÏàúÏÑú)
            // horseRankingsÎäî ÏàúÏúÑ ÏàúÏÑúÏù¥ÎØÄÎ°ú, ÏõêÎûò Îßê Ïù∏Îç±Ïä§ ÏàúÏÑúÎ°ú Îß§Ìïë
            const originalHorseOrder = availableHorses.length > 0 ? availableHorses : 
                                      (horseRankings.length > 0 ? [...new Set(horseRankings)].sort((a, b) => a - b) : []);
            
            console.log('[startRaceAnimation] ÏãúÏûë:', {
                horseRankings: horseRankings,
                selectedVehicleTypes: selectedVehicleTypes,
                availableHorses: availableHorses
            });
            
            // Îßê ÏÑ†ÌÉù ÌôîÎ©¥Í≥º ÎèôÏùºÌïú ÏàúÏÑúÎ°ú Î†àÏù∏ Î∞∞Ïπò (availableHorses ÏàúÏÑú)
            availableHorses.forEach((horseIndex, laneIndex) => {
                // ÌÉàÍ≤É ÌÉÄÏûÖ Í∞ÄÏ†∏Ïò§Í∏∞: ÏÑ†ÌÉù ÌôîÎ©¥ÏóêÏÑú Î≥∏ ÏõêÎûò ÏàúÏÑúÎåÄÎ°ú
                const vehicleId = selectedVehicleTypes && selectedVehicleTypes[horseIndex] 
                    ? selectedVehicleTypes[horseIndex] 
                    : (ALL_VEHICLES.length > 0 ? ALL_VEHICLES[horseIndex % ALL_VEHICLES.length].id : 'car');
                
                // Ìï¥Îãπ ÎßêÏùò ÏàúÏúÑ Ï∞æÍ∏∞ (horseRankingsÏóêÏÑú horseIndexÏùò ÏúÑÏπò)
                const rank = horseRankings.indexOf(horseIndex);
                
                console.log(`[startRaceAnimation] laneIndex ${laneIndex}: horseIndex=${horseIndex}, vehicleId=${vehicleId}, rank=${rank} (${rank === 0 ? '1Îì±' : rank === 1 ? '2Îì±' : rank === 2 ? '3Îì±' : rank + 1 + 'Îì±'})`);
                
                const { lane, vehicleBg } = createLane({ vehicleId, topPx: laneIndex * totalLaneHeight, laneHeight, isRacing: true });

                if (laneIndex < horseCount - 1) {
                    track.appendChild(createWall({ topPx: laneIndex * totalLaneHeight + laneHeight, wallHeight }));
                }

                // Í∞Å Î†àÏù∏Î≥Ñ Í≤∞ÏäπÏÑ† Ï∂îÍ∞Ä (Î∞∞Í≤ΩÍ≥º Ìï®Íªò Ïä§ÌÅ¨Î°§Îê®)
                const laneFinishLine = document.createElement('div');
                laneFinishLine.className = 'finish-line';
                laneFinishLine.style.cssText = `
                    position: absolute;
                    left: ${finishLine}px;
                    top: 0;
                    width: 6px;
                    height: 100%;
                `;
                lane.appendChild(laneFinishLine);
                lane.finishLineElement = laneFinishLine;
                
                track.appendChild(lane);
                
                const horse = document.createElement('div');
                horse.className = 'horse idle';
                horse.id = `horse_${horseIndex}`;
                horse.style.cssText = `
                    position: absolute;
                    left: 10px;
                    top: ${laneIndex * totalLaneHeight + 10}px;
                    width: 80px;
                    height: ${laneHeight - 10}px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    z-index: ${100 - laneIndex};
                `;
                
                // ÏÑ†ÌÉùÌïú Î™®Îì† ÏÇ¨Ïö©Ïûê Ïù¥Î¶Ñ ÌëúÏãú (Ï§ëÎ≥µ ÏÑ†ÌÉù Í∞ÄÎä•)
                const selectedUsers = Object.entries(userHorseBets)
                    .filter(([_, h]) => h === horseIndex)
                    .map(([name, _]) => name);
                
                // ÌÉàÍ≤É Ïä§ÌîÑÎùºÏù¥Ìä∏ (2ÌîÑÎ†àÏûÑ Ïï†ÎãàÎ©îÏù¥ÏÖò)
                const vehicleContent = document.createElement('div');
                vehicleContent.className = 'vehicle-sprite';
                
                const frame1 = document.createElement('div');
                frame1.className = 'frame1';
                const frame2 = document.createElement('div');
                frame2.className = 'frame2';
                
                // ÌÉàÍ≤ÉÎ≥Ñ SVG ÏÉùÏÑ± (idle ÏÉÅÌÉúÎ°ú ÏãúÏûë, ÏóÜÏúºÎ©¥ run)
                const vehicleSVGs = getVehicleSVG(vehicleId);
                const idleData = vehicleSVGs.idle || vehicleSVGs.run || vehicleSVGs;
                frame1.innerHTML = idleData.frame1 || vehicleSVGs.frame1;
                frame2.innerHTML = (idleData.frame2 || vehicleSVGs.frame2) || '';

                vehicleContent.appendChild(frame1);
                vehicleContent.appendChild(frame2);

                horse.appendChild(vehicleContent);
                horse.dataset.vehicleId = vehicleId;

                // Î™®Îì† ÎßêÏóê ÌôîÏÇ¥Ìëú ÏÉùÏÑ± (Ïπ¥Î©îÎùº ÌÉÄÍ≤üÏóê Îî∞Îùº ÎèôÏ†ÅÏúºÎ°ú ÌëúÏãú)
                const arrow = document.createElement('div');
                arrow.className = 'camera-target-arrow';
                arrow.dataset.horseIndex = horseIndex;
                arrow.innerHTML = '‚ñº';
                arrow.style.cssText = `
                    position: absolute;
                    top: -18px;
                    left: 50%;
                    transform: translateX(-50%);
                    font-size: 16px;
                    color: #e94560;
                    text-shadow: 0 0 4px rgba(233,69,96,0.6);
                    animation: arrowBounce 0.8s ease-in-out infinite;
                    pointer-events: none;
                    z-index: 300;
                    display: none;
                `;
                horse.style.overflow = 'visible';
                horse.appendChild(arrow);

                track.appendChild(horse);

                // Ïù¥Î¶Ñ ÎùºÎ≤®ÏùÑ Î†àÏù∏ ÏôºÏ™Ω ÏÉÅÎã®Ïóê ÌëúÏãú
                if (selectedUsers.length > 0) {
                    const namesContainer = document.createElement('div');
                    namesContainer.className = 'names-container';
                    namesContainer.style.cssText = `
                        position: absolute;
                        top: ${laneIndex * totalLaneHeight + 1}px;
                        left: 3px;
                        display: flex;
                        flex-wrap: wrap;
                        gap: 3px;
                        z-index: 200;
                        max-width: 250px;
                    `;

                    // ÎÇ¥ Ïù¥Î¶ÑÏù¥ Î®ºÏ†Ä Ïò§ÎèÑÎ°ù Ï†ïÎ†¨
                    const sortedUsers = [...selectedUsers].sort((a, b) => {
                        if (a === currentUser) return -1;
                        if (b === currentUser) return 1;
                        return 0;
                    });

                    sortedUsers.forEach(userName => {
                        const nameTag = document.createElement('span');
                        const isMe = userName === currentUser;

                        if (isMe) {
                            // ÎÇ¥ ÌÉàÍ≤É: Í∏àÏÉâ Î∞∞Í≤Ω + Í≤ÄÏùÄ Í∏ÄÏî® + ÌÖåÎëêÎ¶¨ + ÌÅ∞ Ìè∞Ìä∏
                            nameTag.style.cssText = `
                                background: linear-gradient(135deg, #ffd700, #ffaa00);
                                color: #000;
                                padding: 2px 6px;
                                border-radius: 4px;
                                font-size: 11px;
                                line-height: 16px;
                                font-weight: bold;
                                white-space: nowrap;
                                border: 2px solid #fff;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.5), 0 0 8px rgba(255,215,0,0.6);
                                text-shadow: 0 1px 1px rgba(255,255,255,0.5);
                            `;
                            nameTag.textContent = '‚≠ê ' + userName;
                        } else {
                            // Îã§Î•∏ ÏÇ¨Ïö©Ïûê: Í∞úÏÑ†Îêú Í∞ÄÎèÖÏÑ±
                            nameTag.style.cssText = `
                                background: rgba(0,0,0,0.75);
                                color: #fff;
                                padding: 2px 5px;
                                border-radius: 3px;
                                font-size: 10px;
                                line-height: 15px;
                                font-weight: bold;
                                white-space: nowrap;
                                border: 1px solid rgba(255,255,255,0.3);
                                text-shadow: 0 1px 2px rgba(0,0,0,0.8);
                            `;
                            nameTag.textContent = userName;
                        }
                        namesContainer.appendChild(nameTag);
                    });

                    track.appendChild(namesContainer);
                }
                
                const duration = speeds[rank] || 5000;
                maxDuration = Math.max(maxDuration, duration);
                horseElements.push({ horse, vehicleContent, frames: [frame1, frame2], rank, duration, lane });
            });
            
            // Ïã§ÏãúÍ∞Ñ ÏàúÏúÑ Ìå®ÎÑê ÌëúÏãú
            const liveRankingPanel = document.getElementById('liveRankingPanel');
            const liveRankingList = document.getElementById('liveRankingList');
            if (liveRankingPanel) {
                liveRankingPanel.style.display = 'block';
            }
            
            // ÌÉàÍ≤É Ï†ïÎ≥¥ Îßµ ÏÉùÏÑ± (horseIndex -> vehicleInfo)
            const vehicleInfoMap = {};
            availableHorses.forEach((horseIndex) => {
                const vehicleId = selectedVehicleTypes && selectedVehicleTypes[horseIndex] 
                    ? selectedVehicleTypes[horseIndex] 
                    : (ALL_VEHICLES.length > 0 ? ALL_VEHICLES[horseIndex % ALL_VEHICLES.length].id : 'car');
                const vehicle = ALL_VEHICLES.find(v => v.id === vehicleId) || { name: 'ÌÉàÍ≤É', emoji: 'üèÉ' };
                const bettingUsers = Object.entries(userHorseBets)
                    .filter(([_, h]) => h === horseIndex)
                    .map(([name, _]) => name);
                vehicleInfoMap[horseIndex] = { vehicleId, vehicle, bettingUsers };
            });
            
            // Ïã§ÏãúÍ∞Ñ ÏàúÏúÑ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
            const startPosition = 10; // ÏãúÏûë ÏúÑÏπò
            const totalDistance = finishLine - startPosition; // Ï†ÑÏ≤¥ Í±∞Î¶¨
            const centerPosition = trackWidth / 2; // ÌôîÎ©¥ Í∞ÄÏö¥Îç∞ ÏúÑÏπò (Î∞∞Í≤Ω Ïä§ÌÅ¨Î°§ ÏãúÏûëÏ†ê)
            
            // ÎèÑÏ∞© ÏàúÏÑú Ï∂îÏ†Å Í∞ùÏ≤¥
            const finishOrderMap = {};
            
            function updateLiveRanking(horseStatesRef) {
                const positions = [];
                horseElements.forEach(({ horse, rank }) => {
                    const actualHorseIndex = parseInt(horse.id.replace('horse_', ''));
                    // Ïã§Ï†ú ÏúÑÏπò(currentPos)Î•º ÏÇ¨Ïö© (ÌôîÎ©¥ ÌëúÏãú ÏúÑÏπòÍ∞Ä ÏïÑÎãå ÏßÑÌñâ ÏúÑÏπò)
                    const state = horseStatesRef ? horseStatesRef.find(s => s.horseIndex === actualHorseIndex) : null;
                    const actualPos = state ? state.currentPos : (parseFloat(horse.style.left) || startPosition);
                    const progress = Math.min(100, Math.max(0, ((actualPos - startPosition) / totalDistance) * 100));
                    const remainingMeters = Math.max(0, Math.round((totalDistance - (actualPos - startPosition)) / PIXELS_PER_METER));
                    const remaining = Math.max(0, 100 - progress);
                    
                    // ÎèÑÏ∞© ÏàúÏÑú Í∞ÄÏ†∏Ïò§Í∏∞ (horseStatesÏóêÏÑú)
                    let finishOrder = -1;
                    let isFinished = false;
                    if (horseStatesRef) {
                        const state = horseStatesRef.find(s => s.horseIndex === actualHorseIndex);
                        if (state && state.finished) {
                            isFinished = true;
                            finishOrder = state.finishOrder;
                            finishOrderMap[actualHorseIndex] = finishOrder;
                        }
                    }
                    // Ïù¥ÎØ∏ Í∏∞Î°ùÎêú ÎèÑÏ∞© ÏàúÏÑú ÏÇ¨Ïö©
                    if (finishOrderMap[actualHorseIndex] !== undefined) {
                        isFinished = true;
                        finishOrder = finishOrderMap[actualHorseIndex];
                    }
                    
                    positions.push({ horseIndex: actualHorseIndex, position: actualPos, progress, remaining, remainingMeters, isFinished, finishOrder });
                });
                
                // Ï†ïÎ†¨: ÎèÑÏ∞©Ìïú ÎßêÏùÄ ÎèÑÏ∞© ÏàúÏÑúÎåÄÎ°ú, ÎÇòÎ®∏ÏßÄÎäî ÏúÑÏπò Ïàú
                positions.sort((a, b) => {
                    // Îëò Îã§ ÎèÑÏ∞©Ìïú Í≤ΩÏö∞ ÎèÑÏ∞© ÏàúÏÑúÎ°ú
                    if (a.isFinished && b.isFinished) {
                        return a.finishOrder - b.finishOrder;
                    }
                    // ÌïòÎÇòÎßå ÎèÑÏ∞©Ìïú Í≤ΩÏö∞ ÎèÑÏ∞©Ìïú Ï™ΩÏù¥ Ïïû
                    if (a.isFinished) return -1;
                    if (b.isFinished) return 1;
                    // Îëò Îã§ ÎØ∏ÎèÑÏ∞©Ïãú ÏúÑÏπò Ïàú
                    return b.position - a.position;
                });
                
                // ÏàúÏúÑ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
                if (liveRankingList) {
                    let html = '';
                    positions.forEach((pos, idx) => {
                        const info = vehicleInfoMap[pos.horseIndex];
                        if (info) {
                            const medal = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : `${idx + 1}.`;
                            const users = info.bettingUsers.length > 0 ? info.bettingUsers.join(',') : '-';
                            const remainingText = pos.remaining <= 0 ? 'üèÅ' : `${pos.remainingMeters}m`;
                            const progressColor = pos.remaining <= 0 ? '#4ade80' : pos.remaining < 30 ? '#fbbf24' : '#94a3b8';
                            html += `<div style="display: flex; align-items: center; gap: 4px; margin: 4px 0; ${idx === 0 ? 'color: #ffd700; font-weight: bold;' : ''}">
                                <span style="width: 20px; font-size: 12px;">${medal}</span>
                                <span style="font-size: 14px;">${info.vehicle.emoji}</span>
                                <span style="flex: 1; font-size: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${users}</span>
                                <span style="font-size: 10px; color: ${progressColor}; min-width: 32px; text-align: right;">${remainingText}</span>
                            </div>`;
                        }
                    });
                    liveRankingList.innerHTML = html;
                }
            }
            
            // ÎØ∏ÎãàÎßµ Ï¥àÍ∏∞Ìôî Î∞è ÌëúÏãú
            const minimapEl = document.getElementById('raceMinimap');
            if (minimapEl) minimapEl.style.display = 'block';

            // ÎØ∏ÎãàÎßµÏóê ÏÇ¨Ïö©Ìï† ÏÉâÏÉÅ ÌåîÎ†àÌä∏
            const minimapColors = ['#ffd700', '#c0c0c0', '#cd7f32', '#ff6b6b', '#4ecdc4', '#a29bfe', '#fd79a8', '#00cec9', '#e17055', '#636e72'];

            function updateMinimap(horseStatesRef, startPos, totalDist, finishLinePx, trackMeters, vInfoMap) {
                const minimapTrack = document.getElementById('minimapTrack');
                const minimapMarkers = document.getElementById('minimapMarkers');
                const minimapDots = document.getElementById('minimapDots');
                if (!minimapTrack) return;

                const trackW = minimapTrack.offsetWidth;

                // Í±∞Î¶¨ ÎßàÏª§ ÏÉùÏÑ± (100m Í∞ÑÍ≤©, 200m Ïù¥ÌïòÎ∂ÄÌÑ¥ 50m Í∞ÑÍ≤©)
                let markersHtml = '';
                let ticksHtml = '';
                const markers = [];
                for (let m = 0; m <= trackMeters; m += 100) {
                    if (m === 0) continue;
                    markers.push(m);
                }
                // 200m Ïù¥Ìïò Íµ¨Í∞ÑÏóê 50m Îã®ÏúÑ Ï∂îÍ∞Ä
                const lastStretch = Math.min(trackMeters, 200);
                for (let m = 50; m < lastStretch; m += 100) {
                    const absM = trackMeters - lastStretch + m;
                    if (absM > 0 && absM < trackMeters && !markers.includes(absM)) {
                        markers.push(absM);
                    }
                }
                // ÎßàÏßÄÎßâ 200m Íµ¨Í∞ÑÏùò 50m ÎßàÏª§
                for (let m = trackMeters - 200 + 50; m < trackMeters; m += 50) {
                    if (m > 0 && !markers.includes(m) && m % 100 !== 0) {
                        markers.push(m);
                    }
                }
                markers.sort((a, b) => a - b);

                markers.forEach(m => {
                    const pct = (m / trackMeters) * 100;
                    const isMajor = m % 100 === 0;
                    const remaining = trackMeters - m;
                    ticksHtml += `<div style="position: absolute; left: ${pct}%; top: 0; width: 1px; height: 6px; background: rgba(255,255,255,${isMajor ? '0.4' : '0.2'}); transform: translateX(-50%);"></div>`;
                    markersHtml += `<div style="position: absolute; left: ${pct}%; transform: translateX(-50%); font-size: 7px; color: rgba(255,255,255,${isMajor ? '0.6' : '0.35'}); white-space: nowrap;">${remaining}m</div>`;
                });
                // Í≤∞ÏäπÏÑ† ÎßàÏª§
                ticksHtml += `<div style="position: absolute; right: 0; top: 0; width: 2px; height: 6px; background: #4ade80;"></div>`;

                minimapTrack.innerHTML = ticksHtml;
                minimapMarkers.innerHTML = markersHtml;

                // Îßê ÏúÑÏπò Ï†ê + Î≤îÎ°Ä
                let dotsHtml = '';
                // Ï†ïÎ†¨: ÏúÑÏπò Ïàú
                const sorted = [...horseStatesRef].sort((a, b) => b.currentPos - a.currentPos);
                sorted.forEach((state, idx) => {
                    const progress = Math.min(1, Math.max(0, (state.currentPos - startPos) / totalDist));
                    const leftPct = progress * 100;
                    const color = minimapColors[state.horseIndex % minimapColors.length];
                    const info = vInfoMap[state.horseIndex];
                    const emoji = info ? info.vehicle.emoji : 'üèÉ';

                    // Ìä∏Îûô ÏúÑÏùò Ï†ê
                    const isMyBet = userHorseBets[currentUser] === state.horseIndex;
                    const arrow = isMyBet ? `<div style="position: absolute; left: 50%; top: -8px; transform: translateX(-50%); font-size: 6px; color: #ffd700; line-height: 1;">‚ñº</div>` : '';
                    minimapTrack.innerHTML += `<div style="position: absolute; left: ${leftPct}%; top: 50%; transform: translate(-50%, -50%) scaleX(-1); font-size: 10px; line-height: 1; z-index: ${isMyBet ? 100 : 10 + idx}; filter: ${isMyBet ? 'drop-shadow(0 0 3px #ffd700)' : 'none'};">${arrow}${emoji}</div>`;
                });

                minimapDots.style.display = 'none';
            }

            // Ïã§ÏãúÍ∞Ñ ÏàúÏúÑ ÏóÖÎç∞Ïù¥Ìä∏ Ïù∏ÌÑ∞Î≤å
            let rankingInterval = null;
            let animationInterval = null;
            let currentScrollOffset = 0; // ÌòÑÏû¨ Ïä§ÌÅ¨Î°§ Ïò§ÌîÑÏÖã
            let cameraMode = 'leader'; // 'leader' | 'myHorse'

            // 1Îì± Í≤∞Ïäπ ÌõÑ Íº¥Îì±ÏúºÎ°ú Î∂ÄÎìúÎü¨Ïö¥ Ìå®Îãù (updateCameraBtnUIÎ≥¥Îã§ Î®ºÏ†Ä ÏÑ†Ïñ∏)
            let panningToLoser = false;
            let panStartTime = 0;
            let panStartOffset = 0;
            let panTargetOffset = 0;
            const PAN_DELAY = 500;
            const PAN_DURATION = 2500;
            let loserCameraTarget = null;
            let cameraModeBefore = null;

            // Ïπ¥Î©îÎùº Î≤ÑÌäº UI ÎèôÍ∏∞Ìôî Ìï®Ïàò (Î£®ÌîÑ ÎÇ¥ÏóêÏÑúÎèÑ Ìò∏Ï∂ú)
            const cameraSwitchBtn = document.getElementById('cameraSwitchBtn');
            function updateCameraBtnUI() {
                if (!cameraSwitchBtn) return;
                if (cameraMode === 'myHorse') {
                    cameraSwitchBtn.textContent = 'üì∑ ÎÇ¥ Îßê Î≥¥ÎäîÏ§ë';
                    cameraSwitchBtn.style.background = 'rgba(255,215,0,0.3)';
                } else if (cameraMode === '_loser' || panningToLoser) {
                    cameraSwitchBtn.textContent = 'üì∑ Íº¥Îì± Ï∂îÏ†ÅÏ§ë';
                    cameraSwitchBtn.style.background = 'rgba(233,69,96,0.4)';
                } else {
                    cameraSwitchBtn.textContent = 'üì∑ ÏãúÏä§ÌÖú Ïπ¥Î©îÎùº';
                    cameraSwitchBtn.style.background = 'rgba(0,0,0,0.6)';
                }
            }
            if (cameraSwitchBtn) {
                if (userHorseBets[currentUser] !== undefined) {
                    cameraSwitchBtn.style.display = 'block';
                    cameraSwitchBtn.textContent = 'üì∑ ÏãúÏä§ÌÖú Ïπ¥Î©îÎùº';
                    cameraSwitchBtn.onclick = () => {
                        panningToLoser = false;
                        if (cameraMode === '_loser') {
                            cameraMode = cameraModeBefore || 'leader';
                            cameraModeBefore = null;
                            loserCameraTarget = null;
                        }
                        cameraMode = cameraMode === 'leader' ? 'myHorse' : 'leader';
                        updateCameraBtnUI();
                    };
                } else {
                    cameraSwitchBtn.style.display = 'none';
                }
            }
            
            // Í∞Å ÌÉàÍ≤ÉÏùò Ïï†ÎãàÎ©îÏù¥ÏÖò ÏÉÅÌÉú (ÏÑúÎ≤ÑÏóêÏÑú Î∞õÏùÄ Í∏∞ÎØπ Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©)
            const horseStates = horseElements.map(({ horse, frames, duration, rank, lane }) => {
                const horseIndex = parseInt(horse.id.replace('horse_', ''));
                
                // ÏÑúÎ≤ÑÏóêÏÑú Î∞õÏùÄ Í∏∞ÎØπ Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö© (ÏóÜÏúºÎ©¥ Îπà Î∞∞Ïó¥)
                const serverGimmickList = serverGimmicks && serverGimmicks[horseIndex] ? serverGimmicks[horseIndex] : [];
                const gimmicks = serverGimmickList.map(g => ({
                    progressTrigger: g.progressTrigger,
                    type: g.type,
                    duration: g.duration,
                    speedMultiplier: g.speedMultiplier,
                    nextGimmick: g.nextGimmick || null,
                    triggered: false,
                    active: false,
                    endTime: 0
                }));
                
                // Í∏∞Î≥∏ ÏÜçÎèÑ Í≥ÑÏÇ∞ (duration Í∏∞Î∞ò)
                const baseSpeed = totalDistance / duration;
                
                // Ï¥àÍ∏∞ ÏÜçÎèÑ Î≥ÄÌôîÎ•º ÏúÑÌïú ÏãúÎìú (horseIndex Í∏∞Î∞òÏúºÎ°ú ÏùºÍ¥ÄÏÑ± Ïú†ÏßÄ)
                const initialSpeedFactor = 0.8 + ((horseIndex * 1234567) % 100) / 250; // 0.8 ~ 1.2
                
                return {
                    horse,
                    frames,
                    duration,
                    rank,
                    horseIndex,
                    lane,
                    currentPos: startPosition,
                    baseSpeed,
                    currentSpeed: baseSpeed * initialSpeedFactor,
                    targetSpeed: baseSpeed,
                    finished: false,
                    gimmicks,
                    wobblePhase: 0,
                    lastSpeedChange: 0,
                    speedChangeSeed: horseIndex * 9876, // ÏÜçÎèÑ Î≥ÄÌôî ÏãúÎìú
                    simElapsed: 0 // ÏÑúÎ≤ÑÏôÄ ÎèôÍ∏∞ÌôîÏö© Í≥†Ï†ï 16ms Ïä§ÌÖù elapsed
                };
            });
            
            // Î™®Îì† ÌÉàÍ≤É ÎèôÏãúÏóê Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë
            setTimeout(() => {
                let startTime = Date.now();
                let lastFrameTime = Date.now();
                let pausedAt = 0;
                let finishOrderCounter = 0; // ÎèÑÏ∞© ÏàúÏÑú Ïπ¥Ïö¥ÌÑ∞
                const smConf = window._slowMotionConfig || { leader: { triggerDistanceM: 15, factor: 0.4 }, loser: { triggerDistanceM: 10, factor: 0.4 } };
                let slowMotionFactor = 1; // 1 = Ï†ïÏÉÅÏÜçÎèÑ
                let slowMotionActive = false;
                let slowMotionTriggered = false; // ÌïúÎ≤àÎßå Ìä∏Î¶¨Í±∞
                let loserSlowMotionTriggered = false; // Íº¥Îì± Í≤∞Ï†ï Ïä¨Î°úÏö∞Î™®ÏÖò
                let loserSlowMotionActive = false;
                // loserCameraTarget, cameraModeBefore, Ìå®Îãù Î≥ÄÏàòÎäî ÏÉÅÏúÑ Ïä§ÏΩîÌîÑÏóêÏÑú ÏÑ†Ïñ∏Îê®

                // ÌÖåÏä§Ìä∏Ïö©: ÏΩòÏÜîÏóêÏÑú forceSlowMotion() Ìò∏Ï∂úÎ°ú Í∞ïÏ†ú Î∞úÎèô
                window.forceSlowMotion = function() {
                    slowMotionTriggered = true;
                    slowMotionActive = true;
                    slowMotionFactor = smConf.leader.factor;
                    track.style.transition = 'filter 0.3s';
                    track.style.filter = 'contrast(1.1) saturate(1.3)';
                    console.log('[Ïä¨Î°úÏö∞Î™®ÏÖò] Í∞ïÏ†ú Î∞úÎèô!');
                };
                
                // Î†àÏù¥Ïä§ ÏãúÏûë: idle ‚Üí run ÏÉÅÌÉú Ï†ÑÌôò
                horseStates.forEach(state => {
                    if (state.horse && state.horse.dataset.vehicleId) {
                        state.horse.classList.remove('idle');
                        state.horse.classList.add('racing');
                        setVehicleState(state.horse, state.horse.dataset.vehicleId, 'run');
                    }
                });

                // ÌÉ≠ Ï†ÑÌôò ÏùºÏãúÏ†ïÏßÄ/Ïû¨Í∞ú
                function onVisChange() {
                    if (!animationInterval) return; // Í≤ΩÏ£º ÎÅùÎÇ¨ÏúºÎ©¥ Î¨¥Ïãú
                    if (document.hidden) {
                        pausedAt = Date.now();
                    } else if (pausedAt > 0) {
                        startTime += (Date.now() - pausedAt);
                        lastFrameTime = Date.now();
                        pausedAt = 0;
                        // Ïû¨Í∞ú ÌÜ†Ïä§Ìä∏
                        const toast = document.createElement('div');
                        toast.textContent = '‚ñ∂ Í≤ΩÏ£º Ïû¨Í∞ú!';
                        toast.style.cssText = 'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; background: rgba(0,0,0,0.7); color: #4ade80; padding: 8px 20px; border-radius: 8px; font-size: 14px; font-weight: bold; pointer-events: none; transition: opacity 0.5s;';
                        trackContainer.style.position = 'relative';
                        trackContainer.appendChild(toast);
                        setTimeout(() => { toast.style.opacity = '0'; }, 800);
                        setTimeout(() => toast.remove(), 1300);
                    }
                }
                document.removeEventListener('visibilitychange', onVisChange);
                document.addEventListener('visibilitychange', onVisChange);

                // JavaScript Í∏∞Î∞ò Ïï†ÎãàÎ©îÏù¥ÏÖò Î£®ÌîÑ
                animationInterval = setInterval(() => {
                    if (pausedAt > 0) return; // ÏùºÏãúÏ†ïÏßÄ Ï§ë
                    const now = Date.now();
                    const deltaTime = Math.min(now - lastFrameTime, 50);
                    lastFrameTime = now;
                    const elapsed = now - startTime;
                    let allFinished = true;
                    
                    // Ïä¨Î°úÏö∞Î™®ÏÖò Ï≤¥ÌÅ¨: 1Îì±Ïù¥ Í≤∞ÏäπÏÑ† 30m Ï†ÑÏóê ÎèÑÎã¨ÌïòÎ©¥ Î¨¥Ï°∞Í±¥ Î∞úÎèô
                    if (!slowMotionTriggered) {
                        const rank1 = horseStates.find(s => s.rank === 0);
                        if (rank1 && !rank1.finished) {
                            const remainingPx = finishLine - rank1.currentPos;
                            const remainingM = remainingPx / PIXELS_PER_METER;
                            if (remainingM <= smConf.leader.triggerDistanceM) {
                                slowMotionTriggered = true;
                                slowMotionActive = true;
                                slowMotionFactor = smConf.leader.factor;
                                // ÎπÑÎÑ§ÌåÖ(Í∞ÄÏû•ÏûêÎ¶¨ Ïñ¥Îë°Í≤å) + ÌïÑÌÑ∞ Ìö®Í≥º
                                let vignette = document.getElementById('slowmoVignette');
                                if (!vignette) {
                                    vignette = document.createElement('div');
                                    vignette.id = 'slowmoVignette';
                                    vignette.style.cssText = `
                                        position: absolute; top: 0; left: 0; right: 0; bottom: 0;
                                        pointer-events: none; z-index: 9999;
                                        box-shadow: inset 0 0 60px 30px rgba(0,0,0,0.5);
                                        border-radius: inherit;
                                        transition: opacity 0.5s;
                                    `;
                                    track.parentElement.style.position = 'relative';
                                    track.parentElement.appendChild(vignette);
                                }
                                vignette.style.opacity = '1';
                                track.style.transition = 'filter 0.3s';
                                track.style.filter = 'contrast(1.1) saturate(1.3)';
                                // Ïä¨Î°úÏö∞Î™®ÏÖò ÌôòÌò∏ÏÑ± (Í∏∞Ï°¥ crowdÎ≥¥Îã§ ÌÅ¨Í≤å)
                                if (window.SoundManager) {
                                    SoundManager.playLoop('horse-race_slowmo_cheer', getHorseSoundEnabled(), 0.9);
                                }
                            }
                        }
                    }

                    // ========== ÎÇ†Ïî® Î≥ÄÌôî Ï≤¥ÌÅ¨ (1Îì± ÏßÑÌñâÎèÑ Í∏∞Ï§Ä) ==========
                    if (weatherSchedule.length > 0) {
                        const leaderState = horseStates.reduce((a, b) =>
                            (a && !a.finished && a.currentPos > b.currentPos) ? a : b, null);
                        if (leaderState && !leaderState.finished) {
                            const raceProgress = (leaderState.currentPos - startPosition) / totalDistance;
                            const newWeather = getCurrentWeatherFromSchedule(raceProgress);

                            if (newWeather !== currentWeather) {
                                currentWeather = newWeather;
                                // sunnyÏùº ÎïåÎäî Î∞∞ÎÑà/ÌÜ†Ïä§Ìä∏/Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ Ïà®ÍπÄ
                                if (currentWeather === 'sunny') {
                                    weatherBanner.style.display = 'none';
                                } else {
                                    // Î∞∞ÎÑà ÏóÖÎç∞Ïù¥Ìä∏
                                    weatherBanner.style.display = '';
                                    weatherBanner.textContent = `${weatherEmojis[currentWeather]} ${weatherNames[currentWeather]}`;
                                    // ÌÜ†Ïä§Ìä∏ Î©îÏãúÏßÄ ÌëúÏãú (ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÎèÖÎ¶Ω)
                                    showWeatherToast(currentWeather);
                                    // Î≤ÑÌîÑ/ÎîîÎ≤ÑÌîÑ ÏÇºÍ∞ÅÌòï ÌëúÏãú
                                    showWeatherIndicators(horseStates, currentWeather);
                                }
                                // Ïò§Î≤ÑÎ†àÏù¥ Ìö®Í≥º ÏóÖÎç∞Ïù¥Ìä∏ (sunnyÎ©¥ Ìö®Í≥º ÏóÜÏùå)
                                applyWeatherEffect(currentWeather);
                            }
                        }
                    }

                    // Ïä¨Î°úÏö∞Î™®ÏÖò Ìï¥Ï†ú: 1Îì±Ïù¥ Í≤∞ÏäπÏÑ† ÌÜµÍ≥ºÌïòÎ©¥ Ï¶âÏãú Ìï¥Ï†ú
                    if (slowMotionActive && horseStates.some(s => s.finished)) {
                        slowMotionActive = false;
                        slowMotionFactor = 1;
                        track.style.filter = '';
                        const vignette = document.getElementById('slowmoVignette');
                        if (vignette) {
                            vignette.style.opacity = '0';
                            setTimeout(() => vignette.remove(), 500);
                        }
                        // Ïä¨Î°úÏö∞Î™®ÏÖò ÌôòÌò∏ÏÑ± ÌéòÏù¥ÎìúÏïÑÏõÉ + Í≥®Ïù∏ ÌôòÌò∏ Ïû¨ÏÉù
                        if (window.SoundManager) {
                            // Í≥®Ïù∏ ÌôòÌò∏ (Îã®Î∞ú)
                            SoundManager.playSound('horse-race_cheer_burst', getHorseSoundEnabled(), 1.0);
                            // Ïä¨Î°úÏö∞Î™®ÏÖò ÌôòÌò∏ ÌéòÏù¥ÎìúÏïÑÏõÉ (1Ï¥à)
                            let slowmoVol = 0.9;
                            const fadeSlowmo = setInterval(() => {
                                slowmoVol -= 0.15;
                                if (slowmoVol <= 0) {
                                    SoundManager.stopLoop('horse-race_slowmo_cheer');
                                    clearInterval(fadeSlowmo);
                                } else {
                                    SoundManager.setVolume('horse-race_slowmo_cheer', slowmoVol);
                                }
                            }, 150);
                        }
                    }

                    // Íº¥Îì± Í≤∞Ï†ï Ïä¨Î°úÏö∞Î™®ÏÖò: Î≤†ÌåÖÎêú Îßê Ï§ë Íº¥Îì±Í≥º ÏßÅÏ†Ñ ÎßêÏù¥ Ï†ëÏ†Ñ Ï§ëÏùº Îïå Î∞úÎèô
                    if (!loserSlowMotionTriggered && !slowMotionActive) {
                        const bettedHorseIndices = [...new Set(Object.values(userHorseBets))];
                        const bettedByRank = bettedHorseIndices
                            .map(hi => horseStates.find(s => s.horseIndex === hi))
                            .filter(Boolean)
                            .sort((a, b) => a.currentPos - b.currentPos); // ÏúÑÏπòÏàú Ï†ïÎ†¨ (ÎäêÎ¶∞ Ïàú)
                        const lastBetted = bettedByRank.length >= 2 ? bettedByRank[0] : null; // Íº¥Îì±
                        const secondLastBetted = bettedByRank.length >= 2 ? bettedByRank[1] : null; // Íº¥Îì± ÏßÅÏ†Ñ

                        if (lastBetted && secondLastBetted && !lastBetted.finished && !secondLastBetted.finished) {
                            // Îëê ÎßêÏùò Í±∞Î¶¨ Ï∞®Ïù¥ (m)
                            const gapM = Math.abs(secondLastBetted.currentPos - lastBetted.currentPos) / PIXELS_PER_METER;
                            const slRemainingM = (finishLine - secondLastBetted.currentPos) / PIXELS_PER_METER;
                            // Í≤∞ÏäπÏÑ† Í∑ºÏ≤òÏùº Îïå Î∞úÎèô (Í±∞Î¶¨ Î¨¥Í¥Ä)
                            if (slRemainingM <= smConf.loser.triggerDistanceM) {
                                loserSlowMotionTriggered = true;
                                loserSlowMotionActive = true;
                                slowMotionFactor = smConf.loser.factor;
                                loserCameraTarget = secondLastBetted; // Í≤∞ÏäπÏÑ†Ïóê Í∞ÄÍπåÏö¥ Îßê(Îì§Ïñ¥Í∞ÄÎäî Ïï†)Ïóê Ïπ¥Î©îÎùº
                                cameraModeBefore = cameraMode;
                                cameraMode = '_loser';
                                let vignette = document.getElementById('slowmoVignette');
                                if (!vignette) {
                                    vignette = document.createElement('div');
                                    vignette.id = 'slowmoVignette';
                                    vignette.style.cssText = `
                                        position: absolute; top: 0; left: 0; right: 0; bottom: 0;
                                        pointer-events: none; z-index: 9999;
                                        box-shadow: inset 0 0 60px 30px rgba(233,69,96,0.4);
                                        border-radius: inherit;
                                        transition: opacity 0.5s;
                                    `;
                                    track.parentElement.style.position = 'relative';
                                    track.parentElement.appendChild(vignette);
                                }
                                vignette.style.opacity = '1';
                                track.style.transition = 'filter 0.3s';
                                track.style.filter = 'contrast(1.1) saturate(1.3)';
                                // Íº¥Îì± Ïä¨Î°úÏö∞Î™®ÏÖò ÌôòÌò∏ÏÑ± (Ïù¥ÎØ∏ Ïû¨ÏÉù Ï§ëÏù¥Î©¥ Î¨¥ÏãúÎê®)
                                if (window.SoundManager) {
                                    SoundManager.playLoop('horse-race_slowmo_cheer', getHorseSoundEnabled(), 0.9);
                                }
                            }
                        }
                    }

                    // Íº¥Îì± Ïä¨Î°úÏö∞Î™®ÏÖò Ìï¥Ï†ú: secondLastBetted(Ïπ¥Î©îÎùº ÎåÄÏÉÅ)Í∞Ä Í≤∞ÏäπÏÑ† ÌÜµÍ≥ºÌïòÎ©¥
                    if (loserSlowMotionActive) {
                        const loserFinished = !loserCameraTarget || loserCameraTarget.finished;
                        if (loserFinished) {
                            loserSlowMotionActive = false;
                            slowMotionFactor = 1;
                            // secondLastBettedÍ∞Ä Îì§Ïñ¥ÏôîÏúºÎãà ‚Üí lastBetted(ÏßÑÏßú Íº¥Îì±)Î°ú Ïπ¥Î©îÎùº Ï†ÑÌôò
                            const bettedIndices = [...new Set(Object.values(userHorseBets))];
                            const remaining = bettedIndices
                                .map(hi => horseStates.find(s => s.horseIndex === hi))
                                .filter(s => s && !s.finished)
                                .sort((a, b) => a.currentPos - b.currentPos);
                            if (remaining.length > 0) {
                                loserCameraTarget = remaining[0]; // Í∞ÄÏû• ÎäêÎ¶∞ ÎØ∏ÏôÑÏ£º Î≤†ÌåÖ Îßê
                                // _loser Î™®Îìú Ïú†ÏßÄ, Ïä¨Î°úÏö∞Î™®ÏÖòÎßå Ìï¥Ï†ú
                            } else {
                                loserCameraTarget = null;
                                if (cameraModeBefore) { cameraMode = cameraModeBefore; cameraModeBefore = null; }
                            }
                            track.style.filter = '';
                            const vignette = document.getElementById('slowmoVignette');
                            if (vignette) {
                                vignette.style.opacity = '0';
                                setTimeout(() => vignette.remove(), 500);
                            }
                            // Íº¥Îì± Ïä¨Î°úÏö∞Î™®ÏÖò ÌôòÌò∏ÏÑ± Ï†ïÏßÄ
                            if (window.SoundManager) {
                                SoundManager.stopLoop('horse-race_slowmo_cheer');
                            }
                        }
                    }

                    horseStates.forEach(state => {
                        if (state.finished) return;
                        allFinished = false;

                        const progress = (state.currentPos - startPosition) / totalDistance;

                        // Í∏∞ÎØπ Ï≤¥ÌÅ¨
                        state.gimmicks.forEach(gimmick => {
                            // Í∏∞ÎØπ Ìä∏Î¶¨Í±∞ Ï≤¥ÌÅ¨
                            if (!gimmick.triggered && progress >= gimmick.progressTrigger) {
                                gimmick.triggered = true;
                                gimmick.active = true;
                                gimmick.endTime = elapsed + gimmick.duration;
                                
                                // Í∏∞ÎØπ ÏãúÏûë Ìö®Í≥º Î∞è Ïù¥ÌéôÌä∏ Ï∂îÍ∞Ä
                                if (gimmick.type === 'stop') {
                                    state.horse.style.filter = 'brightness(0.7)';
                                    // Ïâ¨Îäî Ïï†ÎãàÎ©îÏù¥ÏÖòÏúºÎ°ú Ï†ÑÌôò
                                    state.horse.classList.remove('racing');
                                    state.horse.classList.add('rest');
                                    setVehicleState(state.horse, state.horse.dataset.vehicleId, 'rest');
                                    // Î∏åÎ†àÏù¥ÌÅ¨ Ïó∞Í∏∞ Ïù¥ÌéôÌä∏
                                    const stopEffect = document.createElement('div');
                                    stopEffect.className = 'gimmick-effect-stop';
                                    stopEffect.innerHTML = '<div class="brake-smoke"></div><div class="brake-smoke"></div><div class="brake-smoke"></div>';
                                    state.horse.appendChild(stopEffect);
                                    gimmick.effectElement = stopEffect;
                                } else if (gimmick.type === 'sprint') {
                                    state.horse.style.filter = 'brightness(1.3) saturate(1.5)';
                                    // Î∂àÍΩÉ + ÏÜçÎèÑÏÑ† Ïù¥ÌéôÌä∏
                                    const sprintEffect = document.createElement('div');
                                    sprintEffect.className = 'gimmick-effect-sprint';
                                    sprintEffect.innerHTML = `
                                        <div class="flame-core"></div>
                                        <div class="flame"></div>
                                        <div class="flame"></div>
                                        <div class="flame"></div>
                                    `;
                                    state.horse.appendChild(sprintEffect);
                                    // ÏÜçÎèÑÏÑ† Ï∂îÍ∞Ä
                                    const speedLines = document.createElement('div');
                                    speedLines.className = 'speed-lines';
                                    speedLines.innerHTML = '<div class="speed-line"></div><div class="speed-line"></div><div class="speed-line"></div><div class="speed-line"></div><div class="speed-line"></div>';
                                    state.horse.appendChild(speedLines);
                                    gimmick.effectElement = sprintEffect;
                                    gimmick.speedLinesElement = speedLines;
                                } else if (gimmick.type === 'slip') {
                                    state.horse.style.filter = 'hue-rotate(20deg)';
                                    // ÎØ∏ÎÅÑÎü¨Ïßê Î®ºÏßÄ Ïù¥ÌéôÌä∏
                                    const slipEffect = document.createElement('div');
                                    slipEffect.className = 'gimmick-effect-slip';
                                    slipEffect.innerHTML = '<div class="dust-cloud"></div><div class="dust-cloud"></div>';
                                    state.horse.appendChild(slipEffect);
                                    gimmick.effectElement = slipEffect;
                                } else if (gimmick.type === 'slow') {
                                    state.horse.style.filter = 'brightness(0.9) grayscale(0.3)';
                                    // ÌîºÎ°ú ÎïÄÎ∞©Ïö∏ Ïù¥ÌéôÌä∏
                                    const slowEffect = document.createElement('div');
                                    slowEffect.className = 'gimmick-effect-slow';
                                    slowEffect.innerHTML = '<div class="sweat-drop"></div><div class="sweat-drop"></div>';
                                    state.horse.appendChild(slowEffect);
                                    gimmick.effectElement = slowEffect;
                                } else if (gimmick.type === 'wobble') {
                                    state.wobblePhase = 0;
                                    // Ïñ¥ÏßÄÎü¨ÏõÄ Î≥Ñ Ïù¥ÌéôÌä∏
                                    const wobbleEffect = document.createElement('div');
                                    wobbleEffect.className = 'gimmick-effect-wobble';
                                    wobbleEffect.textContent = 'üí´';
                                    state.horse.appendChild(wobbleEffect);
                                    gimmick.effectElement = wobbleEffect;
                                } else if (gimmick.type === 'obstacle') {
                                    // Ïû•Ïï†Î¨º ‚Äî Ïâ¨Îäî Ïï†ÎãàÎ©îÏù¥ÏÖò + Ï†êÌîÑ
                                    state.horse.style.filter = 'brightness(0.6)';
                                    state.horse.classList.remove('racing');
                                    state.horse.classList.add('rest');
                                    setVehicleState(state.horse, state.horse.dataset.vehicleId, 'rest');
                                    state.horse.style.animation = 'obstacleJump 0.5s ease-in-out infinite';
                                    const obstacleEffect = document.createElement('div');
                                    obstacleEffect.className = 'gimmick-effect-obstacle';
                                    obstacleEffect.textContent = 'üöß';
                                    obstacleEffect.style.cssText = 'position:absolute;top:-18px;left:50%;transform:translateX(-50%);font-size:16px;';
                                    state.horse.appendChild(obstacleEffect);
                                    gimmick.effectElement = obstacleEffect;
                                } else if (gimmick.type === 'item_boost') {
                                    // Ìô©Í∏à ÎãπÍ∑º ‚Äî Í∞ïÌïú Í∞ÄÏÜç
                                    state.horse.style.filter = 'brightness(1.5) saturate(2)';
                                    const boostEffect = document.createElement('div');
                                    boostEffect.className = 'gimmick-effect-item-boost';
                                    boostEffect.textContent = 'ü•ï‚ú®';
                                    boostEffect.style.cssText = 'position:absolute;top:-18px;left:50%;transform:translateX(-50%);font-size:14px;animation:blink 0.3s infinite;';
                                    state.horse.appendChild(boostEffect);
                                    gimmick.effectElement = boostEffect;
                                    // ÏÜçÎèÑÏÑ† Ï∂îÍ∞Ä
                                    const speedLines = document.createElement('div');
                                    speedLines.className = 'speed-lines';
                                    speedLines.innerHTML = '<div class="speed-line"></div><div class="speed-line"></div><div class="speed-line"></div>';
                                    state.horse.appendChild(speedLines);
                                    gimmick.speedLinesElement = speedLines;
                                } else if (gimmick.type === 'item_trap') {
                                    // Î∞îÎÇòÎÇò ÍªçÏßà ‚Äî ÌöåÏ†Ñ Ïï†ÎãàÎ©îÏù¥ÏÖò
                                    state.horse.style.filter = 'hue-rotate(60deg) brightness(0.8)';
                                    state.horse.style.animation = 'trapSpin 0.3s linear infinite';
                                    const trapEffect = document.createElement('div');
                                    trapEffect.className = 'gimmick-effect-item-trap';
                                    trapEffect.textContent = 'üçå';
                                    trapEffect.style.cssText = 'position:absolute;top:-18px;left:50%;transform:translateX(-50%);font-size:16px;';
                                    state.horse.appendChild(trapEffect);
                                    gimmick.effectElement = trapEffect;
                                } else if (gimmick.type === 'reverse') {
                                    // Ïó≠Ï£ºÌñâ ‚Äî Îπ®Í∞Ñ ÍπúÎπ°ÏûÑ
                                    state.horse.style.filter = 'hue-rotate(180deg) brightness(1.2)';
                                    state.horse.style.transform = 'scaleX(-1)';
                                    const reverseEffect = document.createElement('div');
                                    reverseEffect.className = 'gimmick-effect-reverse';
                                    reverseEffect.textContent = '‚ö†Ô∏è‚Ü©Ô∏è';
                                    reverseEffect.style.cssText = 'position:absolute;top:-18px;left:50%;transform:translateX(-50%);font-size:14px;animation:blink 0.4s infinite;';
                                    state.horse.appendChild(reverseEffect);
                                    gimmick.effectElement = reverseEffect;
                                } else if (gimmick.type === 'reverse_boost') {
                                    // Ïó≠Ï£ºÌñâ Î≥¥ÏÉÅ Î∂ÄÏä§Ìä∏
                                    state.horse.style.filter = 'brightness(1.4) saturate(1.8)';
                                    state.horse.style.transform = '';
                                    const rBoostEffect = document.createElement('div');
                                    rBoostEffect.className = 'gimmick-effect-reverse-boost';
                                    rBoostEffect.textContent = 'üí®üî•';
                                    rBoostEffect.style.cssText = 'position:absolute;top:-18px;left:50%;transform:translateX(-50%);font-size:14px;';
                                    state.horse.appendChild(rBoostEffect);
                                    gimmick.effectElement = rBoostEffect;
                                }
                            }
                            
                            // Í∏∞ÎØπ Ï¢ÖÎ£å Ï≤¥ÌÅ¨
                            if (gimmick.active && elapsed >= gimmick.endTime) {
                                gimmick.active = false;
                                state.horse.style.filter = '';
                                state.horse.style.animation = '';
                                if (gimmick.type === 'reverse') {
                                    state.horse.style.transform = '';
                                }
                                // stop/obstacle Í∏∞ÎØπ Ï¢ÖÎ£å Ïãú Îã§Ïãú Îã¨Î¶¨Í∏∞ ÏÉÅÌÉúÎ°ú
                                if (gimmick.type === 'stop' || gimmick.type === 'obstacle') {
                                    state.horse.classList.remove('rest');
                                    state.horse.classList.add('racing');
                                    setVehicleState(state.horse, state.horse.dataset.vehicleId, 'run');
                                }
                                // Ïù¥ÌéôÌä∏ ÏöîÏÜå Ï†úÍ±∞
                                if (gimmick.effectElement && gimmick.effectElement.parentNode) {
                                    gimmick.effectElement.remove();
                                    gimmick.effectElement = null;
                                }
                                if (gimmick.speedLinesElement && gimmick.speedLinesElement.parentNode) {
                                    gimmick.speedLinesElement.remove();
                                    gimmick.speedLinesElement = null;
                                }
                                // Ïó∞ÏáÑ Í∏∞ÎØπ ÌôúÏÑ±Ìôî
                                if (gimmick.nextGimmick && !gimmick.chainTriggered) {
                                    gimmick.chainTriggered = true;
                                    state.gimmicks.push({
                                        progressTrigger: 0,
                                        type: gimmick.nextGimmick.type,
                                        duration: gimmick.nextGimmick.duration,
                                        speedMultiplier: gimmick.nextGimmick.speedMultiplier,
                                        nextGimmick: null,
                                        triggered: true,
                                        active: true,
                                        endTime: elapsed + gimmick.nextGimmick.duration
                                    });
                                }
                            }
                        });
                        
                        // ÌôúÏÑ±ÌôîÎêú Í∏∞ÎØπÏóê Îî∞Î•∏ ÏÜçÎèÑ Í≥ÑÏÇ∞
                        let speedMultiplier = 1;
                        let hasActiveGimmick = false;
                        state.gimmicks.forEach(gimmick => {
                            if (gimmick.active) {
                                hasActiveGimmick = true;
                                speedMultiplier = gimmick.speedMultiplier;
                                
                                // ÏßÄÍ∑∏Ïû¨Í∑∏ Ìö®Í≥º
                                if (gimmick.type === 'wobble') {
                                    state.wobblePhase += 0.3;
                                    const wobbleOffset = Math.sin(state.wobblePhase) * 3;
                                    state.horse.style.transform = `translateY(${wobbleOffset}px)`;
                                }
                            }
                        });
                        
                        // ÏßÄÍ∑∏Ïû¨Í∑∏Í∞Ä ÏïÑÎãê Îïå transform Î¶¨ÏÖã
                        if (!state.gimmicks.some(g => g.active && g.type === 'wobble')) {
                            state.horse.style.transform = '';
                        }
                        
                        // ÏûêÏó∞Ïä§Îü¨Ïö¥ ÏÜçÎèÑ Î≥ÄÌôî (Í∏∞ÎØπÏù¥ ÏóÜÏùÑ Îïå) - ÏÑúÎ≤ÑÏôÄ ÎèôÍ∏∞ÌôîÎêú Í≥†Ï†ï Ïä§ÌÖù ÏÇ¨Ïö©
                        // simElapsed: ÏÑúÎ≤ÑÏôÄ ÎèôÏùºÌïú 16ms Í≥†Ï†ï Ïä§ÌÖùÏúºÎ°ú ÎàÑÏ†Å (RNG ÎèôÍ∏∞ÌôîÏö©)
                        while (state.simElapsed + 16 <= elapsed) {
                            state.simElapsed += 16;
                        }

                        if (!hasActiveGimmick) {
                            // Ï£ºÍ∏∞Ï†ÅÏúºÎ°ú Î™©Ìëú ÏÜçÎèÑ Î≥ÄÍ≤Ω (Í∞ÄÏÜç/Í∞êÏÜç) - 500ms Í∞ÑÍ≤©
                            const changeInterval = 500;
                            const currentInterval = Math.floor(state.simElapsed / changeInterval);
                            const lastInterval = Math.floor(state.lastSpeedChange / changeInterval);

                            if (currentInterval > lastInterval) {
                                state.lastSpeedChange = state.simElapsed;
                                // ÏãúÎìú Í∏∞Î∞ò ÏÜçÎèÑ Î≥ÄÌôî (0.7 ~ 1.3 Î≤îÏúÑ)
                                const speedSeed = (state.speedChangeSeed + currentInterval) * 16807 % 2147483647;
                                const speedFactor = 0.7 + (speedSeed % 600) / 1000;
                                state.targetSpeed = state.baseSpeed * speedFactor;
                            }

                            // ÌîÑÎ†àÏûÑ ÎèÖÎ¶ΩÏ†Å lerp Î≥¥Í∞Ñ
                            const lerpFactor = 1 - Math.pow(0.95, deltaTime / 16);
                            const speedDiff = state.targetSpeed - state.currentSpeed;
                            state.currentSpeed += speedDiff * lerpFactor;
                            speedMultiplier = state.currentSpeed / state.baseSpeed;
                        }
                        
                        // ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏
                        // ÎßêÏù¥ Í∞ÄÏö¥Îç∞Ïóê ÎèÑÎã¨ÌïòÍ∏∞ Ï†ÑÍπåÏßÄÎäî Ï†ïÏÉÅÏ†ÅÏúºÎ°ú ÏïûÏúºÎ°ú Ïù¥Îèô
                        // Í∞ÄÏö¥Îç∞Ïóê ÎèÑÎã¨Ìïú ÌõÑÎ∂ÄÌÑ∞Îäî Î∞∞Í≤Ω Ïä§ÌÅ¨Î°§Í≥º Ìï®Íªò ÌôîÎ©¥ Î∞ñÏúºÎ°ú ÎÇòÍ∞ê
                        const movement = state.baseSpeed * speedMultiplier * deltaTime * slowMotionFactor;
                        state.currentPos = Math.max(startPosition, state.currentPos + movement);
                        
                        // Í≤∞ÏäπÏÑ† ÎèÑÏ∞© Ï≤¥ÌÅ¨
                        if (state.currentPos >= finishLine && !state.finished) {
                            state.currentPos = finishLine;
                            state.finished = true;
                            state.finishOrder = state.rank; // ÏÑúÎ≤Ñ ÏàúÏúÑ ÏÇ¨Ïö© (ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÌÉÄÏù¥Î∞ç Ï∞®Ïù¥ Î∞©ÏßÄ)
                            finishOrderCounter = Math.max(finishOrderCounter, state.rank + 1);
                            state.horse.style.filter = '';
                            state.horse.style.transform = '';

                            // finish ÏÉÅÌÉú SVGÎ°ú Ï†ÑÌôò (Í∞êÏÜç Í±∑Í∏∞)
                            const vid = state.horse.dataset.vehicleId;
                            if (vid) {
                                setVehicleState(state.horse, vid, 'finish');
                                // ÌîÑÎ†àÏûÑ Ïï†ÎãàÎ©îÏù¥ÏÖò ÏÜçÎèÑ Í∞êÏÜç (0.15s ‚Üí 0.4s)
                                const sprite = state.horse.querySelector('.vehicle-sprite');
                                if (sprite) {
                                    const f1 = sprite.querySelector('.frame1');
                                    const f2 = sprite.querySelector('.frame2');
                                    if (f1) f1.style.animationDuration = '0.4s';
                                    if (f2) f2.style.animationDuration = '0.4s';
                                }
                            }

                            // ÎèÑÏ∞© Ïï†ÎãàÎ©îÏù¥ÏÖò ÌëúÏãú
                            showFinishAnimation(state.horse, state.finishOrder, state.horseIndex);

                            // 1Îì± Í≤∞Ïäπ ÌõÑ ‚Üí 0.5Ï¥à Ïú†ÏßÄ ÌõÑ Íº¥Îì±ÏúºÎ°ú Î∂ÄÎìúÎüΩÍ≤å Ìå®Îãù
                            if (state.rank === 0) {
                                setTimeout(() => {
                                    const unfinished = horseStates.filter(s => !s.finished)
                                        .sort((a, b) => a.currentPos - b.currentPos);
                                    if (unfinished.length > 0) {
                                        panningToLoser = true;
                                        panStartTime = Date.now();
                                        panStartOffset = currentScrollOffset;
                                        loserCameraTarget = unfinished[0];
                                        panTargetOffset = loserCameraTarget.currentPos - trackWidth * 0.3;
                                    }
                                }, PAN_DELAY);
                            }
                        }
                    });

                    // === ÏùºÏ†ï ÏÜçÎèÑ Ïä§ÌÅ¨Î°§ÎßÅ ===
                    // Î¶¨Îçî(1Îì±) Îßê Ï∞æÍ∏∞ (ÏàúÏúÑ ÌëúÏãúÏö©)
                    const leaderState = horseStates.reduce((leader, state) => 
                        state.currentPos > leader.currentPos ? state : leader, horseStates[0]);
                    const leaderPos = leaderState.currentPos;
                    
                    // Ïä§ÌÅ¨Î°§ ÏÑ§Ï†ï
                    const finishLineDisplayOffset = 250;
                    const scrollReleasePoint = finishLine - finishLineDisplayOffset;
                    const maxScrollLimit = -(scrollReleasePoint - centerPosition);

                    // Ïπ¥Î©îÎùº ÎåÄÏÉÅ Í≤∞Ï†ï (1Îì± / ÎÇ¥ Îßê / Íº¥Îì± Ïä¨Î°úÏö∞Î™®ÏÖò ÎåÄÏÉÅ / Ìå®Îãù)
                    if (panningToLoser) {
                        // Î∂ÄÎìúÎü¨Ïö¥ Ìå®Îãù Ï§ë (1Îì± Í≤∞Ïäπ ÌõÑ ‚Üí Íº¥Îì±ÏúºÎ°ú Ïù¥Îèô)
                        const panElapsed = Date.now() - panStartTime;
                        const t = Math.min(panElapsed / PAN_DURATION, 1);
                        const ease = t < 0.5 ? 2*t*t : 1 - Math.pow(-2*t + 2, 2) / 2;
                        // ÌÉÄÍ≤ü ÏúÑÏπò Í∞±Ïã† (Íº¥Îì±Ïù¥ Í≥ÑÏÜç ÏõÄÏßÅÏù¥ÎØÄÎ°ú)
                        if (loserCameraTarget) {
                            panTargetOffset = -(loserCameraTarget.currentPos - centerPosition);
                            if (panTargetOffset < maxScrollLimit) panTargetOffset = maxScrollLimit;
                        }
                        currentScrollOffset = panStartOffset + (panTargetOffset - panStartOffset) * ease;
                        if (t >= 1) {
                            panningToLoser = false;
                            cameraModeBefore = cameraMode;
                            cameraMode = '_loser';
                        }
                    } else {
                        let cameraTarget = leaderState;
                        if (cameraMode === '_loser') {
                            // Îß§ ÌîÑÎ†àÏûÑ Ïã§Ï†ú Íº¥Îì± Ïû¨Í≥ÑÏÇ∞
                            const unfinishedNow = horseStates.filter(s => !s.finished)
                                .sort((a, b) => a.currentPos - b.currentPos);
                            if (unfinishedNow.length > 0) {
                                loserCameraTarget = unfinishedNow[0];
                            }
                            if (loserCameraTarget) cameraTarget = loserCameraTarget;
                        } else if (cameraMode === 'myHorse') {
                            const myIdx = userHorseBets[currentUser];
                            const myState = horseStates.find(s => s.horseIndex === myIdx);
                            if (myState) cameraTarget = myState;
                        }
                        const cameraPos = cameraTarget.currentPos;

                        // Ïπ¥Î©îÎùº ÌÉÄÍ≤üÏóê ÌôîÏÇ¥Ìëú ÌëúÏãú (Îã§Î•∏ ÌôîÏÇ¥ÌëúÎäî Ïà®ÍπÄ, ÎÇ¥ Î≤†ÌåÖ ÎßêÏù¥Î©¥ ÎÖ∏ÎûÄÏÉâ)
                        const myBetIndex = userHorseBets[currentUser];
                        track.querySelectorAll('.camera-target-arrow').forEach(arrow => {
                            const idx = parseInt(arrow.dataset.horseIndex);
                            if (idx === cameraTarget.horseIndex) {
                                arrow.style.display = 'block';
                                // ÎÇ¥ Î≤†ÌåÖ ÎßêÏù¥Î©¥ ÎÖ∏ÎûÄÏÉâ, ÏïÑÎãàÎ©¥ Îπ®Í∞ÑÏÉâ
                                if (idx === myBetIndex) {
                                    arrow.style.color = '#ffd700';
                                    arrow.style.textShadow = '0 0 6px rgba(255,215,0,0.8)';
                                } else {
                                    arrow.style.color = '#e94560';
                                    arrow.style.textShadow = '0 0 4px rgba(233,69,96,0.6)';
                                }
                            } else {
                                arrow.style.display = 'none';
                            }
                        });

                        let targetOffset = 0;
                        if (cameraPos > centerPosition) {
                            targetOffset = -(cameraPos - centerPosition);
                            if (targetOffset < maxScrollLimit) {
                                targetOffset = maxScrollLimit;
                            }
                        }
                        // Î∂ÄÎìúÎü¨Ïö¥ Ïπ¥Î©îÎùº Ïù¥Îèô (lerp)
                        const lerpSpeed = 0.08;
                        currentScrollOffset += (targetOffset - currentScrollOffset) * lerpSpeed;
                    }
                    
                    // Ïπ¥Î©îÎùº Î≤ÑÌäº UI ÎèôÍ∏∞Ìôî
                    updateCameraBtnUI();

                    const bgScrollOffset = currentScrollOffset;
                    
                    // Í±∞Î¶¨ ÎßàÏª§ Ïä§ÌÅ¨Î°§
                    track.querySelectorAll('.distance-marker').forEach(marker => {
                        const origLeft = parseFloat(marker.dataset.origLeft || marker.style.left);
                        if (!marker.dataset.origLeft) marker.dataset.origLeft = origLeft;
                        marker.style.left = `${origLeft + bgScrollOffset}px`;
                    });

                    // Î™®Îì† ÎßêÏùò ÌôîÎ©¥ ÏúÑÏπò Î∞è Î∞∞Í≤Ω ÏóÖÎç∞Ïù¥Ìä∏ (Ïä§ÌÅ¨Î°§ Ïò§ÌîÑÏÖã Í∏∞Ï§Ä)
                    const cullEdge = -10; // ÌôîÎ©¥ Î∞ñ ÌåêÏ†ï Í∏∞Ï§Ä
                    horseStates.forEach(state => {
                        // ÌôîÎ©¥ ÏúÑÏπò = Ïã§Ï†ú ÏúÑÏπò + Ïä§ÌÅ¨Î°§ Ïò§ÌîÑÏÖã
                        let horseDisplayPos = state.currentPos + bgScrollOffset;
                        const isOffscreen = horseDisplayPos < cullEdge;

                        // Ïò§ÌîÑÏä§ÌÅ¨Î¶∞ Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ Ï≤òÎ¶¨
                        if (!state.offscreenIndicator) {
                            const indicator = document.createElement('div');
                            indicator.className = 'offscreen-indicator';
                            indicator.style.cssText = `position: absolute; left: 2px; top: 50%; transform: translateY(-50%); z-index: 100; display: none; font-size: 10px; color: #fbbf24; white-space: nowrap; text-shadow: 0 0 4px rgba(0,0,0,0.8); pointer-events: none;`;
                            state.lane.appendChild(indicator);
                            state.offscreenIndicator = indicator;
                        }

                        if (isOffscreen && !state.finished) {
                            const distBehind = Math.round((leaderPos - state.currentPos) / PIXELS_PER_METER);
                            state.offscreenIndicator.innerHTML = `<span style="animation: blink 0.6s infinite;">‚óÄ</span> ${distBehind}m`;
                            state.offscreenIndicator.style.display = 'block';
                            state.horse.style.left = `-200px`; // ÏôÑÏ†ÑÌûà Ïà®ÍπÄ
                            state.horse.style.visibility = 'hidden';
                        } else {
                            state.offscreenIndicator.style.display = 'none';
                            if (isOffscreen) horseDisplayPos = cullEdge;
                            state.horse.style.left = `${horseDisplayPos}px`;
                            state.horse.style.visibility = 'visible';
                        }
                        
                        // Î∞∞Í≤Ω Ïä§ÌÅ¨Î°§ - Î™®Îì† Î†àÏù∏ÏóêÏÑú Î¶¨Îçî Í∏∞Ï§ÄÏúºÎ°ú ÎèôÏùºÌïòÍ≤å
                        if (state.lane) {
                            state.lane.style.backgroundPosition = `${bgScrollOffset}px center`;
                            
                            // Í≤∞ÏäπÏÑ†ÎèÑ Î¶¨Îçî Í∏∞Ï§ÄÏúºÎ°ú Ïä§ÌÅ¨Î°§
                            if (state.lane.finishLineElement) {
                                state.lane.finishLineElement.style.left = `${finishLine + bgScrollOffset}px`;
                            }
                        }
                    });
                    
                    // ÎØ∏ÎãàÎßµ ÏóÖÎç∞Ïù¥Ìä∏
                    updateMinimap(horseStates, startPosition, totalDistance, finishLine, trackDistanceMeters, vehicleInfoMap);

                    // Ï¢ÖÎ£å Ï°∞Í±¥: Î≤†ÌåÖÎêú Îßê Ï§ë Îí§ÏóêÏÑú Îëê Î≤àÏß∏Í∞Ä ÏôÑÏ£ºÌïòÎ©¥ Ï¢ÖÎ£å
                    const totalHorses = horseStates.length;
                    const bettedIndicesForEnd = [...new Set(Object.values(userHorseBets))];
                    const bettedFinishedCount = horseStates.filter(s => bettedIndicesForEnd.includes(s.horseIndex) && s.finished).length;
                    const bettedTotal = bettedIndicesForEnd.length;
                    // Î≤†ÌåÖÎêú ÎßêÏù¥ 1ÎßàÎ¶¨Î©¥ Í∑∏ Îßê ÏôÑÏ£º Ïãú Ï¢ÖÎ£å, 2ÎßàÎ¶¨ Ïù¥ÏÉÅÏù¥Î©¥ Îí§ÏóêÏÑú Îëê Î≤àÏß∏ ÏôÑÏ£º Ïãú
                    const raceEndThreshold = bettedTotal <= 1 ? bettedTotal : bettedTotal - 1;
                    const shouldEndRace = bettedFinishedCount >= raceEndThreshold;

                    if (shouldEndRace) {
                        clearInterval(animationInterval);
                        animationInterval = null;
                        document.removeEventListener('visibilitychange', onVisChange);

                        // Ïä¨Î°úÏö∞Î™®ÏÖò Í∞ïÏ†ú Ìï¥Ï†ú
                        slowMotionFactor = 1;
                        slowMotionActive = false;
                        loserSlowMotionActive = false;
                        loserCameraTarget = null;
                        if (cameraModeBefore) { cameraMode = cameraModeBefore; cameraModeBefore = null; }
                        track.style.filter = '';
                        const vignetteCleanup = document.getElementById('slowmoVignette');
                        if (vignetteCleanup) {
                            vignetteCleanup.style.opacity = '0';
                            setTimeout(() => vignetteCleanup.remove(), 500);
                        }
                        // Ïä¨Î°úÏö∞Î™®ÏÖò ÌôòÌò∏ÏÑ± Ï†ïÏßÄ
                        if (window.SoundManager) {
                            SoundManager.stopLoop('horse-race_slowmo_cheer');
                        }

                        // ÎÇ†Ïî® ÏöîÏÜå Ï†ïÎ¶¨
                        const weatherOverlayCleanup = document.getElementById('weatherOverlay');
                        const weatherBannerCleanup = document.getElementById('weatherBanner');
                        if (weatherOverlayCleanup) {
                            weatherOverlayCleanup.style.opacity = '0';
                            setTimeout(() => weatherOverlayCleanup.remove(), 800);
                        }
                        if (weatherBannerCleanup) {
                            weatherBannerCleanup.style.opacity = '0';
                            setTimeout(() => weatherBannerCleanup.remove(), 800);
                        }
                        // Î≤ÑÌîÑ/ÎîîÎ≤ÑÌîÑ Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ Ï†úÍ±∞
                        document.querySelectorAll('.weather-indicator').forEach(el => el.remove());

                        // ÎØ∏ÏôÑÏ£º ÎßêÎì§ Ï†ÑÎ∂Ä Ï∞æÍ∏∞ (ÎπÑÏÑù ÎåÄÏÉÅ)
                        const unfinishedStates = horseStates.filter(s => !s.finished);

                        // Ïã§Ï†ú ÎèÑÏ∞© ÏàúÏÑú ÏàòÏßë (ÏôÑÏ£ºÌïú ÎßêÎì§Îßå)
                        const actualFinishOrder = horseStates
                            .filter(s => s.finished)
                            .sort((a, b) => a.finishOrder - b.finishOrder)
                            .map(s => s.horseIndex);

                        // ÎØ∏ÏôÑÏ£º ÎßêÎì§ÏùÑ ÌòÑÏû¨ ÏúÑÏπòÏàúÏúºÎ°ú Ï†ïÎ†¨ ÌõÑ ÏàúÏÑúÎåÄÎ°ú Ï∂îÍ∞Ä
                        const baseFinishOrder = actualFinishOrder.length;
                        unfinishedStates
                            .sort((a, b) => b.currentPos - a.currentPos) // ÏïûÏóê ÏûàÎäî Ïàú
                            .forEach((s, idx) => {
                                s.finished = true;
                                s.finishOrder = baseFinishOrder + idx;
                                actualFinishOrder.push(s.horseIndex);
                            });

                        // Ï†ÑÏó≠ Î≥ÄÏàòÏóê Ï†ÄÏû•
                        window.lastActualFinishOrder = actualFinishOrder;

                        // ÎØ∏ÏôÑÏ£º ÎßêÎì§ Ï†ÑÎ∂Ä ÎπÑÏÑù Ïï†ÎãàÎ©îÏù¥ÏÖò ÌõÑ Í≤åÏûÑ Ï¢ÖÎ£å
                        const finishGame = () => {
                            setTimeout(() => {
                                if (rankingInterval) {
                                    clearInterval(rankingInterval);
                                    rankingInterval = null;
                                }
                                // ÏµúÏ¢Ö ÏàúÏúÑ Ìïú Î≤à Îçî ÏóÖÎç∞Ïù¥Ìä∏
                                updateLiveRanking(horseStates);
                                // Ïû†Ïãú ÌõÑ Ìå®ÎÑê Ïà®Í∏∞Í∏∞ Î∞è ÏΩúÎ∞± Ìò∏Ï∂ú
                                setTimeout(() => {
                                    if (liveRankingPanel) {
                                        liveRankingPanel.style.display = 'none';
                                    }
                                    const minimap = document.getElementById('raceMinimap');
                                    if (minimap) minimap.style.display = 'none';
                                    // ÏôÑÎ£å ÏΩúÎ∞± Ìò∏Ï∂ú
                                    if (onComplete) {
                                        onComplete(actualFinishOrder);
                                    }
                                }, 600);
                            }, 200);
                        };

                        // ÎØ∏ÏôÑÏ£º Îßê Ï†ÑÎ∂Ä ÎπÑÏÑù Ïï†ÎãàÎ©îÏù¥ÏÖò + Íº¥Îì±ÌïúÌÖå Ïπ¥Î©îÎùº Ïù¥Îèô
                        if (unfinishedStates.length > 0) {
                            // Íº¥Îì±(Í∞ÄÏû• ÎäêÎ¶∞ Îßê)ÌïúÌÖå Ïπ¥Î©îÎùº Ïù¥Îèô
                            const loserState = unfinishedStates[unfinishedStates.length - 1];
                            loserCameraTarget = loserState;
                            cameraModeBefore = cameraMode;
                            cameraMode = '_loser';
                            updateCameraBtnUI();

                            let completedCount = 0;
                            unfinishedStates.forEach((st) => {
                                showDeathAnimation(st.horse, st.horseIndex, st.finishOrder, () => {
                                    completedCount++;
                                    if (completedCount >= unfinishedStates.length) {
                                        finishGame();
                                    }
                                });
                            });
                        } else {
                            finishGame();
                        }
                    }
                }, 16);
                
                // Ïã§ÏãúÍ∞Ñ ÏàúÏúÑ ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë (100ms Í∞ÑÍ≤©)
                rankingInterval = setInterval(() => updateLiveRanking(horseStates), 100);
                updateLiveRanking(horseStates); // Ï¶âÏãú Ï≤´ ÏóÖÎç∞Ïù¥Ìä∏
            }, 500);
            
            return maxDuration + 1000;
        }
        
        // ÏàúÏúÑ Ïù¥ÌéôÌä∏ Ïò§Î≤ÑÎ†àÏù¥ Í¥ÄÎ¶¨
        let finishEffectsOverlay = null;
        const finishEffectElements = new Map(); // horseIndex -> effectElement
        
        function getOrCreateFinishEffectsOverlay() {
            if (!finishEffectsOverlay) {
                finishEffectsOverlay = document.createElement('div');
                finishEffectsOverlay.id = 'finishEffectsOverlay';
                finishEffectsOverlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    pointer-events: none;
                    z-index: 99999;
                `;
                document.body.appendChild(finishEffectsOverlay);
            }
            return finishEffectsOverlay;
        }
        
        function clearFinishEffects() {
            if (finishEffectsOverlay) {
                finishEffectsOverlay.remove();
                finishEffectsOverlay = null;
            }
            finishEffectElements.clear();
        }
        
        // ÎèÑÏ∞© Ïï†ÎãàÎ©îÏù¥ÏÖò ÌëúÏãú (ÌÖçÏä§Ìä∏ Ïä§ÌÉÄÏùº, Îßê ÎÇ¥Î∂Ä ÏôºÏ™ΩÏóê ÌëúÏãú)
        function showFinishAnimation(horseElement, finishOrder, horseIndex) {
            const rankTexts = ['ü•á 1Îì±!', 'ü•à 2Îì±!', 'ü•â 3Îì±!', '4Îì±', '5Îì±', '6Îì±'];
            const rankColors = ['#FFD700', '#C0C0C0', '#CD7F32', '#888', '#888', '#888'];

            const existingEffect = finishEffectElements.get(horseIndex);
            if (existingEffect) existingEffect.remove();

            // Îßê ÏöîÏÜå ÏïàÏóê ÏûêÏãùÏúºÎ°ú ÏÇΩÏûÖ (overflow visibleÎ°ú ÏôºÏ™ΩÏóê ÌëúÏãú)
            horseElement.style.overflow = 'visible';

            const label = document.createElement('div');
            label.className = 'finish-effect';
            label.dataset.horseIndex = horseIndex;

            const fontSize = finishOrder === 0 ? '20px' : finishOrder <= 2 ? '17px' : '14px';

            label.style.cssText = `
                position: absolute;
                left: -75px;
                top: 40%;
                transform: translateY(-50%);
                font-size: ${fontSize};
                font-weight: 900;
                color: ${rankColors[finishOrder] || '#888'};
                pointer-events: none;
                z-index: 10;
                white-space: nowrap;
                animation: tombstoneDrop 0.5s ease-out forwards;
                opacity: 0;
            `;
            label.textContent = rankTexts[finishOrder] || `${finishOrder + 1}Îì±`;

            horseElement.appendChild(label);
            finishEffectElements.set(horseIndex, label);

            // 1Îì± ÌäπÎ≥Ñ Ìö®Í≥º: victory SVG + Í∏àÎπõ Ìö®Í≥º
            if (finishOrder === 0) {
                const vid = horseElement.dataset.vehicleId;
                if (vid) setVehicleState(horseElement, vid, 'victory');
                horseElement.style.filter = 'drop-shadow(0 0 15px gold) brightness(1.2)';
                horseElement.style.transform = 'scale(1.1)';
            }
        }
        
        // Íº¥Îì± ÏÇ¨Îßù Ïï†ÎãàÎ©îÏù¥ÏÖò (ÏãúÏ≤¥ ÌéòÏù¥Îìú ÏïÑÏõÉ + ÏòÅÌòºÎßå Ïò§Î≤ÑÎ†àÏù¥, ÎπÑÏÑùÏùÄ Ìä∏Îûô ÏïàÏ™ΩÏóê Í∑∏Î†§ÏÑú Ïä§ÌÅ¨Î°§Í≥º Ìï®Íªò Ïú†ÏßÄ)
        function showDeathAnimation(horseElement, horseIndex, finishRank, onComplete) {
            const track = document.getElementById('raceTrack');
            const overlay = getOrCreateFinishEffectsOverlay();
            const horseRect = horseElement.getBoundingClientRect();
            
            // Í∏∞Ï°¥ Ïò§Î≤ÑÎ†àÏù¥ Ïù¥ÌéôÌä∏Îßå Ï†úÍ±∞ (ÎπÑÏÑùÏùÄ Ìä∏ÎûôÏóê ÏûàÏúºÎØÄÎ°ú Ïó¨Í∏∞ÏÑú Ï†úÍ±∞ ÎåÄÏÉÅ ÏïÑÎãò)
            const existingEffect = finishEffectElements.get(horseIndex);
            if (existingEffect) existingEffect.remove();
            
            // dead ÏÉÅÌÉú SVGÎ°ú Ï†ÑÌôò (ÎπÑÏÑù + Ïú†Î†π)
            const vid = horseElement.dataset.vehicleId;
            if (vid) setVehicleState(horseElement, vid, 'dead');
            // ÌîÑÎ†àÏûÑ Ïï†ÎãàÎ©îÏù¥ÏÖò Ï§ëÏßÄ
            horseElement.classList.remove('racing');

            // BGM Ï†ïÏßÄ - ÎπÑÏÑù(ÏÇ¨Îßù) Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë Ïãú
            if (window.SoundManager) {
                SoundManager.stopLoop('horse-race_bgm');
            }

            // ÌÉàÍ≤É ÌéòÏù¥Îìú ÏïÑÏõÉ ÌõÑ ÏôÑÏ†ÑÌûà ÏÇ¨ÎùºÏßê
            horseElement.style.animation = 'deathFade 2s ease-out forwards';
            
            // ÏòÅÌòºÎßå Ïò§Î≤ÑÎ†àÏù¥Ïóê ÌëúÏãú (ÏúÑÎ°ú Ïò¨ÎùºÍ∞ÄÎ©∞ ÏÇ¨ÎùºÏßê)
            const soulContainer = document.createElement('div');
            soulContainer.className = 'death-effect soul-only';
            soulContainer.dataset.horseIndex = horseIndex;
            soulContainer.style.cssText = `
                position: fixed;
                left: ${horseRect.left + horseRect.width / 2 - 15}px;
                top: ${horseRect.top + horseRect.height / 2 - 15}px;
                width: 30px;
                height: 40px;
                pointer-events: none;
                z-index: 10000;
            `;
            const soul = document.createElement('div');
            soul.innerHTML = 'üëª';
            soul.style.cssText = `
                position: absolute;
                top: 0;
                left: 50%;
                transform: translateX(-50%);
                font-size: 30px;
                animation: soulRise 3s ease-out forwards;
                text-shadow: 0 0 10px rgba(255,255,255,0.8);
            `;
            soulContainer.appendChild(soul);
            overlay.appendChild(soulContainer);
            finishEffectElements.set(horseIndex, soulContainer);
            setTimeout(() => {
                if (soulContainer.parentNode) soulContainer.remove();
                finishEffectElements.delete(horseIndex);
            }, 3500);
            
            // ÎπÑÏÑùÏùÄ Ìä∏Îûô ÏïàÏ™ΩÏóê Ï∂îÍ∞Ä (Íº¥Îì± Ï†ÑÏö©)
            if (track) {
                const leftPx = horseElement.offsetLeft + (horseElement.offsetWidth / 2) - 25;
                const topPx = horseElement.offsetTop + (horseElement.offsetHeight / 2) - 40;
                const tombstoneWrap = document.createElement('div');
                tombstoneWrap.className = 'tombstone-in-track';
                tombstoneWrap.dataset.horseIndex = horseIndex;
                tombstoneWrap.style.cssText = `
                    position: absolute;
                    left: ${leftPx}px;
                    top: ${topPx}px;
                    pointer-events: none;
                    z-index: 150;
                    font-size: 35px;
                    text-align: center;
                    animation: tombstoneDrop 1.6s ease-out 1s forwards;
                    opacity: 0;
                    filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.5));
                `;
                tombstoneWrap.innerHTML = `ü™¶<span style="display:block;font-size:12px;font-weight:bold;color:#444;">${finishRank + 1}Îì±</span>`;
                track.appendChild(tombstoneWrap);
            }
            
            setTimeout(() => {
                if (onComplete) onComplete();
            }, 4000);
        }
        
        // Ï∂ïÌïò Ïª®ÌéòÌã∞ ÏÉùÏÑ±
        function createConfetti() {
            const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8'];
            let confettiHtml = '';
            
            for (let i = 0; i < 20; i++) {
                const color = colors[Math.floor(Math.random() * colors.length)];
                const left = Math.random() * 80 - 10;
                const delay = Math.random() * 0.3;
                const rotation = Math.random() * 360;
                const size = 4 + Math.random() * 4;
                const duration = 1 + Math.random() * 0.5;
                
                confettiHtml += `
                    <div style="
                        position: absolute;
                        left: ${left}px;
                        top: 0;
                        width: ${size}px;
                        height: ${size}px;
                        background: ${color};
                        transform: rotate(${rotation}deg);
                        animation: confettiFall ${duration}s ease-out ${delay}s forwards;
                        opacity: 0;
                        border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
                    "></div>
                `;
            }
            
            return confettiHtml;
        }
        
        // ÌÉàÍ≤ÉÎ≥Ñ SVG ÏÉùÏÑ± Ìï®Ïàò
        // ÌÉàÍ≤É ÏÉÅÌÉú Ï†ÑÌôò Ìó¨Ìçº
        function setVehicleState(horseElement, vehicleId, state) {
            const svgData = getVehicleSVG(vehicleId);
            const stateData = svgData[state] || svgData.run || svgData;
            const sprite = horseElement.querySelector('.vehicle-sprite');
            if (!sprite) return;
            const f1 = sprite.querySelector('.frame1');
            const f2 = sprite.querySelector('.frame2');
            if (f1) f1.innerHTML = stateData.frame1;
            if (f2 && stateData.frame2) f2.innerHTML = stateData.frame2;
        }

        function getVehicleSVG(vehicleId) {
            const svgMap = {
                'car': { // ÏûêÎèôÏ∞® - Î∞îÌÄ¥ ÌöåÏ†Ñ
                    run: {
                        frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <rect x="10" y="15" width="40" height="15" rx="3" fill="#e74c3c"/>
                            <rect x="18" y="8" width="22" height="12" rx="2" fill="#e74c3c"/>
                            <rect x="20" y="10" width="8" height="8" fill="#87CEEB"/>
                            <rect x="30" y="10" width="8" height="8" fill="#87CEEB"/>
                            <circle cx="18" cy="32" r="6" fill="#333"/><circle cx="18" cy="32" r="3" fill="#666"/>
                            <line x1="18" y1="29" x2="18" y2="35" stroke="#999" stroke-width="1"/>
                            <circle cx="42" cy="32" r="6" fill="#333"/><circle cx="42" cy="32" r="3" fill="#666"/>
                            <line x1="42" y1="29" x2="42" y2="35" stroke="#999" stroke-width="1"/>
                        </svg>`,
                        frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <rect x="10" y="15" width="40" height="15" rx="3" fill="#e74c3c"/>
                            <rect x="18" y="8" width="22" height="12" rx="2" fill="#e74c3c"/>
                            <rect x="20" y="10" width="8" height="8" fill="#87CEEB"/>
                            <rect x="30" y="10" width="8" height="8" fill="#87CEEB"/>
                            <circle cx="18" cy="32" r="6" fill="#333"/><circle cx="18" cy="32" r="3" fill="#666"/>
                            <line x1="15" y1="32" x2="21" y2="32" stroke="#999" stroke-width="1"/>
                            <circle cx="42" cy="32" r="6" fill="#333"/><circle cx="42" cy="32" r="3" fill="#666"/>
                            <line x1="39" y1="32" x2="45" y2="32" stroke="#999" stroke-width="1"/>
                        </svg>`
                    },
                    rest: {
                        frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <rect x="10" y="15" width="40" height="15" rx="3" fill="#a93226"/>
                            <rect x="18" y="8" width="22" height="12" rx="2" fill="#a93226"/>
                            <rect x="20" y="10" width="8" height="8" fill="#5a8fa8"/>
                            <rect x="30" y="10" width="8" height="8" fill="#5a8fa8"/>
                            <circle cx="18" cy="32" r="6" fill="#333"/><circle cx="18" cy="32" r="3" fill="#555"/>
                            <circle cx="42" cy="32" r="6" fill="#333"/><circle cx="42" cy="32" r="3" fill="#555"/>
                            <text x="24" y="8" font-size="8" fill="#fff">z</text>
                            <text x="28" y="5" font-size="6" fill="#fff">z</text>
                        </svg>`,
                        frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <rect x="10" y="15" width="40" height="15" rx="3" fill="#a93226"/>
                            <rect x="18" y="8" width="22" height="12" rx="2" fill="#a93226"/>
                            <rect x="20" y="10" width="8" height="8" fill="#5a8fa8"/>
                            <rect x="30" y="10" width="8" height="8" fill="#5a8fa8"/>
                            <circle cx="18" cy="32" r="6" fill="#333"/><circle cx="18" cy="32" r="3" fill="#555"/>
                            <circle cx="42" cy="32" r="6" fill="#333"/><circle cx="42" cy="32" r="3" fill="#555"/>
                            <text x="26" y="6" font-size="8" fill="#fff">z</text>
                            <text x="30" y="3" font-size="6" fill="#fff">z</text>
                        </svg>`
                    }
                },
                'rocket': { // Î°úÏºì - Î∂àÍΩÉ ÍπúÎπ°ÏûÑ
                    run: {
                        frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <ellipse cx="35" cy="22" rx="18" ry="10" fill="#3498db"/>
                            <polygon points="53,22 60,15 60,29" fill="#e74c3c"/>
                            <circle cx="50" cy="22" r="4" fill="#87CEEB"/>
                            <rect x="8" y="18" width="10" height="8" fill="#e74c3c"/>
                            <polygon points="8,22 2,18 2,26" fill="#f39c12"/>
                            <polygon points="2,22 -3,20 -3,24" fill="#e67e22"/>
                        </svg>`,
                        frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <ellipse cx="35" cy="22" rx="18" ry="10" fill="#3498db"/>
                            <polygon points="53,22 60,15 60,29" fill="#e74c3c"/>
                            <circle cx="50" cy="22" r="4" fill="#87CEEB"/>
                            <rect x="8" y="18" width="10" height="8" fill="#e74c3c"/>
                            <polygon points="8,22 0,16 0,28" fill="#f1c40f"/>
                            <polygon points="0,22 -5,19 -5,25" fill="#f39c12"/>
                        </svg>`
                    },
                    rest: {
                        frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <ellipse cx="35" cy="28" rx="18" ry="10" fill="#2980b9"/>
                            <polygon points="53,28 60,21 60,35" fill="#c0392b"/>
                            <circle cx="50" cy="28" r="4" fill="#5a8fa8"/>
                            <rect x="8" y="24" width="10" height="8" fill="#c0392b"/>
                            <rect x="20" y="38" width="8" height="4" fill="#7f8c8d"/>
                            <rect x="38" y="38" width="8" height="4" fill="#7f8c8d"/>
                            <text x="24" y="20" font-size="8" fill="#fff">z</text>
                            <text x="28" y="16" font-size="6" fill="#fff">z</text>
                        </svg>`,
                        frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <ellipse cx="35" cy="28" rx="18" ry="10" fill="#2980b9"/>
                            <polygon points="53,28 60,21 60,35" fill="#c0392b"/>
                            <circle cx="50" cy="28" r="4" fill="#5a8fa8"/>
                            <rect x="8" y="24" width="10" height="8" fill="#c0392b"/>
                            <rect x="20" y="38" width="8" height="4" fill="#7f8c8d"/>
                            <rect x="38" y="38" width="8" height="4" fill="#7f8c8d"/>
                            <text x="26" y="18" font-size="8" fill="#fff">z</text>
                            <text x="30" y="14" font-size="6" fill="#fff">z</text>
                        </svg>`
                    }
                },
                'bird': { // ÏÉà - ÎÇ†Í∞ú ÌéÑÎü≠ÏûÑ
                    run: {
                        frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <ellipse cx="30" cy="25" rx="15" ry="8" fill="#9b59b6"/>
                            <circle cx="48" cy="22" r="7" fill="#9b59b6"/>
                            <polygon points="55,22 62,20 62,24" fill="#f39c12"/>
                            <circle cx="52" cy="20" r="2" fill="black"/>
                            <path d="M25,25 Q15,10 30,18" fill="#8e44ad"/>
                            <path d="M35,25 Q25,8 40,16" fill="#8e44ad"/>
                            <polygon points="12,28 8,32 15,30" fill="#9b59b6"/>
                        </svg>`,
                        frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <ellipse cx="30" cy="25" rx="15" ry="8" fill="#9b59b6"/>
                            <circle cx="48" cy="22" r="7" fill="#9b59b6"/>
                            <polygon points="55,22 62,20 62,24" fill="#f39c12"/>
                            <circle cx="52" cy="20" r="2" fill="black"/>
                            <path d="M25,25 Q15,35 30,30" fill="#8e44ad"/>
                            <path d="M35,25 Q25,38 40,32" fill="#8e44ad"/>
                            <polygon points="12,28 8,32 15,30" fill="#9b59b6"/>
                        </svg>`
                    },
                    rest: {
                        frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <ellipse cx="30" cy="32" rx="15" ry="8" fill="#8e44ad"/>
                            <circle cx="48" cy="28" r="7" fill="#8e44ad"/>
                            <polygon points="55,28 62,26 62,30" fill="#d68910"/>
                            <ellipse cx="52" cy="26" rx="2" ry="1" fill="black"/>
                            <path d="M22,30 Q18,28 16,32" fill="#7d3c98"/>
                            <path d="M38,30 Q42,28 44,32" fill="#7d3c98"/>
                            <ellipse cx="20" cy="38" rx="4" ry="2" fill="#d68910"/>
                            <ellipse cx="40" cy="38" rx="4" ry="2" fill="#d68910"/>
                        </svg>`,
                        frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <ellipse cx="30" cy="33" rx="15" ry="8" fill="#8e44ad"/>
                            <circle cx="48" cy="29" r="7" fill="#8e44ad"/>
                            <polygon points="55,29 62,27 62,31" fill="#d68910"/>
                            <ellipse cx="52" cy="27" rx="2" ry="1" fill="black"/>
                            <path d="M22,31 Q18,29 16,33" fill="#7d3c98"/>
                            <path d="M38,31 Q42,29 44,33" fill="#7d3c98"/>
                            <ellipse cx="20" cy="39" rx="4" ry="2" fill="#d68910"/>
                            <ellipse cx="40" cy="39" rx="4" ry="2" fill="#d68910"/>
                        </svg>`
                    }
                },
                'boat': { // Î≥¥Ìä∏ - Î¨ºÍ≤∞ Ìö®Í≥º
                    run: {
                        frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <path d="M5,30 Q15,28 25,30 Q35,32 45,30 Q55,28 60,30" fill="none" stroke="#3498db" stroke-width="3"/>
                            <polygon points="10,28 50,28 45,20 15,20" fill="#e74c3c"/>
                            <rect x="28" y="10" width="4" height="12" fill="#8b4513"/>
                            <polygon points="32,8 32,18 50,14" fill="white"/>
                        </svg>`,
                        frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <path d="M5,30 Q15,32 25,30 Q35,28 45,30 Q55,32 60,30" fill="none" stroke="#3498db" stroke-width="3"/>
                            <polygon points="10,28 50,28 45,20 15,20" fill="#e74c3c"/>
                            <rect x="28" y="10" width="4" height="12" fill="#8b4513"/>
                            <polygon points="32,8 32,18 50,14" fill="white"/>
                        </svg>`
                    },
                    rest: {
                        frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <path d="M5,32 Q15,32 25,32 Q35,32 45,32 Q55,32 60,32" fill="none" stroke="#2980b9" stroke-width="3"/>
                            <polygon points="10,30 50,30 45,22 15,22" fill="#a93226"/>
                            <rect x="28" y="14" width="4" height="10" fill="#6d4c41"/>
                            <polygon points="32,14 32,20 38,18" fill="#bdc3c7"/>
                            <circle cx="48" cy="26" r="3" fill="#7f8c8d"/>
                            <text x="20" y="18" font-size="8" fill="#fff">z</text>
                        </svg>`,
                        frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <path d="M5,32 Q15,32 25,32 Q35,32 45,32 Q55,32 60,32" fill="none" stroke="#2980b9" stroke-width="3"/>
                            <polygon points="10,30 50,30 45,22 15,22" fill="#a93226"/>
                            <rect x="28" y="14" width="4" height="10" fill="#6d4c41"/>
                            <polygon points="32,14 32,20 38,18" fill="#bdc3c7"/>
                            <circle cx="48" cy="26" r="3" fill="#7f8c8d"/>
                            <text x="22" y="16" font-size="8" fill="#fff">z</text>
                        </svg>`
                    }
                },
                'bicycle': { // ÏûêÏ†ÑÍ±∞ - ÌéòÎã¨ ÌöåÏ†Ñ
                    run: {
                        frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <circle cx="12" cy="30" r="8" fill="none" stroke="#333" stroke-width="2"/>
                            <circle cx="48" cy="30" r="8" fill="none" stroke="#333" stroke-width="2"/>
                            <line x1="12" y1="30" x2="30" y2="30" stroke="#666" stroke-width="2"/>
                            <line x1="30" y1="30" x2="48" y2="30" stroke="#666" stroke-width="2"/>
                            <line x1="30" y1="30" x2="35" y2="15" stroke="#666" stroke-width="2"/>
                            <circle cx="35" cy="13" r="4" fill="#f39c12"/>
                            <circle cx="30" cy="30" r="3" fill="#333"/>
                            <line x1="30" y1="30" x2="33" y2="35" stroke="#333" stroke-width="2"/>
                            <line x1="30" y1="30" x2="27" y2="25" stroke="#333" stroke-width="2"/>
                        </svg>`,
                        frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <circle cx="12" cy="30" r="8" fill="none" stroke="#333" stroke-width="2"/>
                            <circle cx="48" cy="30" r="8" fill="none" stroke="#333" stroke-width="2"/>
                            <line x1="12" y1="30" x2="30" y2="30" stroke="#666" stroke-width="2"/>
                            <line x1="30" y1="30" x2="48" y2="30" stroke="#666" stroke-width="2"/>
                            <line x1="30" y1="30" x2="35" y2="15" stroke="#666" stroke-width="2"/>
                            <circle cx="35" cy="13" r="4" fill="#f39c12"/>
                            <circle cx="30" cy="30" r="3" fill="#333"/>
                            <line x1="30" y1="30" x2="27" y2="35" stroke="#333" stroke-width="2"/>
                            <line x1="30" y1="30" x2="33" y2="25" stroke="#333" stroke-width="2"/>
                        </svg>`
                    },
                    rest: {
                        frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <circle cx="15" cy="35" r="8" fill="none" stroke="#555" stroke-width="2"/>
                            <circle cx="45" cy="32" r="8" fill="none" stroke="#555" stroke-width="2"/>
                            <line x1="15" y1="35" x2="30" y2="30" stroke="#555" stroke-width="2"/>
                            <line x1="30" y1="30" x2="45" y2="32" stroke="#555" stroke-width="2"/>
                            <line x1="30" y1="30" x2="38" y2="18" stroke="#555" stroke-width="2"/>
                            <rect x="36" y="15" width="8" height="4" rx="1" fill="#555"/>
                            <circle cx="30" cy="30" r="3" fill="#444"/>
                            <line x1="30" y1="30" x2="30" y2="36" stroke="#444" stroke-width="2"/>
                        </svg>`,
                        frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <circle cx="15" cy="35" r="8" fill="none" stroke="#555" stroke-width="2"/>
                            <circle cx="45" cy="32" r="8" fill="none" stroke="#555" stroke-width="2"/>
                            <line x1="15" y1="35" x2="30" y2="30" stroke="#555" stroke-width="2"/>
                            <line x1="30" y1="30" x2="45" y2="32" stroke="#555" stroke-width="2"/>
                            <line x1="30" y1="30" x2="38" y2="18" stroke="#555" stroke-width="2"/>
                            <rect x="36" y="15" width="8" height="4" rx="1" fill="#555"/>
                            <circle cx="30" cy="30" r="3" fill="#444"/>
                            <line x1="30" y1="30" x2="30" y2="36" stroke="#444" stroke-width="2"/>
                        </svg>`
                    }
                },
                'rabbit': { // ÌÜ†ÎÅº - Íπ°Ï∂©Íπ°Ï∂©
                    run: {
                        frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <ellipse cx="30" cy="28" rx="14" ry="10" fill="#f5f5dc"/>
                            <circle cx="45" cy="22" r="8" fill="#f5f5dc"/>
                            <ellipse cx="40" cy="8" rx="3" ry="10" fill="#f5f5dc"/>
                            <ellipse cx="48" cy="10" rx="3" ry="9" fill="#f5f5dc"/>
                            <ellipse cx="40" cy="10" rx="2" ry="6" fill="#ffb6c1"/>
                            <ellipse cx="48" cy="12" rx="2" ry="5" fill="#ffb6c1"/>
                            <circle cx="50" cy="20" r="2" fill="black"/>
                            <circle cx="47" cy="26" r="2" fill="#ffb6c1"/>
                            <ellipse cx="18" cy="32" rx="5" ry="4" fill="#f5f5dc"/>
                            <ellipse cx="25" cy="35" rx="4" ry="3" fill="#f5f5dc"/>
                            <circle cx="14" cy="30" r="4" fill="#f5f5dc"/>
                        </svg>`,
                        frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <ellipse cx="30" cy="24" rx="14" ry="10" fill="#f5f5dc"/>
                            <circle cx="45" cy="18" r="8" fill="#f5f5dc"/>
                            <ellipse cx="40" cy="4" rx="3" ry="10" fill="#f5f5dc"/>
                            <ellipse cx="48" cy="6" rx="3" ry="9" fill="#f5f5dc"/>
                            <ellipse cx="40" cy="6" rx="2" ry="6" fill="#ffb6c1"/>
                            <ellipse cx="48" cy="8" rx="2" ry="5" fill="#ffb6c1"/>
                            <circle cx="50" cy="16" r="2" fill="black"/>
                            <circle cx="47" cy="22" r="2" fill="#ffb6c1"/>
                            <ellipse cx="20" cy="38" rx="5" ry="4" fill="#f5f5dc"/>
                            <ellipse cx="28" cy="40" rx="4" ry="3" fill="#f5f5dc"/>
                            <circle cx="14" cy="35" r="4" fill="#f5f5dc"/>
                        </svg>`
                    },
                    rest: {
                        frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <ellipse cx="30" cy="32" rx="16" ry="8" fill="#ddd8c4"/>
                            <circle cx="46" cy="28" r="7" fill="#ddd8c4"/>
                            <ellipse cx="42" cy="18" rx="3" ry="8" fill="#ddd8c4"/>
                            <ellipse cx="48" cy="20" rx="3" ry="7" fill="#ddd8c4"/>
                            <ellipse cx="42" cy="20" rx="2" ry="5" fill="#e8b4b8"/>
                            <ellipse cx="48" cy="22" rx="2" ry="4" fill="#e8b4b8"/>
                            <ellipse cx="50" cy="27" rx="2" ry="1" fill="black"/>
                            <circle cx="47" cy="32" r="2" fill="#e8b4b8"/>
                            <ellipse cx="18" cy="36" rx="5" ry="3" fill="#ddd8c4"/>
                            <ellipse cx="26" cy="38" rx="4" ry="2" fill="#ddd8c4"/>
                            <circle cx="12" cy="34" r="4" fill="#ddd8c4"/>
                        </svg>`,
                        frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <ellipse cx="30" cy="33" rx="16" ry="8" fill="#ddd8c4"/>
                            <circle cx="46" cy="29" r="7" fill="#ddd8c4"/>
                            <ellipse cx="42" cy="19" rx="3" ry="8" fill="#ddd8c4"/>
                            <ellipse cx="48" cy="21" rx="3" ry="7" fill="#ddd8c4"/>
                            <ellipse cx="42" cy="21" rx="2" ry="5" fill="#e8b4b8"/>
                            <ellipse cx="48" cy="23" rx="2" ry="4" fill="#e8b4b8"/>
                            <ellipse cx="50" cy="28" rx="2" ry="1" fill="black"/>
                            <circle cx="47" cy="33" r="2" fill="#e8b4b8"/>
                            <ellipse cx="18" cy="37" rx="5" ry="3" fill="#ddd8c4"/>
                            <ellipse cx="26" cy="39" rx="4" ry="2" fill="#ddd8c4"/>
                            <circle cx="12" cy="35" r="4" fill="#ddd8c4"/>
                        </svg>`
                    }
                },
                'turtle': { // Í±∞Î∂ÅÏù¥ - ÎäêÎ¶øÎäêÎ¶ø
                    run: {
                        frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <ellipse cx="30" cy="28" rx="18" ry="12" fill="#228B22"/>
                            <path d="M15,20 Q30,10 45,20" fill="#006400"/>
                            <ellipse cx="50" cy="28" rx="6" ry="5" fill="#8FBC8F"/>
                            <circle cx="54" cy="26" r="2" fill="black"/>
                            <ellipse cx="18" cy="36" rx="4" ry="3" fill="#8FBC8F"/>
                            <ellipse cx="42" cy="36" rx="4" ry="3" fill="#8FBC8F"/>
                            <ellipse cx="20" cy="24" rx="3" ry="2" fill="#8FBC8F"/>
                            <ellipse cx="40" cy="24" rx="3" ry="2" fill="#8FBC8F"/>
                            <circle cx="10" cy="30" r="3" fill="#8FBC8F"/>
                        </svg>`,
                        frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <ellipse cx="30" cy="28" rx="18" ry="12" fill="#228B22"/>
                            <path d="M15,20 Q30,10 45,20" fill="#006400"/>
                            <ellipse cx="52" cy="28" rx="6" ry="5" fill="#8FBC8F"/>
                            <circle cx="56" cy="26" r="2" fill="black"/>
                            <ellipse cx="16" cy="38" rx="4" ry="3" fill="#8FBC8F"/>
                            <ellipse cx="40" cy="38" rx="4" ry="3" fill="#8FBC8F"/>
                            <ellipse cx="22" cy="22" rx="3" ry="2" fill="#8FBC8F"/>
                            <ellipse cx="42" cy="22" rx="3" ry="2" fill="#8FBC8F"/>
                            <circle cx="8" cy="32" r="3" fill="#8FBC8F"/>
                        </svg>`
                    },
                    rest: {
                        frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <ellipse cx="30" cy="30" rx="18" ry="12" fill="#1e7b1e"/>
                            <path d="M15,22 Q30,12 45,22" fill="#005500"/>
                            <ellipse cx="46" cy="32" rx="4" ry="3" fill="#7aa87a"/>
                            <circle cx="10" cy="32" r="2" fill="#7aa87a"/>
                        </svg>`,
                        frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <ellipse cx="30" cy="31" rx="18" ry="12" fill="#1e7b1e"/>
                            <path d="M15,23 Q30,13 45,23" fill="#005500"/>
                            <ellipse cx="46" cy="33" rx="4" ry="3" fill="#7aa87a"/>
                            <circle cx="10" cy="33" r="2" fill="#7aa87a"/>
                        </svg>`
                    }
                },
                'eagle': { // ÎèÖÏàòÎ¶¨ - ÎÇ†Í∞ú ÌéÑÎü≠ÏûÑ
                    run: {
                        frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <ellipse cx="30" cy="25" rx="12" ry="7" fill="#8B4513"/>
                            <circle cx="48" cy="22" r="7" fill="#8B4513"/>
                            <polygon points="55,22 63,20 63,24" fill="#FFD700"/>
                            <polygon points="55,22 63,22 58,25" fill="#DAA520"/>
                            <circle cx="52" cy="19" r="2" fill="black"/>
                            <path d="M22,25 Q5,8 28,18" fill="#654321"/>
                            <path d="M35,25 Q55,5 40,18" fill="#654321"/>
                            <polygon points="15,28 10,32 18,30" fill="#8B4513"/>
                        </svg>`,
                        frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <ellipse cx="30" cy="25" rx="12" ry="7" fill="#8B4513"/>
                            <circle cx="48" cy="22" r="7" fill="#8B4513"/>
                            <polygon points="55,22 63,20 63,24" fill="#FFD700"/>
                            <polygon points="55,22 63,22 58,25" fill="#DAA520"/>
                            <circle cx="52" cy="19" r="2" fill="black"/>
                            <path d="M22,25 Q5,38 28,32" fill="#654321"/>
                            <path d="M35,25 Q55,40 40,32" fill="#654321"/>
                            <polygon points="15,28 10,32 18,30" fill="#8B4513"/>
                        </svg>`
                    },
                    rest: {
                        frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <ellipse cx="30" cy="32" rx="12" ry="7" fill="#7a3d10"/>
                            <circle cx="46" cy="28" r="7" fill="#7a3d10"/>
                            <polygon points="53,28 60,26 60,30" fill="#d4a017"/>
                            <polygon points="53,28 60,28 56,31" fill="#b8860b"/>
                            <ellipse cx="50" cy="26" rx="2" ry="1" fill="black"/>
                            <path d="M22,30 Q18,28 16,32" fill="#5a3520"/>
                            <path d="M38,30 Q42,28 44,32" fill="#5a3520"/>
                            <ellipse cx="22" cy="38" rx="4" ry="2" fill="#d4a017"/>
                            <ellipse cx="38" cy="38" rx="4" ry="2" fill="#d4a017"/>
                        </svg>`,
                        frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <ellipse cx="30" cy="33" rx="12" ry="7" fill="#7a3d10"/>
                            <circle cx="46" cy="29" r="7" fill="#7a3d10"/>
                            <polygon points="53,29 60,27 60,31" fill="#d4a017"/>
                            <polygon points="53,29 60,29 56,32" fill="#b8860b"/>
                            <ellipse cx="50" cy="27" rx="2" ry="1" fill="black"/>
                            <path d="M22,31 Q18,29 16,33" fill="#5a3520"/>
                            <path d="M38,31 Q42,29 44,33" fill="#5a3520"/>
                            <ellipse cx="22" cy="39" rx="4" ry="2" fill="#d4a017"/>
                            <ellipse cx="38" cy="39" rx="4" ry="2" fill="#d4a017"/>
                        </svg>`
                    }
                },
                'scooter': { // ÌÇ•Î≥¥Îìú - Î∞îÌÄ¥ ÌöåÏ†Ñ (Ïò§Î•∏Ï™Ω Î∞©Ìñ•)
                    run: {
                        frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <circle cx="12" cy="35" r="6" fill="#333"/>
                            <circle cx="48" cy="35" r="6" fill="#333"/>
                            <line x1="48" y1="35" x2="48" y2="15" stroke="#666" stroke-width="3"/>
                            <line x1="12" y1="35" x2="48" y2="35" stroke="#333" stroke-width="2"/>
                            <rect x="42" y="12" width="10" height="4" rx="2" fill="#666"/>
                            <circle cx="25" cy="20" r="5" fill="#3498db"/>
                            <line x1="25" y1="25" x2="25" y2="35" stroke="#333" stroke-width="2"/>
                            <line x1="25" y1="35" x2="22" y2="42" stroke="#333" stroke-width="2"/>
                            <line x1="25" y1="35" x2="28" y2="42" stroke="#333" stroke-width="2"/>
                        </svg>`,
                        frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <circle cx="12" cy="35" r="6" fill="#333"/>
                            <circle cx="48" cy="35" r="6" fill="#333"/>
                            <line x1="48" y1="35" x2="48" y2="15" stroke="#666" stroke-width="3"/>
                            <line x1="12" y1="35" x2="48" y2="35" stroke="#333" stroke-width="2"/>
                            <rect x="42" y="12" width="10" height="4" rx="2" fill="#666"/>
                            <circle cx="25" cy="20" r="5" fill="#3498db"/>
                            <line x1="25" y1="25" x2="25" y2="35" stroke="#333" stroke-width="2"/>
                            <line x1="25" y1="35" x2="28" y2="42" stroke="#333" stroke-width="2"/>
                            <line x1="25" y1="35" x2="22" y2="42" stroke="#333" stroke-width="2"/>
                        </svg>`
                    },
                    rest: {
                        frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <circle cx="15" cy="38" r="6" fill="#444"/>
                            <circle cx="45" cy="38" r="6" fill="#444"/>
                            <line x1="45" y1="38" x2="40" y2="20" stroke="#555" stroke-width="3"/>
                            <line x1="15" y1="38" x2="45" y2="38" stroke="#444" stroke-width="2"/>
                            <rect x="35" y="17" width="8" height="4" rx="2" fill="#555"/>
                        </svg>`,
                        frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <circle cx="15" cy="38" r="6" fill="#444"/>
                            <circle cx="45" cy="38" r="6" fill="#444"/>
                            <line x1="45" y1="38" x2="40" y2="20" stroke="#555" stroke-width="3"/>
                            <line x1="15" y1="38" x2="45" y2="38" stroke="#444" stroke-width="2"/>
                            <rect x="35" y="17" width="8" height="4" rx="2" fill="#555"/>
                        </svg>`
                    }
                },
                'helicopter': { // Ìó¨Î¶¨ÏΩ•ÌÑ∞ - ÌîÑÎ°úÌé†Îü¨ ÌöåÏ†Ñ (Ï¢åÏö∞Î∞òÏ†Ñ)
                    run: {
                        frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <g transform="translate(60, 0) scale(-1, 1)">
                                <ellipse cx="30" cy="25" rx="18" ry="10" fill="#e74c3c"/>
                                <rect x="45" y="22" width="15" height="4" fill="#c0392b"/>
                                <polygon points="58,20 62,24 58,28" fill="#c0392b"/>
                                <circle cx="40" cy="22" r="5" fill="#87CEEB"/>
                                <line x1="30" y1="15" x2="30" y2="10" stroke="#333" stroke-width="2"/>
                                <line x1="15" y1="10" x2="45" y2="10" stroke="#333" stroke-width="2"/>
                                <line x1="25" y1="35" x2="25" y2="40" stroke="#333" stroke-width="2"/>
                                <line x1="35" y1="35" x2="35" y2="40" stroke="#333" stroke-width="2"/>
                                <line x1="20" y1="40" x2="40" y2="40" stroke="#333" stroke-width="2"/>
                            </g>
                        </svg>`,
                        frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <g transform="translate(60, 0) scale(-1, 1)">
                                <ellipse cx="30" cy="25" rx="18" ry="10" fill="#e74c3c"/>
                                <rect x="45" y="22" width="15" height="4" fill="#c0392b"/>
                                <polygon points="58,20 62,24 58,28" fill="#c0392b"/>
                                <circle cx="40" cy="22" r="5" fill="#87CEEB"/>
                                <line x1="30" y1="15" x2="30" y2="10" stroke="#333" stroke-width="2"/>
                                <line x1="20" y1="8" x2="40" y2="12" stroke="#333" stroke-width="2"/>
                                <line x1="25" y1="35" x2="25" y2="40" stroke="#333" stroke-width="2"/>
                                <line x1="35" y1="35" x2="35" y2="40" stroke="#333" stroke-width="2"/>
                                <line x1="20" y1="40" x2="40" y2="40" stroke="#333" stroke-width="2"/>
                            </g>
                        </svg>`
                    },
                    rest: {
                        frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <g transform="translate(60, 0) scale(-1, 1)">
                                <ellipse cx="30" cy="28" rx="18" ry="10" fill="#a93226"/>
                                <rect x="45" y="25" width="15" height="4" fill="#922b21"/>
                                <polygon points="58,23 62,27 58,31" fill="#922b21"/>
                                <circle cx="40" cy="25" r="5" fill="#5a8fa8"/>
                                <line x1="30" y1="18" x2="30" y2="14" stroke="#444" stroke-width="2"/>
                                <line x1="22" y1="14" x2="38" y2="14" stroke="#444" stroke-width="2"/>
                                <line x1="25" y1="38" x2="25" y2="42" stroke="#444" stroke-width="2"/>
                                <line x1="35" y1="38" x2="35" y2="42" stroke="#444" stroke-width="2"/>
                                <line x1="20" y1="42" x2="40" y2="42" stroke="#444" stroke-width="2"/>
                            </g>
                        </svg>`,
                        frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <g transform="translate(60, 0) scale(-1, 1)">
                                <ellipse cx="30" cy="28" rx="18" ry="10" fill="#a93226"/>
                                <rect x="45" y="25" width="15" height="4" fill="#922b21"/>
                                <polygon points="58,23 62,27 58,31" fill="#922b21"/>
                                <circle cx="40" cy="25" r="5" fill="#5a8fa8"/>
                                <line x1="30" y1="18" x2="30" y2="14" stroke="#444" stroke-width="2"/>
                                <line x1="22" y1="14" x2="38" y2="14" stroke="#444" stroke-width="2"/>
                                <line x1="25" y1="38" x2="25" y2="42" stroke="#444" stroke-width="2"/>
                                <line x1="35" y1="38" x2="35" y2="42" stroke="#444" stroke-width="2"/>
                                <line x1="20" y1="42" x2="40" y2="42" stroke="#444" stroke-width="2"/>
                            </g>
                        </svg>`
                    }
                },
                'horse': { // Îßê - ÏÉÅÌÉúÎ≥Ñ Ïï†ÎãàÎ©îÏù¥ÏÖò
                    // === ÎåÄÍ∏∞ Î™®ÏÖò (idle) - Ï†úÏûêÎ¶¨ÏóêÏÑú Î∞úÍµ¨Î•¥Í∏∞, Î®∏Î¶¨ ÏúÑÏïÑÎûò ===
                    idle: {
                        frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <!-- Îí∑Îã§Î¶¨ (Î™®Îëê ÎïÖ) -->
                            <path d="M36,28 L37,38 L35,40 L33,40 Z" fill="#654321"/>
                            <ellipse cx="34" cy="40" rx="2.5" ry="3" fill="#2C1810"/>
                            <path d="M30,28 L31,38 L29,40 L27,40 Z" fill="#654321"/>
                            <ellipse cx="28" cy="40" rx="2.5" ry="3" fill="#2C1810"/>
                            <!-- Î™∏ÌÜµ -->
                            <ellipse cx="28" cy="26" rx="12" ry="7" fill="#8B4513"/>
                            <!-- Î™© (ÏÇ¥Ïßù ÎÜíÏù¥) -->
                            <path d="M16,26 Q20,17 24,19 Q26,22 28,26" fill="#8B4513"/>
                            <!-- ÏïûÎã§Î¶¨ (Ïò§Î•∏Ï™Ω - ÏÇ¥Ïßù Îì§Î¶º, Î∞úÍµ¨Î•¥Í∏∞) -->
                            <path d="M22,26 L21,36 L19,38 L23,38 Z" fill="#654321"/>
                            <ellipse cx="20" cy="38" rx="2.5" ry="3" fill="#2C1810"/>
                            <!-- ÏïûÎã§Î¶¨ (ÏôºÏ™Ω - ÎïÖ) -->
                            <path d="M18,26 L17,38 L15,40 L19,40 Z" fill="#654321"/>
                            <ellipse cx="16" cy="40" rx="2.5" ry="3" fill="#2C1810"/>
                            <!-- Î®∏Î¶¨ (ÎÜíÏùÄ ÏúÑÏπò) -->
                            <ellipse cx="46" cy="16" rx="8" ry="7" fill="#8B4513"/>
                            <ellipse cx="48" cy="14" rx="5" ry="4" fill="#A0522D"/>
                            <!-- Í∑Ä -->
                            <path d="M40,10 Q42,4 44,8 Q42,6 40,10" fill="#654321" stroke="#2C1810" stroke-width="0.3"/>
                            <path d="M43,10 Q45,4 47,8 Q45,6 43,10" fill="#654321" stroke="#2C1810" stroke-width="0.3"/>
                            <!-- Îàà (Ï†ïÎ©¥ ÏùëÏãú) -->
                            <circle cx="48" cy="15" r="1.8" fill="white"/>
                            <circle cx="49" cy="15" r="1.2" fill="black"/>
                            <!-- ÏΩî -->
                            <ellipse cx="53" cy="17" rx="2.5" ry="2" fill="#654321"/>
                            <ellipse cx="54" cy="17" rx="1" ry="0.8" fill="#2C1810"/>
                            <!-- Í∞àÍ∏∞ -->
                            <path d="M20,18 Q22,12 24,14 Q26,12 28,16" fill="#654321" stroke="#2C1810" stroke-width="0.4"/>
                            <path d="M22,16 Q24,10 26,12 Q28,10 30,14" fill="#654321" stroke="#2C1810" stroke-width="0.4"/>
                            <!-- Íº¨Î¶¨ (ÎäòÏñ¥ÏßÑ) -->
                            <path d="M16,26 Q13,28 10,32 Q8,36 7,38" fill="none" stroke="#654321" stroke-width="1.5"/>
                            <path d="M16,27 Q12,30 9,34 Q7,37 6,40" fill="none" stroke="#654321" stroke-width="1.2"/>
                        </svg>`,
                        frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <!-- Îí∑Îã§Î¶¨ (Î™®Îëê ÎïÖ) -->
                            <path d="M36,28 L37,38 L35,40 L33,40 Z" fill="#654321"/>
                            <ellipse cx="34" cy="40" rx="2.5" ry="3" fill="#2C1810"/>
                            <path d="M30,28 L31,38 L29,40 L27,40 Z" fill="#654321"/>
                            <ellipse cx="28" cy="40" rx="2.5" ry="3" fill="#2C1810"/>
                            <!-- Î™∏ÌÜµ -->
                            <ellipse cx="28" cy="27" rx="12" ry="7" fill="#8B4513"/>
                            <!-- Î™© (ÏÇ¥Ïßù ÎÇÆÍ≤å) -->
                            <path d="M16,27 Q20,19 24,21 Q26,23 28,27" fill="#8B4513"/>
                            <!-- ÏïûÎã§Î¶¨ (Ïò§Î•∏Ï™Ω - ÎïÖÏúºÎ°ú ÎÇ¥Î¶º, Î∞úÍµ¨Î•¥Í∏∞ Ïøµ) -->
                            <path d="M22,27 L21,38 L19,40 L23,40 Z" fill="#654321"/>
                            <ellipse cx="20" cy="40" rx="2.5" ry="3" fill="#2C1810"/>
                            <!-- ÏïûÎã§Î¶¨ (ÏôºÏ™Ω - ÎïÖ) -->
                            <path d="M18,27 L17,38 L15,40 L19,40 Z" fill="#654321"/>
                            <ellipse cx="16" cy="40" rx="2.5" ry="3" fill="#2C1810"/>
                            <!-- Î®∏Î¶¨ (ÎÇÆÏùÄ ÏúÑÏπò - ÎÅÑÎçï) -->
                            <ellipse cx="46" cy="18" rx="8" ry="7" fill="#8B4513"/>
                            <ellipse cx="48" cy="16" rx="5" ry="4" fill="#A0522D"/>
                            <!-- Í∑Ä -->
                            <path d="M40,12 Q42,6 44,10 Q42,8 40,12" fill="#654321" stroke="#2C1810" stroke-width="0.3"/>
                            <path d="M43,12 Q45,6 47,10 Q45,8 43,12" fill="#654321" stroke="#2C1810" stroke-width="0.3"/>
                            <!-- Îàà -->
                            <circle cx="48" cy="17" r="1.8" fill="white"/>
                            <circle cx="49" cy="17" r="1.2" fill="black"/>
                            <!-- ÏΩî -->
                            <ellipse cx="53" cy="19" rx="2.5" ry="2" fill="#654321"/>
                            <ellipse cx="54" cy="19" rx="1" ry="0.8" fill="#2C1810"/>
                            <!-- Í∞àÍ∏∞ -->
                            <path d="M20,20 Q22,14 24,16 Q26,14 28,18" fill="#654321" stroke="#2C1810" stroke-width="0.4"/>
                            <path d="M22,18 Q24,12 26,14 Q28,12 30,16" fill="#654321" stroke="#2C1810" stroke-width="0.4"/>
                            <!-- Íº¨Î¶¨ (ÏÇ¥Ïßù ÌùîÎì§Î¶º) -->
                            <path d="M16,27 Q13,29 11,33 Q9,37 8,40" fill="none" stroke="#654321" stroke-width="1.5"/>
                            <path d="M16,28 Q14,30 12,34 Q10,38 10,42" fill="none" stroke="#654321" stroke-width="1.2"/>
                        </svg>`
                    },
                    // === Ïâ¨Îäî Î™®ÏÖò (rest) - ÏïâÏïÑÏÑú Ïâ¨Í∏∞ ===
                    rest: {
                        frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <!-- Îí∑Îã§Î¶¨ (Ï†ëÌûå ÏÉÅÌÉú) -->
                            <ellipse cx="32" cy="36" rx="6" ry="4" fill="#654321"/>
                            <ellipse cx="26" cy="38" rx="5" ry="3" fill="#654321"/>
                            <!-- Î™∏ÌÜµ (ÎÇÆÍ≤å) -->
                            <ellipse cx="28" cy="32" rx="14" ry="8" fill="#7a3d10"/>
                            <!-- Î™© (ÎÇÆÍ≤å) -->
                            <path d="M16,32 Q22,26 28,28 Q32,30 34,32" fill="#7a3d10"/>
                            <!-- ÏïûÎã§Î¶¨ (Ï†ëÌûå ÏÉÅÌÉú) -->
                            <ellipse cx="20" cy="38" rx="5" ry="3" fill="#5a3520"/>
                            <ellipse cx="14" cy="36" rx="4" ry="3" fill="#5a3520"/>
                            <!-- Î®∏Î¶¨ (ÎÇÆÍ≤å, Îàà Í∞êÏùÄ ÏÉÅÌÉú) -->
                            <ellipse cx="42" cy="24" rx="8" ry="7" fill="#7a3d10"/>
                            <ellipse cx="44" cy="22" rx="5" ry="4" fill="#8b5a2b"/>
                            <!-- Í∑Ä (ÎäòÏñ¥ÏßÑ) -->
                            <path d="M36,18 Q37,14 39,16" fill="#5a3520"/>
                            <path d="M39,18 Q40,14 42,16" fill="#5a3520"/>
                            <!-- Îàà (Í∞êÏùÄ ÏÉÅÌÉú) -->
                            <path d="M44,22 Q46,21 48,22" stroke="black" stroke-width="1.5" fill="none"/>
                            <!-- ÏΩî -->
                            <ellipse cx="49" cy="25" rx="2.5" ry="2" fill="#5a3520"/>
                            <!-- Í∞àÍ∏∞ (ÎäòÏñ¥ÏßÑ) -->
                            <path d="M22,26 Q24,22 26,24" fill="#5a3520"/>
                            <!-- Íº¨Î¶¨ (ÎäòÏñ¥ÏßÑ) -->
                            <path d="M16,32 Q12,34 10,38 Q8,40 8,42" fill="none" stroke="#5a3520" stroke-width="1.5"/>
                        </svg>`,
                        frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <!-- Îí∑Îã§Î¶¨ (Ï†ëÌûå ÏÉÅÌÉú) -->
                            <ellipse cx="32" cy="37" rx="6" ry="4" fill="#654321"/>
                            <ellipse cx="26" cy="39" rx="5" ry="3" fill="#654321"/>
                            <!-- Î™∏ÌÜµ (ÎÇÆÍ≤å, Ìò∏Ìù°) -->
                            <ellipse cx="28" cy="33" rx="14" ry="7" fill="#7a3d10"/>
                            <!-- Î™© (ÎÇÆÍ≤å) -->
                            <path d="M16,33 Q22,27 28,29 Q32,31 34,33" fill="#7a3d10"/>
                            <!-- ÏïûÎã§Î¶¨ (Ï†ëÌûå ÏÉÅÌÉú) -->
                            <ellipse cx="20" cy="39" rx="5" ry="3" fill="#5a3520"/>
                            <ellipse cx="14" cy="37" rx="4" ry="3" fill="#5a3520"/>
                            <!-- Î®∏Î¶¨ (ÎÇÆÍ≤å, Îàà Í∞êÏùÄ ÏÉÅÌÉú) -->
                            <ellipse cx="42" cy="25" rx="8" ry="7" fill="#7a3d10"/>
                            <ellipse cx="44" cy="23" rx="5" ry="4" fill="#8b5a2b"/>
                            <!-- Í∑Ä (ÎäòÏñ¥ÏßÑ) -->
                            <path d="M36,19 Q37,15 39,17" fill="#5a3520"/>
                            <path d="M39,19 Q40,15 42,17" fill="#5a3520"/>
                            <!-- Îàà (Í∞êÏùÄ ÏÉÅÌÉú) -->
                            <path d="M44,23 Q46,22 48,23" stroke="black" stroke-width="1.5" fill="none"/>
                            <!-- ÏΩî -->
                            <ellipse cx="49" cy="26" rx="2.5" ry="2" fill="#5a3520"/>
                            <!-- Í∞àÍ∏∞ (ÎäòÏñ¥ÏßÑ) -->
                            <path d="M22,27 Q24,23 26,25" fill="#5a3520"/>
                            <!-- Íº¨Î¶¨ (ÎäòÏñ¥ÏßÑ) -->
                            <path d="M16,33 Q12,35 10,39 Q8,41 8,43" fill="none" stroke="#5a3520" stroke-width="1.5"/>
                        </svg>`
                    },
                    // === Îã¨Î¶¨Í∏∞ Î™®ÏÖò (run) - Í∏∞Ï°¥ Ïú†ÏßÄ ===
                    run: {
                        frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <!-- Îí∑Îã§Î¶¨ (Ïò§Î•∏Ï™Ω Îí§ - Îì§Î¶º) -->
                            <path d="M38,28 L40,32 L38,34 L36,34 Z" fill="#654321"/>
                            <ellipse cx="37" cy="34" rx="2" ry="2.5" fill="#2C1810"/>
                            <!-- Îí∑Îã§Î¶¨ (ÏôºÏ™Ω Îí§ - ÎïÖ) -->
                            <path d="M32,28 L34,38 L32,40 L30,40 Z" fill="#654321"/>
                            <ellipse cx="31" cy="40" rx="2.5" ry="3" fill="#2C1810"/>
                            <!-- Î™∏ÌÜµ -->
                            <ellipse cx="28" cy="26" rx="12" ry="7" fill="#8B4513"/>
                            <!-- Î™© -->
                            <path d="M16,26 Q20,18 24,20 Q26,22 28,26" fill="#8B4513"/>
                            <!-- ÏïûÎã§Î¶¨ (Ïò§Î•∏Ï™Ω Ïïû - ÎïÖ) -->
                            <path d="M22,26 L20,38 L18,40 L22,40 Z" fill="#654321"/>
                            <ellipse cx="19" cy="40" rx="2.5" ry="3" fill="#2C1810"/>
                            <!-- ÏïûÎã§Î¶¨ (ÏôºÏ™Ω Ïïû - Îì§Î¶º) -->
                            <path d="M18,26 L16,32 L14,34 L18,34 Z" fill="#654321"/>
                            <ellipse cx="15" cy="34" rx="2" ry="2.5" fill="#2C1810"/>
                            <!-- Î®∏Î¶¨ -->
                            <ellipse cx="46" cy="18" rx="8" ry="7" fill="#8B4513"/>
                            <ellipse cx="48" cy="16" rx="5" ry="4" fill="#A0522D"/>
                            <!-- Í∑Ä (ÏôºÏ™Ω) -->
                            <path d="M40,12 Q42,6 44,10 Q42,8 40,12" fill="#654321" stroke="#2C1810" stroke-width="0.3"/>
                            <!-- Í∑Ä (Ïò§Î•∏Ï™Ω) -->
                            <path d="M43,12 Q45,6 47,10 Q45,8 43,12" fill="#654321" stroke="#2C1810" stroke-width="0.3"/>
                            <!-- Îàà -->
                            <circle cx="48" cy="17" r="1.8" fill="white"/>
                            <circle cx="48" cy="17" r="1.2" fill="black"/>
                            <!-- ÏΩî -->
                            <ellipse cx="53" cy="19" rx="2.5" ry="2" fill="#654321"/>
                            <ellipse cx="54" cy="19" rx="1" ry="0.8" fill="#2C1810"/>
                            <!-- Í∞àÍ∏∞ (Îçî ÌíçÏÑ±ÌïòÍ≤å) -->
                            <path d="M20,20 Q22,14 24,16 Q26,14 28,18 Q26,16 24,20" fill="#654321" stroke="#2C1810" stroke-width="0.4"/>
                            <path d="M22,18 Q24,12 26,14 Q28,12 30,16 Q28,14 26,18" fill="#654321" stroke="#2C1810" stroke-width="0.4"/>
                            <path d="M24,16 Q26,10 28,12 Q30,10 32,14 Q30,12 28,16" fill="#654321" stroke="#2C1810" stroke-width="0.4"/>
                            <!-- Íº¨Î¶¨ (Îçî ÏûêÏó∞Ïä§ÎüΩÍ≤å) -->
                            <path d="M16,26 Q12,22 8,18 Q4,14 2,10" fill="#654321" stroke="#2C1810" stroke-width="0.5"/>
                            <path d="M14,24 Q10,20 6,16 Q2,12 0,8" fill="#654321" stroke="#2C1810" stroke-width="0.5"/>
                        </svg>`,
                        frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <!-- Îí∑Îã§Î¶¨ (Ïò§Î•∏Ï™Ω Îí§ - ÎïÖ) -->
                            <path d="M38,28 L40,38 L38,40 L36,40 Z" fill="#654321"/>
                            <ellipse cx="37" cy="40" rx="2.5" ry="3" fill="#2C1810"/>
                            <!-- Îí∑Îã§Î¶¨ (ÏôºÏ™Ω Îí§ - Îì§Î¶º) -->
                            <path d="M32,28 L34,32 L32,34 L30,34 Z" fill="#654321"/>
                            <ellipse cx="31" cy="34" rx="2" ry="2.5" fill="#2C1810"/>
                            <!-- Î™∏ÌÜµ -->
                            <ellipse cx="28" cy="24" rx="12" ry="7" fill="#8B4513"/>
                            <!-- Î™© -->
                            <path d="M16,24 Q20,16 24,18 Q26,20 28,24" fill="#8B4513"/>
                            <!-- ÏïûÎã§Î¶¨ (Ïò§Î•∏Ï™Ω Ïïû - Îì§Î¶º) -->
                            <path d="M22,24 L20,30 L18,32 L22,32 Z" fill="#654321"/>
                            <ellipse cx="19" cy="32" rx="2" ry="2.5" fill="#2C1810"/>
                            <!-- ÏïûÎã§Î¶¨ (ÏôºÏ™Ω Ïïû - ÎïÖ) -->
                            <path d="M18,24 L16,38 L14,40 L18,40 Z" fill="#654321"/>
                            <ellipse cx="15" cy="40" rx="2.5" ry="3" fill="#2C1810"/>
                            <!-- Î®∏Î¶¨ -->
                            <ellipse cx="46" cy="16" rx="8" ry="7" fill="#8B4513"/>
                            <ellipse cx="48" cy="14" rx="5" ry="4" fill="#A0522D"/>
                            <!-- Í∑Ä (ÏôºÏ™Ω) -->
                            <path d="M40,10 Q42,4 44,8 Q42,6 40,10" fill="#654321" stroke="#2C1810" stroke-width="0.3"/>
                            <!-- Í∑Ä (Ïò§Î•∏Ï™Ω) -->
                            <path d="M43,10 Q45,4 47,8 Q45,6 43,10" fill="#654321" stroke="#2C1810" stroke-width="0.3"/>
                            <!-- Îàà -->
                            <circle cx="48" cy="15" r="1.8" fill="white"/>
                            <circle cx="48" cy="15" r="1.2" fill="black"/>
                            <!-- ÏΩî -->
                            <ellipse cx="53" cy="17" rx="2.5" ry="2" fill="#654321"/>
                            <ellipse cx="54" cy="17" rx="1" ry="0.8" fill="#2C1810"/>
                            <!-- Í∞àÍ∏∞ (Îçî ÌíçÏÑ±ÌïòÍ≤å) -->
                            <path d="M20,18 Q22,12 24,14 Q26,12 28,16 Q26,14 24,18" fill="#654321" stroke="#2C1810" stroke-width="0.4"/>
                            <path d="M22,16 Q24,10 26,12 Q28,10 30,14 Q28,12 26,16" fill="#654321" stroke="#2C1810" stroke-width="0.4"/>
                            <path d="M24,14 Q26,8 28,10 Q30,8 32,12 Q30,10 28,14" fill="#654321" stroke="#2C1810" stroke-width="0.4"/>
                            <!-- Íº¨Î¶¨ (Îçî ÏûêÏó∞Ïä§ÎüΩÍ≤å) -->
                            <path d="M16,24 Q12,20 8,16 Q4,12 2,8" fill="#654321" stroke="#2C1810" stroke-width="0.5"/>
                            <path d="M14,22 Q10,18 6,14 Q2,10 0,6" fill="#654321" stroke="#2C1810" stroke-width="0.5"/>
                        </svg>`
                    },
                    // === ÎèÑÏ∞© Î™®ÏÖò (finish) - Í∞êÏÜç, Ï≤úÏ≤úÌûà Í±∑Í∏∞ ===
                    finish: {
                        frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <!-- Îí∑Îã§Î¶¨ (ÏÇ¥ÏßùÎßå ÏõÄÏßÅÏûÑ) -->
                            <path d="M36,28 L37,37 L35,40 L33,40 Z" fill="#654321"/>
                            <ellipse cx="34" cy="40" rx="2.5" ry="3" fill="#2C1810"/>
                            <path d="M30,28 L31,38 L29,40 L27,40 Z" fill="#654321"/>
                            <ellipse cx="28" cy="40" rx="2.5" ry="3" fill="#2C1810"/>
                            <!-- Î™∏ÌÜµ -->
                            <ellipse cx="28" cy="26" rx="12" ry="7" fill="#8B4513"/>
                            <!-- Î™© (ÏïΩÍ∞Ñ ÎÜíÏù¥) -->
                            <path d="M16,26 Q20,18 24,20 Q26,22 28,26" fill="#8B4513"/>
                            <!-- ÏïûÎã§Î¶¨ (Ï≤úÏ≤úÌûà Í±∑Îäî ÏûêÏÑ∏) -->
                            <path d="M22,26 L21,37 L19,40 L23,40 Z" fill="#654321"/>
                            <ellipse cx="20" cy="40" rx="2.5" ry="3" fill="#2C1810"/>
                            <path d="M18,26 L16,36 L14,38 L18,38 Z" fill="#654321"/>
                            <ellipse cx="15" cy="38" rx="2.5" ry="3" fill="#2C1810"/>
                            <!-- Î®∏Î¶¨ (Ï†ïÎ©¥ ÏïΩÍ∞Ñ ÏúÑ) -->
                            <ellipse cx="46" cy="17" rx="8" ry="7" fill="#8B4513"/>
                            <ellipse cx="48" cy="15" rx="5" ry="4" fill="#A0522D"/>
                            <!-- Í∑Ä -->
                            <path d="M40,11 Q42,5 44,9 Q42,7 40,11" fill="#654321" stroke="#2C1810" stroke-width="0.3"/>
                            <path d="M43,11 Q45,5 47,9 Q45,7 43,11" fill="#654321" stroke="#2C1810" stroke-width="0.3"/>
                            <!-- Îàà (Ìé∏ÏïàÌïú ÌëúÏ†ï) -->
                            <circle cx="48" cy="16" r="1.8" fill="white"/>
                            <circle cx="48.5" cy="16" r="1.2" fill="black"/>
                            <!-- ÏΩî -->
                            <ellipse cx="53" cy="18" rx="2.5" ry="2" fill="#654321"/>
                            <ellipse cx="54" cy="18" rx="1" ry="0.8" fill="#2C1810"/>
                            <!-- Í∞àÍ∏∞ (ÏÇ¥Ïßù ÌùîÎì§Î¶º) -->
                            <path d="M20,19 Q22,13 24,15 Q26,13 28,17" fill="#654321" stroke="#2C1810" stroke-width="0.4"/>
                            <path d="M22,17 Q24,11 26,13 Q28,11 30,15" fill="#654321" stroke="#2C1810" stroke-width="0.4"/>
                            <!-- Íº¨Î¶¨ (ÏûêÏó∞Ïä§ÎüΩÍ≤å ÎäòÏñ¥Ïßê) -->
                            <path d="M16,26 Q13,28 10,30 Q8,34 7,38" fill="none" stroke="#654321" stroke-width="1.5"/>
                            <path d="M16,27 Q12,30 9,33 Q7,36 6,40" fill="none" stroke="#654321" stroke-width="1.2"/>
                        </svg>`,
                        frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <!-- Îí∑Îã§Î¶¨ -->
                            <path d="M36,28 L37,38 L35,40 L33,40 Z" fill="#654321"/>
                            <ellipse cx="34" cy="40" rx="2.5" ry="3" fill="#2C1810"/>
                            <path d="M30,28 L31,36 L29,38 L27,38 Z" fill="#654321"/>
                            <ellipse cx="28" cy="38" rx="2.5" ry="3" fill="#2C1810"/>
                            <!-- Î™∏ÌÜµ -->
                            <ellipse cx="28" cy="27" rx="12" ry="7" fill="#8B4513"/>
                            <!-- Î™© -->
                            <path d="M16,27 Q20,19 24,21 Q26,23 28,27" fill="#8B4513"/>
                            <!-- ÏïûÎã§Î¶¨ -->
                            <path d="M22,27 L21,38 L19,40 L23,40 Z" fill="#654321"/>
                            <ellipse cx="20" cy="40" rx="2.5" ry="3" fill="#2C1810"/>
                            <path d="M18,27 L16,37 L14,40 L18,40 Z" fill="#654321"/>
                            <ellipse cx="15" cy="40" rx="2.5" ry="3" fill="#2C1810"/>
                            <!-- Î®∏Î¶¨ -->
                            <ellipse cx="46" cy="18" rx="8" ry="7" fill="#8B4513"/>
                            <ellipse cx="48" cy="16" rx="5" ry="4" fill="#A0522D"/>
                            <!-- Í∑Ä -->
                            <path d="M40,12 Q42,6 44,10 Q42,8 40,12" fill="#654321" stroke="#2C1810" stroke-width="0.3"/>
                            <path d="M43,12 Q45,6 47,10 Q45,8 43,12" fill="#654321" stroke="#2C1810" stroke-width="0.3"/>
                            <!-- Îàà -->
                            <circle cx="48" cy="17" r="1.8" fill="white"/>
                            <circle cx="48.5" cy="17" r="1.2" fill="black"/>
                            <!-- ÏΩî -->
                            <ellipse cx="53" cy="19" rx="2.5" ry="2" fill="#654321"/>
                            <ellipse cx="54" cy="19" rx="1" ry="0.8" fill="#2C1810"/>
                            <!-- Í∞àÍ∏∞ -->
                            <path d="M20,20 Q22,14 24,16 Q26,14 28,18" fill="#654321" stroke="#2C1810" stroke-width="0.4"/>
                            <path d="M22,18 Q24,12 26,14 Q28,12 30,16" fill="#654321" stroke="#2C1810" stroke-width="0.4"/>
                            <!-- Íº¨Î¶¨ -->
                            <path d="M16,27 Q13,29 10,32 Q8,36 7,40" fill="none" stroke="#654321" stroke-width="1.5"/>
                            <path d="M16,28 Q12,31 9,35 Q7,38 6,42" fill="none" stroke="#654321" stroke-width="1.2"/>
                        </svg>`
                    },
                    // === ÏäπÎ¶¨ Î™®ÏÖò (victory) - ÏïûÎ∞ú Îì§Í≥† ÌûàÌûù! + ÏôïÍ¥Ä ===
                    victory: {
                        frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <!-- Îí∑Îã§Î¶¨ (ÎïÖÏóê Î≤ÑÌã∞Í∏∞) -->
                            <path d="M36,30 L38,38 L36,40 L34,40 Z" fill="#654321"/>
                            <ellipse cx="35" cy="40" rx="2.5" ry="3" fill="#2C1810"/>
                            <path d="M30,30 L32,38 L30,40 L28,40 Z" fill="#654321"/>
                            <ellipse cx="29" cy="40" rx="2.5" ry="3" fill="#2C1810"/>
                            <!-- Î™∏ÌÜµ (Îí§Î°ú Í∏∞Ïö∏Ïñ¥Ïßê) -->
                            <ellipse cx="30" cy="26" rx="12" ry="7" fill="#8B4513" transform="rotate(-15,30,26)"/>
                            <!-- Î™© (ÎÜíÏù¥ Îì§Ïñ¥Ïò¨Î¶º) -->
                            <path d="M22,22 Q24,12 28,14 Q30,16 32,22" fill="#8B4513"/>
                            <!-- ÏïûÎã§Î¶¨ (Îì§Ïñ¥Ïò¨Î¶º! ÌûàÌûù!) -->
                            <path d="M26,20 L22,14 L20,12 L24,14 Z" fill="#654321"/>
                            <ellipse cx="21" cy="12" rx="2" ry="2.5" fill="#2C1810"/>
                            <path d="M24,22 L18,16 L16,14 L20,16 Z" fill="#654321"/>
                            <ellipse cx="17" cy="14" rx="2" ry="2.5" fill="#2C1810"/>
                            <!-- Î®∏Î¶¨ (ÏúÑÎ°ú Îì§Ïñ¥Ïò¨Î¶º) -->
                            <ellipse cx="44" cy="10" rx="8" ry="6" fill="#8B4513"/>
                            <ellipse cx="46" cy="8" rx="5" ry="4" fill="#A0522D"/>
                            <!-- Í∑Ä (Ï´ëÍ∏ã) -->
                            <path d="M38,4 Q40,-2 42,2 Q40,0 38,4" fill="#654321" stroke="#2C1810" stroke-width="0.3"/>
                            <path d="M41,4 Q43,-2 45,2 Q43,0 41,4" fill="#654321" stroke="#2C1810" stroke-width="0.3"/>
                            <!-- Îàà (Î∞òÏßù) -->
                            <circle cx="46" cy="9" r="2" fill="white"/>
                            <circle cx="46.5" cy="9" r="1.3" fill="black"/>
                            <circle cx="47" cy="8" r="0.5" fill="white"/>
                            <!-- ÏΩî (Î≤åÎ¶Ñ) -->
                            <ellipse cx="51" cy="11" rx="2.5" ry="2" fill="#654321"/>
                            <ellipse cx="52" cy="11" rx="1.2" ry="1" fill="#2C1810"/>
                            <!-- ÏûÖ (ÌûàÌûù! Î≤åÎ¶¨Í∏∞) -->
                            <path d="M50,13 Q52,15 54,13" fill="none" stroke="#2C1810" stroke-width="0.5"/>
                            <!-- ÏôïÍ¥Ä -->
                            <polygon points="40,2 42,-3 44,1 46,-3 48,2" fill="#FFD700" stroke="#DAA520" stroke-width="0.4"/>
                            <circle cx="42" cy="-2" r="0.8" fill="#FF6347"/>
                            <circle cx="46" cy="-2" r="0.8" fill="#4169E1"/>
                            <!-- Í∞àÍ∏∞ (ÎÇ†Î¶¨Îäî Ï§ë) -->
                            <path d="M24,14 Q26,8 28,10 Q30,8 32,12" fill="#654321" stroke="#2C1810" stroke-width="0.4"/>
                            <path d="M26,12 Q28,6 30,8 Q32,6 34,10" fill="#654321" stroke="#2C1810" stroke-width="0.4"/>
                            <!-- Íº¨Î¶¨ (ÏúÑÎ°ú ÏπòÏºúÏò¨Î¶º) -->
                            <path d="M18,26 Q14,22 10,18 Q6,14 4,10" fill="none" stroke="#654321" stroke-width="1.5"/>
                            <path d="M18,24 Q14,20 10,16 Q6,12 2,8" fill="none" stroke="#654321" stroke-width="1.2"/>
                            <!-- Î∞òÏßùÏù¥ Ïù¥ÌéôÌä∏ -->
                            <text x="8" y="8" font-size="5" fill="#FFD700">‚ú¶</text>
                            <text x="52" y="4" font-size="4" fill="#FFD700">‚ú¶</text>
                        </svg>`,
                        frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <!-- Îí∑Îã§Î¶¨ (ÎïÖÏóê Î≤ÑÌã∞Í∏∞) -->
                            <path d="M36,30 L38,38 L36,40 L34,40 Z" fill="#654321"/>
                            <ellipse cx="35" cy="40" rx="2.5" ry="3" fill="#2C1810"/>
                            <path d="M30,30 L32,38 L30,40 L28,40 Z" fill="#654321"/>
                            <ellipse cx="29" cy="40" rx="2.5" ry="3" fill="#2C1810"/>
                            <!-- Î™∏ÌÜµ -->
                            <ellipse cx="30" cy="27" rx="12" ry="7" fill="#8B4513" transform="rotate(-12,30,27)"/>
                            <!-- Î™© -->
                            <path d="M22,23 Q24,14 28,16 Q30,18 32,23" fill="#8B4513"/>
                            <!-- ÏïûÎã§Î¶¨ (Îçî ÎÜíÏù¥!) -->
                            <path d="M26,20 L21,12 L19,10 L23,12 Z" fill="#654321"/>
                            <ellipse cx="20" cy="10" rx="2" ry="2.5" fill="#2C1810"/>
                            <path d="M24,22 L17,14 L15,12 L19,14 Z" fill="#654321"/>
                            <ellipse cx="16" cy="12" rx="2" ry="2.5" fill="#2C1810"/>
                            <!-- Î®∏Î¶¨ (Îçî ÏúÑÎ°ú) -->
                            <ellipse cx="44" cy="8" rx="8" ry="6" fill="#8B4513"/>
                            <ellipse cx="46" cy="6" rx="5" ry="4" fill="#A0522D"/>
                            <!-- Í∑Ä -->
                            <path d="M38,2 Q40,-4 42,0 Q40,-2 38,2" fill="#654321" stroke="#2C1810" stroke-width="0.3"/>
                            <path d="M41,2 Q43,-4 45,0 Q43,-2 41,2" fill="#654321" stroke="#2C1810" stroke-width="0.3"/>
                            <!-- Îàà (ÏúôÌÅ¨) -->
                            <circle cx="46" cy="7" r="2" fill="white"/>
                            <circle cx="46.5" cy="7" r="1.3" fill="black"/>
                            <circle cx="47" cy="6" r="0.5" fill="white"/>
                            <!-- ÏΩî -->
                            <ellipse cx="51" cy="9" rx="2.5" ry="2" fill="#654321"/>
                            <ellipse cx="52" cy="9" rx="1.2" ry="1" fill="#2C1810"/>
                            <!-- ÏûÖ -->
                            <path d="M50,11 Q52,14 54,11" fill="none" stroke="#2C1810" stroke-width="0.5"/>
                            <!-- ÏôïÍ¥Ä (ÏÇ¥Ïßù ÌùîÎì§Î¶º) -->
                            <polygon points="39,0 41,-5 43,-1 45,-5 47,0" fill="#FFD700" stroke="#DAA520" stroke-width="0.4"/>
                            <circle cx="41" cy="-4" r="0.8" fill="#FF6347"/>
                            <circle cx="45" cy="-4" r="0.8" fill="#4169E1"/>
                            <!-- Í∞àÍ∏∞ -->
                            <path d="M24,16 Q26,10 28,12 Q30,10 32,14" fill="#654321" stroke="#2C1810" stroke-width="0.4"/>
                            <path d="M26,14 Q28,8 30,10 Q32,8 34,12" fill="#654321" stroke="#2C1810" stroke-width="0.4"/>
                            <!-- Íº¨Î¶¨ -->
                            <path d="M18,27 Q14,23 10,19 Q6,15 3,11" fill="none" stroke="#654321" stroke-width="1.5"/>
                            <path d="M18,25 Q14,21 10,17 Q6,13 1,9" fill="none" stroke="#654321" stroke-width="1.2"/>
                            <!-- Î∞òÏßùÏù¥ Ïù¥ÌéôÌä∏ (ÏúÑÏπò Î≥ÄÍ≤Ω) -->
                            <text x="5" y="12" font-size="4" fill="#FFD700">‚ú¶</text>
                            <text x="54" y="2" font-size="5" fill="#FFD700">‚ú¶</text>
                            <text x="30" y="5" font-size="3" fill="#FFD700">‚ú¶</text>
                        </svg>`
                    },
                    // === Íº¥Îì± ÏÇ¨Îßù Î™®ÏÖò (dead) - ÎπÑÏÑù + XÎàà ===
                    dead: {
                        frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <!-- ÎπÑÏÑù -->
                            <rect x="20" y="10" width="24" height="28" rx="4" ry="4" fill="#808080" stroke="#666" stroke-width="0.5"/>
                            <rect x="20" y="34" width="28" height="6" rx="1" fill="#696969"/>
                            <!-- ÎπÑÏÑù Í∏à -->
                            <line x1="28" y1="14" x2="36" y2="32" stroke="#999" stroke-width="0.3"/>
                            <!-- R.I.P ÌÖçÏä§Ìä∏ -->
                            <text x="32" y="22" text-anchor="middle" font-size="6" fill="#333" font-weight="bold">R.I.P</text>
                            <!-- Îßê Ïú†Î†π (Î∞òÌà¨Î™Ö) -->
                            <g opacity="0.4">
                                <ellipse cx="38" cy="6" rx="5" ry="4" fill="#8B4513"/>
                                <!-- X Îàà -->
                                <line x1="36" y1="4" x2="38" y2="6" stroke="#333" stroke-width="0.8"/>
                                <line x1="38" y1="4" x2="36" y2="6" stroke="#333" stroke-width="0.8"/>
                                <line x1="39" y1="4" x2="41" y2="6" stroke="#333" stroke-width="0.8"/>
                                <line x1="41" y1="4" x2="39" y2="6" stroke="#333" stroke-width="0.8"/>
                                <!-- ÌòÄ -->
                                <path d="M42,7 Q43,9 42,10" fill="#FF69B4" stroke="none"/>
                            </g>
                            <!-- ÌíÄ -->
                            <path d="M16,40 Q17,36 18,40" fill="none" stroke="#2d5a1e" stroke-width="0.8"/>
                            <path d="M44,38 Q45,34 46,38" fill="none" stroke="#2d5a1e" stroke-width="0.8"/>
                            <path d="M48,39 Q49,35 50,39" fill="none" stroke="#2d5a1e" stroke-width="0.8"/>
                        </svg>`,
                        frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                            <!-- ÎπÑÏÑù -->
                            <rect x="20" y="10" width="24" height="28" rx="4" ry="4" fill="#808080" stroke="#666" stroke-width="0.5"/>
                            <rect x="20" y="34" width="28" height="6" rx="1" fill="#696969"/>
                            <line x1="28" y1="14" x2="36" y2="32" stroke="#999" stroke-width="0.3"/>
                            <text x="32" y="22" text-anchor="middle" font-size="6" fill="#333" font-weight="bold">R.I.P</text>
                            <!-- Îßê Ïú†Î†π (Ïò¨ÎùºÍ∞ÄÎäî Ï§ë) -->
                            <g opacity="0.3">
                                <ellipse cx="38" cy="3" rx="5" ry="4" fill="#8B4513"/>
                                <line x1="36" y1="1" x2="38" y2="3" stroke="#333" stroke-width="0.8"/>
                                <line x1="38" y1="1" x2="36" y2="3" stroke="#333" stroke-width="0.8"/>
                                <line x1="39" y1="1" x2="41" y2="3" stroke="#333" stroke-width="0.8"/>
                                <line x1="41" y1="1" x2="39" y2="3" stroke="#333" stroke-width="0.8"/>
                                <path d="M42,4 Q43,6 42,7" fill="#FF69B4" stroke="none"/>
                            </g>
                            <!-- ÌíÄ -->
                            <path d="M16,40 Q17,36 18,40" fill="none" stroke="#2d5a1e" stroke-width="0.8"/>
                            <path d="M44,38 Q45,34 46,38" fill="none" stroke="#2d5a1e" stroke-width="0.8"/>
                            <path d="M48,39 Q49,35 50,39" fill="none" stroke="#2d5a1e" stroke-width="0.8"/>
                        </svg>`
                    },
                    // ÌïòÏúÑÌò∏Ìôò: frame1/frame2 ÏßÅÏ†ë Ï†ëÍ∑º Ïãú run Î™®ÏÖò ÏÇ¨Ïö©
                    get frame1() { return this.run.frame1; },
                    get frame2() { return this.run.frame2; }
                }
            };
            
            return svgMap[vehicleId] || svgMap['car'];
        }
        
        // Ìä∏Îûô Ïò§Î∏åÏ†ùÌä∏ SVG ÏÉùÏÑ± Ìï®Ïàò
        function getTrackObjectSVG(objectId) {
            const objects = {
                // ===== Í≤ΩÏ£ºÏû• ÏãúÏÑ§Î¨º =====
                'start-gate': `<svg viewBox="0 0 80 75" width="80" height="75">
                    <!-- Ï¢åÏ∏° Í∏∞Îë• -->
                    <rect x="2" y="5" width="6" height="65" fill="#555" stroke="#333" stroke-width="0.5"/>
                    <rect x="0" y="65" width="10" height="10" rx="1" fill="#444"/>
                    <!-- Ïö∞Ï∏° Í∏∞Îë• -->
                    <rect x="72" y="5" width="6" height="65" fill="#555" stroke="#333" stroke-width="0.5"/>
                    <rect x="70" y="65" width="10" height="10" rx="1" fill="#444"/>
                    <!-- ÏÉÅÎã® Î∞î -->
                    <rect x="2" y="3" width="76" height="6" rx="1" fill="#666" stroke="#444" stroke-width="0.5"/>
                    <!-- Í≤åÏù¥Ìä∏ Ïπ∏ÎßâÏù¥ -->
                    <rect x="10" y="9" width="15" height="56" fill="none" stroke="#888" stroke-width="0.8"/>
                    <rect x="25" y="9" width="15" height="56" fill="none" stroke="#888" stroke-width="0.8"/>
                    <rect x="40" y="9" width="15" height="56" fill="none" stroke="#888" stroke-width="0.8"/>
                    <rect x="55" y="9" width="15" height="56" fill="none" stroke="#888" stroke-width="0.8"/>
                    <!-- Î≤àÌò∏ -->
                    <text x="17" y="20" text-anchor="middle" font-size="7" fill="#ddd" font-weight="bold">1</text>
                    <text x="32" y="20" text-anchor="middle" font-size="7" fill="#ddd" font-weight="bold">2</text>
                    <text x="47" y="20" text-anchor="middle" font-size="7" fill="#ddd" font-weight="bold">3</text>
                    <text x="62" y="20" text-anchor="middle" font-size="7" fill="#ddd" font-weight="bold">4</text>
                    <!-- Î¶¨Î≤≥ -->
                    <circle cx="5" cy="10" r="1.5" fill="#777"/>
                    <circle cx="5" cy="60" r="1.5" fill="#777"/>
                    <circle cx="75" cy="10" r="1.5" fill="#777"/>
                    <circle cx="75" cy="60" r="1.5" fill="#777"/>
                </svg>`,

                'fence': `<svg viewBox="0 0 60 12" width="60" height="12">
                    <!-- Í∞ÄÎ°ú Î†àÏùº -->
                    <rect x="0" y="2" width="60" height="2.5" rx="0.5" fill="#8B7355"/>
                    <rect x="0" y="7" width="60" height="2.5" rx="0.5" fill="#8B7355"/>
                    <!-- ÏÑ∏Î°ú Í∏∞Îë• -->
                    <rect x="2" y="0" width="3" height="12" rx="0.5" fill="#6B5340" stroke="#5a4535" stroke-width="0.3"/>
                    <rect x="17" y="0" width="3" height="12" rx="0.5" fill="#6B5340" stroke="#5a4535" stroke-width="0.3"/>
                    <rect x="32" y="0" width="3" height="12" rx="0.5" fill="#6B5340" stroke="#5a4535" stroke-width="0.3"/>
                    <rect x="47" y="0" width="3" height="12" rx="0.5" fill="#6B5340" stroke="#5a4535" stroke-width="0.3"/>
                    <!-- Í∏∞Îë• Íº≠ÎåÄÍ∏∞ -->
                    <circle cx="3.5" cy="1" r="2" fill="#7B6350"/>
                    <circle cx="18.5" cy="1" r="2" fill="#7B6350"/>
                    <circle cx="33.5" cy="1" r="2" fill="#7B6350"/>
                    <circle cx="48.5" cy="1" r="2" fill="#7B6350"/>
                </svg>`,

                'grandstand': `<svg viewBox="0 0 120 60" width="120" height="60">
                    <!-- Í¥ÄÏ§ëÏÑù Í≥ÑÎã® -->
                    <rect x="5" y="35" width="110" height="10" fill="#A0522D"/>
                    <rect x="10" y="25" width="100" height="10" fill="#8B4513"/>
                    <rect x="15" y="15" width="90" height="10" fill="#6B3410"/>
                    <!-- Í¥ÄÏ§ë Ïã§Î£®Ïó£ (Îí∑Ï§Ñ) -->
                    <circle cx="25" cy="12" r="3" fill="#444"/>
                    <circle cx="35" cy="11" r="3" fill="#555"/>
                    <circle cx="50" cy="12" r="3" fill="#444"/>
                    <circle cx="65" cy="11" r="3" fill="#555"/>
                    <circle cx="80" cy="12" r="3" fill="#444"/>
                    <circle cx="95" cy="11" r="3" fill="#555"/>
                    <!-- Í¥ÄÏ§ë Ïã§Î£®Ïó£ (Ï§ëÍ∞ÑÏ§Ñ) -->
                    <circle cx="20" cy="22" r="3" fill="#555"/>
                    <circle cx="33" cy="23" r="3.5" fill="#666"/>
                    <circle cx="48" cy="22" r="3" fill="#555"/>
                    <circle cx="62" cy="23" r="3.5" fill="#666"/>
                    <circle cx="77" cy="22" r="3" fill="#555"/>
                    <circle cx="92" cy="23" r="3.5" fill="#666"/>
                    <circle cx="105" cy="22" r="3" fill="#555"/>
                    <!-- Í¥ÄÏ§ë Ïã§Î£®Ïó£ (ÏïûÏ§Ñ) -->
                    <circle cx="15" cy="33" r="3.5" fill="#666"/>
                    <circle cx="30" cy="32" r="3.5" fill="#777"/>
                    <circle cx="45" cy="33" r="3.5" fill="#666"/>
                    <circle cx="60" cy="32" r="4" fill="#777"/>
                    <circle cx="75" cy="33" r="3.5" fill="#666"/>
                    <circle cx="90" cy="32" r="3.5" fill="#777"/>
                    <circle cx="105" cy="33" r="3.5" fill="#666"/>
                    <!-- ÍπÉÎ∞ú -->
                    <line x1="40" y1="5" x2="40" y2="15" stroke="#666" stroke-width="0.8"/>
                    <polygon points="40,5 50,8 40,11" fill="#e74c3c"/>
                    <line x1="80" y1="5" x2="80" y2="15" stroke="#666" stroke-width="0.8"/>
                    <polygon points="80,5 90,8 80,11" fill="#3498db"/>
                    <!-- ÏßÄÎ∂ï -->
                    <rect x="3" y="45" width="114" height="4" fill="#5a3a1a"/>
                    <rect x="0" y="49" width="120" height="11" fill="#4a2a0a"/>
                </svg>`,

                // ===== Ïû•Ïï†Î¨º =====
                'rock': `<svg viewBox="0 0 30 25" width="30" height="25">
                    <!-- ÌÅ∞ Î∞îÏúÑ -->
                    <path d="M5,22 Q2,18 4,14 Q6,10 10,8 Q14,6 18,7 Q22,6 25,9 Q28,12 27,17 Q26,22 22,24 Q15,25 8,24 Z" fill="#808080" stroke="#666" stroke-width="0.5"/>
                    <!-- ÌïòÏù¥ÎùºÏù¥Ìä∏ -->
                    <path d="M10,10 Q13,8 16,9 Q18,8 20,10" fill="none" stroke="#999" stroke-width="0.5"/>
                    <!-- Í∑∏Î¶ºÏûê -->
                    <ellipse cx="15" cy="24" rx="10" ry="2" fill="rgba(0,0,0,0.15)"/>
                    <!-- ÏûëÏùÄ Î∞îÏúÑ -->
                    <path d="M22,20 Q24,18 26,19 Q27,21 25,22 Q23,22 22,20 Z" fill="#707070"/>
                    <!-- Í∏à -->
                    <line x1="12" y1="12" x2="16" y2="18" stroke="#6a6a6a" stroke-width="0.3"/>
                    <line x1="18" y1="10" x2="20" y2="16" stroke="#6a6a6a" stroke-width="0.3"/>
                </svg>`,

                'puddle': `<svg viewBox="0 0 35 15" width="35" height="15">
                    <!-- Î¨ºÏõÖÎç©Ïù¥ Î≥∏Ï≤¥ -->
                    <ellipse cx="17" cy="9" rx="15" ry="5" fill="#4a90d9" opacity="0.7"/>
                    <ellipse cx="17" cy="9" rx="13" ry="4" fill="#5ba3ec" opacity="0.6"/>
                    <!-- Î∞òÏÇ¨Í¥ë -->
                    <ellipse cx="12" cy="7" rx="4" ry="1.5" fill="white" opacity="0.3"/>
                    <ellipse cx="22" cy="8" rx="2" ry="1" fill="white" opacity="0.2"/>
                    <!-- Î¨ºÍ≤∞ -->
                    <path d="M8,9 Q11,7 14,9 Q17,11 20,9 Q23,7 26,9" fill="none" stroke="white" stroke-width="0.4" opacity="0.4"/>
                    <!-- Î¨ºÎ∞©Ïö∏ ÌäÄÍπÄ -->
                    <circle cx="6" cy="5" r="1" fill="#5ba3ec" opacity="0.5"/>
                    <circle cx="28" cy="6" r="0.8" fill="#5ba3ec" opacity="0.4"/>
                </svg>`,

                'hurdle': `<svg viewBox="0 0 25 30" width="25" height="30">
                    <!-- Ï¢åÏ∏° Í∏∞Îë• -->
                    <rect x="2" y="5" width="3" height="25" fill="#ddd" stroke="#bbb" stroke-width="0.3"/>
                    <!-- Ïö∞Ï∏° Í∏∞Îë• -->
                    <rect x="20" y="5" width="3" height="25" fill="#ddd" stroke="#bbb" stroke-width="0.3"/>
                    <!-- ÌóàÎì§ Î∞î (Îπ®Í∞Ñ/Ìù∞ Ï§ÑÎ¨¥Îä¨) -->
                    <rect x="1" y="8" width="23" height="4" fill="#e74c3c"/>
                    <rect x="1" y="8" width="5" height="4" fill="white"/>
                    <rect x="11" y="8" width="5" height="4" fill="white"/>
                    <rect x="1" y="16" width="23" height="3" fill="#e74c3c"/>
                    <rect x="6" y="16" width="5" height="3" fill="white"/>
                    <rect x="16" y="16" width="5" height="3" fill="white"/>
                    <!-- Í∏∞Îë• Íº≠ÎåÄÍ∏∞ -->
                    <circle cx="3.5" cy="5" r="2" fill="#eee" stroke="#ccc" stroke-width="0.3"/>
                    <circle cx="21.5" cy="5" r="2" fill="#eee" stroke="#ccc" stroke-width="0.3"/>
                    <!-- Í∑∏Î¶ºÏûê -->
                    <ellipse cx="12.5" cy="29" rx="10" ry="1.5" fill="rgba(0,0,0,0.1)"/>
                </svg>`,

                // ===== Î∂ÄÏä§Ìä∏ ÏïÑÏù¥ÌÖú =====
                'carrot': `<svg viewBox="0 0 20 30" width="20" height="30">
                    <!-- ÎãπÍ∑º Î≥∏Ï≤¥ -->
                    <path d="M10,5 Q13,10 12,18 Q11,24 10,28 Q9,24 8,18 Q7,10 10,5 Z" fill="#FF6B2B" stroke="#E55B1B" stroke-width="0.3"/>
                    <!-- ÎãπÍ∑º Ï§ÑÎ¨¥Îä¨ -->
                    <line x1="8.5" y1="12" x2="11.5" y2="12" stroke="#E55B1B" stroke-width="0.4"/>
                    <line x1="8.8" y1="16" x2="11.2" y2="16" stroke="#E55B1B" stroke-width="0.4"/>
                    <line x1="9.2" y1="20" x2="10.8" y2="20" stroke="#E55B1B" stroke-width="0.3"/>
                    <!-- ÏûéÏÇ¨Í∑Ä -->
                    <path d="M10,5 Q7,1 5,0" fill="none" stroke="#2ecc71" stroke-width="1.2"/>
                    <path d="M10,5 Q10,0 10,-1" fill="none" stroke="#27ae60" stroke-width="1"/>
                    <path d="M10,5 Q13,1 15,0" fill="none" stroke="#2ecc71" stroke-width="1.2"/>
                    <!-- ÌïòÏù¥ÎùºÏù¥Ìä∏ -->
                    <path d="M9,8 Q9.5,12 9.5,16" fill="none" stroke="#FF8C4B" stroke-width="0.5"/>
                    <!-- Î∞òÏßùÏù¥ -->
                    <circle cx="6" cy="8" r="0.8" fill="#FFD700" opacity="0.8"/>
                    <circle cx="14" cy="12" r="0.6" fill="#FFD700" opacity="0.6"/>
                </svg>`,

                'star': `<svg viewBox="0 0 25 25" width="25" height="25">
                    <!-- Î≥Ñ Î≥∏Ï≤¥ -->
                    <polygon points="12.5,1 15.5,8.5 23.5,9.5 17.5,15 19,23 12.5,19 6,23 7.5,15 1.5,9.5 9.5,8.5" fill="#FFD700" stroke="#DAA520" stroke-width="0.4"/>
                    <!-- ÌïòÏù¥ÎùºÏù¥Ìä∏ -->
                    <polygon points="12.5,4 14,9 12.5,7.5 11,9" fill="#FFE44D" opacity="0.6"/>
                    <!-- Î∞òÏßùÏù¥ Ïù¥ÌéôÌä∏ -->
                    <line x1="12.5" y1="0" x2="12.5" y2="2" stroke="#FFF" stroke-width="0.5" opacity="0.7"/>
                    <line x1="24" y1="12.5" x2="22" y2="12.5" stroke="#FFF" stroke-width="0.5" opacity="0.7"/>
                    <line x1="1" y1="12.5" x2="3" y2="12.5" stroke="#FFF" stroke-width="0.5" opacity="0.7"/>
                </svg>`,

                'horseshoe': `<svg viewBox="0 0 25 25" width="25" height="25">
                    <!-- ÎßêÎ∞úÍµΩ UÏûê -->
                    <path d="M5,4 Q5,16 7,20 Q9,24 12.5,24 Q16,24 18,20 Q20,16 20,4" fill="none" stroke="#DAA520" stroke-width="3" stroke-linecap="round"/>
                    <!-- ÏïàÏ™Ω ÌïòÏù¥ÎùºÏù¥Ìä∏ -->
                    <path d="M7,5 Q7,15 9,19 Q10,22 12.5,22 Q15,22 16,19 Q18,15 18,5" fill="none" stroke="#FFD700" stroke-width="1.5" stroke-linecap="round"/>
                    <!-- Î™ª Íµ¨Î©ç -->
                    <circle cx="6" cy="7" r="1" fill="#B8860B"/>
                    <circle cx="6" cy="13" r="1" fill="#B8860B"/>
                    <circle cx="19" cy="7" r="1" fill="#B8860B"/>
                    <circle cx="19" cy="13" r="1" fill="#B8860B"/>
                    <!-- Î∞òÏßùÏù¥ -->
                    <circle cx="10" cy="10" r="0.6" fill="white" opacity="0.5"/>
                    <circle cx="15" cy="8" r="0.5" fill="white" opacity="0.4"/>
                </svg>`,

                // ===== Î∞∞Í≤Ω Ïû•Ïãù =====
                'tree': `<svg viewBox="0 0 30 50" width="30" height="50">
                    <!-- ÎÇòÎ¨¥ Ï§ÑÍ∏∞ -->
                    <rect x="12" y="30" width="6" height="18" fill="#8B6914" stroke="#6B4914" stroke-width="0.3"/>
                    <!-- ÎøåÎ¶¨ -->
                    <path d="M12,48 Q10,50 8,50" fill="none" stroke="#6B4914" stroke-width="1"/>
                    <path d="M18,48 Q20,50 22,50" fill="none" stroke="#6B4914" stroke-width="1"/>
                    <!-- ÎÇòÎ≠áÏûé (3Îã®Í≥Ñ) -->
                    <ellipse cx="15" cy="28" rx="12" ry="8" fill="#27ae60"/>
                    <ellipse cx="15" cy="20" rx="10" ry="7" fill="#2ecc71"/>
                    <ellipse cx="15" cy="13" rx="7" ry="6" fill="#3ddc84"/>
                    <!-- ÌïòÏù¥ÎùºÏù¥Ìä∏ -->
                    <ellipse cx="12" cy="16" rx="3" ry="2" fill="#4deca4" opacity="0.5"/>
                    <ellipse cx="18" cy="24" rx="3" ry="2" fill="#4deca4" opacity="0.4"/>
                </svg>`,

                'flower': `<svg viewBox="0 0 15 20" width="15" height="20">
                    <!-- Ï§ÑÍ∏∞ -->
                    <path d="M7.5,10 Q7,14 7.5,19" fill="none" stroke="#27ae60" stroke-width="1"/>
                    <!-- Ïûé -->
                    <path d="M7.5,14 Q4,12 3,14 Q4,15 7.5,14" fill="#2ecc71"/>
                    <path d="M7.5,16 Q11,14 12,16 Q11,17 7.5,16" fill="#2ecc71"/>
                    <!-- ÍΩÉÏûé (5Ïû•) -->
                    <ellipse cx="7.5" cy="5" rx="2.5" ry="3" fill="#e74c3c"/>
                    <ellipse cx="4" cy="7.5" rx="2.5" ry="3" fill="#e74c3c" transform="rotate(-72,7.5,7.5)"/>
                    <ellipse cx="5.5" cy="11" rx="2.5" ry="3" fill="#e74c3c" transform="rotate(-144,7.5,7.5)"/>
                    <ellipse cx="9.5" cy="11" rx="2.5" ry="3" fill="#e74c3c" transform="rotate(-216,7.5,7.5)"/>
                    <ellipse cx="11" cy="7.5" rx="2.5" ry="3" fill="#e74c3c" transform="rotate(-288,7.5,7.5)"/>
                    <!-- ÍΩÉÏà† -->
                    <circle cx="7.5" cy="7.5" r="2" fill="#f1c40f"/>
                    <circle cx="7.5" cy="7.5" r="1" fill="#e67e22"/>
                </svg>`,

                'checkered-flag': `<svg viewBox="0 0 20 30" width="20" height="30">
                    <!-- ÍπÉÎåÄ -->
                    <rect x="1" y="2" width="1.5" height="28" fill="#888" stroke="#666" stroke-width="0.2"/>
                    <circle cx="1.75" cy="2" r="1.2" fill="#FFD700"/>
                    <!-- ÍπÉÎ∞ú (Ï≤¥Ïª§ Ìå®ÌÑ¥) -->
                    <rect x="2.5" y="2" width="16" height="14" fill="white" stroke="#333" stroke-width="0.3"/>
                    <!-- Ï≤¥Ïª§ Ìå®ÌÑ¥ -->
                    <rect x="2.5" y="2" width="4" height="3.5" fill="#111"/>
                    <rect x="10.5" y="2" width="4" height="3.5" fill="#111"/>
                    <rect x="6.5" y="5.5" width="4" height="3.5" fill="#111"/>
                    <rect x="14.5" y="5.5" width="4" height="3.5" fill="#111"/>
                    <rect x="2.5" y="9" width="4" height="3.5" fill="#111"/>
                    <rect x="10.5" y="9" width="4" height="3.5" fill="#111"/>
                    <rect x="6.5" y="12.5" width="4" height="3.5" fill="#111"/>
                    <rect x="14.5" y="12.5" width="4" height="3.5" fill="#111"/>
                    <!-- ÍπÉÎ∞ú ÌéÑÎü≠ÏûÑ -->
                    <path d="M18.5,2 Q19,5 18.5,9 Q19,12 18.5,16" fill="none" stroke="#333" stroke-width="0.2"/>
                </svg>`,

                'balloon': `<svg viewBox="0 0 15 25" width="15" height="25">
                    <!-- ÌíçÏÑ† Î≥∏Ï≤¥ -->
                    <ellipse cx="7.5" cy="8" rx="6" ry="7.5" fill="#e74c3c"/>
                    <!-- ÌïòÏù¥ÎùºÏù¥Ìä∏ -->
                    <ellipse cx="5.5" cy="6" rx="2" ry="2.5" fill="white" opacity="0.3"/>
                    <!-- ÌíçÏÑ† Íº≠ÏßÄ -->
                    <polygon points="6.5,15 8.5,15 7.5,17" fill="#c0392b"/>
                    <!-- ÎÅà -->
                    <path d="M7.5,17 Q6,20 7.5,22 Q9,24 7.5,25" fill="none" stroke="#999" stroke-width="0.5"/>
                </svg>`
            };
            return objects[objectId] || '';
        }

        // Î†àÏù∏ ÏÉùÏÑ± Í≥µÌÜµ Ìï®Ïàò
        function createLane({ vehicleId, topPx, laneHeight, isRacing }) {
            const vehicleBg = getVehicleBackground(vehicleId);
            const lane = document.createElement('div');
            lane.style.cssText = `
                position: absolute;
                left: 0;
                top: ${topPx}px;
                width: 100%;
                height: ${laneHeight}px;
                background-image: ${vehicleBg.bg};
                background-size: ${isRacing ? 'auto 100%' : 'cover'};
                background-repeat: ${isRacing ? 'repeat-x' : 'no-repeat'};
                background-position: ${isRacing ? '0 center' : 'center'};
                box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            `;

            // Î∞∞Í≤Ω Ìö®Í≥º Ï∂îÍ∞Ä
            if (vehicleBg.extra === 'road') {
                lane.innerHTML += `<div style="position: absolute; top: 50%; left: 0; width: 100%; height: 3px; background: repeating-linear-gradient(90deg, #fff 0px, #fff 20px, transparent 20px, transparent 40px);"></div>`;
            }
            if (vehicleBg.extra === 'stars') {
                for (let i = 0; i < 20; i++) {
                    const size = 1 + Math.random() * 2;
                    lane.innerHTML += `<div style="position: absolute; width: ${size}px; height: ${size}px; background: white; border-radius: 50%; left: ${Math.random() * 100}%; top: ${Math.random() * 100}%; opacity: ${0.5 + Math.random() * 0.5};"></div>`;
                }
            }
            if (vehicleBg.extra === 'waves') {
                lane.innerHTML += `<div style="position: absolute; bottom: 20%; left: 0; width: 100%; height: 4px; background: repeating-linear-gradient(90deg, transparent, transparent 15px, rgba(255,255,255,0.4) 15px, rgba(255,255,255,0.4) 30px);"></div>`;
                lane.innerHTML += `<div style="position: absolute; bottom: 40%; left: 10px; width: 100%; height: 3px; background: repeating-linear-gradient(90deg, transparent, transparent 20px, rgba(255,255,255,0.3) 20px, rgba(255,255,255,0.3) 35px);"></div>`;
            }
            if (vehicleBg.extra === 'clouds') {
                for (let i = 0; i < 4; i++) {
                    const w = 25 + Math.random() * 20;
                    lane.innerHTML += `<div style="position: absolute; width: ${w}px; height: ${w*0.5}px; background: rgba(255,255,255,0.7); border-radius: ${w/2}px; left: ${Math.random() * 85}%; top: ${10 + Math.random() * 50}%;"></div>`;
                }
            }
            if (vehicleBg.extra === 'carrots') {
                for (let i = 0; i < 6; i++) {
                    lane.innerHTML += `<div style="position: absolute; font-size: 14px; left: ${10 + Math.random() * 80}%; top: ${40 + Math.random() * 50}%;">ü•ï</div>`;
                }
            }
            if (vehicleBg.extra === 'mountains') {
                lane.innerHTML += `<svg style="position: absolute; bottom: 30%; left: 0; width: 100%; height: 40%;" viewBox="0 0 100 40" preserveAspectRatio="none"><polygon points="0,40 15,15 30,40" fill="#7f8c8d"/><polygon points="20,40 40,10 60,40" fill="#95a5a6"/><polygon points="50,40 70,20 90,40" fill="#7f8c8d"/><polygon points="70,40 85,25 100,40" fill="#95a5a6"/></svg>`;
            }
            if (vehicleBg.extra === 'buildings') {
                lane.innerHTML += `<svg style="position: absolute; bottom: 0; left: 0; width: 100%; height: 35%;" viewBox="0 0 100 35" preserveAspectRatio="none"><rect x="0" y="10" width="8" height="25" fill="#1a252f"/><rect x="10" y="5" width="10" height="30" fill="#2c3e50"/><rect x="22" y="15" width="6" height="20" fill="#1a252f"/><rect x="30" y="8" width="12" height="27" fill="#34495e"/><rect x="45" y="12" width="8" height="23" fill="#2c3e50"/><rect x="55" y="3" width="10" height="32" fill="#1a252f"/><rect x="67" y="18" width="7" height="17" fill="#34495e"/><rect x="76" y="10" width="12" height="25" fill="#2c3e50"/><rect x="90" y="15" width="10" height="20" fill="#1a252f"/></svg>`;
            }

            return { lane, vehicleBg };
        }

        // Î≤Ω ÏÉùÏÑ± Í≥µÌÜµ Ìï®Ïàò
        function createWall({ topPx, wallHeight }) {
            const wall = document.createElement('div');
            wall.style.cssText = `
                position: absolute;
                left: 0;
                top: ${topPx}px;
                width: 100%;
                height: ${wallHeight}px;
                background: linear-gradient(180deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%);
                box-shadow:
                    0 2px 4px rgba(0,0,0,0.3),
                    inset 0 1px 2px rgba(255,255,255,0.1),
                    inset 0 -1px 2px rgba(0,0,0,0.2);
                border-top: 1px solid rgba(255,255,255,0.2);
                border-bottom: 1px solid rgba(0,0,0,0.3);
                z-index: 10;
            `;
            return wall;
        }

        // ÌÉàÍ≤ÉÎ≥Ñ Î∞∞Í≤Ω ÏÉùÏÑ± Ìï®Ïàò
        function getVehicleBackground(vehicleId) {
            // JSONÏóêÏÑú ÌÖåÎßà Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
            const theme = vehicleThemes[vehicleId];
            
            if (theme) {
                // Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ ÏÇ¨Ïö©
                return {
                    bg: `url('${theme.backgroundImage}')`,
                    bgSize: 'cover',
                    bgRepeat: 'no-repeat',
                    bgPosition: 'center',
                    textColor: getTextColorByTheme(theme.theme),
                    theme: theme.theme,
                    backgroundImage: theme.backgroundImage
                };
            }
            
            // Ìè¥Î∞±: Í∏∞Î≥∏Í∞í
            return {
                bg: 'linear-gradient(0deg, #333 0%, #333 30%, #555 30%, #555 70%, #87CEEB 70%, #87CEEB 100%)',
                textColor: '#fff',
                theme: 'expressway',
                backgroundImage: 'assets/backgrounds/expressway.png'
            };
        }
        
        // ÌÖåÎßàÏóê Îî∞Î•∏ ÌÖçÏä§Ìä∏ ÏÉâÏÉÅ Í≤∞Ï†ï
        function getTextColorByTheme(theme) {
            const themeColors = {
                'forest': '#fff',
                'sky': '#333',
                'expressway': '#fff',
                'ocean': '#fff',
                'road': '#fff',
                'beach': '#333'
            };
            return themeColors[theme] || '#fff';
        }
        
        // Í≤ΩÏ£º Í≤∞Í≥º ÌëúÏãú
        function showRaceResult(data, isReplay = false) {
            // Îã§ÏãúÎ≥¥Í∏∞Í∞Ä ÏïÑÎãå Í≤ΩÏö∞ Ï§ëÎ≥µ Ìò∏Ï∂ú Î∞©ÏßÄ
            if (!isReplay && raceResultShown) {
                console.warn('[showRaceResult] Ï§ëÎ≥µ Ìò∏Ï∂ú Ï∞®Îã®!', new Error().stack);
                addDebugLog('‚ö†Ô∏è showRaceResult Ï§ëÎ≥µ Ìò∏Ï∂ú Î¨¥Ïãú', 'system');
                return;
            }
            console.log('[showRaceResult] Ìò∏Ï∂úÎê®', { isReplay, raceResultShown, stack: new Error().stack });
            if (!isReplay) raceResultShown = true;

            isRaceActive = false;
            updateStartButton(); // Í≤åÏûÑ Ï¢ÖÎ£å Ïãú Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏

            const winners = data.winners || [];
            const horseRankings = data.horseRankings || [];
            const gameMode = data.horseRaceMode || 'last';

            addDebugLog(`Í≤ΩÏ£º Í≤∞Í≥º: ÎãπÏ≤®Ïûê ${winners.length}Î™Ö (${winners.join(', ')})`, 'race');

            // ÌÉàÍ≤É Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞ Ìó¨Ìçº Ìï®Ïàò
            function getVehicleInfo(horseIndex) {
                const vehicleId = selectedVehicleTypes ? selectedVehicleTypes[horseIndex] : null;
                if (vehicleId && ALL_VEHICLES.length > 0) {
                    const vehicle = ALL_VEHICLES.find(v => v.id === vehicleId);
                    if (vehicle) return { ...vehicle, vehicleId };
                }
                // Í∏∞Î≥∏Í∞í
                return { id: 'horse', name: 'Îßê', emoji: 'üêé', vehicleId: 'horse' };
            }
            
            // Ìï¥Îãπ ÎßêÏóê Î≤†ÌåÖÌïú Î™®Îì† ÏÇ¨Ïö©Ïûê Ï∞æÍ∏∞
            function getBettingUsers(horseIndex) {
                const users = [];
                Object.entries(userHorseBets).forEach(([userName, betHorse]) => {
                    if (betHorse === horseIndex) {
                        users.push(userName);
                    }
                });
                return users;
            }
            
            // SVG Í∑∏Î¶º Í∞ÄÏ†∏Ïò§Í∏∞ (ÌÅ¨Í∏∞ Ï°∞Ï†à Í∞ÄÎä•)
            function getVehicleSVGForResult(vehicleId, size = 60) {
                const svgs = getVehicleSVG(vehicleId);
                // frame1 SVGÏóêÏÑú width/height Ï°∞Ï†à (run ÎòêÎäî idle ÏÉÅÌÉú ÏÇ¨Ïö©)
                const stateData = svgs.run || svgs.idle || svgs;
                let svg = stateData.frame1 || svgs.frame1;
                svg = svg.replace(/width="60"/g, `width="${size}"`);
                svg = svg.replace(/height="45"/g, `height="${Math.round(size * 0.75)}"`);
                return svg;
            }
            
            // Íº¥Îì± Î≤†ÌåÖÏûê Í≥ÑÏÇ∞ (ÏûêÎèôÏ§ÄÎπÑ ÌåêÎã® + Ï±ÑÌåÖ ÌëúÏãúÏö©)
            let loserIndex = horseRankings.length - 1;
            let loserHorseIndex = horseRankings[loserIndex];
            let loserBettingUsers = getBettingUsers(loserHorseIndex);

            // Íº¥Îì±Î∂ÄÌÑ∞ Ïó≠ÏàúÏúºÎ°ú Ïò¨ÎùºÍ∞ÄÎ©∞ Î≤†ÌåÖÏûêÍ∞Ä ÏûàÎäî ÏàúÏúÑ Ï∞æÍ∏∞
            for (let i = horseRankings.length - 1; i >= 0; i--) {
                const users = getBettingUsers(horseRankings[i]);
                if (users.length > 0) {
                    loserIndex = i;
                    loserHorseIndex = horseRankings[i];
                    loserBettingUsers = users;
                    break;
                }
            }
            const loserVehicle = getVehicleInfo(loserHorseIndex);

            // Ï±ÑÌåÖÏóê LOSER Ïπ¥Îìú ÌëúÏãú (Í≤∞Í≥º Ïò§Î≤ÑÎ†àÏù¥ÏôÄ ÎèôÏùºÌïú ÎîîÏûêÏù∏)
            if (ChatModule && typeof ChatModule.displayChatMessage === 'function') {
                const chatLoserVehicle = getVehicleInfo(loserHorseIndex);
                const loserNames = loserBettingUsers.length > 0 ? loserBettingUsers.join(', ') : 'ÏóÜÏùå';
                const chatLoserSvg = getVehicleSVGForResult ? getVehicleSVGForResult(chatLoserVehicle.vehicleId || chatLoserVehicle.id, 45) : '';
                const chatResultHtml = `
                    <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 4px 8px; border-radius: 6px; border: 1.5px solid #e94560; position: relative; overflow: hidden; margin: 2px 0; display: inline-block;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="font-size: 13px;">üíÄ</span>
                            <span style="font-size: 12px; font-weight: bold; color: #e94560;">${loserIndex + 1}Îì±</span>
                            <div style="transform: scale(0.55); margin: -8px -4px; filter: grayscale(60%);">${chatLoserSvg}</div>
                            <span style="font-size: 11px; font-weight: bold; color: #eee;">${chatLoserVehicle.name}</span>
                            <span style="font-size: 11px; color: #e94560; margin-left: auto;">üéâ ${loserNames}</span>
                        </div>
                    </div>`;
                ChatModule.displayChatMessage({
                    message: chatResultHtml,
                    isSystemMessage: true,
                    isHtml: true,
                    noBackground: true,
                    time: new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' })
                }, true);
            }

            // Í≤∞Í≥º Ïò§Î≤ÑÎ†àÏù¥ ÌëúÏãú
            const rankingsDiv = document.getElementById('resultRankings');
            if (rankingsDiv) {

                // Íº¥Îì± Î©òÌä∏ ÎûúÎç§
                const loserComments = [
                    'Ï∂ïÌïòÌï©ÎãàÎã§! ÏòÅÍ¥ëÏùò Íº¥Îì±!',
                    'Íº¥Îì±Ïùò ÏòÅÍ¥ëÏùÑ ÏïàÍ≥† Í∞ëÎãàÎã§!',
                    'Íº¥Ï∞åÎäî ÏïÑÎ¶ÑÎãµÎã§...',
                    'ÎäêÎ¶ºÏùò ÎØ∏Ìïô! Íº¥Îì± Ï∂ïÌïò!',
                    'Íº¥Îì±Ïù¥ÏïºÎßêÎ°ú ÏßÑÏ†ïÌïú Ï£ºÏù∏Í≥µ!',
                    'ÎßàÏßÄÎßâÍπåÏßÄ ÏµúÏÑ†ÏùÑ Îã§Ìïú Íº¥Îì±!',
                ];
                const loserComment = loserComments[Math.floor(Math.random() * loserComments.length)];

                // 1Îì±~Íº¥Îì± Ï†ÑÏ≤¥ ÏàúÏúÑ
                let rankingsHtml = '';
                horseRankings.forEach((horseIndex, index) => {
                    const vehicle = getVehicleInfo(horseIndex);
                    const bettingUsers = getBettingUsers(horseIndex);
                    const rankNum = index + 1;
                    const isLast = index === loserIndex;
                    const usersHtml = bettingUsers.length > 0 ? bettingUsers.join(', ') : 'Î≤†ÌåÖ ÏóÜÏùå';

                    if (index === 0) {
                        rankingsHtml += `
                            <div class="result-rank-1" style="background: linear-gradient(135deg, #fff8dc 0%, #ffeaa7 100%); padding: 12px 14px; border-radius: 10px; margin-bottom: 8px; border-left: 4px solid #f1c40f;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 22px;">ü•á</span>
                                    <span style="font-size: 18px; font-weight: bold; color: #8b6914;">${rankNum}Îì±</span>
                                    <div style="transform: scale(0.9);">${getVehicleSVGForResult(vehicle.vehicleId || vehicle.id, 45)}</div>
                                    <span style="font-size: 15px; font-weight: bold; color: #8b6914;">${vehicle.name}</span>
                                    <span style="font-size: 12px; color: #a08030; margin-left: auto;">${usersHtml}</span>
                                </div>
                            </div>
                        `;
                    } else if (index === 1) {
                        rankingsHtml += `
                            <div class="result-rank-2" style="background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%); padding: 10px 14px; border-radius: 8px; margin-bottom: 6px; border-left: 4px solid #bdc3c7;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 18px;">ü•à</span>
                                    <span style="font-size: 16px; font-weight: bold; color: #555;">${rankNum}Îì±</span>
                                    <div style="transform: scale(0.8);">${getVehicleSVGForResult(vehicle.vehicleId || vehicle.id, 40)}</div>
                                    <span style="font-size: 14px; font-weight: bold; color: #555;">${vehicle.name}</span>
                                    <span style="font-size: 12px; color: #888; margin-left: auto;">${usersHtml}</span>
                                </div>
                            </div>
                        `;
                    } else if (index === 2) {
                        rankingsHtml += `
                            <div class="result-rank-3" style="background: linear-gradient(135deg, #fae5d3 0%, #f0d5b8 100%); padding: 10px 14px; border-radius: 8px; margin-bottom: 6px; border-left: 4px solid #cd7f32;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 18px;">ü•â</span>
                                    <span style="font-size: 16px; font-weight: bold; color: #8b5e3c;">${rankNum}Îì±</span>
                                    <div style="transform: scale(0.8);">${getVehicleSVGForResult(vehicle.vehicleId || vehicle.id, 40)}</div>
                                    <span style="font-size: 14px; font-weight: bold; color: #8b5e3c;">${vehicle.name}</span>
                                    <span style="font-size: 12px; color: #a07050; margin-left: auto;">${usersHtml}</span>
                                </div>
                            </div>
                        `;
                    } else if (isLast) {
                        rankingsHtml += `
                            <div style="background: linear-gradient(135deg, #2d1f3d 0%, #1a1a2e 100%); padding: 10px 14px; border-radius: 8px; margin-bottom: 6px; border-left: 4px solid #e94560;">
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <span style="font-size: 16px;">üíÄ</span>
                                    <span style="font-size: 15px; font-weight: bold; color: #e94560;">${rankNum}Îì±</span>
                                    <div style="transform: scale(0.7); filter: grayscale(50%);">${getVehicleSVGForResult(vehicle.vehicleId || vehicle.id, 40)}</div>
                                    <span style="font-size: 13px; font-weight: bold; color: #e94560;">${vehicle.name}</span>
                                    <span style="font-size: 12px; color: #e94560; margin-left: auto; font-weight: 600;">${usersHtml}</span>
                                </div>
                            </div>
                        `;
                    } else {
                        rankingsHtml += `
                            <div style="background: #fafafa; padding: 8px 14px; border-radius: 6px; margin-bottom: 4px; border-left: 4px solid #ddd;">
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <span style="font-size: 13px; font-weight: bold; color: #999; min-width: 28px;">${rankNum}Îì±</span>
                                    <div style="transform: scale(0.65);">${getVehicleSVGForResult(vehicle.vehicleId || vehicle.id, 38)}</div>
                                    <span style="font-size: 13px; color: #777;">${vehicle.name}</span>
                                    <span style="font-size: 11px; color: #aaa; margin-left: auto;">${usersHtml}</span>
                                </div>
                            </div>
                        `;
                    }
                });

                // Íº¥Îì± ÌïòÏù¥ÎùºÏù¥Ìä∏ (ÌïòÎã®)
                rankingsHtml += `
                    <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 10px 14px; border-radius: 10px; margin-top: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 2px solid #e94560; position: relative; overflow: hidden;">
                        <div style="position: absolute; top: -5px; left: 50%; transform: translateX(-50%); background: #e94560; color: #fff; padding: 2px 10px; border-radius: 0 0 6px 6px; font-size: 9px; font-weight: bold; letter-spacing: 1px;">LOSER</div>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 6px;">
                            <span style="font-size: 20px;">üíÄ</span>
                            <span style="font-size: 16px; font-weight: bold; color: #e94560;">${loserIndex + 1}Îì±</span>
                            <div style="transform: scale(0.8); filter: grayscale(60%);">${getVehicleSVGForResult(loserVehicle.vehicleId || loserVehicle.id, 38)}</div>
                            <span style="font-size: 14px; font-weight: bold; color: #eee;">${loserVehicle.name}</span>
                        </div>
                        <div style="font-size: 13px; color: #e94560; text-align: center; margin-top: 4px; font-weight: 700;">
                            üéâ ${loserBettingUsers.join(', ')} üéâ
                        </div>
                    </div>
                `;

                rankingsDiv.innerHTML = rankingsHtml;
            }
            
            // ÏàúÏúÑ Ïù¥ÌéôÌä∏ Ïà®Í∏∞Í∏∞
            if (finishEffectsOverlay) {
                finishEffectsOverlay.style.display = 'none';
            }
            
            console.log('[resultOverlay] visible Ï∂îÍ∞Ä', { isReplay, stack: new Error().stack });
            document.getElementById('resultOverlay').classList.add('visible');
            
            // Í≤åÏûÑ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            const gameStatus = document.getElementById('gameStatus');
            if (gameStatus) {
                gameStatus.textContent = 'Í≤ΩÏ£º Ï¢ÖÎ£å!';
                gameStatus.style.background = '#e9ecef';
                gameStatus.style.color = '#495057';
            }
            
            // Îã§ÏãúÎ≥¥Í∏∞ Î≤ÑÌäº ÌëúÏãú (Î™®Îì† ÏÇ¨Ïö©Ïûê)
            document.getElementById('replaySection').style.display = 'block';
            const replayBtn = document.getElementById('mainReplayButton');
            if (replayBtn) {
                replayBtn.disabled = false;
                replayBtn.textContent = 'üé¨ Îã§ÏãúÎ≥¥Í∏∞';
                replayBtn.style.opacity = '1';
                replayBtn.style.cursor = 'pointer';
            }

            // Ìò∏Ïä§Ìä∏ÏóêÍ≤å Ï¢ÖÎ£å Î≤ÑÌäº ÌëúÏãú
            if (isHost) {
                document.getElementById('endGameSection').style.display = 'block';
            }
            
            // Í≤ΩÏ£º Ìä∏ÎûôÏùÄ Ïú†ÏßÄ (Í≤åÏûÑ Ï¢ÖÎ£å ÏãúÍπåÏßÄ)

            // LOSER(Íº¥Îì± Î≤†ÌåÖÏûê)Í∞Ä 2Î™Ö Ïù¥ÏÉÅÏù¥Î©¥ ÏûêÎèô Ï§ÄÎπÑ
            if (loserBettingUsers && loserBettingUsers.length >= 2) {
                setTimeout(() => {
                    if (!isReady) {
                        toggleReady();
                        addDebugLog(`LOSER ${loserBettingUsers.length}Î™Ö ‚Üí ÏûêÎèô Ï§ÄÎπÑ`, 'system');
                    }
                }, 3000);
            }
        }
        
        // 3-2-1 Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ ÌëúÏãú (Í≤ΩÎßàÎßµ ÏòÅÏó≠ ÏïàÏóê)
        function showCountdown() {
            // Î†àÏù¥Ïä§ Ìä∏Îûô Ïª®ÌÖåÏù¥ÎÑà ÌëúÏãú
            const trackContainer = document.getElementById('raceTrackContainer');
            if (trackContainer) {
                trackContainer.style.display = 'block';
            }

            // Í∏∞Ï°¥ Ïò§Î≤ÑÎ†àÏù¥ Ï†úÍ±∞
            const existing = document.getElementById('countdownOverlay');
            if (existing) existing.remove();

            const overlay = document.createElement('div');
            overlay.id = 'countdownOverlay';
            overlay.style.cssText = `
                position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.75); z-index: 100;
                display: flex; justify-content: center; align-items: center;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            `;

            // raceTrackContainerÏóê relative ÏÑ§Ï†ï ÌõÑ ÎÇ¥Î∂ÄÏóê Ïò§Î≤ÑÎ†àÏù¥ Ï∂îÍ∞Ä
            if (trackContainer) {
                trackContainer.style.position = 'relative';
                trackContainer.appendChild(overlay);
            } else {
                document.body.appendChild(overlay);
            }

            const nums = ['3', '2', '1', 'START!'];
            const colors = ['#e74c3c', '#f39c12', '#2ecc71', '#3498db'];
            let idx = 0;

            function showNext() {
                if (idx >= nums.length) {
                    overlay.remove();
                    return;
                }
                overlay.innerHTML = `<div style="
                    font-size: ${nums[idx] === 'START!' ? '60px' : '90px'};
                    font-weight: 900; color: ${colors[idx]};
                    text-shadow: 0 0 30px ${colors[idx]}, 0 0 60px ${colors[idx]}40;
                    animation: countPop 0.8s ease-out;
                ">${nums[idx]}</div>`;
                idx++;
                setTimeout(showNext, 1000);
            }
            showNext();
        }

        // ÏÇ¨Ïö©Ïûê Î™©Î°ù Î†åÎçîÎßÅ
        function updateUsers(users) {
            currentUsers = users;
            const usersList = document.getElementById('usersList');
            const usersCount = document.getElementById('usersCount');

            if (!usersList || !usersCount) return;

            usersCount.textContent = users.length;
            usersList.innerHTML = '';

            // ÎìúÎûòÍ∑∏ ÌûåÌä∏ ÌëúÏãú
            const dragHint = document.getElementById('dragHint');
            if (dragHint) {
                dragHint.style.display = (isHost && !isRaceActive) ? 'inline' : 'none';
            }

            users.forEach(user => {
                const tag = document.createElement('span');
                tag.className = 'user-tag';
                if (user.isHost) {
                    tag.classList.add('host');
                }
                if (user.name === currentUser) {
                    tag.classList.add('me');
                }

                let content = user.name;
                if (user.isHost) {
                    content += ' üëë';
                }
                if (user.name === currentUser) {
                    content += ' (ÎÇò)';
                }
                tag.textContent = content;

                // Ìò∏Ïä§Ìä∏Í∞Ä Îã§Î•∏ ÏÇ¨Ïö©ÏûêÎ•º ÌÅ¥Î¶≠ÌïòÎ©¥ Ïï°ÏÖò ÏÑ†ÌÉù Îã§Ïù¥ÏñºÎ°úÍ∑∏ ÌëúÏãú
                if (isHost && user.name !== currentUser) {
                    tag.style.cursor = 'pointer';
                    tag.title = 'ÌÅ¥Î¶≠ÌïòÏó¨ Ìò∏Ïä§Ìä∏ÏûÑÎ™Ö ÎòêÎäî Ï†úÏô∏';
                    tag.addEventListener('click', () => {
                        showPlayerActionDialog(user.name).then(action => {
                            if (action === 'host') {
                                socket.emit('transferHost', user.name);
                            } else if (action === 'kick') {
                                showConfirmDialog(`${user.name}ÎãòÏùÑ Í≤åÏûÑÏóêÏÑú Ï†úÏô∏ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`, () => {
                                    socket.emit('kickPlayer', user.name);
                                });
                            }
                        });
                    });
                }

                // Ìò∏Ïä§Ìä∏Îßå ÎìúÎûòÍ∑∏ Í∞ÄÎä• (Í≤åÏûÑ ÎπÑÌôúÏÑ± Ïãú)
                if (isHost && !isRaceActive) {
                    tag.draggable = true;
                    tag.style.cursor = 'grab';
                    tag.setAttribute('data-user-name', user.name);

                    tag.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', user.name);
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('source', 'users');
                        tag.style.opacity = '0.5';
                    });

                    tag.addEventListener('dragend', (e) => {
                        tag.style.opacity = '1';
                    });
                } else {
                    tag.draggable = false;
                    tag.style.cursor = 'default';
                }

                usersList.appendChild(tag);
            });
        }

        // Í≤åÏûÑ Í∏∞Î°ù Î†åÎçîÎßÅ
        function renderHistory() {
            const historyList = document.getElementById('historyList');
            if (!historyList) return;
            
            if (horseRaceHistory.length === 0) {
                historyList.innerHTML = '<div style="color: #999; text-align: center;">ÏïÑÏßÅ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§</div>';
                return;
            }
            
            historyList.innerHTML = '';
            
            // ÌÉàÍ≤É Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞ Ìó¨Ìçº Ìï®Ïàò
            function getVehicleInfoForHistory(vehicleId) {
                if (vehicleId && ALL_VEHICLES.length > 0) {
                    const vehicle = ALL_VEHICLES.find(v => v.id === vehicleId);
                    if (vehicle) return vehicle;
                }
                return { id: 'horse', name: 'Îßê', emoji: 'üêé' };
            }
            
            // SVG Í∞ÄÏ†∏Ïò§Í∏∞ (ÏûëÏùÄ ÌÅ¨Í∏∞)
            function getSmallVehicleSVG(vehicleId) {
                const svgs = getVehicleSVG(vehicleId);
                const stateData = svgs.run || svgs.idle || svgs;
                let svg = stateData.frame1 || svgs.frame1;
                svg = svg.replace(/width="60"/g, 'width="30"');
                svg = svg.replace(/height="45"/g, 'height="22"');
                return svg;
            }
            
            // Ìï¥Îãπ ÎßêÏóê Î≤†ÌåÖÌïú Î™®Îì† ÏÇ¨Ïö©Ïûê Ï∞æÍ∏∞
            function getBettingUsersFromRecord(record, horseIndex) {
                const users = [];
                if (record.userHorseBets) {
                    Object.entries(record.userHorseBets).forEach(([userName, betHorse]) => {
                        if (betHorse === horseIndex) {
                            users.push(userName);
                        }
                    });
                }
                return users;
            }
            
            horseRaceHistory.slice().reverse().forEach((record, idx) => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.style.cssText = 'background: #fff9f0; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #f0e0c0;';
                
                // ÏãúÍ∞Ñ Ìè¨Îß∑
                const time = record.timestamp ? new Date(record.timestamp).toLocaleString('ko-KR', { 
                    month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' 
                }) : '';
                
                // ÏàúÏúÑÎ≥Ñ Í≤∞Í≥º ÏÉùÏÑ±
                let rankingsHtml = '';
                if (record.rankings && record.rankings.length > 0) {
                    record.rankings.forEach((horseIndex, rank) => {
                        const vehicleId = record.selectedVehicleTypes ? record.selectedVehicleTypes[horseIndex] : 'horse';
                        const vehicle = getVehicleInfoForHistory(vehicleId);
                        const bettingUsers = getBettingUsersFromRecord(record, horseIndex);
                        const medals = ['ü•á', 'ü•à', 'ü•â', '4Ô∏è‚É£', '5Ô∏è‚É£', '6Ô∏è‚É£'];
                        const medal = medals[rank] || `${rank + 1}`;
                        const bgColors = ['#fff8dc', '#f5f5f5', '#faebd7', '#f0f0f0', '#f0f0f0', '#f0f0f0'];
                        const bgColor = bgColors[rank] || '#f0f0f0';
                        
                        rankingsHtml += `
                            <div style="display: flex; align-items: center; gap: 6px; padding: 4px 8px; background: ${bgColor}; border-radius: 4px; margin-bottom: 4px;">
                                <span style="font-size: 14px;">${medal}</span>
                                <span style="font-size: 12px; font-weight: bold;">${rank + 1}Îì±</span>
                                <div style="transform: scale(0.6); margin: -5px;">${getSmallVehicleSVG(vehicleId)}</div>
                                <span style="font-size: 11px; color: #666;">${vehicle.name}</span>
                                <span style="font-size: 11px; color: #8b4513; margin-left: auto;">${bettingUsers.length > 0 ? bettingUsers.join(', ') : '-'}</span>
                            </div>
                        `;
                    });
                }
                
                // ÏµúÏ¢Ö ÎãπÏ≤®Ïûê ÎòêÎäî Í∞ÄÏû• ÎÜíÏùÄ ÏàúÏúÑ Î≤†ÌåÖÏûê
                let winnersText = '';
                if (record.winners && record.winners.length > 0) {
                    winnersText = `üéä ÎãπÏ≤®: ${record.winners.join(', ')}`;
                } else if (record.userHorseBets && record.rankings && record.rankings.length > 0) {
                    // ÎãπÏ≤®Ïûê ÏóÜÏùÑ Îïå: Í∞ÄÏû• ÎÜíÏùÄ ÏàúÏúÑ Î≤†ÌåÖÏûê Ï∞æÍ∏∞
                    let bestRank = -1;
                    let bestBetters = [];
                    Object.entries(record.userHorseBets).forEach(([username, horseIndex]) => {
                        const rank = record.rankings.indexOf(horseIndex);
                        if (rank !== -1) {
                            if (bestRank === -1 || rank < bestRank) {
                                bestRank = rank;
                                bestBetters = [username];
                            } else if (rank === bestRank) {
                                bestBetters.push(username);
                            }
                        }
                    });
                    if (bestBetters.length > 0 && bestRank >= 0) {
                        winnersText = `üèÖ ${bestRank + 1}Îì± ÏàúÏúÑ: ${bestBetters.join(', ')}`;
                    }
                }
                
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="font-weight: bold; color: #8b4513; font-size: 14px;">${record.round || (horseRaceHistory.length - idx)}ÎùºÏö¥Îìú</div>
                        <div style="font-size: 11px; color: #999;">${time}</div>
                    </div>
                    <div style="margin-bottom: 8px;">
                        ${rankingsHtml}
                    </div>
                    ${winnersText ? `<div style="font-size: 13px; color: #d4a574; font-weight: bold; text-align: center; padding: 5px; background: #fff5e6; border-radius: 4px;">${winnersText}</div>` : ''}
                `;
                historyList.appendChild(item);
            });
        }
        
        // ÎßàÏßÄÎßâ Í≤ΩÏ£º Îã§ÏãúÎ≥¥Í∏∞ (Î©îÏù∏ Îã§ÏãúÎ≥¥Í∏∞ Î≤ÑÌäº)
        function playLastReplay() {
            if (horseRaceHistory.length === 0) {
                alert('Í∏∞Î°ùÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            const record = horseRaceHistory[horseRaceHistory.length - 1];
            playReplay(record);
        }

        // Îã§ÏãúÎ≥¥Í∏∞ Í∏∞Îä•
        function playReplay(record) {
            if (!record) {
                alert('Í∏∞Î°ùÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }

            // Í∏∞Ï°¥ ÏÇ¨Ïö¥Îìú Ï†ïÎ¶¨
            if (window.SoundManager) {
                SoundManager.stopAll();
            }

            // Îã§ÏãúÎ≥¥Í∏∞ Ï§ë Î≤ÑÌäº ÌÅ¥Î¶≠ Î∞©ÏßÄ
            const replayBtn = document.getElementById('mainReplayButton');
            if (replayBtn) {
                replayBtn.disabled = true;
                replayBtn.textContent = 'üé¨ Îã§ÏãúÎ≥¥Í∏∞ Ï§ë...';
                replayBtn.style.opacity = '0.6';
                replayBtn.style.cursor = 'not-allowed';
            }

            addDebugLog(`Îã§ÏãúÎ≥¥Í∏∞ ÏãúÏûë: ${record.round}ÎùºÏö¥Îìú`, 'replay');

            // Îßê ÏÑ†ÌÉù ÏÑπÏÖò Ïà®Í∏∞Í∏∞
            const horseSelectionSection = document.getElementById('horseSelectionSection');
            if (horseSelectionSection) {
                horseSelectionSection.classList.remove('active');
            }

            // Í≤∞Í≥º Ïò§Î≤ÑÎ†àÏù¥ Ïà®Í∏∞Í∏∞
            const resultOverlay = document.getElementById('resultOverlay');
            if (resultOverlay) {
                resultOverlay.classList.remove('visible');
            }

            // Îã§ÏãúÎ≥¥Í∏∞Ïö© ÏÉÅÌÉú ÏûÑÏãú ÏÑ§Ï†ï
            const originalSelectedVehicleTypes = selectedVehicleTypes;
            const originalUserHorseBets = userHorseBets;
            const originalAvailableHorses = availableHorses;

            selectedVehicleTypes = record.selectedVehicleTypes;
            userHorseBets = record.userHorseBets;
            availableHorses = record.availableHorses || record.rankings.map((_, i) => i);

            isRaceActive = true;

            // Ï†ÄÏû•Îêú ÏÜçÎèÑ Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö© (ÏóÜÏúºÎ©¥ ÏàúÏúÑ Í∏∞Î∞ò ÏÉùÏÑ±)
            let replaySpeeds;
            if (record.speeds && Array.isArray(record.speeds)) {
                replaySpeeds = record.speeds;
            } else {
                replaySpeeds = record.rankings.map((horseIndex, rank) => {
                    const seedValue = (record.id + horseIndex) * 9301 + 49297;
                    const pseudoRandom = ((seedValue % 233280) / 233280);
                    return 3000 + rank * 500 + pseudoRandom * 200;
                });
            }

            const replayGimmicks = record.gimmicks || null;

            // 3-2-1 Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ ÌõÑ Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë
            isReplayActive = true;
            showCountdown();
            setTimeout(() => {
                startRaceAnimation(record.rankings, replaySpeeds, replayGimmicks, (actualFinishOrder) => {
                    isRaceActive = false;
                    isReplayActive = false;

                    showRaceResult({
                        winners: record.winners,
                        horseRankings: record.rankings,
                        horseRaceMode: record.mode
                    }, true);

                    // ÏõêÎûò ÏÉÅÌÉú Î≥µÏõê
                    setTimeout(() => {
                        selectedVehicleTypes = originalSelectedVehicleTypes;
                        userHorseBets = originalUserHorseBets;
                        availableHorses = originalAvailableHorses;

                        // Îã§ÏãúÎ≥¥Í∏∞ Î≤ÑÌäº Îã§Ïãú ÌôúÏÑ±Ìôî
                        if (replayBtn) {
                            replayBtn.disabled = false;
                            replayBtn.textContent = 'üé¨ Îã§ÏãúÎ≥¥Í∏∞';
                            replayBtn.style.opacity = '1';
                            replayBtn.style.cursor = 'pointer';
                        }
                    }, 100);
                }, { trackDistanceMeters: record.trackDistanceMeters || 500 });
            }, 4000); // Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ 3-2-1-START = 4Ï¥à
        }

        // ÎÜìÏπú Í≤ΩÏ£º Îã§ÏãúÎ≥¥Í∏∞ (ÌôîÎ©¥ÏùÑ Î≥¥ÏßÄ ÏïäÏïòÏùÑ Îïå)
        function replayMissedRace() {
            if (!lastHorseRaceData) {
                alert('Îã§ÏãúÎ≥¥Í∏∞ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
                return;
            }

            // Í∏∞Ï°¥ ÏÇ¨Ïö¥Îìú Ï†ïÎ¶¨
            if (window.SoundManager) {
                SoundManager.stopAll();
            }

            addDebugLog('üîÑ ÎÜìÏπú Í≤ΩÏ£º Îã§ÏãúÎ≥¥Í∏∞ ÏãúÏûë', 'replay');

            // Îã§ÏãúÎ≥¥Í∏∞ ÏÑπÏÖò Ïà®Í∏∞Í∏∞
            document.getElementById('horseReplaySection').style.display = 'none';
            missedHorseRace = false;

            // Í≤∞Í≥º Ïò§Î≤ÑÎ†àÏù¥ Ïà®Í∏∞Í∏∞
            const resultOverlay = document.getElementById('resultOverlay');
            if (resultOverlay) {
                resultOverlay.classList.remove('visible');
            }

            // Îßê ÏÑ†ÌÉù ÏÑπÏÖò Ïà®Í∏∞Í∏∞
            const horseSelectionSection = document.getElementById('horseSelectionSection');
            if (horseSelectionSection) {
                horseSelectionSection.classList.remove('active');
            }

            // Îç∞Ïù¥ÌÑ∞ ÏûÑÏãú ÏÑ§Ï†ï
            const data = lastHorseRaceData;
            const originalSelectedVehicleTypes = selectedVehicleTypes;
            const originalUserHorseBets = userHorseBets;
            const originalAvailableHorses = availableHorses;

            selectedVehicleTypes = data.selectedVehicleTypes;
            userHorseBets = data.userHorseBets || {};
            availableHorses = data.availableHorses || data.horseRankings.map((_, i) => i);

            isRaceActive = true;

            let replaySpeeds = data.speeds || data.horseRankings.map((_, rank) => 3000 + rank * 500);
            const replayGimmicks = data.gimmicks || null;

            // 3-2-1 Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ ÌõÑ Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë
            isReplayActive = true;
            showCountdown();
            setTimeout(() => {
                startRaceAnimation(data.horseRankings, replaySpeeds, replayGimmicks, (actualFinishOrder) => {
                    isRaceActive = false;
                    isReplayActive = false;

                    showRaceResult({
                        winners: data.winners || [],
                        horseRankings: actualFinishOrder || data.horseRankings,
                        horseRaceMode: data.horseRaceMode || 'last'
                    }, true);

                    // Î≥¥Í¥ÄÎêú Í≤∞Í≥º Ï±ÑÌåÖ Î©îÏãúÏßÄ ÌëúÏãú
                    pendingRaceResultMessages.forEach(msg => {
                        ChatModule.displayChatMessage(msg);
                    });
                    pendingRaceResultMessages = [];

                    setTimeout(() => {
                        selectedVehicleTypes = originalSelectedVehicleTypes;
                        userHorseBets = originalUserHorseBets;
                        availableHorses = originalAvailableHorses;
                    }, 100);
                }, { trackDistanceMeters: data.trackDistanceMeters || 500 });
            }, 4000);
        }

        // Ï±ÑÌåÖ Î™®Îìà Ï¥àÍ∏∞Ìôî (roomCreated/roomJoined ÌõÑ Ìò∏Ï∂ú)
        let chatModuleInitialized = false;
        function initChatModule() {
            if (chatModuleInitialized) return;
            chatModuleInitialized = true;
            ChatModule.init(socket, currentUser, {
                systemGradient: 'linear-gradient(135deg, #8b4513 0%, #d2691e 100%)',
                themeColor: '#333',
                myColor: '#8b4513',
                myBgColor: '#fff5e6',
                myBorderColor: '#ffc107',
                getRoomUsers: () => users,
                messageFilter: (data) => {
                    // ÎÜìÏπú Í≤ΩÏ£º ÏÉÅÌÉúÏóêÏÑú Í≤∞Í≥º Î©îÏãúÏßÄÎäî Î≥¥Í¥Ä (Ïä§Ìè¨ÏùºÎü¨ Î∞©ÏßÄ)
                    if (missedHorseRace && data.isHorseRaceWinner) {
                        pendingRaceResultMessages.push(data);
                        return false;
                    }
                    return true;
                }
            });
        }

        // Í∏ÄÎ°úÎ≤å Ìï®Ïàò (HTML onclickÏóêÏÑú Ìò∏Ï∂ú)
        function sendMessage() { ChatModule.sendMessage(); }
        function handleChatKeypress(event) { ChatModule.handleChatKeypress(event); }
        function uploadImage() {
            ChatModule.showImageUploadModal((imageData, caption) => {
                socket.emit('sendImage', { imageData, caption });
            });
        }

        let readyModuleInitialized = false;
        function initReadyModule() {
            if (readyModuleInitialized) return;
            readyModuleInitialized = true;
            ReadyModule.init(socket, currentUser, {
                isHost: isHost,
                isGameActive: () => isRaceActive,
                onReadyChanged: (users) => {
                    readyUsers = users;
                },
                onRenderComplete: (users) => {
                    updateStartButton();
                },
                onError: (message) => alert(message),
                readyStyle: { background: 'linear-gradient(135deg, #8b4513 0%, #a0522d 100%)', color: '#fff' },
                readyCancelStyle: { background: 'linear-gradient(135deg, #a0522d 0%, #8b4513 100%)', color: '#fff' }
            });
        }

        function initOrderModule() {
            OrderModule.init(socket, currentUser, {
                isHost: () => isHost,
                isGameActive: () => isRaceActive,
                getEverPlayedUsers: () => everPlayedUsers,
                getUsersList: () => currentUsers,
                showCustomAlert: (msg, type) => showCustomAlert ? showCustomAlert(msg, type) : alert(msg),
                onOrderStarted: () => { isOrderActive = true; },
                onOrderEnded: () => { isOrderActive = false; },
                onOrdersUpdated: (data) => { ordersData = data; },
            });
        }

        function addChatMessage(data) { ChatModule.displayChatMessage(data); }
        function toggleReaction(messageIndex, emoji) {
            socket.emit('toggleReaction', { messageIndex, emoji });
        }

        // Í≤∞Í≥º Ïò§Î≤ÑÎ†àÏù¥ Îã´Í∏∞ (ÎπÑÏÑùÏùÄ Îã§Ïùå Í≤ΩÏ£º ÏãúÏûë Ï†ÑÍπåÏßÄ Ïú†ÏßÄ)
        function closeResultOverlay() {
            document.getElementById('resultOverlay').classList.remove('visible');
            // ÏàúÏúÑ Ïù¥ÌéôÌä∏Îäî Ï†úÍ±∞ÌïòÏßÄ ÏïäÏùå ‚Üí ÎπÑÏÑùÏù¥ ÎÇ®Ïùå. ÏÉà Í≤ΩÏ£º ÏãúÏûë Ïãú clearFinishEffects()Î°ú Ï†ïÎ¶¨Îê®
        }

        // Î∞© Ìè≠Ìåå Ïπ¥Ïö¥Ìä∏Îã§Ïö¥
        function startRoomExpiryCountdown(createdAt, expiryHours) {
            if (roomExpiryInterval) {
                clearInterval(roomExpiryInterval);
            }
            
            const expirySection = document.getElementById('roomExpirySection');
            const countdownElement = document.getElementById('roomExpiryCountdown');
            
            if (!expirySection || !countdownElement) return;
            
            expirySection.style.display = 'block';
            
            function updateCountdown() {
                const now = new Date();
                const createdAtDate = new Date(createdAt);
                const expiryTime = createdAtDate.getTime() + (expiryHours * 60 * 60 * 1000);
                const remaining = expiryTime - now.getTime();
                
                if (remaining <= 0) {
                    countdownElement.textContent = '00:00:00';
                    if (roomExpiryInterval) {
                        clearInterval(roomExpiryInterval);
                    }
                    return;
                }
                
                const hours = Math.floor(remaining / (1000 * 60 * 60));
                const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
                
                countdownElement.textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
            
            updateCountdown();
            roomExpiryInterval = setInterval(updateCountdown, 1000);
        }

        // Í≤åÏûÑ ÌôîÎ©¥ Ï¥àÍ∏∞Ìôî
        function initializeGameScreen(data) {
            document.getElementById('roomTitle').textContent = data.roomName || 'Í≤ΩÎßà Î∞©';
            
            if (data.createdAt && data.expiryHours) {
                startRoomExpiryCountdown(data.createdAt, data.expiryHours);
            }
            
            // ÏÇ¨Ïö©Ïûê Î™©Î°ù Ï¥àÍ∏∞Ìôî
            if (data.gameState && data.gameState.users) {
                currentUsers = data.gameState.users;
            }
            
            // ÎàÑÏ†Å Ï∞∏Ïó¨Ïûê Î™©Î°ù Î≥µÏõê
            if (data.everPlayedUsers && Array.isArray(data.everPlayedUsers)) {
                everPlayedUsers = [...data.everPlayedUsers];
            } else if (data.gameState && data.gameState.everPlayedUsers && Array.isArray(data.gameState.everPlayedUsers)) {
                everPlayedUsers = [...data.gameState.everPlayedUsers];
            } else {
                everPlayedUsers = [];
            }
            
            // Ï£ºÎ¨∏Î∞õÍ∏∞ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
            isOrderActive = (data.gameState && data.gameState.isOrderActive) || false;
            OrderModule.setIsOrderActive(isOrderActive);
            ordersData = (data.gameState && data.gameState.userOrders) || {};
            OrderModule.setOrdersData(ordersData);

            // Ìò∏Ïä§Ìä∏ UI ÏÑ§Ï†ï
            if (isHost) {
                document.getElementById('hostBadge').style.display = 'inline-block';
                document.getElementById('hostControls').style.display = 'block';

                // Ï£ºÎ¨∏Î∞õÍ∏∞ Î≤ÑÌäº ÏÉÅÌÉú
                if (isOrderActive) {
                    document.getElementById('startOrderButton').style.display = 'none';
                    document.getElementById('endOrderButton').style.display = 'block';
                } else {
                    document.getElementById('startOrderButton').style.display = 'block';
                    document.getElementById('endOrderButton').style.display = 'none';
                }
            } else {
                document.getElementById('hostBadge').style.display = 'none';
                document.getElementById('hostControls').style.display = 'none';
            }

            // Ï£ºÎ¨∏Î∞õÍ∏∞ ÏÉÅÌÉú Î∞òÏòÅ (CSS: .orders-section { display:none }, .orders-section.active { display:block })
            if (isOrderActive) {
                document.getElementById('ordersSection').classList.add('active');
                document.getElementById('myOrderInput').disabled = false;
                document.getElementById('orderSaveButton').disabled = false;

                if (isHost) {
                    document.getElementById('startOrderButton').style.display = 'none';
                    document.getElementById('endOrderButton').style.display = 'block';
                }

                OrderModule.renderOrders();
                OrderModule.renderNotOrderedUsers();
            } else {
                document.getElementById('ordersSection').classList.remove('active');
                document.getElementById('myOrderInput').disabled = true;
                document.getElementById('orderSaveButton').disabled = true;

                if (!isRaceActive) {
                    document.getElementById('gameStatus').textContent = 'ÎåÄÍ∏∞ Ï§ë...';
                    document.getElementById('gameStatus').classList.remove('ordering');
                    document.getElementById('gameStatus').classList.add('waiting');
                }

                if (isHost && !isRaceActive) {
                    const startOrderBtn = document.getElementById('startOrderButton');
                    const endOrderBtn = document.getElementById('endOrderButton');
                    if (startOrderBtn) startOrderBtn.style.display = 'block';
                    if (endOrderBtn) endOrderBtn.style.display = 'none';
                } else if (isHost) {
                    const startOrderBtn = document.getElementById('startOrderButton');
                    const endOrderBtn = document.getElementById('endOrderButton');
                    if (startOrderBtn) startOrderBtn.style.display = 'none';
                    if (endOrderBtn) endOrderBtn.style.display = 'none';
                }

                OrderModule.renderOrders();
                OrderModule.renderNotOrderedUsers();
            }
            
            // Í∏∞Î°ù ÏÑπÏÖò ÌëúÏãú
            document.getElementById('historySection').classList.add('visible');
            
            // Ï±ÑÌåÖ Í∏∞Î°ù Î°úÎìú
            if (data.chatHistory) {
                document.getElementById('chatMessages').innerHTML = '';
                data.chatHistory.forEach(msg => addChatMessage(msg));
                ChatModule.recalculatePins();
            }

            // Í≤ΩÎßà Í∏∞Î°ù Î°úÎìú
            if (data.gameState && data.gameState.horseRaceHistory) {
                horseRaceHistory = data.gameState.horseRaceHistory;
                renderHistory();
            }
            
            // Ï§ÄÎπÑ ÏÉÅÌÉú Î≥µÏõê
            if (data.readyUsers) {
                readyUsers = data.readyUsers;
                isReady = readyUsers.includes(currentUser);
                ReadyModule.setReadyUsers(readyUsers);
            }
            
            // Í≤ΩÎßà Í≤åÏûÑ ÏÉÅÌÉú Î≥µÏõê Î∞è Îßê ÏÑ†ÌÉù UI ÌëúÏãú
            if (data.gameType === 'horse-race' || (data.gameState && data.gameState.availableHorses)) {
                const gameState = data.gameState || {};
                
                // Îßê ÏÑ†ÌÉù UIÍ∞Ä Ïù¥ÎØ∏ ÌôúÏÑ±ÌôîÎêòÏñ¥ ÏûàÏúºÎ©¥ Ïú†ÏßÄ, ÏóÜÏúºÎ©¥ ÌôúÏÑ±Ìôî
                if (gameState.availableHorses && gameState.availableHorses.length > 0 && !gameState.isHorseRaceActive) {
                    availableHorses = gameState.availableHorses;
                    userHorseBets = gameState.userHorseBets || {};
                    horseRaceMode = gameState.horseRaceMode || 'last';
                    
                    mySelectedHorse = userHorseBets[currentUser] !== undefined ? userHorseBets[currentUser] : null;
                    
                    // Îßê ÏÑ†ÌÉù ÏÑπÏÖò ÌëúÏãú
                    const horseSelectionSection = document.getElementById('horseSelectionSection');
                    if (horseSelectionSection) {
                        horseSelectionSection.classList.add('active');
                        renderHorseSelection();
                    }
                }
            }
        }

        // === ÏÜåÏºì Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨ ===
        
        socket.on('connect', () => {
            document.getElementById('connectionStatus').textContent = '‚óè Ïó∞Í≤∞Îê®';
            document.getElementById('connectionStatus').className = 'connection-status connected';
            
            const createRoomStatus = document.getElementById('createRoomConnectionStatus');
            if (createRoomStatus) {
                createRoomStatus.textContent = '‚óè Ïó∞Í≤∞Îê®';
                createRoomStatus.className = 'connection-status connected';
            }
            
            if (document.getElementById('lobbySection').classList.contains('active')) {
                refreshRooms();
            }
        });

        socket.on('disconnect', () => {
            document.getElementById('connectionStatus').textContent = '‚óè Ïó∞Í≤∞ ÎÅäÍπÄ';
            document.getElementById('connectionStatus').className = 'connection-status disconnected';
        });

        socket.on('roomsList', (rooms) => {
            roomsList = rooms;
            renderRoomsList();
        });

        socket.on('roomsListUpdated', (rooms) => {
            roomsList = rooms;
            renderRoomsList();
        });

        socket.on('roomCreated', (data) => {
            currentRoomId = data.roomId;
            const hostInput = document.getElementById('createRoomHostNameInput');
            currentUser = (hostInput && hostInput.value.trim()) || data.userName || '';
            initChatModule();
            isHost = true;
            isReady = data.isReady || false;
            readyUsers = data.readyUsers || [];
            initReadyModule();
            initOrderModule();

            // Í≤ΩÎßà Í≤åÏûÑ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî (gameStateÏóêÏÑú Í∞ÄÏ†∏Ïò§Í∏∞)
            if (data.gameState) {
                if (data.gameState.selectedVehicleTypes) {
                    selectedVehicleTypes = data.gameState.selectedVehicleTypes;
                    console.log('[roomCreated] selectedVehicleTypes ÏÑ§Ï†ï:', selectedVehicleTypes);
                }
                if (data.gameState.availableHorses) {
                    availableHorses = data.gameState.availableHorses;
                }
                if (data.gameState.userHorseBets) {
                    userHorseBets = data.gameState.userHorseBets;
                }
                if (data.gameState.horseRaceMode) {
                    horseRaceMode = data.gameState.horseRaceMode;
                }
                if (data.gameState.horseRaceHistory) {
                    horseRaceHistory = data.gameState.horseRaceHistory;
                    renderHistory();
                }
            }

            document.getElementById('lobbySection').classList.remove('active');
            document.getElementById('createRoomSection').classList.remove('active');
            document.getElementById('gameSection').classList.add('active');

            document.body.classList.remove('lobby-active');
            document.body.classList.add('game-active');

            initializeGameScreen(data);
            ReadyModule.setReadyUsers(readyUsers);
        });

        socket.on('roomJoined', (data) => {
            // ÏÑ±Í≥µ Ïãú ÏóêÎü¨ ÌîåÎûòÍ∑∏ Ï†úÍ±∞
            sessionStorage.removeItem('horseRaceFromDice');
            
            // Î°úÎî© ÌôîÎ©¥ Ïà®Í∏∞Í∏∞
            document.getElementById('loadingScreen').style.display = 'none';
            
            currentRoomId = data.roomId;
            const globalInput = document.getElementById('globalUserNameInput');
            currentUser = (globalInput && globalInput.value.trim()) || data.userName || '';
            initChatModule();
            isHost = data.isHost;
            isReady = data.isReady || false;
            readyUsers = data.readyUsers || [];
            initReadyModule();
            initOrderModule();

            // Í≤ΩÎßà Í≤åÏûÑ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî (gameStateÏóêÏÑú Í∞ÄÏ†∏Ïò§Í∏∞)
            if (data.gameState) {
                if (data.gameState.selectedVehicleTypes) {
                    selectedVehicleTypes = data.gameState.selectedVehicleTypes;
                    console.log('[roomJoined] selectedVehicleTypes ÏÑ§Ï†ï:', selectedVehicleTypes);
                }
                if (data.gameState.availableHorses) {
                    availableHorses = data.gameState.availableHorses;
                }
                if (data.gameState.userHorseBets) {
                    userHorseBets = data.gameState.userHorseBets;
                }
                if (data.gameState.horseRaceMode) {
                    horseRaceMode = data.gameState.horseRaceMode;
                }
                if (data.gameState.horseRaceHistory) {
                    horseRaceHistory = data.gameState.horseRaceHistory;
                    renderHistory();
                }
            }

            document.getElementById('lobbySection').classList.remove('active');
            document.getElementById('gameSection').classList.add('active');
            
            document.body.classList.remove('lobby-active');
            document.body.classList.add('game-active');

            setHorseSoundCheckboxes();
            if (window.SoundManager && typeof window.SoundManager.ensureContext === 'function') {
                window.SoundManager.ensureContext();
            }
            initializeGameScreen(data);
            ReadyModule.setReadyUsers(readyUsers);

            // Í∏∞Î°ù ÏÑπÏÖò ÌëúÏãú
            document.getElementById('historySection').classList.add('visible');
            
            // Í≤ΩÎßà Í≤åÏûÑÏù∏ Í≤ΩÏö∞ Îßê ÏÑ†ÌÉù UIÍ∞Ä ÌëúÏãúÎê† ÎïåÍπåÏßÄ Ïû†Ïãú ÎåÄÍ∏∞ ÌõÑ Îã§Ïãú ÌôïÏù∏
            if (data.gameType === 'horse-race') {
                setTimeout(() => {
                    const horseSelectionSection = document.getElementById('horseSelectionSection');
                    if (horseSelectionSection && !horseSelectionSection.classList.contains('active')) {
                        // Îßê ÏÑ†ÌÉù UIÍ∞Ä ÏïÑÏßÅ ÌëúÏãúÎêòÏßÄ ÏïäÏïòÏúºÎ©¥ ÏÑúÎ≤ÑÏóê ÏöîÏ≤≠
                        // horseSelectionReady Ïù¥Î≤§Ìä∏Î•º Í∏∞Îã§Î¶º (ÏÑúÎ≤ÑÏóêÏÑú ÏûêÎèôÏúºÎ°ú Î≥¥ÎÉÑ)
                    }
                }, 500);
            }
        });

        socket.on('roomError', (message) => {
            // Îã§Î•∏ ÌéòÏù¥ÏßÄÏóêÏÑú Ïò® Í≤ΩÏö∞ Ï£ºÏÇ¨ÏúÑ Î©îÏù∏ÏúºÎ°ú ÎèåÏïÑÍ∞ê
            const fromDice = sessionStorage.getItem('horseRaceFromDice');
            if (fromDice === 'true') {
                sessionStorage.removeItem('horseRaceFromDice');
                alert(message);
                window.location.href = '/dice-game-multiplayer.html';
                return;
            }
            
            // Î°úÎî© ÌôîÎ©¥ Ïà®Í∏∞Í≥† Î°úÎπÑ Î≥¥Ïó¨Ï£ºÍ∏∞
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('lobbySection').style.display = 'block';
            alert(message);
        });

        socket.on('horseRaceError', (message) => {
            addDebugLog(`ÏóêÎü¨: ${message}`, 'error');
            alert(message);
        });

        // readyErrorÎäî ReadyModuleÏóêÏÑú Ï≤òÎ¶¨

        // Îßê ÏÑ†ÌÉù Ï§ÄÎπÑ Ïù¥Î≤§Ìä∏
        socket.on('horseSelectionReady', async (data) => {
            availableHorses = data.availableHorses || [];
            userHorseBets = data.userHorseBets || {};
            selectedUsersFromServer = data.selectedUsers || [];  // ÏÑ†ÌÉù ÏôÑÎ£åÏûê Î™©Î°ù
            horseRaceMode = data.horseRaceMode || 'last';
            selectedVehicleTypes = data.selectedVehicleTypes || null;
            popularVehicles = data.popularVehicles || [];
            vehicleStatsData = data.vehicleStats || [];
            if (data.trackPresets) trackPresetsFromServer = data.trackPresets;
            // Îã§ÏãúÎ≥¥Í∏∞ Ïïà ÌïòÍ≥† ÎÑòÏñ¥Í∞Ñ Í≤ΩÏö∞ Î≥¥Í¥Ä Î©îÏãúÏßÄ Ï¶âÏãú ÌëúÏãú
            if (pendingRaceResultMessages.length > 0) {
                pendingRaceResultMessages.forEach(msg => {
                    ChatModule.displayChatMessage(msg);
                });
                pendingRaceResultMessages = [];
            }
            currentTrackLength = data.trackLength || 'medium';
            currentTrackDistanceMeters = data.trackDistanceMeters || 500;
            
            addDebugLog(`Îßê ÏÑ†ÌÉù Ï§ÄÎπÑ: ${availableHorses.length}ÎßàÎ¶¨`, 'selection');
            
            mySelectedHorse = userHorseBets[currentUser] !== undefined ? userHorseBets[currentUser] : null;
            
            // Í≤∞Í≥º Ïò§Î≤ÑÎ†àÏù¥ Ïà®Í∏∞Í∏∞
            const resultOverlay = document.getElementById('resultOverlay');
            if (resultOverlay) {
                resultOverlay.classList.remove('visible');
            }
            
            // Îßê ÏÑ†ÌÉù ÏÑπÏÖò ÌëúÏãú
            const horseSelectionSection = document.getElementById('horseSelectionSection');
            if (horseSelectionSection) {
                horseSelectionSection.classList.add('active');
                console.log('[horseSelectionReady] ÏÑπÏÖò ÌôúÏÑ±ÌôîÎê®');
            } else {
                console.error('[horseSelectionReady] horseSelectionSection ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
            }
            
            // ALL_VEHICLESÍ∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏúºÎ©¥ Î®ºÏ†Ä Î°úÎìú
            if (ALL_VEHICLES.length === 0) {
                addDebugLog('ALL_VEHICLESÍ∞Ä ÎπÑÏñ¥ÏûàÏùå, Î°úÎìú ÏãúÏûë...', 'warn');
                await loadVehicleThemes();
                addDebugLog(`Î°úÎìú ÏôÑÎ£å: ${ALL_VEHICLES.length}Í∞ú`, 'info');
            }
            
            console.log('[horseSelectionReady] renderHorseSelection Ìò∏Ï∂ú Ï†Ñ:', {
                availableHorses: availableHorses.length,
                ALL_VEHICLES: ALL_VEHICLES.length,
                selectedVehicleTypes: selectedVehicleTypes,
                userHorseBets: Object.keys(userHorseBets).length,
                currentUser: currentUser
            });
            
            // ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ ÌõÑ Î†åÎçîÎßÅ (DOM ÏóÖÎç∞Ïù¥Ìä∏ ÎåÄÍ∏∞)
            setTimeout(() => {
                renderHorseSelection();
            }, 100);
            
        });

        // Ìä∏Îûô Í∏∏Ïù¥ Î≥ÄÍ≤Ω Ïù¥Î≤§Ìä∏
        socket.on('trackLengthChanged', (data) => {
            currentTrackLength = data.trackLength || 'medium';
            currentTrackDistanceMeters = data.trackDistanceMeters || 500;
            if (data.trackPresets) trackPresetsFromServer = data.trackPresets;
            // Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            const tColors = { short: '#4ade80', medium: '#60a5fa', long: '#fbbf24' };
            document.querySelectorAll('.track-length-btn').forEach(btn => {
                const key = btn.dataset.length;
                const isActive = key === currentTrackLength;
                btn.style.background = isActive ? tColors[key] : '#333';
                btn.style.color = isActive ? '#000' : '#ccc';
                btn.style.boxShadow = isActive ? `0 0 8px ${tColors[key]}80` : 'none';
                if (trackPresetsFromServer[key]) {
                    const labels = { short: 'ÏßßÍ≤å', medium: 'Î≥¥ÌÜµ', long: 'Í∏∏Í≤å' };
                    btn.textContent = `${labels[key]} (${trackPresetsFromServer[key]}m)`;
                }
            });
            // Ìä∏Îûô Í∏∏Ïù¥ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
            const trackLengthInfo = document.getElementById('trackLengthInfo');
            if (trackLengthInfo) {
                trackLengthInfo.textContent = `${currentTrackDistanceMeters}m`;
            }
            // Îßê ÏÑ†ÌÉù UI Ïû¨Î†åÎçîÎßÅ (Ìä∏Îûô ÌëúÏãú Í∞±Ïã†)
            renderHorseSelection();
        });

        // Îßê ÏÑ†ÌÉù ÏôÑÎ£å Ïù¥Î≤§Ìä∏
        socket.on('horseSelected', (data) => {
            userHorseBets = data.userHorseBets || {};
            
            if (data.userName === currentUser) {
                const previousSelection = mySelectedHorse;
                mySelectedHorse = data.horseIndex;

                // ÌÉàÍ≤É ÏÑ†ÌÉù Ïãú ÏûêÎèô Ï§ÄÎπÑ
                if (mySelectedHorse !== null && !isReady) {
                    toggleReady();
                } else if (mySelectedHorse === null && isReady) {
                    // ÏÑ†ÌÉù Ï∑®ÏÜå Ïãú Ï§ÄÎπÑ Ìï¥Ï†ú
                    toggleReady();
                }
            }
            
            renderHorseSelection();
        });

        // Îßê ÏÑ†ÌÉù ÌòÑÌô© ÏóÖÎç∞Ïù¥Ìä∏ Ïù¥Î≤§Ìä∏ (Îã§Î•∏ ÏÇ¨Ïö©Ïûê ÏÑ†ÌÉù Ïãú)
        socket.on('horseSelectionUpdated', (data) => {
            // Î≥∏Ïù∏ ÏÑ†ÌÉùÎßå Ï†ÄÏû• (ÏÑúÎ≤ÑÏóêÏÑú Î≥∏Ïù∏ Í≤ÉÎßå Ï†ÑÏÜ°Îê®)
            userHorseBets = data.userHorseBets || {};

            // ÏÑ†ÌÉù ÏôÑÎ£åÏûê Î™©Î°ù Ï†ÄÏû• (Ïñ¥Îñ§ ÌÉàÍ≤ÉÏù∏ÏßÄÎäî Î™®Î¶Ñ, Ïù¥Î¶ÑÎßå)
            selectedUsersFromServer = data.selectedUsers || [];

            const selectedCount = selectedUsersFromServer.length;
            addDebugLog(`Îßê ÏÑ†ÌÉù ÏóÖÎç∞Ïù¥Ìä∏: ${selectedCount}Î™Ö ÏÑ†ÌÉù`, 'selection');

            // ÎÇ¥ ÏÑ†ÌÉù ÏÉÅÌÉú ÌôïÏù∏ (ÏÑ†ÌÉù Ï∑®ÏÜå Ïãú undefinedÍ∞Ä Îê† Ïàò ÏûàÏùå)
            if (userHorseBets[currentUser] !== undefined) {
                mySelectedHorse = userHorseBets[currentUser];
            } else {
                mySelectedHorse = null; // ÏÑ†ÌÉù Ï∑®ÏÜå
            }

            renderHorseSelection();
        });

        // Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ Ïù¥Î≤§Ìä∏ (3,2,1 - Ïù¥ÎØ∏ Í≤åÏûÑ ÏãúÏûë)
        let missedAtCountdown = false;
        socket.on('horseRaceCountdown', (data) => {
            addDebugLog(`Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ ÏãúÏûë: ${data.duration}Ï¥à`, 'race');

            // Î™®Î∞îÏùº ÏÇ¨Ïö©ÏûêÏóêÍ≤å Í≤ΩÍ≥† Î©îÏãúÏßÄ ÌëúÏãú
            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                ChatModule.displayChatMessage({
                    userName: 'ÏãúÏä§ÌÖú',
                    message: 'üì± Î™®Î∞îÏùº ÌôòÍ≤ΩÏóêÏÑúÎäî Í≤ΩÎßà ÌôîÎ©¥Ïù¥ ÏõêÌôúÌïòÏßÄ ÏïäÏùÑ Ïàò ÏûàÏäµÎãàÎã§. PC ÌôòÍ≤ΩÏùÑ Í∂åÏû•Ìï©ÎãàÎã§!',
                    isSystem: true
                });
            }

            // Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ ÏãúÏ†êÏóê visibility Ï≤¥ÌÅ¨ (ÌÉ≠Ïù¥ Î≥¥Ïù¥Î©¥ OK)
            const isVisible = document.visibilityState === 'visible';

            // Ï¥àÍ∏∞ ÏÉÅÌÉú ÏÑ§Ï†ï: ÌÉ≠Ïù¥ Î≥¥Ïù¥Î©¥ false, Ïà®Í≤®Ï†∏ ÏûàÏúºÎ©¥ true
            missedAtCountdown = !isVisible;

            if (missedAtCountdown) {
                addDebugLog(`‚ö†Ô∏è Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ Ïãú ÌôîÎ©¥ NOT visible ‚Üí Î≥µÍ∑Ä ÎåÄÍ∏∞`, 'visibility');
            }

            // Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ Ï§ë ÌÉ≠ Î≥µÍ∑Ä Í∞êÏßÄ (Í∏∞Ï°¥ Î¶¨Ïä§ÎÑà Ï†ïÎ¶¨)
            if (countdownVisibilityHandler) {
                document.removeEventListener('visibilitychange', countdownVisibilityHandler);
            }
            countdownVisibilityHandler = () => {
                if (document.visibilityState === 'visible') {
                    missedAtCountdown = false;
                    addDebugLog('‚úÖ Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ Ï§ë ÌÉ≠ Î≥µÍ∑Ä ‚Üí Í≤ΩÏ£º ÎÜìÏπ® Ìï¥Ï†ú', 'visibility');
                }
            };
            document.addEventListener('visibilitychange', countdownVisibilityHandler);

            // ÏÇ¨Ïö¥Îìú: Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ + Í¥ÄÏ§ë ÏõÖÏÑ±Í±∞Î¶º ÏãúÏûë (Ï†ÄÎ≥ºÎ•®)
            if (window.SoundManager) {
                SoundManager.playSound('horse-race_countdown', getHorseSoundEnabled());
                SoundManager.playLoop('horse-race_crowd', getHorseSoundEnabled(), 0.2);
            }
            // Îã§ÏãúÎ≥¥Í∏∞/Í≤åÏûÑÏ¢ÖÎ£å ÏÑπÏÖò Ïà®Í∏∞Í∏∞
            document.getElementById('replaySection').style.display = 'none';
            document.getElementById('endGameSection').style.display = 'none';
            showCountdown();
        });

        // Í≤ΩÏ£º ÏãúÏûë Ïù¥Î≤§Ìä∏
        socket.on('horseRaceStarted', (data) => {
            // Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ Ï§ë Î≥µÍ∑Ä Í∞êÏßÄ Î¶¨Ïä§ÎÑà Ï†ïÎ¶¨
            if (countdownVisibilityHandler) {
                document.removeEventListener('visibilitychange', countdownVisibilityHandler);
                document.removeEventListener('focus', countdownVisibilityHandler);
                countdownVisibilityHandler = null;
            }

            // Ï°∞Í±¥ ÏôÑÌôî: Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ ÌïúÎ≤àÏù¥ÎùºÎèÑ Î¥§Í±∞ÎÇò OR Ï∂úÎ∞ú ÏãúÏ†êÏóê Î≥¥Í≥† ÏûàÏúºÎ©¥ OK
            const isVisible = document.visibilityState === 'visible';
            const isActuallyVisible = !missedAtCountdown || isVisible;

            addDebugLog(`üì® horseRaceStarted Ïù¥Î≤§Ìä∏ ÏàòÏã† - visible: ${isVisible}, missedAtCountdown: ${missedAtCountdown}`, 'info');

            // ÎßàÏßÄÎßâ Í≤ΩÏ£º Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• (Îã§ÏãúÎ≥¥Í∏∞Ïö©)
            lastHorseRaceData = data;
            window._slowMotionConfig = data.slowMotionConfig || null;

            // Îã§ÏãúÎ≥¥Í∏∞ ÏÑπÏÖò Ïà®Í∏∞Í∏∞ (ÏÉà Í≤ΩÏ£º ÏãúÏûë Ïãú)
            document.getElementById('horseReplaySection').style.display = 'none';

            // Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ Îïå ÌôîÎ©¥ÏùÑ Î≥¥Í≥† ÏûàÏßÄ ÏïäÏïòÏúºÎ©¥ Í≤ΩÏ£º Î¨¥Ïãú
            if (!isActuallyVisible) {
                addDebugLog(`‚ö†Ô∏è Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ Ïãú ÌôîÎ©¥ NOT visible ‚Üí Í≤ΩÏ£º Î¨¥Ïãú, Îã§ÏãúÎ≥¥Í∏∞ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•`, 'visibility');

                missedHorseRace = true;
                missedAtCountdown = false; // Î¶¨ÏÖã
                isRaceActive = false;

                // ÏÇ¨Ïö¥Îìú Ï†ïÏßÄ (Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ÏóêÏÑú ÏãúÏûëÎêú Í¥ÄÏ§ë ÏÜåÎ¶¨)
                if (window.SoundManager) {
                    SoundManager.stopLoop('horse-race_crowd');
                }

                // Îã§ÏãúÎ≥¥Í∏∞ ÏÑπÏÖò ÌëúÏãú
                document.getElementById('horseReplaySection').style.display = 'block';
                addDebugLog('üé¨ Îã§ÏãúÎ≥¥Í∏∞ ÏÑπÏÖò ÌëúÏãú (Í≤ΩÏ£º ÎÜìÏπ®)', 'visibility');

                return;
            }
            missedAtCountdown = false; // Î¶¨ÏÖã

            // ÌôîÎ©¥ÏùÑ Î≥¥Í≥† ÏûàÏúºÎ©¥ Ï†ïÏÉÅÏ†ÅÏúºÎ°ú Í≤ΩÏ£º ÏãúÏûë
            missedHorseRace = false;
            raceResultShown = false; // ÏÉà Í≤ΩÏ£º ÏãúÏûë Ïãú Í≤∞Í≥º ÌëúÏãú ÌîåÎûòÍ∑∏ Î¶¨ÏÖã
            isRaceActive = true;
            updateStartButton(); // Í≤åÏûÑ ÏãúÏûë Ïãú Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏

            // Ï±ÑÌåÖÏóê Í≤åÏûÑ ÏãúÏûë ÏãúÏä§ÌÖú Î©îÏãúÏßÄ Ï∂îÍ∞Ä
            if (ChatModule && typeof ChatModule.displayChatMessage === 'function') {
                ChatModule.displayChatMessage({
                    message: `üèÅ Í≤ΩÏ£ºÍ∞Ä ÏãúÏûëÎêòÏóàÏäµÎãàÎã§!`,
                    isSystemMessage: true,
                    time: new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' })
                }, true);
            }

            // ÏÇ¨Ïö¥Îìú: Ï∂úÎ∞ú Ï¥ùÏÜåÎ¶¨ ‚Üí Í¥ÄÏ§ë Î≥ºÎ•® ÏóÖ + BGM ÏãúÏûë
            if (window.SoundManager) {
                SoundManager.playSound('horse-race_gunshot', getHorseSoundEnabled());
                // Í¥ÄÏ§ë Î≥ºÎ•® ÏóÖ (0.2 ‚Üí 0.7) + BGM ÏãúÏûë
                setTimeout(() => {
                    SoundManager.setVolume('horse-race_crowd', 0.7);
                    SoundManager.playLoop('horse-race_bgm', getHorseSoundEnabled(), 0.3);
                }, 300);
                // Î†àÏù¥Ïä§ Ï§ë Í¥ÄÏ§ë Î≥ºÎ•® ÏïàÏ†ïÌôî (0.7 ‚Üí 0.5)
                setTimeout(() => {
                    SoundManager.setVolume('horse-race_crowd', 0.5);
                }, 2000);
            }

            // everPlayedUsers ÏóÖÎç∞Ïù¥Ìä∏
            if (data.everPlayedUsers) {
                everPlayedUsers = [...data.everPlayedUsers];
            }

            addDebugLog(`Í≤ΩÏ£º ÏãúÏûë: ${data.horseRankings?.length || 0}ÎßàÎ¶¨`, 'race');
            
            // ÏÇ¨Ïö©Ïûê Î≤†ÌåÖ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ (Í≤ΩÏ£º Ïï†ÎãàÎ©îÏù¥ÏÖòÏóêÏÑú ÏÇ¨Ïö©)
            if (data.userHorseBets) {
                userHorseBets = data.userHorseBets;
            }
            
            // ÌÉàÍ≤É ÌÉÄÏûÖ ÎπÑÍµê (Í≤åÏûÑ ÏãúÏûë Ï†Ñ vs Í≤åÏûÑ ÏãúÏûë ÌõÑ)
            const beforeSelectedVehicleTypes = selectedVehicleTypes;
            console.log('[Í≤ΩÏ£º ÏãúÏûë] selectedVehicleTypes ÎπÑÍµê:', {
                Ïù¥Ï†Ñ: beforeSelectedVehicleTypes,
                ÏÑúÎ≤ÑÏóêÏÑú_Î∞õÏùÄ_Í∞í: data.selectedVehicleTypes,
                horseRankings: data.horseRankings,
                availableHorses: availableHorses
            });
            
            // ÌÉàÍ≤É ÌÉÄÏûÖ ÏóÖÎç∞Ïù¥Ìä∏ (ÏÑúÎ≤ÑÏóêÏÑú Ï†ÑÎã¨Îêú Í≤É ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ Í∏∞Ï°¥ Í∞í Ïú†ÏßÄ)
            if (data.selectedVehicleTypes && data.selectedVehicleTypes.length > 0) {
                // ÏÑúÎ≤ÑÏóêÏÑú Î∞õÏùÄ Í∞íÍ≥º Í∏∞Ï°¥ Í∞íÏù¥ Îã§Î•¥Î©¥ Í≤ΩÍ≥†
                if (JSON.stringify(selectedVehicleTypes) !== JSON.stringify(data.selectedVehicleTypes)) {
                    console.warn('[Í≤ΩÏ£º ÏãúÏûë] ‚ö†Ô∏è selectedVehicleTypesÍ∞Ä Î≥ÄÍ≤ΩÎê®!', {
                        Ïù¥Ï†Ñ: selectedVehicleTypes,
                        ÏÉàÎ°úÏö¥: data.selectedVehicleTypes
                    });
                }
                selectedVehicleTypes = data.selectedVehicleTypes;
                console.log('[Í≤ΩÏ£º ÏãúÏûë] selectedVehicleTypes ÏóÖÎç∞Ïù¥Ìä∏:', selectedVehicleTypes);
            } else {
                console.warn('[Í≤ΩÏ£º ÏãúÏûë] selectedVehicleTypesÍ∞Ä Ï†ÑÎã¨ÎêòÏßÄ ÏïäÏùå. Í∏∞Ï°¥ Í∞í Ïú†ÏßÄ:', selectedVehicleTypes);
            }
            
            // Îßê ÏÑ†ÌÉù ÏÑπÏÖò Ïà®Í∏∞Í∏∞
            document.getElementById('horseSelectionSection').classList.remove('active');
            
            // ÌòÑÏû¨ ÏßÑÌñâ Ï§ëÏù∏ Í≤ΩÏ£º Í∏∞Î°ù Ï†ÄÏû•
            const currentRaceRecord = data.record;

            // Í≤ΩÏ£º Ìä∏Îûô ÌëúÏãú (ÏÑúÎ≤ÑÏóêÏÑú Î∞õÏùÄ Í∏∞ÎØπ Îç∞Ïù¥ÌÑ∞ Ï†ÑÎã¨) - ÏΩúÎ∞±ÏúºÎ°ú Ï¢ÖÎ£å Ï≤òÎ¶¨
            startRaceAnimation(data.horseRankings, data.speeds, data.gimmicks, (actualFinishOrder) => {
                // ÏÇ¨Ïö¥Îìú: Í≥®Ïù∏! Í¥ÄÏ§ë ÏµúÍ≥†Ï°∞ ‚Üí ÌôòÌò∏ ‚Üí ÌéòÏù¥ÎìúÏïÑÏõÉ
                if (window.SoundManager) {
                    // Ïä¨Î°úÏö∞Î™®ÏÖò ÌôòÌò∏ÏÑ± Ï†ïÏßÄ (ÏïÑÏßÅ Ïû¨ÏÉù Ï§ëÏù¥Î©¥)
                    SoundManager.stopLoop('horse-race_slowmo_cheer');
                    // Í¥ÄÏ§ë ÌôòÌò∏ ÏµúÍ≥†Ï°∞ (1.0)
                    SoundManager.setVolume('horse-race_crowd', 1.0);
                    // BGM Ï†ïÏßÄ
                    SoundManager.stopLoop('horse-race_bgm');
                    // Ìå°ÌååÎ†à/ÌôòÌò∏ Ïû¨ÏÉù
                    SoundManager.playSound('horse-race_finish', getHorseSoundEnabled());
                    SoundManager.playSound('horse-race_cheer_burst', getHorseSoundEnabled(), 0.8);
                    // 3Ï¥à ÌõÑ Í¥ÄÏ§ë ÌéòÏù¥ÎìúÏïÑÏõÉ
                    setTimeout(() => {
                        let vol = 1.0;
                        const fadeInterval = setInterval(() => {
                            vol -= 0.1;
                            if (vol <= 0) {
                                SoundManager.stopLoop('horse-race_crowd');
                                clearInterval(fadeInterval);
                            } else {
                                SoundManager.setVolume('horse-race_crowd', vol);
                            }
                        }, 200);
                    }, 3000);
                }
                // Í≤ΩÏ£º Í∏∞Î°ùÏùÄ ÏÑúÎ≤ÑÍ∞Ä horseRaceEnded Ïù¥Î≤§Ìä∏Î°ú Ï†ÑÏÜ° (Ï§ëÎ≥µ Î∞©ÏßÄ)
                // ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏßÅÏ†ë push Ï†úÍ±∞ - Ìò∏Ïä§Ìä∏ Ï§ëÎ≥µ Î∞è ÎùºÏö¥Îìú Î≤àÌò∏ Ïò§Î•ò Ìï¥Í≤∞
                // ÏÑúÎ≤Ñ ÏàúÏúÑ Í∏∞Ï§ÄÏúºÎ°ú Í≤∞Í≥º ÌëúÏãú (Í∏∞ÎØπÏóê ÏùòÌïú Ïï†ÎãàÎ©îÏù¥ÏÖò ÏàúÏÑú Ï∞®Ïù¥ Î¨¥Ïãú)
                showRaceResult(data);

                // ÏÑúÎ≤ÑÏóê Ïï†ÎãàÎ©îÏù¥ÏÖò ÏôÑÎ£å ÏïåÎ¶º (ÏÑúÎ≤ÑÍ∞Ä Í≤∞Í≥º Î©îÏãúÏßÄ Ï†ÑÏÜ°)
                socket.emit('raceAnimationComplete');
                console.log('[Í≤ΩÎßà] Ïï†ÎãàÎ©îÏù¥ÏÖò ÏôÑÎ£å ‚Üí ÏÑúÎ≤ÑÏóê ÏïåÎ¶º Ï†ÑÏÜ°');
            }, {
                trackDistanceMeters: data.trackDistanceMeters || 500,
                weatherSchedule: data.weatherSchedule || [],
                weatherConfig: data.weatherConfig || {}
            });
            
            // Í≤åÏûÑ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            const gameStatus = document.getElementById('gameStatus');
            if (gameStatus) {
                gameStatus.textContent = 'Í≤ΩÏ£º ÏßÑÌñâ Ï§ë!';
                gameStatus.className = 'game-status playing';
                gameStatus.style.background = '#d4edda';
                gameStatus.style.color = '#155724';
            }
        });

        // Í≤ΩÏ£º Ï¢ÖÎ£å Ïù¥Î≤§Ìä∏ (ÎùºÏö¥Îìú Í≤∞Í≥º ÌõÑ ÏÑúÎ≤ÑÏóêÏÑú Î≥¥ÎÇ¥Îäî Í≤ΩÏö∞)
        socket.on('horseRaceEnded', (data) => {
            // Í≤åÏûÑ Í∏∞Î°ù ÏóÖÎç∞Ïù¥Ìä∏
            if (data.horseRaceHistory) {
                horseRaceHistory = data.horseRaceHistory;
                renderHistory();
            }

            // Îßê ÏÑ†ÌÉùÎßå Ï¥àÍ∏∞Ìôî (Ï§ÄÎπÑ ÏÉÅÌÉúÎäî ÏÑúÎ≤ÑÏùò readyUsersUpdated Ïù¥Î≤§Ìä∏Í∞Ä Ï≤òÎ¶¨)
            mySelectedHorse = null;
            // isReady ÏßÅÏ†ë Ï¥àÍ∏∞Ìôî Ï†úÍ±∞ - ÏûêÎèôÏ§ÄÎπÑ ÎåÄÏÉÅÏûêÎäî ÏÑúÎ≤ÑÍ∞Ä ÏÑ§Ï†ïÌï®
        });

        // Í≤åÏûÑ ÏôÑÏ†Ñ Î¶¨ÏÖã Ïù¥Î≤§Ìä∏ (Ìò∏Ïä§Ìä∏Í∞Ä Í≤åÏûÑ Ï¢ÖÎ£å Î≤ÑÌäºÏùÑ ÎàÑÎ•∏ Í≤ΩÏö∞)
        socket.on('horseRaceGameReset', (data) => {
            if (window.SoundManager) {
                SoundManager.stopAll();
            }

            // Í≤åÏûÑ Í∏∞Î°ù ÏóÖÎç∞Ïù¥Ìä∏
            if (data.horseRaceHistory) {
                horseRaceHistory = data.horseRaceHistory;
                renderHistory();
            }

            // Í≤∞Í≥º Ïò§Î≤ÑÎ†àÏù¥ Ïà®Í∏∞Í∏∞
            const resultOverlay = document.getElementById('resultOverlay');
            if (resultOverlay) {
                resultOverlay.classList.remove('visible');
            }

            // Îã§ÏãúÎ≥¥Í∏∞/Í≤åÏûÑÏ¢ÖÎ£å ÏÑπÏÖò Ïà®Í∏∞Í∏∞
            document.getElementById('replaySection').style.display = 'none';
            document.getElementById('endGameSection').style.display = 'none';

            // ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
            isReady = false;
            isRaceActive = false;
            mySelectedHorse = null;
            updateReadyButton();
            updateStartButton();
        });

        // Ï§ÄÎπÑ ÏÉÅÌÉú Î≥ÄÍ≤Ω
        // readyStateChanged, readyUsersUpdatedÎäî ReadyModuleÏóêÏÑú Ï≤òÎ¶¨ (initReadyModuleÏóêÏÑú Î∞îÏù∏Îî©)

        // ÏÇ¨Ïö©Ïûê Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
        socket.on('updateUsers', (users) => {
            if (window.SoundManager) SoundManager.playSound('common_notification', getHorseSoundEnabled());
            ChatModule.updateConnectedUsers(users);
            updateUsers(users);
        });

        // Í∞ïÌá¥ÎãπÌñàÏùÑ Îïå
        socket.on('kicked', (message) => {
            showCustomAlert(message, 'info');
            location.reload();
        });

        // Ìò∏Ïä§Ìä∏ Î≥ÄÍ≤Ω ÏïåÎ¶º
        socket.on('hostChanged', (data) => {
            console.log('Ìò∏Ïä§Ìä∏ Î≥ÄÍ≤Ω ÏïåÎ¶º:', data.message);
        });

        // Ï±ÑÌåÖÏùÄ ChatModuleÏóêÏÑú Ï≤òÎ¶¨ (initChatModuleÏóêÏÑú Î∞îÏù∏Îî©)

        // Ï£ºÎ¨∏Î∞õÍ∏∞ Ïù¥Î≤§Ìä∏/Ìï®ÏàòÎäî OrderModuleÏóêÏÑú Ï≤òÎ¶¨
        
        // Ïª§Ïä§ÌÖÄ ÏïåÎ¶ºÏ∞Ω
        function showCustomAlert(message, type = 'info', title = '') {
            const overlay = document.createElement('div');
            overlay.className = 'custom-alert-overlay';
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000;';
            
            const colors = {
                info: '#8b4513',
                warning: '#ffc107',
                error: '#dc3545',
                success: '#28a745'
            };
            
            const modal = document.createElement('div');
            modal.style.cssText = `background: white; padding: 25px; border-radius: 12px; max-width: 400px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); border-top: 4px solid ${colors[type] || colors.info};`;
            
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = 'ÌôïÏù∏';
            confirmBtn.style.cssText = `width: 100%; padding: 12px; background: ${colors[type] || colors.info}; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer;`;
            confirmBtn.addEventListener('click', () => overlay.remove());
            
            const contentDiv = document.createElement('div');
            if (title) {
                const titleDiv = document.createElement('div');
                titleDiv.style.cssText = `font-size: 18px; font-weight: bold; margin-bottom: 15px; color: ${colors[type] || colors.info};`;
                titleDiv.textContent = title;
                contentDiv.appendChild(titleDiv);
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = 'margin-bottom: 20px; line-height: 1.6;';
            messageDiv.innerHTML = message;
            contentDiv.appendChild(messageDiv);
            
            modal.appendChild(contentDiv);
            modal.appendChild(confirmBtn);
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.remove();
            });
        }
        
        // ÌôïÏù∏ Îã§Ïù¥ÏñºÎ°úÍ∑∏
        function showConfirmDialog(message, onConfirm) {
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000;';
            
            const modal = document.createElement('div');
            modal.style.cssText = 'background: white; padding: 25px; border-radius: 12px; max-width: 400px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);';
            
            modal.innerHTML = `
                <div style="margin-bottom: 20px; line-height: 1.6; text-align: center;">${message}</div>
                <div style="display: flex; gap: 10px;">
                    <button id="confirmCancel" style="flex: 1; padding: 12px; background: #e9ecef; color: #333; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">Ï∑®ÏÜå</button>
                    <button id="confirmOk" style="flex: 1; padding: 12px; background: #dc3545; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer;">ÌôïÏù∏</button>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            modal.querySelector('#confirmCancel').addEventListener('click', () => overlay.remove());
            modal.querySelector('#confirmOk').addEventListener('click', () => {
                overlay.remove();
                if (onConfirm) onConfirm();
            });
        }

        // ÌîåÎ†àÏù¥Ïñ¥ Ïï°ÏÖò ÏÑ†ÌÉù Îã§Ïù¥ÏñºÎ°úÍ∑∏ (Ìò∏Ïä§Ìä∏ÏûÑÎ™Ö, Ï†úÏô∏ÏãúÌÇ§Í∏∞, Ï∑®ÏÜå)
        function showPlayerActionDialog(playerName) {
            return new Promise((resolve) => {
                const existingDialog = document.getElementById('playerActionDialog');
                if (existingDialog) existingDialog.remove();

                const dialogOverlay = document.createElement('div');
                dialogOverlay.id = 'playerActionDialog';
                dialogOverlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 10002; display: flex; justify-content: center; align-items: center;';

                const dialogContent = document.createElement('div');
                dialogContent.style.cssText = 'background: white; border-radius: 16px; padding: 25px 30px; max-width: 500px; width: 90vw; box-shadow: 0 10px 40px rgba(0,0,0,0.2); border: 2px solid #8b4513;';

                const messageDiv = document.createElement('div');
                messageDiv.style.cssText = 'font-size: 18px; line-height: 1.6; color: #333; text-align: center; margin-bottom: 25px; font-weight: 600;';
                messageDiv.innerHTML = `<span style="font-size: 24px; margin-right: 8px;">üë§</span>${playerName}ÎãòÏóêÍ≤å Ïñ¥Îñ§ ÌñâÎèôÏùÑ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`;

                const buttonContainer = document.createElement('div');
                buttonContainer.style.cssText = 'display: flex; flex-direction: column; gap: 12px;';

                function createBtn(text, bg, resolveValue) {
                    const btn = document.createElement('button');
                    btn.textContent = text;
                    btn.style.cssText = `padding: 12px 25px; background: ${bg}; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;`;
                    btn.onclick = () => { dialogOverlay.remove(); document.removeEventListener('keydown', handleEsc); resolve(resolveValue); };
                    return btn;
                }

                const hostButton = createBtn('Ìò∏Ïä§Ìä∏ÏûÑÎ™Ö', 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', 'host');
                const kickButton = createBtn('Ï†úÏô∏ÏãúÌÇ§Í∏∞', 'linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)', 'kick');
                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'Ï∑®ÏÜå';
                cancelButton.style.cssText = 'padding: 12px 25px; background: #f5f5f5; color: #666; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;';
                cancelButton.onclick = () => { dialogOverlay.remove(); document.removeEventListener('keydown', handleEsc); resolve('cancel'); };

                const handleEsc = (e) => {
                    if (e.key === 'Escape') { dialogOverlay.remove(); document.removeEventListener('keydown', handleEsc); resolve('cancel'); }
                };
                document.addEventListener('keydown', handleEsc);

                dialogOverlay.onclick = (e) => {
                    if (e.target === dialogOverlay) { dialogOverlay.remove(); document.removeEventListener('keydown', handleEsc); resolve('cancel'); }
                };

                buttonContainer.appendChild(hostButton);
                buttonContainer.appendChild(kickButton);
                buttonContainer.appendChild(cancelButton);
                dialogContent.appendChild(messageDiv);
                dialogContent.appendChild(buttonContainer);
                dialogOverlay.appendChild(dialogContent);
                document.body.appendChild(dialogOverlay);
                hostButton.focus();
            });
        }

        // Í≤åÏûÑ Ï¢ÖÎ£å
        function endHorseRaceGame() {
            socket.emit('endHorseRace', {});
        }
        
        // Ïù¥Ï†Ñ Í≤åÏûÑ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú
        function clearHorseRaceData() {
            showConfirmDialog('Ïù¥Ï†Ñ Í≤åÏûÑ Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n(Í∏∞Î°ù, Ï£ºÎ¨∏ ÎÇ¥Ïó≠ Îì±Ïù¥ Ï¥àÍ∏∞ÌôîÎê©ÎãàÎã§)', () => {
                socket.emit('clearHorseRaceData');
            });
        }
        
        // Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú ÏôÑÎ£å ÏàòÏã†
        socket.on('horseRaceDataCleared', () => {
            horseRaceHistory = [];
            ordersData = {};
            isOrderActive = false;
            lastHorseRaceData = null;
            OrderModule.setOrdersData(ordersData);
            OrderModule.setIsOrderActive(false);
            renderHistory();
            OrderModule.renderOrders();

            // Îã§ÏãúÎ≥¥Í∏∞ ÏÑπÏÖò Ïà®Í∏∞Í∏∞
            const replaySection = document.getElementById('replaySection');
            if (replaySection) replaySection.style.display = 'none';
            const missedReplaySection = document.getElementById('missedReplaySection');
            if (missedReplaySection) missedReplaySection.style.display = 'none';

            // Í≤∞Í≥º Ïò§Î≤ÑÎ†àÏù¥ Ïà®Í∏∞Í∏∞
            const resultOverlay = document.getElementById('resultOverlay');
            if (resultOverlay) resultOverlay.classList.remove('visible');

            // Ìä∏Îûô Ïà®Í∏∞Í∏∞ + Ïù¥ÌéôÌä∏ Ï†ïÎ¶¨
            const trackContainer = document.getElementById('trackContainer');
            if (trackContainer) trackContainer.style.display = 'none';
            clearFinishEffects();

            showCustomAlert('Ïù¥Ï†Ñ Í≤åÏûÑ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.', 'success', '‚úÖ ÏÇ≠Ï†ú ÏôÑÎ£å');
        });

        // Í≤åÏûÑ Î™®Îìú ÏóÖÎç∞Ïù¥Ìä∏ ÏàòÏã† (Î¨¥Ï°∞Í±¥ Íº¥Îì± Ï∞æÍ∏∞)
        socket.on('horseRaceModeUpdated', (mode) => {
            horseRaceMode = mode || 'last';
        });
        
        // ÌÉàÍ≤É ÌÉÄÏûÖ ÏóÖÎç∞Ïù¥Ìä∏ ÏàòÏã†
        socket.on('vehicleTypesUpdated', (data) => {
            selectedVehicleTypes = data.vehicleTypes;
            availableHorses = data.availableHorses;
            userHorseBets = {}; // ÌÉàÍ≤É Î≥ÄÍ≤Ω Ïãú ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî
            mySelectedHorse = null;
            renderHorseSelection();
        });

        // Î∞© ÎÇòÍ∞ÄÍ∏∞
        socket.on('roomLeft', () => {
            if (roomExpiryInterval) {
                clearInterval(roomExpiryInterval);
            }
            window.location.href = '/dice-game-multiplayer.html';
        });

        socket.on('roomDeleted', (data) => {
            alert(data.message || 'Î∞©Ïù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
            if (roomExpiryInterval) {
                clearInterval(roomExpiryInterval);
            }
            window.location.href = '/dice-game-multiplayer.html';
        });

        // ÎπÑÍ≥µÍ∞ú Î∞© Ï≤¥ÌÅ¨Î∞ïÏä§ Ïù¥Î≤§Ìä∏
        document.addEventListener('DOMContentLoaded', () => {
            const privateCheckbox = document.getElementById('createRoomPrivateCheckbox');
            const passwordContainer = document.getElementById('createRoomPasswordContainer');
            
            if (privateCheckbox && passwordContainer) {
                privateCheckbox.addEventListener('change', function() {
                    passwordContainer.style.display = this.checked ? 'block' : 'none';
                    if (!this.checked) {
                        document.getElementById('createRoomPasswordInput').value = '';
                    }
                });
            }
            
            // Î≥ºÎ•® Ïª®Ìä∏Î°§ Ï¥àÍ∏∞Ìôî (Í∏∞Î≥∏ ÏùåÏÜåÍ±∞, Î≥ºÎ•® 50%)
            initVolumeFromStorage();
            updateVolumeUI();

            // SoundManagerÏóê ÎßàÏä§ÌÑ∞ Î≥ºÎ•® getter Îì±Î°ù
            if (window.SoundManager) {
                SoundManager.setMasterVolumeGetter(getHorseMasterVolume);
            }

            // ÌÉ≠ Ìè¨Ïª§Ïä§ ÏûÉÏúºÎ©¥ ÏÜåÎ¶¨ ÏùåÏÜåÍ±∞, Î≥µÍ∑ÄÌïòÎ©¥ Îã§Ïãú Ïû¨ÏÉù
            document.addEventListener('visibilitychange', function() {
                if (window.SoundManager) {
                    if (document.hidden) {
                        SoundManager.muteAll();
                    } else {
                        SoundManager.unmuteAll();
                    }
                }
            });
            window.addEventListener('blur', function() {
                if (window.SoundManager) SoundManager.muteAll();
            });
            window.addEventListener('focus', function() {
                if (window.SoundManager && document.visibilityState === 'visible') {
                    SoundManager.unmuteAll();
                }
            });

            // Î°úÎπÑ Î≥ºÎ•® Ïª®Ìä∏Î°§ Ïù¥Î≤§Ìä∏
            const volBtn1 = document.getElementById('volumeBtn');
            const volSlider1 = document.getElementById('volumeSlider');
            if (volBtn1) volBtn1.addEventListener('click', toggleMute);
            if (volSlider1) volSlider1.addEventListener('input', (e) => setMasterVolume(e.target.value));

            // Í≤åÏûÑ ÏÑπÏÖò Î≥ºÎ•® Ïª®Ìä∏Î°§ Ïù¥Î≤§Ìä∏
            const volBtn2 = document.getElementById('gameSectionVolumeBtn');
            const volSlider2 = document.getElementById('gameSectionVolumeSlider');
            if (volBtn2) volBtn2.addEventListener('click', toggleMute);
            if (volSlider2) volSlider2.addEventListener('input', (e) => setMasterVolume(e.target.value));
            
            // Ï†ÄÏû•Îêú Ïù¥Î¶Ñ Î∂àÎü¨Ïò§Í∏∞
            const savedName = localStorage.getItem('horseRaceUserName');
            if (savedName) {
                document.getElementById('globalUserNameInput').value = savedName;
            }
            
            // URL ÌååÎùºÎØ∏ÌÑ∞Î°ú Î∞© ÏÉùÏÑ±/ÏûÖÏû• ÏöîÏ≤≠Ïù¥ ÏôîÎäîÏßÄ ÌôïÏù∏
            const urlParams = new URLSearchParams(window.location.search);
            
            // Î∞© ÏÉùÏÑ± ÏöîÏ≤≠
            if (urlParams.get('createRoom') === 'true') {
                const pendingRoom = localStorage.getItem('pendingHorseRaceRoom');
                if (pendingRoom) {
                    const roomData = JSON.parse(pendingRoom);
                    localStorage.removeItem('pendingHorseRaceRoom');
                    
                    socket.on('connect', function onConnect() {
                        socket.off('connect', onConnect);
                        
                        socket.emit('createRoom', {
                            userName: roomData.userName,
                            roomName: roomData.roomName,
                            isPrivate: roomData.isPrivate,
                            password: roomData.password,
                            gameType: 'horse-race',
                            expiryHours: roomData.expiryHours,
                            blockIPPerUser: roomData.blockIPPerUser,
                            deviceId: getDeviceId()
                        });
                    });
                    
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
            
            // Î∞© ÏûÖÏû• ÏöîÏ≤≠
            if (urlParams.get('joinRoom') === 'true') {
                const pendingJoin = localStorage.getItem('pendingHorseRaceJoin');
                if (pendingJoin) {
                    const joinData = JSON.parse(pendingJoin);
                    localStorage.removeItem('pendingHorseRaceJoin');
                    
                    sessionStorage.setItem('horseRaceFromDice', 'true');
                    
                    document.getElementById('loadingScreen').style.display = 'flex';
                    document.getElementById('lobbySection').style.display = 'none';
                    
                    document.getElementById('globalUserNameInput').value = joinData.userName;
                    
                    socket.on('connect', function onJoinConnect() {
                        socket.off('connect', onJoinConnect);
                        
                        if (joinData.isPrivate) {
                            pendingRoomId = joinData.roomId;
                            pendingUserName = joinData.userName;
                            document.getElementById('passwordModal').style.display = 'flex';
                            document.getElementById('roomPasswordInput').focus();
                        } else {
                            socket.emit('joinRoom', {
                                roomId: joinData.roomId,
                                userName: joinData.userName,
                                isHost: false,
                                password: '',
                                deviceId: getDeviceId()
                            });
                        }
                    });
                    
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
        });
    </script>

    <!-- ÎîîÎ≤ÑÍ∑∏ Î°úÍ∑∏ ÏÑπÏÖò -->
    <div class="debug-log-section" id="debugLogSection" style="position: fixed; bottom: 20px; right: 20px; width: 400px; max-height: 300px; background: rgba(0, 0, 0, 0.9); color: #0f0; border-radius: 8px; padding: 15px; font-family: 'Courier New', monospace; font-size: 11px; z-index: 10000; overflow-y: auto; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #0f0; padding-bottom: 5px;">
            <div style="font-weight: bold; color: #0f0;">üêõ ÎîîÎ≤ÑÍ∑∏ Î°úÍ∑∏</div>
            <div style="display: flex; gap: 5px;">
                <button onclick="clearDebugLog()" style="background: #333; color: #0f0; border: 1px solid #0f0; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;">ÏßÄÏö∞Í∏∞</button>
                <button onclick="toggleDebugLog()" style="background: #333; color: #0f0; border: 1px solid #0f0; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;">Ïà®Í∏∞Í∏∞</button>
            </div>
        </div>
        <div id="debugLogContent" style="line-height: 1.4;"></div>
    </div>

    <script>
        // localhostÍ∞Ä ÏïÑÎãàÎ©¥ ÎîîÎ≤ÑÍ∑∏ Î°úÍ∑∏ ÏÑπÏÖò Ïà®Í∏∞Í∏∞
        if (!isLocalhost) {
            const debugLogSection = document.getElementById('debugLogSection');
            if (debugLogSection) {
                debugLogSection.style.display = 'none';
            }
        }
        
        function clearDebugLog() {
            const logContent = document.getElementById('debugLogContent');
            if (logContent) {
                logContent.innerHTML = '';
            }
        }
        
        function toggleDebugLog() {
            const logSection = document.getElementById('debugLogSection');
            if (logSection) {
                logSection.style.display = logSection.style.display === 'none' ? 'block' : 'none';
            }
        }
    </script>
</body>
</html>
