<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Google AdSense -->
    <meta name="google-adsense-account" content="ca-pub-1608259764663412">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1608259764663412" crossorigin="anonymous"></script>
    <title>LAM Horse Race ğŸ</title>

    <!-- FOUC Prevention: Always use light theme -->
    <script>
      (function() {
        // Always use light mode regardless of system preference
        document.documentElement.setAttribute('data-theme', 'light');
      })();
    </script>

    <!-- Theme Variables -->
    <link rel="stylesheet" href="/css/theme.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Yeon+Sung&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/horse-race.css">
    <style>
        /* Custom Popup Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        @keyframes slideDown {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- ë¡œë”© í™”ë©´ -->
    <div id="loadingScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--horse-gradient); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <div style="text-align: center; color: white;">
            <div style="font-size: 80px; margin-bottom: 20px; animation: bounce 1s infinite;">ğŸ</div>
            <h2 style="font-size: 24px; margin-bottom: 10px;">ë°©ì— ì…ì¥ ì¤‘...</h2>
            <p style="font-size: 16px; opacity: 0.8;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
            <div style="margin-top: 30px;">
                <div style="width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
            </div>
        </div>
    </div>

    <!-- ì´ë¦„ ì…ë ¥ (ë¡œê·¸ì¸ ì‹œ ìë™ ì„¤ì •, ìˆ¨ê¹€) -->
    <input type="hidden" id="globalUserNameInput">

    <div class="container">
        <!-- ê²Œì„ ì„¹ì…˜ -->
        <section class="game-section" id="gameSection">
            <!-- ë°© ì •ë³´ í—¤ë” (ê³µìœ  ì»¨íŠ¸ë¡¤ ë°”) -->
            <div id="controlBarMount"></div>
            <script src="/control-bar-shared.js"></script>
            <script>
                ControlBar.init({
                    gameKey: 'horse',
                    onLeave: function() { leaveRoom(); }
                });
            </script>

            <!-- ë°© í­íŒŒ ì¹´ìš´íŠ¸ë‹¤ìš´ -->
            <div class="room-expiry-section" id="roomExpirySection" style="display: none;">
                <div style="color: var(--yellow-900); font-weight: bold; font-size: 14px;">
                    â° ë°© í­íŒŒê¹Œì§€ ë‚¨ì€ ì‹œê°„: <span id="roomExpiryCountdown" style="color: var(--red-500);">--:--:--</span>
                </div>
            </div>

            <!-- ì ‘ì†ì ëª©ë¡ -->
            <div class="users-section" id="usersSection">
                <div class="users-title">
                    ğŸ‘¥ ì ‘ì†ì (<span id="usersCount">0</span>ëª…)
                    <span id="dragHint" style="display: none; font-size: 12px; color: var(--horse-accent); font-weight: normal; margin-left: 10px;">
                        ğŸ’¡ ë“œë˜ê·¸ë¡œ ì¤€ë¹„ ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </span>
                </div>
                <div class="users-list" id="usersList"></div>
            </div>

            <!-- ì¤€ë¹„ ì„¹ì…˜ -->
            <div class="ready-section" id="readySection">
                <div class="users-title" style="margin-bottom: 15px;">âœ… ì¤€ë¹„í•œ ì‚¬ëŒ (<span id="readyCount">0</span>ëª…)</div>
                <div class="users-list" id="readyUsersList">
                    <div style="color: var(--text-muted); text-align: center; padding: 10px; width: 100%;">ì•„ì§ ì¤€ë¹„í•œ ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤</div>
                </div>
            </div>

            <!-- ê²Œì„ ëª¨ë“œ: ë¬´ì¡°ê±´ ê¼´ë“± ì°¾ê¸° (ëª¨ë“œ ì„ íƒ ì œê±°) -->

            <!-- íƒˆê²ƒ ì„ íƒ ì„¹ì…˜ -->
            <div class="horse-selection-section" id="horseSelectionSection">
                <div class="users-title" style="margin-bottom: 15px;">ğŸ íƒˆê²ƒ ì„ íƒ</div>
                <div id="horseSelectionGrid" class="horse-selection-grid">
                    <!-- íƒˆê²ƒ ì„ íƒ ë²„íŠ¼ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                </div>
                <div id="horseSelectionInfo" style="text-align: center; margin-top: 15px; color: var(--text-secondary); font-size: 14px;">
                    íƒˆê²ƒì„ ì„ íƒí•´ì£¼ì„¸ìš”
                </div>
                <!-- íƒˆê²ƒ ì„ íƒ ì•ˆí•œ ì‚¬ëŒ -->
                <div id="notSelectedVehicleSection" style="display: none; margin-top: 10px; padding: 10px; background: var(--yellow-50); border-radius: 8px;">
                    <div style="font-weight: bold; color: var(--red-400); margin-bottom: 8px; font-size: 13px;">â³ ì„ íƒ ì•ˆí•œ ì‚¬ëŒ</div>
                    <div id="notSelectedVehicleList" style="display: flex; flex-wrap: wrap; gap: 5px;"></div>
                </div>
            </div>

            <!-- í˜¸ìŠ¤íŠ¸ ì»¨íŠ¸ë¡¤ -->
            <div class="host-controls" id="hostControls" style="display: none; margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button class="start-button" id="startHorseRaceButton" onclick="startHorseRace()" disabled style="flex: 1;">
                        ê²Œì„ ì‹œì‘
                    </button>
                    <button onclick="OrderModule.startOrder()" id="startOrderButton" style="flex: 1; background: linear-gradient(135deg, var(--btn-warning) 0%, var(--yellow-600) 100%); color: var(--bg-white); font-weight: 600; font-size: 16px; padding: 15px;">ì£¼ë¬¸ë°›ê¸° ì‹œì‘</button>
                    <button onclick="OrderModule.endOrder()" id="endOrderButton" style="display: none; flex: 1; background: linear-gradient(135deg, var(--btn-danger) 0%, var(--red-400) 100%); color: var(--bg-white); font-weight: 600; font-size: 16px; padding: 15px;">ì£¼ë¬¸ë°›ê¸° ì¢…ë£Œ</button>
                </div>
                <button onclick="clearHorseRaceData()" id="clearDataButton" style="width: 100%; background: linear-gradient(135deg, var(--purple-600) 0%, var(--purple-400) 100%); color: var(--bg-white); font-weight: 600; font-size: 14px; padding: 12px;">ì´ì „ ê²Œì„ ë°ì´í„° ì‚­ì œ</button>
            </div>

            <!-- ì£¼ë¬¸ë°›ê¸° ì„¹ì…˜ -->
            <div class="orders-section" id="ordersSection" style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="users-title" style="font-weight: bold; color: var(--horse-accent); font-size: 16px; margin: 0;">ğŸ” ì£¼ë¬¸ë°›ê¸°</div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="OrderModule.showOrderList()" id="showOrderListButton" style="width: auto; padding: 8px 16px; font-size: 14px; background: var(--horse-gradient); color: var(--text-primary); font-weight: 600;">ğŸ“‹ ì£¼ë¬¸ë¦¬ìŠ¤íŠ¸</button>
                        <button onclick="OrderModule.sortOrders('asc')" class="sort-btn" style="padding: 6px 10px; font-size: 12px; background: var(--horse-600); color: var(--text-primary); border: none; border-radius: 4px; cursor: pointer;">ê°€ë‚˜ë‹¤ìˆœ</button>
                        <button onclick="OrderModule.sortOrders('count')" class="sort-btn" style="padding: 6px 10px; font-size: 12px; background: var(--horse-600); color: var(--text-primary); border: none; border-radius: 4px; cursor: pointer;">ì£¼ë¬¸ ë§ì€ ìˆœ</button>
                    </div>
                </div>
                
                <!-- ì£¼ë¬¸í•˜ì§€ ì•Šì€ ì‚¬ëŒ ëª©ë¡ -->
                <div id="notOrderedSection" style="display: none; margin-bottom: 10px; padding: 10px; background: var(--yellow-50); border-radius: 8px;">
                    <div style="font-weight: bold; color: var(--red-400); margin-bottom: 8px; font-size: 13px;">â³ ì£¼ë¬¸í•˜ì§€ ì•Šì€ ì‚¬ëŒ</div>
                    <div id="notOrderedList" style="display: flex; flex-wrap: wrap; gap: 5px;"></div>
                </div>
                
                <!-- ë‚´ ì£¼ë¬¸ ì…ë ¥ -->
                <div style="background: var(--yellow-50); border: 2px solid var(--yellow-500); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="font-size: 16px; font-weight: 600; color: var(--yellow-900); margin-bottom: 10px; display: flex; align-items: center; gap: 8px; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span>ğŸ“</span>
                            <span>ë‚´ ì£¼ë¬¸</span>
                        </div>
                        <button onclick="OrderModule.toggleMenuManager()" style="width: auto; padding: 6px 12px; font-size: 12px; background: var(--bg-primary); color: var(--horse-accent); border: 1px solid var(--horse-500); border-radius: 4px; cursor: pointer;">ë©”ë‰´ ê´€ë¦¬</button>
                    </div>
                    
                    <!-- ìì£¼ ì“°ëŠ” ë©”ë‰´ ê´€ë¦¬ -->
                    <div id="menuManager" style="display: none; background: var(--bg-primary); border: 2px solid var(--horse-500); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="font-weight: bold; color: var(--horse-accent);">ğŸ“‹ ìì£¼ ì“°ëŠ” ë©”ë‰´</span>
                            <button onclick="OrderModule.toggleMenuManager()" style="padding: 4px 8px; font-size: 12px; background: var(--btn-danger); color: white; border: none; border-radius: 4px; cursor: pointer;">ë‹«ê¸°</button>
                        </div>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" id="newMenuInput" placeholder="ìƒˆ ë©”ë‰´ ì…ë ¥" maxlength="50" style="flex: 1; padding: 8px; border: 1px solid var(--gray-300); border-radius: 4px;">
                            <button onclick="OrderModule.addMenu()" style="padding: 8px 16px; background: var(--horse-500); color: white; border: none; border-radius: 4px; cursor: pointer;">ì¶”ê°€</button>
                        </div>
                        <div id="menuList" style="display: flex; flex-wrap: wrap; gap: 8px; max-height: 100px; overflow-y: auto;">
                            <div style="color: var(--text-muted); text-align: center; padding: 10px;">ë“±ë¡ëœ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                        </div>
                    </div>
                    
                    <div class="order-input-group">
                        <div class="order-input-wrapper">
                            <div class="autocomplete-suggestion" id="autocompleteSuggestion"></div>
                            <input type="text" id="myOrderInput" placeholder="ì£¼ë¬¸í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="100" disabled>
                            <div class="autocomplete-dropdown" id="autocompleteDropdown" style="display: none;"></div>
                        </div>
                        <button onclick="OrderModule.updateMyOrder()" id="orderSaveButton" style="width: auto; padding: 12px 20px; height: fit-content; margin: 0; color: var(--text-primary); font-weight: 600;" disabled>ì €ì¥</button>
                    </div>
                </div>

                <!-- ì „ì²´ ì£¼ë¬¸ ëª©ë¡ -->
                <div id="orderList" style="background: var(--bg-primary); border-radius: 8px; padding: 12px; max-height: 200px; overflow-y: auto;">
                    <div style="color: var(--text-muted); text-align: center; padding: 10px;">ì•„ì§ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤</div>
                </div>
                <!-- ê´€ì „ì ì£¼ë¬¸ -->
                <div id="spectatorOrdersSection" style="display: none; margin-top: 10px;">
                    <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 5px;">ê´€ì „ì ì£¼ë¬¸</div>
                    <div id="spectatorOrderList" style="background: var(--bg-primary); border-radius: 8px; padding: 12px;"></div>
                </div>
            </div>
            
            <!-- ê²Œì„ ìƒíƒœ í‘œì‹œ -->
            <div class="game-status waiting" id="gameStatus" style="padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; margin-bottom: 20px; background: var(--gray-100); color: var(--gray-700);">
                ëŒ€ê¸° ì¤‘...
            </div>

            <!-- ê²½ì£¼ íŠ¸ë™ ë˜í¼ (ì¹´ë©”ë¼ ë²„íŠ¼ + íŠ¸ë™) -->
            <div id="raceTrackWrapper" style="position: relative; display: none;">
                <!-- ì¹´ë©”ë¼ ì „í™˜ ë²„íŠ¼ (íŠ¸ë™ ë°”ê¹¥ ìš°ìƒë‹¨) -->
                <button id="cameraSwitchBtn" style="display: none; position: absolute; top: -32px; right: 0; z-index: 10; padding: 4px 10px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.3); background: rgba(0,0,0,0.65); color: var(--bg-white); font-size: 11px; cursor: pointer; font-family: 'Jua', sans-serif;">ğŸ“· ì‹œìŠ¤í…œ ì¹´ë©”ë¼</button>
                <div class="race-track-container" id="raceTrackContainer" style="position: relative;">
                    <div class="race-track" id="raceTrack">
                    <!-- ë§ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                </div>
                <!-- ë¯¸ë‹ˆë§µ -->
                <div id="raceMinimap" style="display: none; position: absolute; bottom: 8px; right: 8px; width: 180px; background: rgba(0,0,0,0.75); border-radius: 8px; padding: 8px 10px; z-index: 100; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.15);">
                    <div style="font-size: 9px; color: rgba(255,255,255,0.8); margin-bottom: 4px; text-align: center;">TRACK MAP</div>
                    <div id="minimapTrack" style="position: relative; width: 100%; height: 6px; background: rgba(255,255,255,0.15); border-radius: 3px; margin-bottom: 2px;">
                        <!-- ê±°ë¦¬ ë§ˆì»¤ + ë§ ìœ„ì¹˜ ë™ì  ìƒì„± -->
                    </div>
                    <div id="minimapMarkers" style="position: relative; width: 100%; height: 10px;">
                        <!-- ê±°ë¦¬ í…ìŠ¤íŠ¸ -->
                    </div>
                    <div id="minimapDots" style="position: relative; width: 100%; min-height: 14px; margin-top: 2px;">
                        <!-- ë§ ì•„ì´ì½˜ ë²”ë¡€ -->
                    </div>
                </div>
                </div>
                <!-- ë ˆì´ìŠ¤ ì¤‘ ì±„íŒ… ì˜¤ë²„ë ˆì´ -->
                <div id="raceChatOverlay"></div>
            </div>

            <!-- ë‹¤ì‹œë³´ê¸° + GIF ì €ì¥ + ê²Œì„ ì¢…ë£Œ ë²„íŠ¼ (ê²°ê³¼ í›„ í‘œì‹œ) -->
            <div id="replaySection" style="display: none; text-align: center; margin-top: 20px;">
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button id="mainReplayButton" onclick="playLastReplay()" style="flex: 1; padding: 12px; font-size: 15px; background: linear-gradient(135deg, var(--red-400) 0%, var(--yellow-300) 100%); color: #333333; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(255, 107, 107, 0.4); font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">ğŸ¬ ë‹¤ì‹œë³´ê¸°</button>
                    <!-- GIF ê¸°ëŠ¥ ìˆ¨ê¹€ (CORS ì´ìŠˆ) -->
                    <button id="gifSaveButton" onclick="showGifOptionsModal()" style="display: none; flex: 1; padding: 12px; font-size: 15px; background: linear-gradient(135deg, var(--green-400) 0%, var(--green-600) 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(76, 175, 80, 0.4); font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">ğŸ“¹ GIF ì €ì¥</button>
                </div>
            </div>
            <div id="endGameSection" style="display: none; text-align: center; margin-top: 10px;">
                <button class="end-button" onclick="endHorseRaceGame()">ğŸ ê²Œì„ ì¢…ë£Œ</button>
            </div>

            <!-- ë‹¤ì‹œë³´ê¸° ë²„íŠ¼ (í™”ë©´ ìˆ¨ê¹€ ìƒíƒœì—ì„œ ê²½ì£¼ê°€ ì§„í–‰ëœ ê²½ìš° í‘œì‹œ) -->
            <div id="horseReplaySection" style="display: none; text-align: center; margin-top: 20px; padding: 15px; background: linear-gradient(135deg, var(--horse-500) 0%, var(--horse-600) 100%); border-radius: 12px; box-shadow: 0 4px 15px rgba(139, 69, 19, 0.4);">
                <div style="color: white; margin-bottom: 12px; font-size: 14px; font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                    ğŸ¬ í™”ë©´ì„ ë³´ì§€ ì•ŠëŠ” ë™ì•ˆ ê²½ì£¼ê°€ ì§„í–‰ë˜ì—ˆìŠµë‹ˆë‹¤
                </div>
                <button onclick="replayMissedRace()" style="background: linear-gradient(135deg, var(--red-400) 0%, var(--yellow-300) 100%); border: none; padding: 12px 25px; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; font-size: 15px; box-shadow: 0 4px 10px rgba(255, 107, 107, 0.4); font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                    ğŸ”„ ë‹¤ì‹œë³´ê¸°
                </button>
            </div>

            <!-- ì±„íŒ… ì„¹ì…˜ -->
            <div class="chat-section">
                <div style="font-weight: bold; color: var(--horse-accent); margin-bottom: 10px; font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">ğŸ’¬ ì±„íŒ…</div>
                <div class="chat-messages" id="chatMessages"></div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." style="flex: 1; margin: 0;" onkeypress="handleChatKeypress(event)">
                    <button onclick="sendMessage()" style="width: auto; padding: 10px 20px; color: var(--text-primary); font-weight: 600;">ì „ì†¡</button>
                </div>
            </div>
        </section>
    </div>

    <!-- ê¸°ë¡ ì„¹ì…˜ -->
    <div class="history-section" id="historySection">
        <div class="history-title">ğŸ“œ ê²Œì„ ê¸°ë¡</div>
        <div id="historyList"></div>
        
        <!-- ì‹¤ì‹œê°„ ìˆœìœ„ íŒ¨ë„ (ê²Œì„ ê¸°ë¡ í•˜ë‹¨) -->
        <div id="liveRankingPanel" style="display: none; background: linear-gradient(135deg, var(--slate-950) 0%, var(--slate-960) 100%); color: white; padding: 12px 15px; border-radius: 10px; margin-top: 15px; font-size: 13px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
            <div style="font-weight: bold; margin-bottom: 10px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 8px; font-size: 14px; font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">ğŸƒ ì‹¤ì‹œê°„ ìˆœìœ„</div>
            <div id="liveRankingList"></div>
        </div>
    </div>

    <!-- ê²°ê³¼ ì˜¤ë²„ë ˆì´ -->
    <div class="result-overlay" id="resultOverlay">
        <div class="result-card">
            <div class="result-title">ğŸŠ ìˆœìœ„ ë°œí‘œ ğŸŠ</div>
            <div id="resultRankings" style="margin-bottom: 20px;"></div>
            <button onclick="closeResultOverlay()" style="width: auto; padding: 12px 30px; color: var(--text-primary); font-weight: 600;">í™•ì¸</button>
        </div>
    </div>

    <!-- ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ëª¨ë‹¬ -->
    <div id="passwordModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%;">
            <h3 style="color: var(--horse-accent); margin-bottom: 15px;">ğŸ”’ ë¹„ê³µê°œ ë°©</h3>
            <p style="margin-bottom: 15px; color: var(--text-secondary);">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
            <input type="password" id="roomPasswordInput" placeholder="ë¹„ë°€ë²ˆí˜¸" style="margin-bottom: 15px;">
            <div style="display: flex; gap: 10px;">
                <button onclick="closePasswordModal()" style="background: var(--btn-neutral); flex: 1; color: var(--text-primary); font-weight: 600;">ì·¨ì†Œ</button>
                <button onclick="submitPassword()" style="flex: 1; color: var(--text-primary); font-weight: 600;">ì…ì¥</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/page-history-shared.js"></script>
    <script src="/chat-shared.js"></script>
    <script src="/ready-shared.js"></script>
    <script src="/order-shared.js"></script>
    <script src="/ranking-shared.js"></script>
    <script src="/assets/sounds/sound-manager.js"></script>
    <!-- <script src="/gif-recorder.js"></script> GIF ê¸°ëŠ¥ ë¹„í™œì„±í™” -->
    <script src="/js/horse-race-sprites.js"></script>
    <script src="/js/horse-race.js"></script>

    <script>
        // ============================================
        // Custom Popup Functions
        // ============================================

        // ì»¤ìŠ¤í…€ ì–¼ëŸ¿ í•¨ìˆ˜
        function showCustomAlert(message, type = 'info') {
            const existingAlert = document.getElementById('customAlert');
            if (existingAlert) {
                existingAlert.remove();
            }

            let borderColor, icon;
            switch(type) {
                case 'error':
                    borderColor = 'rgb(239, 68, 68)';
                    icon = 'âš ï¸';
                    break;
                case 'warning':
                    borderColor = 'rgb(234, 179, 8)';
                    icon = 'âš ï¸';
                    break;
                case 'success':
                    borderColor = 'rgb(34, 197, 94)';
                    icon = 'âœ…';
                    break;
                default:
                    borderColor = 'rgb(147, 51, 234)';
                    icon = 'â„¹ï¸';
            }

            const alertOverlay = document.createElement('div');
            alertOverlay.id = 'customAlert';
            alertOverlay.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.4); z-index: 10001;
                display: flex; justify-content: center; align-items: center;
                animation: fadeIn 0.2s ease-out;
            `;

            const alertContent = document.createElement('div');
            alertContent.style.cssText = `
                background: white; border-radius: 16px; padding: 20px;
                max-width: 450px; width: calc(100vw - 40px);
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
                border: 2px solid ${borderColor};
                animation: slideDown 0.3s ease-out;
                box-sizing: border-box;
            `;

            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                font-size: 15px; line-height: 1.6; color: rgb(17, 24, 39);
                white-space: pre-wrap; word-wrap: break-word;
                word-break: keep-all; overflow-wrap: break-word;
                text-align: center; margin-bottom: 20px;
                max-width: 100%;
            `;
            messageDiv.innerHTML = `<span style="font-size: 24px; margin-right: 8px;">${icon}</span>${message}`;

            const confirmButton = document.createElement('button');
            confirmButton.textContent = 'í™•ì¸';
            confirmButton.style.cssText = `
                padding: 10px 30px;
                background: linear-gradient(135deg, ${borderColor} 0%, ${borderColor}dd 100%);
                color: white; border: none; border-radius: 8px;
                font-size: 16px; font-weight: 600; cursor: pointer;
                width: 100%; transition: transform 0.1s, box-shadow 0.1s;
            `;
            confirmButton.onmouseenter = () => { confirmButton.style.transform = 'scale(1.02)'; confirmButton.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)'; };
            confirmButton.onmouseleave = () => { confirmButton.style.transform = 'scale(1)'; confirmButton.style.boxShadow = 'none'; };
            confirmButton.onclick = () => { alertOverlay.style.animation = 'fadeOut 0.2s ease-out'; setTimeout(() => alertOverlay.remove(), 200); };

            const handleEsc = (e) => {
                if (e.key === 'Escape') {
                    alertOverlay.style.animation = 'fadeOut 0.2s ease-out';
                    setTimeout(() => { alertOverlay.remove(); document.removeEventListener('keydown', handleEsc); }, 200);
                }
            };
            document.addEventListener('keydown', handleEsc);

            alertOverlay.onclick = (e) => {
                if (e.target === alertOverlay) {
                    alertOverlay.style.animation = 'fadeOut 0.2s ease-out';
                    setTimeout(() => { alertOverlay.remove(); document.removeEventListener('keydown', handleEsc); }, 200);
                }
            };

            alertContent.appendChild(messageDiv);
            alertContent.appendChild(confirmButton);
            alertOverlay.appendChild(alertContent);
            document.body.appendChild(alertOverlay);
            confirmButton.focus();
        }

        // ì»¤ìŠ¤í…€ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸
        function showCustomConfirm(message, type = 'warning') {
            return new Promise((resolve) => {
                const existingConfirm = document.getElementById('customConfirm');
                if (existingConfirm) { existingConfirm.remove(); }

                let borderColor, icon;
                switch(type) {
                    case 'error': borderColor = 'rgb(239, 68, 68)'; icon = 'âš ï¸'; break;
                    case 'warning': borderColor = 'rgb(234, 179, 8)'; icon = 'âš ï¸'; break;
                    case 'success': borderColor = 'rgb(34, 197, 94)'; icon = 'âœ…'; break;
                    default: borderColor = 'rgb(147, 51, 234)'; icon = 'â„¹ï¸';
                }

                const confirmOverlay = document.createElement('div');
                confirmOverlay.id = 'customConfirm';
                confirmOverlay.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0, 0, 0, 0.4); z-index: 10002;
                    display: flex; justify-content: center; align-items: center;
                    animation: fadeIn 0.2s ease-out;
                `;

                const confirmContent = document.createElement('div');
                confirmContent.style.cssText = `
                    background: white; border-radius: 16px; padding: 20px;
                    max-width: 450px; width: calc(100vw - 40px);
                    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
                    border: 2px solid ${borderColor};
                    animation: slideDown 0.3s ease-out;
                    box-sizing: border-box;
                `;

                const messageDiv = document.createElement('div');
                messageDiv.style.cssText = `
                    font-size: 15px; line-height: 1.6; color: rgb(17, 24, 39);
                    white-space: pre-wrap; word-wrap: break-word;
                    word-break: keep-all; overflow-wrap: break-word;
                    text-align: center; margin-bottom: 25px;
                    max-width: 100%;
                `;
                messageDiv.innerHTML = `<span style="font-size: 24px; margin-right: 8px;">${icon}</span>${message}`;

                const buttonContainer = document.createElement('div');
                buttonContainer.style.cssText = `display: flex; gap: 10px; justify-content: center;`;

                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'ì·¨ì†Œ';
                cancelButton.style.cssText = `
                    padding: 10px 25px; background: rgb(243, 244, 246); color: rgb(107, 114, 128);
                    border: 1px solid rgb(209, 213, 219); border-radius: 8px; font-size: 16px;
                    font-weight: 600; cursor: pointer; transition: transform 0.1s, box-shadow 0.1s; flex: 1;
                `;
                cancelButton.onmouseenter = () => { cancelButton.style.transform = 'scale(1.02)'; };
                cancelButton.onmouseleave = () => { cancelButton.style.transform = 'scale(1)'; };
                cancelButton.onclick = () => { confirmOverlay.style.animation = 'fadeOut 0.2s ease-out'; setTimeout(() => { confirmOverlay.remove(); resolve(false); }, 200); };

                const confirmButton = document.createElement('button');
                confirmButton.textContent = 'í™•ì¸';
                confirmButton.style.cssText = `
                    padding: 10px 25px; background: linear-gradient(135deg, ${borderColor} 0%, ${borderColor}dd 100%);
                    color: white; border: none; border-radius: 8px; font-size: 16px;
                    font-weight: 600; cursor: pointer; transition: transform 0.1s, box-shadow 0.1s; flex: 1;
                `;
                confirmButton.onmouseenter = () => { confirmButton.style.transform = 'scale(1.02)'; confirmButton.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)'; };
                confirmButton.onmouseleave = () => { confirmButton.style.transform = 'scale(1)'; confirmButton.style.boxShadow = 'none'; };
                confirmButton.onclick = () => { confirmOverlay.style.animation = 'fadeOut 0.2s ease-out'; setTimeout(() => { confirmOverlay.remove(); resolve(true); }, 200); };

                const handleEsc = (e) => {
                    if (e.key === 'Escape') {
                        confirmOverlay.style.animation = 'fadeOut 0.2s ease-out';
                        setTimeout(() => { confirmOverlay.remove(); document.removeEventListener('keydown', handleEsc); resolve(false); }, 200);
                    }
                };
                document.addEventListener('keydown', handleEsc);

                confirmOverlay.onclick = (e) => {
                    if (e.target === confirmOverlay) {
                        confirmOverlay.style.animation = 'fadeOut 0.2s ease-out';
                        setTimeout(() => { confirmOverlay.remove(); document.removeEventListener('keydown', handleEsc); resolve(false); }, 200);
                    }
                };

                buttonContainer.appendChild(cancelButton);
                buttonContainer.appendChild(confirmButton);
                confirmContent.appendChild(messageDiv);
                confirmContent.appendChild(buttonContainer);
                confirmOverlay.appendChild(confirmContent);
                document.body.appendChild(confirmOverlay);
                confirmButton.focus();
            });
        }

        // ============================================
        // Room Control Bar Enhancement
        // ============================================

        // Room title editing
        let isEditingRoomName = false;

        document.addEventListener('DOMContentLoaded', function() {
            const roomTitleElem = document.getElementById('roomTitle');
            if (!roomTitleElem) return;

            roomTitleElem.addEventListener('click', function() {
            // Check if user is host (check global isHost from horse-race.js or room data)
            if (!window.isHost || isEditingRoomName) return;

            isEditingRoomName = true;
            const displaySpan = document.getElementById('roomNameDisplay');
            const currentName = displaySpan.textContent;
            const editIcon = this.querySelector('.edit-icon');

            // Hide icon during edit
            if (editIcon) editIcon.style.display = 'none';

            // Create input
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentName;
            input.maxLength = 30;
            input.style.cssText = 'font-size: inherit; font-weight: inherit; border: 2px solid var(--horse-accent); border-radius: 4px; padding: 4px 8px; width: 200px; background: var(--bg-white);';

            displaySpan.replaceWith(input);
            input.focus();
            input.select();

            function finishEdit() {
                const newName = input.value.trim();
                const newDisplay = document.createElement('span');
                newDisplay.id = 'roomNameDisplay';
                newDisplay.textContent = newName || currentName;

                input.replaceWith(newDisplay);
                if (editIcon) editIcon.style.display = '';
                isEditingRoomName = false;

                if (newName && newName !== currentName && window.socket) {
                    window.socket.emit('updateRoomName', { roomName: newName });
                }
            }

            input.addEventListener('blur', finishEdit);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') finishEdit();
            });
            });
        });

        // Update room title on server broadcast
        if (window.socket) {
            window.socket.on('roomNameUpdated', (data) => {
                const display = document.getElementById('roomNameDisplay');
                if (display) display.textContent = data.roomName;
            });
        }

        // Show/hide UI elements based on host status
        function updateControlBarUI(isHostUser) {
            const editIcon = document.querySelector('.edit-icon');
            const hostBadge = document.getElementById('hostBadge');
            const readyBtn = document.getElementById('readyBtn');
            const usernameDisplay = document.getElementById('usernameDisplay');

            if (editIcon) editIcon.style.display = isHostUser ? 'inline' : 'none';
            if (hostBadge) hostBadge.style.display = isHostUser ? 'inline-block' : 'none';
            if (readyBtn) readyBtn.style.display = 'inline-block';

            // Show username if available
            if (usernameDisplay && window.myUserName) {
                usernameDisplay.textContent = window.myUserName;
                usernameDisplay.style.display = 'inline-block';
            }
        }

        // Logout function
        async function logout() {
            const confirmed = await showCustomConfirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë°©ì—ì„œ ë‚˜ê°€ê³  ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.', 'warning');
            if (confirmed) {
                if (window.socket) {
                    window.socket.emit('leaveRoom');
                    window.socket.disconnect();
                }

                // Clear session
                sessionStorage.removeItem('horseActiveRoom');
                sessionStorage.removeItem('userName');

                // Redirect to main page
                location.href = '/';
            }
        }

        // Host delegation (to be implemented in user list rendering)
        async function delegateHost(targetSocketId) {
            if (!window.socket || !window.roomUsers) return;

            const targetUser = window.roomUsers.find(u => u.socketId === targetSocketId);
            if (!targetUser) return;

            const confirmed = await showCustomConfirm(`${targetUser.name}ë‹˜ì—ê²Œ í˜¸ìŠ¤íŠ¸ë¥¼ ìœ„ì„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, 'warning');
            if (confirmed) {
                window.socket.emit('delegateHost', { targetSocketId });
            }
        }

        // Listen for host delegation
        if (window.socket) {
            window.socket.on('hostDelegated', (data) => {
                window.isHost = data.newHostSocketId === window.socket.id;
                window.hostSocketId = data.newHostSocketId;

                updateControlBarUI(window.isHost);

                // Refresh user list if available
                if (typeof renderUsersList === 'function' && window.roomUsers) {
                    renderUsersList(window.roomUsers);
                }

                if (window.isHost) {
                    showCustomAlert('í˜¸ìŠ¤íŠ¸ ê¶Œí•œì„ ë°›ì•˜ìŠµë‹ˆë‹¤!', 'success');
                }
            });
        }

        // Initialize control bar on page load
        window.addEventListener('load', () => {
            // This will be called after horse-race.js loads
            if (window.socket) {
                const originalRoomJoinedHandler = window.socket._callbacks?.$roomJoined;

                window.socket.on('roomJoined', (data) => {
                    setTimeout(() => {
                        updateControlBarUI(window.isHost);
                    }, 100);
                });
            }
        });
    </script>

    <!-- ë””ë²„ê·¸ ë¡œê·¸ ì„¹ì…˜ -->
    <div class="debug-log-section" id="debugLogSection" style="position: fixed; bottom: 20px; right: 20px; width: 400px; max-height: 300px; background: rgba(0, 0, 0, 0.9); color: #0f0; border-radius: 8px; padding: 15px; font-family: 'Courier New', monospace; font-size: 11px; z-index: 10000; overflow-y: auto; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #0f0; padding-bottom: 5px;">
            <div style="font-weight: bold; color: #0f0;">ğŸ› ë””ë²„ê·¸ ë¡œê·¸</div>
            <div style="display: flex; gap: 5px;">
                <button onclick="clearDebugLog()" style="background: #333; color: #0f0; border: 1px solid #0f0; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;">ì§€ìš°ê¸°</button>
                <button onclick="toggleDebugLog()" style="background: #333; color: #0f0; border: 1px solid #0f0; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;">ìˆ¨ê¸°ê¸°</button>
            </div>
        </div>
        <div id="debugLogContent" style="line-height: 1.4;"></div>
    </div>
</body>
</html>
