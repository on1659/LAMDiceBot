<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>LAM Horse Race ğŸ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Yeon+Sung&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #8e99a4 0%, #7a8b99 50%, #6b7c8a 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            position: relative;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px auto;
        }
        
        body.lobby-active .container {
            margin-left: auto;
            margin-right: auto;
        }
        
        body.game-active .container {
            margin-left: calc((100vw - 1140px) / 2 + 160px);
            margin-right: auto;
            max-width: 800px;
        }
        
        body.game-active header,
        body.game-active footer {
            display: none;
        }

        h1 {
            text-align: center;
            color: #8b4513;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .lobby-section, .game-section, .create-room-section {
            display: none;
        }

        .lobby-section.active, .game-section.active, .create-room-section.active {
            display: block;
        }
        
        .rooms-list {
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
        }
        
        .room-item {
            background: white;
            border: 2px solid #8b4513;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .room-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 69, 19, 0.3);
        }
        
        .room-item.active {
            background: #f5e6d3;
            border-color: #8b4513;
        }
        
        .room-item.my-room {
            background: #fff3cd;
            border-color: #ffc107;
            border-width: 3px;
        }
        
        .my-room-badge {
            display: inline-block;
            background: #ffc107;
            color: #333;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .room-info {
            flex: 1;
        }
        
        .room-name {
            font-size: 18px;
            font-weight: 600;
            color: #8b4513;
            margin-bottom: 5px;
        }
        
        .room-details {
            font-size: 14px;
            color: #666;
        }
        
        .room-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            margin-top: 5px;
            display: inline-block;
        }
        
        .room-status.playing {
            background: #d4edda;
            color: #155724;
        }
        
        .room-status.waiting {
            background: #e0e0e0;
            color: #666;
        }
        
        .room-action {
            margin-left: 15px;
        }
        
        .room-action button {
            width: auto;
            padding: 10px 20px;
            color: #000;
            font-weight: 600;
        }
        
        .create-room-section {
            background: #f8f9fa;
            border: 2px solid #8b4513;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        button {
            background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%);
            color: #000;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-top: 10px;
            font-weight: 600;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(139, 69, 19, 0.3);
        }

        button:disabled {
            background: #ccc;
            color: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 10px;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus, input[type="password"]:focus {
            border-color: #8b4513;
            outline: none;
        }

        .connection-status {
            text-align: center;
            padding: 5px;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .connection-status.connected {
            color: #28a745;
        }

        .connection-status.disconnected {
            color: #dc3545;
        }

        /* ê²½ì£¼ íŠ¸ë™ ì»¨í…Œì´ë„ˆ */
        .race-track-container {
            position: relative;
            width: 100%;
            height: 400px;
            margin: 20px 0;
            overflow: hidden;
            border-radius: 12px;
            background: linear-gradient(to bottom, #87CEEB 0%, #98D8C8 50%, #7CB342 100%);
        }

        .race-track {
            position: relative;
            width: 100%;
            height: 100%;
            background-image: url('assets/backgrounds/race_track.png');
            background-repeat: repeat-x;
            background-size: auto 100%;
            background-position: 0 0;
        }

        /* Fallback: ì´ë¯¸ì§€ê°€ ì—†ì„ ê²½ìš° CSS ê·¸ë¼ë°ì´ì…˜ */
        .race-track:not([style*="background-image"]) {
            background: linear-gradient(to bottom, 
                #87CEEB 0%, 
                #87CEEB 20%,
                #98D8C8 20%,
                #98D8C8 40%,
                #7CB342 40%,
                #7CB342 60%,
                #98D8C8 60%,
                #98D8C8 80%,
                #87CEEB 80%,
                #87CEEB 100%);
        }

        /* ë§ ì»¨í…Œì´ë„ˆ */
        .horse {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            z-index: 10;
        }

        /* íƒˆê²ƒ ìŠ¤í”„ë¼ì´íŠ¸ ì• ë‹ˆë©”ì´ì…˜ - 2í”„ë ˆì„ */
        .vehicle-sprite {
            position: relative;
            width: 60px;
            height: 45px;
        }
        
        .vehicle-sprite .frame1,
        .vehicle-sprite .frame2 {
            position: absolute;
            top: 0;
            left: 0;
            width: 60px;
            height: 45px;
        }
        
        /* ì •ì§€ ìƒíƒœ: í”„ë ˆì„ 1ë§Œ ë³´ì„ */
        .vehicle-sprite .frame1 { opacity: 1; }
        .vehicle-sprite .frame2 { opacity: 0; }
        
        /* ë‹¬ë¦¬ëŠ” ìƒíƒœ: 2í”„ë ˆì„ êµì°¨ */
        @keyframes frame1Anim {
            0%, 49% { opacity: 1; }
            50%, 100% { opacity: 0; }
        }
        @keyframes frame2Anim {
            0%, 49% { opacity: 0; }
            50%, 100% { opacity: 1; }
        }
        
        .horse.racing .vehicle-sprite .frame1 { animation: frame1Anim 0.15s steps(1) infinite; }
        .horse.racing .vehicle-sprite .frame2 { animation: frame2Anim 0.15s steps(1) infinite; }
        
        /* ê²°ê³¼ ì˜¤ë²„ë ˆì´ visible ìƒíƒœ */
        .result-overlay.visible {
            display: flex !important;
        }

        /* ë§ ì„ íƒ UI */
        .horse-selection-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .horse-selection-button {
            background: white;
            border: 3px solid #8b4513;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 48px;
        }

        .horse-selection-button:hover:not(:disabled) {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(139, 69, 19, 0.3);
            border-color: #a0522d;
        }

        .horse-selection-button.selected {
            background: #f5e6d3;
            border-color: #8b4513;
            border-width: 4px;
        }

        .horse-selection-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            filter: grayscale(80%);
            background: #f0f0f0;
            border-color: #999;
        }

        /* ì¤€ë¹„ ì„¹ì…˜ */
        .ready-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #8b4513;
        }

        .users-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 50px;
        }

        .user-tag {
            background: white;
            border: 2px solid #8b4513;
            color: #8b4513;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .user-tag.host {
            background: #8b4513;
            color: white;
        }

        /* ê²Œì„ ê¸°ë¡ */
        .history-section {
            position: fixed;
            right: 20px;
            top: 20px;
            width: 320px;
            max-height: calc(100vh - 40px);
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 20px;
            overflow-y: auto;
            display: none;
        }

        .history-section.visible {
            display: block;
        }

        .history-title {
            font-size: 18px;
            font-weight: bold;
            color: #8b4513;
            margin-bottom: 15px;
            text-align: center;
        }

        .history-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #8b4513;
        }

        .history-round {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .history-participants {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .history-winner {
            font-size: 16px;
            font-weight: bold;
            color: #8b4513;
        }

        /* ì±„íŒ… ì„¹ì…˜ */
        .chat-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            border: 2px solid #8b4513;
        }

        .chat-messages {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }

        .chat-message.system {
            margin-bottom: 10px;
            padding: 12px;
            background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%);
            color: white;
            text-align: center;
            font-weight: bold;
            border-radius: 8px;
        }

        .chat-message.winner {
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
            color: #333;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            padding: 15px;
            animation: celebrate 0.5s ease-in-out infinite alternate;
            border-radius: 8px;
        }

        @keyframes celebrate {
            from { transform: scale(1); }
            to { transform: scale(1.02); }
        }

        /* ì ‘ì†ì ëª©ë¡ */
        .users-section {
            margin-bottom: 20px;
        }

        .users-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #8b4513;
        }

        /* ë°© ì •ë³´ í—¤ë” */
        .room-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .room-title {
            font-size: 24px;
            color: #8b4513;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .host-badge {
            display: none;
            background: #ffc107;
            color: #333;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        /* í˜¸ìŠ¤íŠ¸ ì»¨íŠ¸ë¡¤ */
        .host-controls {
            display: none;
            background: linear-gradient(135deg, #fff3cd 0%, #ffe082 100%);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #ffc107;
        }

        .start-button {
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
            color: #000;
            font-size: 20px;
            padding: 15px 30px;
            font-weight: 600;
        }

        .start-button:disabled {
            background: #ccc;
            color: #666;
        }

        .end-button {
            background: linear-gradient(135deg, #f44336 0%, #ff5722 100%);
            color: #000;
            font-weight: 600;
        }

        /* ê²°ê³¼ ì˜¤ë²„ë ˆì´ */
        .result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .result-overlay.visible {
            display: flex;
        }

        .result-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            animation: popup 0.5s ease-out;
        }

        @keyframes popup {
            from {
                transform: scale(0.5);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .result-title {
            font-size: 24px;
            color: #8b4513;
            margin-bottom: 20px;
        }

        .result-winner {
            font-size: 48px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }

        .result-message {
            font-size: 18px;
            color: #666;
            margin-bottom: 30px;
        }

        /* ë°© í­íŒŒ ì¹´ìš´íŠ¸ë‹¤ìš´ */
        .room-expiry-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        /* ë§ ì„ íƒ ì„¹ì…˜ */
        .horse-selection-section {
            display: none;
            background: #f8f9fa;
            border: 2px solid #8b4513;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .horse-selection-section.active {
            display: block;
        }

        /* ê²Œì„ ëª¨ë“œ ì„ íƒ */
        .game-mode-section {
            background: #f8f9fa;
            border: 2px solid #8b4513;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            body.game-active .container {
                margin-left: auto;
                margin-right: auto;
            }
            
            .history-section {
                position: static;
                width: 100%;
                max-height: none;
                margin-top: 20px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
                border-radius: 15px;
            }

            h1 {
                font-size: 1.8em;
            }

            .race-track-container {
                height: 300px;
            }

            .horse-selection-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body class="lobby-active">
    <!-- ë¡œë”© í™”ë©´ -->
    <div id="loadingScreen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center;">
        <div style="text-align: center; color: white;">
            <div style="font-size: 80px; margin-bottom: 20px; animation: bounce 1s infinite;">ğŸ</div>
            <h2 style="font-size: 24px; margin-bottom: 10px;">ë°©ì— ì…ì¥ ì¤‘...</h2>
            <p style="font-size: 16px; opacity: 0.8;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
            <div style="margin-top: 30px;">
                <div style="width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
            </div>
        </div>
    </div>
    <style>
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
    </style>

    <div class="container">
        <!-- ë¡œë¹„ ì„¹ì…˜ -->
        <section class="lobby-section active" id="lobbySection">
            <h1>ğŸ LAM Horse Race</h1>
            <div class="connection-status connected" id="connectionStatus">â— ì—°ê²°ë¨</div>
            
            <!-- ì´ë¦„ ì…ë ¥ -->
            <div style="background: #f5e6d3; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <label style="font-weight: bold; color: #8b4513; display: block; margin-bottom: 8px;">ğŸ‘¤ ë‚´ ì´ë¦„</label>
                <input type="text" id="globalUserNameInput" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="20">
            </div>
            
            <!-- ë°© ë§Œë“¤ê¸° ë²„íŠ¼ -->
            <button onclick="showCreateRoomSection()" style="margin-bottom: 20px; color: #000; font-weight: 600;">ğŸ ìƒˆ ê²½ë§ˆ ë°© ë§Œë“¤ê¸°</button>
            
            <!-- ë°© ëª©ë¡ -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="color: #8b4513;">ğŸ ë°© ëª©ë¡</h3>
                <button onclick="refreshRooms()" style="width: auto; padding: 8px 15px; font-size: 14px; color: #000; font-weight: 600;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div class="rooms-list" id="roomsList">
                <div style="color: #999; text-align: center; padding: 20px;">ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
            
            <!-- ì£¼ì‚¬ìœ„ ê²Œì„ ë§í¬ -->
            <div style="text-align: center; margin-top: 20px;">
                <a href="/dice-game-multiplayer.html" style="color: #8b4513; text-decoration: none;">ğŸ² ì£¼ì‚¬ìœ„ ê²Œì„ìœ¼ë¡œ ì´ë™</a>
            </div>
        </section>

        <!-- ë°© ìƒì„± ì„¹ì…˜ -->
        <section class="create-room-section" id="createRoomSection">
            <h2 style="color: #8b4513; margin-bottom: 20px;">ğŸ ìƒˆ ê²½ë§ˆ ë°© ë§Œë“¤ê¸°</h2>
            <div class="connection-status connected" id="createRoomConnectionStatus">â— ì—°ê²°ë¨</div>
            
            <div style="margin-bottom: 15px;">
                <label style="font-weight: bold; color: #333; display: block; margin-bottom: 5px;">í˜¸ìŠ¤íŠ¸ ì´ë¦„</label>
                <input type="text" id="createRoomHostNameInput" placeholder="í˜¸ìŠ¤íŠ¸ ì´ë¦„" maxlength="20">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="font-weight: bold; color: #333; display: block; margin-bottom: 5px;">ë°© ì œëª©</label>
                <input type="text" id="createRoomNameInput" placeholder="ë°© ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="30">
            </div>
            
            <!-- ë¹„ê³µê°œ ë°© ì„¤ì • -->
            <div style="margin-bottom: 15px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="createRoomPrivateCheckbox" style="width: auto; margin: 0;">
                    <span style="font-weight: bold; color: #333;">ğŸ”’ ë¹„ê³µê°œ ë°©</span>
                </label>
                <div id="createRoomPasswordContainer" style="display: none; margin-top: 10px;">
                    <input type="password" id="createRoomPasswordInput" placeholder="ë¹„ë°€ë²ˆí˜¸ (4~20ì)" maxlength="20">
                </div>
            </div>
            
            <!-- ë°© ìœ ì§€ ì‹œê°„ -->
            <div style="margin-bottom: 15px;">
                <label style="font-weight: bold; color: #333; display: block; margin-bottom: 8px;">â° ë°© ìœ ì§€ ì‹œê°„</label>
                <div style="display: flex; gap: 15px;">
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="radio" name="roomExpiryTime" value="1" style="width: auto; margin: 0;">
                        <span>1ì‹œê°„</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="radio" name="roomExpiryTime" value="3" checked style="width: auto; margin: 0;">
                        <span>3ì‹œê°„</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="radio" name="roomExpiryTime" value="6" style="width: auto; margin: 0;">
                        <span>6ì‹œê°„</span>
                    </label>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="goBackToLobby()" style="background: #6c757d; flex: 1; color: #000; font-weight: 600;">â† ì·¨ì†Œ</button>
                <button onclick="finalizeRoomCreation()" style="flex: 2; color: #000; font-weight: 600;">ğŸ ë°© ë§Œë“¤ê¸°</button>
            </div>
        </section>

        <!-- ê²Œì„ ì„¹ì…˜ -->
        <section class="game-section" id="gameSection">
            <!-- ë°© ì •ë³´ í—¤ë” -->
            <div class="room-header">
                <div style="display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <span class="room-title" id="roomTitle">ê²½ë§ˆ ë°©</span>
                    <span class="host-badge" id="hostBadge" style="display: none;">ğŸ‘‘ í˜¸ìŠ¤íŠ¸</span>
                </div>
                <div style="text-align: center; margin-top: 10px;">
                    <button onclick="leaveRoom()" style="width: auto; padding: 8px 15px; font-size: 12px; background: #6c757d; color: #000; font-weight: 600; border: none; border-radius: 8px; cursor: pointer;">ğŸšª ë‚˜ê°€ê¸°</button>
                </div>
            </div>

            <!-- ë°© í­íŒŒ ì¹´ìš´íŠ¸ë‹¤ìš´ -->
            <div class="room-expiry-section" id="roomExpirySection" style="display: none;">
                <div style="color: #856404; font-weight: bold; font-size: 14px;">
                    â° ë°© í­íŒŒê¹Œì§€ ë‚¨ì€ ì‹œê°„: <span id="roomExpiryCountdown" style="color: #d9534f;">--:--:--</span>
                </div>
            </div>

            <!-- ì ‘ì†ì ëª©ë¡ -->
            <div class="users-section" id="usersSection">
                <div class="users-title">
                    ğŸ‘¥ ì ‘ì†ì (<span id="usersCount">0</span>ëª…)
                </div>
                <div class="users-list" id="usersList"></div>
            </div>

            <!-- ì¤€ë¹„ ì„¹ì…˜ -->
            <div class="ready-section" id="readySection">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="users-title" style="margin: 0;">âœ… ì¤€ë¹„í•œ ì‚¬ëŒ (<span id="readyCount">0</span>ëª…)</div>
                    <button id="readyButton" onclick="toggleReady()" style="width: auto; padding: 10px 20px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: #000; font-weight: 600;">ì¤€ë¹„</button>
                </div>
                <div class="users-list" id="readyUsersList">
                    <div style="color: #999; text-align: center; padding: 10px; width: 100%;">ì•„ì§ ì¤€ë¹„í•œ ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤</div>
                </div>
            </div>

            <!-- ê²Œì„ ëª¨ë“œ ì„ íƒ (í˜¸ìŠ¤íŠ¸ ì „ìš©) -->
            <div class="game-mode-section" id="gameModeSection" style="display: none;">
                <label style="font-weight: bold; color: #333; display: block; margin-bottom: 10px;">ğŸ® ê²Œì„ ëª¨ë“œ</label>
                <div style="display: flex; gap: 15px;">
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="radio" name="horseRaceMode" value="first" checked style="width: auto; margin: 0;">
                        <span>1ë“± ì°¾ê¸°</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="radio" name="horseRaceMode" value="last" style="width: auto; margin: 0;">
                        <span>ê¼´ë“± ì°¾ê¸°</span>
                    </label>
                </div>
                <button onclick="updateGameMode()" style="width: auto; padding: 8px 15px; font-size: 14px; margin-top: 10px; color: #000; font-weight: 600;">ëª¨ë“œ ë³€ê²½</button>
            </div>

            <!-- íƒˆê²ƒ ì„ íƒ ì„¹ì…˜ -->
            <div class="horse-selection-section" id="horseSelectionSection">
                <div class="users-title" style="margin-bottom: 15px;">ğŸ íƒˆê²ƒ ì„ íƒ</div>
                <div id="horseSelectionGrid" class="horse-selection-grid">
                    <!-- íƒˆê²ƒ ì„ íƒ ë²„íŠ¼ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                </div>
                <div id="horseSelectionInfo" style="text-align: center; margin-top: 15px; color: #666; font-size: 14px;">
                    íƒˆê²ƒì„ ì„ íƒí•´ì£¼ì„¸ìš”
                </div>
            </div>

            <!-- í˜¸ìŠ¤íŠ¸ ì»¨íŠ¸ë¡¤ -->
            <div class="host-controls" id="hostControls" style="display: none; margin-bottom: 20px;">
                <button class="start-button" id="startHorseRaceButton" onclick="startHorseRace()" disabled>
                    ğŸ ê²½ë§ˆ ì‹œì‘ (ìµœì†Œ 2ëª… ì¤€ë¹„ í•„ìš”)
                </button>
                <button onclick="startOrder()" id="startOrderButton" style="display: none; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: #000; font-weight: 600;">ì£¼ë¬¸ë°›ê¸° ì‹œì‘</button>
                <button onclick="endOrder()" id="endOrderButton" style="display: none; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: #000; font-weight: 600;">ì£¼ë¬¸ë°›ê¸° ì¢…ë£Œ</button>
            </div>

            <!-- ì£¼ë¬¸ë°›ê¸° ì„¹ì…˜ -->
            <div class="orders-section" id="ordersSection" style="display: none; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="users-title" style="font-weight: bold; color: #8b4513; font-size: 16px; margin: 0;">ğŸ” ì£¼ë¬¸ë°›ê¸°</div>
                    <button onclick="showOrderList()" id="showOrderListButton" style="width: auto; padding: 8px 16px; font-size: 14px; background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%); color: #000; font-weight: 600;">ğŸ“‹ ì£¼ë¬¸ë¦¬ìŠ¤íŠ¸ ë³´ê¸°</button>
                </div>
                
                <!-- ë‚´ ì£¼ë¬¸ ì…ë ¥ -->
                <div style="background: #fff9e6; border: 2px solid #ffc107; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="font-size: 16px; font-weight: 600; color: #856404; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                        <span>ğŸ“</span>
                        <span>ë‚´ ì£¼ë¬¸</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px;">
                        <input type="text" id="myOrderInput" placeholder="ì£¼ë¬¸í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="100" disabled style="margin: 0;">
                        <button onclick="updateMyOrder()" id="orderSaveButton" style="width: auto; padding: 12px 20px; height: fit-content; margin: 0; color: #000; font-weight: 600;" disabled>ì €ì¥</button>
                    </div>
                </div>

                <!-- ì „ì²´ ì£¼ë¬¸ ëª©ë¡ -->
                <div id="orderList" style="background: #f8f9fa; border-radius: 8px; padding: 12px; max-height: 200px; overflow-y: auto;">
                    <div style="color: #999; text-align: center; padding: 10px;">ì•„ì§ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤</div>
                </div>
            </div>
            
            <!-- ê²Œì„ ìƒíƒœ í‘œì‹œ -->
            <div class="game-status waiting" id="gameStatus" style="padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; margin-bottom: 20px; background: #e9ecef; color: #495057;">
                ëŒ€ê¸° ì¤‘...
            </div>

            <!-- ê²½ì£¼ íŠ¸ë™ ì»¨í…Œì´ë„ˆ -->
            <div class="race-track-container" id="raceTrackContainer" style="display: none;">
                <div class="race-track" id="raceTrack">
                    <!-- ë§ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                </div>
            </div>

            <!-- ê²Œì„ ì¢…ë£Œ ë²„íŠ¼ (í˜¸ìŠ¤íŠ¸ ì „ìš©, ê²°ê³¼ í›„ í‘œì‹œ) -->
            <div id="endGameSection" style="display: none; text-align: center; margin-top: 20px;">
                <button class="end-button" onclick="endHorseRaceGame()">ğŸ ê²Œì„ ì¢…ë£Œ</button>
            </div>

            <!-- ì±„íŒ… ì„¹ì…˜ -->
            <div class="chat-section">
                <div style="font-weight: bold; color: #8b4513; margin-bottom: 10px;">ğŸ’¬ ì±„íŒ…</div>
                <div class="chat-messages" id="chatMessages"></div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." style="flex: 1; margin: 0;" onkeypress="handleChatKeypress(event)">
                    <button onclick="sendMessage()" style="width: auto; padding: 10px 20px; color: #000; font-weight: 600;">ì „ì†¡</button>
                </div>
            </div>
        </section>
    </div>

    <!-- ê¸°ë¡ ì„¹ì…˜ -->
    <div class="history-section" id="historySection">
        <div class="history-title">ğŸ“œ ê²Œì„ ê¸°ë¡</div>
        <div id="historyList"></div>
    </div>

    <!-- ê²°ê³¼ ì˜¤ë²„ë ˆì´ -->
    <div class="result-overlay" id="resultOverlay">
        <div class="result-card">
            <div class="result-title">ğŸŠ ìˆœìœ„ ë°œí‘œ ğŸŠ</div>
            <div id="resultRankings" style="margin-bottom: 20px;"></div>
            <div class="result-winner" id="resultWinner"></div>
            <div class="result-message" id="resultMessage"></div>
            <button onclick="closeResultOverlay()" style="width: auto; padding: 12px 30px; color: #000; font-weight: 600;">í™•ì¸</button>
        </div>
    </div>

    <!-- ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ëª¨ë‹¬ -->
    <div id="passwordModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%;">
            <h3 style="color: #8b4513; margin-bottom: 15px;">ğŸ”’ ë¹„ê³µê°œ ë°©</h3>
            <p style="margin-bottom: 15px; color: #666;">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
            <input type="password" id="roomPasswordInput" placeholder="ë¹„ë°€ë²ˆí˜¸" style="margin-bottom: 15px;">
            <div style="display: flex; gap: 10px;">
                <button onclick="closePasswordModal()" style="background: #6c757d; flex: 1; color: #000; font-weight: 600;">ì·¨ì†Œ</button>
                <button onclick="submitPassword()" style="flex: 1; color: #000; font-weight: 600;">ì…ì¥</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // ìƒíƒœ ë³€ìˆ˜
        let currentRoomId = null;
        let currentUser = '';
        let isHost = false;
        let isReady = false;
        let readyUsers = [];
        let roomsList = [];
        let selectedRoomId = null;
        let horseRaceHistory = [];
        let isRaceActive = false;
        let roomExpiryInterval = null;
        let pendingRoomId = null;
        let isOrderActive = false;
        let everPlayedUsers = [];
        let availableHorses = [];
        let userHorseBets = {};
        let mySelectedHorse = null;
        let horseRaceMode = 'first';
        let currentRoundPlayers = [];
        let raceRound = 1;
        let selectedVehicleTypes = null; // ì„ íƒëœ íƒˆê²ƒ íƒ€ì… (nullì´ë©´ ëœë¤)
        let isReraceActive = false; // ì¬ê²½ì£¼ í™œì„± ìƒíƒœ (ê²½ì£¼ í›„ ë™ì ì¼ ë•Œë§Œ true)
        
        // ë””ë²„ê·¸ ë¡œê·¸ ì´ˆê¸°í™”
        addDebugLog('ê²½ë§ˆ ê²Œì„ ì´ˆê¸°í™”', 'info');
        
        // ì „ì²´ íƒˆê²ƒ ëª©ë¡ (10ê°œ)
        const ALL_VEHICLES = [
            { id: 'car', name: 'ìë™ì°¨', emoji: 'ğŸš—', bgType: 'highway' },
            { id: 'rocket', name: 'ë¡œì¼“', emoji: 'ğŸš€', bgType: 'space' },
            { id: 'bird', name: 'ìƒˆ', emoji: 'ğŸ¦', bgType: 'sky' },
            { id: 'boat', name: 'ë³´íŠ¸', emoji: 'ğŸš¤', bgType: 'sea' },
            { id: 'bicycle', name: 'ìì „ê±°', emoji: 'ğŸš´', bgType: 'dirt' },
            { id: 'rabbit', name: 'í† ë¼', emoji: 'ğŸ‡', bgType: 'carrot' },
            { id: 'turtle', name: 'ê±°ë¶ì´', emoji: 'ğŸ¢', bgType: 'beach' },
            { id: 'eagle', name: 'ë…ìˆ˜ë¦¬', emoji: 'ğŸ¦…', bgType: 'mountain' },
            { id: 'scooter', name: 'í‚¥ë³´ë“œ', emoji: 'ğŸ›´', bgType: 'park' },
            { id: 'helicopter', name: 'í—¬ë¦¬ì½¥í„°', emoji: 'ğŸš', bgType: 'city' }
        ];
        let ordersData = {};
        let frequentMenus = [];
        let currentUsers = [];

        // ë””ë°”ì´ìŠ¤ ID ìƒì„±/ê°€ì ¸ì˜¤ê¸°
        function getDeviceId() {
            let deviceId = localStorage.getItem('horseRaceDeviceId');
            if (!deviceId) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('horseRaceDeviceId', deviceId);
            }
            return deviceId;
        }

        // ì†Œì¼“ ì—°ê²°
        const socket = io({
            reconnection: true,
            reconnectionAttempts: 10,
            reconnectionDelay: 1000
        });

        // ë°© ìƒì„± ì„¹ì…˜ í‘œì‹œ
        function showCreateRoomSection() {
            const globalName = document.getElementById('globalUserNameInput').value.trim();
            
            document.getElementById('lobbySection').classList.remove('active');
            document.getElementById('createRoomSection').classList.add('active');
            
            // í˜¸ìŠ¤íŠ¸ ì´ë¦„ ìë™ ì„¤ì •
            const hostNameInput = document.getElementById('createRoomHostNameInput');
            if (globalName) {
                hostNameInput.value = globalName;
                document.getElementById('createRoomNameInput').value = globalName + 'ë‹˜ì˜ Horse Race';
            }
        }

        // ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°
        function goBackToLobby() {
            document.getElementById('createRoomSection').classList.remove('active');
            document.getElementById('lobbySection').classList.add('active');
        }

        // ë°© ìƒì„±
        function finalizeRoomCreation() {
            const hostName = document.getElementById('createRoomHostNameInput').value.trim();
            const roomName = document.getElementById('createRoomNameInput').value.trim();
            const isPrivate = document.getElementById('createRoomPrivateCheckbox').checked;
            const password = document.getElementById('createRoomPasswordInput').value.trim();
            const expiryTimeRadio = document.querySelector('input[name="roomExpiryTime"]:checked');
            const expiryHours = expiryTimeRadio ? parseInt(expiryTimeRadio.value) : 3;

            if (!hostName) {
                alert('í˜¸ìŠ¤íŠ¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            if (!roomName) {
                alert('ë°© ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            if (isPrivate && (!password || password.length < 4)) {
                alert('ë¹„ê³µê°œ ë°©ì€ 4ì ì´ìƒì˜ ë¹„ë°€ë²ˆí˜¸ê°€ í•„ìš”í•©ë‹ˆë‹¤!');
                return;
            }

            // ì´ë¦„ ì €ì¥
            localStorage.setItem('horseRaceUserName', hostName);

            socket.emit('createRoom', {
                userName: hostName,
                roomName: roomName,
                isPrivate: isPrivate,
                password: isPrivate ? password : '',
                gameType: 'horse-race',
                expiryHours: expiryHours,
                blockIPPerUser: false,
                deviceId: getDeviceId()
            });
        }

        // ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        function refreshRooms() {
            socket.emit('getRooms');
        }

        // ë°© ëª©ë¡ ë Œë”ë§
        function renderRoomsList() {
            const roomsListEl = document.getElementById('roomsList');
            
            // ê²½ë§ˆ ë°©ë§Œ í•„í„°ë§
            const horseRaceRooms = roomsList.filter(room => room.gameType === 'horse-race');
            
            if (horseRaceRooms.length === 0) {
                roomsListEl.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">ìƒì„±ëœ ê²½ë§ˆ ë°©ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            roomsListEl.innerHTML = '';

            horseRaceRooms.forEach(room => {
                const roomItem = document.createElement('div');
                const isMyRoom = room.roomId === currentRoomId;
                let className = 'room-item';
                if (isMyRoom) className += ' my-room';
                else if (room.roomId === selectedRoomId) className += ' active';
                roomItem.className = className;

                let statusClass = 'waiting';
                let statusText = 'ëŒ€ê¸° ì¤‘';
                if (room.isGameActive) {
                    statusClass = 'playing';
                    statusText = 'ê²Œì„ ì§„í–‰ ì¤‘';
                }

                const roomNameHtml = isMyRoom 
                    ? `${room.roomName}<span class="my-room-badge">ì°¸ì—¬ ì¤‘</span>`
                    : room.roomName;

                const privateBadge = room.isPrivate 
                    ? '<span style="color: #ff6b6b; font-weight: bold; margin-left: 5px;">ğŸ”’</span>' 
                    : '';

                const buttonText = isMyRoom ? 'ì¬ì…ì¥' : 'ì…ì¥';

                roomItem.innerHTML = `
                    <div class="room-info">
                        <div class="room-name"><span style="font-size: 20px; margin-right: 5px;">ğŸ</span>${roomNameHtml}${privateBadge}</div>
                        <div class="room-details">í˜¸ìŠ¤íŠ¸: ${room.hostName} | ì¸ì›: ${room.playerCount}ëª…</div>
                        <span class="room-status ${statusClass}">${statusText}</span>
                    </div>
                    <div class="room-action">
                        <button onclick="joinRoomDirectly('${room.roomId}')" style="color: #000; font-weight: 600;">${buttonText}</button>
                    </div>
                `;

                roomsListEl.appendChild(roomItem);
            });
        }

        // ë°© ì…ì¥
        function joinRoomDirectly(roomId) {
            const userName = document.getElementById('globalUserNameInput').value.trim();
            
            if (!userName) {
                alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                document.getElementById('globalUserNameInput').focus();
                return;
            }

            const room = roomsList.find(r => r.roomId === roomId);
            if (room && room.isPrivate) {
                pendingRoomId = roomId;
                pendingUserName = userName;
                document.getElementById('passwordModal').style.display = 'flex';
                document.getElementById('roomPasswordInput').focus();
            } else {
                socket.emit('joinRoom', {
                    roomId: roomId,
                    userName: userName,
                    isHost: false,
                    password: '',
                    deviceId: getDeviceId()
                });
            }

            localStorage.setItem('horseRaceUserName', userName);
        }

        // ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ ë‹«ê¸°
        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('roomPasswordInput').value = '';
            pendingRoomId = null;
            pendingUserName = null;
        }

        // ë¹„ë°€ë²ˆí˜¸ ì œì¶œ
        function submitPassword() {
            const password = document.getElementById('roomPasswordInput').value;
            
            if (pendingRoomId && pendingUserName) {
                socket.emit('joinRoom', {
                    roomId: pendingRoomId,
                    userName: pendingUserName,
                    isHost: false,
                    password: password,
                    deviceId: getDeviceId()
                });
            }
            
            closePasswordModal();
        }

        // ë°© ë‚˜ê°€ê¸°
        function leaveRoom() {
            if (confirm('ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                socket.emit('leaveRoom');
            }
        }

        // ì¤€ë¹„ í† ê¸€
        function toggleReady() {
            socket.emit('toggleReady');
        }

        // ì¤€ë¹„ ë²„íŠ¼ ì—…ë°ì´íŠ¸
        function updateReadyButton() {
            const btn = document.getElementById('readyButton');
            if (isReady) {
                btn.textContent = 'ì¤€ë¹„ ì·¨ì†Œ';
                btn.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
                btn.style.color = '#000';
            } else {
                btn.textContent = 'ì¤€ë¹„';
                btn.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
                btn.style.color = '#000';
            }
        }

        // ì¤€ë¹„ ëª©ë¡ ë Œë”ë§
        function renderReadyUsers() {
            const readyUsersList = document.getElementById('readyUsersList');
            const readyCount = document.getElementById('readyCount');
            
            if (!readyUsersList || !readyCount) return;
            
            readyCount.textContent = readyUsers.length;
            
            if (readyUsers.length === 0) {
                readyUsersList.innerHTML = '<div style="color: #999; text-align: center; padding: 10px; width: 100%;" data-empty-ready>ì•„ì§ ì¤€ë¹„í•œ ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤</div>';
            } else {
                readyUsersList.innerHTML = '';
                readyUsers.forEach(userName => {
                    const tag = document.createElement('span');
                    tag.className = 'user-tag';
                    tag.textContent = userName;
                    readyUsersList.appendChild(tag);
                });
            }

            // ì‹œì‘ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateStartButton();
        }
        
        // ì‹œì‘ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateStartButton() {
            const btn = document.getElementById('startHorseRaceButton');
            if (btn && isHost) {
                if (readyUsers.length >= 2 && !isRaceActive) {
                    btn.disabled = false;
                    btn.textContent = 'ğŸ ê²½ë§ˆ ì‹œì‘!';
                } else {
                    btn.disabled = true;
                    btn.textContent = `ğŸ ê²½ë§ˆ ì‹œì‘ (${readyUsers.length}/2ëª… ì¤€ë¹„)`;
                }
            }
        }

        // ê²½ë§ˆ ì‹œì‘
        function startHorseRace() {
            addDebugLog('ê²½ì£¼ ì‹œì‘ ìš”ì²­', 'race');
            socket.emit('startHorseRace');
        }

        // ê²Œì„ ëª¨ë“œ ì—…ë°ì´íŠ¸
        function updateGameMode() {
            const modeRadio = document.querySelector('input[name="horseRaceMode"]:checked');
            const mode = modeRadio ? modeRadio.value : 'first';
            
            socket.emit('updateGameRules', {
                horseRaceMode: mode
            });
        }

        // ë§ ì„ íƒ
        function selectHorse(horseIndex) {
            addDebugLog(`íƒˆê²ƒ ì„ íƒ: ${horseIndex}`, 'selection');
            // ì´ë¯¸ ì„ íƒí•œ íƒˆê²ƒì„ ë‹¤ì‹œ ì„ íƒí•˜ë©´ ì·¨ì†Œ
            // ë‹¤ë¥¸ íƒˆê²ƒì„ ì„ íƒí•˜ë©´ ì¬ì„ íƒ (ì„œë²„ì—ì„œ ê²€ì¦)
            socket.emit('selectHorse', {
                horseIndex: horseIndex
            });
        }

        // íƒˆê²ƒ ì„ íƒ í™”ë©´ì— íŠ¸ë™ í‘œì‹œ (ì´ˆê¸° ìƒíƒœ)
        function renderTrackForSelection() {
            const track = document.getElementById('raceTrack');
            const trackContainer = document.getElementById('raceTrackContainer');
            
            if (!track || !trackContainer) return;
            
            trackContainer.style.display = 'block';
            track.innerHTML = '';
            
            const trackWidth = trackContainer.offsetWidth || 700;
            const horseCount = availableHorses.length;
            const wallHeight = 6;
            const laneHeight = Math.min(75, Math.floor((350 - wallHeight * (horseCount - 1)) / horseCount));
            const totalLaneHeight = laneHeight + wallHeight;
            
            availableHorses.forEach((horseIndex, rank) => {
                const vehicleId = selectedVehicleTypes ? selectedVehicleTypes[horseIndex] : ALL_VEHICLES[horseIndex % ALL_VEHICLES.length].id;
                const vehicleBg = getVehicleBackground(vehicleId);
                const vehicle = ALL_VEHICLES.find(v => v.id === vehicleId) || ALL_VEHICLES[0];
                
                // ë ˆì¸ ìƒì„±
                const lane = document.createElement('div');
                lane.style.cssText = `
                    position: absolute;
                    left: 0;
                    top: ${rank * totalLaneHeight}px;
                    width: 100%;
                    height: ${laneHeight}px;
                    background: ${vehicleBg.bg};
                    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
                `;
                
                // ë°°ê²½ íš¨ê³¼ ì¶”ê°€ (startRaceAnimationê³¼ ë™ì¼)
                if (vehicleBg.extra === 'road') {
                    lane.innerHTML += `<div style="position: absolute; top: 50%; left: 0; width: 100%; height: 3px; background: repeating-linear-gradient(90deg, #fff 0px, #fff 20px, transparent 20px, transparent 40px);"></div>`;
                }
                if (vehicleBg.extra === 'stars') {
                    for (let i = 0; i < 20; i++) {
                        const size = 1 + Math.random() * 2;
                        lane.innerHTML += `<div style="position: absolute; width: ${size}px; height: ${size}px; background: white; border-radius: 50%; left: ${Math.random() * 100}%; top: ${Math.random() * 100}%; opacity: ${0.5 + Math.random() * 0.5};"></div>`;
                    }
                }
                if (vehicleBg.extra === 'waves') {
                    lane.innerHTML += `<div style="position: absolute; bottom: 20%; left: 0; width: 100%; height: 4px; background: repeating-linear-gradient(90deg, transparent, transparent 15px, rgba(255,255,255,0.4) 15px, rgba(255,255,255,0.4) 30px);"></div>`;
                    lane.innerHTML += `<div style="position: absolute; bottom: 40%; left: 10px; width: 100%; height: 3px; background: repeating-linear-gradient(90deg, transparent, transparent 20px, rgba(255,255,255,0.3) 20px, rgba(255,255,255,0.3) 35px);"></div>`;
                }
                if (vehicleBg.extra === 'clouds') {
                    for (let i = 0; i < 4; i++) {
                        const w = 25 + Math.random() * 20;
                        lane.innerHTML += `<div style="position: absolute; width: ${w}px; height: ${w*0.5}px; background: rgba(255,255,255,0.7); border-radius: ${w/2}px; left: ${Math.random() * 85}%; top: ${10 + Math.random() * 50}%;"></div>`;
                    }
                }
                if (vehicleBg.extra === 'carrots') {
                    for (let i = 0; i < 6; i++) {
                        lane.innerHTML += `<div style="position: absolute; font-size: 14px; left: ${10 + Math.random() * 80}%; top: ${40 + Math.random() * 50}%;">ğŸ¥•</div>`;
                    }
                }
                if (vehicleBg.extra === 'mountains') {
                    lane.innerHTML += `<svg style="position: absolute; bottom: 30%; left: 0; width: 100%; height: 40%;" viewBox="0 0 100 40" preserveAspectRatio="none"><polygon points="0,40 15,15 30,40" fill="#7f8c8d"/><polygon points="20,40 40,10 60,40" fill="#95a5a6"/><polygon points="50,40 70,20 90,40" fill="#7f8c8d"/><polygon points="70,40 85,25 100,40" fill="#95a5a6"/></svg>`;
                }
                if (vehicleBg.extra === 'buildings') {
                    lane.innerHTML += `<svg style="position: absolute; bottom: 0; left: 0; width: 100%; height: 35%;" viewBox="0 0 100 35" preserveAspectRatio="none"><rect x="0" y="10" width="8" height="25" fill="#1a252f"/><rect x="10" y="5" width="10" height="30" fill="#2c3e50"/><rect x="22" y="15" width="6" height="20" fill="#1a252f"/><rect x="30" y="8" width="12" height="27" fill="#34495e"/><rect x="45" y="12" width="8" height="23" fill="#2c3e50"/><rect x="55" y="3" width="10" height="32" fill="#1a252f"/><rect x="67" y="18" width="7" height="17" fill="#34495e"/><rect x="76" y="10" width="12" height="25" fill="#2c3e50"/><rect x="90" y="15" width="10" height="20" fill="#1a252f"/></svg>`;
                }
                
                track.appendChild(lane);
                
                // ë ˆì¸ ì•„ë˜ ë²½ ìƒì„±
                if (rank < horseCount - 1) {
                    const wall = document.createElement('div');
                    wall.style.cssText = `
                        position: absolute;
                        left: 0;
                        top: ${rank * totalLaneHeight + laneHeight}px;
                        width: 100%;
                        height: ${wallHeight}px;
                        background: linear-gradient(180deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%);
                        box-shadow: 
                            0 2px 4px rgba(0,0,0,0.3),
                            inset 0 1px 2px rgba(255,255,255,0.1),
                            inset 0 -1px 2px rgba(0,0,0,0.2);
                        border-top: 1px solid rgba(255,255,255,0.2);
                        border-bottom: 1px solid rgba(0,0,0,0.3);
                        z-index: 10;
                    `;
                    track.appendChild(wall);
                }
                
                // íƒˆê²ƒ í‘œì‹œ (ì‹œì‘ ìœ„ì¹˜)
                const horse = document.createElement('div');
                horse.className = 'horse';
                horse.id = `horse_preview_${horseIndex}`;
                horse.style.cssText = `
                    position: absolute;
                    left: 10px;
                    top: ${rank * totalLaneHeight + 10}px;
                    width: 80px;
                    height: ${laneHeight - 10}px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    z-index: ${100 - rank};
                `;
                
                // ì„ íƒí•œ ëª¨ë“  ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ (ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥)
                const selectedUsers = Object.entries(userHorseBets)
                    .filter(([_, h]) => h === horseIndex)
                    .map(([name, _]) => name);
                
                if (selectedUsers.length > 0) {
                    // ì—¬ëŸ¬ ëª…ì´ ì„ íƒí•œ ê²½ìš° ëª¨ë‘ í‘œì‹œ
                    selectedUsers.forEach((userName, idx) => {
                        const nameLabel = document.createElement('div');
                        nameLabel.style.cssText = `font-size: 11px; font-weight: bold; color: ${vehicleBg.textColor}; white-space: nowrap; text-align: center; margin-bottom: ${idx === selectedUsers.length - 1 ? '2px' : '1px'}; background: rgba(0,0,0,0.5); padding: 1px 4px; border-radius: 3px;`;
                        nameLabel.textContent = userName;
                        horse.appendChild(nameLabel);
                    });
                }
                
                // íƒˆê²ƒ ìŠ¤í”„ë¼ì´íŠ¸
                const vehicleContent = document.createElement('div');
                vehicleContent.className = 'vehicle-sprite';
                vehicleContent.style.animation = 'none'; // ì• ë‹ˆë©”ì´ì…˜ ì—†ìŒ
                
                const frame1 = document.createElement('div');
                frame1.className = 'frame1';
                const vehicleSVGs = getVehicleSVG(vehicleId);
                frame1.innerHTML = vehicleSVGs.frame1;
                
                vehicleContent.appendChild(frame1);
                horse.appendChild(vehicleContent);
                track.appendChild(horse);
            });
        }
        
        // íƒˆê²ƒ ì„ íƒ UI ë Œë”ë§
        function renderHorseSelection() {
            const grid = document.getElementById('horseSelectionGrid');
            const info = document.getElementById('horseSelectionInfo');
            
            if (!grid) return;
            
            grid.innerHTML = '';
            
            // íŠ¸ë™ í‘œì‹œ
            renderTrackForSelection();
            
            if (availableHorses.length === 0) {
                info.textContent = 'íƒˆê²ƒ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
                return;
            }

            availableHorses.forEach((horseIndex, index) => {
                const button = document.createElement('button');
                button.className = 'horse-selection-button';
                button.id = `horseButton_${horseIndex}`;
                
                // íƒˆê²ƒ íƒ€ì… ê°€ì ¸ì˜¤ê¸°
                const vehicleId = selectedVehicleTypes ? selectedVehicleTypes[horseIndex] : ALL_VEHICLES[horseIndex % ALL_VEHICLES.length].id;
                const vehicle = ALL_VEHICLES.find(v => v.id === vehicleId) || ALL_VEHICLES[0];
                
                // ì´ë¯¸ ì„ íƒëœ íƒˆê²ƒì¸ì§€ í™•ì¸
                const isTaken = Object.values(userHorseBets).includes(horseIndex);
                const isMyHorse = userHorseBets[currentUser] === horseIndex;
                
                // ì„ íƒí•œ ì‚¬ëŒ ì°¾ê¸°
                const selectedBy = Object.entries(userHorseBets).find(([_, h]) => h === horseIndex)?.[0];
                
                // ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥ ì—¬ë¶€: íƒˆê²ƒ ìˆ˜ < ì‚¬ëŒ ìˆ˜ì¼ ë•Œë§Œ ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥
                // ì°¸ê°€ì ìˆ˜ ê³„ì‚° (currentUsersê°€ ê°€ì¥ ì •í™• - updateUsersë¡œ í•­ìƒ ìµœì‹  ìƒíƒœ)
                const totalPlayers = currentUsers.length > 0 ? currentUsers.length : 
                                    (currentRoundPlayers.length > 0 ? currentRoundPlayers.length : 
                                    (readyUsers.length > 0 ? readyUsers.length : 1));
                const canDuplicate = availableHorses.length < totalPlayers;
                
                // ë””ë²„ê¹…ìš© ë¡œê·¸
                if (index === 0) {
                    console.log('[ë§ ì„ íƒ]', {
                        availableHorses: availableHorses.length,
                        totalPlayers,
                        canDuplicate,
                        currentRoundPlayers: currentRoundPlayers.length,
                        currentUsers: currentUsers.length,
                        readyUsers: readyUsers.length,
                        isHost: isHost,
                        currentUser: currentUser
                    });
                }
                
                // ì¤‘ë³µ ì„ íƒì´ ë¶ˆê°€ëŠ¥í•˜ê³  ì´ë¯¸ ì„ íƒëœ íƒˆê²ƒì´ë©´ ë¹„í™œì„±í™”
                // (ë‹¨, ë‚´ê°€ ì„ íƒí•œ ê²ƒì€ ë¹„í™œì„±í™”í•˜ì§€ ì•ŠìŒ)
                // ì¤‘ë³µ ì„ íƒì´ ê°€ëŠ¥í•˜ë©´(isTakenì´ì–´ë„) ë¹„í™œì„±í™”í•˜ì§€ ì•ŠìŒ
                if (!canDuplicate && isTaken && !isMyHorse) {
                    button.disabled = true;
                } else if (canDuplicate && isTaken && !isMyHorse) {
                    // ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥í•˜ì§€ë§Œ ì´ë¯¸ ì„ íƒëœ ê²½ìš°, ë¹„í™œì„±í™”í•˜ì§€ ì•ŠìŒ (ì„ íƒ ê°€ëŠ¥)
                    button.disabled = false;
                }
                
                if (isMyHorse) {
                    button.classList.add('selected');
                    mySelectedHorse = horseIndex;
                }
                
                // íƒˆê²ƒ ë²„íŠ¼ ë‚´ìš© ìƒì„±
                let content = `<div style="font-size: 48px;">${vehicle.emoji}</div>`;
                content += `<div style="font-size: 14px; margin-top: 5px; font-weight: 600;">${vehicle.name}</div>`;
                
                // ì„ íƒí•œ ì‚¬ëŒ ì •ë³´ í‘œì‹œ
                if (selectedBy) {
                    if (selectedBy === currentUser) {
                        content += `<div style="font-size: 12px; margin-top: 5px; color: #8b4513; font-weight: bold;">âœ“ ë‚´ê°€ ì„ íƒ</div>`;
                    } else {
                        content += `<div style="font-size: 12px; margin-top: 5px; color: #dc3545; font-weight: bold;">${selectedBy} ì„ íƒ</div>`;
                    }
                }
                
                button.innerHTML = content;
                
                // ì¬ê²½ì£¼ì¸ ê²½ìš° ì¬ê²½ì£¼ ëŒ€ìƒìê°€ ì•„ë‹ˆë©´ ì„ íƒ ë¶ˆê°€
                if (isReraceActive && !currentRoundPlayers.includes(currentUser)) {
                    button.disabled = true;
                    button.style.opacity = '0.5';
                    button.style.cursor = 'not-allowed';
                }
                
                button.onclick = () => {
                    // ì¬ê²½ì£¼ì¸ ê²½ìš° ì¬ê²½ì£¼ ëŒ€ìƒìê°€ ì•„ë‹ˆë©´ ì„ íƒ ë¶ˆê°€
                    if (isReraceActive && !currentRoundPlayers.includes(currentUser)) {
                        alert('ì¬ê²½ì£¼ ì¤€ë¹„ ëŒ€ìƒì´ ì•„ë‹™ë‹ˆë‹¤!');
                        return;
                    }
                    
                    // ë¹„í™œì„±í™”ëœ ë²„íŠ¼ì€ ì„ íƒ ë¶ˆê°€
                    if (button.disabled) {
                        console.log(`[ë§ ì„ íƒ] ${vehicle.name}ì€(ëŠ”) ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (ì´ë¯¸ ë‹¤ë¥¸ ì‚¬ëŒì´ ì„ íƒí•¨)`);
                        return;
                    }
                    
                    // ê°™ì€ íƒˆê²ƒì„ ë‹¤ì‹œ ì„ íƒí•˜ë©´ ì·¨ì†Œ, ë‹¤ë¥¸ íƒˆê²ƒì„ ì„ íƒí•˜ë©´ ì¬ì„ íƒ
                    selectHorse(horseIndex);
                };
                
                grid.appendChild(button);
            });

            // ì„ íƒ ì •ë³´ ì—…ë°ì´íŠ¸
            const selectedCount = Object.keys(userHorseBets).length;
            // ì¬ê²½ì£¼ì¸ ê²½ìš° ì¬ê²½ì£¼ ëŒ€ìƒì ìˆ˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
            const totalPlayers = isReraceActive ? currentRoundPlayers.length : 
                               (currentUsers.length > 0 ? currentUsers.length : 
                               (currentRoundPlayers.length > 0 ? currentRoundPlayers.length : 
                               (readyUsers.length > 0 ? readyUsers.length : 1)));
            
            // ì„ íƒí•œ ì‚¬ëŒ ëª©ë¡ ìƒì„±
            const selectedUsers = Object.keys(userHorseBets);
            
            // ì¬ê²½ì£¼ ë²„íŠ¼ ì—…ë°ì´íŠ¸ (ì¬ê²½ì£¼ì¸ ê²½ìš°)
            if (isReraceActive && isHost) {
                updateReraceButton();
            }
            
            let infoText = '';
            
            // ì¬ê²½ì£¼ì¸ ê²½ìš°
            if (isReraceActive) {
                const reraceSelectedCount = currentRoundPlayers.filter(p => userHorseBets[p] !== undefined).length;
                infoText = `ì¬ê²½ì£¼: ${reraceSelectedCount}/${totalPlayers}ëª…ì´ íƒˆê²ƒì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤.`;
                
                if (reraceSelectedCount > 0) {
                    const reraceSelectedUsers = currentRoundPlayers.filter(p => userHorseBets[p] !== undefined);
                    infoText += ` (${reraceSelectedUsers.join(', ')})`;
                }
                
                if (reraceSelectedCount === totalPlayers) {
                    infoText = `âœ… ëª¨ë“  ì¬ê²½ì£¼ ëŒ€ìƒìê°€ íƒˆê²ƒì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤. í˜¸ìŠ¤íŠ¸ê°€ ì¬ê²½ì£¼ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”!`;
                } else {
                    // ì¬ê²½ì£¼ ëŒ€ìƒìê°€ ì•„ë‹Œ ì‚¬ëŒì—ê²Œ ë©”ì‹œì§€ í‘œì‹œ
                    if (!currentRoundPlayers.includes(currentUser)) {
                        infoText = `ì¬ê²½ì£¼ ì¤€ë¹„ ëŒ€ìƒì´ ì•„ë‹™ë‹ˆë‹¤. (ì¬ê²½ì£¼ ëŒ€ìƒì: ${currentRoundPlayers.join(', ')})`;
                    }
                }
            } else {
                infoText = `${selectedCount}/${totalPlayers}ëª…ì´ íƒˆê²ƒì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤.`;
                
                if (selectedCount > 0) {
                    infoText += ` (${selectedUsers.join(', ')})`;
                }
                
                if (selectedCount === totalPlayers) {
                    infoText = `âœ… ëª¨ë“  ì°¸ê°€ìê°€ íƒˆê²ƒì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤. ê²½ì£¼ê°€ ê³§ ì‹œì‘ë©ë‹ˆë‹¤!`;
                }
            }
            
            info.textContent = infoText;
        }

        // ê²½ì£¼ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
        function startRaceAnimation(horseRankings, speeds) {
            const track = document.getElementById('raceTrack');
            const trackContainer = document.getElementById('raceTrackContainer');
            
            if (!track || !trackContainer) {
                console.error('íŠ¸ë™ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return 5000;
            }
            
            if (!horseRankings || horseRankings.length === 0) {
                console.error('ë§ ìˆœìœ„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤', horseRankings);
                return 5000;
            }
            
            trackContainer.style.display = 'block';
            track.innerHTML = '';
            
            const trackWidth = trackContainer.offsetWidth || 700;
            const finishLine = trackWidth - 100;
            const horseCount = horseRankings.length;
            const wallHeight = 6; // ë²½ ë†’ì´
            const laneHeight = Math.min(75, Math.floor((350 - wallHeight * (horseCount - 1)) / horseCount));
            const totalLaneHeight = laneHeight + wallHeight; // ë ˆì¸ + ë²½ ë†’ì´
            
            console.log('ê²½ì£¼ ì‹œì‘:', { horseRankings, speeds, trackWidth, finishLine });
            
            // ê° ë§ ìƒì„± ë° ì• ë‹ˆë©”ì´ì…˜ (ëª¨ë“  ë§ì„ ë¨¼ì € ìƒì„±)
            const horseElements = [];
            let maxDuration = 0;
            
            horseRankings.forEach((horseIndex, rank) => {
                // íƒˆê²ƒ íƒ€ì… ê°€ì ¸ì˜¤ê¸° (selectedVehicleTypesê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ëœë¤)
                const vehicleId = selectedVehicleTypes ? selectedVehicleTypes[horseIndex] : ALL_VEHICLES[horseIndex % ALL_VEHICLES.length].id;
                const vehicleBg = getVehicleBackground(vehicleId);
                
                // ë ˆì¸ ìƒì„±
                const lane = document.createElement('div');
                lane.style.cssText = `
                    position: absolute;
                    left: 0;
                    top: ${rank * totalLaneHeight}px;
                    width: 100%;
                    height: ${laneHeight}px;
                    background: ${vehicleBg.bg};
                    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
                `;
                
                // ë ˆì¸ ì•„ë˜ ë²½ ìƒì„± (ë§ˆì§€ë§‰ ë ˆì¸ ì œì™¸)
                if (rank < horseCount - 1) {
                    const wall = document.createElement('div');
                    wall.style.cssText = `
                        position: absolute;
                        left: 0;
                        top: ${rank * totalLaneHeight + laneHeight}px;
                        width: 100%;
                        height: ${wallHeight}px;
                        background: linear-gradient(180deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%);
                        box-shadow: 
                            0 2px 4px rgba(0,0,0,0.3),
                            inset 0 1px 2px rgba(255,255,255,0.1),
                            inset 0 -1px 2px rgba(0,0,0,0.2);
                        border-top: 1px solid rgba(255,255,255,0.2);
                        border-bottom: 1px solid rgba(0,0,0,0.3);
                        z-index: 10;
                    `;
                    track.appendChild(wall);
                }
                
                // ë°°ê²½ íš¨ê³¼ ì¶”ê°€
                if (vehicleBg.extra === 'road') {
                    // ë„ë¡œ ì°¨ì„  (ì ì„ )
                    lane.innerHTML += `<div style="position: absolute; top: 50%; left: 0; width: 100%; height: 3px; background: repeating-linear-gradient(90deg, #fff 0px, #fff 20px, transparent 20px, transparent 40px);"></div>`;
                }
                if (vehicleBg.extra === 'stars') {
                    for (let i = 0; i < 20; i++) {
                        const size = 1 + Math.random() * 2;
                        lane.innerHTML += `<div style="position: absolute; width: ${size}px; height: ${size}px; background: white; border-radius: 50%; left: ${Math.random() * 100}%; top: ${Math.random() * 100}%; opacity: ${0.5 + Math.random() * 0.5};"></div>`;
                    }
                }
                if (vehicleBg.extra === 'waves') {
                    lane.innerHTML += `<div style="position: absolute; bottom: 20%; left: 0; width: 100%; height: 4px; background: repeating-linear-gradient(90deg, transparent, transparent 15px, rgba(255,255,255,0.4) 15px, rgba(255,255,255,0.4) 30px);"></div>`;
                    lane.innerHTML += `<div style="position: absolute; bottom: 40%; left: 10px; width: 100%; height: 3px; background: repeating-linear-gradient(90deg, transparent, transparent 20px, rgba(255,255,255,0.3) 20px, rgba(255,255,255,0.3) 35px);"></div>`;
                }
                if (vehicleBg.extra === 'clouds') {
                    for (let i = 0; i < 4; i++) {
                        const w = 25 + Math.random() * 20;
                        lane.innerHTML += `<div style="position: absolute; width: ${w}px; height: ${w*0.5}px; background: rgba(255,255,255,0.7); border-radius: ${w/2}px; left: ${Math.random() * 85}%; top: ${10 + Math.random() * 50}%;"></div>`;
                    }
                }
                if (vehicleBg.extra === 'carrots') {
                    for (let i = 0; i < 6; i++) {
                        lane.innerHTML += `<div style="position: absolute; font-size: 14px; left: ${10 + Math.random() * 80}%; top: ${40 + Math.random() * 50}%;">ğŸ¥•</div>`;
                    }
                }
                if (vehicleBg.extra === 'mountains') {
                    // ì‚° ì‹¤ë£¨ì—£
                    lane.innerHTML += `<svg style="position: absolute; bottom: 30%; left: 0; width: 100%; height: 40%;" viewBox="0 0 100 40" preserveAspectRatio="none"><polygon points="0,40 15,15 30,40" fill="#7f8c8d"/><polygon points="20,40 40,10 60,40" fill="#95a5a6"/><polygon points="50,40 70,20 90,40" fill="#7f8c8d"/><polygon points="70,40 85,25 100,40" fill="#95a5a6"/></svg>`;
                }
                if (vehicleBg.extra === 'buildings') {
                    // ë„ì‹œ ê±´ë¬¼ ì‹¤ë£¨ì—£
                    lane.innerHTML += `<svg style="position: absolute; bottom: 0; left: 0; width: 100%; height: 35%;" viewBox="0 0 100 35" preserveAspectRatio="none"><rect x="0" y="10" width="8" height="25" fill="#1a252f"/><rect x="10" y="5" width="10" height="30" fill="#2c3e50"/><rect x="22" y="15" width="6" height="20" fill="#1a252f"/><rect x="30" y="8" width="12" height="27" fill="#34495e"/><rect x="45" y="12" width="8" height="23" fill="#2c3e50"/><rect x="55" y="3" width="10" height="32" fill="#1a252f"/><rect x="67" y="18" width="7" height="17" fill="#34495e"/><rect x="76" y="10" width="12" height="25" fill="#2c3e50"/><rect x="90" y="15" width="10" height="20" fill="#1a252f"/></svg>`;
                }
                
                track.appendChild(lane);
                
                const horse = document.createElement('div');
                horse.className = 'horse racing';
                horse.id = `horse_${horseIndex}`;
                horse.style.cssText = `
                    position: absolute;
                    left: 10px;
                    top: ${rank * totalLaneHeight + 10}px;
                    width: 80px;
                    height: ${laneHeight - 10}px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    z-index: ${100 - rank};
                `;
                
                // ì„ íƒí•œ ëª¨ë“  ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ (ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥)
                const selectedUsers = Object.entries(userHorseBets)
                    .filter(([_, h]) => h === horseIndex)
                    .map(([name, _]) => name);
                
                if (selectedUsers.length > 0) {
                    // ì—¬ëŸ¬ ëª…ì´ ì„ íƒí•œ ê²½ìš° ëª¨ë‘ í‘œì‹œ
                    selectedUsers.forEach((userName, idx) => {
                        const nameLabel = document.createElement('div');
                        nameLabel.style.cssText = `font-size: 11px; font-weight: bold; color: ${vehicleBg.textColor}; white-space: nowrap; text-align: center; margin-bottom: ${idx === selectedUsers.length - 1 ? '2px' : '1px'}; background: rgba(0,0,0,0.5); padding: 1px 4px; border-radius: 3px;`;
                        nameLabel.textContent = userName;
                        horse.appendChild(nameLabel);
                    });
                }
                
                // íƒˆê²ƒ ìŠ¤í”„ë¼ì´íŠ¸ (2í”„ë ˆì„ ì• ë‹ˆë©”ì´ì…˜)
                const vehicleContent = document.createElement('div');
                vehicleContent.className = 'vehicle-sprite';
                
                const frame1 = document.createElement('div');
                frame1.className = 'frame1';
                const frame2 = document.createElement('div');
                frame2.className = 'frame2';
                
                // íƒˆê²ƒë³„ SVG ìƒì„±
                const vehicleSVGs = getVehicleSVG(vehicleId);
                frame1.innerHTML = vehicleSVGs.frame1;
                frame2.innerHTML = vehicleSVGs.frame2;
                
                vehicleContent.appendChild(frame1);
                vehicleContent.appendChild(frame2);
                
                horse.appendChild(vehicleContent);
                track.appendChild(horse);
                
                const duration = speeds[rank] || 5000;
                maxDuration = Math.max(maxDuration, duration);
                horseElements.push({ horse, vehicleContent, frames: [frame1, frame2], rank, duration });
            });
            
            // ëª¨ë“  íƒˆê²ƒ ë™ì‹œì— ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
            setTimeout(() => {
                horseElements.forEach(({ horse, frames, duration }) => {
                    horse.style.transition = `left ${duration}ms linear`;
                    horse.style.left = `${finishLine}px`;
                    
                    // ë„ì°© í›„ ì• ë‹ˆë©”ì´ì…˜ ë©ˆì¶¤
                    setTimeout(() => {
                        horse.classList.remove('racing');
                        frames.forEach((frame, idx) => {
                            frame.style.animation = 'none';
                            frame.style.opacity = idx === 0 ? '1' : '0';
                        });
                    }, duration);
                });
            }, 500);
            
            return maxDuration;
        }
        
        // íƒˆê²ƒë³„ SVG ìƒì„± í•¨ìˆ˜
        function getVehicleSVG(vehicleId) {
            const svgMap = {
                'car': { // ìë™ì°¨ - ë°”í€´ íšŒì „
                    frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <rect x="10" y="15" width="40" height="15" rx="3" fill="#e74c3c"/>
                        <rect x="18" y="8" width="22" height="12" rx="2" fill="#e74c3c"/>
                        <rect x="20" y="10" width="8" height="8" fill="#87CEEB"/>
                        <rect x="30" y="10" width="8" height="8" fill="#87CEEB"/>
                        <circle cx="18" cy="32" r="6" fill="#333"/><circle cx="18" cy="32" r="3" fill="#666"/>
                        <line x1="18" y1="29" x2="18" y2="35" stroke="#999" stroke-width="1"/>
                        <circle cx="42" cy="32" r="6" fill="#333"/><circle cx="42" cy="32" r="3" fill="#666"/>
                        <line x1="42" y1="29" x2="42" y2="35" stroke="#999" stroke-width="1"/>
                    </svg>`,
                    frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <rect x="10" y="15" width="40" height="15" rx="3" fill="#e74c3c"/>
                        <rect x="18" y="8" width="22" height="12" rx="2" fill="#e74c3c"/>
                        <rect x="20" y="10" width="8" height="8" fill="#87CEEB"/>
                        <rect x="30" y="10" width="8" height="8" fill="#87CEEB"/>
                        <circle cx="18" cy="32" r="6" fill="#333"/><circle cx="18" cy="32" r="3" fill="#666"/>
                        <line x1="15" y1="32" x2="21" y2="32" stroke="#999" stroke-width="1"/>
                        <circle cx="42" cy="32" r="6" fill="#333"/><circle cx="42" cy="32" r="3" fill="#666"/>
                        <line x1="39" y1="32" x2="45" y2="32" stroke="#999" stroke-width="1"/>
                    </svg>`
                },
                'rocket': { // ë¡œì¼“ - ë¶ˆê½ƒ ê¹œë¹¡ì„
                    frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <ellipse cx="35" cy="22" rx="18" ry="10" fill="#3498db"/>
                        <polygon points="53,22 60,15 60,29" fill="#e74c3c"/>
                        <circle cx="50" cy="22" r="4" fill="#87CEEB"/>
                        <rect x="8" y="18" width="10" height="8" fill="#e74c3c"/>
                        <polygon points="8,22 2,18 2,26" fill="#f39c12"/>
                        <polygon points="2,22 -3,20 -3,24" fill="#e67e22"/>
                    </svg>`,
                    frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <ellipse cx="35" cy="22" rx="18" ry="10" fill="#3498db"/>
                        <polygon points="53,22 60,15 60,29" fill="#e74c3c"/>
                        <circle cx="50" cy="22" r="4" fill="#87CEEB"/>
                        <rect x="8" y="18" width="10" height="8" fill="#e74c3c"/>
                        <polygon points="8,22 0,16 0,28" fill="#f1c40f"/>
                        <polygon points="0,22 -5,19 -5,25" fill="#f39c12"/>
                    </svg>`
                },
                'bird': { // ìƒˆ - ë‚ ê°œ í„ëŸ­ì„
                    frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <ellipse cx="30" cy="25" rx="15" ry="8" fill="#9b59b6"/>
                        <circle cx="48" cy="22" r="7" fill="#9b59b6"/>
                        <polygon points="55,22 62,20 62,24" fill="#f39c12"/>
                        <circle cx="52" cy="20" r="2" fill="black"/>
                        <path d="M25,25 Q15,10 30,18" fill="#8e44ad"/>
                        <path d="M35,25 Q25,8 40,16" fill="#8e44ad"/>
                        <polygon points="12,28 8,32 15,30" fill="#9b59b6"/>
                    </svg>`,
                    frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <ellipse cx="30" cy="25" rx="15" ry="8" fill="#9b59b6"/>
                        <circle cx="48" cy="22" r="7" fill="#9b59b6"/>
                        <polygon points="55,22 62,20 62,24" fill="#f39c12"/>
                        <circle cx="52" cy="20" r="2" fill="black"/>
                        <path d="M25,25 Q15,35 30,30" fill="#8e44ad"/>
                        <path d="M35,25 Q25,38 40,32" fill="#8e44ad"/>
                        <polygon points="12,28 8,32 15,30" fill="#9b59b6"/>
                    </svg>`
                },
                'boat': { // ë³´íŠ¸ - ë¬¼ê²° íš¨ê³¼
                    frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <path d="M5,30 Q15,28 25,30 Q35,32 45,30 Q55,28 60,30" fill="none" stroke="#3498db" stroke-width="3"/>
                        <polygon points="10,28 50,28 45,20 15,20" fill="#e74c3c"/>
                        <rect x="28" y="10" width="4" height="12" fill="#8b4513"/>
                        <polygon points="32,8 32,18 50,14" fill="white"/>
                    </svg>`,
                    frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <path d="M5,30 Q15,32 25,30 Q35,28 45,30 Q55,32 60,30" fill="none" stroke="#3498db" stroke-width="3"/>
                        <polygon points="10,28 50,28 45,20 15,20" fill="#e74c3c"/>
                        <rect x="28" y="10" width="4" height="12" fill="#8b4513"/>
                        <polygon points="32,8 32,18 50,14" fill="white"/>
                    </svg>`
                },
                'bicycle': { // ìì „ê±° - í˜ë‹¬ íšŒì „
                    frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <circle cx="12" cy="30" r="8" fill="none" stroke="#333" stroke-width="2"/>
                        <circle cx="48" cy="30" r="8" fill="none" stroke="#333" stroke-width="2"/>
                        <line x1="12" y1="30" x2="30" y2="30" stroke="#666" stroke-width="2"/>
                        <line x1="30" y1="30" x2="48" y2="30" stroke="#666" stroke-width="2"/>
                        <line x1="30" y1="30" x2="35" y2="15" stroke="#666" stroke-width="2"/>
                        <circle cx="35" cy="13" r="4" fill="#f39c12"/>
                        <circle cx="30" cy="30" r="3" fill="#333"/>
                        <line x1="30" y1="30" x2="33" y2="35" stroke="#333" stroke-width="2"/>
                        <line x1="30" y1="30" x2="27" y2="25" stroke="#333" stroke-width="2"/>
                    </svg>`,
                    frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <circle cx="12" cy="30" r="8" fill="none" stroke="#333" stroke-width="2"/>
                        <circle cx="48" cy="30" r="8" fill="none" stroke="#333" stroke-width="2"/>
                        <line x1="12" y1="30" x2="30" y2="30" stroke="#666" stroke-width="2"/>
                        <line x1="30" y1="30" x2="48" y2="30" stroke="#666" stroke-width="2"/>
                        <line x1="30" y1="30" x2="35" y2="15" stroke="#666" stroke-width="2"/>
                        <circle cx="35" cy="13" r="4" fill="#f39c12"/>
                        <circle cx="30" cy="30" r="3" fill="#333"/>
                        <line x1="30" y1="30" x2="27" y2="35" stroke="#333" stroke-width="2"/>
                        <line x1="30" y1="30" x2="33" y2="25" stroke="#333" stroke-width="2"/>
                    </svg>`
                },
                'rabbit': { // í† ë¼ - ê¹¡ì¶©ê¹¡ì¶©
                    frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <ellipse cx="30" cy="28" rx="14" ry="10" fill="#f5f5dc"/>
                        <circle cx="45" cy="22" r="8" fill="#f5f5dc"/>
                        <ellipse cx="40" cy="8" rx="3" ry="10" fill="#f5f5dc"/>
                        <ellipse cx="48" cy="10" rx="3" ry="9" fill="#f5f5dc"/>
                        <ellipse cx="40" cy="10" rx="2" ry="6" fill="#ffb6c1"/>
                        <ellipse cx="48" cy="12" rx="2" ry="5" fill="#ffb6c1"/>
                        <circle cx="50" cy="20" r="2" fill="black"/>
                        <circle cx="47" cy="26" r="2" fill="#ffb6c1"/>
                        <ellipse cx="18" cy="32" rx="5" ry="4" fill="#f5f5dc"/>
                        <ellipse cx="25" cy="35" rx="4" ry="3" fill="#f5f5dc"/>
                        <circle cx="14" cy="30" r="4" fill="#f5f5dc"/>
                    </svg>`,
                    frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <ellipse cx="30" cy="24" rx="14" ry="10" fill="#f5f5dc"/>
                        <circle cx="45" cy="18" r="8" fill="#f5f5dc"/>
                        <ellipse cx="40" cy="4" rx="3" ry="10" fill="#f5f5dc"/>
                        <ellipse cx="48" cy="6" rx="3" ry="9" fill="#f5f5dc"/>
                        <ellipse cx="40" cy="6" rx="2" ry="6" fill="#ffb6c1"/>
                        <ellipse cx="48" cy="8" rx="2" ry="5" fill="#ffb6c1"/>
                        <circle cx="50" cy="16" r="2" fill="black"/>
                        <circle cx="47" cy="22" r="2" fill="#ffb6c1"/>
                        <ellipse cx="20" cy="38" rx="5" ry="4" fill="#f5f5dc"/>
                        <ellipse cx="28" cy="40" rx="4" ry="3" fill="#f5f5dc"/>
                        <circle cx="14" cy="35" r="4" fill="#f5f5dc"/>
                    </svg>`
                },
                'turtle': { // ê±°ë¶ì´ - ëŠë¦¿ëŠë¦¿
                    frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <ellipse cx="30" cy="28" rx="18" ry="12" fill="#228B22"/>
                        <path d="M15,20 Q30,10 45,20" fill="#006400"/>
                        <ellipse cx="50" cy="28" rx="6" ry="5" fill="#8FBC8F"/>
                        <circle cx="54" cy="26" r="2" fill="black"/>
                        <ellipse cx="18" cy="36" rx="4" ry="3" fill="#8FBC8F"/>
                        <ellipse cx="42" cy="36" rx="4" ry="3" fill="#8FBC8F"/>
                        <ellipse cx="20" cy="24" rx="3" ry="2" fill="#8FBC8F"/>
                        <ellipse cx="40" cy="24" rx="3" ry="2" fill="#8FBC8F"/>
                        <circle cx="10" cy="30" r="3" fill="#8FBC8F"/>
                    </svg>`,
                    frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <ellipse cx="30" cy="28" rx="18" ry="12" fill="#228B22"/>
                        <path d="M15,20 Q30,10 45,20" fill="#006400"/>
                        <ellipse cx="52" cy="28" rx="6" ry="5" fill="#8FBC8F"/>
                        <circle cx="56" cy="26" r="2" fill="black"/>
                        <ellipse cx="16" cy="38" rx="4" ry="3" fill="#8FBC8F"/>
                        <ellipse cx="40" cy="38" rx="4" ry="3" fill="#8FBC8F"/>
                        <ellipse cx="22" cy="22" rx="3" ry="2" fill="#8FBC8F"/>
                        <ellipse cx="42" cy="22" rx="3" ry="2" fill="#8FBC8F"/>
                        <circle cx="8" cy="32" r="3" fill="#8FBC8F"/>
                    </svg>`
                },
                'eagle': { // ë…ìˆ˜ë¦¬ - ë‚ ê°œ í„ëŸ­ì„
                    frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <ellipse cx="30" cy="25" rx="12" ry="7" fill="#8B4513"/>
                        <circle cx="48" cy="22" r="7" fill="#8B4513"/>
                        <polygon points="55,22 63,20 63,24" fill="#FFD700"/>
                        <polygon points="55,22 63,22 58,25" fill="#DAA520"/>
                        <circle cx="52" cy="19" r="2" fill="black"/>
                        <path d="M22,25 Q5,8 28,18" fill="#654321"/>
                        <path d="M35,25 Q55,5 40,18" fill="#654321"/>
                        <polygon points="15,28 10,32 18,30" fill="#8B4513"/>
                    </svg>`,
                    frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <ellipse cx="30" cy="25" rx="12" ry="7" fill="#8B4513"/>
                        <circle cx="48" cy="22" r="7" fill="#8B4513"/>
                        <polygon points="55,22 63,20 63,24" fill="#FFD700"/>
                        <polygon points="55,22 63,22 58,25" fill="#DAA520"/>
                        <circle cx="52" cy="19" r="2" fill="black"/>
                        <path d="M22,25 Q5,38 28,32" fill="#654321"/>
                        <path d="M35,25 Q55,40 40,32" fill="#654321"/>
                        <polygon points="15,28 10,32 18,30" fill="#8B4513"/>
                    </svg>`
                },
                'scooter': { // í‚¥ë³´ë“œ - ë°”í€´ íšŒì „ (ì˜¤ë¥¸ìª½ ë°©í–¥)
                    frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <circle cx="12" cy="35" r="6" fill="#333"/>
                        <circle cx="48" cy="35" r="6" fill="#333"/>
                        <line x1="48" y1="35" x2="48" y2="15" stroke="#666" stroke-width="3"/>
                        <line x1="12" y1="35" x2="48" y2="35" stroke="#333" stroke-width="2"/>
                        <rect x="42" y="12" width="10" height="4" rx="2" fill="#666"/>
                        <circle cx="25" cy="20" r="5" fill="#3498db"/>
                        <line x1="25" y1="25" x2="25" y2="35" stroke="#333" stroke-width="2"/>
                        <line x1="25" y1="35" x2="22" y2="42" stroke="#333" stroke-width="2"/>
                        <line x1="25" y1="35" x2="28" y2="42" stroke="#333" stroke-width="2"/>
                    </svg>`,
                    frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <circle cx="12" cy="35" r="6" fill="#333"/>
                        <circle cx="48" cy="35" r="6" fill="#333"/>
                        <line x1="48" y1="35" x2="48" y2="15" stroke="#666" stroke-width="3"/>
                        <line x1="12" y1="35" x2="48" y2="35" stroke="#333" stroke-width="2"/>
                        <rect x="42" y="12" width="10" height="4" rx="2" fill="#666"/>
                        <circle cx="25" cy="20" r="5" fill="#3498db"/>
                        <line x1="25" y1="25" x2="25" y2="35" stroke="#333" stroke-width="2"/>
                        <line x1="25" y1="35" x2="28" y2="42" stroke="#333" stroke-width="2"/>
                        <line x1="25" y1="35" x2="22" y2="42" stroke="#333" stroke-width="2"/>
                    </svg>`
                },
                'helicopter': { // í—¬ë¦¬ì½¥í„° - í”„ë¡œí ëŸ¬ íšŒì „
                    frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <ellipse cx="30" cy="25" rx="18" ry="10" fill="#e74c3c"/>
                        <rect x="45" y="22" width="15" height="4" fill="#c0392b"/>
                        <polygon points="58,20 62,24 58,28" fill="#c0392b"/>
                        <circle cx="40" cy="22" r="5" fill="#87CEEB"/>
                        <line x1="30" y1="15" x2="30" y2="10" stroke="#333" stroke-width="2"/>
                        <line x1="15" y1="10" x2="45" y2="10" stroke="#333" stroke-width="2"/>
                        <line x1="25" y1="35" x2="25" y2="40" stroke="#333" stroke-width="2"/>
                        <line x1="35" y1="35" x2="35" y2="40" stroke="#333" stroke-width="2"/>
                        <line x1="20" y1="40" x2="40" y2="40" stroke="#333" stroke-width="2"/>
                    </svg>`,
                    frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <ellipse cx="30" cy="25" rx="18" ry="10" fill="#e74c3c"/>
                        <rect x="45" y="22" width="15" height="4" fill="#c0392b"/>
                        <polygon points="58,20 62,24 58,28" fill="#c0392b"/>
                        <circle cx="40" cy="22" r="5" fill="#87CEEB"/>
                        <line x1="30" y1="15" x2="30" y2="10" stroke="#333" stroke-width="2"/>
                        <line x1="20" y1="8" x2="40" y2="12" stroke="#333" stroke-width="2"/>
                        <line x1="25" y1="35" x2="25" y2="40" stroke="#333" stroke-width="2"/>
                        <line x1="35" y1="35" x2="35" y2="40" stroke="#333" stroke-width="2"/>
                        <line x1="20" y1="40" x2="40" y2="40" stroke="#333" stroke-width="2"/>
                    </svg>`
                }
            };
            
            return svgMap[vehicleId] || svgMap['car'];
        }
        
        // íƒˆê²ƒë³„ ë°°ê²½ ìƒì„± í•¨ìˆ˜
        function getVehicleBackground(vehicleId) {
            const bgMap = {
                'car': { bg: 'linear-gradient(0deg, #333 0%, #333 30%, #555 30%, #555 70%, #87CEEB 70%, #87CEEB 100%)', textColor: '#fff', extra: 'road' },
                'rocket': { bg: 'linear-gradient(0deg, #0a0a2e 0%, #1a1a4e 50%, #2a2a6e 100%)', textColor: '#fff', extra: 'stars' },
                'bird': { bg: 'linear-gradient(0deg, #5dade2 0%, #85c1e9 50%, #aed6f1 100%)', textColor: '#333', extra: 'clouds' },
                'boat': { bg: 'linear-gradient(0deg, #1a5276 0%, #2980b9 50%, #5dade2 100%)', textColor: '#fff', extra: 'waves' },
                'bicycle': { bg: 'linear-gradient(0deg, #784212 0%, #784212 40%, #27ae60 40%, #27ae60 100%)', textColor: '#fff', extra: '' },
                'rabbit': { bg: 'linear-gradient(0deg, #784212 0%, #784212 30%, #2ecc71 30%, #2ecc71 100%)', textColor: '#fff', extra: 'carrots' },
                'turtle': { bg: 'linear-gradient(0deg, #f5cba7 0%, #f5cba7 50%, #5dade2 50%, #5dade2 100%)', textColor: '#333', extra: '' },
                'eagle': { bg: 'linear-gradient(0deg, #566573 0%, #85929e 30%, #aeb6bf 60%, #d5dbdb 100%)', textColor: '#333', extra: 'mountains' },
                'scooter': { bg: 'linear-gradient(0deg, #616a6b 0%, #616a6b 35%, #82e0aa 35%, #82e0aa 100%)', textColor: '#fff', extra: '' },
                'helicopter': { bg: 'linear-gradient(0deg, #2c3e50 0%, #34495e 30%, #5dade2 60%, #85c1e9 100%)', textColor: '#fff', extra: 'buildings' }
            };
            return bgMap[vehicleId] || bgMap['car'];
        }
        
        // ê²½ì£¼ ê²°ê³¼ í‘œì‹œ
        function showRaceResult(data) {
            isRaceActive = false;
            
            const winners = data.winners || [];
            const horseRankings = data.horseRankings || [];
            const gameMode = data.horseRaceMode || 'first';
            
            addDebugLog(`ê²½ì£¼ ê²°ê³¼: ë‹¹ì²¨ì ${winners.length}ëª… (${winners.join(', ')})`, 'race');
            
            // ê²°ê³¼ ì˜¤ë²„ë ˆì´ í‘œì‹œ
            const rankingsDiv = document.getElementById('resultRankings');
            if (rankingsDiv) {
                let rankingsHtml = '<div style="font-size: 16px; font-weight: bold; margin-bottom: 15px;">ğŸ ìˆœìœ„</div>';
                
                horseRankings.forEach((horseIndex, index) => {
                    const userName = Object.entries(userHorseBets).find(([_, h]) => h === horseIndex)?.[0] || `ë§ ${horseIndex + 1}`;
                    const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}ë“±`;
                    const isWinner = winners.includes(userName);
                    const style = isWinner ? 'color: #8b4513; font-weight: bold;' : '';
                    rankingsHtml += `<div style="font-size: 14px; margin: 5px 0; ${style}">${medal} ${userName}${isWinner ? ' â­' : ''}</div>`;
                });
                
                rankingsDiv.innerHTML = rankingsHtml;
            }
            
            // ë‹¹ì²¨ì í‘œì‹œ
            const winnerDiv = document.getElementById('resultWinner');
            if (winnerDiv) {
                const modeText = gameMode === 'first' ? '1ë“±' : 'ê¼´ë“±';
                if (winners.length === 0) {
                    winnerDiv.textContent = 'ë‹¹ì²¨ì ì—†ìŒ';
                } else if (winners.length === 1) {
                    winnerDiv.textContent = `ğŸŠ ${winners[0]} ğŸŠ`;
                } else {
                    winnerDiv.textContent = winners.join(', ');
                }
            }
            
            // ë©”ì‹œì§€ í‘œì‹œ
            const messageDiv = document.getElementById('resultMessage');
            if (messageDiv) {
                if (winners.length >= 2) {
                    messageDiv.textContent = 'ë™ì ! ì¬ê²½ì£¼ë¥¼ ì§„í–‰í•´ì•¼ í•©ë‹ˆë‹¤.';
                } else if (winners.length === 1) {
                    messageDiv.textContent = 'ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰';
                } else {
                    messageDiv.textContent = 'ë‹¹ì²¨ìê°€ ì—†ìŠµë‹ˆë‹¤.';
                }
            }
            
            document.getElementById('resultOverlay').classList.add('visible');
            
            // ê²Œì„ ìƒíƒœ ì—…ë°ì´íŠ¸
            const gameStatus = document.getElementById('gameStatus');
            if (gameStatus) {
                gameStatus.textContent = 'ê²½ì£¼ ì¢…ë£Œ!';
                gameStatus.style.background = '#e9ecef';
                gameStatus.style.color = '#495057';
            }
            
            // í˜¸ìŠ¤íŠ¸ì—ê²Œ ì¢…ë£Œ ë²„íŠ¼ í‘œì‹œ
            if (isHost) {
                document.getElementById('endGameSection').style.display = 'block';
                
                // ë™ì ì¼ ë•Œë§Œ ì¬ê²½ì£¼ ì¤€ë¹„ ë²„íŠ¼ í‘œì‹œ
                if (winners.length >= 2) {
                    const endSection = document.getElementById('endGameSection');
                    endSection.innerHTML = `
                        <button class="end-button" onclick="requestReraceReady()" style="background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%); margin-bottom: 10px;">ğŸ”„ ì¬ê²½ì£¼ ì¤€ë¹„</button>
                        <button class="end-button" onclick="endHorseRaceGame()">ğŸ ê²Œì„ ì¢…ë£Œ</button>
                    `;
                } else {
                    const endSection = document.getElementById('endGameSection');
                    endSection.innerHTML = `
                        <button class="end-button" onclick="endHorseRaceGame()">ğŸ ê²Œì„ ì¢…ë£Œ</button>
                    `;
                }
            }
            
            // ê²½ì£¼ íŠ¸ë™ì€ ìœ ì§€ (ê²Œì„ ì¢…ë£Œ ì‹œê¹Œì§€)
        }
        
        // ì¬ê²½ì£¼ ì¤€ë¹„ ìš”ì²­
        function requestReraceReady() {
            addDebugLog('ì¬ê²½ì£¼ ì¤€ë¹„ ìš”ì²­', 'rerace');
            socket.emit('requestReraceReady');
        }
        
        // ì¬ê²½ì£¼ ì‹œì‘ ìš”ì²­
        function startRerace() {
            addDebugLog('ì¬ê²½ì£¼ ì‹œì‘ ìš”ì²­', 'rerace');
            socket.emit('startRerace');
        }
        
        // ì¬ê²½ì£¼ ë²„íŠ¼ ì—…ë°ì´íŠ¸ (í˜¸ìŠ¤íŠ¸ ì „ìš©)
        function updateReraceButton() {
            if (!isHost) return;
            
            if (!isReraceActive) return;
            
            // ëª¨ë“  ì¬ê²½ì£¼ ëŒ€ìƒìê°€ íƒˆê²ƒì„ ì„ íƒí–ˆëŠ”ì§€ í™•ì¸
            const allSelected = currentRoundPlayers.every(player => userHorseBets[player] !== undefined);
            const selectedCount = currentRoundPlayers.filter(p => userHorseBets[p] !== undefined).length;
            
            addDebugLog(`ì¬ê²½ì£¼ ë²„íŠ¼ ì—…ë°ì´íŠ¸: ${selectedCount}/${currentRoundPlayers.length}ëª… ì„ íƒ, ëª¨ë‘ ì„ íƒ: ${allSelected}`, 'rerace');
            
            // í˜¸ìŠ¤íŠ¸ ì»¨íŠ¸ë¡¤ ì„¹ì…˜ì— ì¬ê²½ì£¼ ë²„íŠ¼ í‘œì‹œ
            const hostControls = document.getElementById('hostControls');
            if (hostControls) {
                const startButton = document.getElementById('startHorseRaceButton');
                if (startButton) {
                    if (allSelected) {
                        startButton.textContent = 'ğŸ”„ ì¬ê²½ì£¼';
                        startButton.disabled = false;
                        startButton.onclick = startRerace;
                    } else {
                        startButton.textContent = `ğŸ”„ ì¬ê²½ì£¼ (${selectedCount}/${currentRoundPlayers.length}ëª… ì„ íƒ)`;
                        startButton.disabled = true;
                        startButton.onclick = null;
                    }
                }
            }
        }

        // ì‚¬ìš©ì ëª©ë¡ ë Œë”ë§
        function updateUsers(users) {
            currentUsers = users;
            const usersList = document.getElementById('usersList');
            const usersCount = document.getElementById('usersCount');
            
            if (!usersList || !usersCount) return;
            
            usersCount.textContent = users.length;
            usersList.innerHTML = '';
            
            users.forEach(user => {
                const tag = document.createElement('span');
                tag.className = 'user-tag';
                if (user.isHost) {
                    tag.classList.add('host');
                }
                tag.textContent = user.name;
                usersList.appendChild(tag);
            });
        }

        // ê²Œì„ ê¸°ë¡ ë Œë”ë§
        function renderHistory() {
            const historyList = document.getElementById('historyList');
            if (!historyList) return;
            
            if (horseRaceHistory.length === 0) {
                historyList.innerHTML = '<div style="color: #999; text-align: center;">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }
            
            historyList.innerHTML = '';
            
            horseRaceHistory.slice().reverse().forEach(record => {
                const item = document.createElement('div');
                item.className = 'history-item';
                
                const winners = record.horseRankings[0] === record.userHorseBets[currentUser] ? [currentUser] : [];
                const winnerText = winners.length > 0 ? `ğŸŠ ë‹¹ì²¨: ${winners.join(', ')}` : '';
                
                item.innerHTML = `
                    <div class="history-round">${record.round}ë¼ìš´ë“œ (${record.time})</div>
                    <div class="history-participants">ì°¸ê°€ì: ${record.participants.join(', ')}</div>
                    <div class="history-winner">${winnerText || 'ë‹¹ì²¨ ì—†ìŒ'}</div>
                `;
                historyList.appendChild(item);
            });
        }

        // ì±„íŒ… ë©”ì‹œì§€ ì¶”ê°€
        function addChatMessage(data) {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';
            
            if (data.isSystem) {
                messageDiv.classList.add('system');
            }
            if (data.isHorseRaceWinner) {
                messageDiv.classList.add('winner');
            }
            
            const time = new Date(data.timestamp).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px;">${data.userName}</div>
                <div>${data.message}</div>
                <div style="font-size: 11px; color: #999; margin-top: 5px;">${time}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ë©”ì‹œì§€ ì „ì†¡
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message) {
                socket.emit('sendMessage', { message: message });
                input.value = '';
            }
        }

        // ì±„íŒ… ì—”í„°í‚¤ ì²˜ë¦¬
        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // ê²°ê³¼ ì˜¤ë²„ë ˆì´ ë‹«ê¸°
        function closeResultOverlay() {
            document.getElementById('resultOverlay').classList.remove('visible');
        }

        // ë°© í­íŒŒ ì¹´ìš´íŠ¸ë‹¤ìš´
        function startRoomExpiryCountdown(createdAt, expiryHours) {
            if (roomExpiryInterval) {
                clearInterval(roomExpiryInterval);
            }
            
            const expirySection = document.getElementById('roomExpirySection');
            const countdownElement = document.getElementById('roomExpiryCountdown');
            
            if (!expirySection || !countdownElement) return;
            
            expirySection.style.display = 'block';
            
            function updateCountdown() {
                const now = new Date();
                const createdAtDate = new Date(createdAt);
                const expiryTime = createdAtDate.getTime() + (expiryHours * 60 * 60 * 1000);
                const remaining = expiryTime - now.getTime();
                
                if (remaining <= 0) {
                    countdownElement.textContent = '00:00:00';
                    if (roomExpiryInterval) {
                        clearInterval(roomExpiryInterval);
                    }
                    return;
                }
                
                const hours = Math.floor(remaining / (1000 * 60 * 60));
                const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
                
                countdownElement.textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
            
            updateCountdown();
            roomExpiryInterval = setInterval(updateCountdown, 1000);
        }

        // ê²Œì„ í™”ë©´ ì´ˆê¸°í™”
        function initializeGameScreen(data) {
            document.getElementById('roomTitle').textContent = data.roomName || 'ê²½ë§ˆ ë°©';
            
            if (data.createdAt && data.expiryHours) {
                startRoomExpiryCountdown(data.createdAt, data.expiryHours);
            }
            
            // ì‚¬ìš©ì ëª©ë¡ ì´ˆê¸°í™”
            if (data.gameState && data.gameState.users) {
                currentUsers = data.gameState.users;
            }
            
            // ëˆ„ì  ì°¸ì—¬ì ëª©ë¡ ë³µì›
            if (data.everPlayedUsers && Array.isArray(data.everPlayedUsers)) {
                everPlayedUsers = [...data.everPlayedUsers];
            } else if (data.gameState && data.gameState.everPlayedUsers && Array.isArray(data.gameState.everPlayedUsers)) {
                everPlayedUsers = [...data.gameState.everPlayedUsers];
            } else {
                everPlayedUsers = [];
            }
            
            // ì£¼ë¬¸ë°›ê¸° ìƒíƒœ ì´ˆê¸°í™”
            isOrderActive = data.isOrderActive || false;
            ordersData = data.userOrders || {};
            
            // í˜¸ìŠ¤íŠ¸ UI ì„¤ì •
            if (isHost) {
                document.getElementById('hostBadge').style.display = 'inline-block';
                document.getElementById('hostControls').style.display = 'block';
                document.getElementById('gameModeSection').style.display = 'block';
                
                // ì£¼ë¬¸ë°›ê¸° ë²„íŠ¼ ìƒíƒœ
                if (isOrderActive) {
                    document.getElementById('startOrderButton').style.display = 'none';
                    document.getElementById('endOrderButton').style.display = 'block';
                } else {
                    document.getElementById('startOrderButton').style.display = 'block';
                    document.getElementById('endOrderButton').style.display = 'none';
                }
            } else {
                document.getElementById('hostBadge').style.display = 'none';
                document.getElementById('hostControls').style.display = 'none';
                document.getElementById('gameModeSection').style.display = 'none';
            }
            
            // ì£¼ë¬¸ë°›ê¸° ì„¹ì…˜ í‘œì‹œ
            if (isOrderActive) {
                document.getElementById('ordersSection').style.display = 'block';
                document.getElementById('myOrderInput').disabled = false;
                document.getElementById('orderSaveButton').disabled = false;
            } else {
                if (Object.keys(ordersData).length > 0) {
                    document.getElementById('ordersSection').style.display = 'block';
                }
                document.getElementById('myOrderInput').disabled = true;
                document.getElementById('orderSaveButton').disabled = true;
            }
            
            // ê¸°ë¡ ì„¹ì…˜ í‘œì‹œ
            document.getElementById('historySection').classList.add('visible');
            
            // ì±„íŒ… ê¸°ë¡ ë¡œë“œ
            if (data.chatHistory) {
                document.getElementById('chatMessages').innerHTML = '';
                data.chatHistory.forEach(msg => addChatMessage(msg));
            }
            
            // ê²½ë§ˆ ê¸°ë¡ ë¡œë“œ
            if (data.gameState && data.gameState.horseRaceHistory) {
                horseRaceHistory = data.gameState.horseRaceHistory;
                renderHistory();
            }
            
            // ì¤€ë¹„ ìƒíƒœ ë³µì›
            if (data.readyUsers) {
                readyUsers = data.readyUsers;
                isReady = readyUsers.includes(currentUser);
                renderReadyUsers();
                updateReadyButton();
            }
            
            // ê²½ë§ˆ ê²Œì„ ìƒíƒœ ë³µì› ë° ë§ ì„ íƒ UI í‘œì‹œ
            if (data.gameType === 'horse-race' || (data.gameState && data.gameState.availableHorses)) {
                const gameState = data.gameState || {};
                
                // ë§ ì„ íƒ UIê°€ ì´ë¯¸ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ìœ ì§€, ì—†ìœ¼ë©´ í™œì„±í™”
                if (gameState.availableHorses && gameState.availableHorses.length > 0 && !gameState.isHorseRaceActive) {
                    availableHorses = gameState.availableHorses;
                    userHorseBets = gameState.userHorseBets || {};
                    horseRaceMode = gameState.horseRaceMode || 'first';
                    currentRoundPlayers = gameState.currentRoundPlayers || gameState.users?.map(u => u.name) || [];
                    raceRound = gameState.raceRound || 1;
                    
                    mySelectedHorse = userHorseBets[currentUser] !== undefined ? userHorseBets[currentUser] : null;
                    
                    // ë§ ì„ íƒ ì„¹ì…˜ í‘œì‹œ
                    const horseSelectionSection = document.getElementById('horseSelectionSection');
                    if (horseSelectionSection) {
                        horseSelectionSection.classList.add('active');
                        renderHorseSelection();
                    }
                }
            }
        }

        // === ì†Œì¼“ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ===
        
        socket.on('connect', () => {
            document.getElementById('connectionStatus').textContent = 'â— ì—°ê²°ë¨';
            document.getElementById('connectionStatus').className = 'connection-status connected';
            
            const createRoomStatus = document.getElementById('createRoomConnectionStatus');
            if (createRoomStatus) {
                createRoomStatus.textContent = 'â— ì—°ê²°ë¨';
                createRoomStatus.className = 'connection-status connected';
            }
            
            if (document.getElementById('lobbySection').classList.contains('active')) {
                refreshRooms();
            }
        });

        socket.on('disconnect', () => {
            document.getElementById('connectionStatus').textContent = 'â— ì—°ê²° ëŠê¹€';
            document.getElementById('connectionStatus').className = 'connection-status disconnected';
        });

        socket.on('roomsList', (rooms) => {
            roomsList = rooms;
            renderRoomsList();
        });

        socket.on('roomsListUpdated', (rooms) => {
            roomsList = rooms;
            renderRoomsList();
        });

        socket.on('roomCreated', (data) => {
            currentRoomId = data.roomId;
            const hostInput = document.getElementById('createRoomHostNameInput');
            currentUser = (hostInput && hostInput.value.trim()) || data.userName || '';
            isHost = true;
            isReady = data.isReady || false;
            readyUsers = data.readyUsers || [];

            document.getElementById('lobbySection').classList.remove('active');
            document.getElementById('createRoomSection').classList.remove('active');
            document.getElementById('gameSection').classList.add('active');
            
            document.body.classList.remove('lobby-active');
            document.body.classList.add('game-active');

            initializeGameScreen(data);
            renderReadyUsers();
            updateReadyButton();
        });

        socket.on('roomJoined', (data) => {
            // ì„±ê³µ ì‹œ ì—ëŸ¬ í”Œë˜ê·¸ ì œê±°
            sessionStorage.removeItem('horseRaceFromDice');
            
            // ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê¸°
            document.getElementById('loadingScreen').style.display = 'none';
            
            currentRoomId = data.roomId;
            const globalInput = document.getElementById('globalUserNameInput');
            currentUser = (globalInput && globalInput.value.trim()) || data.userName || '';
            isHost = data.isHost;
            isReady = data.isReady || false;
            readyUsers = data.readyUsers || [];

            document.getElementById('lobbySection').classList.remove('active');
            document.getElementById('gameSection').classList.add('active');
            
            document.body.classList.remove('lobby-active');
            document.body.classList.add('game-active');

            initializeGameScreen(data);
            renderReadyUsers();
            updateReadyButton();
            
            // ê²½ë§ˆ ê²Œì„ì¸ ê²½ìš° ë§ ì„ íƒ UIê°€ í‘œì‹œë  ë•Œê¹Œì§€ ì ì‹œ ëŒ€ê¸° í›„ ë‹¤ì‹œ í™•ì¸
            if (data.gameType === 'horse-race') {
                setTimeout(() => {
                    const horseSelectionSection = document.getElementById('horseSelectionSection');
                    if (horseSelectionSection && !horseSelectionSection.classList.contains('active')) {
                        // ë§ ì„ íƒ UIê°€ ì•„ì§ í‘œì‹œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì„œë²„ì— ìš”ì²­
                        // horseSelectionReady ì´ë²¤íŠ¸ë¥¼ ê¸°ë‹¤ë¦¼ (ì„œë²„ì—ì„œ ìë™ìœ¼ë¡œ ë³´ëƒ„)
                    }
                }, 500);
            }
        });

        socket.on('roomError', (message) => {
            // ë‹¤ë¥¸ í˜ì´ì§€ì—ì„œ ì˜¨ ê²½ìš° ì£¼ì‚¬ìœ„ ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°
            const fromDice = sessionStorage.getItem('horseRaceFromDice');
            if (fromDice === 'true') {
                sessionStorage.removeItem('horseRaceFromDice');
                alert(message);
                window.location.href = '/dice-game-multiplayer.html';
                return;
            }
            
            // ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê³  ë¡œë¹„ ë³´ì—¬ì£¼ê¸°
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('lobbySection').style.display = 'block';
            alert(message);
        });

        socket.on('horseRaceError', (message) => {
            addDebugLog(`ì—ëŸ¬: ${message}`, 'error');
            alert(message);
        });

        socket.on('readyError', (message) => {
            alert(message);
        });

        // ë§ ì„ íƒ ì¤€ë¹„ ì´ë²¤íŠ¸
        // ì¬ê²½ì£¼ ì¤€ë¹„ ì´ë²¤íŠ¸ (ë™ì ì¼ ë•Œ í˜¸ìŠ¤íŠ¸ì—ê²Œ ì¬ê²½ì£¼ ì¤€ë¹„ ë²„íŠ¼ í‘œì‹œ)
        socket.on('reraceReady', (data) => {
            const winners = data.winners || [];
            const raceRound = data.raceRound || 1;
            
            addDebugLog(`ì¬ê²½ì£¼ ì¤€ë¹„ í•„ìš”: ${winners.length}ëª… ë™ì  (${winners.join(', ')})`, 'rerace');
            
            // í˜¸ìŠ¤íŠ¸ì—ê²Œ ì¬ê²½ì£¼ ì¤€ë¹„ ë²„íŠ¼ í‘œì‹œ
            if (isHost) {
                document.getElementById('endGameSection').style.display = 'block';
                const endSection = document.getElementById('endGameSection');
                endSection.innerHTML = `
                    <button class="end-button" onclick="requestReraceReady()" style="background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%); margin-bottom: 10px;">ğŸ”„ ì¬ê²½ì£¼ ì¤€ë¹„</button>
                    <button class="end-button" onclick="endHorseRaceGame()">ğŸ ê²Œì„ ì¢…ë£Œ</button>
                `;
            }
        });
        
        socket.on('horseSelectionReady', (data) => {
            availableHorses = data.availableHorses || [];
            userHorseBets = data.userHorseBets || {};
            horseRaceMode = data.horseRaceMode || 'first';
            currentRoundPlayers = data.participants || data.players || [];
            raceRound = data.raceRound || 1;
            selectedVehicleTypes = data.selectedVehicleTypes || null;
            isReraceActive = data.isRerace || false; // ì¬ê²½ì£¼ ìƒíƒœ ì €ì¥
            
            addDebugLog(`ë§ ì„ íƒ ì¤€ë¹„: ${availableHorses.length}ë§ˆë¦¬, ì°¸ê°€ì ${currentRoundPlayers.length}ëª…, ì¬ê²½ì£¼: ${isReraceActive}`, 'selection');
            
            mySelectedHorse = userHorseBets[currentUser] !== undefined ? userHorseBets[currentUser] : null;
            
            // ì¬ê²½ì£¼ ì‹œ ê²°ê³¼ ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
            const resultOverlay = document.getElementById('resultOverlay');
            if (resultOverlay) {
                resultOverlay.classList.remove('visible');
            }
            
            // ë§ ì„ íƒ ì„¹ì…˜ í‘œì‹œ
            document.getElementById('horseSelectionSection').classList.add('active');
            
            // ì¬ê²½ì£¼ì¸ ê²½ìš° í˜¸ìŠ¤íŠ¸ ì»¨íŠ¸ë¡¤ í‘œì‹œ
            if (isRerace && isHost) {
                document.getElementById('hostControls').style.display = 'block';
            }
            
            renderHorseSelection();
            
            // ì¬ê²½ì£¼ì¸ ê²½ìš° í˜¸ìŠ¤íŠ¸ì—ê²Œ ì¬ê²½ì£¼ ë²„íŠ¼ í‘œì‹œ ì¤€ë¹„
            if (isReraceActive && isHost) {
                updateReraceButton();
            }
        });

        // ë§ ì„ íƒ ì™„ë£Œ ì´ë²¤íŠ¸
        socket.on('horseSelected', (data) => {
            userHorseBets = data.userHorseBets || {};
            
            if (data.userName === currentUser) {
                mySelectedHorse = data.horseIndex;
            }
            
            renderHorseSelection();
        });

        // ë§ ì„ íƒ í˜„í™© ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸ (ë‹¤ë¥¸ ì‚¬ìš©ì ì„ íƒ ì‹œ)
        socket.on('horseSelectionUpdated', (data) => {
            userHorseBets = data.userHorseBets || {};
            
            const selectedCount = Object.keys(userHorseBets).length;
            addDebugLog(`ë§ ì„ íƒ ì—…ë°ì´íŠ¸: ${selectedCount}ëª… ì„ íƒ`, 'selection');
            
            // ë‚´ ì„ íƒ ìƒíƒœ í™•ì¸ (ì„ íƒ ì·¨ì†Œ ì‹œ undefinedê°€ ë  ìˆ˜ ìˆìŒ)
            if (userHorseBets[currentUser] !== undefined) {
                mySelectedHorse = userHorseBets[currentUser];
            } else {
                mySelectedHorse = null; // ì„ íƒ ì·¨ì†Œ
            }
            
            renderHorseSelection();
            
            // ì¬ê²½ì£¼ ë²„íŠ¼ ì—…ë°ì´íŠ¸ (ì¬ê²½ì£¼ì¸ ê²½ìš°)
            if (isReraceActive && isHost) {
                updateReraceButton();
            }
        });

        // ê²½ì£¼ ì‹œì‘ ì´ë²¤íŠ¸
        socket.on('horseRaceStarted', (data) => {
            isRaceActive = true;
            isReraceActive = false; // ê²½ì£¼ ì‹œì‘ ì‹œ ì¬ê²½ì£¼ ìƒíƒœ ì´ˆê¸°í™”
            
            addDebugLog(`ê²½ì£¼ ì‹œì‘: ë¼ìš´ë“œ ${data.raceRound || raceRound}, ${data.horseRankings?.length || 0}ë§ˆë¦¬`, 'race');
            
            // ì‚¬ìš©ì ë² íŒ… ì •ë³´ ì—…ë°ì´íŠ¸ (ê²½ì£¼ ì• ë‹ˆë©”ì´ì…˜ì—ì„œ ì‚¬ìš©)
            if (data.userHorseBets) {
                userHorseBets = data.userHorseBets;
            }
            
            // íƒˆê²ƒ íƒ€ì… ì—…ë°ì´íŠ¸
            if (data.selectedVehicleTypes) {
                selectedVehicleTypes = data.selectedVehicleTypes;
            }
            
            // ë§ ì„ íƒ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.getElementById('horseSelectionSection').classList.remove('active');
            
            // ê²½ì£¼ íŠ¸ë™ í‘œì‹œ
            const maxTime = startRaceAnimation(data.horseRankings, data.speeds);
            
            // ê²Œì„ ìƒíƒœ ì—…ë°ì´íŠ¸
            const gameStatus = document.getElementById('gameStatus');
            if (gameStatus) {
                gameStatus.textContent = 'ê²½ì£¼ ì§„í–‰ ì¤‘!';
                gameStatus.className = 'game-status playing';
                gameStatus.style.background = '#d4edda';
                gameStatus.style.color = '#155724';
            }
            
            // ê¸°ë¡ ì¶”ê°€
            if (data.record) {
                horseRaceHistory.push(data.record);
                renderHistory();
            }
            
            // ê²½ì£¼ ì¢…ë£Œ í›„ ê²°ê³¼ í‘œì‹œ (ê°€ì¥ ëŠë¦° ë§ ë„ì°© + 1ì´ˆ í›„)
            setTimeout(() => {
                showRaceResult(data);
            }, maxTime + 1500);
        });

        // ê²½ì£¼ ì¢…ë£Œ ì´ë²¤íŠ¸ (ì„œë²„ì—ì„œ ì§ì ‘ ë³´ë‚´ëŠ” ê²½ìš°)
        socket.on('horseRaceEnded', (data) => {
            // userHorseBets ì—…ë°ì´íŠ¸ (ì„œë²„ì—ì„œ ë³´ë‚¸ ê²½ìš°)
            if (data.userHorseBets) {
                userHorseBets = data.userHorseBets;
            }
            
            showRaceResult(data);
            
            // ì¤€ë¹„ ìƒíƒœ ì´ˆê¸°í™”
            isReady = false;
            mySelectedHorse = null;
            updateReadyButton();
        });

        // ì¤€ë¹„ ìƒíƒœ ë³€ê²½
        socket.on('readyStateChanged', (data) => {
            isReady = data.isReady;
            updateReadyButton();
        });

        // ì¤€ë¹„ ëª©ë¡ ì—…ë°ì´íŠ¸
        socket.on('readyUsersUpdated', (users) => {
            readyUsers = users || [];
            renderReadyUsers();
            
            isReady = readyUsers.includes(currentUser);
            updateReadyButton();
        });

        // ì‚¬ìš©ì ëª©ë¡ ì—…ë°ì´íŠ¸
        socket.on('updateUsers', (users) => {
            updateUsers(users);
        });

        // ì±„íŒ… ë©”ì‹œì§€ ìˆ˜ì‹ 
        socket.on('newMessage', (data) => {
            addChatMessage(data);
        });

        // ì£¼ë¬¸ë°›ê¸° ì´ë²¤íŠ¸
        socket.on('orderStarted', () => {
            isOrderActive = true;
            document.getElementById('ordersSection').style.display = 'block';
            document.getElementById('myOrderInput').disabled = false;
            document.getElementById('orderSaveButton').disabled = false;
            
            const gameStatus = document.getElementById('gameStatus');
            if (gameStatus) {
                gameStatus.textContent = 'ì£¼ë¬¸ë°›ê¸° ì§„í–‰ ì¤‘!';
                gameStatus.className = 'game-status playing';
            }
            
            if (isHost) {
                document.getElementById('startOrderButton').style.display = 'none';
                document.getElementById('endOrderButton').style.display = 'block';
            }
        });

        socket.on('orderEnded', () => {
            isOrderActive = false;
            document.getElementById('myOrderInput').disabled = true;
            document.getElementById('orderSaveButton').disabled = true;
            
            const gameStatus = document.getElementById('gameStatus');
            if (gameStatus) {
                gameStatus.textContent = 'ëŒ€ê¸° ì¤‘...';
                gameStatus.className = 'game-status waiting';
            }
            
            if (isHost) {
                document.getElementById('startOrderButton').style.display = 'block';
                document.getElementById('endOrderButton').style.display = 'none';
            }
        });

        socket.on('orderUpdated', (data) => {
            ordersData[data.userName] = data.order;
            renderOrders();
        });

        socket.on('updateOrders', (orders) => {
            ordersData = orders;
            renderOrders();
        });

        // ì£¼ë¬¸ë°›ê¸° í•¨ìˆ˜
        function startOrder() {
            socket.emit('startOrder');
        }

        function endOrder() {
            socket.emit('endOrder');
        }

        function updateMyOrder() {
            const orderInput = document.getElementById('myOrderInput');
            const order = orderInput.value.trim();
            socket.emit('updateOrder', { order: order });
        }

        function renderOrders() {
            const orderList = document.getElementById('orderList');
            if (!orderList) return;
            
            if (Object.keys(ordersData).length === 0) {
                orderList.innerHTML = '<div style="color: #999; text-align: center; padding: 10px;">ì•„ì§ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }
            
            orderList.innerHTML = '';
            Object.entries(ordersData).forEach(([userName, order]) => {
                if (!order) return;
                
                const orderItem = document.createElement('div');
                orderItem.style.cssText = 'background: white; padding: 12px; margin-bottom: 8px; border-radius: 6px; border-left: 3px solid #ffc107;';
                orderItem.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 5px;">${userName}</div>
                    <div>${order}</div>
                `;
                orderList.appendChild(orderItem);
            });
        }

        function showOrderList() {
            // ì£¼ë¬¸ ë¦¬ìŠ¤íŠ¸ëŠ” ì´ë¯¸ í‘œì‹œë˜ì–´ ìˆìŒ
            alert('ì£¼ë¬¸ ë¦¬ìŠ¤íŠ¸ëŠ” ì•„ë˜ì— í‘œì‹œë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
        }

        // ê²Œì„ ì¢…ë£Œ
        function endHorseRaceGame() {
            socket.emit('endHorseRace', {});
        }

        // ê²Œì„ ëª¨ë“œ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ 
        socket.on('horseRaceModeUpdated', (mode) => {
            horseRaceMode = mode;
            const modeRadio = document.querySelector(`input[name="horseRaceMode"][value="${mode}"]`);
            if (modeRadio) {
                modeRadio.checked = true;
            }
        });
        
        // íƒˆê²ƒ íƒ€ì… ì—…ë°ì´íŠ¸ ìˆ˜ì‹ 
        socket.on('vehicleTypesUpdated', (data) => {
            selectedVehicleTypes = data.vehicleTypes;
            availableHorses = data.availableHorses;
            userHorseBets = {}; // íƒˆê²ƒ ë³€ê²½ ì‹œ ì„ íƒ ì´ˆê¸°í™”
            mySelectedHorse = null;
            renderHorseSelection();
        });

        // ë°© ë‚˜ê°€ê¸°
        socket.on('roomLeft', () => {
            if (roomExpiryInterval) {
                clearInterval(roomExpiryInterval);
            }
            window.location.href = '/dice-game-multiplayer.html';
        });

        socket.on('roomDeleted', (data) => {
            alert(data.message || 'ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            if (roomExpiryInterval) {
                clearInterval(roomExpiryInterval);
            }
            window.location.href = '/dice-game-multiplayer.html';
        });

        // ë¹„ê³µê°œ ë°© ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
        document.addEventListener('DOMContentLoaded', () => {
            const privateCheckbox = document.getElementById('createRoomPrivateCheckbox');
            const passwordContainer = document.getElementById('createRoomPasswordContainer');
            
            if (privateCheckbox && passwordContainer) {
                privateCheckbox.addEventListener('change', function() {
                    passwordContainer.style.display = this.checked ? 'block' : 'none';
                    if (!this.checked) {
                        document.getElementById('createRoomPasswordInput').value = '';
                    }
                });
            }
            
            // ì €ì¥ëœ ì´ë¦„ ë¶ˆëŸ¬ì˜¤ê¸°
            const savedName = localStorage.getItem('horseRaceUserName');
            if (savedName) {
                document.getElementById('globalUserNameInput').value = savedName;
            }
            
            // URL íŒŒë¼ë¯¸í„°ë¡œ ë°© ìƒì„±/ì…ì¥ ìš”ì²­ì´ ì™”ëŠ”ì§€ í™•ì¸
            const urlParams = new URLSearchParams(window.location.search);
            
            // ë°© ìƒì„± ìš”ì²­
            if (urlParams.get('createRoom') === 'true') {
                const pendingRoom = localStorage.getItem('pendingHorseRaceRoom');
                if (pendingRoom) {
                    const roomData = JSON.parse(pendingRoom);
                    localStorage.removeItem('pendingHorseRaceRoom');
                    
                    socket.on('connect', function onConnect() {
                        socket.off('connect', onConnect);
                        
                        socket.emit('createRoom', {
                            userName: roomData.userName,
                            roomName: roomData.roomName,
                            isPrivate: roomData.isPrivate,
                            password: roomData.password,
                            gameType: 'horse-race',
                            expiryHours: roomData.expiryHours,
                            blockIPPerUser: roomData.blockIPPerUser,
                            deviceId: getDeviceId()
                        });
                    });
                    
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
            
            // ë°© ì…ì¥ ìš”ì²­
            if (urlParams.get('joinRoom') === 'true') {
                const pendingJoin = localStorage.getItem('pendingHorseRaceJoin');
                if (pendingJoin) {
                    const joinData = JSON.parse(pendingJoin);
                    localStorage.removeItem('pendingHorseRaceJoin');
                    
                    sessionStorage.setItem('horseRaceFromDice', 'true');
                    
                    document.getElementById('loadingScreen').style.display = 'flex';
                    document.getElementById('lobbySection').style.display = 'none';
                    
                    document.getElementById('globalUserNameInput').value = joinData.userName;
                    
                    socket.on('connect', function onJoinConnect() {
                        socket.off('connect', onJoinConnect);
                        
                        if (joinData.isPrivate) {
                            pendingRoomId = joinData.roomId;
                            pendingUserName = joinData.userName;
                            document.getElementById('passwordModal').style.display = 'flex';
                            document.getElementById('roomPasswordInput').focus();
                        } else {
                            socket.emit('joinRoom', {
                                roomId: joinData.roomId,
                                userName: joinData.userName,
                                isHost: false,
                                password: '',
                                deviceId: getDeviceId()
                            });
                        }
                    });
                    
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
        });
    </script>

    <!-- ë””ë²„ê·¸ ë¡œê·¸ ì„¹ì…˜ -->
    <div class="debug-log-section" id="debugLogSection" style="position: fixed; bottom: 20px; right: 20px; width: 400px; max-height: 300px; background: rgba(0, 0, 0, 0.9); color: #0f0; border-radius: 8px; padding: 15px; font-family: 'Courier New', monospace; font-size: 11px; z-index: 10000; overflow-y: auto; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #0f0; padding-bottom: 5px;">
            <div style="font-weight: bold; color: #0f0;">ğŸ› ë””ë²„ê·¸ ë¡œê·¸</div>
            <div style="display: flex; gap: 5px;">
                <button onclick="clearDebugLog()" style="background: #333; color: #0f0; border: 1px solid #0f0; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;">ì§€ìš°ê¸°</button>
                <button onclick="toggleDebugLog()" style="background: #333; color: #0f0; border: 1px solid #0f0; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;">ìˆ¨ê¸°ê¸°</button>
            </div>
        </div>
        <div id="debugLogContent" style="line-height: 1.4;"></div>
    </div>

    <script>
        // ë””ë²„ê·¸ ë¡œê·¸ í•¨ìˆ˜ (localhost:3000ì—ì„œë§Œ í™œì„±í™”)
        const isLocalhost = window.location.hostname === 'localhost' && window.location.port === '3000';
        let debugLogEnabled = isLocalhost;
        const MAX_LOG_LINES = 100;
        
        // localhost:3000ì´ ì•„ë‹ˆë©´ ë””ë²„ê·¸ ë¡œê·¸ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
        if (!isLocalhost) {
            const debugLogSection = document.getElementById('debugLogSection');
            if (debugLogSection) {
                debugLogSection.style.display = 'none';
            }
        }
        
        function addDebugLog(message, type = 'info') {
            if (!debugLogEnabled) return;
            
            const logSection = document.getElementById('debugLogSection');
            const logContent = document.getElementById('debugLogContent');
            
            if (!logSection || !logContent) return;
            
            const timestamp = new Date().toLocaleTimeString('ko-KR', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3 });
            const colors = {
                'info': '#0f0',
                'warn': '#ff0',
                'error': '#f00',
                'race': '#0ff',
                'selection': '#ff0',
                'rerace': '#f0f'
            };
            const color = colors[type] || '#0f0';
            
            const logLine = document.createElement('div');
            logLine.style.color = color;
            logLine.style.marginBottom = '2px';
            logLine.innerHTML = `[${timestamp}] ${message}`;
            
            logContent.appendChild(logLine);
            
            // ìµœëŒ€ ë¡œê·¸ ë¼ì¸ ìˆ˜ ì œí•œ
            while (logContent.children.length > MAX_LOG_LINES) {
                logContent.removeChild(logContent.firstChild);
            }
            
            // ìë™ ìŠ¤í¬ë¡¤
            logContent.scrollTop = logContent.scrollHeight;
            
            // ë¡œê·¸ ì„¹ì…˜ í‘œì‹œ
            logSection.style.display = 'block';
        }
        
        function clearDebugLog() {
            const logContent = document.getElementById('debugLogContent');
            if (logContent) {
                logContent.innerHTML = '';
            }
        }
        
        function toggleDebugLog() {
            const logSection = document.getElementById('debugLogSection');
            if (logSection) {
                logSection.style.display = logSection.style.display === 'none' ? 'block' : 'none';
            }
        }
    </script>
</body>
</html>
