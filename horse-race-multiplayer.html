<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>LAM Horse Race ğŸ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Yeon+Sung&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #8e99a4 0%, #7a8b99 50%, #6b7c8a 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            position: relative;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px auto;
        }
        
        body.lobby-active .container {
            margin-left: auto;
            margin-right: auto;
        }
        
        body.game-active .container {
            margin-left: calc((100vw - 1140px) / 2 + 160px);
            margin-right: auto;
            max-width: 800px;
        }
        
        body.game-active header,
        body.game-active footer {
            display: none;
        }

        h1 {
            text-align: center;
            color: #8b4513;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .lobby-section, .game-section, .create-room-section {
            display: none;
        }

        .lobby-section.active, .game-section.active, .create-room-section.active {
            display: block;
        }
        
        .rooms-list {
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
        }
        
        .room-item {
            background: white;
            border: 2px solid #8b4513;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .room-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 69, 19, 0.3);
        }
        
        .room-item.active {
            background: #f5e6d3;
            border-color: #8b4513;
        }
        
        .room-item.my-room {
            background: #fff3cd;
            border-color: #ffc107;
            border-width: 3px;
        }
        
        .my-room-badge {
            display: inline-block;
            background: #ffc107;
            color: #333;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .room-info {
            flex: 1;
        }
        
        .room-name {
            font-size: 18px;
            font-weight: 600;
            color: #8b4513;
            margin-bottom: 5px;
        }
        
        .room-details {
            font-size: 14px;
            color: #666;
        }
        
        .room-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            margin-top: 5px;
            display: inline-block;
        }
        
        .room-status.playing {
            background: #d4edda;
            color: #155724;
        }
        
        .room-status.waiting {
            background: #e0e0e0;
            color: #666;
        }
        
        .room-action {
            margin-left: 15px;
        }
        
        .room-action button {
            width: auto;
            padding: 10px 20px;
            color: #000;
            font-weight: 600;
        }
        
        .create-room-section {
            background: #f8f9fa;
            border: 2px solid #8b4513;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        button {
            background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%);
            color: #000;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-top: 10px;
            font-weight: 600;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(139, 69, 19, 0.3);
        }

        button:disabled {
            background: #ccc;
            color: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin-bottom: 10px;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus, input[type="password"]:focus {
            border-color: #8b4513;
            outline: none;
        }

        .connection-status {
            text-align: center;
            padding: 5px;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .connection-status.connected {
            color: #28a745;
        }

        .connection-status.disconnected {
            color: #dc3545;
        }

        .connection-sound-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .connection-sound-row label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #555;
            cursor: pointer;
        }
        .connection-sound-row input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        /* ê²½ì£¼ íŠ¸ë™ ì»¨í…Œì´ë„ˆ - ìŠ¤í¬ë¡¤ì€ ìœ ì§€, ìŠ¤í¬ë¡¤ë°”ë§Œ ìˆ¨ê¹€ */
        .race-track-container {
            position: relative;
            width: 100%;
            height: 400px;
            margin: 20px 0;
            overflow-x: auto;
            overflow-y: hidden;
            scrollbar-width: none;
            -ms-overflow-style: none;
            border-radius: 12px;
            background: linear-gradient(to bottom, #87CEEB 0%, #98D8C8 50%, #7CB342 100%);
        }
        .race-track-container::-webkit-scrollbar {
            display: none;
        }
        
        /* ìˆœìœ„ í‘œì‹œ ì´í™íŠ¸ */
        .finish-effect {
            z-index: 10000 !important;
        }

        /* ê²°ìŠ¹ì„  ìŠ¤íƒ€ì¼ */
        .finish-line {
            position: absolute;
            width: 6px;
            background: linear-gradient(to right, #ff0000, #cc0000);
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.8), inset 0 0 10px rgba(255, 255, 255, 0.3);
            z-index: 200;
            pointer-events: none;
            animation: finishLinePulse 1.5s ease-in-out infinite;
        }

        @keyframes countPop {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            70% { transform: scale(0.95); }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes finishLinePulse {
            0%, 100% {
                opacity: 1;
                box-shadow: 0 0 10px rgba(255, 0, 0, 0.8), inset 0 0 10px rgba(255, 255, 255, 0.3);
            }
            50% {
                opacity: 0.8;
                box-shadow: 0 0 20px rgba(255, 0, 0, 1), inset 0 0 15px rgba(255, 255, 255, 0.5);
            }
        }

        .race-track {
            position: relative;
            width: 100%;
            height: 100%;
            background-image: url('assets/backgrounds/race_track.png');
            background-repeat: repeat-x;
            background-size: auto 100%;
            background-position: 0 0;
        }

        /* Fallback: ì´ë¯¸ì§€ê°€ ì—†ì„ ê²½ìš° CSS ê·¸ë¼ë°ì´ì…˜ */
        .race-track:not([style*="background-image"]) {
            background: linear-gradient(to bottom, 
                #87CEEB 0%, 
                #87CEEB 20%,
                #98D8C8 20%,
                #98D8C8 40%,
                #7CB342 40%,
                #7CB342 60%,
                #98D8C8 60%,
                #98D8C8 80%,
                #87CEEB 80%,
                #87CEEB 100%);
        }

        /* ë§ ì»¨í…Œì´ë„ˆ */
        .horse {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            z-index: 10;
        }

        /* íƒˆê²ƒ ìŠ¤í”„ë¼ì´íŠ¸ ì• ë‹ˆë©”ì´ì…˜ - 2í”„ë ˆì„ */
        .vehicle-sprite {
            position: relative;
            width: 60px;
            height: 45px;
        }
        
        .vehicle-sprite .frame1,
        .vehicle-sprite .frame2 {
            position: absolute;
            top: 0;
            left: 0;
            width: 60px;
            height: 45px;
        }
        
        /* ì •ì§€ ìƒíƒœ: í”„ë ˆì„ 1ë§Œ ë³´ì„ */
        .vehicle-sprite .frame1 { opacity: 1; }
        .vehicle-sprite .frame2 { opacity: 0; }
        
        /* ë‹¬ë¦¬ëŠ” ìƒíƒœ: 2í”„ë ˆì„ êµì°¨ */
        @keyframes frame1Anim {
            0%, 49% { opacity: 1; }
            50%, 100% { opacity: 0; }
        }
        @keyframes frame2Anim {
            0%, 49% { opacity: 0; }
            50%, 100% { opacity: 1; }
        }
        
        .horse.racing .vehicle-sprite .frame1 { animation: frame1Anim 0.15s steps(1) infinite; }
        .horse.racing .vehicle-sprite .frame2 { animation: frame2Anim 0.15s steps(1) infinite; }
        
        /* ===== ê¸°ë¯¹ ì´í™íŠ¸ ìŠ¤íƒ€ì¼ ===== */
        
        /* ìŠ¤í”„ë¦°íŠ¸ ë¶ˆê½ƒ ì´í™íŠ¸ */
        .gimmick-effect-sprint {
            position: absolute;
            left: -35px;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 30px;
            pointer-events: none;
            z-index: 1;
        }
        
        .flame {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-bottom: 25px solid #ff6600;
            filter: blur(1px);
            animation: flameFlicker 0.1s ease-in-out infinite alternate;
        }
        
        .flame:nth-child(1) { left: 0; animation-delay: 0s; border-bottom-color: #ff4400; }
        .flame:nth-child(2) { left: 10px; animation-delay: 0.05s; border-bottom-color: #ff6600; }
        .flame:nth-child(3) { left: 20px; animation-delay: 0.1s; border-bottom-color: #ffaa00; }
        
        .flame-core {
            position: absolute;
            left: 5px;
            top: 5px;
            width: 30px;
            height: 20px;
            background: radial-gradient(ellipse at right, #fff 0%, #ffff00 20%, #ff6600 50%, transparent 70%);
            filter: blur(2px);
            animation: flamePulse 0.15s ease-in-out infinite alternate;
        }
        
        @keyframes flameFlicker {
            0% { transform: scaleY(0.8) rotate(-5deg); opacity: 0.8; }
            100% { transform: scaleY(1.2) rotate(5deg); opacity: 1; }
        }
        
        @keyframes flamePulse {
            0% { transform: scaleX(0.8); opacity: 0.9; }
            100% { transform: scaleX(1.2); opacity: 1; }
        }
        
        /* ì†ë„ì„  ì´í™íŠ¸ */
        .speed-lines {
            position: absolute;
            left: -50px;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 40px;
            pointer-events: none;
            z-index: 0;
        }
        
        .speed-line {
            position: absolute;
            height: 2px;
            background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,100,50,0.8) 50%, rgba(255,200,100,0.5) 100%);
            animation: speedLineMove 0.2s linear infinite;
        }
        
        .speed-line:nth-child(1) { top: 5px; width: 30px; animation-delay: 0s; }
        .speed-line:nth-child(2) { top: 12px; width: 40px; animation-delay: 0.05s; }
        .speed-line:nth-child(3) { top: 19px; width: 35px; animation-delay: 0.1s; }
        .speed-line:nth-child(4) { top: 26px; width: 45px; animation-delay: 0.15s; }
        .speed-line:nth-child(5) { top: 33px; width: 25px; animation-delay: 0.08s; }
        
        @keyframes speedLineMove {
            0% { opacity: 0; transform: translateX(10px); }
            50% { opacity: 1; }
            100% { opacity: 0; transform: translateX(-20px); }
        }
        
        /* ë©ˆì¶¤ ë¸Œë ˆì´í¬ ì—°ê¸° ì´í™íŠ¸ */
        .gimmick-effect-stop {
            position: absolute;
            left: -20px;
            bottom: -5px;
            width: 50px;
            height: 30px;
            pointer-events: none;
            z-index: 1;
        }
        
        .brake-smoke {
            position: absolute;
            width: 15px;
            height: 15px;
            background: radial-gradient(circle, rgba(100,100,100,0.6) 0%, transparent 70%);
            border-radius: 50%;
            animation: smokeRise 0.5s ease-out infinite;
        }
        
        .brake-smoke:nth-child(1) { left: 0; animation-delay: 0s; }
        .brake-smoke:nth-child(2) { left: 15px; animation-delay: 0.1s; }
        .brake-smoke:nth-child(3) { left: 30px; animation-delay: 0.2s; }
        
        @keyframes smokeRise {
            0% { transform: translateY(0) scale(0.5); opacity: 0.8; }
            100% { transform: translateY(-20px) scale(1.5); opacity: 0; }
        }
        
        /* ëŠë¦¼ í”¼ë¡œ ì´í™íŠ¸ (ë•€ë°©ìš¸) */
        .gimmick-effect-slow {
            position: absolute;
            right: -5px;
            top: -10px;
            width: 20px;
            height: 20px;
            pointer-events: none;
            z-index: 2;
        }
        
        .sweat-drop {
            position: absolute;
            width: 6px;
            height: 10px;
            background: linear-gradient(to bottom, rgba(100,200,255,0.8) 0%, rgba(50,150,255,0.6) 100%);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            animation: sweatFall 0.6s ease-in infinite;
        }
        
        .sweat-drop:nth-child(1) { left: 0; animation-delay: 0s; }
        .sweat-drop:nth-child(2) { left: 10px; animation-delay: 0.3s; }
        
        @keyframes sweatFall {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(15px); opacity: 0; }
        }
        
        /* ë¯¸ë„ëŸ¬ì§ ë¨¼ì§€ ì´í™íŠ¸ */
        .gimmick-effect-slip {
            position: absolute;
            right: -25px;
            bottom: 0;
            width: 40px;
            height: 25px;
            pointer-events: none;
            z-index: 1;
        }
        
        .dust-cloud {
            position: absolute;
            width: 20px;
            height: 15px;
            background: radial-gradient(ellipse, rgba(180,140,100,0.7) 0%, transparent 70%);
            border-radius: 50%;
            animation: dustBurst 0.3s ease-out infinite;
        }
        
        .dust-cloud:nth-child(1) { left: 0; bottom: 0; animation-delay: 0s; }
        .dust-cloud:nth-child(2) { left: 15px; bottom: 5px; animation-delay: 0.1s; }
        
        @keyframes dustBurst {
            0% { transform: scale(0.5) translateX(0); opacity: 0.8; }
            100% { transform: scale(1.5) translateX(15px); opacity: 0; }
        }
        
        /* ì§€ê·¸ì¬ê·¸ ì–´ì§€ëŸ¬ì›€ ì´í™íŠ¸ */
        .gimmick-effect-wobble {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 16px;
            pointer-events: none;
            z-index: 2;
            animation: wobbleStars 0.3s ease-in-out infinite;
        }
        
        @keyframes wobbleStars {
            0%, 100% { transform: translateX(-50%) rotate(-10deg); }
            50% { transform: translateX(-50%) rotate(10deg); }
        }
        
        /* ê²°ê³¼ ì˜¤ë²„ë ˆì´ visible ìƒíƒœ */
        .result-overlay.visible {
            display: flex !important;
        }

        /* ë§ ì„ íƒ UI */
        .horse-selection-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .horse-selection-button {
            background: white;
            border: 3px solid #8b4513;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 48px;
        }

        .horse-selection-button:hover:not(:disabled) {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(139, 69, 19, 0.3);
            border-color: #a0522d;
        }

        .horse-selection-button.selected {
            background: #f5e6d3;
            border-color: #8b4513;
            border-width: 4px;
        }

        .horse-selection-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            filter: grayscale(80%);
            background: #f0f0f0;
            border-color: #999;
        }

        /* ì¤€ë¹„ ì„¹ì…˜ */
        .ready-section {
            background: #f5e6d3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #8b4513;
            font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* ì¤€ë¹„ ë²„íŠ¼ hover íš¨ê³¼ */
        #readyButton:hover {
            background: linear-gradient(135deg, #a0522d 0%, #8b4513 100%) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(139, 69, 19, 0.3);
        }

        .users-list {
            background: #faf5ef;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 50px;
        }
        
        /* ì¤€ë¹„ ì„¹ì…˜ ë‚´ë¶€ ë¦¬ìŠ¤íŠ¸ë„ ê°ˆìƒ‰í†¤ */
        .ready-section .users-list {
            background: #faf5ef;
        }

        .user-tag {
            background: white;
            border: 2px solid #8b4513;
            color: #8b4513;
            padding: 6px 12px;
            font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .user-tag.host {
            background: #8b4513;
            color: white;
        }
        
        /* ì£¼ë¬¸ë°›ê¸° ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .orders-section {
            margin-bottom: 20px;
            display: none;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .orders-section.active {
            display: block;
        }

        .my-order-box {
            background: #fff9e6;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .my-order-title {
            font-size: 16px;
            font-weight: 600;
            color: #856404;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .order-input-group {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            position: relative;
        }

        .order-input-wrapper {
            position: relative;
            width: 100%;
        }

        .autocomplete-suggestion {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 12px;
            color: #999;
            pointer-events: none;
            font-family: inherit;
            font-size: 16px;
            line-height: 1.5;
            border: 2px solid transparent;
            border-radius: 8px;
            z-index: 1;
        }

        #myOrderInput {
            position: relative;
            z-index: 2;
            background-color: transparent;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #8b4513;
            border-radius: 8px;
            margin-top: 4px;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        .autocomplete-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background-color: #fff9e6;
        }

        .menu-manager {
            display: none;
            background: #f8f9fa;
            border: 2px solid #8b4513;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .menu-manager.active {
            display: block;
        }

        .menu-manager-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: bold;
            color: #8b4513;
        }

        .menu-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 5px;
            background: white;
            border: 1px solid #ddd;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
        }

        .menu-item .delete-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 14px;
            padding: 0;
            margin-left: 5px;
        }

        .order-list-container {
            max-height: 300px;
            overflow-y: auto;
        }

        .order-item {
            background: white;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 3px solid #d2b48c;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .order-item:last-child {
            margin-bottom: 0;
        }

        .order-item-left {
            flex: 1;
        }

        .order-user {
            font-weight: 600;
            color: #8b4513;
            margin-bottom: 4px;
        }

        .order-text {
            color: #666;
            font-size: 20px;
            font-weight: 600;
            word-break: break-word;
        }

        .order-text.empty {
            color: #999;
            font-style: italic;
        }

        .order-count {
            font-size: 48px;
            font-weight: bold;
            color: #8b4513;
            margin-left: 15px;
        }

        .sort-buttons {
            display: flex;
            gap: 5px;
        }

        .sort-button {
            padding: 6px 12px;
            font-size: 12px;
            background: #e9ecef;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sort-button:hover {
            background: #dee2e6;
        }

        .sort-button.active {
            background: #8b4513;
            color: white;
        }

        .not-ordered-section {
            margin-bottom: 15px;
            padding: 12px;
            background: #fff5e6;
            border-radius: 8px;
            border-left: 4px solid #ff6b6b;
        }

        .not-ordered-title {
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .not-ordered-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .not-ordered-item {
            background: #ffe6e6;
            color: #cc0000;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
        }

        /* ê²Œì„ ê¸°ë¡ */
        .history-section {
            position: fixed;
            right: 20px;
            top: 20px;
            width: 320px;
            max-height: calc(100vh - 40px);
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            overflow-y: auto;
            display: none;
            z-index: 100;
        }

        .history-section.visible,
        body.game-active .history-section {
            display: block;
        }

        .history-title {
            font-size: 18px;
            font-weight: bold;
            color: #8b4513;
            margin-bottom: 15px;
            font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
        }

        .history-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #8b4513;
        }

        .history-round {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .history-participants {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .history-winner {
            font-size: 16px;
            font-weight: bold;
            color: #8b4513;
        }

        /* ì±„íŒ… ì„¹ì…˜ */
        .chat-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            border: 2px solid #8b4513;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .chat-messages {
            max-height: 480px;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .chat-message.system {
            margin-bottom: 10px;
            padding: 12px;
            background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%);
            color: white;
            text-align: center;
            font-weight: bold;
            border-radius: 8px;
        }

        .chat-message.winner {
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
            color: #333;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            padding: 15px;
            animation: celebrate 0.5s ease-in-out infinite alternate;
            border-radius: 8px;
        }

        @keyframes celebrate {
            from { transform: scale(1); }
            to { transform: scale(1.02); }
        }

        /* ì ‘ì†ì ëª©ë¡ */
        .users-section {
            margin-bottom: 20px;
        }

        .users-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #8b4513;
            font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* ë°© ì •ë³´ í—¤ë” */
        .room-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .room-title {
            font-size: 24px;
            color: #8b4513;
            font-weight: bold;
            margin-bottom: 5px;
            font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .host-badge {
            display: none;
            background: #ffc107;
            color: #333;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        /* í˜¸ìŠ¤íŠ¸ ì»¨íŠ¸ë¡¤ */
        .host-controls {
            display: none;
            background: linear-gradient(135deg, #fff3cd 0%, #ffe082 100%);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #ffc107;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .start-button {
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
            color: #000;
            font-size: 20px;
            padding: 15px 30px;
            font-weight: 600;
        }

        .start-button:disabled {
            background: #ccc;
            color: #666;
        }

        .end-button {
            background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
            color: #fff;
            font-weight: 600;
            font-size: 16px;
            padding: 15px 30px;
        }

        /* ê²°ê³¼ ì˜¤ë²„ë ˆì´ */
        .result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .result-overlay.visible {
            display: flex;
        }

        .result-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            animation: popup 0.5s ease-out;
            max-width: 90vw;
            max-height: 85vh;
            overflow-y: auto;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
        }
        
        @media (max-width: 768px) {
            .result-card {
                padding: 20px 15px;
                max-height: 80vh;
                font-size: 14px;
            }
            
            .result-card .result-title {
                font-size: 20px;
            }
        }

        @keyframes popup {
            from {
                transform: scale(0.5);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* ë„ì°© ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes finishBounce {
            0% { transform: scale(0) translateY(20px); opacity: 0; }
            50% { transform: scale(1.3) translateY(-10px); opacity: 1; }
            70% { transform: scale(0.9) translateY(0); }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }
        
        @keyframes finishGlow {
            0%, 100% { text-shadow: 0 0 10px gold, 0 0 20px gold, 2px 2px 4px rgba(0,0,0,0.5); }
            50% { text-shadow: 0 0 20px gold, 0 0 40px gold, 0 0 60px gold, 2px 2px 4px rgba(0,0,0,0.5); }
        }
        
        @keyframes finishFade {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes sparkleRing {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
        }
        
        /* ê¼´ë“± ì‚¬ë§ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes soulRise {
            0% { transform: translateY(0); opacity: 0.8; }
            100% { transform: translateY(-100px); opacity: 0; }
        }
        
        @keyframes tombstoneDrop {
            0% { transform: translateY(-150px); opacity: 0; }
            60% { transform: translateY(10px); opacity: 1; }
            80% { transform: translateY(-5px); }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes deathFade {
            0% { opacity: 1; filter: grayscale(0); }
            100% { opacity: 0; filter: grayscale(100%); visibility: hidden; }
        }
        
        @keyframes confettiFall {
            0% { opacity: 1; transform: translateY(0) rotate(0deg); }
            100% { opacity: 0; transform: translateY(80px) rotate(720deg); }
        }

        .result-title {
            font-size: 24px;
            color: #8b4513;
            margin-bottom: 20px;
            font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .result-winner {
            font-size: 48px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }

        .result-message {
            font-size: 18px;
            color: #666;
            margin-bottom: 30px;
        }

        /* ìˆœìœ„ ë°œí‘œ 1Â·2Â·3ë“± ë¸”ë¡ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes resultRankBounce {
            0% { transform: scale(0.95); opacity: 0.9; }
            50% { transform: scale(1.02); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .result-rank-1 { animation: resultRankBounce 0.6s ease-out, resultRankPulse 2s ease-in-out 0.6s infinite; }
        .result-rank-2 { animation: resultRankBounce 0.5s ease-out 0.1s both; }
        .result-rank-3 { animation: resultRankBounce 0.5s ease-out 0.2s both; }
        @keyframes resultRankPulse {
            0%, 100% { box-shadow: 0 4px 15px rgba(255,215,0,0.4); }
            50% { box-shadow: 0 6px 25px rgba(255,215,0,0.6); }
        }

        /* ë°© í­íŒŒ ì¹´ìš´íŠ¸ë‹¤ìš´ */
        .room-expiry-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        /* ë§ ì„ íƒ ì„¹ì…˜ */
        .horse-selection-section {
            display: none;
            background: #f8f9fa;
            border: 2px solid #8b4513;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .horse-selection-section.active {
            display: block;
        }

        /* ê²Œì„ ëª¨ë“œ ì„ íƒ */
        .game-mode-section {
            background: #f5e6d3;
            border: 2px solid #8b4513;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .game-mode-section label:hover {
            background: #faf5ef;
            transform: translateX(2px);
        }
        
        .game-mode-section label input[type="radio"]:checked + span {
            color: #8b4513;
            font-weight: 600;
        }

        @media (max-width: 1200px) {
            body.game-active .container {
                margin-left: auto;
                margin-right: auto;
            }
            
            .history-section {
                position: static;
                width: 100%;
                max-height: none;
                margin-top: 20px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
                border-radius: 15px;
            }

            h1 {
                font-size: 1.8em;
            }

            .race-track-container {
                height: 300px;
            }

            .horse-selection-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body class="lobby-active">
    <!-- ë¡œë”© í™”ë©´ -->
    <div id="loadingScreen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center;">
        <div style="text-align: center; color: white;">
            <div style="font-size: 80px; margin-bottom: 20px; animation: bounce 1s infinite;">ğŸ</div>
            <h2 style="font-size: 24px; margin-bottom: 10px;">ë°©ì— ì…ì¥ ì¤‘...</h2>
            <p style="font-size: 16px; opacity: 0.8;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
            <div style="margin-top: 30px;">
                <div style="width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
            </div>
        </div>
    </div>
    <style>
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
    </style>

    <div class="container">
        <!-- ë¡œë¹„ ì„¹ì…˜ -->
        <section class="lobby-section active" id="lobbySection">
            <h1>ğŸ LAM Horse Race</h1>
            <div class="connection-sound-row">
                <div class="connection-status connected" id="connectionStatus">â— ì—°ê²°ë¨</div>
                <label><input type="checkbox" id="soundCheckbox"> ğŸ”Š ì‚¬ìš´ë“œ</label>
            </div>
            
            <!-- ì´ë¦„ ì…ë ¥ -->
            <div style="background: #f5e6d3; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <label style="font-weight: bold; color: #8b4513; display: block; margin-bottom: 8px;">ğŸ‘¤ ë‚´ ì´ë¦„</label>
                <input type="text" id="globalUserNameInput" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="20">
            </div>
            
            <!-- ë°© ë§Œë“¤ê¸° ë²„íŠ¼ -->
            <button onclick="showCreateRoomSection()" style="margin-bottom: 20px; color: #000; font-weight: 600;">ğŸ ìƒˆ ê²½ë§ˆ ë°© ë§Œë“¤ê¸°</button>
            
            <!-- ë°© ëª©ë¡ -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="color: #8b4513;">ğŸ ë°© ëª©ë¡</h3>
                <button onclick="refreshRooms()" style="width: auto; padding: 8px 15px; font-size: 14px; color: #000; font-weight: 600;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div class="rooms-list" id="roomsList">
                <div style="color: #999; text-align: center; padding: 20px;">ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
            
            <!-- ì£¼ì‚¬ìœ„ ê²Œì„ ë§í¬ -->
            <div style="text-align: center; margin-top: 20px;">
                <a href="/dice-game-multiplayer.html" style="color: #8b4513; text-decoration: none;">ğŸ² ì£¼ì‚¬ìœ„ ê²Œì„ìœ¼ë¡œ ì´ë™</a>
            </div>
        </section>

        <!-- ë°© ìƒì„± ì„¹ì…˜ -->
        <section class="create-room-section" id="createRoomSection">
            <h2 style="color: #8b4513; margin-bottom: 20px;">ğŸ ìƒˆ ê²½ë§ˆ ë°© ë§Œë“¤ê¸°</h2>
            <div class="connection-status connected" id="createRoomConnectionStatus">â— ì—°ê²°ë¨</div>
            
            <div style="margin-bottom: 15px;">
                <label style="font-weight: bold; color: #333; display: block; margin-bottom: 5px;">í˜¸ìŠ¤íŠ¸ ì´ë¦„</label>
                <input type="text" id="createRoomHostNameInput" placeholder="í˜¸ìŠ¤íŠ¸ ì´ë¦„" maxlength="20">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="font-weight: bold; color: #333; display: block; margin-bottom: 5px;">ë°© ì œëª©</label>
                <input type="text" id="createRoomNameInput" placeholder="ë°© ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="30">
            </div>
            
            <!-- ë¹„ê³µê°œ ë°© ì„¤ì • -->
            <div style="margin-bottom: 15px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="createRoomPrivateCheckbox" style="width: auto; margin: 0;">
                    <span style="font-weight: bold; color: #333;">ğŸ”’ ë¹„ê³µê°œ ë°©</span>
                </label>
                <div id="createRoomPasswordContainer" style="display: none; margin-top: 10px;">
                    <input type="password" id="createRoomPasswordInput" placeholder="ë¹„ë°€ë²ˆí˜¸ (4~20ì)" maxlength="20">
                </div>
            </div>
            
            <!-- ë°© ìœ ì§€ ì‹œê°„ -->
            <div style="margin-bottom: 15px;">
                <label style="font-weight: bold; color: #333; display: block; margin-bottom: 8px;">â° ë°© ìœ ì§€ ì‹œê°„</label>
                <div style="display: flex; gap: 15px;">
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="radio" name="roomExpiryTime" value="1" style="width: auto; margin: 0;">
                        <span>1ì‹œê°„</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="radio" name="roomExpiryTime" value="3" checked style="width: auto; margin: 0;">
                        <span>3ì‹œê°„</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="radio" name="roomExpiryTime" value="6" style="width: auto; margin: 0;">
                        <span>6ì‹œê°„</span>
                    </label>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="goBackToLobby()" style="background: #6c757d; flex: 1; color: #000; font-weight: 600;">â† ì·¨ì†Œ</button>
                <button onclick="finalizeRoomCreation()" style="flex: 2; color: #000; font-weight: 600;">ğŸ ë°© ë§Œë“¤ê¸°</button>
            </div>
        </section>

        <!-- ê²Œì„ ì„¹ì…˜ -->
        <section class="game-section" id="gameSection">
            <!-- ë°© ì •ë³´ í—¤ë” -->
            <div class="room-header">
                <div style="display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <span class="room-title" id="roomTitle">ê²½ë§ˆ ë°©</span>
                    <span class="host-badge" id="hostBadge" style="display: none;">ğŸ‘‘ í˜¸ìŠ¤íŠ¸</span>
                    <label style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: #555; cursor: pointer; margin: 0;"><input type="checkbox" id="gameSectionSoundCheckbox"> ğŸ”Š ì‚¬ìš´ë“œ</label>
                </div>
                <div style="text-align: center; margin-top: 10px;">
                    <button onclick="leaveRoom()" style="width: auto; padding: 8px 15px; font-size: 12px; background: #6c757d; color: #000; font-weight: 600; border: none; border-radius: 8px; cursor: pointer;">ğŸšª ë‚˜ê°€ê¸°</button>
                </div>
            </div>

            <!-- ë°© í­íŒŒ ì¹´ìš´íŠ¸ë‹¤ìš´ -->
            <div class="room-expiry-section" id="roomExpirySection" style="display: none;">
                <div style="color: #856404; font-weight: bold; font-size: 14px;">
                    â° ë°© í­íŒŒê¹Œì§€ ë‚¨ì€ ì‹œê°„: <span id="roomExpiryCountdown" style="color: #d9534f;">--:--:--</span>
                </div>
            </div>

            <!-- ì ‘ì†ì ëª©ë¡ -->
            <div class="users-section" id="usersSection">
                <div class="users-title">
                    ğŸ‘¥ ì ‘ì†ì (<span id="usersCount">0</span>ëª…)
                    <span id="dragHint" style="display: none; font-size: 12px; color: #8b4513; font-weight: normal; margin-left: 10px;">
                        ğŸ’¡ ë“œë˜ê·¸ë¡œ ì¤€ë¹„ ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </span>
                </div>
                <div class="users-list" id="usersList"></div>
            </div>

            <!-- ì¤€ë¹„ ì„¹ì…˜ -->
            <div class="ready-section" id="readySection">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="users-title" style="margin: 0;">âœ… ì¤€ë¹„í•œ ì‚¬ëŒ (<span id="readyCount">0</span>ëª…)</div>
                    <button id="readyButton" onclick="toggleReady()" style="width: auto; padding: 10px 20px; background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%); color: #fff; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s;">ì¤€ë¹„</button>
                </div>
                <div class="users-list" id="readyUsersList">
                    <div style="color: #999; text-align: center; padding: 10px; width: 100%;">ì•„ì§ ì¤€ë¹„í•œ ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤</div>
                </div>
            </div>

            <!-- ê²Œì„ ëª¨ë“œ: ë¬´ì¡°ê±´ ê¼´ë“± ì°¾ê¸° (ëª¨ë“œ ì„ íƒ ì œê±°) -->

            <!-- íƒˆê²ƒ ì„ íƒ ì„¹ì…˜ -->
            <div class="horse-selection-section" id="horseSelectionSection">
                <div class="users-title" style="margin-bottom: 15px;">ğŸ íƒˆê²ƒ ì„ íƒ</div>
                <div id="horseSelectionGrid" class="horse-selection-grid">
                    <!-- íƒˆê²ƒ ì„ íƒ ë²„íŠ¼ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                </div>
                <div id="horseSelectionInfo" style="text-align: center; margin-top: 15px; color: #666; font-size: 14px;">
                    íƒˆê²ƒì„ ì„ íƒí•´ì£¼ì„¸ìš”
                </div>
            </div>

            <!-- í˜¸ìŠ¤íŠ¸ ì»¨íŠ¸ë¡¤ -->
            <div class="host-controls" id="hostControls" style="display: none; margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button class="start-button" id="startHorseRaceButton" onclick="startHorseRace()" disabled style="flex: 1;">
                        ê²Œì„ ì‹œì‘
                    </button>
                    <button onclick="OrderModule.startOrder()" id="startOrderButton" style="flex: 1; background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: #fff; font-weight: 600; font-size: 16px; padding: 15px;">ì£¼ë¬¸ë°›ê¸° ì‹œì‘</button>
                    <button onclick="OrderModule.endOrder()" id="endOrderButton" style="display: none; flex: 1; background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%); color: #fff; font-weight: 600; font-size: 16px; padding: 15px;">ì£¼ë¬¸ë°›ê¸° ì¢…ë£Œ</button>
                </div>
                <button onclick="clearHorseRaceData()" id="clearDataButton" style="width: 100%; background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%); color: #fff; font-weight: 600; font-size: 14px; padding: 12px;">ì´ì „ ê²Œì„ ë°ì´í„° ì‚­ì œ</button>
            </div>

            <!-- ì£¼ë¬¸ë°›ê¸° ì„¹ì…˜ -->
            <div class="orders-section" id="ordersSection" style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="users-title" style="font-weight: bold; color: #8b4513; font-size: 16px; margin: 0;">ğŸ” ì£¼ë¬¸ë°›ê¸°</div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="OrderModule.showOrderList()" id="showOrderListButton" style="width: auto; padding: 8px 16px; font-size: 14px; background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%); color: #000; font-weight: 600;">ğŸ“‹ ì£¼ë¬¸ë¦¬ìŠ¤íŠ¸</button>
                        <button onclick="OrderModule.sortOrders('asc')" class="sort-btn" style="padding: 6px 10px; font-size: 12px; background: #d2b48c; color: #333; border: none; border-radius: 4px; cursor: pointer;">ê°€ë‚˜ë‹¤ìˆœ</button>
                        <button onclick="OrderModule.sortOrders('count')" class="sort-btn" style="padding: 6px 10px; font-size: 12px; background: #d2b48c; color: #333; border: none; border-radius: 4px; cursor: pointer;">ì£¼ë¬¸ ë§ì€ ìˆœ</button>
                    </div>
                </div>
                
                <!-- ì£¼ë¬¸í•˜ì§€ ì•Šì€ ì‚¬ëŒ ëª©ë¡ -->
                <div id="notOrderedSection" style="display: none; margin-bottom: 10px; padding: 10px; background: #fff5e6; border-radius: 8px;">
                    <div style="font-weight: bold; color: #ff6b6b; margin-bottom: 8px; font-size: 13px;">â³ ì£¼ë¬¸í•˜ì§€ ì•Šì€ ì‚¬ëŒ</div>
                    <div id="notOrderedList" style="display: flex; flex-wrap: wrap; gap: 5px;"></div>
                </div>
                
                <!-- ë‚´ ì£¼ë¬¸ ì…ë ¥ -->
                <div style="background: #fff9e6; border: 2px solid #ffc107; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="font-size: 16px; font-weight: 600; color: #856404; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span>ğŸ“</span>
                            <span>ë‚´ ì£¼ë¬¸</span>
                        </div>
                        <button onclick="OrderModule.toggleMenuManager()" style="width: auto; padding: 6px 12px; font-size: 12px; background: #f8f9fa; color: #8b4513; border: 1px solid #8b4513; border-radius: 4px; cursor: pointer;">ë©”ë‰´ ê´€ë¦¬</button>
                    </div>
                    
                    <!-- ìì£¼ ì“°ëŠ” ë©”ë‰´ ê´€ë¦¬ -->
                    <div id="menuManager" style="display: none; background: #f8f9fa; border: 2px solid #8b4513; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="font-weight: bold; color: #8b4513;">ğŸ“‹ ìì£¼ ì“°ëŠ” ë©”ë‰´</span>
                            <button onclick="OrderModule.toggleMenuManager()" style="padding: 4px 8px; font-size: 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">ë‹«ê¸°</button>
                        </div>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" id="newMenuInput" placeholder="ìƒˆ ë©”ë‰´ ì…ë ¥" maxlength="50" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <button onclick="OrderModule.addMenu()" style="padding: 8px 16px; background: #8b4513; color: white; border: none; border-radius: 4px; cursor: pointer;">ì¶”ê°€</button>
                        </div>
                        <div id="menuList" style="display: flex; flex-wrap: wrap; gap: 8px; max-height: 100px; overflow-y: auto;">
                            <div style="color: #999; text-align: center; padding: 10px;">ë“±ë¡ëœ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                        </div>
                    </div>
                    
                    <div class="order-input-group">
                        <div class="order-input-wrapper">
                            <div class="autocomplete-suggestion" id="autocompleteSuggestion"></div>
                            <input type="text" id="myOrderInput" placeholder="ì£¼ë¬¸í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="100" disabled>
                            <div class="autocomplete-dropdown" id="autocompleteDropdown" style="display: none;"></div>
                        </div>
                        <button onclick="OrderModule.updateMyOrder()" id="orderSaveButton" style="width: auto; padding: 12px 20px; height: fit-content; margin: 0; color: #000; font-weight: 600;" disabled>ì €ì¥</button>
                    </div>
                </div>

                <!-- ì „ì²´ ì£¼ë¬¸ ëª©ë¡ -->
                <div id="orderList" style="background: #f8f9fa; border-radius: 8px; padding: 12px; max-height: 200px; overflow-y: auto;">
                    <div style="color: #999; text-align: center; padding: 10px;">ì•„ì§ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤</div>
                </div>
                <!-- ê´€ì „ì ì£¼ë¬¸ -->
                <div id="spectatorOrdersSection" style="display: none; margin-top: 10px;">
                    <div style="font-size: 13px; color: #999; margin-bottom: 5px;">ê´€ì „ì ì£¼ë¬¸</div>
                    <div id="spectatorOrderList" style="background: #f8f9fa; border-radius: 8px; padding: 12px;"></div>
                </div>
            </div>
            
            <!-- ê²Œì„ ìƒíƒœ í‘œì‹œ -->
            <div class="game-status waiting" id="gameStatus" style="padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; margin-bottom: 20px; background: #e9ecef; color: #495057;">
                ëŒ€ê¸° ì¤‘...
            </div>

            <!-- ê²½ì£¼ íŠ¸ë™ ì»¨í…Œì´ë„ˆ -->
            <div class="race-track-container" id="raceTrackContainer" style="display: none;">
                <div class="race-track" id="raceTrack">
                    <!-- ë§ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                </div>
            </div>

            <!-- ê²Œì„ ì¢…ë£Œ ë²„íŠ¼ (í˜¸ìŠ¤íŠ¸ ì „ìš©, ê²°ê³¼ í›„ í‘œì‹œ) -->
            <div id="endGameSection" style="display: none; text-align: center; margin-top: 40px;">
                <button class="end-button" onclick="endHorseRaceGame()">ğŸ ê²Œì„ ì¢…ë£Œ</button>
            </div>

            <!-- ì±„íŒ… ì„¹ì…˜ -->
            <div class="chat-section">
                <div style="font-weight: bold; color: #8b4513; margin-bottom: 10px; font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">ğŸ’¬ ì±„íŒ…</div>
                <div class="chat-messages" id="chatMessages"></div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." style="flex: 1; margin: 0;" onkeypress="handleChatKeypress(event)">
                    <button onclick="sendMessage()" style="width: auto; padding: 10px 20px; color: #000; font-weight: 600;">ì „ì†¡</button>
                </div>
            </div>
        </section>
    </div>

    <!-- ê¸°ë¡ ì„¹ì…˜ -->
    <div class="history-section" id="historySection">
        <div class="history-title">ğŸ“œ ê²Œì„ ê¸°ë¡</div>
        <div id="historyList"></div>
        
        <!-- ì‹¤ì‹œê°„ ìˆœìœ„ íŒ¨ë„ (ê²Œì„ ê¸°ë¡ í•˜ë‹¨) -->
        <div id="liveRankingPanel" style="display: none; background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 12px 15px; border-radius: 10px; margin-top: 15px; font-size: 13px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
            <div style="font-weight: bold; margin-bottom: 10px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 8px; font-size: 14px; font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">ğŸƒ ì‹¤ì‹œê°„ ìˆœìœ„</div>
            <div id="liveRankingList"></div>
        </div>
    </div>

    <!-- ê²°ê³¼ ì˜¤ë²„ë ˆì´ -->
    <div class="result-overlay" id="resultOverlay">
        <div class="result-card">
            <div class="result-title">ğŸŠ ìˆœìœ„ ë°œí‘œ ğŸŠ</div>
            <div id="resultRankings" style="margin-bottom: 20px;"></div>
            <div class="result-winner" id="resultWinner"></div>
            <div class="result-message" id="resultMessage"></div>
            <button onclick="closeResultOverlay()" style="width: auto; padding: 12px 30px; color: #000; font-weight: 600;">í™•ì¸</button>
        </div>
    </div>

    <!-- ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ëª¨ë‹¬ -->
    <div id="passwordModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%;">
            <h3 style="color: #8b4513; margin-bottom: 15px;">ğŸ”’ ë¹„ê³µê°œ ë°©</h3>
            <p style="margin-bottom: 15px; color: #666;">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
            <input type="password" id="roomPasswordInput" placeholder="ë¹„ë°€ë²ˆí˜¸" style="margin-bottom: 15px;">
            <div style="display: flex; gap: 10px;">
                <button onclick="closePasswordModal()" style="background: #6c757d; flex: 1; color: #000; font-weight: 600;">ì·¨ì†Œ</button>
                <button onclick="submitPassword()" style="flex: 1; color: #000; font-weight: 600;">ì…ì¥</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/chat-shared.js"></script>
    <script src="/ready-shared.js"></script>
    <script src="/order-shared.js"></script>
    <script src="/assets/sounds/sound-manager.js"></script>
    <script>
        // localhost ì²´í¬
        const isLocalhost = window.location.hostname === 'localhost' || 
                           window.location.hostname === '127.0.0.1' ||
                           window.location.hostname === '';
        
        // ë¡œì»¬ì—ì„œëŠ” ë°© ì œëª© ê¸°ë³¸ê°’ì„ "test"ë¡œ ì„¤ì •
        if (isLocalhost) {
            const roomNameInput = document.getElementById('createRoomNameInput');
            if (roomNameInput) {
                roomNameInput.value = 'test';
            }
        }
        
        // ë””ë²„ê·¸ ë¡œê·¸ ì„¤ì •
        let debugLogEnabled = isLocalhost;
        
        // ë””ë²„ê·¸ ë¡œê·¸ í•¨ìˆ˜ (ë¨¼ì € ì •ì˜)
        const MAX_LOG_LINES = 100;
        function addDebugLog(message, type = 'info') {
            if (!debugLogEnabled) return;
            
            const logSection = document.getElementById('debugLogSection');
            const logContent = document.getElementById('debugLogContent');
            
            if (!logSection || !logContent) return;
            
            const timestamp = new Date().toLocaleTimeString('ko-KR', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3 });
            const colors = {
                'info': '#0f0',
                'warn': '#ff0',
                'error': '#f00',
                'race': '#0ff',
                'selection': '#ff0',
                'rerace': '#f0f'
            };
            const color = colors[type] || '#0f0';
            
            const logLine = document.createElement('div');
            logLine.style.color = color;
            logLine.style.marginBottom = '2px';
            logLine.innerHTML = `[${timestamp}] ${message}`;
            logContent.appendChild(logLine);
            
            // ìµœëŒ€ ë¡œê·¸ ë¼ì¸ ìˆ˜ ì œí•œ
            while (logContent.children.length > MAX_LOG_LINES) {
                logContent.removeChild(logContent.firstChild);
            }
            
            // ìë™ ìŠ¤í¬ë¡¤
            logContent.scrollTop = logContent.scrollHeight;
            
            // ë¡œê·¸ ì„¹ì…˜ í‘œì‹œ
            logSection.style.display = 'block';
        }
        
        // ìƒíƒœ ë³€ìˆ˜
        let currentRoomId = null;
        let currentUser = '';
        let isHost = false;
        let isReady = false;
        let readyUsers = [];
        let roomsList = [];
        let selectedRoomId = null;
        let horseRaceHistory = [];
        let isRaceActive = false;
        let roomExpiryInterval = null;
        let pendingRoomId = null;
        let isOrderActive = false;
        let everPlayedUsers = [];
        let availableHorses = [];
        let userHorseBets = {};
        let mySelectedHorse = null;
        let horseRaceMode = 'last'; // ë¬´ì¡°ê±´ ê¼´ë“± ì°¾ê¸°
        let currentRoundPlayers = [];
        let raceRound = 1;
        let selectedVehicleTypes = null; // ì„ íƒëœ íƒˆê²ƒ íƒ€ì… (nullì´ë©´ ëœë¤)
        let isReraceActive = false; // ì¬ê²½ì£¼ í™œì„± ìƒíƒœ (ê²½ì£¼ í›„ ë™ì ì¼ ë•Œë§Œ true)
        // ê²½ë§ˆ ì‚¬ìš´ë“œ (socket/roomJoinedì—ì„œë„ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ì „ì—­ ìŠ¤ì½”í”„)
        const HORSE_SOUND_KEY = 'horseSoundEnabled';
        function getHorseSoundEnabled() { return localStorage.getItem(HORSE_SOUND_KEY) === 'true'; }
        function setHorseSoundCheckboxes() {
            const v = getHorseSoundEnabled();
            const c1 = document.getElementById('soundCheckbox');
            const c2 = document.getElementById('createRoomSoundCheckbox');
            const c3 = document.getElementById('gameSectionSoundCheckbox');
            if (c1) c1.checked = v;
            if (c2) c2.checked = v;
            if (c3) c3.checked = v;
        }
        function onHorseSoundChange(checked) {
            localStorage.setItem(HORSE_SOUND_KEY, checked ? 'true' : 'false');
            setHorseSoundCheckboxes();
        }
        
        // ë””ë²„ê·¸ ë¡œê·¸ ì´ˆê¸°í™”
        addDebugLog('ê²½ë§ˆ ê²Œì„ ì´ˆê¸°í™”', 'info');
        
        // íƒˆê²ƒ í…Œë§ˆ ë°ì´í„° (JSONì—ì„œ ë¡œë“œ)
        let vehicleThemes = {};
        let ALL_VEHICLES = [];
        
        // JSON íŒŒì¼ ë¡œë“œ
        async function loadVehicleThemes() {
            try {
                const response = await fetch('assets/vehicle-themes.json');
                const data = await response.json();
                vehicleThemes = data.vehicleThemes;
                
                // ALL_VEHICLES ë°°ì—´ ìƒì„±
                ALL_VEHICLES = Object.values(vehicleThemes).map(theme => ({
                    id: theme.id,
                    name: theme.name,
                    emoji: theme.emoji,
                    bgType: theme.theme
                }));
                
                addDebugLog(`íƒˆê²ƒ í…Œë§ˆ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${ALL_VEHICLES.length}ê°œ`, 'info');
                console.log('ALL_VEHICLES ë¡œë“œ ì™„ë£Œ:', ALL_VEHICLES);
            } catch (error) {
                addDebugLog(`í…Œë§ˆ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
                // ê¸°ë³¸ê°’ìœ¼ë¡œ í´ë°±
                ALL_VEHICLES = [
                    { id: 'car', name: 'ìë™ì°¨', emoji: 'ğŸš—', bgType: 'expressway' },
                    { id: 'rocket', name: 'ë¡œì¼“', emoji: 'ğŸš€', bgType: 'sky' },
                    { id: 'bird', name: 'ìƒˆ', emoji: 'ğŸ¦', bgType: 'sky' },
                    { id: 'boat', name: 'ë³´íŠ¸', emoji: 'ğŸš¤', bgType: 'ocean' },
                    { id: 'bicycle', name: 'ìì „ê±°', emoji: 'ğŸš´', bgType: 'road' },
                    { id: 'rabbit', name: 'í† ë¼', emoji: 'ğŸ‡', bgType: 'forest' },
                    { id: 'turtle', name: 'ê±°ë¶ì´', emoji: 'ğŸ¢', bgType: 'forest' },
                    { id: 'eagle', name: 'ë…ìˆ˜ë¦¬', emoji: 'ğŸ¦…', bgType: 'sky' },
                    { id: 'scooter', name: 'í‚¥ë³´ë“œ', emoji: 'ğŸ›´', bgType: 'road' },
                    { id: 'helicopter', name: 'í—¬ë¦¬ì½¥í„°', emoji: 'ğŸš', bgType: 'sky' },
                    { id: 'horse', name: 'ë§', emoji: 'ğŸ', bgType: 'forest' }
                ];
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ í…Œë§ˆ ë°ì´í„° ë¡œë“œ
        loadVehicleThemes();
        let ordersData = {};
        let currentUsers = [];

        // ë””ë°”ì´ìŠ¤ ID ìƒì„±/ê°€ì ¸ì˜¤ê¸°
        function getDeviceId() {
            let deviceId = localStorage.getItem('horseRaceDeviceId');
            if (!deviceId) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('horseRaceDeviceId', deviceId);
            }
            return deviceId;
        }

        // ì†Œì¼“ ì—°ê²°
        const socket = io({
            reconnection: true,
            reconnectionAttempts: 10,
            reconnectionDelay: 1000
        });

        // ë°© ìƒì„± ì„¹ì…˜ í‘œì‹œ
        function showCreateRoomSection() {
            const globalName = document.getElementById('globalUserNameInput').value.trim();
            
            document.getElementById('lobbySection').classList.remove('active');
            document.getElementById('createRoomSection').classList.add('active');
            
            // í˜¸ìŠ¤íŠ¸ ì´ë¦„ ìë™ ì„¤ì •
            const hostNameInput = document.getElementById('createRoomHostNameInput');
            if (globalName) {
                hostNameInput.value = globalName;
                // ë¡œì»¬ì—ì„œëŠ” "test", ê·¸ ì™¸ì—ëŠ” ìë™ ìƒì„±
                if (isLocalhost) {
                    document.getElementById('createRoomNameInput').value = 'test';
                } else {
                    document.getElementById('createRoomNameInput').value = globalName + 'ë‹˜ì˜ Horse Race';
                }
            }
        }

        // ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°
        function goBackToLobby() {
            document.getElementById('createRoomSection').classList.remove('active');
            document.getElementById('lobbySection').classList.add('active');
        }

        // ë°© ìƒì„±
        function finalizeRoomCreation() {
            const hostName = document.getElementById('createRoomHostNameInput').value.trim();
            const roomName = document.getElementById('createRoomNameInput').value.trim();
            const isPrivate = document.getElementById('createRoomPrivateCheckbox').checked;
            const password = document.getElementById('createRoomPasswordInput').value.trim();
            const expiryTimeRadio = document.querySelector('input[name="roomExpiryTime"]:checked');
            const expiryHours = expiryTimeRadio ? parseInt(expiryTimeRadio.value) : 3;

            if (!hostName) {
                alert('í˜¸ìŠ¤íŠ¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            if (!roomName) {
                alert('ë°© ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            if (isPrivate && (!password || password.length < 4)) {
                alert('ë¹„ê³µê°œ ë°©ì€ 4ì ì´ìƒì˜ ë¹„ë°€ë²ˆí˜¸ê°€ í•„ìš”í•©ë‹ˆë‹¤!');
                return;
            }

            // ì´ë¦„ ì €ì¥
            localStorage.setItem('horseRaceUserName', hostName);

            socket.emit('createRoom', {
                userName: hostName,
                roomName: roomName,
                isPrivate: isPrivate,
                password: isPrivate ? password : '',
                gameType: 'horse-race',
                expiryHours: expiryHours,
                blockIPPerUser: false,
                deviceId: getDeviceId()
            });
        }

        // ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        function refreshRooms() {
            socket.emit('getRooms');
        }

        // ë°© ëª©ë¡ ë Œë”ë§
        function renderRoomsList() {
            const roomsListEl = document.getElementById('roomsList');
            
            // ê²½ë§ˆ ë°©ë§Œ í•„í„°ë§
            const horseRaceRooms = roomsList.filter(room => room.gameType === 'horse-race');
            
            if (horseRaceRooms.length === 0) {
                roomsListEl.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">ìƒì„±ëœ ê²½ë§ˆ ë°©ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            roomsListEl.innerHTML = '';

            horseRaceRooms.forEach(room => {
                const roomItem = document.createElement('div');
                const isMyRoom = room.roomId === currentRoomId;
                let className = 'room-item';
                if (isMyRoom) className += ' my-room';
                else if (room.roomId === selectedRoomId) className += ' active';
                roomItem.className = className;

                let statusClass = 'waiting';
                let statusText = 'ëŒ€ê¸° ì¤‘';
                if (room.isGameActive) {
                    statusClass = 'playing';
                    statusText = 'ê²Œì„ ì§„í–‰ ì¤‘';
                }

                const roomNameHtml = isMyRoom 
                    ? `${room.roomName}<span class="my-room-badge">ì°¸ì—¬ ì¤‘</span>`
                    : room.roomName;

                const privateBadge = room.isPrivate 
                    ? '<span style="color: #ff6b6b; font-weight: bold; margin-left: 5px;">ğŸ”’</span>' 
                    : '';

                const buttonText = isMyRoom ? 'ì¬ì…ì¥' : 'ì…ì¥';

                roomItem.innerHTML = `
                    <div class="room-info">
                        <div class="room-name"><span style="font-size: 20px; margin-right: 5px;">ğŸ</span>${roomNameHtml}${privateBadge}</div>
                        <div class="room-details">í˜¸ìŠ¤íŠ¸: ${room.hostName} | ì¸ì›: ${room.playerCount}ëª…</div>
                        <span class="room-status ${statusClass}">${statusText}</span>
                    </div>
                    <div class="room-action">
                        <button onclick="joinRoomDirectly('${room.roomId}')" style="color: #000; font-weight: 600;">${buttonText}</button>
                    </div>
                `;

                roomsListEl.appendChild(roomItem);
            });
        }

        // ë°© ì…ì¥
        function joinRoomDirectly(roomId) {
            const userName = document.getElementById('globalUserNameInput').value.trim();
            
            if (!userName) {
                alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                document.getElementById('globalUserNameInput').focus();
                return;
            }

            const room = roomsList.find(r => r.roomId === roomId);
            if (room && room.isPrivate) {
                pendingRoomId = roomId;
                pendingUserName = userName;
                document.getElementById('passwordModal').style.display = 'flex';
                document.getElementById('roomPasswordInput').focus();
            } else {
                socket.emit('joinRoom', {
                    roomId: roomId,
                    userName: userName,
                    isHost: false,
                    password: '',
                    deviceId: getDeviceId()
                });
            }

            localStorage.setItem('horseRaceUserName', userName);
        }

        // ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ ë‹«ê¸°
        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('roomPasswordInput').value = '';
            pendingRoomId = null;
            pendingUserName = null;
        }

        // ë¹„ë°€ë²ˆí˜¸ ì œì¶œ
        function submitPassword() {
            const password = document.getElementById('roomPasswordInput').value;
            
            if (pendingRoomId && pendingUserName) {
                socket.emit('joinRoom', {
                    roomId: pendingRoomId,
                    userName: pendingUserName,
                    isHost: false,
                    password: password,
                    deviceId: getDeviceId()
                });
            }
            
            closePasswordModal();
        }

        // ë°© ë‚˜ê°€ê¸°
        function leaveRoom() {
            if (confirm('ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                socket.emit('leaveRoom');
            }
        }

        // ì¤€ë¹„ í•¨ìˆ˜ (ReadyModule ìœ„ì„)
        function toggleReady() {
            ReadyModule.toggleReady();
        }
        function updateReadyButton() {
            ReadyModule.updateReadyButton();
        }
        function renderReadyUsers() {
            ReadyModule.renderReadyUsers();
        }
        
        // ì‹œì‘ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateStartButton() {
            const btn = document.getElementById('startHorseRaceButton');
            if (btn && isHost) {
                if (readyUsers.length >= 2 && !isRaceActive) {
                    btn.disabled = false;
                    btn.textContent = 'ğŸ ê²½ë§ˆ ì‹œì‘!';
                } else {
                    btn.disabled = true;
                    btn.textContent = `ğŸ ê²½ë§ˆ ì‹œì‘ (${readyUsers.length}/2ëª… ì¤€ë¹„)`;
                }
            }
        }

        // ê²½ë§ˆ ì‹œì‘
        function startHorseRace() {
            addDebugLog('ê²½ì£¼ ì‹œì‘ ìš”ì²­', 'race');
            socket.emit('startHorseRace');
        }

        // ê²Œì„ ëª¨ë“œ: ë¬´ì¡°ê±´ ê¼´ë“± ì°¾ê¸° (ëª¨ë“œ ì„ íƒ ì œê±°)
        function updateGameMode() {
            socket.emit('updateGameRules', { horseRaceMode: 'last' });
        }

        // ë§ ì„ íƒ
        function selectHorse(horseIndex) {
            addDebugLog(`íƒˆê²ƒ ì„ íƒ: ${horseIndex}`, 'selection');
            // ì´ë¯¸ ì„ íƒí•œ íƒˆê²ƒì„ ë‹¤ì‹œ ì„ íƒí•˜ë©´ ì·¨ì†Œ
            // ë‹¤ë¥¸ íƒˆê²ƒì„ ì„ íƒí•˜ë©´ ì¬ì„ íƒ (ì„œë²„ì—ì„œ ê²€ì¦)
            socket.emit('selectHorse', {
                horseIndex: horseIndex
            });
        }

        // íƒˆê²ƒ ì„ íƒ í™”ë©´ì— íŠ¸ë™ í‘œì‹œ (ì´ˆê¸° ìƒíƒœ)
        function renderTrackForSelection() {
            const track = document.getElementById('raceTrack');
            const trackContainer = document.getElementById('raceTrackContainer');
            
            if (!track || !trackContainer) {
                console.warn('[renderTrackForSelection] track ë˜ëŠ” trackContainerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                return;
            }
            
            trackContainer.style.display = 'block';
            track.innerHTML = '';
            
            const trackWidth = trackContainer.offsetWidth || 700;
            const horseCount = availableHorses.length;
            
            if (horseCount === 0) {
                console.warn('[renderTrackForSelection] availableHorsesê°€ ë¹„ì–´ìˆìŒ');
                return;
            }
            
            const wallHeight = 6;
            const laneHeight = Math.min(75, Math.floor((350 - wallHeight * (horseCount - 1)) / horseCount));
            const totalLaneHeight = laneHeight + wallHeight;
            
            console.log('[renderTrackForSelection] ì‹œì‘:', {
                horseCount,
                selectedVehicleTypes: selectedVehicleTypes,
                ALL_VEHICLES: ALL_VEHICLES.length,
                vehicleThemes: Object.keys(vehicleThemes).length
            });
            
            availableHorses.forEach((horseIndex, rank) => {
                // selectedVehicleTypesê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ALL_VEHICLESì—ì„œ ê°€ì ¸ì˜¤ê¸°
                // ë§ ì„ íƒ í™”ë©´ì—ì„œëŠ” availableHorses ìˆœì„œëŒ€ë¡œ í‘œì‹œí•˜ë¯€ë¡œ horseIndexë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                const vehicleId = selectedVehicleTypes && selectedVehicleTypes[horseIndex] 
                    ? selectedVehicleTypes[horseIndex] 
                    : (ALL_VEHICLES.length > 0 ? ALL_VEHICLES[horseIndex % ALL_VEHICLES.length].id : 'car');
                
                console.log(`[renderTrackForSelection] ë§ ${horseIndex} (rank ${rank}): vehicleId=${vehicleId}`);
                
                const vehicleBg = getVehicleBackground(vehicleId);
                const vehicle = ALL_VEHICLES.find(v => v.id === vehicleId) || ALL_VEHICLES[0];
                
                console.log(`[renderTrackForSelection] ë§ ${horseIndex} (rank ${rank}):`, {
                    vehicleId: vehicleId,
                    bg: vehicleBg.bg,
                    bgSize: vehicleBg.bgSize,
                    backgroundImage: vehicleBg.backgroundImage,
                    vehicleThemes_loaded: Object.keys(vehicleThemes).length > 0
                });
                
                // ë ˆì¸ ìƒì„±
                const lane = document.createElement('div');
                lane.style.cssText = `
                    position: absolute;
                    left: 0;
                    top: ${rank * totalLaneHeight}px;
                    width: 100%;
                    height: ${laneHeight}px;
                    background-image: ${vehicleBg.bg};
                    background-size: ${vehicleBg.bgSize || 'cover'};
                    background-repeat: ${vehicleBg.bgRepeat || 'no-repeat'};
                    background-position: ${vehicleBg.bgPosition || 'center'};
                    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
                `;
                
                // ë°°ê²½ íš¨ê³¼ ì¶”ê°€ (startRaceAnimationê³¼ ë™ì¼)
                if (vehicleBg.extra === 'road') {
                    lane.innerHTML += `<div style="position: absolute; top: 50%; left: 0; width: 100%; height: 3px; background: repeating-linear-gradient(90deg, #fff 0px, #fff 20px, transparent 20px, transparent 40px);"></div>`;
                }
                if (vehicleBg.extra === 'stars') {
                    for (let i = 0; i < 20; i++) {
                        const size = 1 + Math.random() * 2;
                        lane.innerHTML += `<div style="position: absolute; width: ${size}px; height: ${size}px; background: white; border-radius: 50%; left: ${Math.random() * 100}%; top: ${Math.random() * 100}%; opacity: ${0.5 + Math.random() * 0.5};"></div>`;
                    }
                }
                if (vehicleBg.extra === 'waves') {
                    lane.innerHTML += `<div style="position: absolute; bottom: 20%; left: 0; width: 100%; height: 4px; background: repeating-linear-gradient(90deg, transparent, transparent 15px, rgba(255,255,255,0.4) 15px, rgba(255,255,255,0.4) 30px);"></div>`;
                    lane.innerHTML += `<div style="position: absolute; bottom: 40%; left: 10px; width: 100%; height: 3px; background: repeating-linear-gradient(90deg, transparent, transparent 20px, rgba(255,255,255,0.3) 20px, rgba(255,255,255,0.3) 35px);"></div>`;
                }
                if (vehicleBg.extra === 'clouds') {
                    for (let i = 0; i < 4; i++) {
                        const w = 25 + Math.random() * 20;
                        lane.innerHTML += `<div style="position: absolute; width: ${w}px; height: ${w*0.5}px; background: rgba(255,255,255,0.7); border-radius: ${w/2}px; left: ${Math.random() * 85}%; top: ${10 + Math.random() * 50}%;"></div>`;
                    }
                }
                if (vehicleBg.extra === 'carrots') {
                    for (let i = 0; i < 6; i++) {
                        lane.innerHTML += `<div style="position: absolute; font-size: 14px; left: ${10 + Math.random() * 80}%; top: ${40 + Math.random() * 50}%;">ğŸ¥•</div>`;
                    }
                }
                if (vehicleBg.extra === 'mountains') {
                    lane.innerHTML += `<svg style="position: absolute; bottom: 30%; left: 0; width: 100%; height: 40%;" viewBox="0 0 100 40" preserveAspectRatio="none"><polygon points="0,40 15,15 30,40" fill="#7f8c8d"/><polygon points="20,40 40,10 60,40" fill="#95a5a6"/><polygon points="50,40 70,20 90,40" fill="#7f8c8d"/><polygon points="70,40 85,25 100,40" fill="#95a5a6"/></svg>`;
                }
                if (vehicleBg.extra === 'buildings') {
                    lane.innerHTML += `<svg style="position: absolute; bottom: 0; left: 0; width: 100%; height: 35%;" viewBox="0 0 100 35" preserveAspectRatio="none"><rect x="0" y="10" width="8" height="25" fill="#1a252f"/><rect x="10" y="5" width="10" height="30" fill="#2c3e50"/><rect x="22" y="15" width="6" height="20" fill="#1a252f"/><rect x="30" y="8" width="12" height="27" fill="#34495e"/><rect x="45" y="12" width="8" height="23" fill="#2c3e50"/><rect x="55" y="3" width="10" height="32" fill="#1a252f"/><rect x="67" y="18" width="7" height="17" fill="#34495e"/><rect x="76" y="10" width="12" height="25" fill="#2c3e50"/><rect x="90" y="15" width="10" height="20" fill="#1a252f"/></svg>`;
                }
                
                track.appendChild(lane);
                
                // ë ˆì¸ ì•„ë˜ ë²½ ìƒì„±
                if (rank < horseCount - 1) {
                    const wall = document.createElement('div');
                    wall.style.cssText = `
                        position: absolute;
                        left: 0;
                        top: ${rank * totalLaneHeight + laneHeight}px;
                        width: 100%;
                        height: ${wallHeight}px;
                        background: linear-gradient(180deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%);
                        box-shadow: 
                            0 2px 4px rgba(0,0,0,0.3),
                            inset 0 1px 2px rgba(255,255,255,0.1),
                            inset 0 -1px 2px rgba(0,0,0,0.2);
                        border-top: 1px solid rgba(255,255,255,0.2);
                        border-bottom: 1px solid rgba(0,0,0,0.3);
                        z-index: 10;
                    `;
                    track.appendChild(wall);
                }
                
                // íƒˆê²ƒ í‘œì‹œ (ì‹œì‘ ìœ„ì¹˜)
                const horse = document.createElement('div');
                horse.className = 'horse';
                horse.id = `horse_preview_${horseIndex}`;
                horse.style.cssText = `
                    position: absolute;
                    left: 10px;
                    top: ${rank * totalLaneHeight + 10}px;
                    width: 80px;
                    height: ${laneHeight - 10}px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    z-index: ${100 - rank};
                `;
                
                // ì„ íƒí•œ ëª¨ë“  ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ (ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥)
                const selectedUsers = Object.entries(userHorseBets)
                    .filter(([_, h]) => h === horseIndex)
                    .map(([name, _]) => name);
                
                // íƒˆê²ƒ ìŠ¤í”„ë¼ì´íŠ¸
                const vehicleContent = document.createElement('div');
                vehicleContent.className = 'vehicle-sprite';
                vehicleContent.style.animation = 'none'; // ì• ë‹ˆë©”ì´ì…˜ ì—†ìŒ
                
                const frame1 = document.createElement('div');
                frame1.className = 'frame1';
                const vehicleSVGs = getVehicleSVG(vehicleId);
                frame1.innerHTML = vehicleSVGs.frame1;
                
                vehicleContent.appendChild(frame1);
                horse.appendChild(vehicleContent);
                track.appendChild(horse);
                
                // ì´ë¦„ ë¼ë²¨ì„ ë ˆì¸ ì™¼ìª½ì— í‘œì‹œ
                if (selectedUsers.length > 0) {
                    const namesContainer = document.createElement('div');
                    namesContainer.className = 'names-container';
                    namesContainer.style.cssText = `
                        position: absolute;
                        top: ${rank * totalLaneHeight + 5}px;
                        left: 5px;
                        display: flex;
                        flex-wrap: wrap;
                        gap: 2px;
                        z-index: 200;
                        max-width: 200px;
                    `;
                    
                    selectedUsers.forEach(userName => {
                        const nameTag = document.createElement('span');
                        nameTag.style.cssText = `
                            background: rgba(0,0,0,0.7);
                            color: #fff;
                            padding: 1px 4px;
                            border-radius: 3px;
                            font-size: 10px;
                            font-weight: bold;
                            white-space: nowrap;
                        `;
                        nameTag.textContent = userName;
                        namesContainer.appendChild(nameTag);
                    });
                    
                    track.appendChild(namesContainer);
                }
            });
        }
        
        // íƒˆê²ƒ ì„ íƒ UI ë Œë”ë§
        function renderHorseSelection() {
            const grid = document.getElementById('horseSelectionGrid');
            const info = document.getElementById('horseSelectionInfo');
            
            console.log('[renderHorseSelection] ì‹œì‘', {
                grid: !!grid,
                availableHorses: availableHorses.length,
                ALL_VEHICLES: ALL_VEHICLES.length,
                selectedVehicleTypes: selectedVehicleTypes,
                vehicleThemes_loaded: Object.keys(vehicleThemes).length
            });
            
            if (!grid) {
                console.error('[renderHorseSelection] grid ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                return;
            }
            
            grid.innerHTML = '';
            
            // íŠ¸ë™ í‘œì‹œ (ë°°ê²½ ì´ë¯¸ì§€ í¬í•¨)
            // selectedVehicleTypesê°€ ì„¤ì •ë˜ì–´ ìˆì–´ì•¼ ë°°ê²½ì´ ì œëŒ€ë¡œ í‘œì‹œë¨
            console.log('[renderHorseSelection] renderTrackForSelection í˜¸ì¶œ ì „:', {
                selectedVehicleTypes: selectedVehicleTypes,
                availableHorses: availableHorses.length,
                vehicleThemes_loaded: Object.keys(vehicleThemes).length > 0
            });
            
            // vehicleThemesê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ë¡œë“œ ëŒ€ê¸°
            if (Object.keys(vehicleThemes).length === 0) {
                console.warn('[renderHorseSelection] vehicleThemesê°€ ë¡œë“œë˜ì§€ ì•ŠìŒ, ë¡œë“œ ëŒ€ê¸°...');
                loadVehicleThemes().then(() => {
                    renderTrackForSelection();
                }).catch(() => {
                    renderTrackForSelection(); // í´ë°±ìœ¼ë¡œ ë Œë”ë§
                });
            } else {
                renderTrackForSelection();
            }
            
            if (availableHorses.length === 0) {
                info.textContent = 'íƒˆê²ƒ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
                console.warn('[renderHorseSelection] availableHorsesê°€ ë¹„ì–´ìˆìŒ');
                return;
            }
            
            // ALL_VEHICLESê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ í´ë°± ë°ì´í„° ì‚¬ìš©
            if (ALL_VEHICLES.length === 0) {
                console.warn('[renderHorseSelection] ALL_VEHICLESê°€ ë¹„ì–´ìˆìŒ, í´ë°± ë°ì´í„° ì‚¬ìš©');
                // í´ë°± ë°ì´í„° ì„¤ì •
                ALL_VEHICLES = [
                    { id: 'car', name: 'ìë™ì°¨', emoji: 'ğŸš—', bgType: 'expressway' },
                    { id: 'rocket', name: 'ë¡œì¼“', emoji: 'ğŸš€', bgType: 'sky' },
                    { id: 'bird', name: 'ìƒˆ', emoji: 'ğŸ¦', bgType: 'sky' },
                    { id: 'boat', name: 'ë³´íŠ¸', emoji: 'ğŸš¤', bgType: 'ocean' },
                    { id: 'bicycle', name: 'ìì „ê±°', emoji: 'ğŸš´', bgType: 'road' },
                    { id: 'rabbit', name: 'í† ë¼', emoji: 'ğŸ‡', bgType: 'forest' },
                    { id: 'turtle', name: 'ê±°ë¶ì´', emoji: 'ğŸ¢', bgType: 'forest' },
                    { id: 'eagle', name: 'ë…ìˆ˜ë¦¬', emoji: 'ğŸ¦…', bgType: 'sky' },
                    { id: 'scooter', name: 'í‚¥ë³´ë“œ', emoji: 'ğŸ›´', bgType: 'road' },
                    { id: 'helicopter', name: 'í—¬ë¦¬ì½¥í„°', emoji: 'ğŸš', bgType: 'sky' },
                    { id: 'horse', name: 'ë§', emoji: 'ğŸ', bgType: 'forest' }
                ];
                // ë¹„ë™ê¸°ë¡œ ë¡œë“œ ì‹œë„ (ë‚˜ì¤‘ì— ì—…ë°ì´íŠ¸ë¨)
                loadVehicleThemes().catch(err => {
                    console.error('[renderHorseSelection] í…Œë§ˆ ë¡œë“œ ì‹¤íŒ¨:', err);
                });
            }

            availableHorses.forEach((horseIndex, index) => {
                const button = document.createElement('button');
                button.className = 'horse-selection-button';
                button.id = `horseButton_${horseIndex}`;
                
                // íƒˆê²ƒ íƒ€ì… ê°€ì ¸ì˜¤ê¸°
                const vehicleId = selectedVehicleTypes ? selectedVehicleTypes[horseIndex] : ALL_VEHICLES[horseIndex % ALL_VEHICLES.length].id;
                const vehicle = ALL_VEHICLES.find(v => v.id === vehicleId) || ALL_VEHICLES[0];
                
                // ì´ë¯¸ ì„ íƒëœ íƒˆê²ƒì¸ì§€ í™•ì¸
                const isTaken = Object.values(userHorseBets).includes(horseIndex);
                const isMyHorse = userHorseBets[currentUser] === horseIndex;
                
                // ì„ íƒí•œ ì‚¬ëŒ ì°¾ê¸°
                const selectedBy = Object.entries(userHorseBets).find(([_, h]) => h === horseIndex)?.[0];
                
                // ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥ ì—¬ë¶€: íƒˆê²ƒ ìˆ˜ < ì‚¬ëŒ ìˆ˜ì¼ ë•Œë§Œ ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥
                // ì°¸ê°€ì ìˆ˜ ê³„ì‚° (currentUsersê°€ ê°€ì¥ ì •í™• - updateUsersë¡œ í•­ìƒ ìµœì‹  ìƒíƒœ)
                const totalPlayers = currentUsers.length > 0 ? currentUsers.length : 
                                    (currentRoundPlayers.length > 0 ? currentRoundPlayers.length : 
                                    (readyUsers.length > 0 ? readyUsers.length : 1));
                const canDuplicate = availableHorses.length < totalPlayers;
                
                // ë””ë²„ê¹…ìš© ë¡œê·¸
                if (index === 0) {
                    console.log('[ë§ ì„ íƒ]', {
                        availableHorses: availableHorses.length,
                        totalPlayers,
                        canDuplicate,
                        currentRoundPlayers: currentRoundPlayers.length,
                        currentUsers: currentUsers.length,
                        readyUsers: readyUsers.length,
                        isHost: isHost,
                        currentUser: currentUser
                    });
                }
                
                // ì¤‘ë³µ ì„ íƒì´ ë¶ˆê°€ëŠ¥í•˜ê³  ì´ë¯¸ ì„ íƒëœ íƒˆê²ƒì´ë©´ ë¹„í™œì„±í™”
                // (ë‹¨, ë‚´ê°€ ì„ íƒí•œ ê²ƒì€ ë¹„í™œì„±í™”í•˜ì§€ ì•ŠìŒ)
                // ì¤‘ë³µ ì„ íƒì´ ê°€ëŠ¥í•˜ë©´(isTakenì´ì–´ë„) ë¹„í™œì„±í™”í•˜ì§€ ì•ŠìŒ
                if (!canDuplicate && isTaken && !isMyHorse) {
                    button.disabled = true;
                } else if (canDuplicate && isTaken && !isMyHorse) {
                    // ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥í•˜ì§€ë§Œ ì´ë¯¸ ì„ íƒëœ ê²½ìš°, ë¹„í™œì„±í™”í•˜ì§€ ì•ŠìŒ (ì„ íƒ ê°€ëŠ¥)
                    button.disabled = false;
                }
                
                if (isMyHorse) {
                    button.classList.add('selected');
                    mySelectedHorse = horseIndex;
                }
                
                // íƒˆê²ƒ ë²„íŠ¼ ë‚´ìš© ìƒì„± (SVG ì‚¬ìš© - ê²½ì£¼ì™€ ë™ì¼í•˜ê²Œ)
                const svgData = getVehicleSVG(vehicleId);
                let vehicleDisplay = '';
                if (svgData && svgData.frame1) {
                    vehicleDisplay = `<div style="width: 60px; height: 45px; margin: 0 auto;">${svgData.frame1}</div>`;
                } else {
                    vehicleDisplay = `<div style="font-size: 48px;">${vehicle.emoji}</div>`;
                }
                let content = vehicleDisplay;
                content += `<div style="font-size: 14px; margin-top: 5px; font-weight: 600;">${vehicle.name}</div>`;
                
                // ì„ íƒí•œ ì‚¬ëŒ ì •ë³´ í‘œì‹œ
                if (selectedBy) {
                    if (selectedBy === currentUser) {
                        content += `<div style="font-size: 12px; margin-top: 5px; color: #8b4513; font-weight: bold;">âœ“ ë‚´ê°€ ì„ íƒ</div>`;
                    } else {
                        content += `<div style="font-size: 12px; margin-top: 5px; color: #dc3545; font-weight: bold;">${selectedBy} ì„ íƒ</div>`;
                    }
                }
                
                button.innerHTML = content;
                
                // ì¬ê²½ì£¼ì¸ ê²½ìš° ì¬ê²½ì£¼ ëŒ€ìƒìê°€ ì•„ë‹ˆë©´ ì„ íƒ ë¶ˆê°€
                if (isReraceActive && !currentRoundPlayers.includes(currentUser)) {
                    button.disabled = true;
                    button.style.opacity = '0.5';
                    button.style.cursor = 'not-allowed';
                }
                
                button.onclick = () => {
                    // ì¬ê²½ì£¼ì¸ ê²½ìš° ì¬ê²½ì£¼ ëŒ€ìƒìê°€ ì•„ë‹ˆë©´ ì„ íƒ ë¶ˆê°€
                    if (isReraceActive && !currentRoundPlayers.includes(currentUser)) {
                        alert('ì¬ê²½ì£¼ ì¤€ë¹„ ëŒ€ìƒì´ ì•„ë‹™ë‹ˆë‹¤!');
                        return;
                    }
                    
                    // ë¹„í™œì„±í™”ëœ ë²„íŠ¼ì€ ì„ íƒ ë¶ˆê°€
                    if (button.disabled) {
                        console.log(`[ë§ ì„ íƒ] ${vehicle.name}ì€(ëŠ”) ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (ì´ë¯¸ ë‹¤ë¥¸ ì‚¬ëŒì´ ì„ íƒí•¨)`);
                        return;
                    }
                    
                    // ê°™ì€ íƒˆê²ƒì„ ë‹¤ì‹œ ì„ íƒí•˜ë©´ ì·¨ì†Œ, ë‹¤ë¥¸ íƒˆê²ƒì„ ì„ íƒí•˜ë©´ ì¬ì„ íƒ
                    selectHorse(horseIndex);
                };
                
                grid.appendChild(button);
            });
            
            console.log('[renderHorseSelection] ì™„ë£Œ', {
                ìƒì„±ëœ_ë²„íŠ¼_ìˆ˜: grid.children.length,
                availableHorses: availableHorses.length
            });

            // ì„ íƒ ì •ë³´ ì—…ë°ì´íŠ¸
            const selectedCount = Object.keys(userHorseBets).length;
            // ì¬ê²½ì£¼ì¸ ê²½ìš° ì¬ê²½ì£¼ ëŒ€ìƒì ìˆ˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
            const totalPlayers = isReraceActive ? currentRoundPlayers.length : 
                               (currentUsers.length > 0 ? currentUsers.length : 
                               (currentRoundPlayers.length > 0 ? currentRoundPlayers.length : 
                               (readyUsers.length > 0 ? readyUsers.length : 1)));
            
            // ì„ íƒí•œ ì‚¬ëŒ ëª©ë¡ ìƒì„±
            const selectedUsers = Object.keys(userHorseBets);
            
            // ì¬ê²½ì£¼ ë²„íŠ¼ ì—…ë°ì´íŠ¸ (ì¬ê²½ì£¼ì¸ ê²½ìš°)
            if (isReraceActive && isHost) {
                updateReraceButton();
            }
            
            let infoText = '';
            
            // ì¬ê²½ì£¼ì¸ ê²½ìš°
            if (isReraceActive) {
                const reraceSelectedCount = currentRoundPlayers.filter(p => userHorseBets[p] !== undefined).length;
                infoText = `ì¬ê²½ì£¼: ${reraceSelectedCount}/${totalPlayers}ëª…ì´ íƒˆê²ƒì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤.`;
                
                if (reraceSelectedCount > 0) {
                    const reraceSelectedUsers = currentRoundPlayers.filter(p => userHorseBets[p] !== undefined);
                    infoText += ` (${reraceSelectedUsers.join(', ')})`;
                }
                
                if (reraceSelectedCount === totalPlayers) {
                    infoText = `âœ… ëª¨ë“  ì¬ê²½ì£¼ ëŒ€ìƒìê°€ íƒˆê²ƒì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤. í˜¸ìŠ¤íŠ¸ê°€ ì¬ê²½ì£¼ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”!`;
                } else {
                    // ì¬ê²½ì£¼ ëŒ€ìƒìê°€ ì•„ë‹Œ ì‚¬ëŒì—ê²Œ ë©”ì‹œì§€ í‘œì‹œ
                    if (!currentRoundPlayers.includes(currentUser)) {
                        infoText = `ì¬ê²½ì£¼ ì¤€ë¹„ ëŒ€ìƒì´ ì•„ë‹™ë‹ˆë‹¤. (ì¬ê²½ì£¼ ëŒ€ìƒì: ${currentRoundPlayers.join(', ')})`;
                    }
                }
            } else {
                infoText = `${selectedCount}/${totalPlayers}ëª…ì´ íƒˆê²ƒì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤.`;
                
                if (selectedCount > 0) {
                    infoText += ` (${selectedUsers.join(', ')})`;
                }
                
                if (selectedCount === totalPlayers) {
                    infoText = `âœ… ëª¨ë“  ì°¸ê°€ìê°€ íƒˆê²ƒì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤. ê²½ì£¼ê°€ ê³§ ì‹œì‘ë©ë‹ˆë‹¤!`;
                }
            }
            
            info.textContent = infoText;
        }

        // ê²½ì£¼ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ (ì„œë²„ì—ì„œ ë°›ì€ ê¸°ë¯¹ ë°ì´í„° ì‚¬ìš©)
        // ê²Œì„ ì¢…ë£Œ ë²„íŠ¼ í¬ê¸° ê³„ì‚° í•¨ìˆ˜
        function getEndButtonWidth() {
            const endButton = document.querySelector('.end-button');
            return endButton ? endButton.offsetWidth : 200;
        }

        // ìë™ ìŠ¤í¬ë¡¤ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateTrackScroll(trackContainer, leaderPosition, centerPosition) {
            if (!trackContainer) return;
            
            // ë§ì´ ì¤‘ì•™ì„ ë„˜ì–´ê°€ë©´ ìŠ¤í¬ë¡¤ ì‹œì‘
            if (leaderPosition > centerPosition) {
                const scrollAmount = leaderPosition - centerPosition;
                trackContainer.scrollLeft = scrollAmount;
            } else {
                // ë§ì´ ì¤‘ì•™ì— ë„ë‹¬í•˜ê¸° ì „ì—ëŠ” ìŠ¤í¬ë¡¤í•˜ì§€ ì•ŠìŒ
                trackContainer.scrollLeft = 0;
            }
        }

        function startRaceAnimation(horseRankings, speeds, serverGimmicks, onComplete) {
            // ì´ì „ ê²½ì£¼ì˜ ìˆœìœ„ ì´í™íŠ¸ ì •ë¦¬
            clearFinishEffects();
            
            const track = document.getElementById('raceTrack');
            const trackContainer = document.getElementById('raceTrackContainer');
            
            if (!track || !trackContainer) {
                console.error('íŠ¸ë™ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                if (onComplete) onComplete();
                return 5000;
            }
            
            if (!horseRankings || horseRankings.length === 0) {
                console.error('ë§ ìˆœìœ„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤', horseRankings);
                if (onComplete) onComplete();
                return 5000;
            }
            
            trackContainer.style.display = 'block';
            track.innerHTML = '';
            
            // ì´ì „ ë„ì°© ì´í™íŠ¸ ì œê±°
            document.querySelectorAll('.finish-effect').forEach(el => el.remove());
            
            // ì»¨í…Œì´ë„ˆ ë„ˆë¹„ (ìŠ¤í¬ë¡¤ ì˜ì—­ì˜ ë·°í¬íŠ¸ í¬ê¸°)
            const trackWidth = trackContainer.offsetWidth || 700;
            const finishLine = trackWidth * 2 - 60; // ë„ì°© ì§€ì ì„ í˜„ì¬ ê±°ë¦¬ì˜ ì•½ 2ë°°ë¡œ ì„¤ì •
            
            // íŠ¸ë™ì˜ ë„ˆë¹„: ë„ì°© ì§€ì ì€ ê·¸ëŒ€ë¡œ, ê²°ìŠ¹ì„  ë’¤ ì—¬ìœ ë§Œ ìµœì†Œí™”í•´ ìŠ¤í¬ë¡¤ ì–‘ ì¤„ì„
            track.style.width = `${finishLine + 30}px`; // ê²°ìŠ¹ì„  ë’¤ ì—¬ìœ ë§Œ ì†ŒëŸ‰
            
            const horseCount = horseRankings.length;
            const wallHeight = 6; // ë²½ ë†’ì´
            const laneHeight = Math.min(75, Math.floor((350 - wallHeight * (horseCount - 1)) / horseCount));
            const totalLaneHeight = laneHeight + wallHeight; // ë ˆì¸ + ë²½ ë†’ì´
            
            console.log('ê²½ì£¼ ì‹œì‘:', { horseRankings, speeds, trackWidth, finishLine });
            
            // ê° ë§ ìƒì„± ë° ì• ë‹ˆë©”ì´ì…˜ (ëª¨ë“  ë§ì„ ë¨¼ì € ìƒì„±)
            const horseElements = [];
            let maxDuration = 0;
            
            // ì„ íƒ í™”ë©´ì—ì„œ ë³¸ ì›ë˜ ìˆœì„œ ìœ ì§€ (availableHorses ìˆœì„œ)
            // horseRankingsëŠ” ìˆœìœ„ ìˆœì„œì´ë¯€ë¡œ, ì›ë˜ ë§ ì¸ë±ìŠ¤ ìˆœì„œë¡œ ë§¤í•‘
            const originalHorseOrder = availableHorses.length > 0 ? availableHorses : 
                                      (horseRankings.length > 0 ? [...new Set(horseRankings)].sort((a, b) => a - b) : []);
            
            console.log('[startRaceAnimation] ì‹œì‘:', {
                horseRankings: horseRankings,
                selectedVehicleTypes: selectedVehicleTypes,
                availableHorses: availableHorses
            });
            
            // ë§ ì„ íƒ í™”ë©´ê³¼ ë™ì¼í•œ ìˆœì„œë¡œ ë ˆì¸ ë°°ì¹˜ (availableHorses ìˆœì„œ)
            availableHorses.forEach((horseIndex, laneIndex) => {
                // íƒˆê²ƒ íƒ€ì… ê°€ì ¸ì˜¤ê¸°: ì„ íƒ í™”ë©´ì—ì„œ ë³¸ ì›ë˜ ìˆœì„œëŒ€ë¡œ
                const vehicleId = selectedVehicleTypes && selectedVehicleTypes[horseIndex] 
                    ? selectedVehicleTypes[horseIndex] 
                    : (ALL_VEHICLES.length > 0 ? ALL_VEHICLES[horseIndex % ALL_VEHICLES.length].id : 'car');
                
                // í•´ë‹¹ ë§ì˜ ìˆœìœ„ ì°¾ê¸° (horseRankingsì—ì„œ horseIndexì˜ ìœ„ì¹˜)
                const rank = horseRankings.indexOf(horseIndex);
                
                console.log(`[startRaceAnimation] laneIndex ${laneIndex}: horseIndex=${horseIndex}, vehicleId=${vehicleId}, rank=${rank} (${rank === 0 ? '1ë“±' : rank === 1 ? '2ë“±' : rank === 2 ? '3ë“±' : rank + 1 + 'ë“±'})`);
                
                const vehicleBg = getVehicleBackground(vehicleId);
                
                // ë ˆì¸ ìƒì„± (laneIndexë¡œ ìœ„ì¹˜ ê²°ì • - ë§ ì„ íƒ í™”ë©´ê³¼ ë™ì¼)
                const lane = document.createElement('div');
                lane.style.cssText = `
                    position: absolute;
                    left: 0;
                    top: ${laneIndex * totalLaneHeight}px;
                    width: 100%;
                    height: ${laneHeight}px;
                    background-image: ${vehicleBg.bg};
                    background-size: ${vehicleBg.bgSize || 'cover'};
                    background-repeat: repeat-x;
                    background-position: 0 center;
                    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
                `;
                
                // ë ˆì¸ ì•„ë˜ ë²½ ìƒì„± (ë§ˆì§€ë§‰ ë ˆì¸ ì œì™¸)
                if (laneIndex < horseCount - 1) {
                    const wall = document.createElement('div');
                    wall.style.cssText = `
                        position: absolute;
                        left: 0;
                        top: ${laneIndex * totalLaneHeight + laneHeight}px;
                        width: 100%;
                        height: ${wallHeight}px;
                        background: linear-gradient(180deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%);
                        box-shadow: 
                            0 2px 4px rgba(0,0,0,0.3),
                            inset 0 1px 2px rgba(255,255,255,0.1),
                            inset 0 -1px 2px rgba(0,0,0,0.2);
                        border-top: 1px solid rgba(255,255,255,0.2);
                        border-bottom: 1px solid rgba(0,0,0,0.3);
                        z-index: 10;
                    `;
                    track.appendChild(wall);
                }
                
                // ë°°ê²½ íš¨ê³¼ ì¶”ê°€
                if (vehicleBg.extra === 'road') {
                    // ë„ë¡œ ì°¨ì„  (ì ì„ )
                    lane.innerHTML += `<div style="position: absolute; top: 50%; left: 0; width: 100%; height: 3px; background: repeating-linear-gradient(90deg, #fff 0px, #fff 20px, transparent 20px, transparent 40px);"></div>`;
                }
                if (vehicleBg.extra === 'stars') {
                    for (let i = 0; i < 20; i++) {
                        const size = 1 + Math.random() * 2;
                        lane.innerHTML += `<div style="position: absolute; width: ${size}px; height: ${size}px; background: white; border-radius: 50%; left: ${Math.random() * 100}%; top: ${Math.random() * 100}%; opacity: ${0.5 + Math.random() * 0.5};"></div>`;
                    }
                }
                if (vehicleBg.extra === 'waves') {
                    lane.innerHTML += `<div style="position: absolute; bottom: 20%; left: 0; width: 100%; height: 4px; background: repeating-linear-gradient(90deg, transparent, transparent 15px, rgba(255,255,255,0.4) 15px, rgba(255,255,255,0.4) 30px);"></div>`;
                    lane.innerHTML += `<div style="position: absolute; bottom: 40%; left: 10px; width: 100%; height: 3px; background: repeating-linear-gradient(90deg, transparent, transparent 20px, rgba(255,255,255,0.3) 20px, rgba(255,255,255,0.3) 35px);"></div>`;
                }
                if (vehicleBg.extra === 'clouds') {
                    for (let i = 0; i < 4; i++) {
                        const w = 25 + Math.random() * 20;
                        lane.innerHTML += `<div style="position: absolute; width: ${w}px; height: ${w*0.5}px; background: rgba(255,255,255,0.7); border-radius: ${w/2}px; left: ${Math.random() * 85}%; top: ${10 + Math.random() * 50}%;"></div>`;
                    }
                }
                if (vehicleBg.extra === 'carrots') {
                    for (let i = 0; i < 6; i++) {
                        lane.innerHTML += `<div style="position: absolute; font-size: 14px; left: ${10 + Math.random() * 80}%; top: ${40 + Math.random() * 50}%;">ğŸ¥•</div>`;
                    }
                }
                if (vehicleBg.extra === 'mountains') {
                    // ì‚° ì‹¤ë£¨ì—£
                    lane.innerHTML += `<svg style="position: absolute; bottom: 30%; left: 0; width: 100%; height: 40%;" viewBox="0 0 100 40" preserveAspectRatio="none"><polygon points="0,40 15,15 30,40" fill="#7f8c8d"/><polygon points="20,40 40,10 60,40" fill="#95a5a6"/><polygon points="50,40 70,20 90,40" fill="#7f8c8d"/><polygon points="70,40 85,25 100,40" fill="#95a5a6"/></svg>`;
                }
                if (vehicleBg.extra === 'buildings') {
                    // ë„ì‹œ ê±´ë¬¼ ì‹¤ë£¨ì—£
                    lane.innerHTML += `<svg style="position: absolute; bottom: 0; left: 0; width: 100%; height: 35%;" viewBox="0 0 100 35" preserveAspectRatio="none"><rect x="0" y="10" width="8" height="25" fill="#1a252f"/><rect x="10" y="5" width="10" height="30" fill="#2c3e50"/><rect x="22" y="15" width="6" height="20" fill="#1a252f"/><rect x="30" y="8" width="12" height="27" fill="#34495e"/><rect x="45" y="12" width="8" height="23" fill="#2c3e50"/><rect x="55" y="3" width="10" height="32" fill="#1a252f"/><rect x="67" y="18" width="7" height="17" fill="#34495e"/><rect x="76" y="10" width="12" height="25" fill="#2c3e50"/><rect x="90" y="15" width="10" height="20" fill="#1a252f"/></svg>`;
                }
                
                // ê° ë ˆì¸ë³„ ê²°ìŠ¹ì„  ì¶”ê°€ (ë°°ê²½ê³¼ í•¨ê»˜ ìŠ¤í¬ë¡¤ë¨)
                const laneFinishLine = document.createElement('div');
                laneFinishLine.className = 'finish-line';
                laneFinishLine.style.cssText = `
                    position: absolute;
                    left: ${finishLine}px;
                    top: 0;
                    width: 6px;
                    height: 100%;
                `;
                lane.appendChild(laneFinishLine);
                lane.finishLineElement = laneFinishLine;
                
                track.appendChild(lane);
                
                const horse = document.createElement('div');
                horse.className = 'horse racing';
                horse.id = `horse_${horseIndex}`;
                horse.style.cssText = `
                    position: absolute;
                    left: 10px;
                    top: ${laneIndex * totalLaneHeight + 10}px;
                    width: 80px;
                    height: ${laneHeight - 10}px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    z-index: ${100 - laneIndex};
                `;
                
                // ì„ íƒí•œ ëª¨ë“  ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ (ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥)
                const selectedUsers = Object.entries(userHorseBets)
                    .filter(([_, h]) => h === horseIndex)
                    .map(([name, _]) => name);
                
                // íƒˆê²ƒ ìŠ¤í”„ë¼ì´íŠ¸ (2í”„ë ˆì„ ì• ë‹ˆë©”ì´ì…˜)
                const vehicleContent = document.createElement('div');
                vehicleContent.className = 'vehicle-sprite';
                
                const frame1 = document.createElement('div');
                frame1.className = 'frame1';
                const frame2 = document.createElement('div');
                frame2.className = 'frame2';
                
                // íƒˆê²ƒë³„ SVG ìƒì„±
                const vehicleSVGs = getVehicleSVG(vehicleId);
                frame1.innerHTML = vehicleSVGs.frame1;
                frame2.innerHTML = vehicleSVGs.frame2;
                
                vehicleContent.appendChild(frame1);
                vehicleContent.appendChild(frame2);
                
                horse.appendChild(vehicleContent);
                track.appendChild(horse);
                
                // ì´ë¦„ ë¼ë²¨ì„ ë ˆì¸ ì™¼ìª½ ìƒë‹¨ì— í‘œì‹œ
                if (selectedUsers.length > 0) {
                    const namesContainer = document.createElement('div');
                    namesContainer.className = 'names-container';
                    namesContainer.style.cssText = `
                        position: absolute;
                        top: ${laneIndex * totalLaneHeight + 2}px;
                        left: 5px;
                        display: flex;
                        flex-wrap: wrap;
                        gap: 2px;
                        z-index: 200;
                        max-width: 250px;
                    `;
                    
                    selectedUsers.forEach(userName => {
                        const nameTag = document.createElement('span');
                        nameTag.style.cssText = `
                            background: rgba(0,0,0,0.7);
                            color: #fff;
                            padding: 1px 4px;
                            border-radius: 3px;
                            font-size: 10px;
                            font-weight: bold;
                            white-space: nowrap;
                        `;
                        nameTag.textContent = userName;
                        namesContainer.appendChild(nameTag);
                    });
                    
                    track.appendChild(namesContainer);
                }
                
                const duration = speeds[rank] || 5000;
                maxDuration = Math.max(maxDuration, duration);
                horseElements.push({ horse, vehicleContent, frames: [frame1, frame2], rank, duration, lane });
            });
            
            // ì‹¤ì‹œê°„ ìˆœìœ„ íŒ¨ë„ í‘œì‹œ
            const liveRankingPanel = document.getElementById('liveRankingPanel');
            const liveRankingList = document.getElementById('liveRankingList');
            if (liveRankingPanel) {
                liveRankingPanel.style.display = 'block';
            }
            
            // íƒˆê²ƒ ì •ë³´ ë§µ ìƒì„± (horseIndex -> vehicleInfo)
            const vehicleInfoMap = {};
            availableHorses.forEach((horseIndex) => {
                const vehicleId = selectedVehicleTypes && selectedVehicleTypes[horseIndex] 
                    ? selectedVehicleTypes[horseIndex] 
                    : (ALL_VEHICLES.length > 0 ? ALL_VEHICLES[horseIndex % ALL_VEHICLES.length].id : 'car');
                const vehicle = ALL_VEHICLES.find(v => v.id === vehicleId) || { name: 'íƒˆê²ƒ', emoji: 'ğŸƒ' };
                const bettingUsers = Object.entries(userHorseBets)
                    .filter(([_, h]) => h === horseIndex)
                    .map(([name, _]) => name);
                vehicleInfoMap[horseIndex] = { vehicleId, vehicle, bettingUsers };
            });
            
            // ì‹¤ì‹œê°„ ìˆœìœ„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
            const startPosition = 10; // ì‹œì‘ ìœ„ì¹˜
            const totalDistance = finishLine - startPosition; // ì „ì²´ ê±°ë¦¬
            const centerPosition = trackWidth / 2; // í™”ë©´ ê°€ìš´ë° ìœ„ì¹˜ (ë°°ê²½ ìŠ¤í¬ë¡¤ ì‹œì‘ì )
            
            // ë„ì°© ìˆœì„œ ì¶”ì  ê°ì²´
            const finishOrderMap = {};
            
            function updateLiveRanking(horseStatesRef) {
                const positions = [];
                horseElements.forEach(({ horse, rank }) => {
                    const actualHorseIndex = parseInt(horse.id.replace('horse_', ''));
                    const currentLeft = parseFloat(horse.style.left) || startPosition;
                    const progress = Math.min(100, Math.max(0, ((currentLeft - startPosition) / totalDistance) * 100));
                    const remaining = Math.max(0, 100 - progress);
                    
                    // ë„ì°© ìˆœì„œ ê°€ì ¸ì˜¤ê¸° (horseStatesì—ì„œ)
                    let finishOrder = -1;
                    let isFinished = false;
                    if (horseStatesRef) {
                        const state = horseStatesRef.find(s => s.horseIndex === actualHorseIndex);
                        if (state && state.finished) {
                            isFinished = true;
                            finishOrder = state.finishOrder;
                            finishOrderMap[actualHorseIndex] = finishOrder;
                        }
                    }
                    // ì´ë¯¸ ê¸°ë¡ëœ ë„ì°© ìˆœì„œ ì‚¬ìš©
                    if (finishOrderMap[actualHorseIndex] !== undefined) {
                        isFinished = true;
                        finishOrder = finishOrderMap[actualHorseIndex];
                    }
                    
                    positions.push({ horseIndex: actualHorseIndex, position: currentLeft, progress, remaining, isFinished, finishOrder });
                });
                
                // ì •ë ¬: ë„ì°©í•œ ë§ì€ ë„ì°© ìˆœì„œëŒ€ë¡œ, ë‚˜ë¨¸ì§€ëŠ” ìœ„ì¹˜ ìˆœ
                positions.sort((a, b) => {
                    // ë‘˜ ë‹¤ ë„ì°©í•œ ê²½ìš° ë„ì°© ìˆœì„œë¡œ
                    if (a.isFinished && b.isFinished) {
                        return a.finishOrder - b.finishOrder;
                    }
                    // í•˜ë‚˜ë§Œ ë„ì°©í•œ ê²½ìš° ë„ì°©í•œ ìª½ì´ ì•
                    if (a.isFinished) return -1;
                    if (b.isFinished) return 1;
                    // ë‘˜ ë‹¤ ë¯¸ë„ì°©ì‹œ ìœ„ì¹˜ ìˆœ
                    return b.position - a.position;
                });
                
                // ìˆœìœ„ í‘œì‹œ ì—…ë°ì´íŠ¸
                if (liveRankingList) {
                    let html = '';
                    positions.forEach((pos, idx) => {
                        const info = vehicleInfoMap[pos.horseIndex];
                        if (info) {
                            const medal = idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : idx === 2 ? 'ğŸ¥‰' : `${idx + 1}.`;
                            const users = info.bettingUsers.length > 0 ? info.bettingUsers.join(',') : '-';
                            const remainingText = pos.remaining <= 0 ? 'ğŸ' : `${Math.round(pos.remaining)}%`;
                            const progressColor = pos.remaining <= 0 ? '#4ade80' : pos.remaining < 30 ? '#fbbf24' : '#94a3b8';
                            html += `<div style="display: flex; align-items: center; gap: 4px; margin: 4px 0; ${idx === 0 ? 'color: #ffd700; font-weight: bold;' : ''}">
                                <span style="width: 20px; font-size: 12px;">${medal}</span>
                                <span style="font-size: 14px;">${info.vehicle.emoji}</span>
                                <span style="flex: 1; font-size: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${users}</span>
                                <span style="font-size: 10px; color: ${progressColor}; min-width: 32px; text-align: right;">${remainingText}</span>
                            </div>`;
                        }
                    });
                    liveRankingList.innerHTML = html;
                }
            }
            
            // ì‹¤ì‹œê°„ ìˆœìœ„ ì—…ë°ì´íŠ¸ ì¸í„°ë²Œ
            let rankingInterval = null;
            let animationInterval = null;
            let currentScrollOffset = 0; // í˜„ì¬ ìŠ¤í¬ë¡¤ ì˜¤í”„ì…‹
            let scrollStarted = false; // ìŠ¤í¬ë¡¤ ì‹œì‘ ì—¬ë¶€
            
            // ê° íƒˆê²ƒì˜ ì• ë‹ˆë©”ì´ì…˜ ìƒíƒœ (ì„œë²„ì—ì„œ ë°›ì€ ê¸°ë¯¹ ë°ì´í„° ì‚¬ìš©)
            const horseStates = horseElements.map(({ horse, frames, duration, rank, lane }) => {
                const horseIndex = parseInt(horse.id.replace('horse_', ''));
                
                // ì„œë²„ì—ì„œ ë°›ì€ ê¸°ë¯¹ ë°ì´í„° ì‚¬ìš© (ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´)
                const serverGimmickList = serverGimmicks && serverGimmicks[horseIndex] ? serverGimmicks[horseIndex] : [];
                const gimmicks = serverGimmickList.map(g => ({
                    progressTrigger: g.progressTrigger,
                    type: g.type,
                    duration: g.duration,
                    speedMultiplier: g.speedMultiplier,
                    triggered: false,
                    active: false,
                    endTime: 0
                }));
                
                // ê¸°ë³¸ ì†ë„ ê³„ì‚° (duration ê¸°ë°˜)
                const baseSpeed = totalDistance / duration;
                
                // ì´ˆê¸° ì†ë„ ë³€í™”ë¥¼ ìœ„í•œ ì‹œë“œ (horseIndex ê¸°ë°˜ìœ¼ë¡œ ì¼ê´€ì„± ìœ ì§€)
                const initialSpeedFactor = 0.8 + ((horseIndex * 1234567) % 100) / 250; // 0.8 ~ 1.2
                
                return {
                    horse,
                    frames,
                    duration,
                    rank,
                    horseIndex,
                    lane,
                    currentPos: startPosition,
                    baseSpeed,
                    currentSpeed: baseSpeed * initialSpeedFactor,
                    targetSpeed: baseSpeed,
                    finished: false,
                    gimmicks,
                    wobblePhase: 0,
                    lastSpeedChange: 0,
                    speedChangeSeed: horseIndex * 9876 // ì†ë„ ë³€í™” ì‹œë“œ
                };
            });
            
            // ê°€ì¥ ë¹ ë¥¸ ë§ì˜ ì†ë„ ê³„ì‚° (ìŠ¤í¬ë¡¤ ì†ë„ ê¸°ì¤€)
            const fastestSpeed = Math.max(...horseStates.map(s => s.baseSpeed));
            const scrollSpeed = fastestSpeed; // ìŠ¤í¬ë¡¤ ì†ë„ = ê°€ì¥ ë¹ ë¥¸ ë§ì˜ ì†ë„
            
            // ëª¨ë“  íƒˆê²ƒ ë™ì‹œì— ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
            setTimeout(() => {
                const startTime = Date.now();
                const frameInterval = 16; // ~60fps
                let finishOrderCounter = 0; // ë„ì°© ìˆœì„œ ì¹´ìš´í„°
                
                // JavaScript ê¸°ë°˜ ì• ë‹ˆë©”ì´ì…˜ ë£¨í”„
                animationInterval = setInterval(() => {
                    const elapsed = Date.now() - startTime;
                    let allFinished = true;
                    
                    horseStates.forEach(state => {
                        if (state.finished) return;
                        allFinished = false;
                        
                        const progress = (state.currentPos - startPosition) / totalDistance;
                        
                        // ê¸°ë¯¹ ì²´í¬
                        state.gimmicks.forEach(gimmick => {
                            // ê¸°ë¯¹ íŠ¸ë¦¬ê±° ì²´í¬
                            if (!gimmick.triggered && progress >= gimmick.progressTrigger) {
                                gimmick.triggered = true;
                                gimmick.active = true;
                                gimmick.endTime = elapsed + gimmick.duration;
                                
                                // ê¸°ë¯¹ ì‹œì‘ íš¨ê³¼ ë° ì´í™íŠ¸ ì¶”ê°€
                                if (gimmick.type === 'stop') {
                                    state.horse.style.filter = 'brightness(0.7)';
                                    // ë¸Œë ˆì´í¬ ì—°ê¸° ì´í™íŠ¸
                                    const stopEffect = document.createElement('div');
                                    stopEffect.className = 'gimmick-effect-stop';
                                    stopEffect.innerHTML = '<div class="brake-smoke"></div><div class="brake-smoke"></div><div class="brake-smoke"></div>';
                                    state.horse.appendChild(stopEffect);
                                    gimmick.effectElement = stopEffect;
                                } else if (gimmick.type === 'sprint') {
                                    state.horse.style.filter = 'brightness(1.3) saturate(1.5)';
                                    // ë¶ˆê½ƒ + ì†ë„ì„  ì´í™íŠ¸
                                    const sprintEffect = document.createElement('div');
                                    sprintEffect.className = 'gimmick-effect-sprint';
                                    sprintEffect.innerHTML = `
                                        <div class="flame-core"></div>
                                        <div class="flame"></div>
                                        <div class="flame"></div>
                                        <div class="flame"></div>
                                    `;
                                    state.horse.appendChild(sprintEffect);
                                    // ì†ë„ì„  ì¶”ê°€
                                    const speedLines = document.createElement('div');
                                    speedLines.className = 'speed-lines';
                                    speedLines.innerHTML = '<div class="speed-line"></div><div class="speed-line"></div><div class="speed-line"></div><div class="speed-line"></div><div class="speed-line"></div>';
                                    state.horse.appendChild(speedLines);
                                    gimmick.effectElement = sprintEffect;
                                    gimmick.speedLinesElement = speedLines;
                                } else if (gimmick.type === 'slip') {
                                    state.horse.style.filter = 'hue-rotate(20deg)';
                                    // ë¯¸ë„ëŸ¬ì§ ë¨¼ì§€ ì´í™íŠ¸
                                    const slipEffect = document.createElement('div');
                                    slipEffect.className = 'gimmick-effect-slip';
                                    slipEffect.innerHTML = '<div class="dust-cloud"></div><div class="dust-cloud"></div>';
                                    state.horse.appendChild(slipEffect);
                                    gimmick.effectElement = slipEffect;
                                } else if (gimmick.type === 'slow') {
                                    state.horse.style.filter = 'brightness(0.9) grayscale(0.3)';
                                    // í”¼ë¡œ ë•€ë°©ìš¸ ì´í™íŠ¸
                                    const slowEffect = document.createElement('div');
                                    slowEffect.className = 'gimmick-effect-slow';
                                    slowEffect.innerHTML = '<div class="sweat-drop"></div><div class="sweat-drop"></div>';
                                    state.horse.appendChild(slowEffect);
                                    gimmick.effectElement = slowEffect;
                                } else if (gimmick.type === 'wobble') {
                                    state.wobblePhase = 0;
                                    // ì–´ì§€ëŸ¬ì›€ ë³„ ì´í™íŠ¸
                                    const wobbleEffect = document.createElement('div');
                                    wobbleEffect.className = 'gimmick-effect-wobble';
                                    wobbleEffect.textContent = 'ğŸ’«';
                                    state.horse.appendChild(wobbleEffect);
                                    gimmick.effectElement = wobbleEffect;
                                }
                            }
                            
                            // ê¸°ë¯¹ ì¢…ë£Œ ì²´í¬
                            if (gimmick.active && elapsed >= gimmick.endTime) {
                                gimmick.active = false;
                                state.horse.style.filter = '';
                                // ì´í™íŠ¸ ìš”ì†Œ ì œê±°
                                if (gimmick.effectElement && gimmick.effectElement.parentNode) {
                                    gimmick.effectElement.remove();
                                    gimmick.effectElement = null;
                                }
                                if (gimmick.speedLinesElement && gimmick.speedLinesElement.parentNode) {
                                    gimmick.speedLinesElement.remove();
                                    gimmick.speedLinesElement = null;
                                }
                            }
                        });
                        
                        // í™œì„±í™”ëœ ê¸°ë¯¹ì— ë”°ë¥¸ ì†ë„ ê³„ì‚°
                        let speedMultiplier = 1;
                        let hasActiveGimmick = false;
                        state.gimmicks.forEach(gimmick => {
                            if (gimmick.active) {
                                hasActiveGimmick = true;
                                speedMultiplier = gimmick.speedMultiplier;
                                
                                // ì§€ê·¸ì¬ê·¸ íš¨ê³¼
                                if (gimmick.type === 'wobble') {
                                    state.wobblePhase += 0.3;
                                    const wobbleOffset = Math.sin(state.wobblePhase) * 3;
                                    state.horse.style.transform = `translateY(${wobbleOffset}px)`;
                                }
                            }
                        });
                        
                        // ì§€ê·¸ì¬ê·¸ê°€ ì•„ë‹ ë•Œ transform ë¦¬ì…‹
                        if (!state.gimmicks.some(g => g.active && g.type === 'wobble')) {
                            state.horse.style.transform = '';
                        }
                        
                        // ìì—°ìŠ¤ëŸ¬ìš´ ì†ë„ ë³€í™” (ê¸°ë¯¹ì´ ì—†ì„ ë•Œ) - ì‹œë“œ ê¸°ë°˜ìœ¼ë¡œ ë™ê¸°í™”
                        if (!hasActiveGimmick) {
                            // ì‹œë“œ ê¸°ë°˜ ì˜ì‚¬ ë‚œìˆ˜ ìƒì„± (elapsed ì‹œê°„ê³¼ horseIndex ê¸°ë°˜)
                            const seedValue = (state.speedChangeSeed + Math.floor(elapsed / 500)) * 9301 + 49297;
                            const pseudoRandom = ((seedValue % 233280) / 233280);
                            
                            // ì£¼ê¸°ì ìœ¼ë¡œ ëª©í‘œ ì†ë„ ë³€ê²½ (ê°€ì†/ê°ì†) - 500ms ê°„ê²©
                            const changeInterval = 500;
                            const currentInterval = Math.floor(elapsed / changeInterval);
                            const lastInterval = Math.floor(state.lastSpeedChange / changeInterval);
                            
                            if (currentInterval > lastInterval) {
                                state.lastSpeedChange = elapsed;
                                // ì‹œë“œ ê¸°ë°˜ ì†ë„ ë³€í™” (0.7 ~ 1.3 ë²”ìœ„)
                                const speedSeed = (state.speedChangeSeed + currentInterval) * 16807 % 2147483647;
                                const speedFactor = 0.7 + (speedSeed % 600) / 1000;
                                state.targetSpeed = state.baseSpeed * speedFactor;
                            }
                            
                            // í˜„ì¬ ì†ë„ë¥¼ ëª©í‘œ ì†ë„ë¡œ ë¶€ë“œëŸ½ê²Œ ì „í™˜
                            const speedDiff = state.targetSpeed - state.currentSpeed;
                            state.currentSpeed += speedDiff * 0.05;
                            speedMultiplier = state.currentSpeed / state.baseSpeed;
                        }
                        
                        // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                        // ë§ì´ ê°€ìš´ë°ì— ë„ë‹¬í•˜ê¸° ì „ê¹Œì§€ëŠ” ì •ìƒì ìœ¼ë¡œ ì•ìœ¼ë¡œ ì´ë™
                        // ê°€ìš´ë°ì— ë„ë‹¬í•œ í›„ë¶€í„°ëŠ” ë°°ê²½ ìŠ¤í¬ë¡¤ê³¼ í•¨ê»˜ í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°
                        const movement = state.baseSpeed * speedMultiplier * (frameInterval / 1000) * 1000;
                        state.currentPos = Math.max(startPosition, state.currentPos + movement);
                        
                        // ê²°ìŠ¹ì„  ë„ì°© ì²´í¬
                        if (state.currentPos >= finishLine && !state.finished) {
                            state.currentPos = finishLine;
                            state.finished = true;
                            state.finishOrder = finishOrderCounter++;
                            state.horse.style.filter = '';
                            state.horse.style.transform = '';
                            
                            // ë„ì°© ì• ë‹ˆë©”ì´ì…˜ í‘œì‹œ
                            showFinishAnimation(state.horse, state.finishOrder, state.horseIndex);
                        }
                    });
                    
                    // === ì¼ì • ì†ë„ ìŠ¤í¬ë¡¤ë§ ===
                    // ë¦¬ë”(1ë“±) ë§ ì°¾ê¸° (ìˆœìœ„ í‘œì‹œìš©)
                    const leaderState = horseStates.reduce((leader, state) => 
                        state.currentPos > leader.currentPos ? state : leader, horseStates[0]);
                    const leaderPos = leaderState.currentPos;
                    
                    // ìŠ¤í¬ë¡¤ ì„¤ì •
                    const finishLineDisplayOffset = 250;
                    const scrollReleasePoint = finishLine - finishLineDisplayOffset;
                    const maxScrollLimit = -(scrollReleasePoint - centerPosition);
                    
                    // ìŠ¤í¬ë¡¤ ì‹œì‘ ì¡°ê±´: ì•„ë¬´ ë§ì´ë“  centerPositionì— ë„ë‹¬
                    if (!scrollStarted && leaderPos >= centerPosition) {
                        scrollStarted = true;
                    }
                    
                    // ì¼ì •í•œ ì†ë„ë¡œ ìŠ¤í¬ë¡¤ (ë©ˆì¶”ì§€ ì•ŠìŒ)
                    if (scrollStarted && currentScrollOffset > maxScrollLimit) {
                        // baseSpeedëŠ” px/ms ë‹¨ìœ„ì´ë¯€ë¡œ frameInterval(ms)ì„ ê³±í•¨
                        currentScrollOffset -= scrollSpeed * frameInterval;
                        // ìµœëŒ€ ìŠ¤í¬ë¡¤ ì œí•œ
                        if (currentScrollOffset < maxScrollLimit) {
                            currentScrollOffset = maxScrollLimit;
                        }
                    }
                    
                    const bgScrollOffset = currentScrollOffset;
                    
                    // ëª¨ë“  ë§ì˜ í™”ë©´ ìœ„ì¹˜ ë° ë°°ê²½ ì—…ë°ì´íŠ¸ (ìŠ¤í¬ë¡¤ ì˜¤í”„ì…‹ ê¸°ì¤€)
                    const cullEdge = -50; // ì´ ê°’ë³´ë‹¤ ì™¼ìª½ì´ë©´ ëì— ì‚´ì§ ë³´ì´ê²Œ (ì»¬ë§ ëŒ€ì‹  í´ë¨í”„, ìŒìˆ˜ì¼ìˆ˜ë¡ ëœ ë³´ì„)
                    horseStates.forEach(state => {
                        // í™”ë©´ ìœ„ì¹˜ = ì‹¤ì œ ìœ„ì¹˜ + ìŠ¤í¬ë¡¤ ì˜¤í”„ì…‹
                        let horseDisplayPos = state.currentPos + bgScrollOffset;
                        // ë’¤ì²˜ì§„ ë§ì€ ì™„ì „íˆ ìˆ¨ê¸°ì§€ ì•Šê³ , ì™¼ìª½ ëì—ì„œ ì‚´ì§ì´ë¼ë„ ë³´ì´ê²Œ
                        if (horseDisplayPos < cullEdge) {
                            horseDisplayPos = cullEdge;
                        }
                        state.horse.style.left = `${horseDisplayPos}px`;
                        state.horse.style.visibility = 'visible';
                        
                        // ë°°ê²½ ìŠ¤í¬ë¡¤ - ëª¨ë“  ë ˆì¸ì—ì„œ ë¦¬ë” ê¸°ì¤€ìœ¼ë¡œ ë™ì¼í•˜ê²Œ
                        if (state.lane) {
                            state.lane.style.backgroundPosition = `${bgScrollOffset}px center`;
                            
                            // ê²°ìŠ¹ì„ ë„ ë¦¬ë” ê¸°ì¤€ìœ¼ë¡œ ìŠ¤í¬ë¡¤
                            if (state.lane.finishLineElement) {
                                state.lane.finishLineElement.style.left = `${finishLine + bgScrollOffset}px`;
                            }
                        }
                    });
                    
                    // ê¼´ë“±-1ì´ ì™„ì£¼í•˜ë©´ ì¢…ë£Œ (ë§ì´ 2ë§ˆë¦¬ ì´ìƒì¼ ë•Œë§Œ)
                    const totalHorses = horseStates.length;
                    const finishedCount = horseStates.filter(s => s.finished).length;
                    const almostAllFinished = totalHorses >= 2 && finishedCount >= totalHorses - 1;
                    
                    if (almostAllFinished) {
                        clearInterval(animationInterval);
                        animationInterval = null;
                        
                        // ê¼´ë“±(ì•„ì§ ì™„ì£¼ ëª»í•œ ë§) ì°¾ê¸°
                        const lastPlaceState = horseStates.find(s => !s.finished);
                        
                        // ì‹¤ì œ ë„ì°© ìˆœì„œ ìˆ˜ì§‘ (ì™„ì£¼í•œ ë§ë“¤ë§Œ)
                        const actualFinishOrder = horseStates
                            .filter(s => s.finished)
                            .sort((a, b) => a.finishOrder - b.finishOrder)
                            .map(s => s.horseIndex);
                        
                        // ê¼´ë“±ì„ ë§ˆì§€ë§‰ì— ì¶”ê°€
                        if (lastPlaceState) {
                            actualFinishOrder.push(lastPlaceState.horseIndex);
                        }
                        
                        // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                        window.lastActualFinishOrder = actualFinishOrder;
                        
                        // ê¼´ë“± ì‚¬ë§ ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰ í›„ ê²Œì„ ì¢…ë£Œ
                        const finishGame = () => {
                            setTimeout(() => {
                                if (rankingInterval) {
                                    clearInterval(rankingInterval);
                                    rankingInterval = null;
                                }
                                // ìµœì¢… ìˆœìœ„ í•œ ë²ˆ ë” ì—…ë°ì´íŠ¸
                                updateLiveRanking(horseStates);
                                // ì ì‹œ í›„ íŒ¨ë„ ìˆ¨ê¸°ê¸° ë° ì½œë°± í˜¸ì¶œ
                                setTimeout(() => {
                                    if (liveRankingPanel) {
                                        liveRankingPanel.style.display = 'none';
                                    }
                                    // ì™„ë£Œ ì½œë°± í˜¸ì¶œ
                                    if (onComplete) {
                                        onComplete(actualFinishOrder);
                                    }
                                }, 1500);
                            }, 500);
                        };
                        
                        // ê¼´ë“±ì´ ìˆìœ¼ë©´ ì‚¬ë§ ì• ë‹ˆë©”ì´ì…˜, ì—†ìœ¼ë©´ ë°”ë¡œ ì¢…ë£Œ
                        if (lastPlaceState) {
                            // ê¼´ë“±ì—ê²Œ finished ìƒíƒœ ë¶€ì—¬ (ìˆœìœ„ ê³„ì‚°ìš©)
                            lastPlaceState.finished = true;
                            lastPlaceState.finishOrder = finishOrderCounter;
                            
                            showDeathAnimation(lastPlaceState.horse, lastPlaceState.horseIndex, finishOrderCounter, finishGame);
                        } else {
                            finishGame();
                        }
                    }
                }, frameInterval);
                
                // ì‹¤ì‹œê°„ ìˆœìœ„ ì—…ë°ì´íŠ¸ ì‹œì‘ (100ms ê°„ê²©)
                rankingInterval = setInterval(() => updateLiveRanking(horseStates), 100);
                updateLiveRanking(horseStates); // ì¦‰ì‹œ ì²« ì—…ë°ì´íŠ¸
            }, 500);
            
            return maxDuration + 1000;
        }
        
        // ìˆœìœ„ ì´í™íŠ¸ ì˜¤ë²„ë ˆì´ ê´€ë¦¬
        let finishEffectsOverlay = null;
        const finishEffectElements = new Map(); // horseIndex -> effectElement
        
        function getOrCreateFinishEffectsOverlay() {
            if (!finishEffectsOverlay) {
                finishEffectsOverlay = document.createElement('div');
                finishEffectsOverlay.id = 'finishEffectsOverlay';
                finishEffectsOverlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    pointer-events: none;
                    z-index: 99999;
                `;
                document.body.appendChild(finishEffectsOverlay);
            }
            return finishEffectsOverlay;
        }
        
        function clearFinishEffects() {
            if (finishEffectsOverlay) {
                finishEffectsOverlay.remove();
                finishEffectsOverlay = null;
            }
            finishEffectElements.clear();
        }
        
        // ë„ì°© ì• ë‹ˆë©”ì´ì…˜ í‘œì‹œ (í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼, ë§ ë‚´ë¶€ ì™¼ìª½ì— í‘œì‹œ)
        function showFinishAnimation(horseElement, finishOrder, horseIndex) {
            const rankTexts = ['ğŸ¥‡ 1ë“±!', 'ğŸ¥ˆ 2ë“±!', 'ğŸ¥‰ 3ë“±!', '4ë“±', '5ë“±', '6ë“±'];
            const rankColors = ['#FFD700', '#C0C0C0', '#CD7F32', '#888', '#888', '#888'];

            const existingEffect = finishEffectElements.get(horseIndex);
            if (existingEffect) existingEffect.remove();

            // ë§ ìš”ì†Œ ì•ˆì— ìì‹ìœ¼ë¡œ ì‚½ì… (overflow visibleë¡œ ì™¼ìª½ì— í‘œì‹œ)
            horseElement.style.overflow = 'visible';

            const label = document.createElement('div');
            label.className = 'finish-effect';
            label.dataset.horseIndex = horseIndex;

            const fontSize = finishOrder === 0 ? '20px' : finishOrder <= 2 ? '17px' : '14px';

            label.style.cssText = `
                position: absolute;
                left: -75px;
                top: 50%;
                transform: translateY(-50%);
                font-size: ${fontSize};
                font-weight: 900;
                color: ${rankColors[finishOrder] || '#888'};
                text-shadow:
                    -2px -2px 0 #000, 2px -2px 0 #000,
                    -2px 2px 0 #000, 2px 2px 0 #000,
                    0 0 8px rgba(0,0,0,0.8);
                pointer-events: none;
                z-index: -1;
                white-space: nowrap;
                animation: tombstoneDrop 0.5s ease-out forwards;
                opacity: 0;
            `;
            label.textContent = rankTexts[finishOrder] || `${finishOrder + 1}ë“±`;

            horseElement.appendChild(label);
            finishEffectElements.set(horseIndex, label);

            // 1ë“± íŠ¹ë³„ íš¨ê³¼
            if (finishOrder === 0) {
                horseElement.style.filter = 'drop-shadow(0 0 15px gold) brightness(1.2)';
                horseElement.style.transform = 'scale(1.1)';
            }
        }
        
        // ê¼´ë“± ì‚¬ë§ ì• ë‹ˆë©”ì´ì…˜ (ì‹œì²´ í˜ì´ë“œ ì•„ì›ƒ + ì˜í˜¼ë§Œ ì˜¤ë²„ë ˆì´, ë¹„ì„ì€ íŠ¸ë™ ì•ˆìª½ì— ê·¸ë ¤ì„œ ìŠ¤í¬ë¡¤ê³¼ í•¨ê»˜ ìœ ì§€)
        function showDeathAnimation(horseElement, horseIndex, finishRank, onComplete) {
            const track = document.getElementById('raceTrack');
            const overlay = getOrCreateFinishEffectsOverlay();
            const horseRect = horseElement.getBoundingClientRect();
            
            // ê¸°ì¡´ ì˜¤ë²„ë ˆì´ ì´í™íŠ¸ë§Œ ì œê±° (ë¹„ì„ì€ íŠ¸ë™ì— ìˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œ ì œê±° ëŒ€ìƒ ì•„ë‹˜)
            const existingEffect = finishEffectElements.get(horseIndex);
            if (existingEffect) existingEffect.remove();
            
            // íƒˆê²ƒ í˜ì´ë“œ ì•„ì›ƒ í›„ ì™„ì „íˆ ì‚¬ë¼ì§
            horseElement.style.animation = 'deathFade 2s ease-out forwards';
            
            // ì˜í˜¼ë§Œ ì˜¤ë²„ë ˆì´ì— í‘œì‹œ (ìœ„ë¡œ ì˜¬ë¼ê°€ë©° ì‚¬ë¼ì§)
            const soulContainer = document.createElement('div');
            soulContainer.className = 'death-effect soul-only';
            soulContainer.dataset.horseIndex = horseIndex;
            soulContainer.style.cssText = `
                position: fixed;
                left: ${horseRect.left + horseRect.width / 2 - 15}px;
                top: ${horseRect.top + horseRect.height / 2 - 15}px;
                width: 30px;
                height: 40px;
                pointer-events: none;
                z-index: 10000;
            `;
            const soul = document.createElement('div');
            soul.innerHTML = 'ğŸ‘»';
            soul.style.cssText = `
                position: absolute;
                top: 0;
                left: 50%;
                transform: translateX(-50%);
                font-size: 30px;
                animation: soulRise 3s ease-out forwards;
                text-shadow: 0 0 10px rgba(255,255,255,0.8);
            `;
            soulContainer.appendChild(soul);
            overlay.appendChild(soulContainer);
            finishEffectElements.set(horseIndex, soulContainer);
            setTimeout(() => {
                if (soulContainer.parentNode) soulContainer.remove();
                finishEffectElements.delete(horseIndex);
            }, 3500);
            
            // ë¹„ì„ì€ íŠ¸ë™ ì•ˆìª½ì— ì¶”ê°€ (ê¸°ì¡´ ì˜¤ë¸Œì íŠ¸ì²˜ëŸ¼ ìŠ¤í¬ë¡¤Â·ë ˆì´ì•„ì›ƒì— í¬í•¨)
            if (track) {
                const leftPx = horseElement.offsetLeft + (horseElement.offsetWidth / 2) - 25;
                const topPx = horseElement.offsetTop + (horseElement.offsetHeight / 2) - 40;
                const tombstoneWrap = document.createElement('div');
                tombstoneWrap.className = 'tombstone-in-track';
                tombstoneWrap.dataset.horseIndex = horseIndex;
                tombstoneWrap.style.cssText = `
                    position: absolute;
                    left: ${leftPx}px;
                    top: ${topPx}px;
                    width: 50px;
                    height: 80px;
                    pointer-events: none;
                    z-index: 150;
                `;
                tombstoneWrap.innerHTML = `
                    <div style="
                        position: absolute;
                        top: 15px;
                        left: 50%;
                        transform: translateX(-50%);
                        font-size: 35px;
                        text-align: center;
                        animation: tombstoneDrop 1.6s ease-out 1s forwards;
                        opacity: 0;
                        filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.5));
                    ">ğŸª¦<span style="display:block;font-size:12px;font-weight:bold;color:#444;">${finishRank + 1}ë“±</span></div>
                `;
                track.appendChild(tombstoneWrap);
            }
            
            setTimeout(() => {
                if (onComplete) onComplete();
            }, 4000);
        }
        
        // ì¶•í•˜ ì»¨í˜í‹° ìƒì„±
        function createConfetti() {
            const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8'];
            let confettiHtml = '';
            
            for (let i = 0; i < 20; i++) {
                const color = colors[Math.floor(Math.random() * colors.length)];
                const left = Math.random() * 80 - 10;
                const delay = Math.random() * 0.3;
                const rotation = Math.random() * 360;
                const size = 4 + Math.random() * 4;
                const duration = 1 + Math.random() * 0.5;
                
                confettiHtml += `
                    <div style="
                        position: absolute;
                        left: ${left}px;
                        top: 0;
                        width: ${size}px;
                        height: ${size}px;
                        background: ${color};
                        transform: rotate(${rotation}deg);
                        animation: confettiFall ${duration}s ease-out ${delay}s forwards;
                        opacity: 0;
                        border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
                    "></div>
                `;
            }
            
            return confettiHtml;
        }
        
        // íƒˆê²ƒë³„ SVG ìƒì„± í•¨ìˆ˜
        function getVehicleSVG(vehicleId) {
            const svgMap = {
                'car': { // ìë™ì°¨ - ë°”í€´ íšŒì „
                    frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <rect x="10" y="15" width="40" height="15" rx="3" fill="#e74c3c"/>
                        <rect x="18" y="8" width="22" height="12" rx="2" fill="#e74c3c"/>
                        <rect x="20" y="10" width="8" height="8" fill="#87CEEB"/>
                        <rect x="30" y="10" width="8" height="8" fill="#87CEEB"/>
                        <circle cx="18" cy="32" r="6" fill="#333"/><circle cx="18" cy="32" r="3" fill="#666"/>
                        <line x1="18" y1="29" x2="18" y2="35" stroke="#999" stroke-width="1"/>
                        <circle cx="42" cy="32" r="6" fill="#333"/><circle cx="42" cy="32" r="3" fill="#666"/>
                        <line x1="42" y1="29" x2="42" y2="35" stroke="#999" stroke-width="1"/>
                    </svg>`,
                    frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <rect x="10" y="15" width="40" height="15" rx="3" fill="#e74c3c"/>
                        <rect x="18" y="8" width="22" height="12" rx="2" fill="#e74c3c"/>
                        <rect x="20" y="10" width="8" height="8" fill="#87CEEB"/>
                        <rect x="30" y="10" width="8" height="8" fill="#87CEEB"/>
                        <circle cx="18" cy="32" r="6" fill="#333"/><circle cx="18" cy="32" r="3" fill="#666"/>
                        <line x1="15" y1="32" x2="21" y2="32" stroke="#999" stroke-width="1"/>
                        <circle cx="42" cy="32" r="6" fill="#333"/><circle cx="42" cy="32" r="3" fill="#666"/>
                        <line x1="39" y1="32" x2="45" y2="32" stroke="#999" stroke-width="1"/>
                    </svg>`
                },
                'rocket': { // ë¡œì¼“ - ë¶ˆê½ƒ ê¹œë¹¡ì„
                    frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <ellipse cx="35" cy="22" rx="18" ry="10" fill="#3498db"/>
                        <polygon points="53,22 60,15 60,29" fill="#e74c3c"/>
                        <circle cx="50" cy="22" r="4" fill="#87CEEB"/>
                        <rect x="8" y="18" width="10" height="8" fill="#e74c3c"/>
                        <polygon points="8,22 2,18 2,26" fill="#f39c12"/>
                        <polygon points="2,22 -3,20 -3,24" fill="#e67e22"/>
                    </svg>`,
                    frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <ellipse cx="35" cy="22" rx="18" ry="10" fill="#3498db"/>
                        <polygon points="53,22 60,15 60,29" fill="#e74c3c"/>
                        <circle cx="50" cy="22" r="4" fill="#87CEEB"/>
                        <rect x="8" y="18" width="10" height="8" fill="#e74c3c"/>
                        <polygon points="8,22 0,16 0,28" fill="#f1c40f"/>
                        <polygon points="0,22 -5,19 -5,25" fill="#f39c12"/>
                    </svg>`
                },
                'bird': { // ìƒˆ - ë‚ ê°œ í„ëŸ­ì„
                    frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <ellipse cx="30" cy="25" rx="15" ry="8" fill="#9b59b6"/>
                        <circle cx="48" cy="22" r="7" fill="#9b59b6"/>
                        <polygon points="55,22 62,20 62,24" fill="#f39c12"/>
                        <circle cx="52" cy="20" r="2" fill="black"/>
                        <path d="M25,25 Q15,10 30,18" fill="#8e44ad"/>
                        <path d="M35,25 Q25,8 40,16" fill="#8e44ad"/>
                        <polygon points="12,28 8,32 15,30" fill="#9b59b6"/>
                    </svg>`,
                    frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <ellipse cx="30" cy="25" rx="15" ry="8" fill="#9b59b6"/>
                        <circle cx="48" cy="22" r="7" fill="#9b59b6"/>
                        <polygon points="55,22 62,20 62,24" fill="#f39c12"/>
                        <circle cx="52" cy="20" r="2" fill="black"/>
                        <path d="M25,25 Q15,35 30,30" fill="#8e44ad"/>
                        <path d="M35,25 Q25,38 40,32" fill="#8e44ad"/>
                        <polygon points="12,28 8,32 15,30" fill="#9b59b6"/>
                    </svg>`
                },
                'boat': { // ë³´íŠ¸ - ë¬¼ê²° íš¨ê³¼
                    frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <path d="M5,30 Q15,28 25,30 Q35,32 45,30 Q55,28 60,30" fill="none" stroke="#3498db" stroke-width="3"/>
                        <polygon points="10,28 50,28 45,20 15,20" fill="#e74c3c"/>
                        <rect x="28" y="10" width="4" height="12" fill="#8b4513"/>
                        <polygon points="32,8 32,18 50,14" fill="white"/>
                    </svg>`,
                    frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <path d="M5,30 Q15,32 25,30 Q35,28 45,30 Q55,32 60,30" fill="none" stroke="#3498db" stroke-width="3"/>
                        <polygon points="10,28 50,28 45,20 15,20" fill="#e74c3c"/>
                        <rect x="28" y="10" width="4" height="12" fill="#8b4513"/>
                        <polygon points="32,8 32,18 50,14" fill="white"/>
                    </svg>`
                },
                'bicycle': { // ìì „ê±° - í˜ë‹¬ íšŒì „
                    frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <circle cx="12" cy="30" r="8" fill="none" stroke="#333" stroke-width="2"/>
                        <circle cx="48" cy="30" r="8" fill="none" stroke="#333" stroke-width="2"/>
                        <line x1="12" y1="30" x2="30" y2="30" stroke="#666" stroke-width="2"/>
                        <line x1="30" y1="30" x2="48" y2="30" stroke="#666" stroke-width="2"/>
                        <line x1="30" y1="30" x2="35" y2="15" stroke="#666" stroke-width="2"/>
                        <circle cx="35" cy="13" r="4" fill="#f39c12"/>
                        <circle cx="30" cy="30" r="3" fill="#333"/>
                        <line x1="30" y1="30" x2="33" y2="35" stroke="#333" stroke-width="2"/>
                        <line x1="30" y1="30" x2="27" y2="25" stroke="#333" stroke-width="2"/>
                    </svg>`,
                    frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <circle cx="12" cy="30" r="8" fill="none" stroke="#333" stroke-width="2"/>
                        <circle cx="48" cy="30" r="8" fill="none" stroke="#333" stroke-width="2"/>
                        <line x1="12" y1="30" x2="30" y2="30" stroke="#666" stroke-width="2"/>
                        <line x1="30" y1="30" x2="48" y2="30" stroke="#666" stroke-width="2"/>
                        <line x1="30" y1="30" x2="35" y2="15" stroke="#666" stroke-width="2"/>
                        <circle cx="35" cy="13" r="4" fill="#f39c12"/>
                        <circle cx="30" cy="30" r="3" fill="#333"/>
                        <line x1="30" y1="30" x2="27" y2="35" stroke="#333" stroke-width="2"/>
                        <line x1="30" y1="30" x2="33" y2="25" stroke="#333" stroke-width="2"/>
                    </svg>`
                },
                'rabbit': { // í† ë¼ - ê¹¡ì¶©ê¹¡ì¶©
                    frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <ellipse cx="30" cy="28" rx="14" ry="10" fill="#f5f5dc"/>
                        <circle cx="45" cy="22" r="8" fill="#f5f5dc"/>
                        <ellipse cx="40" cy="8" rx="3" ry="10" fill="#f5f5dc"/>
                        <ellipse cx="48" cy="10" rx="3" ry="9" fill="#f5f5dc"/>
                        <ellipse cx="40" cy="10" rx="2" ry="6" fill="#ffb6c1"/>
                        <ellipse cx="48" cy="12" rx="2" ry="5" fill="#ffb6c1"/>
                        <circle cx="50" cy="20" r="2" fill="black"/>
                        <circle cx="47" cy="26" r="2" fill="#ffb6c1"/>
                        <ellipse cx="18" cy="32" rx="5" ry="4" fill="#f5f5dc"/>
                        <ellipse cx="25" cy="35" rx="4" ry="3" fill="#f5f5dc"/>
                        <circle cx="14" cy="30" r="4" fill="#f5f5dc"/>
                    </svg>`,
                    frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <ellipse cx="30" cy="24" rx="14" ry="10" fill="#f5f5dc"/>
                        <circle cx="45" cy="18" r="8" fill="#f5f5dc"/>
                        <ellipse cx="40" cy="4" rx="3" ry="10" fill="#f5f5dc"/>
                        <ellipse cx="48" cy="6" rx="3" ry="9" fill="#f5f5dc"/>
                        <ellipse cx="40" cy="6" rx="2" ry="6" fill="#ffb6c1"/>
                        <ellipse cx="48" cy="8" rx="2" ry="5" fill="#ffb6c1"/>
                        <circle cx="50" cy="16" r="2" fill="black"/>
                        <circle cx="47" cy="22" r="2" fill="#ffb6c1"/>
                        <ellipse cx="20" cy="38" rx="5" ry="4" fill="#f5f5dc"/>
                        <ellipse cx="28" cy="40" rx="4" ry="3" fill="#f5f5dc"/>
                        <circle cx="14" cy="35" r="4" fill="#f5f5dc"/>
                    </svg>`
                },
                'turtle': { // ê±°ë¶ì´ - ëŠë¦¿ëŠë¦¿
                    frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <ellipse cx="30" cy="28" rx="18" ry="12" fill="#228B22"/>
                        <path d="M15,20 Q30,10 45,20" fill="#006400"/>
                        <ellipse cx="50" cy="28" rx="6" ry="5" fill="#8FBC8F"/>
                        <circle cx="54" cy="26" r="2" fill="black"/>
                        <ellipse cx="18" cy="36" rx="4" ry="3" fill="#8FBC8F"/>
                        <ellipse cx="42" cy="36" rx="4" ry="3" fill="#8FBC8F"/>
                        <ellipse cx="20" cy="24" rx="3" ry="2" fill="#8FBC8F"/>
                        <ellipse cx="40" cy="24" rx="3" ry="2" fill="#8FBC8F"/>
                        <circle cx="10" cy="30" r="3" fill="#8FBC8F"/>
                    </svg>`,
                    frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <ellipse cx="30" cy="28" rx="18" ry="12" fill="#228B22"/>
                        <path d="M15,20 Q30,10 45,20" fill="#006400"/>
                        <ellipse cx="52" cy="28" rx="6" ry="5" fill="#8FBC8F"/>
                        <circle cx="56" cy="26" r="2" fill="black"/>
                        <ellipse cx="16" cy="38" rx="4" ry="3" fill="#8FBC8F"/>
                        <ellipse cx="40" cy="38" rx="4" ry="3" fill="#8FBC8F"/>
                        <ellipse cx="22" cy="22" rx="3" ry="2" fill="#8FBC8F"/>
                        <ellipse cx="42" cy="22" rx="3" ry="2" fill="#8FBC8F"/>
                        <circle cx="8" cy="32" r="3" fill="#8FBC8F"/>
                    </svg>`
                },
                'eagle': { // ë…ìˆ˜ë¦¬ - ë‚ ê°œ í„ëŸ­ì„
                    frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <ellipse cx="30" cy="25" rx="12" ry="7" fill="#8B4513"/>
                        <circle cx="48" cy="22" r="7" fill="#8B4513"/>
                        <polygon points="55,22 63,20 63,24" fill="#FFD700"/>
                        <polygon points="55,22 63,22 58,25" fill="#DAA520"/>
                        <circle cx="52" cy="19" r="2" fill="black"/>
                        <path d="M22,25 Q5,8 28,18" fill="#654321"/>
                        <path d="M35,25 Q55,5 40,18" fill="#654321"/>
                        <polygon points="15,28 10,32 18,30" fill="#8B4513"/>
                    </svg>`,
                    frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <ellipse cx="30" cy="25" rx="12" ry="7" fill="#8B4513"/>
                        <circle cx="48" cy="22" r="7" fill="#8B4513"/>
                        <polygon points="55,22 63,20 63,24" fill="#FFD700"/>
                        <polygon points="55,22 63,22 58,25" fill="#DAA520"/>
                        <circle cx="52" cy="19" r="2" fill="black"/>
                        <path d="M22,25 Q5,38 28,32" fill="#654321"/>
                        <path d="M35,25 Q55,40 40,32" fill="#654321"/>
                        <polygon points="15,28 10,32 18,30" fill="#8B4513"/>
                    </svg>`
                },
                'scooter': { // í‚¥ë³´ë“œ - ë°”í€´ íšŒì „ (ì˜¤ë¥¸ìª½ ë°©í–¥)
                    frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <circle cx="12" cy="35" r="6" fill="#333"/>
                        <circle cx="48" cy="35" r="6" fill="#333"/>
                        <line x1="48" y1="35" x2="48" y2="15" stroke="#666" stroke-width="3"/>
                        <line x1="12" y1="35" x2="48" y2="35" stroke="#333" stroke-width="2"/>
                        <rect x="42" y="12" width="10" height="4" rx="2" fill="#666"/>
                        <circle cx="25" cy="20" r="5" fill="#3498db"/>
                        <line x1="25" y1="25" x2="25" y2="35" stroke="#333" stroke-width="2"/>
                        <line x1="25" y1="35" x2="22" y2="42" stroke="#333" stroke-width="2"/>
                        <line x1="25" y1="35" x2="28" y2="42" stroke="#333" stroke-width="2"/>
                    </svg>`,
                    frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <circle cx="12" cy="35" r="6" fill="#333"/>
                        <circle cx="48" cy="35" r="6" fill="#333"/>
                        <line x1="48" y1="35" x2="48" y2="15" stroke="#666" stroke-width="3"/>
                        <line x1="12" y1="35" x2="48" y2="35" stroke="#333" stroke-width="2"/>
                        <rect x="42" y="12" width="10" height="4" rx="2" fill="#666"/>
                        <circle cx="25" cy="20" r="5" fill="#3498db"/>
                        <line x1="25" y1="25" x2="25" y2="35" stroke="#333" stroke-width="2"/>
                        <line x1="25" y1="35" x2="28" y2="42" stroke="#333" stroke-width="2"/>
                        <line x1="25" y1="35" x2="22" y2="42" stroke="#333" stroke-width="2"/>
                    </svg>`
                },
                'helicopter': { // í—¬ë¦¬ì½¥í„° - í”„ë¡œí ëŸ¬ íšŒì „ (ì¢Œìš°ë°˜ì „)
                    frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <g transform="translate(60, 0) scale(-1, 1)">
                            <ellipse cx="30" cy="25" rx="18" ry="10" fill="#e74c3c"/>
                            <rect x="45" y="22" width="15" height="4" fill="#c0392b"/>
                            <polygon points="58,20 62,24 58,28" fill="#c0392b"/>
                            <circle cx="40" cy="22" r="5" fill="#87CEEB"/>
                            <line x1="30" y1="15" x2="30" y2="10" stroke="#333" stroke-width="2"/>
                            <line x1="15" y1="10" x2="45" y2="10" stroke="#333" stroke-width="2"/>
                            <line x1="25" y1="35" x2="25" y2="40" stroke="#333" stroke-width="2"/>
                            <line x1="35" y1="35" x2="35" y2="40" stroke="#333" stroke-width="2"/>
                            <line x1="20" y1="40" x2="40" y2="40" stroke="#333" stroke-width="2"/>
                        </g>
                    </svg>`,
                    frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <g transform="translate(60, 0) scale(-1, 1)">
                            <ellipse cx="30" cy="25" rx="18" ry="10" fill="#e74c3c"/>
                            <rect x="45" y="22" width="15" height="4" fill="#c0392b"/>
                            <polygon points="58,20 62,24 58,28" fill="#c0392b"/>
                            <circle cx="40" cy="22" r="5" fill="#87CEEB"/>
                            <line x1="30" y1="15" x2="30" y2="10" stroke="#333" stroke-width="2"/>
                            <line x1="20" y1="8" x2="40" y2="12" stroke="#333" stroke-width="2"/>
                            <line x1="25" y1="35" x2="25" y2="40" stroke="#333" stroke-width="2"/>
                            <line x1="35" y1="35" x2="35" y2="40" stroke="#333" stroke-width="2"/>
                            <line x1="20" y1="40" x2="40" y2="40" stroke="#333" stroke-width="2"/>
                        </g>
                    </svg>`
                },
                'horse': { // ë§ - ë‹¬ë¦¬ëŠ” ì• ë‹ˆë©”ì´ì…˜ (ë” ì •êµí•œ í˜•íƒœ)
                    frame1: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <!-- ë’·ë‹¤ë¦¬ (ì˜¤ë¥¸ìª½ ë’¤ - ë“¤ë¦¼) -->
                        <path d="M38,28 L40,32 L38,34 L36,34 Z" fill="#654321"/>
                        <ellipse cx="37" cy="34" rx="2" ry="2.5" fill="#2C1810"/>
                        <!-- ë’·ë‹¤ë¦¬ (ì™¼ìª½ ë’¤ - ë•…) -->
                        <path d="M32,28 L34,38 L32,40 L30,40 Z" fill="#654321"/>
                        <ellipse cx="31" cy="40" rx="2.5" ry="3" fill="#2C1810"/>
                        <!-- ëª¸í†µ -->
                        <ellipse cx="28" cy="26" rx="12" ry="7" fill="#8B4513"/>
                        <!-- ëª© -->
                        <path d="M16,26 Q20,18 24,20 Q26,22 28,26" fill="#8B4513"/>
                        <!-- ì•ë‹¤ë¦¬ (ì˜¤ë¥¸ìª½ ì• - ë•…) -->
                        <path d="M22,26 L20,38 L18,40 L22,40 Z" fill="#654321"/>
                        <ellipse cx="19" cy="40" rx="2.5" ry="3" fill="#2C1810"/>
                        <!-- ì•ë‹¤ë¦¬ (ì™¼ìª½ ì• - ë“¤ë¦¼) -->
                        <path d="M18,26 L16,32 L14,34 L18,34 Z" fill="#654321"/>
                        <ellipse cx="15" cy="34" rx="2" ry="2.5" fill="#2C1810"/>
                        <!-- ë¨¸ë¦¬ -->
                        <ellipse cx="46" cy="18" rx="8" ry="7" fill="#8B4513"/>
                        <ellipse cx="48" cy="16" rx="5" ry="4" fill="#A0522D"/>
                        <!-- ê·€ (ì™¼ìª½) -->
                        <path d="M40,12 Q42,6 44,10 Q42,8 40,12" fill="#654321" stroke="#2C1810" stroke-width="0.3"/>
                        <!-- ê·€ (ì˜¤ë¥¸ìª½) -->
                        <path d="M43,12 Q45,6 47,10 Q45,8 43,12" fill="#654321" stroke="#2C1810" stroke-width="0.3"/>
                        <!-- ëˆˆ -->
                        <circle cx="48" cy="17" r="1.8" fill="white"/>
                        <circle cx="48" cy="17" r="1.2" fill="black"/>
                        <!-- ì½” -->
                        <ellipse cx="53" cy="19" rx="2.5" ry="2" fill="#654321"/>
                        <ellipse cx="54" cy="19" rx="1" ry="0.8" fill="#2C1810"/>
                        <!-- ê°ˆê¸° (ë” í’ì„±í•˜ê²Œ) -->
                        <path d="M20,20 Q22,14 24,16 Q26,14 28,18 Q26,16 24,20" fill="#654321" stroke="#2C1810" stroke-width="0.4"/>
                        <path d="M22,18 Q24,12 26,14 Q28,12 30,16 Q28,14 26,18" fill="#654321" stroke="#2C1810" stroke-width="0.4"/>
                        <path d="M24,16 Q26,10 28,12 Q30,10 32,14 Q30,12 28,16" fill="#654321" stroke="#2C1810" stroke-width="0.4"/>
                        <!-- ê¼¬ë¦¬ (ë” ìì—°ìŠ¤ëŸ½ê²Œ) -->
                        <path d="M16,26 Q12,22 8,18 Q4,14 2,10" fill="#654321" stroke="#2C1810" stroke-width="0.5"/>
                        <path d="M14,24 Q10,20 6,16 Q2,12 0,8" fill="#654321" stroke="#2C1810" stroke-width="0.5"/>
                    </svg>`,
                    frame2: `<svg viewBox="0 0 60 45" width="60" height="45">
                        <!-- ë’·ë‹¤ë¦¬ (ì˜¤ë¥¸ìª½ ë’¤ - ë•…) -->
                        <path d="M38,28 L40,38 L38,40 L36,40 Z" fill="#654321"/>
                        <ellipse cx="37" cy="40" rx="2.5" ry="3" fill="#2C1810"/>
                        <!-- ë’·ë‹¤ë¦¬ (ì™¼ìª½ ë’¤ - ë“¤ë¦¼) -->
                        <path d="M32,28 L34,32 L32,34 L30,34 Z" fill="#654321"/>
                        <ellipse cx="31" cy="34" rx="2" ry="2.5" fill="#2C1810"/>
                        <!-- ëª¸í†µ -->
                        <ellipse cx="28" cy="24" rx="12" ry="7" fill="#8B4513"/>
                        <!-- ëª© -->
                        <path d="M16,24 Q20,16 24,18 Q26,20 28,24" fill="#8B4513"/>
                        <!-- ì•ë‹¤ë¦¬ (ì˜¤ë¥¸ìª½ ì• - ë“¤ë¦¼) -->
                        <path d="M22,24 L20,30 L18,32 L22,32 Z" fill="#654321"/>
                        <ellipse cx="19" cy="32" rx="2" ry="2.5" fill="#2C1810"/>
                        <!-- ì•ë‹¤ë¦¬ (ì™¼ìª½ ì• - ë•…) -->
                        <path d="M18,24 L16,38 L14,40 L18,40 Z" fill="#654321"/>
                        <ellipse cx="15" cy="40" rx="2.5" ry="3" fill="#2C1810"/>
                        <!-- ë¨¸ë¦¬ -->
                        <ellipse cx="46" cy="16" rx="8" ry="7" fill="#8B4513"/>
                        <ellipse cx="48" cy="14" rx="5" ry="4" fill="#A0522D"/>
                        <!-- ê·€ (ì™¼ìª½) -->
                        <path d="M40,10 Q42,4 44,8 Q42,6 40,10" fill="#654321" stroke="#2C1810" stroke-width="0.3"/>
                        <!-- ê·€ (ì˜¤ë¥¸ìª½) -->
                        <path d="M43,10 Q45,4 47,8 Q45,6 43,10" fill="#654321" stroke="#2C1810" stroke-width="0.3"/>
                        <!-- ëˆˆ -->
                        <circle cx="48" cy="15" r="1.8" fill="white"/>
                        <circle cx="48" cy="15" r="1.2" fill="black"/>
                        <!-- ì½” -->
                        <ellipse cx="53" cy="17" rx="2.5" ry="2" fill="#654321"/>
                        <ellipse cx="54" cy="17" rx="1" ry="0.8" fill="#2C1810"/>
                        <!-- ê°ˆê¸° (ë” í’ì„±í•˜ê²Œ) -->
                        <path d="M20,18 Q22,12 24,14 Q26,12 28,16 Q26,14 24,18" fill="#654321" stroke="#2C1810" stroke-width="0.4"/>
                        <path d="M22,16 Q24,10 26,12 Q28,10 30,14 Q28,12 26,16" fill="#654321" stroke="#2C1810" stroke-width="0.4"/>
                        <path d="M24,14 Q26,8 28,10 Q30,8 32,12 Q30,10 28,14" fill="#654321" stroke="#2C1810" stroke-width="0.4"/>
                        <!-- ê¼¬ë¦¬ (ë” ìì—°ìŠ¤ëŸ½ê²Œ) -->
                        <path d="M16,24 Q12,20 8,16 Q4,12 2,8" fill="#654321" stroke="#2C1810" stroke-width="0.5"/>
                        <path d="M14,22 Q10,18 6,14 Q2,10 0,6" fill="#654321" stroke="#2C1810" stroke-width="0.5"/>
                    </svg>`
                }
            };
            
            return svgMap[vehicleId] || svgMap['car'];
        }
        
        // íƒˆê²ƒë³„ ë°°ê²½ ìƒì„± í•¨ìˆ˜
        function getVehicleBackground(vehicleId) {
            // JSONì—ì„œ í…Œë§ˆ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const theme = vehicleThemes[vehicleId];
            
            if (theme) {
                // ë°°ê²½ ì´ë¯¸ì§€ ì‚¬ìš©
                return {
                    bg: `url('${theme.backgroundImage}')`,
                    bgSize: 'cover',
                    bgRepeat: 'no-repeat',
                    bgPosition: 'center',
                    textColor: getTextColorByTheme(theme.theme),
                    theme: theme.theme,
                    backgroundImage: theme.backgroundImage
                };
            }
            
            // í´ë°±: ê¸°ë³¸ê°’
            return {
                bg: 'linear-gradient(0deg, #333 0%, #333 30%, #555 30%, #555 70%, #87CEEB 70%, #87CEEB 100%)',
                textColor: '#fff',
                theme: 'expressway',
                backgroundImage: 'assets/backgrounds/expressway.png'
            };
        }
        
        // í…Œë§ˆì— ë”°ë¥¸ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ê²°ì •
        function getTextColorByTheme(theme) {
            const themeColors = {
                'forest': '#fff',
                'sky': '#333',
                'expressway': '#fff',
                'ocean': '#fff',
                'road': '#fff',
                'beach': '#333'
            };
            return themeColors[theme] || '#fff';
        }
        
        // ê²½ì£¼ ê²°ê³¼ í‘œì‹œ
        function showRaceResult(data) {
            isRaceActive = false;
            
            const winners = data.winners || [];
            const horseRankings = data.horseRankings || [];
            const gameMode = data.horseRaceMode || 'last';
            
            addDebugLog(`ê²½ì£¼ ê²°ê³¼: ë‹¹ì²¨ì ${winners.length}ëª… (${winners.join(', ')})`, 'race');
            
            // íƒˆê²ƒ ì •ë³´ ê°€ì ¸ì˜¤ê¸° í—¬í¼ í•¨ìˆ˜
            function getVehicleInfo(horseIndex) {
                const vehicleId = selectedVehicleTypes ? selectedVehicleTypes[horseIndex] : null;
                if (vehicleId && ALL_VEHICLES.length > 0) {
                    const vehicle = ALL_VEHICLES.find(v => v.id === vehicleId);
                    if (vehicle) return { ...vehicle, vehicleId };
                }
                // ê¸°ë³¸ê°’
                return { id: 'horse', name: 'ë§', emoji: 'ğŸ', vehicleId: 'horse' };
            }
            
            // í•´ë‹¹ ë§ì— ë² íŒ…í•œ ëª¨ë“  ì‚¬ìš©ì ì°¾ê¸°
            function getBettingUsers(horseIndex) {
                const users = [];
                Object.entries(userHorseBets).forEach(([userName, betHorse]) => {
                    if (betHorse === horseIndex) {
                        users.push(userName);
                    }
                });
                return users;
            }
            
            // SVG ê·¸ë¦¼ ê°€ì ¸ì˜¤ê¸° (í¬ê¸° ì¡°ì ˆ ê°€ëŠ¥)
            function getVehicleSVGForResult(vehicleId, size = 60) {
                const svgs = getVehicleSVG(vehicleId);
                // frame1 SVGì—ì„œ width/height ì¡°ì ˆ
                let svg = svgs.frame1;
                svg = svg.replace(/width="60"/g, `width="${size}"`);
                svg = svg.replace(/height="45"/g, `height="${Math.round(size * 0.75)}"`);
                return svg;
            }
            
            // ê²°ê³¼ ì˜¤ë²„ë ˆì´ í‘œì‹œ
            const rankingsDiv = document.getElementById('resultRankings');
            if (rankingsDiv) {
                let rankingsHtml = '<div style="font-size: 18px; font-weight: bold; margin-bottom: 20px; text-align: center;">ğŸ ìˆœìœ„ ë°œí‘œ ğŸ</div>';
                
                const lastIndex = horseRankings.length - 1;
                horseRankings.forEach((horseIndex, index) => {
                    const vehicle = getVehicleInfo(horseIndex);
                    const bettingUsers = getBettingUsers(horseIndex);
                    const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : '';
                    const rankNum = index + 1;
                    const isLast = index === lastIndex;
                    const usersHtml = bettingUsers.length > 0 ? bettingUsers.join(', ') : 'ë² íŒ… ì—†ìŒ';
                    const usersDisplay = isLast && bettingUsers.length > 0
                        ? bettingUsers.map(u => `<strong>${u}</strong>`).join(', ')
                        : usersHtml;
                    
                    if (index === 0) {
                        rankingsHtml += `
                            <div class="result-rank-1" style="background: linear-gradient(135deg, #ffd700 0%, #ffec8b 100%); padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(255,215,0,0.4);">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                                    <span style="font-size: 28px;">${medal}</span>
                                    <span style="font-size: 26px; font-weight: bold; color: #8b4513;">${rankNum}ë“±</span>
                                    <div style="transform: scale(1.3); margin: 0 5px;">${getVehicleSVGForResult(vehicle.vehicleId || vehicle.id, 60)}</div>
                                    <span style="font-size: 22px; font-weight: bold; color: #8b4513;">${vehicle.name}</span>
                                </div>
                                <div style="font-size: 20px; color: #5a3d1e; text-align: center; margin-top: 12px; font-weight: 600;">
                                    ${usersDisplay}
                                </div>
                            </div>
                        `;
                    } else if (index === 1) {
                        rankingsHtml += `
                            <div class="result-rank-2" style="background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%); padding: 12px; border-radius: 10px; margin-bottom: 10px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 22px;">${medal}</span>
                                    <span style="font-size: 18px; font-weight: bold; color: #4a4a4a;">${rankNum}ë“±</span>
                                    <div style="transform: scale(0.9);">${getVehicleSVGForResult(vehicle.vehicleId || vehicle.id, 50)}</div>
                                    <span style="font-size: 16px; font-weight: bold; color: #4a4a4a;">${vehicle.name}</span>
                                </div>
                                <div style="font-size: 14px; color: #666; margin-top: 5px; padding-left: 15px;">
                                    - ${usersDisplay}
                                </div>
                            </div>
                        `;
                    } else if (index === 2) {
                        rankingsHtml += `
                            <div class="result-rank-3" style="background: linear-gradient(135deg, #cd7f32 0%, #daa06d 100%); padding: 12px; border-radius: 10px; margin-bottom: 10px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 22px;">${medal}</span>
                                    <span style="font-size: 18px; font-weight: bold; color: #4a3728;">${rankNum}ë“±</span>
                                    <div style="transform: scale(0.9);">${getVehicleSVGForResult(vehicle.vehicleId || vehicle.id, 50)}</div>
                                    <span style="font-size: 16px; font-weight: bold; color: #4a3728;">${vehicle.name}</span>
                                </div>
                                <div style="font-size: 14px; color: #5a4a3a; margin-top: 5px; padding-left: 15px;">
                                    - ${usersDisplay}
                                </div>
                            </div>
                        `;
                    } else {
                        rankingsHtml += `
                            <div style="background: #f5f5f5; padding: 6px 8px; border-radius: 6px; margin-bottom: 4px;">
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <span style="font-size: 14px; font-weight: bold; color: #666;">${rankNum}ë“±</span>
                                    <div style="transform: scale(0.65);">${getVehicleSVGForResult(vehicle.vehicleId || vehicle.id, 45)}</div>
                                    <span style="font-size: 13px; font-weight: bold; color: #666;">${vehicle.name}</span>
                                </div>
                                <div style="font-size: 12px; color: #888; margin-top: 2px; padding-left: 12px;">
                                    - ${usersDisplay}
                                </div>
                            </div>
                        `;
                    }
                });
                
                rankingsDiv.innerHTML = rankingsHtml;
            }
            
            // ë‹¹ì²¨ì í‘œì‹œ
            const winnerDiv = document.getElementById('resultWinner');
            const messageDiv = document.getElementById('resultMessage');
            
            if (winnerDiv) {
                const modeText = 'ê¼´ë“±'; // ë¬´ì¡°ê±´ ê¼´ë“± ì°¾ê¸°
                if (winners.length === 0) {
                    // ë‹¹ì²¨ìê°€ ì—†ì„ ë•Œ: ë² íŒ…í•œ ì‚¬ëŒë“¤ ì¤‘ ê°€ì¥ ë†’ì€ ìˆœìœ„ ì°¾ê¸°
                    let bestRank = -1;
                    let bestBetters = [];
                    let bestHorseIndex = -1;
                    
                    // userHorseBetsì—ì„œ ê° ë² íŒ…ìì˜ ìˆœìœ„ í™•ì¸
                    if (userHorseBets && horseRankings.length > 0) {
                        Object.entries(userHorseBets).forEach(([username, horseIndex]) => {
                            const rank = horseRankings.indexOf(horseIndex);
                            if (rank !== -1) {
                                if (bestRank === -1 || rank < bestRank) {
                                    bestRank = rank;
                                    bestBetters = [username];
                                    bestHorseIndex = horseIndex;
                                } else if (rank === bestRank) {
                                    bestBetters.push(username);
                                }
                            }
                        });
                    }
                    
                    if (bestBetters.length > 0 && bestRank >= 0) {
                        const vehicleInfo = getVehicleInfo(bestHorseIndex);
                        const rankText = bestRank + 1;
                        winnerDiv.innerHTML = `ğŸ… ${bestBetters.join(', ')} ğŸ…`;
                        if (messageDiv) {
                            messageDiv.textContent = `${rankText}ë“± ${vehicleInfo.name}ì— ë² íŒ…! ê°€ì¥ ë†’ì€ ìˆœìœ„!`;
                        }
                    } else {
                        winnerDiv.textContent = 'ë² íŒ…ì ì—†ìŒ';
                        if (messageDiv) {
                            messageDiv.textContent = 'ì•„ë¬´ë„ ë² íŒ…í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
                        }
                    }
                } else if (winners.length === 1) {
                    winnerDiv.textContent = `ğŸŠ ${winners[0]} ğŸŠ`;
                    if (messageDiv) {
                        messageDiv.textContent = '';
                    }
                } else {
                    winnerDiv.textContent = winners.join(', ');
                    if (messageDiv) {
                        messageDiv.textContent = 'ë™ì ! ì¬ê²½ì£¼ë¥¼ ì§„í–‰í•´ì•¼ í•©ë‹ˆë‹¤.';
                    }
                }
            }
            
            // ìˆœìœ„ ì´í™íŠ¸ ìˆ¨ê¸°ê¸°
            if (finishEffectsOverlay) {
                finishEffectsOverlay.style.display = 'none';
            }
            
            document.getElementById('resultOverlay').classList.add('visible');
            
            // ê²Œì„ ìƒíƒœ ì—…ë°ì´íŠ¸
            const gameStatus = document.getElementById('gameStatus');
            if (gameStatus) {
                gameStatus.textContent = 'ê²½ì£¼ ì¢…ë£Œ!';
                gameStatus.style.background = '#e9ecef';
                gameStatus.style.color = '#495057';
            }
            
            // í˜¸ìŠ¤íŠ¸ì—ê²Œ ì¢…ë£Œ ë²„íŠ¼ í‘œì‹œ
            if (isHost) {
                document.getElementById('endGameSection').style.display = 'block';
                
                // ë™ì ì¼ ë•Œë§Œ ì¬ê²½ì£¼ ì¤€ë¹„ ë²„íŠ¼ í‘œì‹œ
                if (winners.length >= 2) {
                    const endSection = document.getElementById('endGameSection');
                    endSection.innerHTML = `
                        <button class="end-button" onclick="requestReraceReady()" style="background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%); margin-bottom: 10px;">ğŸ”„ ì¬ê²½ì£¼ ì¤€ë¹„</button>
                        <button class="end-button" onclick="endHorseRaceGame()">ğŸ ê²Œì„ ì¢…ë£Œ</button>
                    `;
                } else {
                    const endSection = document.getElementById('endGameSection');
                    endSection.innerHTML = `
                        <button class="end-button" onclick="endHorseRaceGame()">ğŸ ê²Œì„ ì¢…ë£Œ</button>
                    `;
                }
            }
            
            // ê²½ì£¼ íŠ¸ë™ì€ ìœ ì§€ (ê²Œì„ ì¢…ë£Œ ì‹œê¹Œì§€)
        }
        
        // ì¬ê²½ì£¼ ì¤€ë¹„ ìš”ì²­
        function requestReraceReady() {
            addDebugLog('ì¬ê²½ì£¼ ì¤€ë¹„ ìš”ì²­', 'rerace');
            socket.emit('requestReraceReady');
        }
        
        // 3-2-1 ì¹´ìš´íŠ¸ë‹¤ìš´ í‘œì‹œ (ê²½ë§ˆë§µ ì˜ì—­ ì•ˆì—)
        function showCountdown() {
            // ë ˆì´ìŠ¤ íŠ¸ë™ ì»¨í…Œì´ë„ˆ í‘œì‹œ
            const trackContainer = document.getElementById('raceTrackContainer');
            if (trackContainer) {
                trackContainer.style.display = 'block';
            }

            // ê¸°ì¡´ ì˜¤ë²„ë ˆì´ ì œê±°
            const existing = document.getElementById('countdownOverlay');
            if (existing) existing.remove();

            const overlay = document.createElement('div');
            overlay.id = 'countdownOverlay';
            overlay.style.cssText = `
                position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.75); z-index: 100;
                display: flex; justify-content: center; align-items: center;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            `;

            // raceTrackContainerì— relative ì„¤ì • í›„ ë‚´ë¶€ì— ì˜¤ë²„ë ˆì´ ì¶”ê°€
            if (trackContainer) {
                trackContainer.style.position = 'relative';
                trackContainer.appendChild(overlay);
            } else {
                document.body.appendChild(overlay);
            }

            const nums = ['3', '2', '1', 'START!'];
            const colors = ['#e74c3c', '#f39c12', '#2ecc71', '#3498db'];
            let idx = 0;

            function showNext() {
                if (idx >= nums.length) {
                    overlay.remove();
                    return;
                }
                overlay.innerHTML = `<div style="
                    font-size: ${nums[idx] === 'START!' ? '60px' : '90px'};
                    font-weight: 900; color: ${colors[idx]};
                    text-shadow: 0 0 30px ${colors[idx]}, 0 0 60px ${colors[idx]}40;
                    animation: countPop 0.8s ease-out;
                ">${nums[idx]}</div>`;
                idx++;
                setTimeout(showNext, 1000);
            }
            showNext();
        }

        // ì¬ê²½ì£¼ ì‹œì‘ ìš”ì²­
        function startRerace() {
            addDebugLog('ì¬ê²½ì£¼ ì‹œì‘ ìš”ì²­', 'rerace');
            socket.emit('startRerace');
        }
        
        // ì¬ê²½ì£¼ ë²„íŠ¼ ì—…ë°ì´íŠ¸ (í˜¸ìŠ¤íŠ¸ ì „ìš©)
        function updateReraceButton() {
            if (!isHost) return;
            
            if (!isReraceActive) return;
            
            // ëª¨ë“  ì¬ê²½ì£¼ ëŒ€ìƒìê°€ íƒˆê²ƒì„ ì„ íƒí–ˆëŠ”ì§€ í™•ì¸
            const allSelected = currentRoundPlayers.every(player => userHorseBets[player] !== undefined);
            const selectedCount = currentRoundPlayers.filter(p => userHorseBets[p] !== undefined).length;
            
            addDebugLog(`ì¬ê²½ì£¼ ë²„íŠ¼ ì—…ë°ì´íŠ¸: ${selectedCount}/${currentRoundPlayers.length}ëª… ì„ íƒ, ëª¨ë‘ ì„ íƒ: ${allSelected}`, 'rerace');
            
            // í˜¸ìŠ¤íŠ¸ ì»¨íŠ¸ë¡¤ ì„¹ì…˜ì— ì¬ê²½ì£¼ ë²„íŠ¼ í‘œì‹œ
            const hostControls = document.getElementById('hostControls');
            if (hostControls) {
                const startButton = document.getElementById('startHorseRaceButton');
                if (startButton) {
                    if (allSelected) {
                        startButton.textContent = 'ğŸ”„ ì¬ê²½ì£¼';
                        startButton.disabled = false;
                        startButton.onclick = startRerace;
                    } else {
                        startButton.textContent = `ğŸ”„ ì¬ê²½ì£¼ (${selectedCount}/${currentRoundPlayers.length}ëª… ì„ íƒ)`;
                        startButton.disabled = true;
                        startButton.onclick = null;
                    }
                }
            }
        }

        // ì‚¬ìš©ì ëª©ë¡ ë Œë”ë§
        function updateUsers(users) {
            currentUsers = users;
            const usersList = document.getElementById('usersList');
            const usersCount = document.getElementById('usersCount');

            if (!usersList || !usersCount) return;

            usersCount.textContent = users.length;
            usersList.innerHTML = '';

            // ë“œë˜ê·¸ íŒíŠ¸ í‘œì‹œ
            const dragHint = document.getElementById('dragHint');
            if (dragHint) {
                dragHint.style.display = (isHost && !isRaceActive) ? 'inline' : 'none';
            }

            users.forEach(user => {
                const tag = document.createElement('span');
                tag.className = 'user-tag';
                if (user.isHost) {
                    tag.classList.add('host');
                }

                let content = user.name;
                if (user.isHost) {
                    content += ' ğŸ‘‘';
                }
                if (user.name === currentUser) {
                    content += ' (ë‚˜)';
                }
                tag.textContent = content;

                // í˜¸ìŠ¤íŠ¸ê°€ ë‹¤ë¥¸ ì‚¬ìš©ìë¥¼ í´ë¦­í•˜ë©´ ì•¡ì…˜ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
                if (isHost && user.name !== currentUser) {
                    tag.style.cursor = 'pointer';
                    tag.title = 'í´ë¦­í•˜ì—¬ í˜¸ìŠ¤íŠ¸ì„ëª… ë˜ëŠ” ì œì™¸';
                    tag.addEventListener('click', () => {
                        showPlayerActionDialog(user.name).then(action => {
                            if (action === 'host') {
                                socket.emit('transferHost', user.name);
                            } else if (action === 'kick') {
                                showConfirmDialog(`${user.name}ë‹˜ì„ ê²Œì„ì—ì„œ ì œì™¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, () => {
                                    socket.emit('kickPlayer', user.name);
                                });
                            }
                        });
                    });
                }

                // í˜¸ìŠ¤íŠ¸ë§Œ ë“œë˜ê·¸ ê°€ëŠ¥ (ê²Œì„ ë¹„í™œì„± ì‹œ)
                if (isHost && !isRaceActive) {
                    tag.draggable = true;
                    tag.style.cursor = 'grab';
                    tag.setAttribute('data-user-name', user.name);

                    tag.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', user.name);
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('source', 'users');
                        tag.style.opacity = '0.5';
                    });

                    tag.addEventListener('dragend', (e) => {
                        tag.style.opacity = '1';
                    });
                } else {
                    tag.draggable = false;
                    tag.style.cursor = 'default';
                }

                usersList.appendChild(tag);
            });
        }

        // ê²Œì„ ê¸°ë¡ ë Œë”ë§
        function renderHistory() {
            const historyList = document.getElementById('historyList');
            if (!historyList) return;
            
            if (horseRaceHistory.length === 0) {
                historyList.innerHTML = '<div style="color: #999; text-align: center;">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }
            
            historyList.innerHTML = '';
            
            // íƒˆê²ƒ ì •ë³´ ê°€ì ¸ì˜¤ê¸° í—¬í¼ í•¨ìˆ˜
            function getVehicleInfoForHistory(vehicleId) {
                if (vehicleId && ALL_VEHICLES.length > 0) {
                    const vehicle = ALL_VEHICLES.find(v => v.id === vehicleId);
                    if (vehicle) return vehicle;
                }
                return { id: 'horse', name: 'ë§', emoji: 'ğŸ' };
            }
            
            // SVG ê°€ì ¸ì˜¤ê¸° (ì‘ì€ í¬ê¸°)
            function getSmallVehicleSVG(vehicleId) {
                const svgs = getVehicleSVG(vehicleId);
                let svg = svgs.frame1;
                svg = svg.replace(/width="60"/g, 'width="30"');
                svg = svg.replace(/height="45"/g, 'height="22"');
                return svg;
            }
            
            // í•´ë‹¹ ë§ì— ë² íŒ…í•œ ëª¨ë“  ì‚¬ìš©ì ì°¾ê¸°
            function getBettingUsersFromRecord(record, horseIndex) {
                const users = [];
                if (record.userHorseBets) {
                    Object.entries(record.userHorseBets).forEach(([userName, betHorse]) => {
                        if (betHorse === horseIndex) {
                            users.push(userName);
                        }
                    });
                }
                return users;
            }
            
            horseRaceHistory.slice().reverse().forEach((record, idx) => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.style.cssText = 'background: #fff9f0; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #f0e0c0;';
                
                // ì‹œê°„ í¬ë§·
                const time = record.timestamp ? new Date(record.timestamp).toLocaleString('ko-KR', { 
                    month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' 
                }) : '';
                
                // ìˆœìœ„ë³„ ê²°ê³¼ ìƒì„±
                let rankingsHtml = '';
                if (record.rankings && record.rankings.length > 0) {
                    record.rankings.slice(0, 3).forEach((horseIndex, rank) => {
                        const vehicleId = record.selectedVehicleTypes ? record.selectedVehicleTypes[horseIndex] : 'horse';
                        const vehicle = getVehicleInfoForHistory(vehicleId);
                        const bettingUsers = getBettingUsersFromRecord(record, horseIndex);
                        const medal = rank === 0 ? 'ğŸ¥‡' : rank === 1 ? 'ğŸ¥ˆ' : 'ğŸ¥‰';
                        const bgColor = rank === 0 ? '#fff8dc' : rank === 1 ? '#f5f5f5' : '#faebd7';
                        
                        rankingsHtml += `
                            <div style="display: flex; align-items: center; gap: 6px; padding: 4px 8px; background: ${bgColor}; border-radius: 4px; margin-bottom: 4px;">
                                <span style="font-size: 14px;">${medal}</span>
                                <span style="font-size: 12px; font-weight: bold;">${rank + 1}ë“±</span>
                                <div style="transform: scale(0.6); margin: -5px;">${getSmallVehicleSVG(vehicleId)}</div>
                                <span style="font-size: 11px; color: #666;">${vehicle.name}</span>
                                <span style="font-size: 11px; color: #8b4513; margin-left: auto;">${bettingUsers.length > 0 ? bettingUsers.join(', ') : '-'}</span>
                            </div>
                        `;
                    });
                }
                
                // ìµœì¢… ë‹¹ì²¨ì ë˜ëŠ” ê°€ì¥ ë†’ì€ ìˆœìœ„ ë² íŒ…ì
                let winnersText = '';
                if (record.winners && record.winners.length > 0) {
                    winnersText = `ğŸŠ ë‹¹ì²¨: ${record.winners.join(', ')}`;
                } else if (record.userHorseBets && record.rankings && record.rankings.length > 0) {
                    // ë‹¹ì²¨ì ì—†ì„ ë•Œ: ê°€ì¥ ë†’ì€ ìˆœìœ„ ë² íŒ…ì ì°¾ê¸°
                    let bestRank = -1;
                    let bestBetters = [];
                    Object.entries(record.userHorseBets).forEach(([username, horseIndex]) => {
                        const rank = record.rankings.indexOf(horseIndex);
                        if (rank !== -1) {
                            if (bestRank === -1 || rank < bestRank) {
                                bestRank = rank;
                                bestBetters = [username];
                            } else if (rank === bestRank) {
                                bestBetters.push(username);
                            }
                        }
                    });
                    if (bestBetters.length > 0 && bestRank >= 0) {
                        winnersText = `ğŸ… ${bestRank + 1}ë“± ìˆœìœ„: ${bestBetters.join(', ')}`;
                    }
                }
                
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="font-weight: bold; color: #8b4513; font-size: 14px;">${record.round}ë¼ìš´ë“œ</div>
                        <div style="font-size: 11px; color: #999;">${time}</div>
                    </div>
                    <div style="margin-bottom: 8px;">
                        ${rankingsHtml}
                    </div>
                    ${winnersText ? `<div style="font-size: 13px; color: #d4a574; font-weight: bold; text-align: center; padding: 5px; background: #fff5e6; border-radius: 4px;">${winnersText}</div>` : ''}
                    <button onclick="playReplay(${record.id})" style="width: 100%; margin-top: 8px; padding: 8px; font-size: 12px; background: linear-gradient(135deg, #8b4513 0%, #d2691e 100%); color: white; border: none; border-radius: 6px; cursor: pointer;">
                        ğŸ¬ ë‹¤ì‹œë³´ê¸°
                    </button>
                `;
                historyList.appendChild(item);
            });
        }
        
        // ë‹¤ì‹œë³´ê¸° ê¸°ëŠ¥
        function playReplay(recordId) {
            const record = horseRaceHistory.find(r => r.id === recordId);
            if (!record) {
                alert('ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ë‹¤ì‹œë³´ê¸°ìš© ë°ì´í„° ì„¤ì •
            const replayData = {
                rankings: record.rankings,
                userHorseBets: record.userHorseBets,
                selectedVehicleTypes: record.selectedVehicleTypes,
                availableHorses: record.availableHorses || record.rankings.map((_, i) => i),
                isReplay: true,
                replayRound: record.round
            };
            
            // íŠ¸ë™ í‘œì‹œ ë° ì• ë‹ˆë©”ì´ì…˜ ì¬ìƒ
            addDebugLog(`ë‹¤ì‹œë³´ê¸° ì‹œì‘: ${record.round}ë¼ìš´ë“œ`, 'replay');
            
            // ë§ ì„ íƒ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            const horseSelectionSection = document.getElementById('horseSelectionSection');
            if (horseSelectionSection) {
                horseSelectionSection.classList.remove('active');
            }
            
            // ê²°ê³¼ ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
            const resultOverlay = document.getElementById('resultOverlay');
            if (resultOverlay) {
                resultOverlay.classList.remove('visible');
            }
            
            // ë‹¤ì‹œë³´ê¸°ìš© selectedVehicleTypes ì„ì‹œ ì„¤ì •
            const originalSelectedVehicleTypes = selectedVehicleTypes;
            const originalUserHorseBets = userHorseBets;
            const originalAvailableHorses = availableHorses;
            
            selectedVehicleTypes = record.selectedVehicleTypes;
            userHorseBets = record.userHorseBets;
            availableHorses = record.availableHorses || record.rankings.map((_, i) => i);
            
            // ê²½ì£¼ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
            isRaceActive = true;
            
            // ì €ì¥ëœ ì†ë„ ë°ì´í„° ì‚¬ìš© (ì—†ìœ¼ë©´ ìˆœìœ„ ê¸°ë°˜ ìƒì„±)
            let replaySpeeds;
            if (record.speeds && Array.isArray(record.speeds)) {
                replaySpeeds = record.speeds;
            } else {
                // ìˆœìœ„ ê¸°ë°˜ ì†ë„ ìƒì„± (ë™ì¼í•œ ì‹œë“œ ê¸°ë°˜)
                replaySpeeds = record.rankings.map((horseIndex, rank) => {
                    const seedValue = (record.id + horseIndex) * 9301 + 49297;
                    const pseudoRandom = ((seedValue % 233280) / 233280);
                    return 3000 + rank * 500 + pseudoRandom * 200;
                });
            }
            
            // ì €ì¥ëœ ê¸°ë¯¹ ë°ì´í„° ì‚¬ìš© (ì„œë²„ì™€ ë™ì¼í•œ ê²½ì£¼ ì¬í˜„)
            const replayGimmicks = record.gimmicks || null;
            
            // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ - ì½œë°±ìœ¼ë¡œ ì¢…ë£Œ ì²˜ë¦¬
            startRaceAnimation(record.rankings, replaySpeeds, replayGimmicks, (actualFinishOrder) => {
                isRaceActive = false;
                
                // ë‹¤ì‹œë³´ê¸° ê²°ê³¼ í‘œì‹œ (ì‹¤ì œ ë„ì°© ìˆœì„œ ì‚¬ìš©)
                showRaceResult({
                    winners: record.winners,
                    horseRankings: actualFinishOrder || record.rankings,
                    horseRaceMode: record.mode
                });
                
                // ì›ë˜ ìƒíƒœ ë³µì›
                setTimeout(() => {
                    selectedVehicleTypes = originalSelectedVehicleTypes;
                    userHorseBets = originalUserHorseBets;
                    availableHorses = originalAvailableHorses;
                }, 100);
            });
        }

        // ì±„íŒ… ëª¨ë“ˆ ì´ˆê¸°í™” (roomCreated/roomJoined í›„ í˜¸ì¶œ)
        let chatModuleInitialized = false;
        function initChatModule() {
            if (chatModuleInitialized) return;
            chatModuleInitialized = true;
            ChatModule.init(socket, currentUser, {
                systemGradient: 'linear-gradient(135deg, #8b4513 0%, #d2691e 100%)',
                themeColor: '#333',
                myColor: '#8b4513',
                myBgColor: '#fff5e6',
                myBorderColor: '#ffc107'
            });
        }

        // ê¸€ë¡œë²Œ í•¨ìˆ˜ (HTML onclickì—ì„œ í˜¸ì¶œ)
        function sendMessage() { ChatModule.sendMessage(); }
        function handleChatKeypress(event) { ChatModule.handleChatKeypress(event); }

        let readyModuleInitialized = false;
        function initReadyModule() {
            if (readyModuleInitialized) return;
            readyModuleInitialized = true;
            ReadyModule.init(socket, currentUser, {
                isHost: isHost,
                isGameActive: () => isRaceActive,
                onReadyChanged: (users) => {
                    readyUsers = users;
                },
                onRenderComplete: (users) => {
                    updateStartButton();
                },
                onError: (message) => alert(message),
                readyStyle: { background: 'linear-gradient(135deg, #8b4513 0%, #a0522d 100%)', color: '#fff' },
                readyCancelStyle: { background: 'linear-gradient(135deg, #a0522d 0%, #8b4513 100%)', color: '#fff' }
            });
        }

        function initOrderModule() {
            OrderModule.init(socket, currentUser, {
                isHost: () => isHost,
                isGameActive: () => isRaceActive,
                getEverPlayedUsers: () => everPlayedUsers,
                getUsersList: () => currentUsers,
                showCustomAlert: (msg, type) => showCustomAlert ? showCustomAlert(msg, type) : alert(msg),
                onOrderStarted: () => { isOrderActive = true; },
                onOrderEnded: () => { isOrderActive = false; },
                onOrdersUpdated: (data) => { ordersData = data; },
            });
        }

        function addChatMessage(data) { ChatModule.displayChatMessage(data); }
        function toggleReaction(messageIndex, emoji) {
            socket.emit('toggleReaction', { messageIndex, emoji });
        }

        // ê²°ê³¼ ì˜¤ë²„ë ˆì´ ë‹«ê¸° (ë¹„ì„ì€ ë‹¤ìŒ ê²½ì£¼ ì‹œì‘ ì „ê¹Œì§€ ìœ ì§€)
        function closeResultOverlay() {
            document.getElementById('resultOverlay').classList.remove('visible');
            // ìˆœìœ„ ì´í™íŠ¸ëŠ” ì œê±°í•˜ì§€ ì•ŠìŒ â†’ ë¹„ì„ì´ ë‚¨ìŒ. ìƒˆ ê²½ì£¼ ì‹œì‘ ì‹œ clearFinishEffects()ë¡œ ì •ë¦¬ë¨
        }

        // ë°© í­íŒŒ ì¹´ìš´íŠ¸ë‹¤ìš´
        function startRoomExpiryCountdown(createdAt, expiryHours) {
            if (roomExpiryInterval) {
                clearInterval(roomExpiryInterval);
            }
            
            const expirySection = document.getElementById('roomExpirySection');
            const countdownElement = document.getElementById('roomExpiryCountdown');
            
            if (!expirySection || !countdownElement) return;
            
            expirySection.style.display = 'block';
            
            function updateCountdown() {
                const now = new Date();
                const createdAtDate = new Date(createdAt);
                const expiryTime = createdAtDate.getTime() + (expiryHours * 60 * 60 * 1000);
                const remaining = expiryTime - now.getTime();
                
                if (remaining <= 0) {
                    countdownElement.textContent = '00:00:00';
                    if (roomExpiryInterval) {
                        clearInterval(roomExpiryInterval);
                    }
                    return;
                }
                
                const hours = Math.floor(remaining / (1000 * 60 * 60));
                const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
                
                countdownElement.textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
            
            updateCountdown();
            roomExpiryInterval = setInterval(updateCountdown, 1000);
        }

        // ê²Œì„ í™”ë©´ ì´ˆê¸°í™”
        function initializeGameScreen(data) {
            document.getElementById('roomTitle').textContent = data.roomName || 'ê²½ë§ˆ ë°©';
            
            if (data.createdAt && data.expiryHours) {
                startRoomExpiryCountdown(data.createdAt, data.expiryHours);
            }
            
            // ì‚¬ìš©ì ëª©ë¡ ì´ˆê¸°í™”
            if (data.gameState && data.gameState.users) {
                currentUsers = data.gameState.users;
            }
            
            // ëˆ„ì  ì°¸ì—¬ì ëª©ë¡ ë³µì›
            if (data.everPlayedUsers && Array.isArray(data.everPlayedUsers)) {
                everPlayedUsers = [...data.everPlayedUsers];
            } else if (data.gameState && data.gameState.everPlayedUsers && Array.isArray(data.gameState.everPlayedUsers)) {
                everPlayedUsers = [...data.gameState.everPlayedUsers];
            } else {
                everPlayedUsers = [];
            }
            
            // ì£¼ë¬¸ë°›ê¸° ìƒíƒœ ì´ˆê¸°í™”
            isOrderActive = (data.gameState && data.gameState.isOrderActive) || false;
            OrderModule.setIsOrderActive(isOrderActive);
            ordersData = (data.gameState && data.gameState.userOrders) || {};
            OrderModule.setOrdersData(ordersData);

            // í˜¸ìŠ¤íŠ¸ UI ì„¤ì •
            if (isHost) {
                document.getElementById('hostBadge').style.display = 'inline-block';
                document.getElementById('hostControls').style.display = 'block';

                // ì£¼ë¬¸ë°›ê¸° ë²„íŠ¼ ìƒíƒœ
                if (isOrderActive) {
                    document.getElementById('startOrderButton').style.display = 'none';
                    document.getElementById('endOrderButton').style.display = 'block';
                } else {
                    document.getElementById('startOrderButton').style.display = 'block';
                    document.getElementById('endOrderButton').style.display = 'none';
                }
            } else {
                document.getElementById('hostBadge').style.display = 'none';
                document.getElementById('hostControls').style.display = 'none';
            }

            // ì£¼ë¬¸ë°›ê¸° ìƒíƒœ ë°˜ì˜ (CSS: .orders-section { display:none }, .orders-section.active { display:block })
            if (isOrderActive) {
                document.getElementById('ordersSection').classList.add('active');
                document.getElementById('myOrderInput').disabled = false;
                document.getElementById('orderSaveButton').disabled = false;

                if (isHost) {
                    document.getElementById('startOrderButton').style.display = 'none';
                    document.getElementById('endOrderButton').style.display = 'block';
                }

                OrderModule.renderOrders();
                OrderModule.renderNotOrderedUsers();
            } else {
                document.getElementById('ordersSection').classList.remove('active');
                document.getElementById('myOrderInput').disabled = true;
                document.getElementById('orderSaveButton').disabled = true;

                if (!isRaceActive) {
                    document.getElementById('gameStatus').textContent = 'ëŒ€ê¸° ì¤‘...';
                    document.getElementById('gameStatus').classList.remove('ordering');
                    document.getElementById('gameStatus').classList.add('waiting');
                }

                if (isHost && !isRaceActive) {
                    const startOrderBtn = document.getElementById('startOrderButton');
                    const endOrderBtn = document.getElementById('endOrderButton');
                    if (startOrderBtn) startOrderBtn.style.display = 'block';
                    if (endOrderBtn) endOrderBtn.style.display = 'none';
                } else if (isHost) {
                    const startOrderBtn = document.getElementById('startOrderButton');
                    const endOrderBtn = document.getElementById('endOrderButton');
                    if (startOrderBtn) startOrderBtn.style.display = 'none';
                    if (endOrderBtn) endOrderBtn.style.display = 'none';
                }

                OrderModule.renderOrders();
                OrderModule.renderNotOrderedUsers();
            }
            
            // ê¸°ë¡ ì„¹ì…˜ í‘œì‹œ
            document.getElementById('historySection').classList.add('visible');
            
            // ì±„íŒ… ê¸°ë¡ ë¡œë“œ
            if (data.chatHistory) {
                document.getElementById('chatMessages').innerHTML = '';
                data.chatHistory.forEach(msg => addChatMessage(msg));
            }
            
            // ê²½ë§ˆ ê¸°ë¡ ë¡œë“œ
            if (data.gameState && data.gameState.horseRaceHistory) {
                horseRaceHistory = data.gameState.horseRaceHistory;
                renderHistory();
            }
            
            // ì¤€ë¹„ ìƒíƒœ ë³µì›
            if (data.readyUsers) {
                readyUsers = data.readyUsers;
                isReady = readyUsers.includes(currentUser);
                ReadyModule.setReadyUsers(readyUsers);
            }
            
            // ê²½ë§ˆ ê²Œì„ ìƒíƒœ ë³µì› ë° ë§ ì„ íƒ UI í‘œì‹œ
            if (data.gameType === 'horse-race' || (data.gameState && data.gameState.availableHorses)) {
                const gameState = data.gameState || {};
                
                // ë§ ì„ íƒ UIê°€ ì´ë¯¸ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ìœ ì§€, ì—†ìœ¼ë©´ í™œì„±í™”
                if (gameState.availableHorses && gameState.availableHorses.length > 0 && !gameState.isHorseRaceActive) {
                    availableHorses = gameState.availableHorses;
                    userHorseBets = gameState.userHorseBets || {};
                    horseRaceMode = gameState.horseRaceMode || 'last';
                    currentRoundPlayers = gameState.currentRoundPlayers || gameState.users?.map(u => u.name) || [];
                    raceRound = gameState.raceRound || 1;
                    
                    mySelectedHorse = userHorseBets[currentUser] !== undefined ? userHorseBets[currentUser] : null;
                    
                    // ë§ ì„ íƒ ì„¹ì…˜ í‘œì‹œ
                    const horseSelectionSection = document.getElementById('horseSelectionSection');
                    if (horseSelectionSection) {
                        horseSelectionSection.classList.add('active');
                        renderHorseSelection();
                    }
                }
            }
        }

        // === ì†Œì¼“ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ===
        
        socket.on('connect', () => {
            document.getElementById('connectionStatus').textContent = 'â— ì—°ê²°ë¨';
            document.getElementById('connectionStatus').className = 'connection-status connected';
            
            const createRoomStatus = document.getElementById('createRoomConnectionStatus');
            if (createRoomStatus) {
                createRoomStatus.textContent = 'â— ì—°ê²°ë¨';
                createRoomStatus.className = 'connection-status connected';
            }
            
            if (document.getElementById('lobbySection').classList.contains('active')) {
                refreshRooms();
            }
        });

        socket.on('disconnect', () => {
            document.getElementById('connectionStatus').textContent = 'â— ì—°ê²° ëŠê¹€';
            document.getElementById('connectionStatus').className = 'connection-status disconnected';
        });

        socket.on('roomsList', (rooms) => {
            roomsList = rooms;
            renderRoomsList();
        });

        socket.on('roomsListUpdated', (rooms) => {
            roomsList = rooms;
            renderRoomsList();
        });

        socket.on('roomCreated', (data) => {
            currentRoomId = data.roomId;
            const hostInput = document.getElementById('createRoomHostNameInput');
            currentUser = (hostInput && hostInput.value.trim()) || data.userName || '';
            initChatModule();
            isHost = true;
            isReady = data.isReady || false;
            readyUsers = data.readyUsers || [];
            initReadyModule();
            initOrderModule();

            // ê²½ë§ˆ ê²Œì„ ìƒíƒœ ì´ˆê¸°í™” (gameStateì—ì„œ ê°€ì ¸ì˜¤ê¸°)
            if (data.gameState) {
                if (data.gameState.selectedVehicleTypes) {
                    selectedVehicleTypes = data.gameState.selectedVehicleTypes;
                    console.log('[roomCreated] selectedVehicleTypes ì„¤ì •:', selectedVehicleTypes);
                }
                if (data.gameState.availableHorses) {
                    availableHorses = data.gameState.availableHorses;
                }
                if (data.gameState.userHorseBets) {
                    userHorseBets = data.gameState.userHorseBets;
                }
                if (data.gameState.horseRaceMode) {
                    horseRaceMode = data.gameState.horseRaceMode;
                }
                if (data.gameState.raceRound) {
                    raceRound = data.gameState.raceRound;
                }
                if (data.gameState.horseRaceHistory) {
                    horseRaceHistory = data.gameState.horseRaceHistory;
                    renderHistory();
                }
            }

            document.getElementById('lobbySection').classList.remove('active');
            document.getElementById('createRoomSection').classList.remove('active');
            document.getElementById('gameSection').classList.add('active');

            document.body.classList.remove('lobby-active');
            document.body.classList.add('game-active');

            initializeGameScreen(data);
            ReadyModule.setReadyUsers(readyUsers);
        });

        socket.on('roomJoined', (data) => {
            // ì„±ê³µ ì‹œ ì—ëŸ¬ í”Œë˜ê·¸ ì œê±°
            sessionStorage.removeItem('horseRaceFromDice');
            
            // ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê¸°
            document.getElementById('loadingScreen').style.display = 'none';
            
            currentRoomId = data.roomId;
            const globalInput = document.getElementById('globalUserNameInput');
            currentUser = (globalInput && globalInput.value.trim()) || data.userName || '';
            initChatModule();
            isHost = data.isHost;
            isReady = data.isReady || false;
            readyUsers = data.readyUsers || [];
            initReadyModule();
            initOrderModule();

            // ê²½ë§ˆ ê²Œì„ ìƒíƒœ ì´ˆê¸°í™” (gameStateì—ì„œ ê°€ì ¸ì˜¤ê¸°)
            if (data.gameState) {
                if (data.gameState.selectedVehicleTypes) {
                    selectedVehicleTypes = data.gameState.selectedVehicleTypes;
                    console.log('[roomJoined] selectedVehicleTypes ì„¤ì •:', selectedVehicleTypes);
                }
                if (data.gameState.availableHorses) {
                    availableHorses = data.gameState.availableHorses;
                }
                if (data.gameState.userHorseBets) {
                    userHorseBets = data.gameState.userHorseBets;
                }
                if (data.gameState.horseRaceMode) {
                    horseRaceMode = data.gameState.horseRaceMode;
                }
                if (data.gameState.raceRound) {
                    raceRound = data.gameState.raceRound;
                }
                if (data.gameState.horseRaceHistory) {
                    horseRaceHistory = data.gameState.horseRaceHistory;
                    renderHistory();
                }
            }

            document.getElementById('lobbySection').classList.remove('active');
            document.getElementById('gameSection').classList.add('active');
            
            document.body.classList.remove('lobby-active');
            document.body.classList.add('game-active');

            setHorseSoundCheckboxes();
            if (window.SoundManager && typeof window.SoundManager.ensureContext === 'function') {
                window.SoundManager.ensureContext();
            }
            initializeGameScreen(data);
            ReadyModule.setReadyUsers(readyUsers);

            // ê¸°ë¡ ì„¹ì…˜ í‘œì‹œ
            document.getElementById('historySection').classList.add('visible');
            
            // ê²½ë§ˆ ê²Œì„ì¸ ê²½ìš° ë§ ì„ íƒ UIê°€ í‘œì‹œë  ë•Œê¹Œì§€ ì ì‹œ ëŒ€ê¸° í›„ ë‹¤ì‹œ í™•ì¸
            if (data.gameType === 'horse-race') {
                setTimeout(() => {
                    const horseSelectionSection = document.getElementById('horseSelectionSection');
                    if (horseSelectionSection && !horseSelectionSection.classList.contains('active')) {
                        // ë§ ì„ íƒ UIê°€ ì•„ì§ í‘œì‹œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì„œë²„ì— ìš”ì²­
                        // horseSelectionReady ì´ë²¤íŠ¸ë¥¼ ê¸°ë‹¤ë¦¼ (ì„œë²„ì—ì„œ ìë™ìœ¼ë¡œ ë³´ëƒ„)
                    }
                }, 500);
            }
        });

        socket.on('roomError', (message) => {
            // ë‹¤ë¥¸ í˜ì´ì§€ì—ì„œ ì˜¨ ê²½ìš° ì£¼ì‚¬ìœ„ ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°
            const fromDice = sessionStorage.getItem('horseRaceFromDice');
            if (fromDice === 'true') {
                sessionStorage.removeItem('horseRaceFromDice');
                alert(message);
                window.location.href = '/dice-game-multiplayer.html';
                return;
            }
            
            // ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê³  ë¡œë¹„ ë³´ì—¬ì£¼ê¸°
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('lobbySection').style.display = 'block';
            alert(message);
        });

        socket.on('horseRaceError', (message) => {
            addDebugLog(`ì—ëŸ¬: ${message}`, 'error');
            alert(message);
        });

        // readyErrorëŠ” ReadyModuleì—ì„œ ì²˜ë¦¬

        // ë§ ì„ íƒ ì¤€ë¹„ ì´ë²¤íŠ¸
        // ì¬ê²½ì£¼ ì¤€ë¹„ ì´ë²¤íŠ¸ (ë™ì ì¼ ë•Œ í˜¸ìŠ¤íŠ¸ì—ê²Œ ì¬ê²½ì£¼ ì¤€ë¹„ ë²„íŠ¼ í‘œì‹œ)
        socket.on('reraceReady', (data) => {
            const winners = data.winners || [];
            const raceRound = data.raceRound || 1;
            
            addDebugLog(`ì¬ê²½ì£¼ ì¤€ë¹„ í•„ìš”: ${winners.length}ëª… ë™ì  (${winners.join(', ')})`, 'rerace');
            
            // í˜¸ìŠ¤íŠ¸ì—ê²Œ ì¬ê²½ì£¼ ì¤€ë¹„ ë²„íŠ¼ í‘œì‹œ
            if (isHost) {
                document.getElementById('endGameSection').style.display = 'block';
                const endSection = document.getElementById('endGameSection');
                endSection.innerHTML = `
                    <button class="end-button" onclick="requestReraceReady()" style="background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%); margin-bottom: 10px;">ğŸ”„ ì¬ê²½ì£¼ ì¤€ë¹„</button>
                    <button class="end-button" onclick="endHorseRaceGame()">ğŸ ê²Œì„ ì¢…ë£Œ</button>
                `;
            }
        });
        
        socket.on('horseSelectionReady', async (data) => {
            availableHorses = data.availableHorses || [];
            userHorseBets = data.userHorseBets || {};
            horseRaceMode = data.horseRaceMode || 'last';
            currentRoundPlayers = data.participants || data.players || [];
            raceRound = data.raceRound || 1;
            selectedVehicleTypes = data.selectedVehicleTypes || null;
            isReraceActive = data.isRerace || false; // ì¬ê²½ì£¼ ìƒíƒœ ì €ì¥
            
            addDebugLog(`ë§ ì„ íƒ ì¤€ë¹„: ${availableHorses.length}ë§ˆë¦¬, ì°¸ê°€ì ${currentRoundPlayers.length}ëª…, ì¬ê²½ì£¼: ${isReraceActive}`, 'selection');
            
            mySelectedHorse = userHorseBets[currentUser] !== undefined ? userHorseBets[currentUser] : null;
            
            // ì¬ê²½ì£¼ ì‹œ ê²°ê³¼ ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
            const resultOverlay = document.getElementById('resultOverlay');
            if (resultOverlay) {
                resultOverlay.classList.remove('visible');
            }
            
            // ë§ ì„ íƒ ì„¹ì…˜ í‘œì‹œ
            const horseSelectionSection = document.getElementById('horseSelectionSection');
            if (horseSelectionSection) {
                horseSelectionSection.classList.add('active');
                console.log('[horseSelectionReady] ì„¹ì…˜ í™œì„±í™”ë¨');
            } else {
                console.error('[horseSelectionReady] horseSelectionSection ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            }
            
            // ì¬ê²½ì£¼ì¸ ê²½ìš° í˜¸ìŠ¤íŠ¸ ì»¨íŠ¸ë¡¤ í‘œì‹œ
            if (isReraceActive && isHost) {
                document.getElementById('hostControls').style.display = 'block';
            }
            
            // ALL_VEHICLESê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ë¨¼ì € ë¡œë“œ
            if (ALL_VEHICLES.length === 0) {
                addDebugLog('ALL_VEHICLESê°€ ë¹„ì–´ìˆìŒ, ë¡œë“œ ì‹œì‘...', 'warn');
                await loadVehicleThemes();
                addDebugLog(`ë¡œë“œ ì™„ë£Œ: ${ALL_VEHICLES.length}ê°œ`, 'info');
            }
            
            console.log('[horseSelectionReady] renderHorseSelection í˜¸ì¶œ ì „:', {
                availableHorses: availableHorses.length,
                ALL_VEHICLES: ALL_VEHICLES.length,
                selectedVehicleTypes: selectedVehicleTypes,
                userHorseBets: Object.keys(userHorseBets).length,
                currentUser: currentUser
            });
            
            // ì•½ê°„ì˜ ì§€ì—° í›„ ë Œë”ë§ (DOM ì—…ë°ì´íŠ¸ ëŒ€ê¸°)
            setTimeout(() => {
                renderHorseSelection();
            }, 100);
            
            // ì¬ê²½ì£¼ì¸ ê²½ìš° í˜¸ìŠ¤íŠ¸ì—ê²Œ ì¬ê²½ì£¼ ë²„íŠ¼ í‘œì‹œ ì¤€ë¹„
            if (isReraceActive && isHost) {
                updateReraceButton();
            }
        });

        // ë§ ì„ íƒ ì™„ë£Œ ì´ë²¤íŠ¸
        socket.on('horseSelected', (data) => {
            userHorseBets = data.userHorseBets || {};
            
            if (data.userName === currentUser) {
                const previousSelection = mySelectedHorse;
                mySelectedHorse = data.horseIndex;
                
                // íƒˆê²ƒ ì„ íƒ ì‹œ ìë™ìœ¼ë¡œ ì¤€ë¹„ ìƒíƒœë¡œ ë³€ê²½
                if (data.horseIndex !== null && data.horseIndex !== undefined) {
                    // íƒˆê²ƒì„ ì„ íƒí–ˆê³ , ì•„ì§ ì¤€ë¹„ ì•ˆëìœ¼ë©´ ì¤€ë¹„
                    if (!isReady) {
                        toggleReady();
                    }
                } else {
                    // íƒˆê²ƒ ì„ íƒ ì·¨ì†Œí–ˆê³ , ì¤€ë¹„ ìƒíƒœë©´ ì¤€ë¹„ ì·¨ì†Œ
                    if (isReady) {
                        toggleReady();
                    }
                }
            }
            
            renderHorseSelection();
        });

        // ë§ ì„ íƒ í˜„í™© ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸ (ë‹¤ë¥¸ ì‚¬ìš©ì ì„ íƒ ì‹œ)
        socket.on('horseSelectionUpdated', (data) => {
            userHorseBets = data.userHorseBets || {};
            
            const selectedCount = Object.keys(userHorseBets).length;
            addDebugLog(`ë§ ì„ íƒ ì—…ë°ì´íŠ¸: ${selectedCount}ëª… ì„ íƒ`, 'selection');
            
            // ë‚´ ì„ íƒ ìƒíƒœ í™•ì¸ (ì„ íƒ ì·¨ì†Œ ì‹œ undefinedê°€ ë  ìˆ˜ ìˆìŒ)
            if (userHorseBets[currentUser] !== undefined) {
                mySelectedHorse = userHorseBets[currentUser];
            } else {
                mySelectedHorse = null; // ì„ íƒ ì·¨ì†Œ
            }
            
            renderHorseSelection();
            
            // ì¬ê²½ì£¼ ë²„íŠ¼ ì—…ë°ì´íŠ¸ (ì¬ê²½ì£¼ì¸ ê²½ìš°)
            if (isReraceActive && isHost) {
                updateReraceButton();
            }
        });

        // ì¹´ìš´íŠ¸ë‹¤ìš´ ì´ë²¤íŠ¸
        socket.on('horseRaceCountdown', (data) => {
            addDebugLog(`ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘: ${data.duration}ì´ˆ, ë¼ìš´ë“œ ${data.raceRound}`, 'race');
            if (window.SoundManager) SoundManager.playSound('horse-race_countdown', getHorseSoundEnabled());
            showCountdown();
        });

        // ê²½ì£¼ ì‹œì‘ ì´ë²¤íŠ¸
        socket.on('horseRaceStarted', (data) => {
            isRaceActive = true;
            isReraceActive = false; // ê²½ì£¼ ì‹œì‘ ì‹œ ì¬ê²½ì£¼ ìƒíƒœ ì´ˆê¸°í™”

            // ì‚¬ìš´ë“œ: ì¶œë°œ ì´ì†Œë¦¬ â†’ ë°œêµ½/ê´€ê° ë£¨í”„
            if (window.SoundManager) {
                SoundManager.playSound('horse-race_gunshot', getHorseSoundEnabled());
                setTimeout(() => {
                    SoundManager.playLoop('horse-race_crowd', getHorseSoundEnabled(), 0.3);
                    SoundManager.playLoop('horse-race_bgm', getHorseSoundEnabled(), 0.3);
                }, 500);
            }

            // everPlayedUsers ì—…ë°ì´íŠ¸
            if (data.everPlayedUsers) {
                everPlayedUsers = [...data.everPlayedUsers];
            }
            
            addDebugLog(`ê²½ì£¼ ì‹œì‘: ë¼ìš´ë“œ ${data.raceRound || raceRound}, ${data.horseRankings?.length || 0}ë§ˆë¦¬`, 'race');
            
            // ì‚¬ìš©ì ë² íŒ… ì •ë³´ ì—…ë°ì´íŠ¸ (ê²½ì£¼ ì• ë‹ˆë©”ì´ì…˜ì—ì„œ ì‚¬ìš©)
            if (data.userHorseBets) {
                userHorseBets = data.userHorseBets;
            }
            
            // íƒˆê²ƒ íƒ€ì… ë¹„êµ (ê²Œì„ ì‹œì‘ ì „ vs ê²Œì„ ì‹œì‘ í›„)
            const beforeSelectedVehicleTypes = selectedVehicleTypes;
            console.log('[ê²½ì£¼ ì‹œì‘] selectedVehicleTypes ë¹„êµ:', {
                ì´ì „: beforeSelectedVehicleTypes,
                ì„œë²„ì—ì„œ_ë°›ì€_ê°’: data.selectedVehicleTypes,
                horseRankings: data.horseRankings,
                availableHorses: availableHorses
            });
            
            // íƒˆê²ƒ íƒ€ì… ì—…ë°ì´íŠ¸ (ì„œë²„ì—ì„œ ì „ë‹¬ëœ ê²ƒ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ì¡´ ê°’ ìœ ì§€)
            if (data.selectedVehicleTypes && data.selectedVehicleTypes.length > 0) {
                // ì„œë²„ì—ì„œ ë°›ì€ ê°’ê³¼ ê¸°ì¡´ ê°’ì´ ë‹¤ë¥´ë©´ ê²½ê³ 
                if (JSON.stringify(selectedVehicleTypes) !== JSON.stringify(data.selectedVehicleTypes)) {
                    console.warn('[ê²½ì£¼ ì‹œì‘] âš ï¸ selectedVehicleTypesê°€ ë³€ê²½ë¨!', {
                        ì´ì „: selectedVehicleTypes,
                        ìƒˆë¡œìš´: data.selectedVehicleTypes
                    });
                }
                selectedVehicleTypes = data.selectedVehicleTypes;
                console.log('[ê²½ì£¼ ì‹œì‘] selectedVehicleTypes ì—…ë°ì´íŠ¸:', selectedVehicleTypes);
            } else {
                console.warn('[ê²½ì£¼ ì‹œì‘] selectedVehicleTypesê°€ ì „ë‹¬ë˜ì§€ ì•ŠìŒ. ê¸°ì¡´ ê°’ ìœ ì§€:', selectedVehicleTypes);
            }
            
            // ë§ ì„ íƒ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.getElementById('horseSelectionSection').classList.remove('active');
            
            // í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ê²½ì£¼ ê¸°ë¡ ì €ì¥
            const currentRaceRecord = data.record;
            
            // ê²½ì£¼ íŠ¸ë™ í‘œì‹œ (ì„œë²„ì—ì„œ ë°›ì€ ê¸°ë¯¹ ë°ì´í„° ì „ë‹¬) - ì½œë°±ìœ¼ë¡œ ì¢…ë£Œ ì²˜ë¦¬
            startRaceAnimation(data.horseRankings, data.speeds, data.gimmicks, (actualFinishOrder) => {
                // ì‚¬ìš´ë“œ: ë£¨í”„ ì •ì§€ â†’ ê²°ìŠ¹ íŒ¡íŒŒë ˆ
                if (window.SoundManager) {
                    SoundManager.stopLoop('horse-race_crowd');
                    SoundManager.playSound('horse-race_finish', getHorseSoundEnabled());
                }
                // ê²½ì£¼ ì¢…ë£Œ í›„ì— ê¸°ë¡ ì¶”ê°€ (ì‹¤ì œ ë„ì°© ìˆœì„œ ë°˜ì˜)
                if (currentRaceRecord && actualFinishOrder) {
                    currentRaceRecord.rankings = actualFinishOrder;
                    horseRaceHistory.push(currentRaceRecord);
                    renderHistory();
                }
                // ì‹¤ì œ ë„ì°© ìˆœì„œë¡œ ê²°ê³¼ í‘œì‹œ
                const resultData = { ...data };
                if (actualFinishOrder) {
                    resultData.horseRankings = actualFinishOrder;
                }
                showRaceResult(resultData);
            });
            
            // ê²Œì„ ìƒíƒœ ì—…ë°ì´íŠ¸
            const gameStatus = document.getElementById('gameStatus');
            if (gameStatus) {
                gameStatus.textContent = 'ê²½ì£¼ ì§„í–‰ ì¤‘!';
                gameStatus.className = 'game-status playing';
                gameStatus.style.background = '#d4edda';
                gameStatus.style.color = '#155724';
            }
        });

        // ê²½ì£¼ ì¢…ë£Œ ì´ë²¤íŠ¸ (ì„œë²„ì—ì„œ ì§ì ‘ ë³´ë‚´ëŠ” ê²½ìš°)
        socket.on('horseRaceEnded', (data) => {
            // ì‚¬ìš´ë“œ: ë£¨í”„ ì •ì§€ + ê²°ê³¼ íš¨ê³¼ìŒ
            if (window.SoundManager) {
                SoundManager.stopAll();
                SoundManager.playSound('horse-race_result', getHorseSoundEnabled());
            }
            // userHorseBets ì—…ë°ì´íŠ¸ (ì„œë²„ì—ì„œ ë³´ë‚¸ ê²½ìš°)
            if (data.userHorseBets) {
                userHorseBets = data.userHorseBets;
            }
            
            // ê²Œì„ ê¸°ë¡ ì—…ë°ì´íŠ¸
            if (data.horseRaceHistory) {
                horseRaceHistory = data.horseRaceHistory;
                renderHistory();
            }
            
            showRaceResult(data);
            
            // ì¤€ë¹„ ìƒíƒœ ì´ˆê¸°í™”
            isReady = false;
            mySelectedHorse = null;
            updateReadyButton();
        });

        // ì¤€ë¹„ ìƒíƒœ ë³€ê²½
        // readyStateChanged, readyUsersUpdatedëŠ” ReadyModuleì—ì„œ ì²˜ë¦¬ (initReadyModuleì—ì„œ ë°”ì¸ë”©)

        // ì‚¬ìš©ì ëª©ë¡ ì—…ë°ì´íŠ¸
        socket.on('updateUsers', (users) => {
            if (window.SoundManager) SoundManager.playSound('common_notification', getHorseSoundEnabled());
            updateUsers(users);
        });

        // ê°•í‡´ë‹¹í–ˆì„ ë•Œ
        socket.on('kicked', (message) => {
            showCustomAlert(message, 'info');
            location.reload();
        });

        // í˜¸ìŠ¤íŠ¸ ë³€ê²½ ì•Œë¦¼
        socket.on('hostChanged', (data) => {
            console.log('í˜¸ìŠ¤íŠ¸ ë³€ê²½ ì•Œë¦¼:', data.message);
        });

        // ì±„íŒ…ì€ ChatModuleì—ì„œ ì²˜ë¦¬ (initChatModuleì—ì„œ ë°”ì¸ë”©)

        // ì£¼ë¬¸ë°›ê¸° ì´ë²¤íŠ¸/í•¨ìˆ˜ëŠ” OrderModuleì—ì„œ ì²˜ë¦¬
        
        // ì»¤ìŠ¤í…€ ì•Œë¦¼ì°½
        function showCustomAlert(message, type = 'info', title = '') {
            const overlay = document.createElement('div');
            overlay.className = 'custom-alert-overlay';
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000;';
            
            const colors = {
                info: '#8b4513',
                warning: '#ffc107',
                error: '#dc3545',
                success: '#28a745'
            };
            
            const modal = document.createElement('div');
            modal.style.cssText = `background: white; padding: 25px; border-radius: 12px; max-width: 400px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); border-top: 4px solid ${colors[type] || colors.info};`;
            
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = 'í™•ì¸';
            confirmBtn.style.cssText = `width: 100%; padding: 12px; background: ${colors[type] || colors.info}; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer;`;
            confirmBtn.addEventListener('click', () => overlay.remove());
            
            const contentDiv = document.createElement('div');
            if (title) {
                const titleDiv = document.createElement('div');
                titleDiv.style.cssText = `font-size: 18px; font-weight: bold; margin-bottom: 15px; color: ${colors[type] || colors.info};`;
                titleDiv.textContent = title;
                contentDiv.appendChild(titleDiv);
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = 'margin-bottom: 20px; line-height: 1.6;';
            messageDiv.innerHTML = message;
            contentDiv.appendChild(messageDiv);
            
            modal.appendChild(contentDiv);
            modal.appendChild(confirmBtn);
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.remove();
            });
        }
        
        // í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸
        function showConfirmDialog(message, onConfirm) {
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000;';
            
            const modal = document.createElement('div');
            modal.style.cssText = 'background: white; padding: 25px; border-radius: 12px; max-width: 400px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);';
            
            modal.innerHTML = `
                <div style="margin-bottom: 20px; line-height: 1.6; text-align: center;">${message}</div>
                <div style="display: flex; gap: 10px;">
                    <button id="confirmCancel" style="flex: 1; padding: 12px; background: #e9ecef; color: #333; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">ì·¨ì†Œ</button>
                    <button id="confirmOk" style="flex: 1; padding: 12px; background: #dc3545; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer;">í™•ì¸</button>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            modal.querySelector('#confirmCancel').addEventListener('click', () => overlay.remove());
            modal.querySelector('#confirmOk').addEventListener('click', () => {
                overlay.remove();
                if (onConfirm) onConfirm();
            });
        }

        // í”Œë ˆì´ì–´ ì•¡ì…˜ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ (í˜¸ìŠ¤íŠ¸ì„ëª…, ì œì™¸ì‹œí‚¤ê¸°, ì·¨ì†Œ)
        function showPlayerActionDialog(playerName) {
            return new Promise((resolve) => {
                const existingDialog = document.getElementById('playerActionDialog');
                if (existingDialog) existingDialog.remove();

                const dialogOverlay = document.createElement('div');
                dialogOverlay.id = 'playerActionDialog';
                dialogOverlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 10002; display: flex; justify-content: center; align-items: center;';

                const dialogContent = document.createElement('div');
                dialogContent.style.cssText = 'background: white; border-radius: 16px; padding: 25px 30px; max-width: 500px; width: 90vw; box-shadow: 0 10px 40px rgba(0,0,0,0.2); border: 2px solid #8b4513;';

                const messageDiv = document.createElement('div');
                messageDiv.style.cssText = 'font-size: 18px; line-height: 1.6; color: #333; text-align: center; margin-bottom: 25px; font-weight: 600;';
                messageDiv.innerHTML = `<span style="font-size: 24px; margin-right: 8px;">ğŸ‘¤</span>${playerName}ë‹˜ì—ê²Œ ì–´ë–¤ í–‰ë™ì„ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;

                const buttonContainer = document.createElement('div');
                buttonContainer.style.cssText = 'display: flex; flex-direction: column; gap: 12px;';

                function createBtn(text, bg, resolveValue) {
                    const btn = document.createElement('button');
                    btn.textContent = text;
                    btn.style.cssText = `padding: 12px 25px; background: ${bg}; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;`;
                    btn.onclick = () => { dialogOverlay.remove(); document.removeEventListener('keydown', handleEsc); resolve(resolveValue); };
                    return btn;
                }

                const hostButton = createBtn('í˜¸ìŠ¤íŠ¸ì„ëª…', 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', 'host');
                const kickButton = createBtn('ì œì™¸ì‹œí‚¤ê¸°', 'linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)', 'kick');
                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'ì·¨ì†Œ';
                cancelButton.style.cssText = 'padding: 12px 25px; background: #f5f5f5; color: #666; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;';
                cancelButton.onclick = () => { dialogOverlay.remove(); document.removeEventListener('keydown', handleEsc); resolve('cancel'); };

                const handleEsc = (e) => {
                    if (e.key === 'Escape') { dialogOverlay.remove(); document.removeEventListener('keydown', handleEsc); resolve('cancel'); }
                };
                document.addEventListener('keydown', handleEsc);

                dialogOverlay.onclick = (e) => {
                    if (e.target === dialogOverlay) { dialogOverlay.remove(); document.removeEventListener('keydown', handleEsc); resolve('cancel'); }
                };

                buttonContainer.appendChild(hostButton);
                buttonContainer.appendChild(kickButton);
                buttonContainer.appendChild(cancelButton);
                dialogContent.appendChild(messageDiv);
                dialogContent.appendChild(buttonContainer);
                dialogOverlay.appendChild(dialogContent);
                document.body.appendChild(dialogOverlay);
                hostButton.focus();
            });
        }

        // ê²Œì„ ì¢…ë£Œ
        function endHorseRaceGame() {
            socket.emit('endHorseRace', {});
        }
        
        // ì´ì „ ê²Œì„ ë°ì´í„° ì‚­ì œ
        function clearHorseRaceData() {
            showConfirmDialog('ì´ì „ ê²Œì„ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê¸°ë¡, ì£¼ë¬¸ ë‚´ì—­ ë“±ì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤)', () => {
                socket.emit('clearHorseRaceData');
            });
        }
        
        // ë°ì´í„° ì‚­ì œ ì™„ë£Œ ìˆ˜ì‹ 
        socket.on('horseRaceDataCleared', () => {
            horseRaceHistory = [];
            ordersData = {};
            isOrderActive = false;
            OrderModule.setOrdersData(ordersData);
            OrderModule.setIsOrderActive(false);
            renderHistory();
            OrderModule.renderOrders();
            showCustomAlert('ì´ì „ ê²Œì„ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success', 'âœ… ì‚­ì œ ì™„ë£Œ');
        });

        // ê²Œì„ ëª¨ë“œ ì—…ë°ì´íŠ¸ ìˆ˜ì‹  (ë¬´ì¡°ê±´ ê¼´ë“± ì°¾ê¸°)
        socket.on('horseRaceModeUpdated', (mode) => {
            horseRaceMode = mode || 'last';
        });
        
        // íƒˆê²ƒ íƒ€ì… ì—…ë°ì´íŠ¸ ìˆ˜ì‹ 
        socket.on('vehicleTypesUpdated', (data) => {
            selectedVehicleTypes = data.vehicleTypes;
            availableHorses = data.availableHorses;
            userHorseBets = {}; // íƒˆê²ƒ ë³€ê²½ ì‹œ ì„ íƒ ì´ˆê¸°í™”
            mySelectedHorse = null;
            renderHorseSelection();
        });

        // ë°© ë‚˜ê°€ê¸°
        socket.on('roomLeft', () => {
            if (roomExpiryInterval) {
                clearInterval(roomExpiryInterval);
            }
            window.location.href = '/dice-game-multiplayer.html';
        });

        socket.on('roomDeleted', (data) => {
            alert(data.message || 'ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            if (roomExpiryInterval) {
                clearInterval(roomExpiryInterval);
            }
            window.location.href = '/dice-game-multiplayer.html';
        });

        // ë¹„ê³µê°œ ë°© ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
        document.addEventListener('DOMContentLoaded', () => {
            const privateCheckbox = document.getElementById('createRoomPrivateCheckbox');
            const passwordContainer = document.getElementById('createRoomPasswordContainer');
            
            if (privateCheckbox && passwordContainer) {
                privateCheckbox.addEventListener('change', function() {
                    passwordContainer.style.display = this.checked ? 'block' : 'none';
                    if (!this.checked) {
                        document.getElementById('createRoomPasswordInput').value = '';
                    }
                });
            }
            
            // ì‚¬ìš´ë“œ ì²´í¬ë°•ìŠ¤ (ê¸°ë³¸ ë”, localStorageì™€ ë¡œë¹„/ê²Œì„ ì„¹ì…˜ ì²´í¬ë°•ìŠ¤ ë™ê¸°í™”)
            setHorseSoundCheckboxes();
            const hsc1 = document.getElementById('soundCheckbox');
            const hsc2 = document.getElementById('createRoomSoundCheckbox');
            const hsc3 = document.getElementById('gameSectionSoundCheckbox');
            if (hsc1) hsc1.addEventListener('change', () => onHorseSoundChange(hsc1.checked));
            if (hsc2) hsc2.addEventListener('change', () => onHorseSoundChange(hsc2.checked));
            if (hsc3) hsc3.addEventListener('change', () => onHorseSoundChange(hsc3.checked));
            
            // ì €ì¥ëœ ì´ë¦„ ë¶ˆëŸ¬ì˜¤ê¸°
            const savedName = localStorage.getItem('horseRaceUserName');
            if (savedName) {
                document.getElementById('globalUserNameInput').value = savedName;
            }
            
            // URL íŒŒë¼ë¯¸í„°ë¡œ ë°© ìƒì„±/ì…ì¥ ìš”ì²­ì´ ì™”ëŠ”ì§€ í™•ì¸
            const urlParams = new URLSearchParams(window.location.search);
            
            // ë°© ìƒì„± ìš”ì²­
            if (urlParams.get('createRoom') === 'true') {
                const pendingRoom = localStorage.getItem('pendingHorseRaceRoom');
                if (pendingRoom) {
                    const roomData = JSON.parse(pendingRoom);
                    localStorage.removeItem('pendingHorseRaceRoom');
                    
                    socket.on('connect', function onConnect() {
                        socket.off('connect', onConnect);
                        
                        socket.emit('createRoom', {
                            userName: roomData.userName,
                            roomName: roomData.roomName,
                            isPrivate: roomData.isPrivate,
                            password: roomData.password,
                            gameType: 'horse-race',
                            expiryHours: roomData.expiryHours,
                            blockIPPerUser: roomData.blockIPPerUser,
                            deviceId: getDeviceId()
                        });
                    });
                    
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
            
            // ë°© ì…ì¥ ìš”ì²­
            if (urlParams.get('joinRoom') === 'true') {
                const pendingJoin = localStorage.getItem('pendingHorseRaceJoin');
                if (pendingJoin) {
                    const joinData = JSON.parse(pendingJoin);
                    localStorage.removeItem('pendingHorseRaceJoin');
                    
                    sessionStorage.setItem('horseRaceFromDice', 'true');
                    
                    document.getElementById('loadingScreen').style.display = 'flex';
                    document.getElementById('lobbySection').style.display = 'none';
                    
                    document.getElementById('globalUserNameInput').value = joinData.userName;
                    
                    socket.on('connect', function onJoinConnect() {
                        socket.off('connect', onJoinConnect);
                        
                        if (joinData.isPrivate) {
                            pendingRoomId = joinData.roomId;
                            pendingUserName = joinData.userName;
                            document.getElementById('passwordModal').style.display = 'flex';
                            document.getElementById('roomPasswordInput').focus();
                        } else {
                            socket.emit('joinRoom', {
                                roomId: joinData.roomId,
                                userName: joinData.userName,
                                isHost: false,
                                password: '',
                                deviceId: getDeviceId()
                            });
                        }
                    });
                    
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
        });
    </script>

    <!-- ë””ë²„ê·¸ ë¡œê·¸ ì„¹ì…˜ -->
    <div class="debug-log-section" id="debugLogSection" style="position: fixed; bottom: 20px; right: 20px; width: 400px; max-height: 300px; background: rgba(0, 0, 0, 0.9); color: #0f0; border-radius: 8px; padding: 15px; font-family: 'Courier New', monospace; font-size: 11px; z-index: 10000; overflow-y: auto; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #0f0; padding-bottom: 5px;">
            <div style="font-weight: bold; color: #0f0;">ğŸ› ë””ë²„ê·¸ ë¡œê·¸</div>
            <div style="display: flex; gap: 5px;">
                <button onclick="clearDebugLog()" style="background: #333; color: #0f0; border: 1px solid #0f0; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;">ì§€ìš°ê¸°</button>
                <button onclick="toggleDebugLog()" style="background: #333; color: #0f0; border: 1px solid #0f0; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;">ìˆ¨ê¸°ê¸°</button>
            </div>
        </div>
        <div id="debugLogContent" style="line-height: 1.4;"></div>
    </div>

    <script>
        // localhostê°€ ì•„ë‹ˆë©´ ë””ë²„ê·¸ ë¡œê·¸ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
        if (!isLocalhost) {
            const debugLogSection = document.getElementById('debugLogSection');
            if (debugLogSection) {
                debugLogSection.style.display = 'none';
            }
        }
        
        function clearDebugLog() {
            const logContent = document.getElementById('debugLogContent');
            if (logContent) {
                logContent.innerHTML = '';
            }
        }
        
        function toggleDebugLog() {
            const logSection = document.getElementById('debugLogSection');
            if (logSection) {
                logSection.style.display = logSection.style.display === 'none' ? 'block' : 'none';
            }
        }
    </script>
</body>
</html>
