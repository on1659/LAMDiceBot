<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Google AdSense -->
    <meta name="google-adsense-account" content="ca-pub-1608259764663412">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1608259764663412" crossorigin="anonymous"></script>
    <title>LAM Horse Race 🐎</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Yeon+Sung&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/horse-race.css">
</head>
<body>
    <!-- 로딩 화면 -->
    <div id="loadingScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <div style="text-align: center; color: white;">
            <div style="font-size: 80px; margin-bottom: 20px; animation: bounce 1s infinite;">🐎</div>
            <h2 style="font-size: 24px; margin-bottom: 10px;">방에 입장 중...</h2>
            <p style="font-size: 16px; opacity: 0.8;">잠시만 기다려주세요</p>
            <div style="margin-top: 30px;">
                <div style="width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
            </div>
        </div>
    </div>

    <!-- 이름 입력 (로그인 시 자동 설정, 숨김) -->
    <input type="hidden" id="globalUserNameInput">

    <div class="container">
        <!-- 게임 섹션 -->
        <section class="game-section" id="gameSection">
            <!-- 방 정보 헤더 -->
            <div class="room-header">
                <div style="display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <span class="room-title" id="roomTitle">경마 방</span>
                    <span class="host-badge" id="hostBadge" style="display: none;">👑 호스트</span>
                    <div class="volume-control" id="gameSectionVolumeControl">
                        <button class="volume-btn" id="gameSectionVolumeBtn" title="음소거 토글">🔇</button>
                        <input type="range" class="volume-slider muted" id="gameSectionVolumeSlider" min="0" max="100" value="50">
                    </div>
                </div>
                <div style="text-align: center; margin-top: 10px;">
                    <button onclick="leaveRoom()" style="width: auto; padding: 8px 15px; font-size: 12px; background: #6c757d; color: #000; font-weight: 600; border: none; border-radius: 8px; cursor: pointer;">🚪 나가기</button>
                </div>
            </div>

            <!-- 방 폭파 카운트다운 -->
            <div class="room-expiry-section" id="roomExpirySection" style="display: none;">
                <div style="color: #856404; font-weight: bold; font-size: 14px;">
                    ⏰ 방 폭파까지 남은 시간: <span id="roomExpiryCountdown" style="color: #d9534f;">--:--:--</span>
                </div>
            </div>

            <!-- 접속자 목록 -->
            <div class="users-section" id="usersSection">
                <div class="users-title">
                    👥 접속자 (<span id="usersCount">0</span>명)
                    <span id="dragHint" style="display: none; font-size: 12px; color: #8b4513; font-weight: normal; margin-left: 10px;">
                        💡 드래그로 준비 시킬 수 있습니다.
                    </span>
                </div>
                <div class="users-list" id="usersList"></div>
            </div>

            <!-- 준비 섹션 -->
            <div class="ready-section" id="readySection">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="users-title" style="margin: 0;">✅ 준비한 사람 (<span id="readyCount">0</span>명)</div>
                    <button id="readyButton" onclick="toggleReady()" style="width: auto; padding: 10px 20px; background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%); color: #fff; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s;">준비</button>
                </div>
                <div class="users-list" id="readyUsersList">
                    <div style="color: #999; text-align: center; padding: 10px; width: 100%;">아직 준비한 사람이 없습니다</div>
                </div>
            </div>

            <!-- 게임 모드: 무조건 꼴등 찾기 (모드 선택 제거) -->

            <!-- 탈것 선택 섹션 -->
            <div class="horse-selection-section" id="horseSelectionSection">
                <div class="users-title" style="margin-bottom: 15px;">🏁 탈것 선택</div>
                <div id="horseSelectionGrid" class="horse-selection-grid">
                    <!-- 탈것 선택 버튼들이 여기에 동적으로 생성됨 -->
                </div>
                <div id="horseSelectionInfo" style="text-align: center; margin-top: 15px; color: #666; font-size: 14px;">
                    탈것을 선택해주세요
                </div>
                <!-- 탈것 선택 안한 사람 -->
                <div id="notSelectedVehicleSection" style="display: none; margin-top: 10px; padding: 10px; background: #fff5e6; border-radius: 8px;">
                    <div style="font-weight: bold; color: #ff6b6b; margin-bottom: 8px; font-size: 13px;">⏳ 선택 안한 사람</div>
                    <div id="notSelectedVehicleList" style="display: flex; flex-wrap: wrap; gap: 5px;"></div>
                </div>
            </div>

            <!-- 호스트 컨트롤 -->
            <div class="host-controls" id="hostControls" style="display: none; margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button class="start-button" id="startHorseRaceButton" onclick="startHorseRace()" disabled style="flex: 1;">
                        게임 시작
                    </button>
                    <button onclick="OrderModule.startOrder()" id="startOrderButton" style="flex: 1; background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: #fff; font-weight: 600; font-size: 16px; padding: 15px;">주문받기 시작</button>
                    <button onclick="OrderModule.endOrder()" id="endOrderButton" style="display: none; flex: 1; background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%); color: #fff; font-weight: 600; font-size: 16px; padding: 15px;">주문받기 종료</button>
                </div>
                <button onclick="clearHorseRaceData()" id="clearDataButton" style="width: 100%; background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%); color: #fff; font-weight: 600; font-size: 14px; padding: 12px;">이전 게임 데이터 삭제</button>
            </div>

            <!-- 주문받기 섹션 -->
            <div class="orders-section" id="ordersSection" style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="users-title" style="font-weight: bold; color: #8b4513; font-size: 16px; margin: 0;">🍔 주문받기</div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="OrderModule.showOrderList()" id="showOrderListButton" style="width: auto; padding: 8px 16px; font-size: 14px; background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%); color: #000; font-weight: 600;">📋 주문리스트</button>
                        <button onclick="OrderModule.sortOrders('asc')" class="sort-btn" style="padding: 6px 10px; font-size: 12px; background: #d2b48c; color: #333; border: none; border-radius: 4px; cursor: pointer;">가나다순</button>
                        <button onclick="OrderModule.sortOrders('count')" class="sort-btn" style="padding: 6px 10px; font-size: 12px; background: #d2b48c; color: #333; border: none; border-radius: 4px; cursor: pointer;">주문 많은 순</button>
                    </div>
                </div>
                
                <!-- 주문하지 않은 사람 목록 -->
                <div id="notOrderedSection" style="display: none; margin-bottom: 10px; padding: 10px; background: #fff5e6; border-radius: 8px;">
                    <div style="font-weight: bold; color: #ff6b6b; margin-bottom: 8px; font-size: 13px;">⏳ 주문하지 않은 사람</div>
                    <div id="notOrderedList" style="display: flex; flex-wrap: wrap; gap: 5px;"></div>
                </div>
                
                <!-- 내 주문 입력 -->
                <div style="background: #fff9e6; border: 2px solid #ffc107; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="font-size: 16px; font-weight: 600; color: #856404; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span>📝</span>
                            <span>내 주문</span>
                        </div>
                        <button onclick="OrderModule.toggleMenuManager()" style="width: auto; padding: 6px 12px; font-size: 12px; background: #f8f9fa; color: #8b4513; border: 1px solid #8b4513; border-radius: 4px; cursor: pointer;">메뉴 관리</button>
                    </div>
                    
                    <!-- 자주 쓰는 메뉴 관리 -->
                    <div id="menuManager" style="display: none; background: #f8f9fa; border: 2px solid #8b4513; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="font-weight: bold; color: #8b4513;">📋 자주 쓰는 메뉴</span>
                            <button onclick="OrderModule.toggleMenuManager()" style="padding: 4px 8px; font-size: 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">닫기</button>
                        </div>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" id="newMenuInput" placeholder="새 메뉴 입력" maxlength="50" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <button onclick="OrderModule.addMenu()" style="padding: 8px 16px; background: #8b4513; color: white; border: none; border-radius: 4px; cursor: pointer;">추가</button>
                        </div>
                        <div id="menuList" style="display: flex; flex-wrap: wrap; gap: 8px; max-height: 100px; overflow-y: auto;">
                            <div style="color: #999; text-align: center; padding: 10px;">등록된 메뉴가 없습니다</div>
                        </div>
                    </div>
                    
                    <div class="order-input-group">
                        <div class="order-input-wrapper">
                            <div class="autocomplete-suggestion" id="autocompleteSuggestion"></div>
                            <input type="text" id="myOrderInput" placeholder="주문할 내용을 입력하세요" maxlength="100" disabled>
                            <div class="autocomplete-dropdown" id="autocompleteDropdown" style="display: none;"></div>
                        </div>
                        <button onclick="OrderModule.updateMyOrder()" id="orderSaveButton" style="width: auto; padding: 12px 20px; height: fit-content; margin: 0; color: #000; font-weight: 600;" disabled>저장</button>
                    </div>
                </div>

                <!-- 전체 주문 목록 -->
                <div id="orderList" style="background: #f8f9fa; border-radius: 8px; padding: 12px; max-height: 200px; overflow-y: auto;">
                    <div style="color: #999; text-align: center; padding: 10px;">아직 주문이 없습니다</div>
                </div>
                <!-- 관전자 주문 -->
                <div id="spectatorOrdersSection" style="display: none; margin-top: 10px;">
                    <div style="font-size: 13px; color: #999; margin-bottom: 5px;">관전자 주문</div>
                    <div id="spectatorOrderList" style="background: #f8f9fa; border-radius: 8px; padding: 12px;"></div>
                </div>
            </div>
            
            <!-- 게임 상태 표시 -->
            <div class="game-status waiting" id="gameStatus" style="padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; margin-bottom: 20px; background: #e9ecef; color: #495057;">
                대기 중...
            </div>

            <!-- 경주 트랙 래퍼 (카메라 버튼 + 트랙) -->
            <div id="raceTrackWrapper" style="position: relative; display: none;">
                <!-- 카메라 전환 버튼 (트랙 바깥 우상단) -->
                <button id="cameraSwitchBtn" style="display: none; position: absolute; top: -32px; right: 0; z-index: 10; padding: 4px 10px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.3); background: rgba(0,0,0,0.65); color: #fff; font-size: 11px; cursor: pointer; font-family: 'Jua', sans-serif;">📷 시스템 카메라</button>
                <div class="race-track-container" id="raceTrackContainer" style="position: relative;">
                    <div class="race-track" id="raceTrack">
                    <!-- 말들이 여기에 동적으로 생성됨 -->
                </div>
                <!-- 미니맵 -->
                <div id="raceMinimap" style="display: none; position: absolute; bottom: 8px; right: 8px; width: 180px; background: rgba(0,0,0,0.75); border-radius: 8px; padding: 8px 10px; z-index: 100; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.15);">
                    <div style="font-size: 9px; color: rgba(255,255,255,0.5); margin-bottom: 4px; text-align: center;">TRACK MAP</div>
                    <div id="minimapTrack" style="position: relative; width: 100%; height: 6px; background: rgba(255,255,255,0.15); border-radius: 3px; margin-bottom: 2px;">
                        <!-- 거리 마커 + 말 위치 동적 생성 -->
                    </div>
                    <div id="minimapMarkers" style="position: relative; width: 100%; height: 10px;">
                        <!-- 거리 텍스트 -->
                    </div>
                    <div id="minimapDots" style="position: relative; width: 100%; min-height: 14px; margin-top: 2px;">
                        <!-- 말 아이콘 범례 -->
                    </div>
                </div>
                </div>
                <!-- 레이스 중 채팅 오버레이 -->
                <div id="raceChatOverlay"></div>
            </div>

            <!-- 다시보기 + GIF 저장 + 게임 종료 버튼 (결과 후 표시) -->
            <div id="replaySection" style="display: none; text-align: center; margin-top: 20px;">
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button id="mainReplayButton" onclick="playLastReplay()" style="flex: 1; padding: 12px; font-size: 15px; background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(255, 107, 107, 0.4); font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">🎬 다시보기</button>
                    <!-- GIF 기능 숨김 (CORS 이슈) -->
                    <button id="gifSaveButton" onclick="showGifOptionsModal()" style="display: none; flex: 1; padding: 12px; font-size: 15px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(76, 175, 80, 0.4); font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">📹 GIF 저장</button>
                </div>
            </div>
            <div id="endGameSection" style="display: none; text-align: center; margin-top: 10px;">
                <button class="end-button" onclick="endHorseRaceGame()">🏁 게임 종료</button>
            </div>

            <!-- 다시보기 버튼 (화면 숨김 상태에서 경주가 진행된 경우 표시) -->
            <div id="horseReplaySection" style="display: none; text-align: center; margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #8b4513 0%, #d2691e 100%); border-radius: 12px; box-shadow: 0 4px 15px rgba(139, 69, 19, 0.4);">
                <div style="color: white; margin-bottom: 12px; font-size: 14px; font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                    🎬 화면을 보지 않는 동안 경주가 진행되었습니다
                </div>
                <button onclick="replayMissedRace()" style="background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%); border: none; padding: 12px 25px; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; font-size: 15px; box-shadow: 0 4px 10px rgba(255, 107, 107, 0.4); font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                    🔄 다시보기
                </button>
            </div>

            <!-- 채팅 섹션 -->
            <div class="chat-section">
                <div style="font-weight: bold; color: #8b4513; margin-bottom: 10px; font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">💬 채팅</div>
                <div class="chat-messages" id="chatMessages"></div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="chatInput" placeholder="메시지를 입력하세요..." style="flex: 1; margin: 0;" onkeypress="handleChatKeypress(event)">
                    <button onclick="sendMessage()" style="width: auto; padding: 10px 20px; color: #000; font-weight: 600;">전송</button>
                </div>
            </div>
        </section>
    </div>

    <!-- 기록 섹션 -->
    <div class="history-section" id="historySection">
        <div class="history-title">📜 게임 기록</div>
        <div id="historyList"></div>
        
        <!-- 실시간 순위 패널 (게임 기록 하단) -->
        <div id="liveRankingPanel" style="display: none; background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 12px 15px; border-radius: 10px; margin-top: 15px; font-size: 13px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
            <div style="font-weight: bold; margin-bottom: 10px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 8px; font-size: 14px; font-family: 'Jua', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">🏃 실시간 순위</div>
            <div id="liveRankingList"></div>
        </div>
    </div>

    <!-- 결과 오버레이 -->
    <div class="result-overlay" id="resultOverlay">
        <div class="result-card">
            <div class="result-title">🎊 순위 발표 🎊</div>
            <div id="resultRankings" style="margin-bottom: 20px;"></div>
            <button onclick="closeResultOverlay()" style="width: auto; padding: 12px 30px; color: #000; font-weight: 600;">확인</button>
        </div>
    </div>

    <!-- 비밀번호 입력 모달 -->
    <div id="passwordModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%;">
            <h3 style="color: #8b4513; margin-bottom: 15px;">🔒 비공개 방</h3>
            <p style="margin-bottom: 15px; color: #666;">비밀번호를 입력하세요</p>
            <input type="password" id="roomPasswordInput" placeholder="비밀번호" style="margin-bottom: 15px;">
            <div style="display: flex; gap: 10px;">
                <button onclick="closePasswordModal()" style="background: #6c757d; flex: 1; color: #000; font-weight: 600;">취소</button>
                <button onclick="submitPassword()" style="flex: 1; color: #000; font-weight: 600;">입장</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/page-history-shared.js"></script>
    <script src="/chat-shared.js"></script>
    <script src="/ready-shared.js"></script>
    <script src="/order-shared.js"></script>
    <script src="/ranking-shared.js"></script>
    <script src="/assets/sounds/sound-manager.js"></script>
    <!-- <script src="/gif-recorder.js"></script> GIF 기능 비활성화 -->
    <script src="/js/horse-race-sprites.js"></script>
    <script src="/js/horse-race.js"></script>

    <!-- 디버그 로그 섹션 -->
    <div class="debug-log-section" id="debugLogSection" style="position: fixed; bottom: 20px; right: 20px; width: 400px; max-height: 300px; background: rgba(0, 0, 0, 0.9); color: #0f0; border-radius: 8px; padding: 15px; font-family: 'Courier New', monospace; font-size: 11px; z-index: 10000; overflow-y: auto; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #0f0; padding-bottom: 5px;">
            <div style="font-weight: bold; color: #0f0;">🐛 디버그 로그</div>
            <div style="display: flex; gap: 5px;">
                <button onclick="clearDebugLog()" style="background: #333; color: #0f0; border: 1px solid #0f0; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;">지우기</button>
                <button onclick="toggleDebugLog()" style="background: #333; color: #0f0; border: 1px solid #0f0; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;">숨기기</button>
            </div>
        </div>
        <div id="debugLogContent" style="line-height: 1.4;"></div>
    </div>
</body>
</html>
