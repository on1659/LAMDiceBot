# 업데이트 내역

## 📅 2025-12-09 업데이트 (애드센스 승인을 위한 정책 페이지 추가 및 참여자 정보 복원 개선)

### 주요 변경사항

#### 1. 애드센스 승인을 위한 정책 및 콘텐츠 페이지 추가
- **헤더 및 푸터 추가**
  - 페이지 상단에 네비게이션 헤더 추가
  - "다양한 주사위 규칙", "확률 분석 및 팁", "사이트 소개" 링크 포함
  - 페이지 하단에 푸터 추가
  - "개인정보 처리방침", "이용 약관", "문의하기" 링크 포함

- **정책 페이지 생성**
  - `privacy-policy.html`: 개인정보 처리방침 (실제 서비스에 맞게 간소화)
  - `terms-of-service.html`: 이용 약관
  - `contact.html`: 문의하기 (FAQ 포함)

- **콘텐츠 페이지 생성** (각 500단어 이상)
  - `dice-rules-guide.html`: 다양한 주사위 규칙 가이드
  - `probability-analysis.html`: 확률 분석 및 전략 팁
  - `about-us.html`: 사이트 소개 (공정성 보장, 신뢰도 강조)

#### 2. 새로고침 시 참여자 정보 복원 개선
- **서버에 누적 참여자 정보 저장**
  - `everPlayedUsers` 필드 추가 (방에 입장한 후 한번이라도 게임에 참여한 사람 목록)
  - 게임 시작 시 `gamePlayers`를 `everPlayedUsers`에 누적 저장
  - 새로고침 후에도 참여자 정보가 정확하게 표시됨

- **클라이언트에서 서버 정보 복원**
  - `initializeGameScreen`에서 서버의 `everPlayedUsers` 복원
  - 중복 로직 제거 (서버에서 이미 누적 관리)

### 기술적 변경사항

#### 서버 측 (server.js)
- `createRoomGameState()`에 `everPlayedUsers: []` 필드 추가
- `startGame` 이벤트에서 게임 시작 시 `gamePlayers`를 `everPlayedUsers`에 누적 추가
- `roomCreated`, `roomJoined`, `currentRoomInfo` 이벤트에 `everPlayedUsers` 전송

#### 클라이언트 측 (dice-game-multiplayer.html)
- 헤더 네비게이션 추가 (게임 섹션 상단)
- 푸터 추가 (게임 섹션 하단)
- `initializeGameScreen`에서 서버의 `everPlayedUsers` 복원
- 중복 로직 제거 (서버에서 이미 누적 관리)

#### 정책 페이지 (privacy-policy.html)
- 실제 서비스에 맞게 간소화
- 세션 종료 시 삭제 관련 내용 제거
- 개인정보 보호책임자 및 안전성 확보 조치 항목 제거
- 간단한 문의 안내로 대체

### UX 개선
- 애드센스 승인 요구사항 충족
- 사용자가 정책 및 콘텐츠 페이지에 쉽게 접근 가능
- 새로고침 후에도 참여자 정보가 정확하게 표시됨

### 수정된 파일
- server.js
- dice-game-multiplayer.html
- privacy-policy.html (신규)
- terms-of-service.html (신규)
- contact.html (신규)
- dice-rules-guide.html (신규)
- probability-analysis.html (신규)
- about-us.html (신규)
- CHANGELOG.md
- COMMIT_MESSAGE.txt

---

## 📅 2025-12-04 업데이트 (사다리타기 게임 제거 및 기록 관리 개선)

### 주요 변경사항

#### 1. 사다리타기 게임 완전 제거
- **사다리타기 게임 기능 제거**
  - `ladder-game-multiplayer.html` 파일 삭제
  - 서버에서 사다리타기 관련 라우트 및 이벤트 핸들러 제거
  - 클라이언트에서 사다리타기 게임 타입 선택 UI 제거
  - 주사위 게임만 지원하도록 단순화

#### 2. 하이/로우 게임 애니메이션 중복 저장 버그 수정
- **애니메이션 중복 저장 문제 해결**
  - 하이/로우/니어 애니메이션이 실행될 때 기록이 두 번 저장되던 문제 수정
  - 애니메이션이 있는 경우 즉시 저장하지 않고 애니메이션 완료 후에만 저장
  - 마지막 굴리는 사람과 동일한 로직으로 처리

#### 3. 연습 기록과 게임 기록 관리 개선
- **게임 시작 시 기록 초기화**
  - 게임 시작 시 이전 게임 기록(`isGameActive === true`) 모두 삭제
  - 연습 기록(`isGameActive === false`)은 유지
  - 새로운 게임 기록만 표시

- **게임 종료 후 기록 관리**
  - 게임 종료 후에도 게임 기록 유지 (연습으로 바뀌지 않음)
  - 게임 종료 후 연습 기록 추가 방지
  - 게임 종료 후 연습 기록 표시 안 함

- **연습 기록 표시 조건**
  - 최초 방 입장 시에만 연습 기록 표시
  - 게임 데이터 삭제 후에만 연습 기록 표시
  - 게임이 한 번이라도 시작된 후에는 연습 기록 표시 안 함

### 기술적 변경사항

#### 서버 측 (server.js)
- `/ladder` 라우트 제거
- `ladderData` 필드 제거 (`createRoomGameState`)
- `createLadder`, `startLadderAnimation` 이벤트 핸들러 제거
- `roomCreated`, `roomJoined`, `currentRoomInfo`에서 `ladderData` 전송 제거
- `gameType` 검증에서 `ladder` 제거 (항상 `'dice'`로 설정)
- 문법 오류 수정: `isNotReㅈady` → `isNotReady`
- `if` 문 중괄호 추가

#### 클라이언트 측 (dice-game-multiplayer.html)
- **사다리타기 관련 코드 제거**
  * 게임 타입 선택 UI 제거
  * `roomCreated`, `roomJoined`에서 ladder 리다이렉트 로직 제거
  * 방 목록에서 ladder 배지 표시 제거
  * `finalizeRoomCreation`에서 `gameType` 변수 제거 (항상 `'dice'` 전송)

- **기록 관리 로직 개선**
  * `gameStarted` 이벤트: 이전 게임 기록 삭제
  * `diceRolled` 이벤트: 게임 종료 후 연습 기록 추가 방지
  * `renderHistory` 함수: 게임 종료 후 게임 기록만 표시
  * 하이/로우/니어 애니메이션 시 중복 저장 방지

### 버그 수정
- 하이/로우/니어 애니메이션 실행 시 기록이 두 번 저장되던 문제 해결
- 서버 문법 오류 수정 (`isNotReㅈady` 오타)
- 게임 종료 후 연습 기록이 표시되던 문제 해결
- 게임 시작 시 이전 게임 기록이 남아있던 문제 해결

### 사용자 경험 개선
- 게임 시작 시 깨끗한 상태로 시작 (이전 게임 기록 삭제)
- 게임 종료 후에도 게임 기록 유지로 결과 확인 용이
- 연습 기록과 게임 기록의 구분이 명확해짐

---

## 📅 2025-11-26 업데이트 (호스트 드래그 안내 멘트 추가 및 방장 준비 상태 표시 개선)

### 주요 변경사항

#### 1. 호스트 드래그 안내 멘트 추가
- **접속자 섹션에 드래그 안내 멘트 표시**
  - 호스트일 때만 "👥 접속자" 텍스트 옆에 "💡 드래그로 준비 시킬 수 있습니다." 안내 멘트 표시
  - 게임 진행 중이 아닐 때만 표시
  - 참여자에게는 안내 멘트가 표시되지 않음

#### 2. 방장 준비 상태 표시 개선
- **방 생성 시 호스트 자동 준비 상태 추가**
  - 방 생성 시 호스트가 자동으로 준비 상태로 추가됨
  - 준비한 사람 목록에 방장이 표시됨
  - readyUsers 배열 초기화 및 관리 로직 개선

#### 3. 드래그 앤 드롭 기능 개선
- **준비 취소 기능 개선**
  - 준비한 사람을 드래그하여 준비 섹션 밖으로 드롭하면 준비 취소
  - 접속자 섹션으로 다시 드롭할 필요 없이 밖으로만 드롭하면 취소 가능

### 기술적 변경사항

#### 서버 측 (server.js)
- 방 생성 시 호스트를 readyUsers 배열에 자동 추가
- readyUsers 배열 초기화 확인 로직 추가
- roomCreated 이벤트에서 readyUsers 및 isReady 상태 전송
- setUserReady 이벤트 핸들러 추가 (호스트가 다른 사용자의 준비 상태 설정)
- 디버깅 로그 추가 (방 생성 시 readyUsers 확인)

#### 클라이언트 측 (dice-game-multiplayer.html)
- **HTML 구조 추가**
  * 접속자 섹션 제목에 드래그 안내 멘트 추가 (`dragHint` 요소)
  * 기본적으로 숨김 처리 (`display: none`)

- **JavaScript 로직 추가**
  * `updateHostUI()` 함수에 드래그 안내 멘트 표시/숨김 로직 추가
  * `updateUsers()` 함수에 드래그 안내 멘트 업데이트 로직 추가
  * 게임 시작/종료 시 드래그 안내 멘트 표시 상태 업데이트
  * `readyUsersUpdated` 이벤트에서 준비 섹션 표시 로직 추가

- **드래그 앤 드롭 개선**
  * 전역 `drop` 이벤트 리스너 추가
  * 준비한 사람을 준비 섹션 밖으로 드롭하면 준비 취소
  * `window.draggedReadyUser` 및 `window.droppedInReadySection` 변수로 드래그 상태 추적

### UX 개선
- 호스트에게 드래그 기능을 명확하게 안내하여 사용성 향상
- 방 생성 시 방장이 자동으로 준비 상태로 표시되어 직관적
- 준비 취소 기능이 더 간단하고 직관적으로 개선

---

## 📅 2025-11-26 업데이트 (게임 룰 선택 라디오 버튼 기능 추가)

### 주요 변경사항

#### 1. 게임 룰 선택 UI 추가
- **방 생성 후 게임 섹션에서 방장만 게임 룰 선택 가능**
  - 방 생성 시 게임 룰 선택 제거 (방 생성 후 설정하도록 변경)
  - 게임 섹션에서 방장만 게임 룰 선택 라디오 버튼 표시
  - 참여자는 선택된 룰만 읽기 전용으로 표시
  - 게임 시작 전에만 룰 수정 가능

- **게임 룰 옵션**
  - **하이**: 낮은 사람이 걸림
  - **로우**: 높은 사람이 걸림
  - **니어**: N에 가까운 사람 걸리기 (숫자 입력 필드 포함)
  - **기타**: 직접 룰 적기 (텍스트 영역 포함)

#### 2. 저장 버튼 유효성 검사
- **니어 선택 시**: 숫자를 입력하지 않으면 저장 버튼 비활성화
- **기타 선택 시**: 텍스트를 입력하지 않으면 저장 버튼 비활성화
- **실시간 업데이트**: 입력 시 실시간으로 저장 버튼 상태 업데이트
- **저장 시 검증**: 저장 버튼 클릭 시 니어/기타 입력 여부 재확인

#### 3. 룰 텍스트 자동 생성
- 라디오 버튼 선택에 따라 룰 텍스트 자동 생성
- 기존 룰 텍스트를 파싱하여 라디오 버튼 자동 선택
- 니어 선택 시 숫자 입력 필드 자동 표시/숨김
- 기타 선택 시 텍스트 영역 자동 표시/숨김

### 기술적 변경사항

#### 서버 측 (server.js)
- 방 생성 시 `gameRules` 파라미터 제거 (방 생성 후 설정하도록 변경)
- 방 생성 시 `gameRules`는 빈 문자열로 시작
- `roomCreated` 이벤트에 `gameRules` 포함하여 전송

#### 클라이언트 측 (dice-game-multiplayer.html)
- **방 생성 섹션**
  * 게임 룰 선택 UI 제거 (방 생성 후 설정하도록 변경)

- **게임 섹션**
  * 게임 룰 선택 라디오 버튼 섹션 추가 (방장만 표시)
  * 라디오 버튼 선택에 따라 룰 텍스트 자동 생성 함수 추가 (`updateGameRuleFromRadio`)
  * 룰 텍스트 파싱 함수 추가 (`parseGameRulesToRadio`)
  * 저장 버튼 활성화/비활성화 함수 추가 (`updateGameRulesSaveButtonState`)
  * 니어 선택 시 숫자 입력 필드 표시/숨김
  * 기타 선택 시 텍스트 영역 표시/숨김

- **이벤트 리스너**
  * 라디오 버튼 변경 시 룰 텍스트 업데이트 및 저장 버튼 상태 확인
  * 니어 숫자 입력 시 실시간 업데이트
  * 기타 룰 입력 시 실시간 업데이트

- **유효성 검사**
  * 저장 버튼 클릭 시 니어/기타 입력 여부 재확인
  * 입력이 없으면 알림 표시 및 포커스 이동

### UX 개선
- 방 생성 시 복잡한 설정 제거로 사용자 경험 개선
- 방 생성 후 필요에 따라 룰 설정 가능
- 니어/기타 선택 시 필수 입력 안내 (저장 버튼 비활성화)
- 방장만 룰 수정 가능하여 권한 관리 명확화
- 참여자는 선택된 룰만 확인하여 간단한 UI 제공

### 사용자 경험 개선
- 방 생성 과정이 더 간단해짐
- 방 생성 후 필요에 따라 룰을 설정할 수 있어 유연성 향상
- 니어/기타 선택 시 저장 버튼이 비활성화되어 필수 입력을 명확히 안내
- 방장과 참여자의 UI가 구분되어 역할이 명확함

---

## 📅 2025-11-18 업데이트 (대기실 통계 기능 추가 및 게임 자동 종료 개선)

### 주요 변경사항

#### 1. 대기실 통계 기능 추가
- **오늘의 주사위 통계 표시**
  - 대기실 우상단에 오늘의 주사위 굴린 횟수와 평균값 표시
  - 모든 방에서 진행된 공식전 기록을 집계하여 표시
  - 공식전만 포함 (연습 제외)
  - 실시간 업데이트 (주사위를 굴릴 때마다 자동 갱신)

- **방 삭제 후에도 기록 유지**
  - 전역 저장소(`todayDiceRecords`) 추가
  - 방이 삭제되어도 오늘 날짜의 공식전 기록이 유지됨
  - 방 삭제 시 기록을 전역 저장소에 저장

- **주사위 범위 정규화**
  - 주사위 범위가 100이 아닐 때 1~100 범위로 정규화하여 평균 계산
  - 다양한 범위의 주사위 결과를 일관된 기준으로 비교 가능

#### 2. 게임 자동 종료 기능
- **모든 참여자가 주사위를 굴리면 자동 종료**
  - 모든 참여자가 주사위를 굴렸을 때 자동으로 게임 종료
  - 수동으로 게임 종료 버튼을 누를 필요 없음

- **게임 종료 시 팝업 제거**
  - 게임 종료 시 결과를 보여주는 팝업 제거
  - 결과는 게임 기록에서만 확인 가능

### 기술적 변경사항

#### 서버 측 (server.js)
- **오늘의 주사위 통계 계산 함수 추가**
  * `getTodayDiceStats()` 함수 추가
  * 전역 저장소와 현재 존재하는 방의 기록을 모두 집계
  * 공식전(`isGameActive === true`) 기록만 필터링
  * 주사위 범위 정규화 함수 `normalizeTo100()` 추가

- **전역 저장소 추가**
  * `todayDiceRecords` 배열 추가 (방이 삭제되어도 기록 유지)
  * 방 삭제 시 오늘 날짜의 공식전 기록을 전역 저장소에 저장
  * 중복 저장 방지 로직 추가

- **주사위 기록에 날짜 및 게임 상태 추가**
  * `date` 필드 추가 (YYYY-MM-DD 형식)
  * `isGameActive` 필드 추가 (게임 진행 중일 때 굴린 주사위인지 표시)

- **게임 시작 시 history 초기화 제거**
  * 게임 시작 시 `gameState.history = []` 제거
  * 누적 기록 유지로 통계 계산 가능

- **자동 게임 종료 기능**
  * 모든 참여자가 주사위를 굴렸을 때 자동으로 게임 종료
  * `allPlayersRolled` 이벤트 발생 시 게임 종료 처리

- **통계 조회 이벤트 추가**
  * `getTodayDiceStats` 이벤트 핸들러 추가
  * 주사위를 굴릴 때마다 통계 업데이트

#### 클라이언트 측 (dice-game-multiplayer.html)
- **대기실 통계 표시 영역 추가**
  * 대기실 우상단에 통계 표시 영역 추가
  * 통계 요청 및 표시 함수 추가
  * 방 목록 새로고침 시 통계도 함께 업데이트

- **게임 시작 시 history 초기화 제거**
  * 게임 시작 시 `historyData = []` 제거
  * `renderHistory` 함수에서 게임 진행 중일 때 현재 게임의 기록만 필터링해서 표시

- **게임 종료 시 팝업 제거**
  * 게임 종료 시 결과를 보여주는 `alert` 팝업 제거
  * 결과는 게임 기록에서만 확인 가능

### 버그 수정
- 주사위를 1회 굴리면 카운트가 2씩 늘어나던 문제 해결 (중복 저장 제거)
- 방이 삭제되면 통계에서 기록이 사라지던 문제 해결 (전역 저장소 추가)

### 사용자 경험 개선
- 대기실에서 오늘의 주사위 통계를 한눈에 확인 가능
- 모든 참여자가 주사위를 굴리면 자동으로 게임 종료되어 편의성 향상
- 게임 종료 시 팝업이 없어져 더 깔끔한 사용자 경험 제공

---

## 📅 2025-11-19 업데이트 (방 유지 조건 개선 및 새로고침 시 데이터 복원)

### 주요 변경사항

#### 1. 방 유지 조건 개선
- **모든 사용자가 나가도 방 유지**
  - 기존: 모든 사용자가 나가면 방이 즉시 삭제됨
  - 변경: 모든 사용자가 나가도 방은 지정된 시간(1/3/6시간)까지 유지됨
  - 서버가 1분마다 체크하여 시간 경과 시 자동 삭제
  - 사용자가 모두 나간 후에도 다시 입장 가능

- **방장 정보 초기화**
  - 모든 사용자가 나가면 방장 정보(`hostId`, `hostName`) 초기화
  - 빈 방에 첫 번째 입장자를 자동으로 방장으로 설정
  - 재입장 시에도 방장 권한이 올바르게 전달됨

#### 2. 새로고침 시 데이터 복원 개선
- **브라우저 캐시 방지**
  - HTML 파일에 캐시 방지 메타 태그 추가
  - 서버에서 정적 파일 제공 시 캐시 방지 헤더 설정
  - 새로고침 시 항상 최신 데이터 로드

- **진행 상황 복원**
  - 방 입장 시 `rolledUsersInGame` 복원
  - 게임 진행 중일 때 진행 상황(굴린 인원/전체 인원) 표시
  - 재연결 시에도 진행 상황 업데이트

- **채팅 기록 복원**
  - 재연결 시 채팅 기록 전송 추가
  - 방 입장 시 채팅 기록 복원 로직 개선
  - 주사위 결과가 포함된 채팅도 함께 복원

### 기술적 변경사항

#### 서버 측 (server.js)
- **방 나가기 로직 수정**
  * 모든 사용자가 나가도 방 삭제하지 않고 유지
  * 방장 정보 초기화 (`room.hostId = null`, `room.hostName = null`)
  * `leaveRoom` 함수와 `disconnect` 이벤트 모두 수정

- **방 입장 로직 개선**
  * 빈 방에 첫 입장자를 자동으로 방장으로 설정
  * `isEmptyRoom` 체크 추가하여 빈 방 처리
  * 재연결 시에도 채팅 기록 전송

- **캐시 방지 헤더 추가**
  * 정적 파일 제공 시 HTML 파일에 캐시 방지 헤더 설정
  * 메인 라우트(`/`, `/ladder`)에도 캐시 방지 헤더 추가

- **에러 수정**
  * `userName` const 재할당 에러 수정 (`inputUserName`으로 변경)

#### 클라이언트 측 (dice-game-multiplayer.html)
- **캐시 방지 메타 태그 추가**
  * `Cache-Control`, `Pragma`, `Expires` 메타 태그 추가

- **진행 상황 복원 로직 추가**
  * 방 입장 시 `rolledUsersInGame` 복원
  * 게임 진행 중일 때 진행 상황 업데이트
  * 재연결 시에도 진행 상황 업데이트

- **채팅 기록 복원 로직 개선**
  * 채팅 기록을 항상 초기화하고 표시
  * 채팅 기록이 없어도 빈 상태 메시지 표시
  * DOM 요소 존재 여부 확인 후 처리

### 버그 수정
- 새로고침 시 진행 상황이 0/0으로 표시되던 문제 해결
- 새로고침 시 채팅 기록이 사라지던 문제 해결
- 새로고침 시 주사위를 굴린 사람이 반영되지 않던 문제 해결
- `userName` const 재할당 에러 수정

### 사용자 경험 개선
- 방이 일시적으로 비어도 다시 입장 가능
- 새로고침 후에도 게임 상태가 정확하게 표시됨
- 채팅 기록이 유지되어 대화 흐름 파악 용이
- 진행 상황이 정확하게 표시되어 게임 진행 상황 파악 용이

---

## 📅 2025-11-17 업데이트 (하이/로우 게임 애니메이션 조건 수정)

### 주요 변경사항

#### 1. 하이/로우 게임 애니메이션 조건 수정
- **하이 게임 애니메이션 조건 변경**
  - 기존: 지금까지 결과 중 최고값보다 클 때 애니메이션
  - 변경: 지금까지 결과 중 제일 작은 값이 나왔을 때 애니메이션
  - 최저값보다 작은 값이 나오면 애니메이션 실행

- **로우 게임 애니메이션 조건 변경**
  - 기존: 지금까지 결과 중 최저값보다 작을 때 애니메이션
  - 변경: 지금까지 결과 중 제일 큰 값이 나왔을 때 애니메이션
  - 최고값보다 큰 값이 나오면 애니메이션 실행

#### 2. 애니메이션 활성화 조건 완화
- **참여자 조건 변경**
  - 기존: 참여자 5명 이상일 때만 애니메이션 활성화
  - 변경: 참여자 4명 이상일 때 애니메이션 활성화

- **굴림 순서 조건 변경**
  - 기존: 6번째 굴림 이후부터 애니메이션 활성화
  - 변경: 4번째 굴림 이후부터 애니메이션 활성화

### 기술적 변경사항

#### 서버 측 (server.js)
- `isHighGameAnimation` 조건 수정
  * 최고값 비교 → 최저값 비교로 변경
  * `result > maxRoll` → `result < minRoll`로 변경
  * 참여자 조건: `>= 5` → `>= 4`로 변경
  * 굴림 순서: `rolledUsers.length >= 5` → `>= 3`로 변경

- `isLowGameAnimation` 조건 수정
  * 최저값 비교 → 최고값 비교로 변경
  * `result < minRoll` → `result > maxRoll`로 변경
  * 참여자 조건: `>= 5` → `>= 4`로 변경
  * 굴림 순서: `rolledUsers.length >= 5` → `>= 3`로 변경

- `isNearGameAnimation` 조건 수정
  * 참여자 조건: `>= 5` → `>= 4`로 변경
  * 굴림 순서: `rolledUsers.length >= 5` → `>= 3`로 변경

### 버그 수정
- 하이 게임과 로우 게임의 애니메이션 조건이 반대로 되어 있던 문제 해결
- 하이 게임에서 최고값이 나올 때 애니메이션이 실행되던 문제 → 최저값이 나올 때 실행되도록 수정
- 로우 게임에서 최저값이 나올 때 애니메이션이 실행되던 문제 → 최고값이 나올 때 실행되도록 수정

### 사용자 경험 개선
- 하이 게임: 가장 작은 값이 나왔을 때 애니메이션으로 더 명확한 피드백 제공
- 로우 게임: 가장 큰 값이 나왔을 때 애니메이션으로 더 명확한 피드백 제공
- 참여자 4명 이상, 4번째 굴림부터 애니메이션 활성화로 더 빠른 피드백 제공

---

## 📅 최신 업데이트 (IP 중복 체크 및 MAC 주소 체크 개선)

### 주요 변경사항

#### 1. IP 중복 체크 로직 강화
- **IP 추출 로직 개선**
  - IPv6-mapped IPv4 주소 처리 추가
  - 프록시/로드밸런서 환경에서 IP 추출 정확도 향상
  - 다양한 소켓 속성에서 IP 주소 추출 시도 (handshake.address, request.connection.remoteAddress 등)
  - 로컬 테스트 환경(::1) IPv6 주소를 IPv4로 변환

- **방 생성 시 IP 체크 추가**
  - 기존: 방 입장 시에만 IP 체크
  - 변경: 방 생성 시에도 IP/deviceId 중복 체크 수행
  - 다른 방에 이미 입장한 경우 방 생성 차단
  - 모든 소켓을 확인하여 같은 IP/deviceId를 가진 사용자 검색

- **방 입장 시 IP 체크 개선**
  - 기존: 같은 방 내에서만 IP 체크
  - 변경: 모든 방에서 IP/deviceId 중복 체크
  - deviceId가 있으면 IP와 deviceId 모두 확인
  - deviceId가 없으면 IP만 확인

- **getCurrentRoom 핸들러에도 IP 체크 추가**
  - 재연결 시에도 IP/deviceId 중복 체크 수행
  - 같은 이름은 재연결로 간주하여 허용

- **디버깅 로그 추가**
  - IP 체크가 작동할 때 콘솔에 상세 로그 출력
  - IP 주소, deviceId, 기존 사용자 정보 등 기록

### 기술적 변경사항

#### 서버 측 (server.js)
- `getClientIP()` 함수 개선
  * IPv6-mapped IPv4 주소 처리 (`::ffff:` 제거)
  * 프록시 헤더(`x-forwarded-for`) 우선 처리
  * 다양한 소켓 속성에서 IP 추출 시도
  * 로컬 테스트 환경 IPv6 주소 변환

- `createRoom` 핸들러 수정
  * IP 차단 옵션이 활성화된 경우 방 생성 전 IP/deviceId 체크
  * `io.fetchSockets()`로 모든 소켓 확인
  * 같은 IP/deviceId를 가진 사용자가 다른 방에 있으면 방 생성 차단

- `joinRoom` 핸들러 수정
  * 모든 방에서 IP/deviceId 중복 체크 (같은 방뿐만 아니라)
  * `io.fetchSockets()`로 모든 소켓 확인
  * 같은 방/다른 방 구분하여 에러 메시지 제공

- `getCurrentRoom` 핸들러 수정
  * IP 차단 옵션이 활성화된 경우 IP/deviceId 체크 추가
  * 같은 이름은 재연결로 간주하여 허용
  * 다른 이름으로 중복 접속 시 차단

- 소켓 연결 시 IP 주소 로깅 추가
  * 각 소켓 연결 시 IP 주소와 socket.id를 콘솔에 출력

### 버그 수정
- IP 추출이 제대로 되지 않던 문제 해결
- 방 생성 시 IP 체크가 작동하지 않던 문제 해결
- 방 입장 시 다른 방에서의 중복 체크가 작동하지 않던 문제 해결

### 사용자 경험 개선
- IP 차단 옵션이 활성화된 방에서 더 정확한 중복 접속 방지
- 방 생성 시에도 IP 체크가 작동하여 일관성 있는 보안 정책 적용
- 명확한 에러 메시지로 사용자에게 상황 안내

---

## 📅 2025-11-11 업데이트

### 주요 변경사항

#### 1. IP 중복 체크 방식 개선
- **IP + 기기 식별 정보 조합 체크**
  - 기존: IP 주소만으로 중복 체크 (같은 회사 내 다른 PC도 차단됨)
  - 변경: IP 주소가 같을 때 기기 식별 정보(PC 이름)도 함께 확인
  - 같은 IP를 사용하는 다른 PC에서도 접속 가능하도록 개선
  - 브라우저 정보(userAgent, platform, screen size, timezone 등)를 조합하여 기기 식별 ID 생성

- **기기 식별 정보 수집**
  - 클라이언트에서 브라우저 정보를 수집하여 기기 식별 ID 생성
  - 서버에서 IP와 기기 식별 정보를 함께 저장 및 비교
  - 같은 IP + 같은 기기 = 중복 접속으로 차단
  - 같은 IP + 다른 기기 = 허용 (같은 회사 내 다른 PC)

#### 2. 채팅 스크롤 동작 개선
- **스마트 스크롤 기능 추가**
  - 기존: 새 메시지가 오면 항상 맨 아래로 자동 스크롤
  - 변경: 사용자가 위로 스크롤해 있을 때는 자동 스크롤하지 않음
  - 스크롤이 맨 아래에 있을 때만 새 메시지가 오면 자동 스크롤
  - 사용자가 직접 메시지를 보낼 때는 항상 맨 아래로 스크롤

### 기술적 변경사항

#### 클라이언트 측 (ladder-game-multiplayer.html, dice-game-multiplayer.html)
- `getDeviceId()` 함수 추가
  * 브라우저 정보를 조합하여 기기 식별 ID 생성
  * userAgent, platform, hardwareConcurrency, screen size, language, timezone 등 활용
  * 간단한 해시 함수로 고유 ID 생성

- `joinRoom` 이벤트 수정
  * `deviceId` 파라미터 추가하여 서버로 전송
  * `getCurrentRoom` 이벤트에도 `deviceId` 포함

- `displayChatMessage()` 함수 수정
  * `forceScroll` 파라미터 추가 (필요 시 강제 스크롤)
  * 스크롤이 맨 아래에 있는지 확인하는 로직 추가 (`isScrolledToBottom`)
  * 조건부 스크롤: 스크롤이 맨 아래에 있거나 강제 스크롤일 때만 스크롤

- `sendChatMessage()` 함수 수정
  * 사용자가 메시지를 보낼 때는 항상 맨 아래로 스크롤하도록 수정

#### 서버 측 (server.js)
- 소켓 연결 시 `deviceId` 필드 추가
  * 각 소켓에 `deviceId` 저장 필드 추가

- `joinRoom` 핸들러 수정
  * `deviceId` 파라미터 받아서 `socket.deviceId`에 저장
  * IP 체크 로직 개선:
    - IP가 같은 사용자 찾기
    - IP가 같으면 기기 식별 정보(`deviceId`)도 같은지 확인
    - 같은 IP + 같은 기기 = 중복 접속으로 차단
    - 같은 IP + 다른 기기 = 허용
  * `deviceId`가 없으면 기존 방식대로 IP만 체크

- `getCurrentRoom` 핸들러 수정
  * `deviceId` 파라미터 받아서 저장

### UI 개선
- 채팅창에서 이전 메시지를 읽는 중에도 새 메시지가 와도 스크롤 위치 유지
- 사용자가 메시지를 보낼 때는 항상 최신 메시지 확인 가능

### 사용자 경험 개선
- 같은 회사 내 다른 PC에서도 정상적으로 접속 가능
- 채팅창에서 이전 메시지를 읽는 중 방해받지 않음
- 더 정확한 중복 접속 방지

---

## 📅 2025-11-10 업데이트

### 주요 변경사항

#### 1. 주문 리스트에서 관전자 주문 분리 표시 기능 추가
- **게임 참여자와 관전자 주문 분리**
  - 주문 리스트에서 게임 참여자와 관전자 주문을 분리하여 표시
  - 관전자 주문을 하단에 별도 섹션으로 표시 (👁️ 관전자 주문)
  - 관전자 주문 항목을 약간 투명하게 표시하여 시각적 구분 (opacity: 0.7)
  - 주문 리스트에서 "(관전)" 표시 제거

- **관전자 주문 섹션 안내 문구 추가**
  - 관전자 주문 섹션에 "게임 참여 후 메뉴를 다시 골라주시면됩니다" 안내 문구 추가
  - 관전자가 게임에 참여한 후 주문을 다시 선택할 수 있음을 안내

- **주문 리스트 모달 개선**
  - 모달에서도 게임 참여자와 관전자 주문 분리 표시
  - "=== 게임 참여자 주문 ===" 및 "=== 관전자 주문 ===" 섹션 구분 추가
  - 각 섹션별로 총 메뉴 개수 표시

### 기술적 변경사항

#### 클라이언트 측 (dice-game-multiplayer.html)
- `renderOrders()` 함수 수정
  * 게임 참여자와 관전자 주문을 분리하여 렌더링
  * `everPlayedUsers` 변수 활용: 방에 입장한 후 한번이라도 게임에 참여한 사람 추적
  * 관전자 주문 섹션 HTML 추가 (spectatorOrdersSection, spectatorOrderList)
  * 관전자 주문 항목에 opacity: 0.7 적용하여 시각적 구분

- `showOrderList()` 함수 수정
  * 모달에서도 게임 참여자와 관전자 주문 분리 표시
  * 모달 텍스트에 "=== 게임 참여자 주문 ===" 및 "=== 관전자 주문 ===" 섹션 구분 추가
  * 각 섹션별로 총 메뉴 개수 계산 및 표시

- HTML 구조 추가
  * 관전자 주문 섹션 추가 (spectatorOrdersSection, spectatorOrderList)
  * 관전자 주문 섹션에 구분선 및 제목 추가

### UI 개선
- 주문 리스트에서 "(관전)" 표시 제거로 가독성 향상
- 관전자 주문을 하단에 별도 섹션으로 분리하여 명확한 구분
- 관전자 주문 항목을 약간 투명하게 표시하여 시각적 구분
- 모달에서도 명확하게 게임 참여자와 관전자 주문 구분 표시

---

## 📅 2025-11-11 업데이트

### 주요 변경사항

#### 1. 채팅 기록에 주사위 결과 표시 기능 추가
- **중간 접속자도 이전 주사위 결과 확인 가능**
  - 방에 중간에 입장한 사용자도 이전 채팅 기록과 함께 주사위 결과를 볼 수 있음
  - 서버에서 채팅 메시지와 주사위 결과를 연결하여 저장
  - 채팅 기록 불러올 때 주사위 결과도 함께 표시

- **채팅 기록 저장 개선**
  - 채팅 메시지와 주사위 결과를 함께 저장 (최대 100개)
  - `/주사위` 명령어 메시지에 주사위 결과 정보 자동 연결
  - 시스템 메시지(게임 시작, 모든 참여자 완료 등)도 채팅 기록에 포함

#### 2. PC에서 /주사위 명령어 자동완성 지원
- **PC에서도 자동완성 드롭다운 표시**
  - 기존에는 모바일에서만 자동완성 드롭다운이 표시되었으나, PC에서도 동일하게 작동
  - `/`, `/ㅈ`, `/주`, `/주사` 입력 시 `/주사위` 자동완성 제안 표시
  - Tab 키, 방향키(↑/↓), Enter 키로 자동완성 적용 가능

#### 3. 사다리타기 게임 기능 추가 (준비 중)
- **사다리타기 게임 전용 페이지 추가**
  - `ladder-game-multiplayer.html` 파일 추가
  - 주사위 게임과 독립적인 게임 페이지
  - 준비한 참가자 수에 따라 막대기 자동 생성
  - 참가자 수에 따른 동적 크기 조정
    - 1-3명: 매우 크게 (막대기 간격 150px, 두께 12px)
    - 4-6명: 크게 (막대기 간격 120px, 두께 10px)
    - 7-10명: 중간 (막대기 간격 90px, 두께 8px)
    - 11명 이상: 작게 (막대기 간격 70px, 두께 6px)

- **도착지 텍스트 입력 기능**
  - 각 참가자별 도착지 텍스트 입력 가능
  - 캔버스 아래에 입력창 배치
  - 입력한 텍스트가 캔버스의 네모박스에 표시

- **UI/UX 개선**
  - 채팅 및 준비 상태 UI를 주사위 게임과 동일한 스타일로 통일
  - 귀여운 색상 팔레트 적용 (8가지 색상)
  - 그림자 효과 및 그라데이션 배경
  - 반응형 디자인으로 화면 크기에 맞게 자동 조정

- **로비에서 사다리타기 게임 생성 임시 비활성화**
  - 사다리타기 옵션을 "준비 중" 상태로 표시
  - 방 생성 시 사다리타기 선택 시 경고 메시지 표시

#### 2. 중복 이름 체크 강화
- **재연결 vs 중복 구분 로직 개선**
  - 실제 연결된 socket을 확인하여 중복 체크
  - 재연결 시 기존 사용자 정보 유지
  - 중복 이름 시 명확한 에러 메시지 표시

#### 3. Socket.IO 재연결 로직 개선
- **disconnect 타임아웃 조정**
  - 리다이렉트 시: 5초 대기
  - 일반 disconnect: 3초 대기
  - 재연결 확인 로직 개선 (userName 기반)

### 기술적 변경사항

#### 서버 측 (server.js)
- `chatHistory` 필드 추가 (게임 상태에 채팅 기록 저장, 최대 100개)
- `sendMessage` 이벤트에서 채팅 메시지를 `chatHistory`에 저장
- `requestRoll` 이벤트에서 주사위 결과를 채팅 기록의 `/주사위` 메시지에 연결
- `roomCreated`, `roomJoined`, `getCurrentRoom` 이벤트에서 `chatHistory` 전송
- 시스템 메시지(게임 시작, 모든 참여자 완료)도 `chatHistory`에 저장
- `gameType` 필드 추가 (기본값: 'dice')
- `/ladder` 라우트 추가 (사다리타기 페이지 서빙)
- `createRoom`, `joinRoom` 이벤트에 `gameType` 파라미터 추가
- `getCurrentRoom` 이벤트 추가 (리다이렉트 후 재연결)
- `disconnect` 핸들러에 재연결 대기 로직 추가
- 중복 이름 체크 로직 강화 (실제 연결된 socket 확인)

#### 클라이언트 측
- **dice-game-multiplayer.html**
  - `displayChatMessage` 함수 추가 (채팅 메시지 표시 로직 재사용 가능하도록 분리)
  - `initializeGameScreen` 함수에서 채팅 기록(`chatHistory`) 불러와서 표시
  - 채팅 기록에서 주사위 결과(`diceResult`)가 있으면 자동으로 표시
  - PC에서도 `/주사위` 명령어 자동완성 드롭다운 표시 지원
  - 게임 타입 선택 라디오 버튼 추가
  - 사다리타기 선택 시 `/ladder` 페이지로 리다이렉트
  - 방 목록에 게임 타입 배지 표시
  - 사다리타기 게임 생성 옵션 비활성화

- **ladder-game-multiplayer.html** (신규)
  - `displayChatMessage` 함수 추가 (채팅 메시지 표시 로직 재사용 가능하도록 분리)
  - `roomCreated`, `currentRoomInfo`, `roomJoined` 이벤트에서 채팅 기록(`chatHistory`) 불러와서 표시
  - 사다리타기 게임 전용 페이지
  - 준비 상태에 따른 막대기 동적 생성
  - 도착지 입력 기능
  - 채팅 및 준비 상태 UI 구현
  - 캔버스 기반 사다리 시각화

---

## 📅 2025-11-06 업데이트

### 주요 변경사항

#### 1. 채팅 UI 개선
- **게임 시작 메시지 자동 표시**
  - 게임 시작 시 채팅에 게임 룰 자동 표시
  - 그라디언트 배경(#667eea → #764ba2)과 카드 스타일로 시각적 개선
  - 여러 줄 룰 지원 (중앙 정렬)
  - 시스템 메시지 타입 추가

#### 2. 주사위 결과 표시 최적화
- **/주사위 명령어와 결과를 같은 줄에 표시**
  - Flex 레이아웃으로 명령어와 결과를 한 줄에 배치
  - 주사위 결과를 오른쪽 끝에 정렬
- **기록 저장 여부에 따른 아이콘 표시 차별화**
  - 기록 저장: 🎲 아이콘 + 숫자 (예: 🎲 8)
  - 기록 미저장: 숫자만 표시 (예: 8), 오른쪽 끝 정렬
- **주사위 결과 컨테이너 동적 생성**

#### 3. 게임 기록 저장 로직 개선
- **게임 진행 중 최초 1회만 기록에 저장**
  - `rolledUsersInGame` 배열로 추적
  - 게임이 진행 중이 아니면 모든 주사위 굴림 기록 저장
- **기록에 저장되지 않는 주사위는 채팅에 아이콘 없이 숫자만 표시**

#### 4. 버그 수정
- **주사위를 굴리지 않은 사람 집계 기능 수정**
  - 게임 시작 후 주사위를 굴리지 않은 사람이 올바르게 집계되지 않던 문제 수정
  - `rolledUsers` 배열 추적 로직 개선

### 기술적 변경사항

#### 서버 측 (server.js)
- `startGame` 핸들러에 게임 시작 시스템 메시지 전송 로직 추가
- `gameStartMessage` 객체 생성 및 `newMessage` 이벤트로 전송
- 시스템 메시지 식별을 위한 `isSystemMessage` 플래그 추가

#### 클라이언트 측 (dice-game-multiplayer.html)
- `newMessage` 핸들러에 시스템 메시지 처리 로직 추가
- 게임 시작 메시지 파싱 및 스타일링 (그라디언트, 카드 스타일)
- `/주사위` 명령어 메시지 구조를 flex 레이아웃으로 변경
- `diceRolled` 핸들러에서 주사위 결과 동적 추가 로직 개선
- 기록 저장 여부에 따른 조건부 아이콘 표시
- 주사위 결과 컨테이너 스타일 동적 조정 (오른쪽 끝 정렬)

---

## 📅 2024-12-19 업데이트

### 주요 변경사항

#### 1. UI 구성 개선
- **게임 화면 레이아웃 재구성**
  - 맨 위: 방 제목
  - 두 번째: 게임 룰
  - 세 번째: 주사위 굴리기 명령어 입력 필드
  - 네 번째: 주사위 아이콘
- **주사위 범위 설정 섹션 제거**: 명령어로 대체되어 더 이상 필요 없음

#### 2. 주사위 굴리기 방식 변경
- **버튼 방식 → 채팅 명령어 방식**
  - 기존: "주사위 굴리기" 버튼 클릭
  - 변경: `/주사위 (숫자)` 명령어 입력
  - 예: `/주사위 100` → 1~100 범위에서 주사위 굴림
  - 숫자 없이 `/주사위`만 입력하면 자동으로 100 사용
- **주사위 굴리기 버튼 제거**: 명령어로만 주사위 굴리기 가능
- **주사위 명령어 입력 필드 추가**: 주사위 범위 설정 위치에 추가

#### 3. 주문받기 시스템 개선
- **주문받기 섹션 항상 표시**: 주문받기 종료 후에도 주문 목록과 주문하지 않은 사람 목록 표시
- **주문 목록 항상 업데이트**: 주문받기 상태와 관계없이 주문 목록 표시
- **주문리스트 보기 버튼 항상 표시**: 언제든지 주문리스트 확인 가능

#### 4. 게임 기록 표시 개선
- **범위 표시 간소화**: "1~100" 형식 대신 "100"만 표시 (최대값만)
- **게임 종료 메시지**: 범위 표시 형식 변경

#### 5. 시간 기록 개선
- **UTC+9 (한국 표준시) 적용**: 모든 시간 기록을 Asia/Seoul 타임존으로 변경
  - 주사위 굴리기 기록 시간
  - 채팅 메시지 시간

### 기술적 변경사항

#### 서버 측 (server.js)
- 시간 생성 함수에 `timeZone: 'Asia/Seoul'` 옵션 추가
- 주문 업데이트 시 사용자 이름 검증 로직 개선

#### 클라이언트 측 (dice-game-multiplayer.html)
- 주사위 굴리기 버튼 및 관련 코드 제거
- `/주사위` 명령어 파싱 및 처리 로직 추가
- 주문받기 섹션 표시 로직 개선
- 게임 기록 범위 표시 로직 수정

---

## 📅 최근 업데이트 (GitHub와 비교)

### 통계
- **dice-game-multiplayer.html**: +1,027줄 추가, -119줄 삭제
- **server.js**: +731줄 추가, -119줄 삭제
- **총 변경량**: 약 1,639줄 추가, 238줄 삭제

---

## 🔄 주요 변경사항

### 1. 방(Room) 관리 시스템 도입

#### 서버 측 변경 (server.js)
- **기존**: 단일 전역 게임 상태 관리
- **변경**: 다중 방 지원 시스템으로 전환
  - `rooms` 객체를 통한 방 관리
  - 각 방마다 독립적인 게임 상태(`gameState`) 유지
  - 방 ID 생성 함수 추가 (`generateRoomId()`)
  - 방별 게임 상태 생성 함수 (`createRoomGameState()`)

#### 주요 기능 추가
- **방 생성** (`createRoom` 이벤트)
  - 호스트 이름과 방 제목으로 방 생성
  - 자동 방 ID 할당
  - 방별 게임 상태 초기화
  
- **방 입장** (`joinRoom` 이벤트)
  - 방 ID로 입장
  - 중복 이름 체크
  - 최대 접속자 수 제한 (50명)
  - 재접속 시 상태 복구
  
- **방 나가기** (`leaveRoom` 이벤트)
  - 호스트 나감 시 새 호스트 자동 지정
  - 모든 사용자 나감 시 방 자동 삭제
  - 방 목록 실시간 업데이트

- **방 목록 조회** (`getRooms` 이벤트)
  - 활성화된 모든 방 목록 조회
  - 방 제목, 호스트명, 참여자 수, 게임 상태 정보 제공

---

### 2. UI 변경 (dice-game-multiplayer.html)

#### 새로운 섹션 추가
- **로비 섹션** (`.lobby-section`)
  - 방 목록 표시
  - 방 생성/입장 기능
  
- **방 생성 섹션** (`.create-room-section`)
  - 호스트 이름 입력
  - 방 제목 입력
  - 방 생성 버튼

#### CSS 스타일 추가
- `.rooms-list`: 방 목록 컨테이너 스타일
- `.room-item`: 개별 방 아이템 스타일
  - 호버 효과
  - 활성 상태 표시
  - 내가 만든 방 표시 (`.my-room`)

---

### 3. 서버 측 기능 개선

#### 방 관리 기능
- **호스트 권한 관리**
  - 호스트 전환 기능 (호스트 나감 시 자동)
  - 호스트 권한 확인 로직 강화
  
- **방 제목 변경** (`updateRoomName` 이벤트)
  - 호스트만 방 제목 변경 가능
  - 30자 이하 제한
  
- **실시간 방 목록 업데이트** (`updateRoomsList()`)
  - 방 생성/삭제 시 모든 클라이언트에 알림
  - 게임 상태 변경 시 방 목록 업데이트

#### 게임 상태 관리 개선
- **방별 독립 게임 상태**
  - 각 방의 게임 진행 상황 독립 관리
  - 준비 상태 관리 (`readyUsers`)
  - 게임 참여자 목록 (`gamePlayers`)
  
- **재접속 처리**
  - 사용자 재접속 시 이전 상태 복구
  - 이미 굴린 주사위 결과 유지
  - 준비 상태 유지

---

### 4. 하위 호환성 유지

- **기존 로그인 기능** (`login` 이벤트) 유지
  - 기존 단일 방 모드 지원
  - 전역 `gameState` 유지 (하위 호환성)

---

## 🔧 기술적 개선사항

### 소켓 관리
- 각 소켓에 방 정보 저장
  - `socket.currentRoomId`: 현재 방 ID
  - `socket.userName`: 사용자 이름
  - `socket.isHost`: 호스트 여부

### 에러 처리
- 방 관련 에러 처리 추가
  - `roomError`: 방 관련 일반 에러
  - `permissionError`: 권한 관련 에러
  - `hostTransferred`: 호스트 전환 알림

### Rate Limiting
- 기존 요청 제한 기능 유지 (10초당 50회)
- 모든 새로운 이벤트에 적용

---

## 📝 변경된 이벤트 목록

### 새로 추가된 이벤트
- `getRooms`: 방 목록 조회
- `createRoom`: 방 생성
- `joinRoom`: 방 입장
- `leaveRoom`: 방 나가기
- `updateRoomName`: 방 제목 변경
- `roomsList`: 방 목록 수신
- `roomsListUpdated`: 방 목록 업데이트 알림
- `roomCreated`: 방 생성 성공
- `roomJoined`: 방 입장 성공
- `roomLeft`: 방 나가기 완료
- `roomDeleted`: 방 삭제 알림
- `roomNameUpdated`: 방 제목 변경 알림
- `hostTransferred`: 호스트 전환 알림
- `hostChanged`: 호스트 변경 알림

### 기존 이벤트 유지
- 게임 관련: `startGame`, `endGame`, `requestRoll` 등
- 설정 관련: `updateUserDiceSettings`, `updateGameRules` 등
- 주문 관련: `startOrder`, `endOrder`, `updateOrder` 등
- 채팅 관련: `sendMessage`
- 메뉴 관련: `addFrequentMenu`, `deleteFrequentMenu` 등

---

## 🎯 주요 개선 효과

1. **다중 게임 세션 지원**: 여러 방에서 동시에 게임 진행 가능
2. **독립적인 게임 상태**: 각 방의 게임 상태가 서로 영향받지 않음
3. **향상된 사용자 경험**: 방 선택 및 입장/나가기 기능 제공
4. **확장성 향상**: 향후 방 검색, 비밀번호 기능 등 추가 용이

---

## ⚠️ 주의사항

- 기존 단일 방 모드(`login` 이벤트)는 여전히 지원되지만, 새로운 방 시스템을 사용하는 것을 권장합니다
- 방 생성 시 방 ID가 자동 생성되며, 이 ID로 방에 입장할 수 있습니다
- 호스트가 나가면 자동으로 새 호스트가 지정됩니다
- 모든 사용자가 나가면 방이 자동으로 삭제됩니다

