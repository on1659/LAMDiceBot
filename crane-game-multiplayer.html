<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Google AdSense -->
    <meta name="google-adsense-account" content="ca-pub-1608259764663412">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1608259764663412" crossorigin="anonymous"></script>
    <title>LAM Crane Game ğŸª„</title>

    <!-- FOUC Prevention: Always use light theme -->
    <script>
      (function() {
        // Always use light mode regardless of system preference
        document.documentElement.setAttribute('data-theme', 'light');
      })();
    </script>

    <!-- Theme Variables -->
    <link rel="stylesheet" href="/css/theme.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Yeon+Sung&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--crane-gradient);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            position: relative;
        }

        .container {
            background: var(--bg-white);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px auto;
        }

        body.game-active .container {
            margin-left: calc((100vw - 1140px) / 2 + 160px);
            margin-right: auto;
            max-width: 800px;
        }

        body.game-active header,
        body.game-active footer {
            display: none;
        }

        h1 {
            text-align: center;
            color: var(--crane-accent);
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .game-section {
            display: none;
        }

        .game-section.active {
            display: block;
        }

        button {
            background: linear-gradient(135deg, var(--crane-accent) 0%, var(--crane-600) 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(156, 39, 176, 0.3);
        }

        button:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--gray-300);
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 10px;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus, input[type="password"]:focus {
            border-color: var(--crane-accent);
            outline: none;
        }

        .connection-status {
            text-align: center;
            padding: 5px;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .connection-status.connected {
            color: var(--green-500);
        }

        .connection-status.disconnected {
            color: var(--red-500);
        }

        .connection-sound-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .connection-sound-row label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
        }
        .connection-sound-row input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        .volume-control {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-secondary);
        }
        .volume-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 2px 4px;
            border-radius: 4px;
            transition: background 0.2s;
            width: auto;
        }
        .volume-btn:hover {
            background: rgba(0,0,0,0.1);
        }
        .volume-slider {
            width: 60px;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--gray-300);
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: var(--crane-accent);
            border-radius: 50%;
            cursor: pointer;
        }
        .volume-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: var(--crane-accent);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        .volume-slider.muted {
            opacity: 0.5;
        }

        /* í¬ë ˆì¸ ë¨¸ì‹  ì»¨í…Œì´ë„ˆ */
        .crane-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .crane-machine {
            position: relative;
            width: 100%;
            max-width: 500px;
            height: 500px;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            border: 4px solid var(--crane-accent);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(156, 39, 176, 0.3), inset 0 0 20px rgba(0, 0, 0, 0.3);
            margin: 20px auto;
        }

        .crane-rail {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            height: 8px;
            background: linear-gradient(90deg, #666, #999, #666);
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .crane-assembly {
            position: absolute;
            top: 28px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 9;
            transition: left 1s ease-in-out;
        }

        .crane-arm {
            width: 6px;
            height: 40px;
            background: linear-gradient(180deg, #bbb, #888);
            border-radius: 3px;
            transition: height 0.8s ease-in-out;
        }

        .crane-fingers-wrapper {
            display: flex;
            gap: 12px;
            transition: gap 0.4s ease-in-out;
        }

        .crane-finger {
            width: 4px;
            height: 30px;
            background: linear-gradient(180deg, #999, #666);
            border-radius: 0 0 3px 3px;
            position: relative;
        }

        .crane-finger::after {
            content: '';
            position: absolute;
            bottom: 0;
            width: 10px;
            height: 10px;
            background: var(--gray-500);
            border-radius: 50%;
        }

        .crane-finger:first-child::after {
            right: -3px;
        }

        .crane-finger:last-child::after {
            left: -3px;
        }

        .crane-glass {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 80px;
            background: rgba(255, 255, 255, 0.03);
            border-bottom: 3px solid rgba(156, 39, 176, 0.5);
            pointer-events: none;
            z-index: 1;
        }

        .dolls-grid {
            position: absolute;
            bottom: 85px;
            left: 15px;
            right: 15px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            z-index: 5;
        }

        .doll {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            animation: dollBounce 2s ease-in-out infinite;
            transition: transform 0.3s, opacity 0.3s;
        }

        .doll.grabbed {
            opacity: 0.3;
            transform: scale(0.8);
        }

        .speech-bubble {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 11px;
            white-space: nowrap;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            animation: bubbleFadeIn 0.3s ease-out;
            z-index: 20;
            pointer-events: none;
        }

        .speech-bubble::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: rgba(255, 255, 255, 0.95);
        }

        .speech-bubble.fading {
            animation: bubbleFadeOut 0.5s ease-out forwards;
        }

        .doll-body {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.3);
        }

        .doll-name {
            color: white;
            font-size: 11px;
            font-weight: bold;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
            margin-top: 3px;
            max-width: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-align: center;
        }

        .prize-chute {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 80px;
            background: linear-gradient(180deg, #2d1b4e, #1a0f2e);
            border-top: 3px solid var(--crane-accent);
            border-radius: 8px 8px 0 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 6;
            overflow: hidden;
        }

        .prize-chute::before {
            content: 'ğŸ';
            font-size: 24px;
            opacity: 0.3;
        }

        .prize-in-chute {
            position: absolute;
            font-size: 36px;
            animation: prizeDropIn 0.5s ease-in forwards;
        }

        /* ì¤€ë¹„ ì„¹ì…˜ */
        .ready-section {
            background: var(--bg-primary);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid var(--crane-accent);
        }

        .users-list {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 50px;
        }

        .user-tag {
            background: var(--bg-white);
            border: 2px solid var(--dice-accent);
            color: var(--dice-accent);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .user-tag.host {
            background: var(--dice-accent);
            color: white;
        }

        /* ê²Œì„ ê¸°ë¡ */
        .history-section {
            position: fixed;
            right: 20px;
            top: 20px;
            width: 320px;
            max-height: calc(100vh - 40px);
            background: var(--bg-white);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 20px;
            overflow-y: auto;
            display: none;
        }

        .history-section.visible {
            display: block;
        }

        .history-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--crane-accent);
            margin-bottom: 15px;
            text-align: center;
        }

        .history-item {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid var(--crane-accent);
        }

        .history-round {
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .history-participants {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .history-winner {
            font-size: 16px;
            font-weight: bold;
            color: var(--crane-accent);
        }

        /* ì±„íŒ… ì„¹ì…˜ */
        .chat-section {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            border: 2px solid var(--crane-accent);
        }

        .chat-messages {
            max-height: 480px;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            background: var(--bg-white);
            border-radius: 8px;
        }

        .chat-message.system {
            margin-bottom: 10px;
            padding: 12px;
            background: linear-gradient(135deg, var(--crane-accent) 0%, var(--crane-600) 100%);
            color: white;
            text-align: center;
            font-weight: bold;
            border-radius: 8px;
        }

        .chat-message.winner {
            background: linear-gradient(135deg, var(--yellow-500) 0%, var(--yellow-600) 100%);
            color: var(--text-primary);
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            padding: 15px;
            animation: celebrate 0.5s ease-in-out infinite alternate;
            border-radius: 8px;
        }

        @keyframes celebrate {
            from { transform: scale(1); }
            to { transform: scale(1.02); }
        }

        @keyframes dollBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        @keyframes bubbleFadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(5px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        @keyframes bubbleFadeOut {
            from { opacity: 1; transform: translateX(-50%) translateY(0); }
            to { opacity: 0; transform: translateX(-50%) translateY(-10px); }
        }

        @keyframes prizeDropIn {
            0% { transform: translateY(-100px); opacity: 0; }
            60% { transform: translateY(10px); opacity: 1; }
            80% { transform: translateY(-5px); }
            100% { transform: translateY(0); opacity: 1; }
        }

        @keyframes resultPopup {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* ì ‘ì†ì ëª©ë¡ */
        .users-section {
            margin-bottom: 20px;
        }

        .users-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--dice-accent);
        }

        /* ë°© ì •ë³´ í—¤ë” */
        .room-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--gray-200);
        }

        .room-title {
            font-size: 24px;
            color: var(--crane-accent);
            font-weight: bold;
            margin-bottom: 5px;
        }

        .host-badge {
            display: none;
            background: var(--host-badge-bg);
            color: var(--text-primary);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        /* í˜¸ìŠ¤íŠ¸ ì»¨íŠ¸ë¡¤ */
        .host-controls {
            display: none;
            background: linear-gradient(135deg, var(--yellow-100) 0%, var(--yellow-200) 100%);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid var(--yellow-500);
        }

        .start-button {
            background: linear-gradient(135deg, var(--btn-ready) 0%, var(--green-400) 100%);
            font-size: 20px;
            padding: 15px 30px;
        }

        .start-button:disabled {
            background: var(--gray-300);
        }

        .end-button {
            background: linear-gradient(135deg, var(--btn-danger) 0%, var(--red-400) 100%);
        }

        /* ê²°ê³¼ ì˜¤ë²„ë ˆì´ */
        .result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .result-overlay.visible {
            display: flex;
        }

        .result-card {
            background: var(--bg-white);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            animation: resultPopup 0.5s ease-out;
        }

        @keyframes popup {
            from {
                transform: scale(0.5);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
            15% { opacity: 1; transform: translateX(-50%) translateY(0); }
            85% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }

        .result-title {
            font-size: 24px;
            color: var(--crane-accent);
            margin-bottom: 20px;
        }

        .result-winner {
            font-size: 48px;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .result-message {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        /* ê²Œì„ íƒ€ì… ì•„ì´ì½˜ */
        .game-type-icon {
            font-size: 16px;
            margin-right: 5px;
        }

        /* ë°© í­íŒŒ ì¹´ìš´íŠ¸ë‹¤ìš´ */
        .room-expiry-section {
            background: var(--yellow-100);
            border: 2px solid var(--yellow-500);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        @media (max-width: 1200px) {
            body.game-active .container {
                margin-left: auto;
                margin-right: auto;
            }

            .history-section {
                position: static;
                width: 100%;
                max-height: none;
                margin-top: 20px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
                border-radius: 15px;
            }

            h1 {
                font-size: 1.8em;
            }

            .crane-machine {
                height: 380px;
            }

            .doll-body {
                width: 40px;
                height: 40px;
                font-size: 22px;
            }

            .doll-name {
                font-size: 9px;
                max-width: 45px;
            }

            .dolls-grid {
                gap: 6px;
            }
        }
    </style>
</head>
<body>
    <!-- ë¡œë”© í™”ë©´ -->
    <div id="loadingScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--crane-accent) 0%, var(--crane-600) 100%); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <div style="text-align: center; color: white;">
            <div style="font-size: 80px; margin-bottom: 20px; animation: bounce 1s infinite;">ğŸª„</div>
            <h2 style="font-size: 24px; margin-bottom: 10px;">ë°©ì— ì…ì¥ ì¤‘...</h2>
            <p style="font-size: 16px; opacity: 0.8;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
            <div style="margin-top: 30px;">
                <div style="width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
            </div>
        </div>
    </div>
    <style>
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }

        /* ì£¼ë¬¸ë°›ê¸° ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .orders-section {
            margin-bottom: 20px;
            display: none;
        }
        .orders-section.active {
            display: block;
        }
        .my-order-box {
            background: var(--yellow-50);
            border: 2px solid var(--yellow-500);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .my-order-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--yellow-900);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .order-input-group {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: start;
        }
        .order-input-wrapper {
            position: relative;
            width: 100%;
        }

        .autocomplete-suggestion {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 12px;
            color: var(--text-muted);
            pointer-events: none;
            font-family: inherit;
            font-size: 16px;
            line-height: 1.5;
            border: 2px solid transparent;
            border-radius: 8px;
            z-index: 1;
        }

        #myOrderInput {
            position: relative;
            z-index: 2;
            background-color: transparent;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-white);
            border: 2px solid var(--crane-accent);
            border-radius: 8px;
            margin-top: 4px;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        .autocomplete-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--gray-100);
            transition: background-color 0.2s;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background-color: var(--purple-50);
        }

        .order-list {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .order-item {
            background: var(--bg-white);
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 3px solid var(--yellow-500);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .order-item:last-child {
            margin-bottom: 0;
        }

        .order-item-left {
            flex: 1;
        }

        .order-user {
            font-weight: 600;
            color: var(--yellow-900);
            margin-bottom: 4px;
        }

        .order-text {
            color: var(--text-secondary);
            font-size: 20px;
            font-weight: 600;
            word-break: break-word;
        }

        .order-text.empty {
            color: var(--text-muted);
            font-style: italic;
        }

        .order-count {
            font-size: 48px;
            font-weight: bold;
            color: var(--dice-accent);
            margin-left: 15px;
        }
        .menu-manager {
            background: var(--bg-primary);
            border: 2px solid var(--crane-accent);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }
        .menu-manager.active {
            display: block;
        }
        .menu-manager-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .menu-manager-input {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
        }
        .menu-list {
            background: var(--bg-white);
            border-radius: 6px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
        }
        .menu-tag {
            display: inline-block;
            background: var(--crane-accent);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 14px;
            margin: 4px;
            cursor: pointer;
        }
        .menu-tag .delete-btn {
            margin-left: 6px;
            cursor: pointer;
            font-weight: bold;
        }
        .sort-buttons {
            display: flex;
            gap: 5px;
        }
        .sort-button {
            background: var(--bg-primary);
            border: 1px solid var(--gray-300);
            color: var(--text-secondary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        .sort-button.active {
            background: var(--crane-accent);
            color: white;
            border-color: var(--crane-accent);
        }
        .not-ordered-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed var(--gray-300);
        }

        .not-rolled-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--yellow-900);
            margin-bottom: 12px;
        }

        .not-rolled-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 40px;
        }

        .spectator-orders-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--gray-200);
        }
        .game-status {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .game-status.waiting {
            background: var(--gray-100);
            color: var(--gray-700);
        }
        .game-status.ordering {
            background: var(--yellow-50);
            color: var(--yellow-900);
        }
        .game-status.playing {
            background: var(--status-success-bg);
            color: var(--green-900);
        }
    </style>

    <!-- ì´ë¦„ ì…ë ¥ (ë¡œê·¸ì¸ ì‹œ ìë™ ì„¤ì •, ìˆ¨ê¹€) -->
    <input type="hidden" id="globalUserNameInput">

    <div class="container">
        <!-- ê²Œì„ ì„¹ì…˜ -->
        <section class="game-section" id="gameSection">
            <!-- ë°© ì •ë³´ í—¤ë” (í†µí•© ì»¨íŠ¸ë¡¤ ë°”) -->
            <div class="room-control-bar">
                <!-- Left: Room Identity -->
                <div class="control-bar-left">
                    <span class="room-title" id="roomTitle" style="cursor: pointer;">
                        <span id="roomNameDisplay">ì¸í˜•ë½‘ê¸° ë°©</span>
                        <span class="edit-icon" style="display: none;">âœï¸</span>
                    </span>
                    <span class="host-badge" id="hostBadge" style="display: none;">ğŸ‘‘ í˜¸ìŠ¤íŠ¸</span>
                    <span class="username-display" id="usernameDisplay" style="display: none;">í”Œë ˆì´ì–´</span>
                </div>

                <!-- Right: Actions -->
                <div class="control-bar-right">
                    <label style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-secondary); cursor: pointer; margin: 0;">
                        <input type="checkbox" id="gameSectionSoundCheckbox"> ğŸ”Š ì‚¬ìš´ë“œ
                    </label>
                    <button onclick="toggleReady()" id="readyBtn" class="control-bar-btn" style="display: none;">
                        âœ… ì¤€ë¹„
                    </button>
                    <button onclick="logout()" id="logoutBtn" class="control-bar-btn">
                        ğŸ”„ ë¡œê·¸ì•„ì›ƒ
                    </button>
                    <button onclick="leaveRoom()" id="leaveBtn" class="control-bar-btn">
                        ğŸšª ë‚˜ê°€ê¸°
                    </button>
                </div>
            </div>

            <!-- ë°© í­íŒŒ ì¹´ìš´íŠ¸ë‹¤ìš´ -->
            <div class="room-expiry-section" id="roomExpirySection" style="display: none;">
                <div style="color: var(--yellow-900); font-weight: bold; font-size: 14px;">
                    â° ë°© í­íŒŒê¹Œì§€ ë‚¨ì€ ì‹œê°„: <span id="roomExpiryCountdown" style="color: var(--red-500);">--:--:--</span>
                </div>
            </div>

            <!-- ì ‘ì†ì ëª©ë¡ -->
            <div class="users-section" id="usersSection">
                <div class="users-title">
                    ğŸ‘¥ ì ‘ì†ì (<span id="usersCount">0</span>ëª…)
                    <span id="dragHint" style="display: none; font-size: 12px; color: var(--crane-accent); margin-left: 10px; font-weight: normal;">ğŸ’¡ ë“œë˜ê·¸í•˜ì—¬ ì¤€ë¹„ì‹œí‚¤ê¸°</span>
                </div>
                <div class="users-list" id="usersList"></div>
            </div>

            <!-- ì¤€ë¹„ ì„¹ì…˜ -->
            <div class="ready-section" id="readySection">
                <div class="users-title" style="margin-bottom: 15px;">âœ… ì¤€ë¹„í•œ ì‚¬ëŒ (<span id="readyCount">0</span>ëª…)</div>
                <div class="users-list" id="readyUsersList">
                    <div style="color: var(--text-muted); text-align: center; padding: 10px; width: 100%;">ì•„ì§ ì¤€ë¹„í•œ ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤</div>
                </div>
            </div>

            <!-- í˜¸ìŠ¤íŠ¸ ì»¨íŠ¸ë¡¤ -->
            <div class="host-controls" id="hostControls" style="display: none; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                <button class="start-button" id="startCraneGameButton" onclick="startCraneGame()" disabled style="grid-column: 1 / -1;">
                    ğŸª„ ì¸í˜•ë½‘ê¸° ì‹œì‘ (ìµœì†Œ 2ëª… ì¤€ë¹„ í•„ìš”)
                </button>
                <button onclick="OrderModule.startOrder()" id="startOrderButton" style="display: none; background: linear-gradient(135deg, var(--btn-ready) 0%, var(--green-400) 100%);">ì£¼ë¬¸ë°›ê¸° ì‹œì‘</button>
                <button onclick="OrderModule.endOrder()" id="endOrderButton" style="display: none; background: linear-gradient(135deg, var(--btn-danger) 0%, var(--btn-danger-hover) 100%);">ì£¼ë¬¸ë°›ê¸° ì¢…ë£Œ</button>
            </div>

            <!-- ì£¼ë¬¸ë°›ê¸° ì„¹ì…˜ -->
            <div class="orders-section" id="ordersSection">
                <div class="history-title-wrapper" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="users-title" style="font-weight: bold; color: var(--crane-accent); font-size: 16px; margin: 0;">ğŸ” ì£¼ë¬¸ë°›ê¸°</div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button onclick="OrderModule.showOrderList()" id="showOrderListButton" style="width: auto; padding: 8px 16px; font-size: 14px; background: linear-gradient(135deg, var(--crane-accent) 0%, var(--purple-200) 100%);">ğŸ“‹ ì£¼ë¬¸ë¦¬ìŠ¤íŠ¸ ë³´ê¸°</button>
                        <div class="sort-buttons">
                            <button class="sort-button active" id="sortOrderAscBtn" onclick="OrderModule.sortOrders('asc')">ê°€ë‚˜ë‹¤ìˆœ</button>
                            <button class="sort-button" id="sortOrderDescBtn" onclick="OrderModule.sortOrders('desc')">ê°€ë‚˜ë‹¤ ì—­ìˆœ</button>
                            <button class="sort-button" id="sortOrderCountBtn" onclick="OrderModule.sortOrders('count')">ì£¼ë¬¸ ë§ì€ ìˆœ</button>
                        </div>
                    </div>
                </div>

                <!-- ì£¼ë¬¸í•˜ì§€ ì•Šì€ ì‚¬ëŒ ëª©ë¡ -->
                <div class="not-ordered-section" id="notOrderedSection" style="display: none;">
                    <div class="not-rolled-title" style="margin-top: 15px;">â³ ì£¼ë¬¸í•˜ì§€ ì•Šì€ ì‚¬ëŒ</div>
                    <div class="not-rolled-list" id="notOrderedList"></div>
                </div>

                <!-- ë‚´ ì£¼ë¬¸ ì…ë ¥ -->
                <div class="my-order-box">
                    <div class="my-order-title">
                        <span>ğŸ“</span>
                        <span>ë‚´ ì£¼ë¬¸</span>
                        <button onclick="OrderModule.toggleMenuManager()" style="width: auto; padding: 6px 12px; font-size: 12px; margin-left: auto; background: var(--bg-primary); color: var(--crane-accent); border: 1px solid var(--crane-accent);">ë©”ë‰´ ê´€ë¦¬</button>
                    </div>

                    <!-- ìì£¼ ì“°ëŠ” ë©”ë‰´ ê´€ë¦¬ -->
                    <div class="menu-manager" id="menuManager">
                        <div class="menu-manager-title">
                            <span>ğŸ“‹ ìì£¼ ì“°ëŠ” ë©”ë‰´</span>
                            <button onclick="OrderModule.toggleMenuManager()" style="width: auto; padding: 4px 8px; font-size: 12px; background: var(--btn-danger); color: white; border: none; border-radius: 4px;">ë‹«ê¸°</button>
                        </div>
                        <div class="menu-manager-input">
                            <input type="text" id="menuInput" placeholder="ë©”ë‰´ ì¶”ê°€ (ì˜ˆ: ì¹˜í‚¨)" maxlength="50" />
                            <button onclick="OrderModule.addMenu()" style="width: auto; padding: 12px 20px; height: fit-content;">ì¶”ê°€</button>
                        </div>
                        <div class="menu-list" id="menuList"></div>
                    </div>

                    <div class="order-input-group">
                        <div class="order-input-wrapper">
                            <div class="autocomplete-suggestion" id="autocompleteSuggestion"></div>
                            <input
                                type="text"
                                id="myOrderInput"
                                placeholder="ì£¼ë¬¸í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì˜¤ì´ˆ, ì˜¤ê³ )"
                                maxlength="100"
                                disabled
                            />
                            <div class="autocomplete-dropdown" id="autocompleteDropdown" style="display: none;"></div>
                        </div>
                        <button onclick="OrderModule.updateMyOrder()" id="orderSaveButton" style="width: auto; padding: 12px 20px; height: fit-content;" disabled>ì €ì¥</button>
                    </div>
                </div>

                <!-- ì „ì²´ ì£¼ë¬¸ ëª©ë¡ -->
                <div class="order-list" id="orderList">
                    <div style="color: var(--text-muted); text-align: center; padding: 10px;">ì•„ì§ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤</div>
                </div>

                <!-- ê´€ì „ì ì£¼ë¬¸ ëª©ë¡ -->
                <div class="spectator-orders-section" id="spectatorOrdersSection" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--gray-200);">
                    <div class="users-title" style="margin-bottom: 15px; color: var(--text-muted); font-size: 14px;">ğŸ‘ï¸ ê´€ì „ì ì£¼ë¬¸ (ê²Œì„ ì°¸ì—¬ í›„ ë©”ë‰´ë¥¼ ë‹¤ì‹œ ê³¨ë¼ì£¼ì‹œë©´ë©ë‹ˆë‹¤)</div>
                    <div class="order-list" id="spectatorOrderList"></div>
                </div>
            </div>

            <!-- ê²Œì„ ìƒíƒœ í‘œì‹œ -->
            <div class="game-status waiting" id="gameStatus" style="padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; margin-bottom: 20px; background: var(--gray-100); color: var(--gray-700);">
                ëŒ€ê¸° ì¤‘...
            </div>

            <!-- í¬ë ˆì¸ ë¨¸ì‹  ì»¨í…Œì´ë„ˆ (í•­ìƒ í‘œì‹œ) -->
            <div class="crane-container" id="craneContainer" style="display: flex;">
                <div class="crane-machine" id="craneMachine">
                    <div class="crane-rail"></div>
                    <div class="crane-assembly" id="craneAssembly">
                        <div class="crane-arm" id="craneArm"></div>
                        <div class="crane-fingers-wrapper" id="craneFingers">
                            <div class="crane-finger"></div>
                            <div class="crane-finger"></div>
                        </div>
                    </div>
                    <div class="crane-glass"></div>
                    <div class="dolls-grid" id="dollsGrid"></div>
                    <div class="prize-chute" id="prizeChute"></div>
                </div>
            </div>

            <!-- ê²Œì„ ì¢…ë£Œ ë²„íŠ¼ (í˜¸ìŠ¤íŠ¸ ì „ìš©, ê²°ê³¼ í›„ í‘œì‹œ) -->
            <div id="endGameSection" style="display: none; text-align: center; margin-top: 20px;">
                <button class="end-button" onclick="endCraneGameFull()">ğŸ ê²Œì„ ì¢…ë£Œ</button>
            </div>

            <!-- ë‹¤ì‹œë³´ê¸° ë²„íŠ¼ -->
            <div id="replaySection" style="display: none; text-align: center; margin-top: 20px; padding: 15px; background: linear-gradient(135deg, var(--crane-accent) 0%, var(--crane-600) 100%); border-radius: 12px; box-shadow: 0 4px 15px rgba(156, 39, 176, 0.4);">
                <div style="color: white; margin-bottom: 12px; font-size: 14px;">
                    ğŸ¬ í™”ë©´ì„ ë³´ì§€ ì•ŠëŠ” ë™ì•ˆ ì¸í˜•ë½‘ê¸°ê°€ ì§„í–‰ë˜ì—ˆìŠµë‹ˆë‹¤
                </div>
                <button onclick="replayCraneGame()" style="background: linear-gradient(135deg, var(--red-400) 0%, var(--yellow-300) 100%); border: none; padding: 12px 25px; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; font-size: 15px; box-shadow: 0 4px 10px rgba(255, 107, 107, 0.4);">
                    ğŸ”„ ë‹¤ì‹œë³´ê¸°
                </button>
            </div>

            <!-- ì±„íŒ… ì„¹ì…˜ -->
            <div class="chat-section">
                <div style="font-weight: bold; color: var(--crane-accent); margin-bottom: 10px;">ğŸ’¬ ì±„íŒ…</div>
                <div class="chat-messages" id="chatMessages"></div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." style="flex: 1; margin: 0;" onkeypress="handleChatKeypress(event)">
                    <button onclick="sendMessage()" style="width: auto; padding: 10px 20px;">ì „ì†¡</button>
                </div>
            </div>
        </section>
    </div>

    <!-- ê¸°ë¡ ì„¹ì…˜ -->
    <div class="history-section" id="historySection">
        <div class="history-title">ğŸ“œ ê²Œì„ ê¸°ë¡</div>
        <div id="historyList"></div>
    </div>

    <!-- ê²°ê³¼ ì˜¤ë²„ë ˆì´ -->
    <div class="result-overlay" id="resultOverlay">
        <div class="result-card">
            <div class="result-title">ğŸ§¸ ë½‘ê¸° ì„±ê³µ! ğŸ§¸</div>
            <div class="result-winner" id="resultWinner"></div>
            <div class="result-winner-emoji" id="resultWinnerEmoji" style="font-size: 64px; margin-bottom: 10px;"></div>
            <div class="result-message">ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰</div>
            <button onclick="closeResultOverlay()" style="width: auto; padding: 12px 30px;">í™•ì¸</button>
        </div>
    </div>

    <!-- ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ëª¨ë‹¬ -->
    <div id="passwordModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000;">
        <div style="background: var(--bg-white); padding: 30px; border-radius: 12px; max-width: 400px; width: 90%;">
            <h3 style="color: var(--crane-accent); margin-bottom: 15px;">ğŸ”’ ë¹„ê³µê°œ ë°©</h3>
            <p style="margin-bottom: 15px; color: var(--text-secondary);">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
            <input type="password" id="roomPasswordInput" placeholder="ë¹„ë°€ë²ˆí˜¸" style="margin-bottom: 15px;">
            <div style="display: flex; gap: 10px;">
                <button onclick="closePasswordModal()" style="background: var(--btn-neutral); flex: 1;">ì·¨ì†Œ</button>
                <button onclick="submitPassword()" style="flex: 1;">ì…ì¥</button>
            </div>
        </div>
    </div>

    <!-- ë””ë²„ê·¸ ë¡œê·¸ ì„¹ì…˜ -->
    <div class="debug-log-section" id="debugLogSection" style="position: fixed; bottom: 20px; right: 20px; width: 400px; max-height: 300px; background: rgba(0, 0, 0, 0.9); color: #0f0; border-radius: 8px; padding: 15px; font-family: 'Courier New', monospace; font-size: 11px; z-index: 10000; overflow-y: auto; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #0f0; padding-bottom: 5px;">
            <div style="font-weight: bold; color: #0f0;">ğŸª„ ì¸í˜•ë½‘ê¸° ë””ë²„ê·¸ ë¡œê·¸</div>
            <div style="display: flex; gap: 5px;">
                <button onclick="clearDebugLog()" style="background: #333; color: #0f0; border: 1px solid #0f0; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;">ì§€ìš°ê¸°</button>
                <button onclick="toggleDebugLog()" style="background: #333; color: #0f0; border: 1px solid #0f0; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;">ìˆ¨ê¸°ê¸°</button>
            </div>
        </div>
        <div id="debugLogContent" style="line-height: 1.4;"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/page-history-shared.js"></script>
    <script src="/assets/sounds/sound-manager.js"></script>
    <script src="/chat-shared.js"></script>
    <script src="/ready-shared.js"></script>
    <script src="/order-shared.js"></script>
    <script src="/ranking-shared.js"></script>
    <script>
        // ============================================
        // Room Control Bar Enhancement
        // ============================================

        // Room title editing
        let isEditingRoomName = false;

        document.addEventListener('DOMContentLoaded', function() {
            const roomTitleElem = document.getElementById('roomTitle');
            if (!roomTitleElem) return;

            roomTitleElem.addEventListener('click', function() {
                // Check if user is host
                if (!window.isHost || isEditingRoomName) return;

                isEditingRoomName = true;
                const displaySpan = document.getElementById('roomNameDisplay');
                const currentName = displaySpan.textContent;
                const editIcon = this.querySelector('.edit-icon');

                // Hide icon during edit
                if (editIcon) editIcon.style.display = 'none';

                // Create input
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentName;
                input.maxLength = 30;
                input.style.cssText = 'font-size: inherit; font-weight: inherit; border: 2px solid var(--crane-accent); border-radius: 4px; padding: 4px 8px; width: 200px; background: var(--bg-white);';

                displaySpan.replaceWith(input);
                input.focus();
                input.select();

                function finishEdit() {
                    const newName = input.value.trim();
                    const newDisplay = document.createElement('span');
                    newDisplay.id = 'roomNameDisplay';
                    newDisplay.textContent = newName || currentName;

                    input.replaceWith(newDisplay);
                    if (editIcon) editIcon.style.display = '';
                    isEditingRoomName = false;

                    if (newName && newName !== currentName && window.socket) {
                        window.socket.emit('updateRoomName', { roomName: newName });
                    }
                }

                input.addEventListener('blur', finishEdit);
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') finishEdit();
                });
            });
        });

        // Update room title on server broadcast
        if (window.socket) {
            window.socket.on('roomNameUpdated', (data) => {
                const display = document.getElementById('roomNameDisplay');
                if (display) display.textContent = data.roomName;
            });
        }

        // Show/hide UI elements based on host status
        function updateControlBarUI(isHostUser) {
            const editIcon = document.querySelector('.edit-icon');
            const hostBadge = document.getElementById('hostBadge');
            const readyBtn = document.getElementById('readyBtn');
            const usernameDisplay = document.getElementById('usernameDisplay');

            if (editIcon) editIcon.style.display = isHostUser ? 'inline' : 'none';
            if (hostBadge) hostBadge.style.display = isHostUser ? 'inline-block' : 'none';
            if (readyBtn) readyBtn.style.display = 'inline-block';

            // Show username if available
            if (usernameDisplay && window.myUserName) {
                usernameDisplay.textContent = window.myUserName;
                usernameDisplay.style.display = 'inline-block';
            }
        }

        // Logout function
        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë°©ì—ì„œ ë‚˜ê°€ê³  ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.')) {
                if (window.socket) {
                    window.socket.emit('leaveRoom');
                    window.socket.disconnect();
                }

                // Clear session
                sessionStorage.removeItem('craneActiveRoom');
                sessionStorage.removeItem('userName');

                // Redirect to main page
                location.href = '/';
            }
        }

        // Host delegation
        function delegateHost(targetSocketId) {
            if (!window.socket || !window.roomUsers) return;

            const targetUser = window.roomUsers.find(u => u.socketId === targetSocketId);
            if (!targetUser) return;

            if (confirm(`${targetUser.name}ë‹˜ì—ê²Œ í˜¸ìŠ¤íŠ¸ë¥¼ ìœ„ì„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                window.socket.emit('delegateHost', { targetSocketId });
            }
        }

        // Listen for host delegation
        if (window.socket) {
            window.socket.on('hostDelegated', (data) => {
                window.isHost = data.newHostSocketId === window.socket.id;
                window.hostSocketId = data.newHostSocketId;

                updateControlBarUI(window.isHost);

                if (typeof renderUsersList === 'function' && window.roomUsers) {
                    renderUsersList(window.roomUsers);
                }

                if (window.isHost) {
                    alert('í˜¸ìŠ¤íŠ¸ ê¶Œí•œì„ ë°›ì•˜ìŠµë‹ˆë‹¤!');
                }
            });
        }

        // ============================================
        // ë””ë²„ê·¸ ë¡œê·¸ í•¨ìˆ˜ (localhost ë“± ë¡œì»¬ì—ì„œë§Œ í™œì„±í™”, í¬íŠ¸ ë¬´ê´€)
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.hostname === '';
        let debugLogEnabled = isLocalhost;
        const MAX_LOG_LINES = 100;

        // ë¡œì»¬ì´ ì•„ë‹ˆë©´ ë””ë²„ê·¸ ë¡œê·¸ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
        if (!isLocalhost) {
            const debugLogSection = document.getElementById('debugLogSection');
            if (debugLogSection) {
                debugLogSection.style.display = 'none';
            }
        }

        // ë¡œì»¬ì—ì„œëŠ” ë°© ì œëª© ê¸°ë³¸ê°’ì„ "test"ë¡œ ì„¤ì •
        if (isLocalhost) {
            const roomNameInput = document.getElementById('createRoomNameInput');
            if (roomNameInput) {
                roomNameInput.value = 'test';
            }
        }

        function addDebugLog(message, type = 'info') {
            if (!debugLogEnabled) return;

            const logSection = document.getElementById('debugLogSection');
            const logContent = document.getElementById('debugLogContent');

            if (!logSection || !logContent) return;

            const timestamp = new Date().toLocaleTimeString('ko-KR', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3 });
            const colors = {
                'info': '#0f0',
                'warn': '#ff0',
                'error': '#f00',
                'animation': '#0ff',
                'gameEnd': '#f0f',
                'visibility': '#ffa500'
            };
            const color = colors[type] || colors['info'];

            const logLine = document.createElement('div');
            logLine.innerHTML = `<span style="color: #888;">[${timestamp}]</span> <span style="color: ${color};">${message}</span>`;
            logContent.appendChild(logLine);

            // ìµœëŒ€ ì¤„ ìˆ˜ ì œí•œ
            while (logContent.children.length > MAX_LOG_LINES) {
                logContent.removeChild(logContent.firstChild);
            }

            // ìë™ ìŠ¤í¬ë¡¤
            logSection.scrollTop = logSection.scrollHeight;

            // localhostì¼ ë•Œë§Œ ìë™ìœ¼ë¡œ ë³´ì´ê¸°
            if (isLocalhost && logSection.style.display === 'none') {
                logSection.style.display = 'block';
            }
        }

        function clearDebugLog() {
            const logContent = document.getElementById('debugLogContent');
            if (logContent) {
                logContent.innerHTML = '';
            }
        }

        function toggleDebugLog() {
            const logSection = document.getElementById('debugLogSection');
            if (logSection) {
                logSection.style.display = logSection.style.display === 'none' ? 'block' : 'none';
            }
        }

        // ì»¤ìŠ¤í…€ ì–¼ëŸ¿ í•¨ìˆ˜
        function showCustomAlert(message, type = 'info') {
            const existingAlert = document.getElementById('customAlert');
            if (existingAlert) {
                existingAlert.remove();
            }

            let bgColor, borderColor, icon;
            switch(type) {
                case 'error':
                    bgColor = 'var(--red-50)';
                    borderColor = 'var(--red-400)';
                    icon = 'âš ï¸';
                    break;
                case 'warning':
                    bgColor = 'var(--yellow-50)';
                    borderColor = 'var(--yellow-600)';
                    icon = 'âš ï¸';
                    break;
                case 'success':
                    bgColor = 'var(--green-50)';
                    borderColor = 'var(--green-400)';
                    icon = 'âœ…';
                    break;
                default:
                    bgColor = 'var(--purple-50)';
                    borderColor = 'var(--dice-accent)';
                    icon = 'â„¹ï¸';
            }

            const alertOverlay = document.createElement('div');
            alertOverlay.id = 'customAlert';
            alertOverlay.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.4); z-index: 10001;
                display: flex; justify-content: center; align-items: center;
                animation: fadeIn 0.2s ease-out;
            `;

            const alertContent = document.createElement('div');
            alertContent.style.cssText = `
                background: var(--bg-white); border-radius: 16px; padding: 20px;
                max-width: 450px; width: calc(100vw - 40px);
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
                border: 2px solid ${borderColor};
                animation: slideDown 0.3s ease-out;
                box-sizing: border-box;
            `;

            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                font-size: 15px; line-height: 1.6; color: var(--text-primary);
                white-space: pre-wrap; word-wrap: break-word;
                word-break: keep-all; overflow-wrap: break-word;
                text-align: center; margin-bottom: 20px;
                max-width: 100%;
            `;
            messageDiv.innerHTML = `<span style="font-size: 24px; margin-right: 8px;">${icon}</span>${message}`;

            const confirmButton = document.createElement('button');
            confirmButton.textContent = 'í™•ì¸';
            confirmButton.style.cssText = `
                padding: 10px 30px;
                background: linear-gradient(135deg, ${borderColor} 0%, ${borderColor}dd 100%);
                color: white; border: none; border-radius: 8px;
                font-size: 16px; font-weight: 600; cursor: pointer;
                width: 100%; transition: transform 0.1s, box-shadow 0.1s;
            `;
            confirmButton.onmouseenter = () => { confirmButton.style.transform = 'scale(1.02)'; confirmButton.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)'; };
            confirmButton.onmouseleave = () => { confirmButton.style.transform = 'scale(1)'; confirmButton.style.boxShadow = 'none'; };
            confirmButton.onclick = () => { alertOverlay.style.animation = 'fadeOut 0.2s ease-out'; setTimeout(() => alertOverlay.remove(), 200); };

            const handleEsc = (e) => {
                if (e.key === 'Escape') {
                    alertOverlay.style.animation = 'fadeOut 0.2s ease-out';
                    setTimeout(() => { alertOverlay.remove(); document.removeEventListener('keydown', handleEsc); }, 200);
                }
            };
            document.addEventListener('keydown', handleEsc);

            alertOverlay.onclick = (e) => {
                if (e.target === alertOverlay) {
                    alertOverlay.style.animation = 'fadeOut 0.2s ease-out';
                    setTimeout(() => { alertOverlay.remove(); document.removeEventListener('keydown', handleEsc); }, 200);
                }
            };

            alertContent.appendChild(messageDiv);
            alertContent.appendChild(confirmButton);
            alertOverlay.appendChild(alertContent);
            document.body.appendChild(alertOverlay);
            confirmButton.focus();
        }

        // ì»¤ìŠ¤í…€ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸
        function showCustomConfirm(message, type = 'warning') {
            return new Promise((resolve) => {
                const existingConfirm = document.getElementById('customConfirm');
                if (existingConfirm) { existingConfirm.remove(); }

                let bgColor, borderColor, icon;
                switch(type) {
                    case 'error': bgColor = 'var(--red-50)'; borderColor = 'var(--red-400)'; icon = 'âš ï¸'; break;
                    case 'warning': bgColor = 'var(--yellow-50)'; borderColor = 'var(--yellow-600)'; icon = 'âš ï¸'; break;
                    case 'success': bgColor = 'var(--green-50)'; borderColor = 'var(--green-400)'; icon = 'âœ…'; break;
                    default: bgColor = 'var(--purple-50)'; borderColor = 'var(--dice-accent)'; icon = 'â„¹ï¸';
                }

                const confirmOverlay = document.createElement('div');
                confirmOverlay.id = 'customConfirm';
                confirmOverlay.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0, 0, 0, 0.4); z-index: 10002;
                    display: flex; justify-content: center; align-items: center;
                    animation: fadeIn 0.2s ease-out;
                `;

                const confirmContent = document.createElement('div');
                confirmContent.style.cssText = `
                    background: var(--bg-white); border-radius: 16px; padding: 20px;
                    max-width: 450px; width: calc(100vw - 40px);
                    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
                    border: 2px solid ${borderColor};
                    animation: slideDown 0.3s ease-out;
                    box-sizing: border-box;
                `;

                const messageDiv = document.createElement('div');
                messageDiv.style.cssText = `
                    font-size: 15px; line-height: 1.6; color: var(--text-primary);
                    white-space: pre-wrap; word-wrap: break-word;
                    word-break: keep-all; overflow-wrap: break-word;
                    text-align: center; margin-bottom: 25px;
                    max-width: 100%;
                `;
                messageDiv.innerHTML = `<span style="font-size: 24px; margin-right: 8px;">${icon}</span>${message}`;

                const buttonContainer = document.createElement('div');
                buttonContainer.style.cssText = `display: flex; gap: 10px; justify-content: center;`;

                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'ì·¨ì†Œ';
                cancelButton.style.cssText = `
                    padding: 10px 25px; background: var(--gray-100); color: var(--text-secondary);
                    border: 1px solid var(--gray-300); border-radius: 8px; font-size: 16px;
                    font-weight: 600; cursor: pointer; transition: transform 0.1s, box-shadow 0.1s; flex: 1;
                `;
                cancelButton.onmouseenter = () => { cancelButton.style.transform = 'scale(1.02)'; cancelButton.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)'; };
                cancelButton.onmouseleave = () => { cancelButton.style.transform = 'scale(1)'; cancelButton.style.boxShadow = 'none'; };
                cancelButton.onclick = () => { confirmOverlay.style.animation = 'fadeOut 0.2s ease-out'; setTimeout(() => { confirmOverlay.remove(); resolve(false); }, 200); };

                const confirmButton = document.createElement('button');
                confirmButton.textContent = 'í™•ì¸';
                confirmButton.style.cssText = `
                    padding: 10px 25px;
                    background: linear-gradient(135deg, ${borderColor} 0%, ${borderColor}dd 100%);
                    color: white; border: none; border-radius: 8px; font-size: 16px;
                    font-weight: 600; cursor: pointer; transition: transform 0.1s, box-shadow 0.1s; flex: 1;
                `;
                confirmButton.onmouseenter = () => { confirmButton.style.transform = 'scale(1.02)'; confirmButton.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)'; };
                confirmButton.onmouseleave = () => { confirmButton.style.transform = 'scale(1)'; confirmButton.style.boxShadow = 'none'; };
                confirmButton.onclick = () => { confirmOverlay.style.animation = 'fadeOut 0.2s ease-out'; setTimeout(() => { confirmOverlay.remove(); resolve(true); }, 200); };

                const handleEsc = (e) => {
                    if (e.key === 'Escape') {
                        confirmOverlay.style.animation = 'fadeOut 0.2s ease-out';
                        setTimeout(() => { confirmOverlay.remove(); document.removeEventListener('keydown', handleEsc); resolve(false); }, 200);
                    }
                };
                document.addEventListener('keydown', handleEsc);

                confirmOverlay.onclick = (e) => {
                    if (e.target === confirmOverlay) {
                        confirmOverlay.style.animation = 'fadeOut 0.2s ease-out';
                        setTimeout(() => { confirmOverlay.remove(); document.removeEventListener('keydown', handleEsc); resolve(false); }, 200);
                    }
                };

                buttonContainer.appendChild(cancelButton);
                buttonContainer.appendChild(confirmButton);
                confirmContent.appendChild(messageDiv);
                confirmContent.appendChild(buttonContainer);
                confirmOverlay.appendChild(confirmContent);
                document.body.appendChild(confirmOverlay);
                cancelButton.focus();
            });
        }

        // í”Œë ˆì´ì–´ ì•¡ì…˜ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ (í˜¸ìŠ¤íŠ¸ì„ëª…, ì œì™¸ì‹œí‚¤ê¸°, ì·¨ì†Œ)
        function showPlayerActionDialog(playerName) {
            return new Promise((resolve) => {
                const existingDialog = document.getElementById('playerActionDialog');
                if (existingDialog) { existingDialog.remove(); }

                const dialogOverlay = document.createElement('div');
                dialogOverlay.id = 'playerActionDialog';
                dialogOverlay.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0, 0, 0, 0.4); z-index: 10002;
                    display: flex; justify-content: center; align-items: center;
                    animation: fadeIn 0.2s ease-out;
                `;

                const dialogContent = document.createElement('div');
                dialogContent.style.cssText = `
                    background: var(--bg-white); border-radius: 16px; padding: 25px 30px;
                    max-width: 500px; width: 90vw;
                    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
                    border: 2px solid var(--yellow-600);
                    animation: slideDown 0.3s ease-out;
                `;

                const messageDiv = document.createElement('div');
                messageDiv.style.cssText = `
                    font-size: 18px; line-height: 1.6; color: var(--text-primary);
                    white-space: pre-wrap; word-break: break-word;
                    text-align: center; margin-bottom: 25px; font-weight: 600;
                `;
                messageDiv.innerHTML = `<span style="font-size: 24px; margin-right: 8px;">ğŸ‘¤</span>${playerName}ë‹˜ì—ê²Œ ì–´ë–¤ í–‰ë™ì„ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;

                const buttonContainer = document.createElement('div');
                buttonContainer.style.cssText = `display: flex; flex-direction: column; gap: 12px;`;

                const hostButton = document.createElement('button');
                hostButton.textContent = 'í˜¸ìŠ¤íŠ¸ì„ëª…';
                hostButton.style.cssText = `
                    padding: 12px 25px;
                    background: var(--dice-gradient);
                    color: white; border: none; border-radius: 8px;
                    font-size: 16px; font-weight: 600; cursor: pointer;
                    transition: transform 0.1s, box-shadow 0.1s;
                `;
                hostButton.onmouseenter = () => { hostButton.style.transform = 'scale(1.02)'; hostButton.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.3)'; };
                hostButton.onmouseleave = () => { hostButton.style.transform = 'scale(1)'; hostButton.style.boxShadow = 'none'; };
                hostButton.onclick = () => { dialogOverlay.style.animation = 'fadeOut 0.2s ease-out'; setTimeout(() => { dialogOverlay.remove(); document.removeEventListener('keydown', handleEsc); resolve('host'); }, 200); };

                const kickButton = document.createElement('button');
                kickButton.textContent = 'ì œì™¸ì‹œí‚¤ê¸°';
                kickButton.style.cssText = `
                    padding: 12px 25px;
                    background: linear-gradient(135deg, var(--red-400) 0%, var(--red-400) 100%);
                    color: white; border: none; border-radius: 8px;
                    font-size: 16px; font-weight: 600; cursor: pointer;
                    transition: transform 0.1s, box-shadow 0.1s;
                `;
                kickButton.onmouseenter = () => { kickButton.style.transform = 'scale(1.02)'; kickButton.style.boxShadow = '0 4px 12px rgba(255, 107, 107, 0.3)'; };
                kickButton.onmouseleave = () => { kickButton.style.transform = 'scale(1)'; kickButton.style.boxShadow = 'none'; };
                kickButton.onclick = () => { dialogOverlay.style.animation = 'fadeOut 0.2s ease-out'; setTimeout(() => { dialogOverlay.remove(); document.removeEventListener('keydown', handleEsc); resolve('kick'); }, 200); };

                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'ì·¨ì†Œ';
                cancelButton.style.cssText = `
                    padding: 12px 25px; background: var(--gray-100); color: var(--text-secondary);
                    border: 1px solid var(--gray-300); border-radius: 8px;
                    font-size: 16px; font-weight: 600; cursor: pointer;
                    transition: transform 0.1s, box-shadow 0.1s;
                `;
                cancelButton.onmouseenter = () => { cancelButton.style.transform = 'scale(1.02)'; cancelButton.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)'; };
                cancelButton.onmouseleave = () => { cancelButton.style.transform = 'scale(1)'; cancelButton.style.boxShadow = 'none'; };
                cancelButton.onclick = () => { dialogOverlay.style.animation = 'fadeOut 0.2s ease-out'; setTimeout(() => { dialogOverlay.remove(); document.removeEventListener('keydown', handleEsc); resolve('cancel'); }, 200); };

                const handleEsc = (e) => {
                    if (e.key === 'Escape') {
                        dialogOverlay.style.animation = 'fadeOut 0.2s ease-out';
                        setTimeout(() => { dialogOverlay.remove(); document.removeEventListener('keydown', handleEsc); resolve('cancel'); }, 200);
                    }
                };
                document.addEventListener('keydown', handleEsc);

                dialogOverlay.onclick = (e) => {
                    if (e.target === dialogOverlay) {
                        dialogOverlay.style.animation = 'fadeOut 0.2s ease-out';
                        setTimeout(() => { dialogOverlay.remove(); document.removeEventListener('keydown', handleEsc); resolve('cancel'); }, 200);
                    }
                };

                buttonContainer.appendChild(hostButton);
                buttonContainer.appendChild(kickButton);
                buttonContainer.appendChild(cancelButton);
                dialogContent.appendChild(messageDiv);
                dialogContent.appendChild(buttonContainer);
                dialogOverlay.appendChild(dialogContent);
                document.body.appendChild(dialogOverlay);
                hostButton.focus();
            });
        }

        // ì†Œì¼“ ì—°ê²°
        const socket = io({
            reconnection: true,
            reconnectionAttempts: 10,
            reconnectionDelay: 1000
        });
        let currentServerId = null;
        let currentServerName = null;

        // ì§ì ‘ URL ì ‘ì† ì°¨ë‹¨ + ìƒˆë¡œê³ ì¹¨ ì‹œ ì¬ì…ì¥ ì§€ì›
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const fromDice = urlParams.get('createRoom') === 'true' || urlParams.get('joinRoom') === 'true';

            // ìƒˆë¡œê³ ì¹¨: sessionStorageì— ë°© ì •ë³´ê°€ ìˆìœ¼ë©´ ì¬ì…ì¥
            const activeRoom = sessionStorage.getItem('craneGameActiveRoom');
            if (!fromDice && activeRoom) {
                try {
                    const rd = JSON.parse(activeRoom);
                    currentServerId = rd.serverId || null;
                    currentServerName = rd.serverName || null;
                    if (currentServerId) {
                        socket.emit('setServerId', { serverId: currentServerId });
                    }
                    if (rd.serverName) {
                        document.title = `${rd.serverName} - LAM Crane Game`;
                    }
                    socket.on('connect', function onReconnect() {
                        socket.off('connect', onReconnect);
                        socket.emit('joinRoom', {
                            roomId: rd.roomId,
                            userName: rd.userName,
                            isHost: false,
                            password: '',
                            deviceId: getDeviceId(),
                            tabId: getTabId()
                        });
                    });
                } catch(e) {
                    sessionStorage.removeItem('craneGameActiveRoom');
                    window.location.replace('/game');
                }
                return;
            }

            if (!fromDice) {
                window.location.replace('/game');
                return;
            }
            const pending = localStorage.getItem('pendingCraneGameRoom') || localStorage.getItem('pendingCraneGameJoin');
            if (pending) {
                try {
                    const pd = JSON.parse(pending);
                    currentServerId = pd.serverId || null;
                    currentServerName = pd.serverName || null;
                    if (currentServerId) {
                        socket.emit('setServerId', { serverId: currentServerId });
                        if (pd.serverName) {
                            document.title = `${pd.serverName} - LAM Crane Game`;
                        }
                    }
                } catch(e) {}
            }
        })();

        // ì±„íŒ… ëª¨ë“ˆ ì´ˆê¸°í™” (roomCreated/roomJoined í›„ í˜¸ì¶œ)
        let chatModuleInitialized = false;
        function initChatModule() {
            if (chatModuleInitialized) return;
            chatModuleInitialized = true;
            ChatModule.init(socket, currentUser, {
                themeColor: 'var(--crane-accent)',
                myColor: 'var(--green-800)',
                myBgColor: 'var(--green-50)',
                myBorderColor: 'var(--green-400)',
                messageFilter: (data) => {
                    // ì¸í˜•ë½‘ê¸° ë‹¹ì²¨ ë©”ì‹œì§€ ìŠ¤í¬ì¼ëŸ¬ ë°©ì§€
                    if (data.isCraneGameWinner) {
                        if (document.visibilityState !== 'visible') {
                            addDebugLog(`ğŸ”‡ ì¸í˜•ë½‘ê¸° ë‹¹ì²¨ ë©”ì‹œì§€ ìˆ¨ê¹€ (í™”ë©´ NOT visible) - winner: ${data.message}`, 'visibility');
                            return false;
                        }
                        if (missedCraneGame) {
                            addDebugLog(`ğŸ”‡ ì¸í˜•ë½‘ê¸° ë‹¹ì²¨ ë©”ì‹œì§€ ìˆ¨ê¹€ (ë‹¤ì‹œë³´ê¸° ëŒ€ê¸°ì¤‘) - winner: ${data.message}`, 'visibility');
                            return false;
                        }
                    }
                    return true;
                },
                beforeDisplay: (data) => {
                    // ë§í’ì„  ì‹œìŠ¤í…œ: ì±„íŒ… ë©”ì‹œì§€ê°€ ì˜¤ë©´ í•´ë‹¹ ì¸í˜• ìœ„ì— ë§í’ì„  í‘œì‹œ
                    if (data.userName && !data.isSystem && dollsRendered) {
                        showSpeechBubble(data.userName, data.message);
                    }
                },
                getRoomUsers: () => users
            });
        }

        // ê¸€ë¡œë²Œ í•¨ìˆ˜ (HTML onclickì—ì„œ í˜¸ì¶œ)
        function sendMessage() { ChatModule.sendMessage(); }
        function handleChatKeypress(event) { ChatModule.handleChatKeypress(event); }
        function uploadImage() {
            ChatModule.showImageUploadModal((imageData, caption) => {
                socket.emit('sendImage', { imageData, caption });
            });
        }

        let readyModuleInitialized = false;
        function initReadyModule() {
            if (readyModuleInitialized) return;
            readyModuleInitialized = true;
            ReadyModule.init(socket, currentUser, {
                isHost: isHost,
                isGameActive: () => isAnimating,
                beforeToggle: () => CraneSound.ensureContext(),
                onReadyChanged: (users) => {
                    readyUsers = users;
                },
                onRenderComplete: (users) => {
                    updateStartButton();
                    if (!isAnimating) {
                        updateCranePreview();
                    }
                },
                onError: (message) => {
                    alert(message);
                    addDebugLog(`âŒ ì¤€ë¹„ ì—ëŸ¬: ${message}`, 'error');
                }
            });
        }

        let orderModuleInitialized = false;
        function initOrderModule() {
            if (orderModuleInitialized) return;
            orderModuleInitialized = true;
            OrderModule.init(socket, currentUser, {
                isHost: () => isHost,
                isGameActive: () => isAnimating,
                getEverPlayedUsers: () => everPlayedUsers,
                getUsersList: () => currentUsers,
                showCustomAlert: (msg, type) => alert(msg),
                onOrderStarted: () => { isOrderActive = true; },
                onOrderEnded: () => { isOrderActive = false; },
                onOrdersUpdated: (data) => { ordersData = data; },
            });
        }

        // íƒ­ ì„¸ì…˜ ID (ìƒˆë¡œê³ ì¹¨: ìœ ì§€, ìƒˆ íƒ­: ìƒˆë¡œ ìƒì„±)
        if (!sessionStorage.getItem('tabId')) {
            sessionStorage.setItem('tabId', Math.random().toString(36).substr(2, 9) + Date.now());
        }
        function getTabId() { return sessionStorage.getItem('tabId'); }

        // ìƒíƒœ ë³€ìˆ˜
        let currentRoomId = null;
        let currentUser = '';
        let isHost = false;
        let isReady = false;
        let readyUsers = [];
        let craneGameHistory = [];
        let isAnimating = false;
        let roomExpiryInterval = null;
        let pendingRoomId = null;
        let isOrderActive = false;
        let pendingCraneGameData = null;
        let craneGameFocusHandler = null;
        let craneGameResultShown = false;
        let lastCraneGameData = null;
        let missedCraneGame = false;
        let everPlayedUsers = [];
        let dollsRendered = false;
        let currentDollMap = {};
        let pendingUserName = null;

        // ì¸í˜• ìƒ‰ìƒ ë° ì´ëª¨ì§€
        const DOLL_COLORS = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4',
            '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F',
            '#BB8FCE', '#85C1E9', '#82E0AA', '#F8C471',
            '#D7BDE2', '#AED6F1', '#A3E4D7', '#FAD7A0'
        ];
        const DOLL_EMOJIS = ['ğŸ§¸', 'ğŸ»', 'ğŸ°', 'ğŸ¦Š', 'ğŸ±', 'ğŸ¶', 'ğŸ¼', 'ğŸ¦', 'ğŸ¸', 'ğŸ§', 'ğŸ¦„', 'ğŸ¹', 'ğŸ®', 'ğŸ·', 'ğŸµ', 'ğŸ¦‹'];

        // ì‚¬ìš´ë“œ ë³¼ë¥¨ ê´€ë¦¬
        const CRANE_SOUND_KEY = 'craneGameSoundEnabled';
        const CRANE_VOLUME_KEY = 'craneGameSoundVolume';
        var craneMasterVolume = 0;
        var craneStoredVolume = 0.5;

        function getCraneSoundEnabled() { return craneMasterVolume > 0; }
        function getCraneMasterVolume() { return craneMasterVolume; }

        function initCraneVolumeFromStorage() {
            const storedMuted = localStorage.getItem(CRANE_SOUND_KEY);
            const storedVolume = localStorage.getItem(CRANE_VOLUME_KEY);
            craneStoredVolume = storedVolume ? parseFloat(storedVolume) : 0.5;
            const isEnabled = storedMuted === 'true';
            craneMasterVolume = isEnabled ? craneStoredVolume : 0;
        }

        function updateCraneVolumeUI() {
            const isMuted = craneMasterVolume === 0;
            const volumePercent = Math.round(craneStoredVolume * 100);
            const btn = document.getElementById('volumeBtn');
            const slider = document.getElementById('volumeSlider');
            if (btn) btn.textContent = isMuted ? 'ğŸ”‡' : (craneMasterVolume < 0.5 ? 'ğŸ”ˆ' : 'ğŸ”Š');
            if (slider) {
                slider.value = volumePercent;
                slider.classList.toggle('muted', isMuted);
            }
        }

        function toggleCraneMute() {
            if (craneMasterVolume > 0) {
                craneMasterVolume = 0;
                localStorage.setItem(CRANE_SOUND_KEY, 'false');
            } else {
                craneMasterVolume = craneStoredVolume;
                localStorage.setItem(CRANE_SOUND_KEY, 'true');
            }
            updateCraneVolumeUI();
        }

        function setCraneMasterVolume(volumePercent) {
            const vol = volumePercent / 100;
            craneStoredVolume = vol;
            craneMasterVolume = vol;
            localStorage.setItem(CRANE_VOLUME_KEY, vol.toString());
            localStorage.setItem(CRANE_SOUND_KEY, vol > 0 ? 'true' : 'false');
            updateCraneVolumeUI();
        }

        // í¬ë ˆì¸ ì‚¬ìš´ë“œ (Web Audio API)
        const CraneSound = {
            audioCtx: null,
            init() {
                if (this.audioCtx) return this.audioCtx;
                this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                return this.audioCtx;
            },
            ensureContext() {
                if (!this.audioCtx) this.init();
                if (this.audioCtx.state === 'suspended') this.audioCtx.resume();
            },
            playMotor() {
                if (document.visibilityState !== 'visible' || !document.hasFocus()) return;
                this.ensureContext();
                if (!this.audioCtx) return;
                const vol = getCraneMasterVolume();
                const osc = this.audioCtx.createOscillator();
                const gain = this.audioCtx.createGain();
                osc.type = 'sawtooth';
                osc.frequency.value = 120;
                gain.gain.setValueAtTime(0.06 * vol, this.audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.audioCtx.currentTime + 0.15);
                osc.connect(gain);
                gain.connect(this.audioCtx.destination);
                osc.start(this.audioCtx.currentTime);
                osc.stop(this.audioCtx.currentTime + 0.15);
            },
            playGrab() {
                if (document.visibilityState !== 'visible' || !document.hasFocus()) return;
                this.ensureContext();
                if (!this.audioCtx) return;
                const vol = getCraneMasterVolume();
                const osc = this.audioCtx.createOscillator();
                const gain = this.audioCtx.createGain();
                osc.type = 'square';
                osc.frequency.value = 200;
                gain.gain.setValueAtTime(0.1 * vol, this.audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.audioCtx.currentTime + 0.3);
                osc.connect(gain);
                gain.connect(this.audioCtx.destination);
                osc.start(this.audioCtx.currentTime);
                osc.stop(this.audioCtx.currentTime + 0.3);
            },
            playDrop() {
                if (document.visibilityState !== 'visible' || !document.hasFocus()) return;
                this.ensureContext();
                if (!this.audioCtx) return;
                const vol = getCraneMasterVolume();
                const osc = this.audioCtx.createOscillator();
                const gain = this.audioCtx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(400, this.audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, this.audioCtx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.15 * vol, this.audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.audioCtx.currentTime + 0.3);
                osc.connect(gain);
                gain.connect(this.audioCtx.destination);
                osc.start(this.audioCtx.currentTime);
                osc.stop(this.audioCtx.currentTime + 0.3);
            },
            playWinner() {
                if (document.visibilityState !== 'visible' || !document.hasFocus()) return;
                this.ensureContext();
                if (!this.audioCtx) return;
                const vol = getCraneMasterVolume();
                const notes = [523.25, 659.25, 783.99, 1046.50];
                const gain = this.audioCtx.createGain();
                gain.gain.setValueAtTime(0.25 * vol, this.audioCtx.currentTime);
                gain.connect(this.audioCtx.destination);
                notes.forEach((freq, i) => {
                    const osc = this.audioCtx.createOscillator();
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    osc.connect(gain);
                    osc.start(this.audioCtx.currentTime + i * 0.12);
                    osc.stop(this.audioCtx.currentTime + i * 0.12 + 0.25);
                });
            }
        };

        // ë””ë°”ì´ìŠ¤ ID ìƒì„±/ê°€ì ¸ì˜¤ê¸°
        function getDeviceId() {
            let deviceId = localStorage.getItem('craneGameDeviceId');
            if (!deviceId) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('craneGameDeviceId', deviceId);
            }
            return deviceId;
        }

        // ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ ë‹«ê¸°
        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('roomPasswordInput').value = '';
            pendingRoomId = null;
            pendingUserName = null;
        }

        // ë¹„ë°€ë²ˆí˜¸ ì œì¶œ
        function submitPassword() {
            const password = document.getElementById('roomPasswordInput').value;
            if (pendingRoomId && pendingUserName) {
                socket.emit('joinRoom', {
                    roomId: pendingRoomId,
                    userName: pendingUserName,
                    isHost: false,
                    password: password,
                    deviceId: getDeviceId(),
                    tabId: getTabId()
                });
            }
            closePasswordModal();
        }

        // ë°© ë‚˜ê°€ê¸°
        function leaveRoom() {
            if (confirm('ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                socket.emit('leaveRoom');
            }
        }

        // ì¤€ë¹„ í•¨ìˆ˜ (ReadyModule ìœ„ì„)
        function toggleReady() { ReadyModule.toggleReady(); }
        function updateReadyButton() { ReadyModule.updateReadyButton(); }
        function renderReadyUsers() { ReadyModule.renderReadyUsers(); }

        // í¬ë ˆì¸ ë¨¸ì‹  ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        function updateCranePreview() {
            if (readyUsers.length >= 1) {
                renderDolls(readyUsers);
            } else {
                const grid = document.getElementById('dollsGrid');
                grid.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 20px; width: 100%; font-size: 14px;">ì¤€ë¹„í•œ ì‚¬ëŒì´<br>ì—†ìŠµë‹ˆë‹¤</div>';
                dollsRendered = false;
            }
        }

        // ì‹œì‘ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateStartButton() {
            const btn = document.getElementById('startCraneGameButton');
            if (btn && isHost) {
                if (readyUsers.length >= 2 && !isAnimating) {
                    btn.disabled = false;
                    btn.textContent = 'ğŸª„ ì¸í˜•ë½‘ê¸° ì‹œì‘!';
                } else {
                    btn.disabled = true;
                    btn.textContent = `ğŸª„ ì¸í˜•ë½‘ê¸° ì‹œì‘ (${readyUsers.length}/2ëª… ì¤€ë¹„)`;
                }
            }
        }

        // ì¸í˜•ë½‘ê¸° ì‹œì‘
        function startCraneGame() {
            if (readyUsers.length < 2) {
                alert('ìµœì†Œ 2ëª…ì´ ì¤€ë¹„í•´ì•¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!');
                return;
            }
            CraneSound.ensureContext();
            socket.emit('startCraneGame');
        }

        // ì¸í˜• ë Œë”ë§
        function renderDolls(participants) {
            const grid = document.getElementById('dollsGrid');
            grid.innerHTML = '';
            currentDollMap = {};
            dollsRendered = false;

            participants.forEach((name, idx) => {
                const doll = document.createElement('div');
                doll.className = 'doll';
                doll.setAttribute('data-player', name);
                doll.style.animationDelay = `${idx * 0.2}s`;

                const body = document.createElement('div');
                body.className = 'doll-body';
                body.style.background = DOLL_COLORS[idx % DOLL_COLORS.length];
                body.textContent = DOLL_EMOJIS[idx % DOLL_EMOJIS.length];

                const nameEl = document.createElement('div');
                nameEl.className = 'doll-name';
                nameEl.textContent = name.length > 6 ? name.substring(0, 6) + '..' : name;

                doll.appendChild(body);
                doll.appendChild(nameEl);
                grid.appendChild(doll);

                currentDollMap[name] = {
                    element: doll,
                    emoji: DOLL_EMOJIS[idx % DOLL_EMOJIS.length],
                    color: DOLL_COLORS[idx % DOLL_COLORS.length],
                    index: idx
                };
            });

            dollsRendered = true;
        }

        // ë§í’ì„  í‘œì‹œ
        function showSpeechBubble(userName, message) {
            if (!currentDollMap[userName]) return;
            const dollEl = currentDollMap[userName].element;
            if (!dollEl) return;

            // ê¸°ì¡´ ë§í’ì„  ì œê±°
            const existing = dollEl.querySelector('.speech-bubble');
            if (existing) existing.remove();

            const bubble = document.createElement('div');
            bubble.className = 'speech-bubble';
            bubble.textContent = message.length > 15 ? message.substring(0, 15) + '...' : message;
            dollEl.appendChild(bubble);

            // 4ì´ˆ í›„ ì œê±°
            setTimeout(() => {
                bubble.classList.add('fading');
                setTimeout(() => {
                    if (bubble.parentNode) bubble.remove();
                }, 500);
            }, 3500);
        }

        // í¬ë ˆì¸ ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰
        function playClawAnimation(data, callback) {
            const { participants, winnerIndex, winner, animParams } = data;
            const assembly = document.getElementById('craneAssembly');
            const arm = document.getElementById('craneArm');
            const fingers = document.getElementById('craneFingers');
            const machine = document.getElementById('craneMachine');
            const grid = document.getElementById('dollsGrid');
            const chute = document.getElementById('prizeChute');

            const params = animParams || {};
            const clawMoveDelay = params.clawMoveDelay || 500;
            const horizontalDuration = params.horizontalDuration || 1200;
            const descendDuration = params.descendDuration || 800;
            const grabPauseDuration = params.grabPauseDuration || 600;
            const liftDuration = params.liftDuration || 800;
            const dropDuration = params.dropDuration || 500;
            const fakeOuts = params.fakeOuts || [];
            const fakeOutPause = params.fakeOutPause || 400;

            // Phase 0: Render dolls
            renderDolls(participants);

            // Reset crane position
            assembly.style.transition = 'none';
            assembly.style.left = '50%';
            arm.style.transition = 'none';
            arm.style.height = '40px';
            fingers.style.transition = 'none';
            fingers.style.gap = '12px';

            // Force reflow
            assembly.offsetHeight;

            // Phase 1: Open fingers wide
            setTimeout(() => {
                fingers.style.transition = 'gap 0.4s ease-in-out';
                fingers.style.gap = '20px';
                CraneSound.playMotor();
            }, 300);

            // Phase 2: Move claw horizontally with fake-outs
            setTimeout(() => {
                const machineRect = machine.getBoundingClientRect();
                const railLeft = 20;
                const railRight = machineRect.width - 20;

                // Get all doll positions
                const dollElements = grid.querySelectorAll('.doll');
                const dollPositions = [];
                dollElements.forEach((d, i) => {
                    const rect = d.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2 - machineRect.left;
                    dollPositions.push(centerX);
                });

                const winnerX = dollPositions[winnerIndex] || (machineRect.width / 2);

                // Execute fake-outs then move to winner
                let totalFakeOutTime = 0;
                const executeFakeOuts = (index) => {
                    if (index >= fakeOuts.length) {
                        // Finally move to winner
                        assembly.style.transition = `left ${horizontalDuration}ms ease-in-out`;
                        assembly.style.left = winnerX + 'px';
                        CraneSound.playMotor();
                        return;
                    }

                    const fakeTarget = fakeOuts[index];
                    const fakeX = dollPositions[fakeTarget] || (machineRect.width * (fakeTarget + 0.5) / participants.length);
                    const moveDuration = 600;

                    assembly.style.transition = `left ${moveDuration}ms ease-in-out`;
                    assembly.style.left = fakeX + 'px';
                    CraneSound.playMotor();

                    setTimeout(() => {
                        executeFakeOuts(index + 1);
                    }, moveDuration + fakeOutPause);

                    totalFakeOutTime += moveDuration + fakeOutPause;
                };

                executeFakeOuts(0);

                // Phase 3: Descend after horizontal movement completes
                const totalHorizontalTime = (fakeOuts.length * (600 + fakeOutPause)) + horizontalDuration;

                setTimeout(() => {
                    // Phase 3: Descend
                    arm.style.transition = `height ${descendDuration}ms ease-in-out`;
                    const targetDoll = dollElements[winnerIndex];
                    let targetHeight = 200;
                    if (targetDoll) {
                        const dollRect = targetDoll.getBoundingClientRect();
                        const armTop = assembly.getBoundingClientRect().top + arm.offsetHeight;
                        targetHeight = Math.max(80, dollRect.top - armTop + 20);
                    }
                    arm.style.height = targetHeight + 'px';
                    CraneSound.playMotor();

                    // Phase 4: Close fingers and grab
                    setTimeout(() => {
                        fingers.style.transition = 'gap 0.4s ease-in-out';
                        fingers.style.gap = '2px';
                        CraneSound.playGrab();

                        if (targetDoll) {
                            targetDoll.classList.add('grabbed');
                        }

                        // Phase 5: Lift up
                        setTimeout(() => {
                            arm.style.transition = `height ${liftDuration}ms ease-in-out`;
                            arm.style.height = '40px';

                            // Make grabbed doll follow
                            if (targetDoll) {
                                targetDoll.style.transition = `transform ${liftDuration}ms ease-in-out, opacity ${liftDuration}ms`;
                                targetDoll.style.transform = 'translateY(-200px) scale(0.6)';
                                targetDoll.style.opacity = '0';
                            }

                            // Phase 6: Move to center (prize chute)
                            setTimeout(() => {
                                const chuteRect = chute.getBoundingClientRect();
                                const chuteX = chuteRect.left + chuteRect.width / 2 - machineRect.left;
                                assembly.style.transition = 'left 800ms ease-in-out';
                                assembly.style.left = chuteX + 'px';
                                CraneSound.playMotor();

                                // Phase 7: Open fingers and drop
                                setTimeout(() => {
                                    fingers.style.transition = 'gap 0.3s ease-in-out';
                                    fingers.style.gap = '20px';
                                    CraneSound.playDrop();

                                    // Show prize in chute
                                    const winnerEmoji = DOLL_EMOJIS[winnerIndex % DOLL_EMOJIS.length];
                                    const prizeEl = document.createElement('div');
                                    prizeEl.className = 'prize-in-chute';
                                    prizeEl.textContent = winnerEmoji;
                                    chute.appendChild(prizeEl);

                                    // Phase 8: Show result
                                    setTimeout(() => {
                                        if (callback) callback();
                                    }, dropDuration);
                                }, 500);
                            }, liftDuration);
                        }, grabPauseDuration);
                    }, descendDuration);
                }, totalHorizontalTime);
            }, clawMoveDelay);
        }

        // ì ‘ì†ì ëª©ë¡ ì—…ë°ì´íŠ¸
        let currentUsers = [];

        function updateUsers(users) {
            currentUsers = users;
            const usersList = document.getElementById('usersList');
            const usersCount = document.getElementById('usersCount');

            if (!usersList || !usersCount) return;

            usersCount.textContent = users.length;
            usersList.innerHTML = '';

            users.forEach(user => {
                const tag = document.createElement('div');
                tag.className = 'user-tag' + (user.isHost ? ' host' : '');

                let content = user.name;
                if (user.isHost) { content += ' ğŸ‘‘'; }
                if (user.name === currentUser) { content += ' (ë‚˜)'; }
                tag.textContent = content;

                // í˜¸ìŠ¤íŠ¸ê°€ ë‹¤ë¥¸ ì‚¬ìš©ìë¥¼ í´ë¦­í•˜ë©´ ì•¡ì…˜ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
                if (isHost && user.name !== currentUser) {
                    tag.style.cursor = 'pointer';
                    tag.title = 'í´ë¦­í•˜ì—¬ í˜¸ìŠ¤íŠ¸ì„ëª… ë˜ëŠ” ì œì™¸';

                    let isDragging = false;
                    let mouseDownTime = 0;
                    let mouseDownPos = { x: 0, y: 0 };

                    tag.addEventListener('mousedown', (e) => { isDragging = false; mouseDownTime = Date.now(); mouseDownPos = { x: e.clientX, y: e.clientY }; });
                    tag.addEventListener('mousemove', (e) => {
                        if (mouseDownTime > 0) {
                            const dx = Math.abs(e.clientX - mouseDownPos.x);
                            const dy = Math.abs(e.clientY - mouseDownPos.y);
                            if (dx > 5 || dy > 5) { isDragging = true; }
                        }
                    });
                    tag.addEventListener('click', (e) => {
                        if (!isDragging && Date.now() - mouseDownTime < 300) {
                            e.stopPropagation();
                            showPlayerActionDialog(user.name).then(action => {
                                if (action === 'host') {
                                    socket.emit('transferHost', user.name);
                                } else if (action === 'kick') {
                                    showCustomConfirm(`${user.name}ë‹˜ì„ ê²Œì„ì—ì„œ ì œì™¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, 'warning').then(result => {
                                        if (result) { socket.emit('kickPlayer', user.name); }
                                    });
                                }
                            });
                        }
                        isDragging = false;
                        mouseDownTime = 0;
                    });
                }

                // í˜¸ìŠ¤íŠ¸ì´ê³  ê²Œì„ ì§„í–‰ ì¤‘ì´ ì•„ë‹ ë•Œ ë“œë˜ê·¸ ê°€ëŠ¥
                if (isHost && !isAnimating) {
                    tag.draggable = true;
                    if (user.name !== currentUser) { tag.style.cursor = 'grab'; }
                    tag.setAttribute('data-user-name', user.name);
                    tag.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', user.name); e.dataTransfer.setData('source', 'users'); tag.style.opacity = '0.5'; });
                    tag.addEventListener('dragend', (e) => { tag.style.opacity = '1'; });
                }

                usersList.appendChild(tag);
            });

            // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì •
            if (isHost && !isAnimating) { setupDragAndDrop(); }
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì •
        function setupDragAndDrop() {
            const readyUsersList = document.getElementById('readyUsersList');
            const readySection = document.getElementById('readySection');

            if (!readyUsersList || !readySection) return;

            readyUsersList.addEventListener('dragover', (e) => {
                e.preventDefault();
                readyUsersList.style.backgroundColor = 'rgba(156, 39, 176, 0.1)';
                readyUsersList.style.border = '2px dashed var(--crane-accent)';
            });

            readyUsersList.addEventListener('dragleave', (e) => {
                readyUsersList.style.backgroundColor = '';
                readyUsersList.style.border = '';
            });

            readyUsersList.addEventListener('drop', (e) => {
                e.preventDefault();
                readyUsersList.style.backgroundColor = '';
                readyUsersList.style.border = '';

                if (!isHost || isAnimating) return;

                const userName = e.dataTransfer.getData('text/plain');
                const source = e.dataTransfer.getData('source');

                if (source === 'users' && userName) {
                    if (!readyUsers.includes(userName)) {
                        socket.emit('setUserReady', { userName: userName, isReady: true });
                    }
                }
            });
        }

        // ì±„íŒ… ë©”ì‹œì§€ ì¶”ê°€
        function getDeviceIcon(deviceType) {
            if (!deviceType) return '';
            if (deviceType === 'iOS') return 'ğŸ';
            if (deviceType === 'Android') return 'ğŸ“±';
            if (deviceType === 'PC') return 'ğŸ’»';
            return '';
        }

        function addChatMessage(data) {
            ChatModule.displayChatMessage(data);
        }

        // ê¸°ë¡ ë Œë”ë§
        function renderHistory() {
            const historyList = document.getElementById('historyList');
            if (!historyList) return;

            if (craneGameHistory.length === 0) {
                historyList.innerHTML = '<div style="color: var(--text-muted); text-align: center;">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            historyList.innerHTML = '';

            craneGameHistory.slice().reverse().forEach(record => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <div class="history-round">${record.round}ë¼ìš´ë“œ (${record.time})</div>
                    <div class="history-participants">ì°¸ê°€ì: ${record.participants.join(', ')}</div>
                    <div class="history-winner">ğŸ§¸ ë‹¹ì²¨: ${record.winner}</div>
                `;
                historyList.appendChild(item);
            });
        }

        // ê²Œì„ ì¢…ë£Œ
        function endCraneGameFull() {
            socket.emit('endCraneGame');
        }

        // ë‹¤ì‹œë³´ê¸°
        function replayCraneGame() {
            if (!lastCraneGameData) {
                addDebugLog('âš ï¸ ë‹¤ì‹œë³´ê¸° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'warn');
                return;
            }

            addDebugLog(`ğŸ”„ ë‹¤ì‹œë³´ê¸° ì‹œì‘ - winner: ${lastCraneGameData.winner}, missedCraneGame: ${missedCraneGame}`, 'info');

            document.getElementById('replaySection').style.display = 'none';

            const data = lastCraneGameData;
            const wasMissed = missedCraneGame;

            document.getElementById('startCraneGameButton').disabled = true;
            document.getElementById('startCraneGameButton').textContent = 'ğŸ¬ ë‹¤ì‹œë³´ê¸° ì¤‘...';

            // Reset crane machine
            resetCraneMachine();

            isAnimating = true;
            craneGameResultShown = false;

            setTimeout(() => {
                playClawAnimation(data, () => {
                    addDebugLog('âœ… ë‹¤ì‹œë³´ê¸° ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ', 'animation');

                    isAnimating = false;
                    craneGameResultShown = true;

                    // ê²°ê³¼ ì˜¤ë²„ë ˆì´ í‘œì‹œ
                    const winnerEmoji = DOLL_EMOJIS[data.winnerIndex % DOLL_EMOJIS.length];
                    document.getElementById('resultWinnerEmoji').textContent = winnerEmoji;
                    document.getElementById('resultWinner').textContent = data.winner;
                    document.getElementById('resultOverlay').classList.add('visible');
                    if (data.winner === currentUser) CraneSound.playWinner();
                    addDebugLog(`ğŸ§¸ ë‹¤ì‹œë³´ê¸° ê²°ê³¼ í‘œì‹œ - winner: ${data.winner}`, 'gameEnd');

                    document.getElementById('readySection').style.display = 'block';
                    document.getElementById('startCraneGameButton').disabled = false;
                    document.getElementById('startCraneGameButton').textContent = 'ğŸª„ ì¸í˜•ë½‘ê¸° ì‹œì‘';

                    if (isHost) { document.getElementById('endGameSection').style.display = 'block'; }

                    if (wasMissed) {
                        const winnerMessage = {
                            userName: 'ì‹œìŠ¤í…œ',
                            message: `ğŸ§¸ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ${data.winner}ë‹˜ì´ ë½‘í˜”ìŠµë‹ˆë‹¤! ğŸ‰ğŸ§¸`,
                            timestamp: new Date().toISOString(),
                            isSystem: true,
                            isCraneGameWinner: true
                        };
                        addChatMessage(winnerMessage);

                        if (data.record) {
                            const existingRecord = craneGameHistory.find(r => r.round === data.record.round);
                            if (!existingRecord) {
                                craneGameHistory.push(data.record);
                                renderHistory();
                            }
                        }
                        addDebugLog(`ğŸ“¢ ë‹¤ì‹œë³´ê¸° ì±„íŒ… ë° ê¸°ë¡ í‘œì‹œ ì™„ë£Œ (ë†“ì¹œ ì¸í˜•ë½‘ê¸°)`, 'info');
                    } else {
                        addDebugLog(`ğŸ“¢ ë‹¤ì‹œë³´ê¸° ì™„ë£Œ (ì´ë¯¸ ë³¸ ì¸í˜•ë½‘ê¸°)`, 'info');
                    }

                    missedCraneGame = false;
                    showReplayButton();
                });
            }, 50);
        }

        // í¬ë ˆì¸ ë¨¸ì‹  ë¦¬ì…‹
        function resetCraneMachine() {
            const assembly = document.getElementById('craneAssembly');
            const arm = document.getElementById('craneArm');
            const fingers = document.getElementById('craneFingers');
            const chute = document.getElementById('prizeChute');

            assembly.style.transition = 'none';
            assembly.style.left = '50%';
            arm.style.transition = 'none';
            arm.style.height = '40px';
            fingers.style.transition = 'none';
            fingers.style.gap = '12px';

            // Clear prize from chute
            const prizes = chute.querySelectorAll('.prize-in-chute');
            prizes.forEach(p => p.remove());

            assembly.offsetHeight;
        }

        // ë‹¤ì‹œë³´ê¸° ë²„íŠ¼ í‘œì‹œ í•¨ìˆ˜
        function showReplayButton() {
            if (lastCraneGameData) {
                const replaySection = document.getElementById('replaySection');
                const replayMessage = replaySection.querySelector('div');
                if (replayMessage) { replayMessage.textContent = 'ğŸ¬ ë§ˆì§€ë§‰ ì¸í˜•ë½‘ê¸° ë‹¤ì‹œë³´ê¸°'; }
                replaySection.style.display = 'block';
            }
        }

        // ê²°ê³¼ ì˜¤ë²„ë ˆì´ ë‹«ê¸°
        function closeResultOverlay() {
            document.getElementById('resultOverlay').classList.remove('visible');
        }

        // ë°© í­íŒŒ ì¹´ìš´íŠ¸ë‹¤ìš´
        function startRoomExpiryCountdown(createdAt, expiryHours) {
            if (roomExpiryInterval) { clearInterval(roomExpiryInterval); }

            const expirySection = document.getElementById('roomExpirySection');
            const countdownElement = document.getElementById('roomExpiryCountdown');

            if (!expirySection || !countdownElement) return;

            expirySection.style.display = 'block';

            function updateCountdown() {
                const now = new Date();
                const createdAtDate = new Date(createdAt);
                const expiryTime = createdAtDate.getTime() + (expiryHours * 60 * 60 * 1000);
                const remaining = expiryTime - now.getTime();

                if (remaining <= 0) {
                    countdownElement.textContent = '00:00:00';
                    if (roomExpiryInterval) { clearInterval(roomExpiryInterval); }
                    return;
                }

                const hours = Math.floor(remaining / (1000 * 60 * 60));
                const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remaining % (1000 * 60)) / 1000);

                countdownElement.textContent =
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }

            updateCountdown();
            roomExpiryInterval = setInterval(updateCountdown, 1000);
        }

        // ê²Œì„ í™”ë©´ ì´ˆê¸°í™”
        function initializeGameScreen(data) {
            document.getElementById('roomTitle').textContent = data.roomName || 'ì¸í˜•ë½‘ê¸° ë°©';

            if (data.createdAt && data.expiryHours) {
                startRoomExpiryCountdown(data.createdAt, data.expiryHours);
            }

            // ì‚¬ìš©ì ëª©ë¡ ì´ˆê¸°í™”
            if (data.gameState && data.gameState.users) {
                currentUsers = data.gameState.users;
            }

            // ëˆ„ì  ì°¸ì—¬ì ëª©ë¡ ë³µì›
            if (data.everPlayedUsers && Array.isArray(data.everPlayedUsers)) {
                everPlayedUsers = [...data.everPlayedUsers];
            } else if (data.gameState && data.gameState.everPlayedUsers && Array.isArray(data.gameState.everPlayedUsers)) {
                everPlayedUsers = [...data.gameState.everPlayedUsers];
            } else {
                everPlayedUsers = [];
            }

            // ì£¼ë¬¸ë°›ê¸° ìƒíƒœ ì´ˆê¸°í™”
            isOrderActive = data.isOrderActive || false;
            OrderModule.setIsOrderActive(isOrderActive);
            ordersData = data.userOrders || {};
            OrderModule.setOrdersData(ordersData);

            // ë‚´ ì£¼ë¬¸ ë¶ˆëŸ¬ì˜¤ê¸°
            const myOrderInput = document.getElementById('myOrderInput');
            if (myOrderInput && data.myOrder) { myOrderInput.value = data.myOrder; }

            // í˜¸ìŠ¤íŠ¸ UI ì„¤ì •
            if (isHost) {
                document.getElementById('hostBadge').style.display = 'inline-block';
                document.getElementById('hostControls').style.display = 'block';
                const dragHint = document.getElementById('dragHint');
                if (dragHint) dragHint.style.display = 'inline';

                if (isOrderActive) {
                    document.getElementById('startOrderButton').style.display = 'none';
                    document.getElementById('endOrderButton').style.display = 'block';
                } else {
                    document.getElementById('startOrderButton').style.display = 'block';
                    document.getElementById('endOrderButton').style.display = 'none';
                }
            } else {
                document.getElementById('hostBadge').style.display = 'none';
                document.getElementById('hostControls').style.display = 'none';
                const dragHint = document.getElementById('dragHint');
                if (dragHint) dragHint.style.display = 'none';
            }

            // ì£¼ë¬¸ë°›ê¸° ì„¹ì…˜ í‘œì‹œ
            if (isOrderActive) {
                document.getElementById('ordersSection').style.display = 'block';
                document.getElementById('myOrderInput').disabled = false;
                document.getElementById('orderSaveButton').disabled = false;
            } else {
                if (Object.keys(ordersData).length > 0) {
                    document.getElementById('ordersSection').style.display = 'block';
                }
                document.getElementById('myOrderInput').disabled = true;
                document.getElementById('orderSaveButton').disabled = true;
            }

            OrderModule.renderOrders();
            OrderModule.renderNotOrderedUsers();

            // ìì£¼ ì“°ëŠ” ë©”ë‰´ ë¶ˆëŸ¬ì˜¤ê¸°
            if (data.frequentMenus !== undefined) {
                frequentMenus = data.frequentMenus;
                OrderModule.renderMenuList();
            } else {
                socket.emit('getFrequentMenus');
            }

            // ê¸°ë¡ ì„¹ì…˜ í‘œì‹œ
            document.getElementById('historySection').classList.add('visible');

            // ì±„íŒ… ê¸°ë¡ ë¡œë“œ
            if (data.chatHistory) {
                document.getElementById('chatMessages').innerHTML = '';
                data.chatHistory.forEach(msg => addChatMessage(msg));
                ChatModule.recalculatePins();
            }

            // ê²Œì„ ê¸°ë¡ ë¡œë“œ
            if (data.gameState && data.gameState.craneGameHistory) {
                craneGameHistory = data.gameState.craneGameHistory;
                renderHistory();
            }

            // ì¤€ë¹„ ìƒíƒœ ë³µì›
            if (data.readyUsers) {
                readyUsers = data.readyUsers;
                isReady = readyUsers.includes(currentUser);
                ReadyModule.setReadyUsers(readyUsers);
            }

            // í¬ë ˆì¸ ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™”
            updateCranePreview();
        }

        // === ì†Œì¼“ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ===

        socket.on('connect', () => {});
        socket.on('disconnect', () => {});

        socket.on('roomCreated', (data) => {
            currentRoomId = data.roomId;
            currentUser = data.userName || '';
            sessionStorage.setItem('craneGameActiveRoom', JSON.stringify({
                roomId: data.roomId, userName: currentUser,
                serverId: currentServerId, serverName: currentServerName
            }));
            initChatModule();
            isHost = true;
            isReady = data.isReady || false;
            readyUsers = data.readyUsers || [];
            initReadyModule();
            initOrderModule();

            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('gameSection').classList.add('active');
            document.body.classList.add('game-active');

            initializeGameScreen(data);
            ReadyModule.setReadyUsers(readyUsers);
        });

        socket.on('roomJoined', (data) => {
            sessionStorage.removeItem('craneGameFromDice');
            document.getElementById('loadingScreen').style.display = 'none';

            currentRoomId = data.roomId;
            const globalInput = document.getElementById('globalUserNameInput');
            currentUser = (globalInput && globalInput.value) || data.userName || '';
            sessionStorage.setItem('craneGameActiveRoom', JSON.stringify({
                roomId: data.roomId, userName: currentUser,
                serverId: currentServerId, serverName: currentServerName
            }));
            initChatModule();
            isHost = data.isHost;
            isReady = data.isReady || false;
            readyUsers = data.readyUsers || [];
            initReadyModule();
            initOrderModule();

            document.getElementById('gameSection').classList.add('active');
            document.body.classList.add('game-active');

            initializeGameScreen(data);
            ReadyModule.setReadyUsers(readyUsers);
        });

        socket.on('roomError', (message) => {
            sessionStorage.removeItem('craneGameFromDice');
            sessionStorage.removeItem('craneGameActiveRoom');
            alert(message);
            window.location.href = '/game';
        });

        socket.on('craneGameError', (message) => {
            alert(message);
        });

        // ì£¼ë¬¸ë°›ê¸° ì´ë²¤íŠ¸ (OrderModuleì—ì„œ ì²˜ë¦¬)

        socket.on('updateUsers', (users) => {
            if (window.SoundManager) SoundManager.playSound('common_notification', getCraneSoundEnabled());
            ChatModule.updateConnectedUsers(users);
            currentUsers = users;

            const myUser = users.find(u => u.name === currentUser);
            if (myUser && myUser.isHost !== isHost) {
                const wasHost = isHost;
                isHost = myUser.isHost;
                if (isHost && !wasHost) {
                    document.getElementById('hostBadge').style.display = 'inline-block';
                    document.getElementById('hostControls').style.display = 'block';
                    updateStartButton();
                    if (isOrderActive) {
                        document.getElementById('startOrderButton').style.display = 'none';
                        document.getElementById('endOrderButton').style.display = 'block';
                    } else {
                        document.getElementById('startOrderButton').style.display = 'block';
                        document.getElementById('endOrderButton').style.display = 'none';
                    }
                } else if (!isHost && wasHost) {
                    document.getElementById('hostBadge').style.display = 'none';
                    document.getElementById('hostControls').style.display = 'none';
                    updateStartButton();
                    document.getElementById('startOrderButton').style.display = 'none';
                    document.getElementById('endOrderButton').style.display = 'none';
                }
            }

            updateUsers(users);
            if (isOrderActive) { OrderModule.renderNotOrderedUsers(); }
        });

        // ì¸í˜•ë½‘ê¸° ì‹¤ì œ ì‹œì‘ í•¨ìˆ˜
        function actuallyStartCraneGame(data) {
            addDebugLog(`ğŸª„ actuallyStartCraneGame í˜¸ì¶œ - isHost: ${isHost}, visibilityState: ${document.visibilityState}`, 'info');

            if (document.visibilityState !== 'visible') {
                addDebugLog('âš ï¸ í™”ë©´ì´ ë³´ì´ì§€ ì•ŠìŒ - ì¸í˜•ë½‘ê¸° ë¬´ì‹œ', 'visibility');
                craneGameResultShown = true;
                isAnimating = false;
                pendingCraneGameData = null;
                document.getElementById('resultOverlay').classList.remove('visible');
                document.getElementById('readySection').style.display = 'block';
                document.getElementById('startCraneGameButton').disabled = false;
                document.getElementById('startCraneGameButton').textContent = 'ğŸª„ ì¸í˜•ë½‘ê¸° ì‹œì‘';
                return;
            }

            addDebugLog('âœ… í™”ë©´ì´ ë³´ì„ - ì¸í˜•ë½‘ê¸° ì‹œì‘ ì§„í–‰', 'info');
            isAnimating = true;
            pendingCraneGameData = null;
            craneGameResultShown = false;

            if (data.everPlayedUsers && Array.isArray(data.everPlayedUsers)) {
                everPlayedUsers = [...data.everPlayedUsers];
            }

            document.getElementById('startCraneGameButton').disabled = true;
            document.getElementById('startCraneGameButton').textContent = 'ğŸª„ ì¸í˜•ë½‘ê¸° ì§„í–‰ ì¤‘...';

            // Reset crane machine
            resetCraneMachine();

            const animationStartTime = Date.now();

            setTimeout(() => {
                if (document.visibilityState !== 'visible') {
                    addDebugLog('âš ï¸ setTimeout ì•ˆì—ì„œ í™”ë©´ NOT visible - ì¸í˜•ë½‘ê¸° ë¬´ì‹œ', 'visibility');
                    craneGameResultShown = true;
                    isAnimating = false;
                    pendingCraneGameData = null;
                    document.getElementById('resultOverlay').classList.remove('visible');
                    document.getElementById('readySection').style.display = 'block';
                    document.getElementById('startCraneGameButton').disabled = false;
                    document.getElementById('startCraneGameButton').textContent = 'ğŸª„ ì¸í˜•ë½‘ê¸° ì‹œì‘';
                    return;
                }

                const wasAnimating = isAnimating;
                craneGameResultShown = false;

                playClawAnimation(data, () => {
                    if (craneGameResultShown) {
                        addDebugLog('âš ï¸ ê²°ê³¼ ì´ë¯¸ í‘œì‹œë¨ - ì¤‘ë³µ ë°©ì§€ë¡œ return', 'warn');
                        return;
                    }

                    if (!wasAnimating) {
                        addDebugLog('âš ï¸ wasAnimating=false - ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ ì•ˆ ë¨, return', 'warn');
                        return;
                    }

                    addDebugLog('âœ… ëª¨ë“  ì²´í¬ í†µê³¼ - ê²°ê³¼ í‘œì‹œ ì§„í–‰', 'info');
                    isAnimating = false;
                    craneGameResultShown = true;

                    // í˜¸ìŠ¤íŠ¸ë§Œ ê²°ê³¼ ì´ë²¤íŠ¸ ì „ì†¡
                    if (isHost) {
                        addDebugLog(`ğŸ“¤ craneGameResult emit - winner: ${data.winner}`, 'info');
                        socket.emit('craneGameResult', { winner: data.winner });
                    }

                    // ê²°ê³¼ ì˜¤ë²„ë ˆì´ í‘œì‹œ
                    const winnerEmoji = DOLL_EMOJIS[data.winnerIndex % DOLL_EMOJIS.length];
                    document.getElementById('resultWinnerEmoji').textContent = winnerEmoji;
                    document.getElementById('resultWinner').textContent = data.winner;
                    document.getElementById('resultOverlay').classList.add('visible');
                    if (data.winner === currentUser) CraneSound.playWinner();
                    if (window.SoundManager) SoundManager.stopLoop('crane-game_bgm');

                    addDebugLog(`ğŸ§¸ ê²°ê³¼ ì˜¤ë²„ë ˆì´ í‘œì‹œ - winner: ${data.winner}`, 'gameEnd');

                    // ê¸°ë¡ ì¶”ê°€
                    craneGameHistory.push(data.record);
                    renderHistory();

                    if (isHost) { document.getElementById('endGameSection').style.display = 'block'; }

                    showReplayButton();
                    updateStartButton();
                });
            }, 50);
        }

        socket.on('craneGameStarted', (data) => {
            if (window.SoundManager) SoundManager.playLoop('crane-game_bgm', getCraneSoundEnabled(), 0.3);
            const hasFocus = document.hasFocus();
            const isVisible = document.visibilityState === 'visible';
            const isActuallyVisible = isVisible && hasFocus;

            addDebugLog(`ğŸ“¨ craneGameStarted ì´ë²¤íŠ¸ ìˆ˜ì‹  - isHost: ${isHost}, visible: ${isVisible}, hasFocus: ${hasFocus}`, 'info');
            addDebugLog(`ğŸ“Š data: winner=${data.winner}, participants=${data.participants?.length}ëª…`, 'info');

            lastCraneGameData = data;
            document.getElementById('replaySection').style.display = 'none';

            if (isActuallyVisible) {
                addDebugLog('âœ… í™”ë©´ visible + í¬ì»¤ìŠ¤ ìˆìŒ â†’ actuallyStartCraneGame í˜¸ì¶œ', 'info');
                missedCraneGame = false;
                actuallyStartCraneGame(data);
            } else {
                addDebugLog(`âš ï¸ í™”ë©´ NOT visible (visible=${isVisible}, focus=${hasFocus}) â†’ ì¸í˜•ë½‘ê¸° ë¬´ì‹œ, ë‹¤ì‹œë³´ê¸° ë°ì´í„° ì €ì¥`, 'visibility');
                missedCraneGame = true;
                craneGameResultShown = true;
                isAnimating = false;
                pendingCraneGameData = null;
                document.getElementById('resultOverlay').classList.remove('visible');

                const replaySection = document.getElementById('replaySection');
                const replayMessage = replaySection.querySelector('div');
                if (replayMessage) { replayMessage.textContent = 'ğŸ¬ í™”ë©´ì„ ë³´ì§€ ì•ŠëŠ” ë™ì•ˆ ì¸í˜•ë½‘ê¸°ê°€ ì§„í–‰ë˜ì—ˆìŠµë‹ˆë‹¤'; }
                replaySection.style.display = 'block';

                document.getElementById('readySection').style.display = 'block';
                document.getElementById('startCraneGameButton').disabled = false;
                document.getElementById('startCraneGameButton').textContent = 'ğŸª„ ì¸í˜•ë½‘ê¸° ì‹œì‘';
            }
        });

        socket.on('craneGameEnded', (data) => {
            isReady = false;
            updateReadyButton();
        });

        socket.on('craneGameFullEnded', (data) => {
            isAnimating = false;
            craneGameResultShown = false;
            missedCraneGame = false;
            lastCraneGameData = null;
            isReady = false;

            document.getElementById('resultOverlay').classList.remove('visible');
            document.getElementById('replaySection').style.display = 'none';

            document.getElementById('craneContainer').style.display = 'flex';
            document.getElementById('readySection').style.display = 'block';
            document.getElementById('endGameSection').style.display = 'none';

            updateReadyButton();
            resetCraneMachine();

            if (isHost) { document.getElementById('hostControls').style.display = 'block'; }

            readyUsers = [];
            isReady = false;
            ReadyModule.setReadyUsers([]);
            updateStartButton();
            updateCranePreview();
        });

        socket.on('roomDeleted', (data) => {
            sessionStorage.removeItem('craneGameActiveRoom');
            alert(data.message || 'ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            if (roomExpiryInterval) { clearInterval(roomExpiryInterval); }
            sessionStorage.setItem('returnToLobby', JSON.stringify({ serverId: currentServerId }));
            window.location.replace('/game');
        });

        socket.on('roomLeft', () => {
            sessionStorage.removeItem('craneGameActiveRoom');
            if (roomExpiryInterval) { clearInterval(roomExpiryInterval); }
            sessionStorage.setItem('returnToLobby', JSON.stringify({ serverId: currentServerId }));
            window.location.replace('/game');
        });

        socket.on('leftRoom', () => {
            sessionStorage.removeItem('craneGameActiveRoom');
            if (roomExpiryInterval) { clearInterval(roomExpiryInterval); }
            sessionStorage.setItem('returnToLobby', JSON.stringify({ serverId: currentServerId }));
            window.location.replace('/game');
        });

        socket.on('hostTransferred', (data) => {
            showCustomAlert(data.message || 'í˜¸ìŠ¤íŠ¸ ê¶Œí•œì´ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            isHost = true;
            document.getElementById('hostBadge').style.display = 'inline-block';
            document.getElementById('hostControls').style.display = 'block';
            updateStartButton();

            if (isOrderActive) {
                document.getElementById('startOrderButton').style.display = 'none';
                document.getElementById('endOrderButton').style.display = 'block';
            } else {
                document.getElementById('startOrderButton').style.display = 'block';
                document.getElementById('endOrderButton').style.display = 'none';
            }
        });

        socket.on('hostChanged', (data) => {
            console.log('í˜¸ìŠ¤íŠ¸ ë³€ê²½ ì•Œë¦¼:', data.message);
        });

        // DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            // ë³¼ë¥¨ ì»¨íŠ¸ë¡¤ ì´ˆê¸°í™”
            initCraneVolumeFromStorage();
            updateCraneVolumeUI();
            const volumeBtn = document.getElementById('volumeBtn');
            const volumeSlider = document.getElementById('volumeSlider');
            if (volumeBtn) volumeBtn.addEventListener('click', toggleCraneMute);
            if (volumeSlider) volumeSlider.addEventListener('input', () => setCraneMasterVolume(parseInt(volumeSlider.value)));

            // ì €ì¥ëœ ì´ë¦„ ë¶ˆëŸ¬ì˜¤ê¸°
            const savedName = localStorage.getItem('craneGameUserName');
            if (savedName) {
                document.getElementById('globalUserNameInput').value = savedName;
            }

            // URL íŒŒë¼ë¯¸í„°ë¡œ ë°© ìƒì„±/ì…ì¥ ìš”ì²­ì´ ì™”ëŠ”ì§€ í™•ì¸
            const urlParams = new URLSearchParams(window.location.search);

            // ë°© ìƒì„± ìš”ì²­
            if (urlParams.get('createRoom') === 'true') {
                const pendingRoom = localStorage.getItem('pendingCraneGameRoom');
                if (pendingRoom) {
                    const roomData = JSON.parse(pendingRoom);
                    localStorage.removeItem('pendingCraneGameRoom');

                    socket.on('connect', function onConnect() {
                        socket.off('connect', onConnect);

                        socket.emit('createRoom', {
                            userName: roomData.userName,
                            roomName: roomData.roomName,
                            isPrivate: roomData.isPrivate,
                            password: roomData.password,
                            gameType: 'crane-game',
                            expiryHours: roomData.expiryHours,
                            blockIPPerUser: roomData.blockIPPerUser,
                            deviceId: getDeviceId(),
                            serverId: roomData.serverId || currentServerId,
                            serverName: roomData.serverName || currentServerName,
                            tabId: getTabId()
                        });
                    });

                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }

            // ë°© ì…ì¥ ìš”ì²­
            if (urlParams.get('joinRoom') === 'true') {
                const pendingJoin = localStorage.getItem('pendingCraneGameJoin');
                if (pendingJoin) {
                    const joinData = JSON.parse(pendingJoin);
                    localStorage.removeItem('pendingCraneGameJoin');

                    sessionStorage.setItem('craneGameFromDice', 'true');

                    document.getElementById('globalUserNameInput').value = joinData.userName;

                    socket.on('connect', function onJoinConnect() {
                        socket.off('connect', onJoinConnect);

                        if (joinData.isPrivate) {
                            pendingRoomId = joinData.roomId;
                            pendingUserName = joinData.userName;
                            document.getElementById('passwordModal').style.display = 'flex';
                            document.getElementById('roomPasswordInput').focus();
                        } else {
                            socket.emit('joinRoom', {
                                roomId: joinData.roomId,
                                userName: joinData.userName,
                                isHost: false,
                                password: '',
                                deviceId: getDeviceId(),
                                tabId: getTabId()
                            });
                        }
                    });

                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
        });
    </script>
</body>
</html>
