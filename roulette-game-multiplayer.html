<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Google AdSense -->
    <meta name="google-adsense-account" content="ca-pub-1608259764663412">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1608259764663412" crossorigin="anonymous"></script>
    <title>LAM Roulette ğŸ°</title>

    <!-- FOUC Prevention: Always use light theme -->
    <script>
      (function() {
        // Always use light mode regardless of system preference
        document.documentElement.setAttribute('data-theme', 'light');
      })();
    </script>

    <!-- Theme Variables -->
    <link rel="stylesheet" href="/css/theme.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Yeon+Sung&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--roulette-gradient);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            position: relative;
        }

        .container {
            background: var(--bg-white);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px auto;
        }
        
        body.game-active .container {
            margin-left: calc((100vw - 1140px) / 2 + 160px);
            margin-right: auto;
            max-width: 800px;
        }
        
        body.game-active header,
        body.game-active footer {
            display: none;
        }

        h1 {
            text-align: center;
            color: var(--roulette-accent);
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .game-section {
            display: none;
        }

        .game-section.active {
            display: block;
        }

        button {
            background: linear-gradient(135deg, var(--roulette-accent) 0%, var(--roulette-600) 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(233, 30, 99, 0.3);
        }

        button:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--gray-300);
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 10px;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus, input[type="password"]:focus {
            border-color: var(--roulette-accent);
            outline: none;
        }

        .connection-status {
            text-align: center;
            padding: 5px;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .connection-status.connected {
            color: var(--green-500);
        }

        .connection-status.disconnected {
            color: var(--red-500);
        }

        .connection-sound-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .connection-sound-row label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
        }
        .connection-sound-row input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        /* ë£°ë › ì»¨í…Œì´ë„ˆ */
        .roulette-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .roulette-wrapper {
            position: relative;
            width: 350px;
            height: 350px;
            margin: 20px auto;
        }

        /* ë£°ë › íŒ */
        .roulette-wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3), inset 0 0 20px rgba(0, 0, 0, 0.2);
            border: 8px solid var(--text-primary);
            transition: transform 0.1s ease-out;
        }

        /* ë£°ë › ì¤‘ì•™ */
        .roulette-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
            border-radius: 50%;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        /* í™”ì‚´í‘œ (12ì‹œ ë°©í–¥ ê³ ì •) */
        .roulette-pointer {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 35px solid #ff1744;
            z-index: 20;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.3));
        }

        /* ë£°ë › ì„¸ê·¸ë¨¼íŠ¸ */
        .roulette-segment {
            position: absolute;
            width: 50%;
            height: 50%;
            top: 0;
            right: 0;
            transform-origin: bottom left;
            overflow: hidden;
        }

        .segment-content {
            position: absolute;
            width: 200%;
            height: 200%;
            bottom: 0;
            left: 0;
            transform-origin: bottom left;
            display: flex;
            align-items: center;
            justify-content: center;
            padding-top: 20px;
        }

        .segment-text {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translateX(-50%) rotate(90deg);
            font-size: 14px;
            font-weight: bold;
            color: var(--bg-white);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            white-space: nowrap;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ì¤€ë¹„ ì„¹ì…˜ */
        .ready-section {
            background: var(--bg-primary);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid var(--roulette-accent);
        }

        .users-list {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 50px;
        }

        .user-tag {
            background: var(--bg-white);
            border: 2px solid var(--dice-accent);
            color: var(--dice-accent);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .user-tag.host {
            background: var(--dice-accent);
            color: white;
        }

        /* ê²Œì„ ê¸°ë¡ */
        .history-section {
            position: fixed;
            right: 20px;
            top: 20px;
            width: 320px;
            max-height: calc(100vh - 40px);
            background: var(--bg-white);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 20px;
            overflow-y: auto;
            display: none;
        }

        .history-section.visible {
            display: block;
        }

        .history-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--roulette-accent);
            margin-bottom: 15px;
            text-align: center;
        }

        .history-item {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid var(--roulette-accent);
        }

        .history-round {
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .history-participants {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .history-winner {
            font-size: 16px;
            font-weight: bold;
            color: var(--roulette-accent);
        }

        /* ì±„íŒ… ì„¹ì…˜ */
        .chat-section {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            border: 2px solid var(--roulette-accent);
        }

        .chat-messages {
            max-height: 480px;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            background: var(--bg-white);
            border-radius: 8px;
        }

        .chat-message.system {
            margin-bottom: 10px;
            padding: 12px;
            background: linear-gradient(135deg, var(--roulette-accent) 0%, var(--roulette-600) 100%);
            color: white;
            text-align: center;
            font-weight: bold;
            border-radius: 8px;
        }

        .chat-message.winner {
            background: linear-gradient(135deg, var(--yellow-500) 0%, var(--yellow-600) 100%);
            color: var(--text-primary);
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            padding: 15px;
            animation: celebrate 0.5s ease-in-out infinite alternate;
            border-radius: 8px;
        }

        @keyframes celebrate {
            from { transform: scale(1); }
            to { transform: scale(1.02); }
        }

        /* ì ‘ì†ì ëª©ë¡ */
        .users-section {
            margin-bottom: 20px;
        }

        .users-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--dice-accent);
        }

        /* ë°© ì •ë³´ í—¤ë” */
        .room-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--gray-200);
        }

        .room-title {
            font-size: 24px;
            color: var(--roulette-accent);
            font-weight: bold;
            margin-bottom: 5px;
        }

        /* í˜¸ìŠ¤íŠ¸ ì»¨íŠ¸ë¡¤ */
        .host-controls {
            display: none;
            background: linear-gradient(135deg, var(--yellow-100) 0%, var(--yellow-200) 100%);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid var(--yellow-500);
        }

        .start-button {
            background: linear-gradient(135deg, var(--btn-ready) 0%, var(--green-400) 100%);
            font-size: 20px;
            padding: 15px 30px;
        }

        .start-button:disabled {
            background: var(--gray-300);
        }

        .end-button {
            background: linear-gradient(135deg, var(--btn-danger) 0%, var(--red-400) 100%);
        }

        /* ê²°ê³¼ ì˜¤ë²„ë ˆì´ */
        .result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .result-overlay.visible {
            display: flex;
        }

        .result-card {
            background: var(--bg-white);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            animation: popup 0.5s ease-out;
        }

        @keyframes popup {
            from {
                transform: scale(0.5);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
            15% { opacity: 1; transform: translateX(-50%) translateY(0); }
            85% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }

        .result-title {
            font-size: 24px;
            color: var(--roulette-accent);
            margin-bottom: 20px;
        }

        .result-winner {
            font-size: 48px;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .result-message {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        /* ê²Œì„ íƒ€ì… ì•„ì´ì½˜ */
        .game-type-icon {
            font-size: 16px;
            margin-right: 5px;
        }

        /* ë°© í­íŒŒ ì¹´ìš´íŠ¸ë‹¤ìš´ */
        .room-expiry-section {
            background: var(--yellow-100);
            border: 2px solid var(--yellow-500);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        @media (max-width: 1200px) {
            body.game-active .container {
                margin-left: auto;
                margin-right: auto;
            }
            
            .history-section {
                position: static;
                width: 100%;
                max-height: none;
                margin-top: 20px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
                border-radius: 15px;
            }

            h1 {
                font-size: 1.8em;
            }

            .roulette-wrapper {
                width: 280px;
                height: 280px;
            }

            button, select, input[type="text"], .clickable {
                min-height: 44px;
                min-width: 44px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- ë¡œë”© í™”ë©´ -->
    <div id="loadingScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dice-gradient); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <div style="text-align: center; color: white;">
            <div style="font-size: 80px; margin-bottom: 20px; animation: bounce 1s infinite;">ğŸ°</div>
            <h2 style="font-size: 24px; margin-bottom: 10px;">ë°©ì— ì…ì¥ ì¤‘...</h2>
            <p style="font-size: 16px; opacity: 0.8;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
            <div style="margin-top: 30px;">
                <div style="width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
            </div>
        </div>
    </div>
    <style>
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        
        /* ì£¼ë¬¸ë°›ê¸° ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .orders-section {
            margin-bottom: 20px;
            display: none;
        }
        .orders-section.active {
            display: block;
        }
        .my-order-box {
            background: var(--yellow-50);
            border: 2px solid var(--yellow-500);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .my-order-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--yellow-900);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .order-input-group {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: start;
        }
        .order-input-wrapper {
            position: relative;
            width: 100%;
        }

        .autocomplete-suggestion {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 12px;
            color: var(--text-muted);
            pointer-events: none;
            font-family: inherit;
            font-size: 16px;
            line-height: 1.5;
            border: 2px solid transparent;
            border-radius: 8px;
            z-index: 1;
        }

        #myOrderInput {
            position: relative;
            z-index: 2;
            background-color: transparent;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-white);
            border: 2px solid var(--roulette-accent);
            border-radius: 8px;
            margin-top: 4px;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        .autocomplete-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--gray-100);
            transition: background-color 0.2s;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background-color: var(--purple-50);
        }

        .order-list {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .order-item {
            background: var(--bg-white);
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 3px solid var(--yellow-500);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .order-item:last-child {
            margin-bottom: 0;
        }

        .order-item-left {
            flex: 1;
        }

        .order-user {
            font-weight: 600;
            color: var(--yellow-900);
            margin-bottom: 4px;
        }

        .order-text {
            color: var(--text-secondary);
            font-size: 20px;
            font-weight: 600;
            word-break: break-word;
        }

        .order-text.empty {
            color: var(--text-muted);
            font-style: italic;
        }

        .order-count {
            font-size: 48px;
            font-weight: bold;
            color: var(--dice-accent);
            margin-left: 15px;
        }
        .menu-manager {
            background: var(--bg-primary);
            border: 2px solid var(--roulette-accent);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }
        .menu-manager.active {
            display: block;
        }
        .menu-manager-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .menu-manager-input {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
        }
        .menu-list {
            background: var(--bg-white);
            border-radius: 6px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
        }
        .menu-tag {
            display: inline-block;
            background: var(--roulette-accent);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 14px;
            margin: 4px;
            cursor: pointer;
        }
        .menu-tag .delete-btn {
            margin-left: 6px;
            cursor: pointer;
            font-weight: bold;
        }
        .sort-buttons {
            display: flex;
            gap: 5px;
        }
        .sort-button {
            background: var(--bg-primary);
            border: 1px solid var(--gray-300);
            color: var(--text-secondary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        .sort-button.active {
            background: var(--roulette-accent);
            color: white;
            border-color: var(--roulette-accent);
        }
        .not-ordered-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed var(--gray-300);
        }

        .not-rolled-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--yellow-900);
            margin-bottom: 12px;
        }

        .not-rolled-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 40px;
        }

        .spectator-orders-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--gray-200);
        }
        .game-status {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .game-status.waiting {
            background: var(--gray-100);
            color: var(--gray-700);
        }
        .game-status.ordering {
            background: var(--yellow-50);
            color: var(--yellow-900);
        }
        .game-status.playing {
            background: var(--status-success-bg);
            color: var(--green-900);
        }
    </style>

    <!-- ì´ë¦„ ì…ë ¥ (ë¡œê·¸ì¸ ì‹œ ìë™ ì„¤ì •, ìˆ¨ê¹€) -->
    <input type="hidden" id="globalUserNameInput">

    <div class="container">
        <!-- ê²Œì„ ì„¹ì…˜ -->
        <section class="game-section" id="gameSection">
            <!-- ë°© ì •ë³´ í—¤ë” (ê³µìœ  ì»¨íŠ¸ë¡¤ ë°”) -->
            <div id="controlBarMount"></div>
            <script src="/control-bar-shared.js"></script>
            <script>
                ControlBar.init({
                    gameKey: 'roulette',
                    soundKey: 'rouletteSoundEnabled',
                    volumeKey: 'rouletteSoundVolume',
                    onLeave: function() { leaveRoom(); },
                    extraBadges: [
                        { id: 'turboBadge', html: 'ğŸš€ í„°ë³´', className: 'turbo-badge', style: 'background: linear-gradient(135deg, var(--red-400) 0%, var(--yellow-300) 100%); color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;' }
                    ]
                });
            </script>

            <!-- ë°© í­íŒŒ ì¹´ìš´íŠ¸ë‹¤ìš´ -->
            <div class="room-expiry-section" id="roomExpirySection" style="display: none;">
                <div style="color: var(--yellow-900); font-weight: bold; font-size: 14px;">
                    â° ë°© í­íŒŒê¹Œì§€ ë‚¨ì€ ì‹œê°„: <span id="roomExpiryCountdown" style="color: var(--red-500);">--:--:--</span>
                </div>
            </div>

            <!-- ì ‘ì†ì ëª©ë¡ -->
            <div class="users-section" id="usersSection">
                <div class="users-title">
                    ğŸ‘¥ ì ‘ì†ì (<span id="usersCount">0</span>ëª…)
                    <span id="dragHint" style="display: none; font-size: 12px; color: var(--roulette-accent); margin-left: 10px; font-weight: normal;">ğŸ’¡ ë“œë˜ê·¸í•˜ì—¬ ì¤€ë¹„ì‹œí‚¤ê¸°</span>
                </div>
                <div class="users-list" id="usersList"></div>
            </div>

            <!-- ì¤€ë¹„ ì„¹ì…˜ -->
            <div class="ready-section" id="readySection">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="users-title" style="margin: 0;">âœ… ì¤€ë¹„í•œ ì‚¬ëŒ (<span id="readyCount">0</span>ëª…)</div>
                    <button id="readyButton" onclick="toggleReady()" style="width: auto; padding: 10px 20px; background: linear-gradient(135deg, var(--btn-ready) 0%, var(--btn-ready-hover) 100%);">ì¤€ë¹„</button>
                </div>
                <div class="users-list" id="readyUsersList">
                    <div style="color: var(--text-muted); text-align: center; padding: 10px; width: 100%;">ì•„ì§ ì¤€ë¹„í•œ ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤</div>
                </div>
            </div>

            <!-- í˜¸ìŠ¤íŠ¸ ì»¨íŠ¸ë¡¤ -->
            <div class="host-controls" id="hostControls" style="display: none; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                <button class="start-button" id="startRouletteButton" onclick="startRoulette()" disabled style="grid-column: 1 / -1;">
                    ğŸ° ë£°ë › ì‹œì‘ (ìµœì†Œ 2ëª… ì¤€ë¹„ í•„ìš”)
                </button>
                <button onclick="OrderModule.startOrder()" id="startOrderButton" style="display: none; background: linear-gradient(135deg, var(--btn-ready) 0%, var(--green-400) 100%);">ì£¼ë¬¸ë°›ê¸° ì‹œì‘</button>
                <button onclick="OrderModule.endOrder()" id="endOrderButton" style="display: none; background: linear-gradient(135deg, var(--btn-danger) 0%, var(--btn-danger-hover) 100%);">ì£¼ë¬¸ë°›ê¸° ì¢…ë£Œ</button>
            </div>

            <!-- ì£¼ë¬¸ë°›ê¸° ì„¹ì…˜ -->
            <div class="orders-section" id="ordersSection">
                <div class="history-title-wrapper" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="users-title" style="font-weight: bold; color: var(--roulette-accent); font-size: 16px; margin: 0;">ğŸ” ì£¼ë¬¸ë°›ê¸°</div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button onclick="OrderModule.showOrderList()" id="showOrderListButton" style="width: auto; padding: 8px 16px; font-size: 14px; background: linear-gradient(135deg, var(--roulette-accent) 0%, var(--purple-200) 100%);">ğŸ“‹ ì£¼ë¬¸ë¦¬ìŠ¤íŠ¸ ë³´ê¸°</button>
                        <div class="sort-buttons">
                            <button class="sort-button active" id="sortOrderAscBtn" onclick="OrderModule.sortOrders('asc')">ê°€ë‚˜ë‹¤ìˆœ</button>
                            <button class="sort-button" id="sortOrderDescBtn" onclick="OrderModule.sortOrders('desc')">ê°€ë‚˜ë‹¤ ì—­ìˆœ</button>
                            <button class="sort-button" id="sortOrderCountBtn" onclick="OrderModule.sortOrders('count')">ì£¼ë¬¸ ë§ì€ ìˆœ</button>
                        </div>
                    </div>
                </div>
                
                <!-- ì£¼ë¬¸í•˜ì§€ ì•Šì€ ì‚¬ëŒ ëª©ë¡ -->
                <div class="not-ordered-section" id="notOrderedSection" style="display: none;">
                    <div class="not-rolled-title" style="margin-top: 15px;">â³ ì£¼ë¬¸í•˜ì§€ ì•Šì€ ì‚¬ëŒ</div>
                    <div class="not-rolled-list" id="notOrderedList">
                        <!-- ì£¼ë¬¸í•˜ì§€ ì•Šì€ ì‚¬ëŒ ëª©ë¡ -->
                    </div>
                </div>

                <!-- ë‚´ ì£¼ë¬¸ ì…ë ¥ -->
                <div class="my-order-box">
                    <div class="my-order-title">
                        <span>ğŸ“</span>
                        <span>ë‚´ ì£¼ë¬¸</span>
                        <button onclick="OrderModule.toggleMenuManager()" style="width: auto; padding: 6px 12px; font-size: 12px; margin-left: auto; background: var(--bg-primary); color: var(--roulette-accent); border: 1px solid var(--roulette-accent);">ë©”ë‰´ ê´€ë¦¬</button>
                    </div>
                    
                    <!-- ìì£¼ ì“°ëŠ” ë©”ë‰´ ê´€ë¦¬ -->
                    <div class="menu-manager" id="menuManager">
                        <div class="menu-manager-title">
                            <span>ğŸ“‹ ìì£¼ ì“°ëŠ” ë©”ë‰´</span>
                            <button onclick="OrderModule.toggleMenuManager()" style="width: auto; padding: 4px 8px; font-size: 12px; background: var(--btn-danger); color: white; border: none; border-radius: 4px;">ë‹«ê¸°</button>
                        </div>
                        <div class="menu-manager-input">
                            <input type="text" id="menuInput" placeholder="ë©”ë‰´ ì¶”ê°€ (ì˜ˆ: ì¹˜í‚¨)" maxlength="50" />
                            <button onclick="OrderModule.addMenu()" style="width: auto; padding: 12px 20px; height: fit-content;">ì¶”ê°€</button>
                        </div>
                        <div class="menu-list" id="menuList"></div>
                    </div>
                    
                    <div class="order-input-group">
                        <div class="order-input-wrapper">
                            <div class="autocomplete-suggestion" id="autocompleteSuggestion"></div>
                            <input 
                                type="text"
                                id="myOrderInput" 
                                placeholder="ì£¼ë¬¸í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì˜¤ì´ˆ, ì˜¤ê³ )"
                                maxlength="100"
                                disabled
                            />
                            <div class="autocomplete-dropdown" id="autocompleteDropdown" style="display: none;"></div>
                        </div>
                        <button onclick="OrderModule.updateMyOrder()" id="orderSaveButton" style="width: auto; padding: 12px 20px; height: fit-content;" disabled>ì €ì¥</button>
                    </div>
                </div>

                <!-- ì „ì²´ ì£¼ë¬¸ ëª©ë¡ -->
                <div class="order-list" id="orderList">
                    <div style="color: var(--text-muted); text-align: center; padding: 10px;">ì•„ì§ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤</div>
                </div>
                
                <!-- ê´€ì „ì ì£¼ë¬¸ ëª©ë¡ -->
                <div class="spectator-orders-section" id="spectatorOrdersSection" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--gray-200);">
                    <div class="users-title" style="margin-bottom: 15px; color: var(--text-muted); font-size: 14px;">ğŸ‘ï¸ ê´€ì „ì ì£¼ë¬¸ (ê²Œì„ ì°¸ì—¬ í›„ ë©”ë‰´ë¥¼ ë‹¤ì‹œ ê³¨ë¼ì£¼ì‹œë©´ë©ë‹ˆë‹¤)</div>
                    <div class="order-list" id="spectatorOrderList"></div>
                </div>
            </div>
            
            <!-- ê²Œì„ ìƒíƒœ í‘œì‹œ -->
            <div class="game-status waiting" id="gameStatus" style="padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; margin-bottom: 20px; background: var(--gray-100); color: var(--gray-700);">
                ëŒ€ê¸° ì¤‘...
            </div>

            <!-- ë£°ë › ì»¨í…Œì´ë„ˆ (í•­ìƒ í‘œì‹œ) -->
            <div class="roulette-container" id="rouletteContainer" style="display: flex;">
                <div class="roulette-wrapper">
                    <div class="roulette-pointer"></div>
                    <div class="roulette-wheel" id="rouletteWheel"></div>
                    <div class="roulette-center">ğŸ°</div>
                </div>
            </div>

            <!-- í„°ë³´ ì• ë‹ˆë©”ì´ì…˜ ì„¤ì • (í˜¸ìŠ¤íŠ¸ ì „ìš©) -->
            <div id="turboSettingSection" style="display: none; text-align: center; margin-top: 15px; padding: 10px; background: rgba(124, 77, 255, 0.1); border-radius: 8px;">
                <label style="display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="turboToggle" style="width: auto; margin: 0;" onchange="toggleTurboAnimation()">
                    <span style="font-weight: bold; color: var(--roulette-accent);">ğŸš€ í„°ë³´ ì• ë‹ˆë©”ì´ì…˜</span>
                </label>
                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 5px;">ë‹¤ì–‘í•œ ë§ˆë¬´ë¦¬ íš¨ê³¼</div>
            </div>
            
            <!-- ê²Œì„ ì¢…ë£Œ ë²„íŠ¼ (í˜¸ìŠ¤íŠ¸ ì „ìš©, ê²°ê³¼ í›„ í‘œì‹œ) -->
            <div id="endGameSection" style="display: none; text-align: center; margin-top: 20px;">
                <button class="end-button" onclick="endRouletteGame()">ğŸ ê²Œì„ ì¢…ë£Œ</button>
            </div>

            <!-- ë‹¤ì‹œë³´ê¸° ë²„íŠ¼ (í™”ë©´ ìˆ¨ê¹€ ìƒíƒœì—ì„œ ë£°ë ›ì´ ì§„í–‰ëœ ê²½ìš° í‘œì‹œ) -->
            <div id="replaySection" style="display: none; text-align: center; margin-top: 20px; padding: 15px; background: var(--dice-gradient); border-radius: 12px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
                <div style="color: white; margin-bottom: 12px; font-size: 14px;">
                    ğŸ¬ í™”ë©´ì„ ë³´ì§€ ì•ŠëŠ” ë™ì•ˆ ë£°ë ›ì´ ì§„í–‰ë˜ì—ˆìŠµë‹ˆë‹¤
                </div>
                <button onclick="replayRoulette()" style="background: linear-gradient(135deg, var(--red-400) 0%, var(--yellow-300) 100%); border: none; padding: 12px 25px; border-radius: 8px; color: #333333; font-weight: bold; cursor: pointer; font-size: 15px; box-shadow: 0 4px 10px rgba(255, 107, 107, 0.4);">
                    ğŸ”„ ë‹¤ì‹œë³´ê¸°
                </button>
            </div>

            <!-- ì±„íŒ… ì„¹ì…˜ -->
            <div class="chat-section">
                <div style="font-weight: bold; color: var(--roulette-accent); margin-bottom: 10px;">ğŸ’¬ ì±„íŒ…</div>
                <div class="chat-messages" id="chatMessages"></div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." style="flex: 1; margin: 0;" onkeypress="handleChatKeypress(event)">
                    <button onclick="sendMessage()" style="width: auto; padding: 10px 20px;">ì „ì†¡</button>
                </div>
            </div>
        </section>
    </div>

    <!-- ê¸°ë¡ ì„¹ì…˜ -->
    <div class="history-section" id="historySection">
        <div class="history-title">ğŸ“œ ê²Œì„ ê¸°ë¡</div>
        <div id="historyList"></div>
    </div>

    <!-- ê²°ê³¼ ì˜¤ë²„ë ˆì´ -->
    <div class="result-overlay" id="resultOverlay">
        <div class="result-card">
            <div class="result-title">ğŸŠ ë‹¹ì²¨ì ë°œí‘œ ğŸŠ</div>
            <div class="result-winner" id="resultWinner"></div>
            <div class="result-message">ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰</div>
            <button onclick="closeResultOverlay()" style="width: auto; padding: 12px 30px;">í™•ì¸</button>
        </div>
    </div>

    <!-- ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ëª¨ë‹¬ -->
    <div id="passwordModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000;">
        <div style="background: var(--bg-white); padding: 30px; border-radius: 12px; max-width: 400px; width: 90%;">
            <h3 style="color: var(--roulette-accent); margin-bottom: 15px;">ğŸ”’ ë¹„ê³µê°œ ë°©</h3>
            <p style="margin-bottom: 15px; color: var(--text-secondary);">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
            <input type="password" id="roomPasswordInput" placeholder="ë¹„ë°€ë²ˆí˜¸" style="margin-bottom: 15px;">
            <div style="display: flex; gap: 10px;">
                <button onclick="closePasswordModal()" style="background: var(--btn-neutral); flex: 1;">ì·¨ì†Œ</button>
                <button onclick="submitPassword()" style="flex: 1;">ì…ì¥</button>
            </div>
        </div>
    </div>

    <!-- ë””ë²„ê·¸ ë¡œê·¸ ì„¹ì…˜ -->
    <div class="debug-log-section" id="debugLogSection" style="position: fixed; bottom: 20px; right: 20px; width: 400px; max-height: 300px; background: rgba(0, 0, 0, 0.9); color: #0f0; border-radius: 8px; padding: 15px; font-family: 'Courier New', monospace; font-size: 11px; z-index: 10000; overflow-y: auto; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #0f0; padding-bottom: 5px;">
            <div style="font-weight: bold; color: #0f0;">ğŸ° ë£°ë › ë””ë²„ê·¸ ë¡œê·¸</div>
            <div style="display: flex; gap: 5px;">
                <button onclick="clearDebugLog()" style="background: #333; color: #0f0; border: 1px solid #0f0; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;">ì§€ìš°ê¸°</button>
                <button onclick="toggleDebugLog()" style="background: #333; color: #0f0; border: 1px solid #0f0; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;">ìˆ¨ê¸°ê¸°</button>
            </div>
        </div>
        <div id="debugLogContent" style="line-height: 1.4;"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/page-history-shared.js"></script>
    <script src="/assets/sounds/sound-manager.js"></script>
    <script src="/chat-shared.js"></script>
    <script src="/ready-shared.js"></script>
    <script src="/order-shared.js"></script>
    <script src="/ranking-shared.js"></script>
    <script>
        // ============================================
        // Room Control Bar Enhancement
        // ============================================

        // Room title editing
        let isEditingRoomName = false;

        document.addEventListener('DOMContentLoaded', function() {
            const roomTitleElem = document.getElementById('roomTitle');
            if (!roomTitleElem) return;

            roomTitleElem.addEventListener('click', function() {
                // Check if user is host
                if (!window.isHost || isEditingRoomName) return;

                isEditingRoomName = true;
                const displaySpan = document.getElementById('roomNameDisplay');
                const currentName = displaySpan.textContent;
                const editIcon = this.querySelector('.edit-icon');

                // Hide icon during edit
                if (editIcon) editIcon.style.display = 'none';

                // Create input
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentName;
                input.maxLength = 30;
                input.style.cssText = 'font-size: inherit; font-weight: inherit; border: 2px solid var(--roulette-accent); border-radius: 4px; padding: 4px 8px; width: 200px; background: var(--bg-white); color: var(--text-primary);';

                displaySpan.replaceWith(input);
                input.focus();
                input.select();

                function finishEdit() {
                    const newName = input.value.trim();
                    const newDisplay = document.createElement('span');
                    newDisplay.id = 'roomNameDisplay';
                    newDisplay.textContent = newName || currentName;

                    input.replaceWith(newDisplay);
                    if (editIcon) editIcon.style.display = '';
                    isEditingRoomName = false;

                    if (newName && newName !== currentName && window.socket) {
                        window.socket.emit('updateRoomName', { roomName: newName });
                    }
                }

                input.addEventListener('blur', finishEdit);
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') finishEdit();
                });
            });
        });

        // Update room title on server broadcast
        if (window.socket) {
            window.socket.on('roomNameUpdated', (data) => {
                const display = document.getElementById('roomNameDisplay');
                if (display) display.textContent = data.roomName;
            });
        }

        // Show/hide UI elements based on host status
        function updateControlBarUI(isHostUser) {
            const editIcon = document.querySelector('.edit-icon');
            const hostBadge = document.getElementById('hostBadge');
            const usernameDisplay = document.getElementById('usernameDisplay');

            if (editIcon) editIcon.style.display = isHostUser ? 'inline' : 'none';
            if (hostBadge) hostBadge.style.display = isHostUser ? 'inline-block' : 'none';

            // Show username if available
            if (usernameDisplay && currentUser) {
                usernameDisplay.textContent = currentUser;
                usernameDisplay.style.display = 'inline-block';
            }
        }

        // Logout function
        function logout() {
            showCustomConfirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë°©ì—ì„œ ë‚˜ê°€ê³  ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.').then(result => {
                if (result) {
                    if (window.socket) {
                        window.socket.emit('leaveRoom');
                        window.socket.disconnect();
                    }
                    sessionStorage.removeItem('rouletteActiveRoom');
                    sessionStorage.removeItem('userName');
                    location.href = '/';
                }
            });
        }

        // Host delegation
        function delegateHost(targetSocketId) {
            if (!window.socket || !window.roomUsers) return;

            const targetUser = window.roomUsers.find(u => u.socketId === targetSocketId);
            if (!targetUser) return;

            showCustomConfirm(`${targetUser.name}ë‹˜ì—ê²Œ í˜¸ìŠ¤íŠ¸ë¥¼ ìœ„ì„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`).then(result => {
                if (result) {
                    window.socket.emit('delegateHost', { targetSocketId });
                }
            });
        }

        // Listen for host delegation
        if (window.socket) {
            window.socket.on('hostDelegated', (data) => {
                window.isHost = data.newHostSocketId === window.socket.id;
                window.hostSocketId = data.newHostSocketId;

                updateControlBarUI(window.isHost);

                if (typeof renderUsersList === 'function' && window.roomUsers) {
                    renderUsersList(window.roomUsers);
                }

                if (window.isHost) {
                    showCustomAlert('í˜¸ìŠ¤íŠ¸ ê¶Œí•œì„ ë°›ì•˜ìŠµë‹ˆë‹¤!', 'success');
                }
            });
        }

        // ============================================
        // ë””ë²„ê·¸ ë¡œê·¸ í•¨ìˆ˜ (localhost ë“± ë¡œì»¬ì—ì„œë§Œ í™œì„±í™”, í¬íŠ¸ ë¬´ê´€)
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.hostname === '';
        let debugLogEnabled = isLocalhost;
        const MAX_LOG_LINES = 100;
        
        // ë¡œì»¬ì´ ì•„ë‹ˆë©´ ë””ë²„ê·¸ ë¡œê·¸ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
        if (!isLocalhost) {
            const debugLogSection = document.getElementById('debugLogSection');
            if (debugLogSection) {
                debugLogSection.style.display = 'none';
            }
        }
        
        // ë¡œì»¬ì—ì„œëŠ” ë°© ì œëª© ê¸°ë³¸ê°’ì„ "test"ë¡œ ì„¤ì •
        if (isLocalhost) {
            const roomNameInput = document.getElementById('createRoomNameInput');
            if (roomNameInput) {
                roomNameInput.value = 'test';
            }
        }
        
        function addDebugLog(message, type = 'info') {
            if (!debugLogEnabled) return;
            
            const logSection = document.getElementById('debugLogSection');
            const logContent = document.getElementById('debugLogContent');
            
            if (!logSection || !logContent) return;
            
            const timestamp = new Date().toLocaleTimeString('ko-KR', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3 });
            const colors = {
                'info': '#0f0',
                'warn': '#ff0',
                'error': '#f00',
                'animation': '#0ff',
                'gameEnd': '#f0f',
                'visibility': '#ffa500'
            };
            const color = colors[type] || colors['info'];
            
            const logLine = document.createElement('div');
            logLine.innerHTML = `<span style="color: #888;">[${timestamp}]</span> <span style="color: ${color};">${message}</span>`;
            logContent.appendChild(logLine);
            
            // ìµœëŒ€ ì¤„ ìˆ˜ ì œí•œ
            while (logContent.children.length > MAX_LOG_LINES) {
                logContent.removeChild(logContent.firstChild);
            }
            
            // ìë™ ìŠ¤í¬ë¡¤
            logSection.scrollTop = logSection.scrollHeight;
            
            // localhostì¼ ë•Œë§Œ ìë™ìœ¼ë¡œ ë³´ì´ê¸°
            if (isLocalhost && logSection.style.display === 'none') {
                logSection.style.display = 'block';
            }
        }
        
        function clearDebugLog() {
            const logContent = document.getElementById('debugLogContent');
            if (logContent) {
                logContent.innerHTML = '';
            }
        }
        
        function toggleDebugLog() {
            const logSection = document.getElementById('debugLogSection');
            if (logSection) {
                logSection.style.display = logSection.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        // ì»¤ìŠ¤í…€ ì–¼ëŸ¿ í•¨ìˆ˜
        function showCustomAlert(message, type = 'info') {
            // ê¸°ì¡´ ì–¼ëŸ¿ì´ ìˆìœ¼ë©´ ì œê±°
            const existingAlert = document.getElementById('customAlert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            // íƒ€ì…ì— ë”°ë¥¸ ìƒ‰ìƒ ì„¤ì •
            let bgColor, borderColor, icon;
            switch(type) {
                case 'error':
                    bgColor = 'var(--red-50)';
                    borderColor = 'var(--red-400)';
                    icon = 'âš ï¸';
                    break;
                case 'warning':
                    bgColor = 'var(--yellow-50)';
                    borderColor = 'var(--yellow-600)';
                    icon = 'âš ï¸';
                    break;
                case 'success':
                    bgColor = 'var(--green-50)';
                    borderColor = 'var(--green-400)';
                    icon = 'âœ…';
                    break;
                default:
                    bgColor = 'var(--purple-50)';
                    borderColor = 'var(--dice-accent)';
                    icon = 'â„¹ï¸';
            }
            
            // ì–¼ëŸ¿ ì˜¤ë²„ë ˆì´ ìƒì„±
            const alertOverlay = document.createElement('div');
            alertOverlay.id = 'customAlert';
            alertOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.4);
                z-index: 10001;
                display: flex;
                justify-content: center;
                align-items: center;
                animation: fadeIn 0.2s ease-out;
            `;
            
            // ì–¼ëŸ¿ ì»¨í…ì¸  ìƒì„±
            const alertContent = document.createElement('div');
            alertContent.style.cssText = `
                background: var(--bg-white);
                border-radius: 16px;
                padding: 20px;
                max-width: 450px;
                width: calc(100vw - 40px);
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
                border: 2px solid ${borderColor};
                animation: slideDown 0.3s ease-out;
                box-sizing: border-box;
            `;

            // ì•„ì´ì½˜ê³¼ ë©”ì‹œì§€
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                font-size: 15px;
                line-height: 1.6;
                color: #1a1a1a;
                white-space: pre-wrap;
                word-wrap: break-word;
                word-break: keep-all;
                overflow-wrap: break-word;
                text-align: center;
                margin-bottom: 20px;
                max-width: 100%;
            `;
            messageDiv.innerHTML = `<span style="font-size: 24px; margin-right: 8px;">${icon}</span>${message}`;
            
            // í™•ì¸ ë²„íŠ¼
            const confirmButton = document.createElement('button');
            confirmButton.textContent = 'í™•ì¸';
            confirmButton.style.cssText = `
                padding: 10px 30px;
                background: ${borderColor};
                color: white;
                border: none;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                width: 100%;
                transition: transform 0.1s, box-shadow 0.1s;
            `;
            confirmButton.onmouseenter = () => {
                confirmButton.style.transform = 'scale(1.02)';
                confirmButton.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
            };
            confirmButton.onmouseleave = () => {
                confirmButton.style.transform = 'scale(1)';
                confirmButton.style.boxShadow = 'none';
            };
            confirmButton.onclick = () => {
                alertOverlay.style.animation = 'fadeOut 0.2s ease-out';
                setTimeout(() => alertOverlay.remove(), 200);
            };
            
            // ESC í‚¤ë¡œ ë‹«ê¸°
            const handleEsc = (e) => {
                if (e.key === 'Escape') {
                    alertOverlay.style.animation = 'fadeOut 0.2s ease-out';
                    setTimeout(() => {
                        alertOverlay.remove();
                        document.removeEventListener('keydown', handleEsc);
                    }, 200);
                }
            };
            document.addEventListener('keydown', handleEsc);
            
            // ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ë‹«ê¸°
            alertOverlay.onclick = (e) => {
                if (e.target === alertOverlay) {
                    alertOverlay.style.animation = 'fadeOut 0.2s ease-out';
                    setTimeout(() => {
                        alertOverlay.remove();
                        document.removeEventListener('keydown', handleEsc);
                    }, 200);
                }
            };
            
            alertContent.appendChild(messageDiv);
            alertContent.appendChild(confirmButton);
            alertOverlay.appendChild(alertContent);
            document.body.appendChild(alertOverlay);
            
            // í¬ì»¤ìŠ¤ ì„¤ì •
            confirmButton.focus();
        }
        
        // ì»¤ìŠ¤í…€ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸
        function showCustomConfirm(message, type = 'warning') {
            return new Promise((resolve) => {
                // ê¸°ì¡´ confirmì´ ìˆìœ¼ë©´ ì œê±°
                const existingConfirm = document.getElementById('customConfirm');
                if (existingConfirm) {
                    existingConfirm.remove();
                }
                
                // íƒ€ì…ì— ë”°ë¥¸ ìƒ‰ìƒ ì„¤ì •
                let bgColor, borderColor, icon;
                switch(type) {
                    case 'error':
                        bgColor = 'var(--red-50)';
                        borderColor = 'var(--red-400)';
                        icon = 'âš ï¸';
                        break;
                    case 'warning':
                        bgColor = 'var(--yellow-50)';
                        borderColor = 'var(--yellow-600)';
                        icon = 'âš ï¸';
                        break;
                    case 'success':
                        bgColor = 'var(--green-50)';
                        borderColor = 'var(--green-400)';
                        icon = 'âœ…';
                        break;
                    default:
                        bgColor = 'var(--purple-50)';
                        borderColor = 'var(--dice-accent)';
                        icon = 'â„¹ï¸';
                }
                
                // Confirm ì˜¤ë²„ë ˆì´ ìƒì„±
                const confirmOverlay = document.createElement('div');
                confirmOverlay.id = 'customConfirm';
                confirmOverlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.4);
                    z-index: 10002;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    animation: fadeIn 0.2s ease-out;
                `;
                
                // Confirm ì»¨í…ì¸  ìƒì„±
                const confirmContent = document.createElement('div');
                confirmContent.style.cssText = `
                    background: var(--bg-white);
                    border-radius: 16px;
                    padding: 20px;
                    max-width: 450px;
                    width: calc(100vw - 40px);
                    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
                    border: 2px solid ${borderColor};
                    animation: slideDown 0.3s ease-out;
                    box-sizing: border-box;
                `;

                // ì•„ì´ì½˜ê³¼ ë©”ì‹œì§€
                const messageDiv = document.createElement('div');
                messageDiv.style.cssText = `
                    font-size: 15px;
                    line-height: 1.6;
                    color: #1a1a1a;
                    white-space: pre-wrap;
                    word-wrap: break-word;
                    word-break: keep-all;
                    overflow-wrap: break-word;
                    text-align: center;
                    margin-bottom: 25px;
                    max-width: 100%;
                `;
                messageDiv.innerHTML = `<span style="font-size: 24px; margin-right: 8px;">${icon}</span>${message}`;
                
                // ë²„íŠ¼ ì»¨í…Œì´ë„ˆ
                const buttonContainer = document.createElement('div');
                buttonContainer.style.cssText = `
                    display: flex;
                    gap: 10px;
                    justify-content: center;
                `;
                
                // ì·¨ì†Œ ë²„íŠ¼
                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'ì·¨ì†Œ';
                cancelButton.style.cssText = `
                    padding: 10px 25px;
                    background: var(--gray-100);
                    color: var(--text-secondary);
                    border: 1px solid var(--gray-300);
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: transform 0.1s, box-shadow 0.1s;
                    flex: 1;
                `;
                cancelButton.onmouseenter = () => {
                    cancelButton.style.transform = 'scale(1.02)';
                    cancelButton.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                };
                cancelButton.onmouseleave = () => {
                    cancelButton.style.transform = 'scale(1)';
                    cancelButton.style.boxShadow = 'none';
                };
                cancelButton.onclick = () => {
                    confirmOverlay.style.animation = 'fadeOut 0.2s ease-out';
                    setTimeout(() => {
                        confirmOverlay.remove();
                        resolve(false);
                    }, 200);
                };
                
                // í™•ì¸ ë²„íŠ¼
                const confirmButton = document.createElement('button');
                confirmButton.textContent = 'í™•ì¸';
                confirmButton.style.cssText = `
                    padding: 10px 25px;
                    background: ${borderColor};
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: transform 0.1s, box-shadow 0.1s;
                    flex: 1;
                `;
                confirmButton.onmouseenter = () => {
                    confirmButton.style.transform = 'scale(1.02)';
                    confirmButton.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
                };
                confirmButton.onmouseleave = () => {
                    confirmButton.style.transform = 'scale(1)';
                    confirmButton.style.boxShadow = 'none';
                };
                confirmButton.onclick = () => {
                    confirmOverlay.style.animation = 'fadeOut 0.2s ease-out';
                    setTimeout(() => {
                        confirmOverlay.remove();
                        resolve(true);
                    }, 200);
                };
                
                // ESC í‚¤ë¡œ ë‹«ê¸° (ì·¨ì†Œë¡œ ì²˜ë¦¬)
                const handleEsc = (e) => {
                    if (e.key === 'Escape') {
                        confirmOverlay.style.animation = 'fadeOut 0.2s ease-out';
                        setTimeout(() => {
                            confirmOverlay.remove();
                            document.removeEventListener('keydown', handleEsc);
                            resolve(false);
                        }, 200);
                    }
                };
                document.addEventListener('keydown', handleEsc);
                
                // ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ë‹«ê¸° (ì·¨ì†Œë¡œ ì²˜ë¦¬)
                confirmOverlay.onclick = (e) => {
                    if (e.target === confirmOverlay) {
                        confirmOverlay.style.animation = 'fadeOut 0.2s ease-out';
                        setTimeout(() => {
                            confirmOverlay.remove();
                            document.removeEventListener('keydown', handleEsc);
                            resolve(false);
                        }, 200);
                    }
                };
                
                buttonContainer.appendChild(cancelButton);
                buttonContainer.appendChild(confirmButton);
                confirmContent.appendChild(messageDiv);
                confirmContent.appendChild(buttonContainer);
                confirmOverlay.appendChild(confirmContent);
                document.body.appendChild(confirmOverlay);
                
                // í¬ì»¤ìŠ¤ ì„¤ì •
                cancelButton.focus();
            });
        }
        
        // í”Œë ˆì´ì–´ ì•¡ì…˜ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ (í˜¸ìŠ¤íŠ¸ì„ëª…, ì œì™¸ì‹œí‚¤ê¸°, ì·¨ì†Œ)
        function showPlayerActionDialog(playerName) {
            return new Promise((resolve) => {
                // ê¸°ì¡´ ë‹¤ì´ì–¼ë¡œê·¸ê°€ ìˆìœ¼ë©´ ì œê±°
                const existingDialog = document.getElementById('playerActionDialog');
                if (existingDialog) {
                    existingDialog.remove();
                }
                
                // ë‹¤ì´ì–¼ë¡œê·¸ ì˜¤ë²„ë ˆì´ ìƒì„±
                const dialogOverlay = document.createElement('div');
                dialogOverlay.id = 'playerActionDialog';
                dialogOverlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.4);
                    z-index: 10002;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    animation: fadeIn 0.2s ease-out;
                `;
                
                // ë‹¤ì´ì–¼ë¡œê·¸ ì»¨í…ì¸  ìƒì„±
                const dialogContent = document.createElement('div');
                dialogContent.style.cssText = `
                    background: var(--bg-white);
                    border-radius: 16px;
                    padding: 25px 30px;
                    max-width: 500px;
                    width: 90vw;
                    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
                    border: 2px solid var(--yellow-600);
                    animation: slideDown 0.3s ease-out;
                `;
                
                // ë©”ì‹œì§€
                const messageDiv = document.createElement('div');
                messageDiv.style.cssText = `
                    font-size: 18px;
                    line-height: 1.6;
                    color: #1a1a1a;
                    white-space: pre-wrap;
                    word-break: break-word;
                    text-align: center;
                    margin-bottom: 25px;
                    font-weight: 600;
                `;
                messageDiv.innerHTML = `<span style="font-size: 24px; margin-right: 8px;">ğŸ‘¤</span>${playerName}ë‹˜ì—ê²Œ ì–´ë–¤ í–‰ë™ì„ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
                
                // ë²„íŠ¼ ì»¨í…Œì´ë„ˆ
                const buttonContainer = document.createElement('div');
                buttonContainer.style.cssText = `
                    display: flex;
                    flex-direction: column;
                    gap: 12px;
                `;
                
                // í˜¸ìŠ¤íŠ¸ì„ëª… ë²„íŠ¼
                const hostButton = document.createElement('button');
                hostButton.textContent = 'í˜¸ìŠ¤íŠ¸ì„ëª…';
                hostButton.style.cssText = `
                    padding: 12px 25px;
                    background: var(--dice-gradient);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: transform 0.1s, box-shadow 0.1s;
                `;
                hostButton.onmouseenter = () => {
                    hostButton.style.transform = 'scale(1.02)';
                    hostButton.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.3)';
                };
                hostButton.onmouseleave = () => {
                    hostButton.style.transform = 'scale(1)';
                    hostButton.style.boxShadow = 'none';
                };
                hostButton.onclick = () => {
                    dialogOverlay.style.animation = 'fadeOut 0.2s ease-out';
                    setTimeout(() => {
                        dialogOverlay.remove();
                        document.removeEventListener('keydown', handleEsc);
                        resolve('host');
                    }, 200);
                };
                
                // ì œì™¸ì‹œí‚¤ê¸° ë²„íŠ¼
                const kickButton = document.createElement('button');
                kickButton.textContent = 'ì œì™¸ì‹œí‚¤ê¸°';
                kickButton.style.cssText = `
                    padding: 12px 25px;
                    background: linear-gradient(135deg, var(--red-400) 0%, var(--red-400) 100%);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: transform 0.1s, box-shadow 0.1s;
                `;
                kickButton.onmouseenter = () => {
                    kickButton.style.transform = 'scale(1.02)';
                    kickButton.style.boxShadow = '0 4px 12px rgba(255, 107, 107, 0.3)';
                };
                kickButton.onmouseleave = () => {
                    kickButton.style.transform = 'scale(1)';
                    kickButton.style.boxShadow = 'none';
                };
                kickButton.onclick = () => {
                    dialogOverlay.style.animation = 'fadeOut 0.2s ease-out';
                    setTimeout(() => {
                        dialogOverlay.remove();
                        document.removeEventListener('keydown', handleEsc);
                        resolve('kick');
                    }, 200);
                };
                
                // ì·¨ì†Œ ë²„íŠ¼
                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'ì·¨ì†Œ';
                cancelButton.style.cssText = `
                    padding: 12px 25px;
                    background: var(--gray-100);
                    color: var(--text-secondary);
                    border: 1px solid var(--gray-300);
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: transform 0.1s, box-shadow 0.1s;
                `;
                cancelButton.onmouseenter = () => {
                    cancelButton.style.transform = 'scale(1.02)';
                    cancelButton.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                };
                cancelButton.onmouseleave = () => {
                    cancelButton.style.transform = 'scale(1)';
                    cancelButton.style.boxShadow = 'none';
                };
                cancelButton.onclick = () => {
                    dialogOverlay.style.animation = 'fadeOut 0.2s ease-out';
                    setTimeout(() => {
                        dialogOverlay.remove();
                        document.removeEventListener('keydown', handleEsc);
                        resolve('cancel');
                    }, 200);
                };
                
                // ESC í‚¤ë¡œ ë‹«ê¸° (ì·¨ì†Œë¡œ ì²˜ë¦¬)
                const handleEsc = (e) => {
                    if (e.key === 'Escape') {
                        dialogOverlay.style.animation = 'fadeOut 0.2s ease-out';
                        setTimeout(() => {
                            dialogOverlay.remove();
                            document.removeEventListener('keydown', handleEsc);
                            resolve('cancel');
                        }, 200);
                    }
                };
                document.addEventListener('keydown', handleEsc);
                
                // ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ë‹«ê¸° (ì·¨ì†Œë¡œ ì²˜ë¦¬)
                dialogOverlay.onclick = (e) => {
                    if (e.target === dialogOverlay) {
                        dialogOverlay.style.animation = 'fadeOut 0.2s ease-out';
                        setTimeout(() => {
                            dialogOverlay.remove();
                            document.removeEventListener('keydown', handleEsc);
                            resolve('cancel');
                        }, 200);
                    }
                };
                
                buttonContainer.appendChild(hostButton);
                buttonContainer.appendChild(kickButton);
                buttonContainer.appendChild(cancelButton);
                dialogContent.appendChild(messageDiv);
                dialogContent.appendChild(buttonContainer);
                dialogOverlay.appendChild(dialogContent);
                document.body.appendChild(dialogOverlay);
                
                // í¬ì»¤ìŠ¤ ì„¤ì •
                hostButton.focus();
            });
        }
        
        // ì†Œì¼“ ì—°ê²°
        const socket = io({
            reconnection: true,
            reconnectionAttempts: 10,
            reconnectionDelay: 1000
        });
        let currentServerId = null;
        let currentServerName = null;

        // ì§ì ‘ URL ì ‘ì† ì°¨ë‹¨ + ìƒˆë¡œê³ ì¹¨ ì‹œ ì¬ì…ì¥ ì§€ì›
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const fromDice = urlParams.get('createRoom') === 'true' || urlParams.get('joinRoom') === 'true';

            // ìƒˆë¡œê³ ì¹¨: sessionStorageì— ë°© ì •ë³´ê°€ ìˆìœ¼ë©´ ì¬ì…ì¥
            const activeRoom = sessionStorage.getItem('rouletteActiveRoom');
            if (!fromDice && activeRoom) {
                try {
                    const rd = JSON.parse(activeRoom);
                    currentServerId = rd.serverId || null;
                    currentServerName = rd.serverName || null;
                    if (currentServerId) {
                        socket.emit('setServerId', { serverId: currentServerId });
                    }
                    if (rd.serverName) {
                        document.title = `${rd.serverName} - LAM Roulette`;
                    }
                    socket.on('connect', function onReconnect() {
                        socket.off('connect', onReconnect);
                        socket.emit('joinRoom', {
                            roomId: rd.roomId,
                            userName: rd.userName,
                            isHost: false,
                            password: '',
                            deviceId: getDeviceId(),
                            tabId: getTabId()
                        });
                    });
                } catch(e) {
                    sessionStorage.removeItem('rouletteActiveRoom');
                    window.location.replace('/game');
                }
                return;
            }

            if (!fromDice) {
                window.location.replace('/game');
                return;
            }
            const pending = localStorage.getItem('pendingRouletteRoom') || localStorage.getItem('pendingRouletteJoin');
            if (pending) {
                try {
                    const pd = JSON.parse(pending);
                    currentServerId = pd.serverId || null;
                    currentServerName = pd.serverName || null;
                    if (currentServerId) {
                        socket.emit('setServerId', { serverId: currentServerId });
                        if (pd.serverName) {
                            document.title = `${pd.serverName} - LAM Roulette`;
                        }
                    }
                } catch(e) {}
            }
        })();

        // ì±„íŒ… ëª¨ë“ˆ ì´ˆê¸°í™” (roomCreated/roomJoined í›„ í˜¸ì¶œ)
        let chatModuleInitialized = false;
        function initChatModule() {
            if (chatModuleInitialized) return;
            chatModuleInitialized = true;
            ChatModule.init(socket, currentUser, {
                themeColor: 'var(--roulette-accent)',
                myColor: 'var(--green-800)',
                myBgColor: 'var(--green-50)',
                myBorderColor: 'var(--green-400)',
                messageFilter: (data) => {
                    // ë£°ë › ë‹¹ì²¨ ë©”ì‹œì§€ ìŠ¤í¬ì¼ëŸ¬ ë°©ì§€
                    if (data.isRouletteWinner) {
                        if (document.visibilityState !== 'visible') {
                            addDebugLog(`ğŸ”‡ ë£°ë › ë‹¹ì²¨ ë©”ì‹œì§€ ìˆ¨ê¹€ (í™”ë©´ NOT visible) - winner: ${data.message}`, 'visibility');
                            return false;
                        }
                        if (missedRoulette) {
                            addDebugLog(`ğŸ”‡ ë£°ë › ë‹¹ì²¨ ë©”ì‹œì§€ ìˆ¨ê¹€ (ë‹¤ì‹œë³´ê¸° ëŒ€ê¸°ì¤‘) - winner: ${data.message}`, 'visibility');
                            return false;
                        }
                    }
                    return true;
                },
                getRoomUsers: () => users
            });
        }

        // ê¸€ë¡œë²Œ í•¨ìˆ˜ (HTML onclickì—ì„œ í˜¸ì¶œ)
        function sendMessage() { ChatModule.sendMessage(); }
        function handleChatKeypress(event) { ChatModule.handleChatKeypress(event); }
        function uploadImage() {
            ChatModule.showImageUploadModal((imageData, caption) => {
                socket.emit('sendImage', { imageData, caption });
            });
        }

        let readyModuleInitialized = false;
        function initReadyModule() {
            if (readyModuleInitialized) return;
            readyModuleInitialized = true;
            ReadyModule.init(socket, currentUser, {
                isHost: isHost,
                isGameActive: () => isSpinning,
                beforeToggle: () => RouletteSound.ensureContext(),
                onReadyChanged: (users) => {
                    readyUsers = users;
                },
                onRenderComplete: (users) => {
                    updateStartButton();
                    if (!isSpinning) {
                        updateRoulettePreview();
                    }
                },
                onError: (message) => {
                    showCustomAlert(message, 'error');
                    addDebugLog(`âŒ ì¤€ë¹„ ì—ëŸ¬: ${message}`, 'error');
                }
            });
        }

        let orderModuleInitialized = false;
        function initOrderModule() {
            if (orderModuleInitialized) return;
            orderModuleInitialized = true;
            OrderModule.init(socket, currentUser, {
                isHost: () => isHost,
                isGameActive: () => isSpinning,
                getEverPlayedUsers: () => everPlayedUsers,
                getUsersList: () => currentUsers,
                showCustomAlert: (msg, type) => showCustomAlert(msg, type),
                onOrderStarted: () => { isOrderActive = true; },
                onOrderEnded: () => { isOrderActive = false; },
                onOrdersUpdated: (data) => { ordersData = data; },
            });
        }

        // íƒ­ ì„¸ì…˜ ID (ìƒˆë¡œê³ ì¹¨: ìœ ì§€, ìƒˆ íƒ­: ìƒˆë¡œ ìƒì„±)
        if (!sessionStorage.getItem('tabId')) {
            sessionStorage.setItem('tabId', Math.random().toString(36).substr(2, 9) + Date.now());
        }
        function getTabId() { return sessionStorage.getItem('tabId'); }

        // ìƒíƒœ ë³€ìˆ˜
        let currentRoomId = null;
        let currentUser = '';
        let isHost = false;
        let isReady = false;
        let readyUsers = [];
        let turboAnimation = true; // í„°ë³´ ì• ë‹ˆë©”ì´ì…˜ ì˜µì…˜ (ê¸°ë³¸ê°’: í™œì„±í™”)
        let rouletteHistory = [];
        let isSpinning = false;
        let roomExpiryInterval = null;
        let pendingRoomId = null;
        let isOrderActive = false;
        let pendingRouletteData = null; // í¬ì»¤ìŠ¤ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ë£°ë › ë°ì´í„°
        let rouletteFocusHandler = null; // í¬ì»¤ìŠ¤ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (ì¤‘ë³µ ë°©ì§€ìš©)
        let rouletteResultShown = false; // ê²°ê³¼ ì˜¤ë²„ë ˆì´ í‘œì‹œ ì—¬ë¶€ (ì¤‘ë³µ ë°©ì§€)
        let lastRouletteData = null; // ë§ˆì§€ë§‰ ë£°ë › ë°ì´í„° (ë‹¤ì‹œë³´ê¸°ìš© - ëª¨ë“  ì‚¬ëŒ ì‚¬ìš© ê°€ëŠ¥)
        let missedRoulette = false; // ë£°ë ›ì„ ë†“ì³¤ëŠ”ì§€ ì—¬ë¶€ (í™”ë©´ ìˆ¨ê¹€ ìƒíƒœì˜€ëŠ”ì§€)
        let everPlayedUsers = []; // ë°©ì— ì…ì¥í•œ í›„ í•œë²ˆì´ë¼ë„ ê²Œì„ì— ì°¸ì—¬í•œ ì‚¬ëŒ ëª©ë¡ (ëˆ„ì )
        
        // íŒŒìŠ¤í…”í†¤ ìƒ‰ìƒ ëª©ë¡
        const PASTEL_COLORS = [
            { index: 0, hex: '#FFB3BA', name: 'íŒŒìŠ¤í…” í•‘í¬' },
            { index: 1, hex: '#BAFFC9', name: 'íŒŒìŠ¤í…” ë¯¼íŠ¸' },
            { index: 2, hex: '#BAE1FF', name: 'íŒŒìŠ¤í…” ë¸”ë£¨' },
            { index: 3, hex: '#FFFFBA', name: 'íŒŒìŠ¤í…” ì˜ë¡œìš°' },
            { index: 4, hex: '#FFD9BA', name: 'íŒŒìŠ¤í…” í”¼ì¹˜' },
            { index: 5, hex: '#E2BAFF', name: 'íŒŒìŠ¤í…” ë¼ë²¤ë”' },
            { index: 6, hex: '#BAFFED', name: 'íŒŒìŠ¤í…” ì•„ì¿ ì•„' },
            { index: 7, hex: '#FFC9DE', name: 'íŒŒìŠ¤í…” ë¡œì¦ˆ' },
            { index: 8, hex: '#C9FFE5', name: 'íŒŒìŠ¤í…” ìŠ¤í”„ë§ê·¸ë¦°' },
            { index: 9, hex: '#D4BAFF', name: 'íŒŒìŠ¤í…” í¼í”Œ' },
            { index: 10, hex: '#FFEEBA', name: 'íŒŒìŠ¤í…” í¬ë¦¼' },
            { index: 11, hex: '#BAFFD4', name: 'íŒŒìŠ¤í…” ì‹œí¼' },
            { index: 12, hex: '#FFCCCC', name: 'íŒŒìŠ¤í…” ì½”ë„' },
            { index: 13, hex: '#CCE5FF', name: 'íŒŒìŠ¤í…” ìŠ¤ì¹´ì´' },
            { index: 14, hex: '#E5FFCC', name: 'íŒŒìŠ¤í…” ë¼ì„' },
            { index: 15, hex: '#FFCCE5', name: 'íŒŒìŠ¤í…” ì²´ë¦¬' }
        ];
        let pendingUserName = null;

        // ë£°ë › ì‚¬ìš´ë“œ ë³¼ë¥¨ ê´€ë¦¬ â€” ControlBar ìœ„ì„
        function getRouletteSoundEnabled() { return ControlBar.getSoundEnabled(); }
        function getRouletteMasterVolume() { return ControlBar.getMasterVolume(); }

        // ë£°ë › ì‚¬ìš´ë“œ (Web Audio API - ì™¸ë¶€ íŒŒì¼ ë¶ˆí•„ìš”, ë§ˆìŠ¤í„° ë³¼ë¥¨ ì ìš©)
        const RouletteSound = {
            audioCtx: null,
            spinRafId: null,
            init() {
                if (this.audioCtx) return this.audioCtx;
                this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                return this.audioCtx;
            },
            ensureContext() {
                if (!this.audioCtx) this.init();
                if (this.audioCtx.state === 'suspended') this.audioCtx.resume();
            },
            playTick() {
                if (document.visibilityState !== 'visible' || !document.hasFocus()) return;
                this.ensureContext();
                if (!this.audioCtx) return;
                const vol = getRouletteMasterVolume();
                const osc = this.audioCtx.createOscillator();
                const gain = this.audioCtx.createGain();
                osc.type = 'sine';
                osc.frequency.value = 90;
                gain.gain.setValueAtTime(0.08 * vol, this.audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.audioCtx.currentTime + 0.06);
                osc.connect(gain);
                gain.connect(this.audioCtx.destination);
                osc.start(this.audioCtx.currentTime);
                osc.stop(this.audioCtx.currentTime + 0.06);
            },
            startBoundaryTicks(wheel, mainDuration, animationStartTime) {
                if (document.visibilityState !== 'visible' || !document.hasFocus()) return;
                this.stopSpin();
                const segmentCount = parseInt(wheel.dataset.segmentCount, 10) || 3;
                const segmentAngle = 360 / segmentCount;
                let lastBoundaryIndex = null;
                const self = this;
                function tickOnBoundary() {
                    if (self.spinRafId === null) return;
                    const elapsed = Date.now() - animationStartTime;
                    if (elapsed >= mainDuration) {
                        self.spinRafId = null;
                        return;
                    }
                    const style = getComputedStyle(wheel);
                    const transform = style.transform;
                    if (!transform || transform === 'none') {
                        self.spinRafId = requestAnimationFrame(tickOnBoundary);
                        return;
                    }
                    const m = new DOMMatrix(transform);
                    const rotationDeg = (Math.atan2(m.b, m.a) * 180 / Math.PI);
                    const normalizedAngle = (360 - (rotationDeg % 360) + 360) % 360;
                    const boundaryIndex = Math.floor(normalizedAngle / segmentAngle) % segmentCount;
                    if (lastBoundaryIndex !== null && lastBoundaryIndex !== boundaryIndex) {
                        self.playTick();
                    }
                    lastBoundaryIndex = boundaryIndex;
                    self.spinRafId = requestAnimationFrame(tickOnBoundary);
                }
                this.spinRafId = requestAnimationFrame(tickOnBoundary);
            },
            stopSpin() {
                if (this.spinRafId != null) {
                    cancelAnimationFrame(this.spinRafId);
                    this.spinRafId = null;
                }
            },
            playStopRumble() {
                if (document.visibilityState !== 'visible' || !document.hasFocus()) return;
                this.ensureContext();
                if (!this.audioCtx) return;
                const vol = getRouletteMasterVolume();
                const osc = this.audioCtx.createOscillator();
                const gain = this.audioCtx.createGain();
                osc.type = 'sine';
                osc.frequency.value = 65;
                gain.gain.setValueAtTime(0.2 * vol, this.audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.audioCtx.currentTime + 0.18);
                osc.connect(gain);
                gain.connect(this.audioCtx.destination);
                osc.start(this.audioCtx.currentTime);
                osc.stop(this.audioCtx.currentTime + 0.18);
            },
            playWinner() {
                if (document.visibilityState !== 'visible' || !document.hasFocus()) return;
                this.ensureContext();
                if (!this.audioCtx) return;
                const vol = getRouletteMasterVolume();
                const notes = [523.25, 659.25, 783.99, 1046.50];
                const gain = this.audioCtx.createGain();
                gain.gain.setValueAtTime(0.25 * vol, this.audioCtx.currentTime);
                gain.connect(this.audioCtx.destination);
                notes.forEach((freq, i) => {
                    const osc = this.audioCtx.createOscillator();
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    osc.connect(gain);
                    osc.start(this.audioCtx.currentTime + i * 0.12);
                    osc.stop(this.audioCtx.currentTime + i * 0.12 + 0.25);
                });
            }
        };

        // ë””ë°”ì´ìŠ¤ ID ìƒì„±/ê°€ì ¸ì˜¤ê¸°
        function getDeviceId() {
            let deviceId = localStorage.getItem('rouletteDeviceId');
            if (!deviceId) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('rouletteDeviceId', deviceId);
            }
            return deviceId;
        }


        // ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ ë‹«ê¸°
        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('roomPasswordInput').value = '';
            pendingRoomId = null;
            pendingUserName = null;
        }

        // ë¹„ë°€ë²ˆí˜¸ ì œì¶œ
        function submitPassword() {
            const password = document.getElementById('roomPasswordInput').value;
            
            if (pendingRoomId && pendingUserName) {
                socket.emit('joinRoom', {
                    roomId: pendingRoomId,
                    userName: pendingUserName,
                    isHost: false,
                    password: password,
                    deviceId: getDeviceId(),
                    tabId: getTabId()
                });
            }
            
            closePasswordModal();
        }

        // ë°© ë‚˜ê°€ê¸°
        function leaveRoom() {
            showCustomConfirm('ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?').then(result => {
                if (result) {
                    socket.emit('leaveRoom');
                }
            });
        }

        // ì¤€ë¹„ í•¨ìˆ˜ (ReadyModule ìœ„ì„)
        function toggleReady() {
            ReadyModule.toggleReady();
        }
        function updateReadyButton() {
            ReadyModule.updateReadyButton();
        }
        function renderReadyUsers() {
            ReadyModule.renderReadyUsers();
        }
        
        
        // ëŒë¦¼íŒ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        function updateRoulettePreview() {
            if (readyUsers.length >= 1) {
                createRouletteWheel(readyUsers);
            } else {
                // ì¤€ë¹„í•œ ì‚¬ëŒì´ ì—†ìœ¼ë©´ ë¹ˆ ìƒíƒœ í‘œì‹œ
                const wheel = document.getElementById('rouletteWheel');
                wheel.innerHTML = '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--text-muted); font-size: 14px; text-align: center;">ì¤€ë¹„í•œ ì‚¬ëŒì´<br>ì—†ìŠµë‹ˆë‹¤</div>';
            }
        }

        // ì‹œì‘ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateStartButton() {
            const btn = document.getElementById('startRouletteButton');
            if (btn && isHost) {
                if (readyUsers.length >= 2 && !isSpinning) {
                    btn.disabled = false;
                    btn.textContent = 'ğŸ° ë£°ë › ì‹œì‘!';
                } else {
                    btn.disabled = true;
                    btn.textContent = `ğŸ° ë£°ë › ì‹œì‘ (${readyUsers.length}/2ëª… ì¤€ë¹„)`;
                }
            }
        }

        // ë£°ë › ì‹œì‘
        function startRoulette() {
            if (readyUsers.length < 2) {
                showCustomAlert('ìµœì†Œ 2ëª…ì´ ì¤€ë¹„í•´ì•¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!', 'warning');
                return;
            }
            RouletteSound.ensureContext();
            socket.emit('startRoulette');
        }

        // ë£°ë › íœ  ìƒì„±
        function createRouletteWheel(participants) {
            const wheel = document.getElementById('rouletteWheel');
            wheel.innerHTML = '';
            
            // íœ  íšŒì „ ìƒíƒœ ì´ˆê¸°í™” (ì¤‘ìš”: ì´ì „ ê²Œì„ì˜ íšŒì „ì´ ë‚¨ì•„ìˆìœ¼ë©´ ì•ˆë¨)
            wheel.style.transition = 'none';
            wheel.style.transform = 'rotate(0deg)';
            
            // íŒŒìŠ¤í…”í†¤ ìƒ‰ìƒ ë°°ì—´ - ìˆœì„œëŒ€ë¡œ ìë™ ë°°ì •
            const colorHexList = PASTEL_COLORS.map(c => c.hex);
            const participantColors = participants.map((name, idx) => colorHexList[idx % 16]);
            
            // conic-gradientë¡œ íŒŒì´ ì°¨íŠ¸ ë°°ê²½ ìƒì„± (0ë„ = 12ì‹œ ë°©í–¥ì—ì„œ ì‹œì‘)
            const segmentAngle = 360 / participants.length;
            let gradientParts = [];
            participants.forEach((name, idx) => {
                const startAngle = idx * segmentAngle;
                const endAngle = (idx + 1) * segmentAngle;
                gradientParts.push(`${participantColors[idx]} ${startAngle}deg ${endAngle}deg`);
            });
            wheel.style.background = `conic-gradient(from 0deg, ${gradientParts.join(', ')})`;
            wheel.style.border = '4px solid var(--gray-900)';
            wheel.dataset.segmentCount = String(participants.length);
            
            // êµ¬ë¶„ì„ ê³¼ ì´ë¦„ ì¶”ê°€
            participants.forEach((name, index) => {
                // ì¤‘ì•™ì—ì„œ ë°”ê¹¥ìœ¼ë¡œ ë‚˜ê°€ëŠ” êµ¬ë¶„ì„  (ê²€ì€ìƒ‰)
                const divider = document.createElement('div');
                divider.style.cssText = `
                    position: absolute;
                    left: 50%;
                    top: 50%;
                    width: 3px;
                    height: 50%;
                    background: var(--gray-900);
                    transform-origin: 0 0;
                    transform: rotate(${index * segmentAngle}deg) translateY(-100%);
                    box-shadow: 0 0 3px rgba(0,0,0,0.5);
                    z-index: 5;
                `;
                wheel.appendChild(divider);
                
                // ì´ë¦„ í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ (íŒŒì´ ì¡°ê° ì •ì¤‘ì•™ì— ìœ„ì¹˜, í•­ìƒ ìˆ˜í‰ìœ¼ë¡œ í‘œì‹œ)
                const textOverlay = document.createElement('div');
                // íŒŒì´ ì¡°ê°ì˜ ì •ì¤‘ì•™ ê³„ì‚°
                const angleToCenter = index * segmentAngle + segmentAngle / 2;
                const angleRad = (angleToCenter - 90) * Math.PI / 180; // -90ë„ëŠ” 12ì‹œ ë°©í–¥ ê¸°ì¤€
                const textRadius = 95; // ì¤‘ì•™ì—ì„œ í…ìŠ¤íŠ¸ê¹Œì§€ì˜ ê±°ë¦¬
                const textX = Math.cos(angleRad) * textRadius;
                const textY = Math.sin(angleRad) * textRadius;
                textOverlay.style.cssText = `
                    position: absolute;
                    left: calc(50% + ${textX}px);
                    top: calc(50% + ${textY}px);
                    transform: translate(-50%, -50%);
                    font-size: 16px;
                    font-weight: 700;
                    color: #1a1a1a;
                    text-shadow: 0 0 3px rgba(255, 255, 255, 0.3);
                    white-space: nowrap;
                    text-align: center;
                    z-index: 6;
                    letter-spacing: 1px;
                `;
                textOverlay.textContent = name.length > 6 ? name.substring(0, 6) + '..' : name;
                wheel.appendChild(textOverlay);
            });
        }

        // ë£°ë › ì• ë‹ˆë©”ì´ì…˜
        // effectType: ì„œë²„ì—ì„œ ê²°ì •í•œ ë§ˆë¬´ë¦¬ íš¨ê³¼ íƒ€ì… (normal, bounce, shake, slowCrawl)
        // effectParams: íš¨ê³¼ë³„ íŒŒë¼ë¯¸í„° (ì„œë²„ì—ì„œ ê²°ì •)
        function spinRoulette(finalAngle, duration, effectType, effectParams, callback) {
            const wheel = document.getElementById('rouletteWheel');
            
            // ê¸°ì¡´ transitionend ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
            if (wheel._rouletteTransitionHandler) {
                wheel.removeEventListener('transitionend', wheel._rouletteTransitionHandler);
            }
            if (wheel._rouletteTransitionTimeout) {
                clearTimeout(wheel._rouletteTransitionTimeout);
            }
            if (wheel._rouletteShakeInterval) {
                clearInterval(wheel._rouletteShakeInterval);
            }
            
            let callbackCalled = false;
            const animationStartTime = Date.now();
            
            // ì½œë°± í˜¸ì¶œ í—¬í¼ í•¨ìˆ˜
            const finishAnimation = (mode) => {
                if (callbackCalled) return;
                callbackCalled = true;
                RouletteSound.stopSpin();
                const elapsed = Date.now() - animationStartTime;
                console.log(`âœ… ë£°ë › ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ - ${mode} (ê²½ê³¼ ì‹œê°„: ${elapsed}ms)`);
                if (wheel._rouletteTransitionHandler) {
                    wheel.removeEventListener('transitionend', wheel._rouletteTransitionHandler);
                    wheel._rouletteTransitionHandler = null;
                }
                if (wheel._rouletteTransitionTimeout) {
                    clearTimeout(wheel._rouletteTransitionTimeout);
                    wheel._rouletteTransitionTimeout = null;
                }
                if (wheel._rouletteShakeInterval) {
                    clearInterval(wheel._rouletteShakeInterval);
                    wheel._rouletteShakeInterval = null;
                }
                if (callback) callback();
            };
            
            addDebugLog(`ğŸ° ë£°ë › íš¨ê³¼: ${effectType}`, 'animation');
            console.log(`ğŸ° ë£°ë › íš¨ê³¼: ${effectType}`, effectParams);
            
            // ë©”ì¸ íšŒì „ (ëª¨ë“  íš¨ê³¼ ê³µí†µ) - ìµœì¢… ìœ„ì¹˜ ê·¼ì²˜ê¹Œì§€ íšŒì „
            const mainDuration = duration * 0.75; // ì „ì²´ ì‹œê°„ì˜ 75%ë¥¼ ë©”ì¸ íšŒì „ì— ì‚¬ìš©
            const effectDuration = duration * 0.25; // ë‚˜ë¨¸ì§€ 25%ë¥¼ ë§ˆë¬´ë¦¬ íš¨ê³¼ì— ì‚¬ìš©
            
            // íš¨ê³¼ë³„ ë§ˆë¬´ë¦¬ ê°ë„ ì¡°ì •
            let preEffectAngle = finalAngle;
            if (effectType === 'bounce') {
                preEffectAngle = finalAngle + (effectParams.overshootDeg || 15); // ë°”ìš´ìŠ¤: ì‚´ì§ ì§€ë‚˜ê°
            } else if (effectType === 'shake') {
                preEffectAngle = finalAngle; // ë–¨ë¦¼: ì •í™•í•œ ìœ„ì¹˜ì—ì„œ í”ë“¤ë¦¼
            } else if (effectType === 'slowCrawl') {
                preEffectAngle = finalAngle - (effectParams.crawlDistance || 45); // ëŠë¦° í¬ë¡¤: ì¡°ê¸ˆ ì „ì—ì„œ ì‹œì‘
            }
            
            // ë©”ì¸ íšŒì „ ì‹œì‘ (ê²½ê³„ì„  ì§€ë‚  ë•Œë§ˆë‹¤ í‹± ì‚¬ìš´ë“œ)
            wheel.style.transition = `transform ${mainDuration}ms cubic-bezier(0.12, 0.75, 0.05, 1.0)`;
            wheel.offsetHeight;
            wheel.style.transform = `rotate(${preEffectAngle}deg)`;
            RouletteSound.startBoundaryTicks(wheel, mainDuration, animationStartTime);
            
            // ë©”ì¸ íšŒì „ ì™„ë£Œ í›„ ë§ˆë¬´ë¦¬ íš¨ê³¼ (ìŠ¤í•€ ì†Œë¦¬ ë©ˆì¶”ê³  ë©ˆì¶œ ë•Œ ëŸ¼ë¸”)
            setTimeout(() => {
                if (callbackCalled) return;
                RouletteSound.stopSpin();
                RouletteSound.playStopRumble();
                
                switch (effectType) {
                    case 'bounce':
                        // ğŸ”„ ë°”ìš´ìŠ¤ íš¨ê³¼: ì§€ë‚˜ê°”ë‹¤ê°€ íƒ„ì„±ìœ¼ë¡œ ëŒì•„ì˜´
                        addDebugLog('ğŸ”„ ë°”ìš´ìŠ¤ íš¨ê³¼ ë°œë™!', 'animation');
                        const bounceDuration = effectParams.bounceDuration || 500;
                        
                        const bounceHandler = (e) => {
                            if (e.propertyName === 'transform') {
                                finishAnimation('ë°”ìš´ìŠ¤');
                            }
                        };
                        wheel._rouletteTransitionHandler = bounceHandler;
                        wheel.addEventListener('transitionend', bounceHandler);
                        
                        // íƒ„ì„± ìˆê²Œ ëŒì•„ì˜¤ê¸° (ì²œì²œíˆ ê°ì†í•˜ë©° ë³µê·€)
                        wheel.style.transition = `transform ${bounceDuration}ms cubic-bezier(0.25, 1.2, 0.3, 1)`;
                        wheel.offsetHeight;
                        wheel.style.transform = `rotate(${finalAngle}deg)`;
                        break;
                        
                    case 'shake':
                        // ğŸ“³ ë–¨ë¦¼ íš¨ê³¼: ì•ë’¤ë¡œ í”ë“¤ë¦¬ë‹¤ê°€ ë©ˆì¶¤
                        addDebugLog('ğŸ“³ ë–¨ë¦¼ íš¨ê³¼ ë°œë™!', 'animation');
                        const shakeCount = effectParams.shakeCount || 3;
                        const shakeAmplitudes = effectParams.shakeAmplitudes || [5, 3, 1];
                        const shakeDuration = effectParams.shakeDuration || 150;
                        
                        let shakeIndex = 0;
                        let direction = 1;
                        
                        const doShake = () => {
                            if (callbackCalled) return;
                            
                            const amplitude = shakeAmplitudes[Math.floor(shakeIndex / 2)] || 1;
                            const targetAngle = finalAngle + (amplitude * direction);
                            
                            wheel.style.transition = `transform ${shakeDuration}ms ease-out`;
                            wheel.offsetHeight;
                            wheel.style.transform = `rotate(${targetAngle}deg)`;
                            
                            direction *= -1;
                            shakeIndex++;
                            
                            if (shakeIndex >= shakeCount * 2) {
                                // ë§ˆì§€ë§‰: ì •í™•í•œ ìœ„ì¹˜ë¡œ
                                setTimeout(() => {
                                    if (callbackCalled) return;
                                    wheel.style.transition = `transform ${shakeDuration}ms ease-out`;
                                    wheel.offsetHeight;
                                    wheel.style.transform = `rotate(${finalAngle}deg)`;
                                    setTimeout(() => finishAnimation('ë–¨ë¦¼'), shakeDuration);
                                }, shakeDuration);
                            } else {
                                setTimeout(doShake, shakeDuration);
                            }
                        };
                        
                        doShake();
                        break;
                        
                    case 'slowCrawl':
                        // ğŸŒ ëŠë¦° í¬ë¡¤ íš¨ê³¼: ê·¹ë„ë¡œ ëŠë¦¬ê²Œ ë§ˆì§€ë§‰ êµ¬ê°„ ì´ë™
                        addDebugLog('ğŸŒ ëŠë¦° í¬ë¡¤ íš¨ê³¼ ë°œë™!', 'animation');
                        const crawlDuration = effectParams.crawlDuration || 2000;
                        
                        const crawlHandler = (e) => {
                            if (e.propertyName === 'transform') {
                                finishAnimation('ëŠë¦° í¬ë¡¤');
                            }
                        };
                        wheel._rouletteTransitionHandler = crawlHandler;
                        wheel.addEventListener('transitionend', crawlHandler);
                        
                        // ê·¹ë„ë¡œ ëŠë¦¬ê²Œ (ëìœ¼ë¡œ ê°ˆìˆ˜ë¡ ë” ì²œì²œíˆ ê°ì†)
                        wheel.style.transition = `transform ${crawlDuration}ms cubic-bezier(0.05, 0.85, 0.08, 1)`;
                        wheel.offsetHeight;
                        wheel.style.transform = `rotate(${finalAngle}deg)`;
                        break;
                        
                    default:
                        // ğŸ¯ ì¼ë°˜ ëª¨ë“œ: ì´ë¯¸ ë©”ì¸ íšŒì „ì—ì„œ ìµœì¢… ìœ„ì¹˜ì— ë„ë‹¬
                        addDebugLog('ğŸ¯ ì¼ë°˜ ëª¨ë“œ ì™„ë£Œ', 'animation');
                        finishAnimation('ì¼ë°˜');
                        break;
                }
            }, mainDuration);
            
            // ì•ˆì „ì¥ì¹˜: ì „ì²´ ì‹œê°„ + ì—¬ìœ 
            const totalTimeout = effectType === 'shake' ? duration + 3000 : duration + 2000;
            wheel._rouletteTransitionTimeout = setTimeout(() => {
                if (!callbackCalled) {
                    console.warn(`âš ï¸ ì•ˆì „ì¥ì¹˜ timeout ë°œë™ (${effectType})`);
                    finishAnimation('ì•ˆì „ì¥ì¹˜');
                }
            }, totalTimeout);
        }
        
        // ì´ì „ ë²„ì „ í˜¸í™˜ì„ ìœ„í•œ ë˜í¼ (useSpurt íŒŒë¼ë¯¸í„° ì§€ì›)
        function spinRouletteCompat(finalAngle, duration, useSpurtOrEffectType, effectParamsOrCallback, callbackOrUndefined) {
            // ìƒˆ API: spinRoulette(finalAngle, duration, effectType, effectParams, callback)
            // êµ¬ API: spinRoulette(finalAngle, duration, useSpurt, callback)
            
            if (typeof useSpurtOrEffectType === 'string') {
                // ìƒˆ API
                spinRoulette(finalAngle, duration, useSpurtOrEffectType, effectParamsOrCallback, callbackOrUndefined);
            } else {
                // êµ¬ API (useSpurt boolean)
                const effectType = useSpurtOrEffectType ? 'bounce' : 'normal';
                const effectParams = {};
                spinRoulette(finalAngle, duration, effectType, effectParams, effectParamsOrCallback);
            }
        }

        // ì ‘ì†ì ëª©ë¡ ì—…ë°ì´íŠ¸
        // í˜„ì¬ ì ‘ì†ì ëª©ë¡ ì €ì¥
        let currentUsers = [];
        
        function updateUsers(users) {
            currentUsers = users;
            const usersList = document.getElementById('usersList');
            const usersCount = document.getElementById('usersCount');
            
            if (!usersList || !usersCount) return;
            
            usersCount.textContent = users.length;
            usersList.innerHTML = '';
            
            users.forEach(user => {
                const tag = document.createElement('div');
                tag.className = 'user-tag' + (user.isHost ? ' host' : '');
                
                let content = user.name;
                if (user.isHost) {
                    content += ' ğŸ‘‘';
                }
                if (user.name === currentUser) {
                    content += ' (ë‚˜)';
                }
                tag.textContent = content;
                
                // í˜¸ìŠ¤íŠ¸ê°€ ë‹¤ë¥¸ ì‚¬ìš©ìë¥¼ í´ë¦­í•˜ë©´ ì•¡ì…˜ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
                if (isHost && user.name !== currentUser) {
                    tag.style.cursor = 'pointer';
                    tag.title = 'í´ë¦­í•˜ì—¬ í˜¸ìŠ¤íŠ¸ì„ëª… ë˜ëŠ” ì œì™¸';
                    
                    // í´ë¦­ ì´ë²¤íŠ¸ (ë“œë˜ê·¸ì™€ êµ¬ë¶„í•˜ê¸° ìœ„í•´ mousedown ì‚¬ìš©)
                    let isDragging = false;
                    let mouseDownTime = 0;
                    let mouseDownPos = { x: 0, y: 0 };
                    
                    tag.addEventListener('mousedown', (e) => {
                        isDragging = false;
                        mouseDownTime = Date.now();
                        mouseDownPos = { x: e.clientX, y: e.clientY };
                    });
                    
                    tag.addEventListener('mousemove', (e) => {
                        if (mouseDownTime > 0) {
                            const dx = Math.abs(e.clientX - mouseDownPos.x);
                            const dy = Math.abs(e.clientY - mouseDownPos.y);
                            if (dx > 5 || dy > 5) {
                                isDragging = true;
                            }
                        }
                    });
                    
                    tag.addEventListener('click', (e) => {
                        // ë“œë˜ê·¸ê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
                        if (!isDragging && Date.now() - mouseDownTime < 300) {
                            e.stopPropagation();
                            showPlayerActionDialog(user.name).then(action => {
                                if (action === 'host') {
                                    // í˜¸ìŠ¤íŠ¸ì„ëª…
                                    socket.emit('transferHost', user.name);
                                } else if (action === 'kick') {
                                    // ì œì™¸ì‹œí‚¤ê¸°
                                    showCustomConfirm(`${user.name}ë‹˜ì„ ê²Œì„ì—ì„œ ì œì™¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, 'warning').then(result => {
                                        if (result) {
                                            socket.emit('kickPlayer', user.name);
                                        }
                                    });
                                }
                                // 'cancel'ì¸ ê²½ìš° ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
                            });
                        }
                        isDragging = false;
                        mouseDownTime = 0;
                    });
                }
                
                // í˜¸ìŠ¤íŠ¸ì´ê³  ê²Œì„ ì§„í–‰ ì¤‘ì´ ì•„ë‹ ë•Œ ë“œë˜ê·¸ ê°€ëŠ¥
                if (isHost && !isSpinning) {
                    tag.draggable = true;
                    if (user.name !== currentUser) {
                        tag.style.cursor = 'grab';
                    }
                    tag.setAttribute('data-user-name', user.name);
                    
                    tag.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', user.name);
                        e.dataTransfer.setData('source', 'users');
                        tag.style.opacity = '0.5';
                    });
                    
                    tag.addEventListener('dragend', (e) => {
                        tag.style.opacity = '1';
                    });
                }
                
                usersList.appendChild(tag);
            });
            
            // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì •
            if (isHost && !isSpinning) {
                setupDragAndDrop();
            }
        }
        
        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì •
        function setupDragAndDrop() {
            const readyUsersList = document.getElementById('readyUsersList');
            const readySection = document.getElementById('readySection');
            
            if (!readyUsersList || !readySection) return;
            
            // ë“œë¡­ ì˜ì—­ ì„¤ì • (ì¤€ë¹„ ëª©ë¡)
            readyUsersList.addEventListener('dragover', (e) => {
                e.preventDefault();
                readyUsersList.style.backgroundColor = 'rgba(124, 77, 255, 0.1)';
                readyUsersList.style.border = '2px dashed var(--roulette-accent)';
            });
            
            readyUsersList.addEventListener('dragleave', (e) => {
                readyUsersList.style.backgroundColor = '';
                readyUsersList.style.border = '';
            });
            
            readyUsersList.addEventListener('drop', (e) => {
                e.preventDefault();
                readyUsersList.style.backgroundColor = '';
                readyUsersList.style.border = '';
                
                if (!isHost || isSpinning) return;
                
                const userName = e.dataTransfer.getData('text/plain');
                const source = e.dataTransfer.getData('source');
                
                // ì ‘ì†ì ëª©ë¡ì—ì„œ ë“œë˜ê·¸í•œ ê²½ìš°ë§Œ ì²˜ë¦¬
                if (source === 'users' && userName) {
                    // ì´ë¯¸ ì¤€ë¹„ ìƒíƒœì¸ì§€ í™•ì¸
                    if (!readyUsers.includes(userName)) {
                        socket.emit('setUserReady', {
                            userName: userName,
                            isReady: true
                        });
                    }
                }
            });
        }

        // ì±„íŒ… ë©”ì‹œì§€ ì¶”ê°€
        // ë””ë°”ì´ìŠ¤ ì•„ì´ì½˜ ê°€ì ¸ì˜¤ê¸°
        function getDeviceIcon(deviceType) {
            if (!deviceType) return '';
            if (deviceType === 'iOS') return 'ğŸ';
            if (deviceType === 'Android') return 'ğŸ“±';
            if (deviceType === 'PC') return 'ğŸ’»';
            return '';
        }
        
        // addChatMessageëŠ” ChatModule.displayChatMessageë¡œ ëŒ€ì²´
        function addChatMessage(data) {
            ChatModule.displayChatMessage(data);
        }

        // ê¸°ë¡ ë Œë”ë§
        function renderHistory() {
            const historyList = document.getElementById('historyList');
            if (!historyList) return;
            
            if (rouletteHistory.length === 0) {
                historyList.innerHTML = '<div style="color: var(--text-muted); text-align: center;">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }
            
            historyList.innerHTML = '';
            
            rouletteHistory.slice().reverse().forEach(record => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <div class="history-round">${record.round}ë¼ìš´ë“œ (${record.time})</div>
                    <div class="history-participants">ì°¸ê°€ì: ${record.participants.join(', ')}</div>
                    <div class="history-winner">ğŸŠ ë‹¹ì²¨: ${record.winner}</div>
                `;
                historyList.appendChild(item);
            });
        }

        // ê²Œì„ ì¢…ë£Œ
        function endRouletteGame() {
            socket.emit('endRoulette');
        }
        
        // ë£°ë › ë‹¤ì‹œë³´ê¸° (ëª¨ë“  ì‚¬ëŒ ì‚¬ìš© ê°€ëŠ¥)
        function replayRoulette() {
            if (!lastRouletteData) {
                addDebugLog('âš ï¸ ë‹¤ì‹œë³´ê¸° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'warn');
                console.log('âš ï¸ ë‹¤ì‹œë³´ê¸° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            addDebugLog(`ğŸ”„ ë‹¤ì‹œë³´ê¸° ì‹œì‘ - winner: ${lastRouletteData.winner}, missedRoulette: ${missedRoulette}`, 'info');
            
            // ë‹¤ì‹œë³´ê¸° ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.getElementById('replaySection').style.display = 'none';
            
            // ë‹¤ì‹œë³´ê¸° ëª¨ë“œë¡œ ë£°ë › ì¬ìƒ (ê²°ê³¼ ì´ë²¤íŠ¸ëŠ” ì „ì†¡í•˜ì§€ ì•ŠìŒ)
            const data = lastRouletteData;
            const wasMissed = missedRoulette; // ë†“ì¹œ ìƒíƒœì˜€ëŠ”ì§€ ì €ì¥
            
            // UI ìƒíƒœ ë³€ê²½ (ì¤€ë¹„ ì„¹ì…˜ì€ ìœ ì§€)
            document.getElementById('startRouletteButton').disabled = true;
            document.getElementById('startRouletteButton').textContent = 'ğŸ¬ ë‹¤ì‹œë³´ê¸° ì¤‘...';
            
            // ë£°ë › íœ  ìƒì„±
            createRouletteWheel(data.participants);
            
            // ê°ë„ ê³„ì‚°
            const segmentAngle = 360 / data.participants.length;
            const winnerCenterAngle = (data.winnerIndex + 0.5) * segmentAngle;
            const neededRotation = 360 - winnerCenterAngle;
            const fullRotations = Math.floor(data.totalRotation / 360);
            const finalAngle = fullRotations * 360 + neededRotation;
            
            addDebugLog(`ğŸ¯ ë‹¤ì‹œë³´ê¸° ê°ë„ ê³„ì‚°: finalAngle=${finalAngle}`, 'animation');
            
            // ê°•ì œ ë¦¬í”Œë¡œìš° í›„ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
            const wheel = document.getElementById('rouletteWheel');
            wheel.style.transition = 'none';
            wheel.style.transform = 'rotate(0deg)';
            wheel.offsetHeight; // ê°•ì œ ë¦¬í”Œë¡œìš°
            
            isSpinning = true;
            rouletteResultShown = false;
            
            setTimeout(() => {
                // ì„œë²„ì—ì„œ ê²°ì •í•œ íš¨ê³¼ë¥¼ ì‚¬ìš© (ë™ì¼í•œ ì• ë‹ˆë©”ì´ì…˜ ì¬í˜„)
                spinRoulette(finalAngle, data.spinDuration, data.effectType || 'normal', data.effectParams || {}, () => {
                    addDebugLog('âœ… ë‹¤ì‹œë³´ê¸° ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ', 'animation');
                    
                    isSpinning = false;
                    rouletteResultShown = true;
                    
                    // ê²°ê³¼ ì˜¤ë²„ë ˆì´ í‘œì‹œ
                    document.getElementById('resultWinner').textContent = data.winner;
                    document.getElementById('resultOverlay').classList.add('visible');
                    if (data.winner === currentUser) RouletteSound.playWinner();
                    addDebugLog(`ğŸŠ ë‹¤ì‹œë³´ê¸° ê²°ê³¼ í‘œì‹œ - winner: ${data.winner}`, 'gameEnd');
                    
                    // UI ë³µì›
                    document.getElementById('readySection').style.display = 'block';
                    document.getElementById('startRouletteButton').disabled = false;
                    document.getElementById('startRouletteButton').textContent = 'ğŸ° ë£°ë › ì‹œì‘';
                    
                    // í˜¸ìŠ¤íŠ¸ì—ê²Œ ì¢…ë£Œ ë²„íŠ¼ í‘œì‹œ
                    if (isHost) {
                        document.getElementById('endGameSection').style.display = 'block';
                    }
                    
                    // ë†“ì¹œ ê²½ìš°ì—ë§Œ ì±„íŒ… ë©”ì‹œì§€ì™€ ê¸°ë¡ ì¶”ê°€ (ì´ë¯¸ ë³¸ ê²½ìš°ëŠ” ì´ë¯¸ í‘œì‹œë¨)
                    if (wasMissed) {
                        // ë‹¤ì‹œë³´ê¸°ì—ì„œ ì±„íŒ… ë©”ì‹œì§€ í‘œì‹œ
                        const winnerMessage = {
                            userName: 'ì‹œìŠ¤í…œ',
                            message: `ğŸŠğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ${data.winner}ë‹˜ì´ ë‹¹ì²¨ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰ğŸŠ`,
                            timestamp: new Date().toISOString(),
                            isSystem: true,
                            isRouletteWinner: true
                        };
                        addChatMessage(winnerMessage);
                        
                        // ë‹¤ì‹œë³´ê¸°ì—ì„œ ê¸°ë¡ ì—…ë°ì´íŠ¸
                        if (data.record) {
                            // ì¤‘ë³µ ë°©ì§€: ì´ë¯¸ ê°™ì€ ë¼ìš´ë“œê°€ ìˆëŠ”ì§€ í™•ì¸
                            const existingRecord = rouletteHistory.find(r => r.round === data.record.round);
                            if (!existingRecord) {
                                rouletteHistory.push(data.record);
                                renderHistory();
                            }
                        }
                        
                        addDebugLog(`ğŸ“¢ ë‹¤ì‹œë³´ê¸° ì±„íŒ… ë° ê¸°ë¡ í‘œì‹œ ì™„ë£Œ (ë†“ì¹œ ë£°ë ›)`, 'info');
                    } else {
                        addDebugLog(`ğŸ“¢ ë‹¤ì‹œë³´ê¸° ì™„ë£Œ (ì´ë¯¸ ë³¸ ë£°ë ›)`, 'info');
                    }
                    
                    // ë†“ì¹œ ìƒíƒœ ì´ˆê¸°í™”
                    missedRoulette = false;
                    
                    // ë‹¤ì‹œë³´ê¸° ë²„íŠ¼ ë‹¤ì‹œ í‘œì‹œ
                    showReplayButton();
                });
            }, 50);
        }
        
        // ë‹¤ì‹œë³´ê¸° ë²„íŠ¼ í‘œì‹œ í•¨ìˆ˜
        function showReplayButton() {
            if (lastRouletteData) {
                const replaySection = document.getElementById('replaySection');
                const replayMessage = replaySection.querySelector('div');
                if (replayMessage) {
                    replayMessage.textContent = 'ğŸ¬ ë§ˆì§€ë§‰ ë£°ë › ë‹¤ì‹œë³´ê¸°';
                }
                replaySection.style.display = 'block';
            }
        }

        // ê²°ê³¼ ì˜¤ë²„ë ˆì´ ë‹«ê¸°
        function closeResultOverlay() {
            document.getElementById('resultOverlay').classList.remove('visible');
        }

        // ë°© í­íŒŒ ì¹´ìš´íŠ¸ë‹¤ìš´
        function startRoomExpiryCountdown(createdAt, expiryHours) {
            if (roomExpiryInterval) {
                clearInterval(roomExpiryInterval);
            }
            
            const expirySection = document.getElementById('roomExpirySection');
            const countdownElement = document.getElementById('roomExpiryCountdown');
            
            if (!expirySection || !countdownElement) return;
            
            expirySection.style.display = 'block';
            
            function updateCountdown() {
                const now = new Date();
                const createdAtDate = new Date(createdAt);
                const expiryTime = createdAtDate.getTime() + (expiryHours * 60 * 60 * 1000);
                const remaining = expiryTime - now.getTime();
                
                if (remaining <= 0) {
                    countdownElement.textContent = '00:00:00';
                    if (roomExpiryInterval) {
                        clearInterval(roomExpiryInterval);
                    }
                    return;
                }
                
                const hours = Math.floor(remaining / (1000 * 60 * 60));
                const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
                
                countdownElement.textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
            
            updateCountdown();
            roomExpiryInterval = setInterval(updateCountdown, 1000);
        }
        
        // í„°ë³´ ì• ë‹ˆë©”ì´ì…˜ ë°°ì§€ ì—…ë°ì´íŠ¸
        function updateTurboAnimationBadge() {
            const badge = document.getElementById('turboBadge');
            if (badge) {
                badge.style.display = turboAnimation ? 'inline-block' : 'none';
            }
        }
        
        // í„°ë³´ ì• ë‹ˆë©”ì´ì…˜ ì„¤ì • UI ì—…ë°ì´íŠ¸
        function updateTurboSettingUI() {
            const section = document.getElementById('turboSettingSection');
            const toggle = document.getElementById('turboToggle');
            
            if (section) {
                // í˜¸ìŠ¤íŠ¸ë§Œ í‘œì‹œ
                section.style.display = isHost ? 'block' : 'none';
            }
            
            if (toggle) {
                toggle.checked = turboAnimation;
            }
        }
        
        // í„°ë³´ ì• ë‹ˆë©”ì´ì…˜ í† ê¸€
        function toggleTurboAnimation() {
            if (!isHost) {
                showCustomAlert('í˜¸ìŠ¤íŠ¸ë§Œ ì„¤ì •ì„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'warning');
                return;
            }
            
            const toggle = document.getElementById('turboToggle');
            const newValue = toggle.checked;
            
            socket.emit('updateTurboAnimation', { turboAnimation: newValue });
        }

        // ê²Œì„ í™”ë©´ ì´ˆê¸°í™”
        function initializeGameScreen(data) {
            document.getElementById('roomTitle').textContent = data.roomName || 'ë£°ë › ë°©';
            
            if (data.createdAt && data.expiryHours) {
                startRoomExpiryCountdown(data.createdAt, data.expiryHours);
            }
            
            // í„°ë³´ ì• ë‹ˆë©”ì´ì…˜ ì˜µì…˜ ì €ì¥
            turboAnimation = data.turboAnimation !== false;
            updateTurboAnimationBadge();
            updateTurboSettingUI();
            
            // ì‚¬ìš©ì ëª©ë¡ ì´ˆê¸°í™”
            if (data.gameState && data.gameState.users) {
                currentUsers = data.gameState.users;
            }
            
            // ëˆ„ì  ì°¸ì—¬ì ëª©ë¡ ë³µì›
            if (data.everPlayedUsers && Array.isArray(data.everPlayedUsers)) {
                everPlayedUsers = [...data.everPlayedUsers];
            } else if (data.gameState && data.gameState.everPlayedUsers && Array.isArray(data.gameState.everPlayedUsers)) {
                everPlayedUsers = [...data.gameState.everPlayedUsers];
            } else {
                everPlayedUsers = [];
            }
            
            // ì£¼ë¬¸ë°›ê¸° ìƒíƒœ ì´ˆê¸°í™”
            isOrderActive = data.isOrderActive || false;
            OrderModule.setIsOrderActive(isOrderActive);
            ordersData = data.userOrders || {};
            OrderModule.setOrdersData(ordersData);

            // ë‚´ ì£¼ë¬¸ ë¶ˆëŸ¬ì˜¤ê¸°
            const myOrderInput = document.getElementById('myOrderInput');
            if (myOrderInput && data.myOrder) {
                myOrderInput.value = data.myOrder;
            }
            
            // í˜¸ìŠ¤íŠ¸ UI ì„¤ì •
            if (isHost) {
                document.getElementById('hostBadge').style.display = 'inline-block';
                document.getElementById('hostControls').style.display = 'grid';
                const dragHint = document.getElementById('dragHint');
                if (dragHint) dragHint.style.display = 'inline';
                
                // ì£¼ë¬¸ë°›ê¸° ë²„íŠ¼ ìƒíƒœ
                if (isOrderActive) {
                    document.getElementById('startOrderButton').style.display = 'none';
                    document.getElementById('endOrderButton').style.display = 'block';
                } else {
                    document.getElementById('startOrderButton').style.display = 'block';
                    document.getElementById('endOrderButton').style.display = 'none';
                }
            } else {
                document.getElementById('hostBadge').style.display = 'none';
                document.getElementById('hostControls').style.display = 'none';
                const dragHint = document.getElementById('dragHint');
                if (dragHint) dragHint.style.display = 'none';
            }
            
            // ì£¼ë¬¸ë°›ê¸° ì„¹ì…˜ í‘œì‹œ
            if (isOrderActive) {
                document.getElementById('ordersSection').style.display = 'block';
                document.getElementById('myOrderInput').disabled = false;
                document.getElementById('orderSaveButton').disabled = false;
            } else {
                // ì£¼ë¬¸ì´ ìˆìœ¼ë©´ ì„¹ì…˜ì€ ë³´ì—¬ì£¼ë˜ ì…ë ¥ì€ ë¹„í™œì„±í™”
                if (Object.keys(ordersData).length > 0) {
                    document.getElementById('ordersSection').style.display = 'block';
                }
                document.getElementById('myOrderInput').disabled = true;
                document.getElementById('orderSaveButton').disabled = true;
            }
            
            OrderModule.renderOrders();
            OrderModule.renderNotOrderedUsers();
            
            // ìì£¼ ì“°ëŠ” ë©”ë‰´ ë¶ˆëŸ¬ì˜¤ê¸°
            if (data.frequentMenus !== undefined) {
                frequentMenus = data.frequentMenus;
                OrderModule.renderMenuList();
            } else {
                // ì„œë²„ì—ì„œ ê°€ì ¸ì˜¤ê¸°
                socket.emit('getFrequentMenus');
            }
            
            // ê¸°ë¡ ì„¹ì…˜ í‘œì‹œ
            document.getElementById('historySection').classList.add('visible');
            
            // ì±„íŒ… ê¸°ë¡ ë¡œë“œ
            if (data.chatHistory) {
                document.getElementById('chatMessages').innerHTML = '';
                window.rouletteChatHistory = [];
                data.chatHistory.forEach(msg => addChatMessage(msg));
                ChatModule.recalculatePins();
            }

            // ë£°ë › ê¸°ë¡ ë¡œë“œ
            if (data.gameState && data.gameState.rouletteHistory) {
                rouletteHistory = data.gameState.rouletteHistory;
                renderHistory();
            }
            
            // ì¤€ë¹„ ìƒíƒœ ë³µì›
            if (data.readyUsers) {
                readyUsers = data.readyUsers;
                isReady = readyUsers.includes(currentUser);
                ReadyModule.setReadyUsers(readyUsers);
            }
            
            // ëŒë¦¼íŒ ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™”
            updateRoulettePreview();
        }

        // === ì†Œì¼“ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ===
        
        socket.on('connect', () => {
        });

        socket.on('disconnect', () => {
        });

        socket.on('roomCreated', (data) => {
            currentRoomId = data.roomId;
            currentUser = data.userName || '';
            sessionStorage.setItem('rouletteActiveRoom', JSON.stringify({
                roomId: data.roomId, userName: currentUser,
                serverId: currentServerId, serverName: currentServerName
            }));
            initChatModule();
            isHost = true;
            isReady = data.isReady || false;
            readyUsers = data.readyUsers || [];
            initReadyModule();
            initOrderModule();

            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('gameSection').classList.add('active');
            document.body.classList.add('game-active');

            initializeGameScreen(data);
            ReadyModule.setReadyUsers(readyUsers);
        });

        socket.on('roomJoined', (data) => {
            sessionStorage.removeItem('rouletteFromDice');
            document.getElementById('loadingScreen').style.display = 'none';

            currentRoomId = data.roomId;
            const globalInput = document.getElementById('globalUserNameInput');
            currentUser = (globalInput && globalInput.value) || data.userName || '';
            sessionStorage.setItem('rouletteActiveRoom', JSON.stringify({
                roomId: data.roomId, userName: currentUser,
                serverId: currentServerId, serverName: currentServerName
            }));
            initChatModule();
            isHost = data.isHost;
            isReady = data.isReady || false;
            readyUsers = data.readyUsers || [];
            initReadyModule();
            initOrderModule();

            document.getElementById('gameSection').classList.add('active');
            document.body.classList.add('game-active');

            setRouletteSoundCheckboxes();
            initializeGameScreen(data);
            ReadyModule.setReadyUsers(readyUsers);
        });

        socket.on('roomError', (message) => {
            sessionStorage.removeItem('rouletteFromDice');
            sessionStorage.removeItem('rouletteActiveRoom');
            showCustomAlert(message, 'error');
            window.location.href = '/game';
        });

        socket.on('rouletteError', (message) => {
            showCustomAlert(message, 'error');
        });

        // readyError, readyStateChanged, readyUsersUpdatedëŠ” ReadyModuleì—ì„œ ì²˜ë¦¬

        // ========== ì£¼ë¬¸ë°›ê¸° ì´ë²¤íŠ¸ (OrderModuleì—ì„œ ì²˜ë¦¬) ==========

        socket.on('updateUsers', (users) => {
            if (window.SoundManager) SoundManager.playSound('common_notification', getRouletteSoundEnabled());
            ChatModule.updateConnectedUsers(users);
            currentUsers = users;

            // í˜¸ìŠ¤íŠ¸ ìƒíƒœ í™•ì¸ ë° ì—…ë°ì´íŠ¸
            const myUser = users.find(u => u.name === currentUser);
            if (myUser && myUser.isHost !== isHost) {
                const wasHost = isHost;
                isHost = myUser.isHost;
                if (isHost && !wasHost) {
                    // í˜¸ìŠ¤íŠ¸ ê¶Œí•œì´ ì „ë‹¬ë˜ì—ˆì„ ë•Œ
                    document.getElementById('hostBadge').style.display = 'inline-block';
                    document.getElementById('hostControls').style.display = 'grid';
                    updateStartButton();
                    
                    // ì£¼ë¬¸ë°›ê¸° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                    if (isOrderActive) {
                        document.getElementById('startOrderButton').style.display = 'none';
                        document.getElementById('endOrderButton').style.display = 'block';
                    } else {
                        document.getElementById('startOrderButton').style.display = 'block';
                        document.getElementById('endOrderButton').style.display = 'none';
                    }
                } else if (!isHost && wasHost) {
                    // í˜¸ìŠ¤íŠ¸ ê¶Œí•œì´ ì œê±°ë˜ì—ˆì„ ë•Œ
                    document.getElementById('hostBadge').style.display = 'none';
                    document.getElementById('hostControls').style.display = 'none';
                    updateStartButton();
                    
                    // ì£¼ë¬¸ë°›ê¸° ë²„íŠ¼ ìˆ¨ê¹€
                    document.getElementById('startOrderButton').style.display = 'none';
                    document.getElementById('endOrderButton').style.display = 'none';
                }
            }
            
            updateUsers(users);
            // ì£¼ë¬¸ë°›ê¸°ê°€ í™œì„±í™”ëœ ìƒíƒœë©´ ì£¼ë¬¸í•˜ì§€ ì•Šì€ ì‚¬ëŒ ëª©ë¡ë„ ì—…ë°ì´íŠ¸
            if (isOrderActive) {
                OrderModule.renderNotOrderedUsers();
            }
        });

        // readyStateChanged, readyUsersUpdatedëŠ” ReadyModuleì—ì„œ ì²˜ë¦¬ (initReadyModuleì—ì„œ ë°”ì¸ë”©)

        // ì±„íŒ… ë©”ì‹œì§€ ìˆ˜ì‹  ë° ì´ëª¨í‹°ì½˜ ë°˜ì‘ì€ ChatModuleì—ì„œ ì²˜ë¦¬ (initChatModuleì—ì„œ ë°”ì¸ë”©)

        // ë£°ë › ì‹¤ì œ ì‹œì‘ í•¨ìˆ˜ (í™”ë©´ í‘œì‹œ í™•ì¸ í›„ í˜¸ì¶œ)
        function actuallyStartRoulette(data) {
            addDebugLog(`ğŸ° actuallyStartRoulette í˜¸ì¶œ - isHost: ${isHost}, visibilityState: ${document.visibilityState}`, 'info');
            
            // í˜„ì¬ í™”ë©´ì„ ë³´ê³  ìˆëŠ”ì§€ í™•ì¸ (ìµœì†Œí™” ë˜ëŠ” íƒ­ ìˆ¨ê¹€ ì²´í¬) - ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì²´í¬
            if (document.visibilityState !== 'visible') {
                addDebugLog('âš ï¸ í™”ë©´ì´ ë³´ì´ì§€ ì•ŠìŒ - ë£°ë › ë¬´ì‹œ', 'visibility');
                console.log('âš ï¸ í™”ë©´ì´ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤. ë£°ë ›ì„ ë¬´ì‹œí•©ë‹ˆë‹¤.');
                // ë¬´ì‹œí•˜ê³  ê²°ê³¼ í™”ë©´ë„ í‘œì‹œí•˜ì§€ ì•ŠìŒ
                rouletteResultShown = true;
                isSpinning = false;
                pendingRouletteData = null;
                
                // ê²°ê³¼ ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸° (ì´ì „ ê²°ê³¼ê°€ ë‚¨ì•„ìˆì„ ìˆ˜ ìˆìŒ)
                document.getElementById('resultOverlay').classList.remove('visible');
                addDebugLog('ğŸ”’ resultOverlay ìˆ¨ê¹€ ì²˜ë¦¬', 'visibility');
                
                // UI ì´ˆê¸°í™”
                document.getElementById('readySection').style.display = 'block';
                document.getElementById('startRouletteButton').disabled = false;
                document.getElementById('startRouletteButton').textContent = 'ğŸ° ë£°ë › ì‹œì‘';
                return;
            }
            
            addDebugLog('âœ… í™”ë©´ì´ ë³´ì„ - ë£°ë › ì‹œì‘ ì§„í–‰', 'info');
            isSpinning = true;
            pendingRouletteData = null; // ëŒ€ê¸° ë°ì´í„° ì´ˆê¸°í™”
            rouletteResultShown = false; // ê²°ê³¼ í‘œì‹œ í”Œë˜ê·¸ ì´ˆê¸°í™”
            addDebugLog(`ğŸ“Š ìƒíƒœ ì„¤ì •: isSpinning=${isSpinning}, rouletteResultShown=${rouletteResultShown}`, 'info');
            
            // ì„œë²„ì—ì„œ ë°›ì€ ëˆ„ì  ì°¸ì—¬ì ëª©ë¡ìœ¼ë¡œ ì—…ë°ì´íŠ¸
            if (data.everPlayedUsers && Array.isArray(data.everPlayedUsers)) {
                everPlayedUsers = [...data.everPlayedUsers];
            }
            
            // UI ìƒíƒœ ë³€ê²½ (ëŒë¦¼íŒê³¼ ì¤€ë¹„ ì„¹ì…˜ì€ ê³„ì† í‘œì‹œ)
            // ë£°ë › ì‹œì‘ ë²„íŠ¼ë§Œ ë¹„í™œì„±í™” (ì£¼ë¬¸ë°›ê¸° ë²„íŠ¼ì€ ìœ ì§€)
            document.getElementById('startRouletteButton').disabled = true;
            document.getElementById('startRouletteButton').textContent = 'ğŸ° ë£°ë › ì§„í–‰ ì¤‘...';
            
            // ë£°ë › íœ  ìƒì„±
            createRouletteWheel(data.participants);
            
            // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì§ì ‘ ê°ë„ ê³„ì‚°
            // conic-gradient(from 0deg): index Nì€ N*segmentAngle ~ (N+1)*segmentAngle
            // index Nì˜ ì¤‘ì•™: (N + 0.5) * segmentAngle
            // 
            // rotate(X deg) í›„ í™”ì‚´í‘œê°€ ê°€ë¦¬í‚¤ëŠ” ìœ„ì¹˜ = (360 - X) mod 360
            // ë‹¹ì²¨ì ì¤‘ì•™ì´ í™”ì‚´í‘œì— ì˜¤ë ¤ë©´: X = 360 - winnerCenterAngle
            // totalRotationì€ 360ì˜ ë°°ìˆ˜ê°€ ì•„ë‹ˆë¯€ë¡œ, ì „ì²´ ë°”í€´ ìˆ˜ë§Œ ì‚¬ìš©
            const segmentAngle = 360 / data.participants.length;
            const winnerCenterAngle = (data.winnerIndex + 0.5) * segmentAngle;
            const neededRotation = 360 - winnerCenterAngle;
            const fullRotations = Math.floor(data.totalRotation / 360);
            const finalAngle = fullRotations * 360 + neededRotation;
            
            console.log('ë£°ë ›: participants=' + data.participants.length + ', winnerIndex=' + data.winnerIndex + ', winner=' + data.winner + ', neededRotation=' + neededRotation + ', finalAngle=' + finalAngle);
            
            // ê°•ì œ ë¦¬í”Œë¡œìš° í›„ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
            const wheel = document.getElementById('rouletteWheel');
            wheel.offsetHeight; // ê°•ì œ ë¦¬í”Œë¡œìš°
            
            setTimeout(() => {
                addDebugLog(`â° setTimeout ì½œë°± - isHost: ${isHost}, visibilityState: ${document.visibilityState}`, 'animation');
                
                // í™”ë©´ì´ ë³´ì´ëŠ”ì§€ ë‹¤ì‹œ í•œ ë²ˆ í™•ì¸ (ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ ì§ì „) - ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì²´í¬
                if (document.visibilityState !== 'visible') {
                    addDebugLog('âš ï¸ setTimeout ì•ˆì—ì„œ í™”ë©´ NOT visible - ë£°ë › ë¬´ì‹œ', 'visibility');
                    console.log('âš ï¸ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ ì§ì „ í™”ë©´ì´ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤. ë£°ë ›ì„ ë¬´ì‹œí•©ë‹ˆë‹¤.');
                    // ë¬´ì‹œí•˜ê³  ê²°ê³¼ í™”ë©´ë„ í‘œì‹œí•˜ì§€ ì•ŠìŒ
                    rouletteResultShown = true;
                    isSpinning = false;
                    pendingRouletteData = null;
                    addDebugLog(`ğŸ“Š ìƒíƒœ ì„¤ì •: rouletteResultShown=${rouletteResultShown}, isSpinning=${isSpinning}`, 'visibility');
                    
                    // ê²°ê³¼ ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸° (ì´ì „ ê²°ê³¼ê°€ ë‚¨ì•„ìˆì„ ìˆ˜ ìˆìŒ)
                    document.getElementById('resultOverlay').classList.remove('visible');
                    addDebugLog('ğŸ”’ resultOverlay ìˆ¨ê¹€ ì²˜ë¦¬', 'visibility');
                    
                    // UI ì´ˆê¸°í™”
                    document.getElementById('readySection').style.display = 'block';
                    document.getElementById('startRouletteButton').disabled = false;
                    document.getElementById('startRouletteButton').textContent = 'ğŸ° ë£°ë › ì‹œì‘';
                    return;
                }
                
                // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ ì „ ìƒíƒœ í™•ì¸
                const wasSpinning = isSpinning;
                const animationStartTime = Date.now();
                rouletteResultShown = false; // ê²°ê³¼ í‘œì‹œ í”Œë˜ê·¸ ì´ˆê¸°í™”
                addDebugLog(`ğŸ¬ spinRoulette í˜¸ì¶œ ì‹œì‘ - wasSpinning: ${wasSpinning}, rouletteResultShown: ${rouletteResultShown}, effectType: ${data.effectType}`, 'animation');
                
                spinRoulette(finalAngle, data.spinDuration, data.effectType || 'normal', data.effectParams || {}, () => {
                    addDebugLog(`ğŸ”„ spinRoulette ì½œë°± ì‹¤í–‰ - rouletteResultShown: ${rouletteResultShown}, wasSpinning: ${wasSpinning}`, 'animation');
                    
                    // ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
                    if (rouletteResultShown) {
                        addDebugLog('âš ï¸ ê²°ê³¼ ì´ë¯¸ í‘œì‹œë¨ - ì¤‘ë³µ ë°©ì§€ë¡œ return', 'warn');
                        console.log('âš ï¸ ê²°ê³¼ê°€ ì´ë¯¸ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤. ì¤‘ë³µ í‘œì‹œë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.');
                        return;
                    }
                    
                    // ì• ë‹ˆë©”ì´ì…˜ì´ ì‹¤ì œë¡œ ì‹œì‘ë˜ì—ˆëŠ”ì§€ í™•ì¸
                    if (!wasSpinning) {
                        addDebugLog('âš ï¸ wasSpinning=false - ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ ì•ˆ ë¨, return', 'warn');
                        console.log('âš ï¸ ì• ë‹ˆë©”ì´ì…˜ì´ ì‹œì‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í‘œì‹œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                        return;
                    }
                    
                    // ì• ë‹ˆë©”ì´ì…˜ ìµœì†Œ ì‹œê°„ í™•ì¸ (ë„ˆë¬´ ë¹¨ë¦¬ ì™„ë£Œë˜ë©´ ì‹¤ì œ ì• ë‹ˆë©”ì´ì…˜ì´ ì•„ë‹ ìˆ˜ ìˆìŒ)
                    const elapsed = Date.now() - animationStartTime;
                    const minDuration = data.spinDuration * 0.7; // ìµœì†Œ 70% ì´ìƒ ê²½ê³¼í•´ì•¼ í•¨ (ë„ˆë¬´ ì—„ê²©í•˜ì§€ ì•Šê²Œ)
                    addDebugLog(`â±ï¸ ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„ ì²´í¬ - elapsed: ${elapsed}ms, minDuration: ${minDuration}ms`, 'animation');
                    if (elapsed < minDuration) {
                        addDebugLog(`âš ï¸ ì• ë‹ˆë©”ì´ì…˜ ë„ˆë¬´ ë¹¨ë¦¬ ì™„ë£Œ (${elapsed}ms < ${minDuration}ms) - return`, 'warn');
                        console.log(`âš ï¸ ì• ë‹ˆë©”ì´ì…˜ì´ ë„ˆë¬´ ë¹¨ë¦¬ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤ (${elapsed}ms < ${minDuration}ms). ê²°ê³¼ë¥¼ í‘œì‹œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
                        return;
                    }
                    
                    addDebugLog('âœ… ëª¨ë“  ì²´í¬ í†µê³¼ - ê²°ê³¼ í‘œì‹œ ì§„í–‰', 'info');
                    isSpinning = false;
                    rouletteResultShown = true; // ê²°ê³¼ í‘œì‹œ í”Œë˜ê·¸ ì„¤ì •
                    
                    // ========== ğŸ§ª CSS ì• ë‹ˆë©”ì´ì…˜ ê²€ì¦ ë¡œê·¸ ==========
                    const wheelAfter = document.getElementById('rouletteWheel');
                    const computedTransform = window.getComputedStyle(wheelAfter).transform;
                    
                    // matrixì—ì„œ ì‹¤ì œ ê°ë„ ì¶”ì¶œ
                    let actualAngle = null;
                    if (computedTransform && computedTransform !== 'none') {
                        const matrixMatch = computedTransform.match(/matrix\(([^)]+)\)/);
                        if (matrixMatch) {
                            const values = matrixMatch[1].split(',').map(v => parseFloat(v.trim()));
                            actualAngle = Math.atan2(values[1], values[0]) * (180 / Math.PI);
                            if (actualAngle < 0) actualAngle += 360;
                        }
                    }
                    
                    const expectedAngle = finalAngle % 360;
                    const diff = actualAngle !== null ? Math.abs(actualAngle - expectedAngle) : null;
                    const diffAdjusted = diff !== null ? Math.min(diff, 360 - diff) : null;
                    const isAccurate = diffAdjusted !== null && diffAdjusted <= 1;
                    
                    // í™”ì‚´í‘œê°€ ê°€ë¦¬í‚¤ëŠ” ì„¸ê·¸ë¨¼íŠ¸ ê²€ì¦
                    const arrowPointsTo = (360 - (finalAngle % 360) + 360) % 360;
                    const winnerStart = data.winnerIndex * segmentAngle;
                    const winnerEnd = (data.winnerIndex + 1) * segmentAngle;
                    const isInWinnerSegment = arrowPointsTo >= winnerStart && arrowPointsTo < winnerEnd;
                    
                    console.log('%c========== ğŸ° ë£°ë › CSS ê²€ì¦ ==========', 'font-size: 14px; font-weight: bold; color: var(--roulette-accent);');
                    console.log('ì°¸ê°€ì:', data.participants);
                    console.log('ë‹¹ì²¨ì:', data.winner, '(index:', data.winnerIndex + ')');
                    console.log('ì„¸ê·¸ë¨¼íŠ¸ ê°ë„:', segmentAngle.toFixed(2) + 'Â°');
                    console.log('ë‹¹ì²¨ì ì„¸ê·¸ë¨¼íŠ¸ ë²”ìœ„:', winnerStart.toFixed(2) + 'Â° ~ ' + winnerEnd.toFixed(2) + 'Â°');
                    console.log('---');
                    console.log('ëª©í‘œ íšŒì „ (ì „ì²´):', finalAngle.toFixed(2) + 'Â°');
                    console.log('ëª©í‘œ íšŒì „ (mod 360):', expectedAngle.toFixed(2) + 'Â°');
                    console.log('ì‹¤ì œ CSS ê°ë„:', actualAngle !== null ? actualAngle.toFixed(2) + 'Â°' : 'N/A');
                    console.log('ì˜¤ì°¨:', diffAdjusted !== null ? diffAdjusted.toFixed(2) + 'Â°' : 'N/A');
                    console.log('---');
                    console.log('í™”ì‚´í‘œ ê°€ë¦¬í‚¤ëŠ” ìœ„ì¹˜:', arrowPointsTo.toFixed(2) + 'Â°');
                    console.log('ë‹¹ì²¨ì ì„¸ê·¸ë¨¼íŠ¸ ì•ˆì— ìˆìŒ?', isInWinnerSegment ? 'âœ… YES' : 'âŒ NO');
                    console.log('---');
                    console.log('style.transform:', wheelAfter.style.transform);
                    console.log('computed transform:', computedTransform);
                    
                    if (isAccurate && isInWinnerSegment) {
                        console.log('%câœ… í…ŒìŠ¤íŠ¸ í†µê³¼: CSS ì• ë‹ˆë©”ì´ì…˜ ì •í™•!', 'color: green; font-weight: bold; font-size: 16px;');
                    } else if (isInWinnerSegment) {
                        console.log('%câš ï¸ ë¶€ë¶„ í†µê³¼: ì„¸ê·¸ë¨¼íŠ¸ëŠ” ë§ì§€ë§Œ ê°ë„ ì˜¤ì°¨ ìˆìŒ', 'color: orange; font-weight: bold; font-size: 16px;');
                    } else {
                        console.log('%câŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: í™”ì‚´í‘œê°€ ë‹¤ë¥¸ ì„¸ê·¸ë¨¼íŠ¸ë¥¼ ê°€ë¦¬í‚´!', 'color: red; font-weight: bold; font-size: 16px;');
                    }
                    console.log('%c==========================================', 'font-size: 14px; font-weight: bold; color: var(--roulette-accent);');
                    // ========== ê²€ì¦ ë¡œê·¸ ë ==========
                    
                    // í˜¸ìŠ¤íŠ¸ë§Œ ê²°ê³¼ ì´ë²¤íŠ¸ ì „ì†¡ (ì• ë‹ˆë©”ì´ì…˜ì´ ì‹¤ì œë¡œ ì™„ë£Œëœ ê²½ìš°ì—ë§Œ)
                    if (isHost) {
                        addDebugLog(`ğŸ“¤ rouletteResult emit - winner: ${data.winner}`, 'info');
                        socket.emit('rouletteResult', { winner: data.winner });
                    }
                    
                    // ê²°ê³¼ ì˜¤ë²„ë ˆì´ í‘œì‹œ (ì• ë‹ˆë©”ì´ì…˜ì´ ì‹¤ì œë¡œ ì™„ë£Œëœ ê²½ìš°ì—ë§Œ, ì¤‘ë³µ ë°©ì§€)
                    addDebugLog(`ğŸŠ ê²°ê³¼ ì˜¤ë²„ë ˆì´ í‘œì‹œ - winner: ${data.winner}`, 'gameEnd');
                    document.getElementById('resultWinner').textContent = data.winner;
                    document.getElementById('resultOverlay').classList.add('visible');
                    if (data.winner === currentUser) RouletteSound.playWinner();
                    if (window.SoundManager) SoundManager.stopLoop('roulette_bgm');

                    // ê¸°ë¡ ì¶”ê°€
                    rouletteHistory.push(data.record);
                    renderHistory();
                    
                    // í˜¸ìŠ¤íŠ¸ì—ê²Œ ì¢…ë£Œ ë²„íŠ¼ í‘œì‹œ
                    if (isHost) {
                        document.getElementById('endGameSection').style.display = 'block';
                    }
                    
                    // ë‹¤ì‹œë³´ê¸° ë²„íŠ¼ í‘œì‹œ (ëª¨ë“  ì‚¬ëŒ ì‚¬ìš© ê°€ëŠ¥)
                    showReplayButton();
                    
                    // ë£°ë › ì‹œì‘ ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
                    updateStartButton();
                });
            }, 50); // 50ms ì§€ì—°ìœ¼ë¡œ ë¦¬í”Œë¡œìš° ë³´ì¥
        }
        
        socket.on('rouletteStarted', (data) => {
            if (window.SoundManager) SoundManager.playLoop('roulette_bgm', getRouletteSoundEnabled(), 0.3);
            const hasFocus = document.hasFocus();
            const isVisible = document.visibilityState === 'visible';
            const isActuallyVisible = isVisible && hasFocus; // ë‘˜ ë‹¤ ì¶©ì¡±í•´ì•¼ ì‹¤ì œë¡œ ë³´ì´ëŠ” ê²ƒ
            
            addDebugLog(`ğŸ“¨ rouletteStarted ì´ë²¤íŠ¸ ìˆ˜ì‹  - isHost: ${isHost}, visible: ${isVisible}, hasFocus: ${hasFocus}`, 'info');
            addDebugLog(`ğŸ“Š data: winner=${data.winner}, participants=${data.participants?.length}ëª…`, 'info');
            
            // ë§ˆì§€ë§‰ ë£°ë › ë°ì´í„° ì €ì¥ (ëª¨ë“  ì‚¬ëŒ ë‹¤ì‹œë³´ê¸° ê°€ëŠ¥)
            lastRouletteData = data;
            
            // ë‹¤ì‹œë³´ê¸° ì„¹ì…˜ ìˆ¨ê¸°ê¸° (ìƒˆ ë£°ë › ì‹œì‘ ì‹œ)
            document.getElementById('replaySection').style.display = 'none';
            
            // ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ì—ì„œ í™”ë©´ í‘œì‹œ í™•ì¸ (í˜¸ìŠ¤íŠ¸/ë¹„í˜¸ìŠ¤íŠ¸ ëª¨ë‘)
            // visibilityStateê°€ visibleì´ê³  ì°½ì´ í¬ì»¤ìŠ¤ë¥¼ ê°€ì§€ê³  ìˆì–´ì•¼ ì‹¤ì œë¡œ ë³´ì´ëŠ” ê²ƒ
            if (isActuallyVisible) {
                addDebugLog('âœ… í™”ë©´ visible + í¬ì»¤ìŠ¤ ìˆìŒ â†’ actuallyStartRoulette í˜¸ì¶œ', 'info');
                // í™”ë©´ì´ ë³´ì´ë©´ ì¦‰ì‹œ ì‹œì‘
                missedRoulette = false;
                actuallyStartRoulette(data);
            } else {
                addDebugLog(`âš ï¸ í™”ë©´ NOT visible (visible=${isVisible}, focus=${hasFocus}) â†’ ë£°ë › ë¬´ì‹œ, ë‹¤ì‹œë³´ê¸° ë°ì´í„° ì €ì¥`, 'visibility');
                // í™”ë©´ì´ ë³´ì´ì§€ ì•Šìœ¼ë©´ ë¬´ì‹œ (ëŒ€ê¸°í•˜ì§€ ì•ŠìŒ)
                console.log('âš ï¸ í™”ë©´ì´ ë³´ì´ì§€ ì•Šì•„ ë£°ë ›ì„ ë¬´ì‹œí•©ë‹ˆë‹¤. ë‹¤ì‹œë³´ê¸°ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                
                // ë†“ì¹œ ìƒíƒœ í‘œì‹œ
                missedRoulette = true;
                addDebugLog(`ğŸ“¦ missedRoulette = true, lastRouletteData ì €ì¥ - winner: ${data.winner}`, 'visibility');
                
                // ë£°ë › ê²°ê³¼ ë¬´ì‹œ í”Œë˜ê·¸ ì„¤ì •
                rouletteResultShown = true; // ê²°ê³¼ í™”ë©´ì´ ëœ¨ì§€ ì•Šë„ë¡ ì„¤ì •
                isSpinning = false;
                pendingRouletteData = null; // ëŒ€ê¸° ë°ì´í„° ì—†ìŒ
                addDebugLog(`ğŸ“Š ìƒíƒœ ì„¤ì •: rouletteResultShown=${rouletteResultShown}, isSpinning=${isSpinning}`, 'visibility');
                
                // ê²°ê³¼ ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸° (ì´ì „ ê²°ê³¼ê°€ ë‚¨ì•„ìˆì„ ìˆ˜ ìˆìŒ)
                document.getElementById('resultOverlay').classList.remove('visible');
                addDebugLog('ğŸ”’ resultOverlay ìˆ¨ê¹€ ì²˜ë¦¬', 'visibility');
                
                // ë‹¤ì‹œë³´ê¸° ì„¹ì…˜ í‘œì‹œ (ë†“ì¹œ ê²½ìš° ë©”ì‹œì§€)
                const replaySection = document.getElementById('replaySection');
                const replayMessage = replaySection.querySelector('div');
                if (replayMessage) {
                    replayMessage.textContent = 'ğŸ¬ í™”ë©´ì„ ë³´ì§€ ì•ŠëŠ” ë™ì•ˆ ë£°ë ›ì´ ì§„í–‰ë˜ì—ˆìŠµë‹ˆë‹¤';
                }
                replaySection.style.display = 'block';
                addDebugLog('ğŸ¬ ë‹¤ì‹œë³´ê¸° ì„¹ì…˜ í‘œì‹œ (ë†“ì¹œ ê²½ìš°)', 'visibility');
                
                // UI ì´ˆê¸°í™” - ë‹¤ì‹œ ì‹œì‘í•  ìˆ˜ ìˆë„ë¡
                document.getElementById('readySection').style.display = 'block';
                document.getElementById('startRouletteButton').disabled = false;
                document.getElementById('startRouletteButton').textContent = 'ğŸ° ë£°ë › ì‹œì‘';
            }
        });

        socket.on('rouletteEnded', (data) => {
            // ê²°ê³¼ ì²˜ë¦¬ ì™„ë£Œ - ì¤€ë¹„ ìƒíƒœ ì´ˆê¸°í™”
            isReady = false;
            updateReadyButton();
        });
        
        // í„°ë³´ ì• ë‹ˆë©”ì´ì…˜ ì„¤ì • ì—…ë°ì´íŠ¸
        socket.on('turboAnimationUpdated', (data) => {
            turboAnimation = data.turboAnimation;
            updateTurboAnimationBadge();
            updateTurboSettingUI();
            addDebugLog(`ğŸš€ í„°ë³´ ì• ë‹ˆë©”ì´ì…˜ ${turboAnimation ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}ë¨`, 'info');
        });

        socket.on('rouletteGameEnded', (data) => {
            isSpinning = false;
            rouletteResultShown = false; // ê²°ê³¼ í‘œì‹œ í”Œë˜ê·¸ ì´ˆê¸°í™”
            missedRoulette = false; // ë†“ì¹œ ìƒíƒœ ì´ˆê¸°í™”
            lastRouletteData = null; // ë§ˆì§€ë§‰ ë£°ë › ë°ì´í„° ì´ˆê¸°í™” (ê²Œì„ ì¢…ë£Œ ì‹œ)
            isReady = false; // ì¤€ë¹„ ìƒíƒœ ì´ˆê¸°í™”
            
            // ê²°ê³¼ ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
            document.getElementById('resultOverlay').classList.remove('visible');
            
            // ë‹¤ì‹œë³´ê¸° ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.getElementById('replaySection').style.display = 'none';
            
            // UI ì´ˆê¸°í™” (ëŒë¦¼íŒì€ ê³„ì† í‘œì‹œ)
            document.getElementById('rouletteContainer').style.display = 'flex';
            document.getElementById('readySection').style.display = 'block';
            document.getElementById('endGameSection').style.display = 'none';
            
            // ì¤€ë¹„ ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
            updateReadyButton();
            
            // ë£°ë › íœ  ì´ˆê¸°í™”
            const wheel = document.getElementById('rouletteWheel');
            wheel.style.transition = 'none';
            wheel.style.transform = 'rotate(0deg)';
            
            // í˜¸ìŠ¤íŠ¸ ì»¨íŠ¸ë¡¤ í‘œì‹œ
            if (isHost) {
                document.getElementById('hostControls').style.display = 'grid';
            }
            
            // ì¤€ë¹„ ìƒíƒœ ì´ˆê¸°í™”
            readyUsers = [];
            isReady = false;
            ReadyModule.setReadyUsers([]);
            updateStartButton();
        });

        socket.on('roomDeleted', (data) => {
            sessionStorage.removeItem('rouletteActiveRoom');
            showCustomAlert(data.message || 'ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            if (roomExpiryInterval) {
                clearInterval(roomExpiryInterval);
            }
            sessionStorage.setItem('returnToLobby', JSON.stringify({ serverId: currentServerId }));
            window.location.replace('/game');
        });

        // ë°© ë‚˜ê°€ê¸° ì™„ë£Œ (ì„œë²„ì—ì„œ roomLeft emit)
        socket.on('roomLeft', () => {
            sessionStorage.removeItem('rouletteActiveRoom');
            if (roomExpiryInterval) {
                clearInterval(roomExpiryInterval);
            }
            sessionStorage.setItem('returnToLobby', JSON.stringify({ serverId: currentServerId }));
            window.location.replace('/game');
        });

        // ë ˆê±°ì‹œ ì´ë²¤íŠ¸ í˜¸í™˜ì„± ìœ ì§€
        socket.on('leftRoom', () => {
            sessionStorage.removeItem('rouletteActiveRoom');
            if (roomExpiryInterval) {
                clearInterval(roomExpiryInterval);
            }
            sessionStorage.setItem('returnToLobby', JSON.stringify({ serverId: currentServerId }));
            window.location.replace('/game');
        });

        // í˜¸ìŠ¤íŠ¸ ê¶Œí•œ ì „ë‹¬ ì•Œë¦¼
        socket.on('hostTransferred', (data) => {
            showCustomAlert(data.message || 'í˜¸ìŠ¤íŠ¸ ê¶Œí•œì´ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            isHost = true;
            document.getElementById('hostBadge').style.display = 'inline-block';
            document.getElementById('hostControls').style.display = 'grid';
            updateStartButton();
            
            // ì£¼ë¬¸ë°›ê¸° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            if (isOrderActive) {
                document.getElementById('startOrderButton').style.display = 'none';
                document.getElementById('endOrderButton').style.display = 'block';
            } else {
                document.getElementById('startOrderButton').style.display = 'block';
                document.getElementById('endOrderButton').style.display = 'none';
            }
        });
        
        // í˜¸ìŠ¤íŠ¸ ë³€ê²½ ì•Œë¦¼
        socket.on('hostChanged', (data) => {
            // updateUsers ì´ë²¤íŠ¸ë¥¼ í†µí•´ í˜¸ìŠ¤íŠ¸ ìƒíƒœ í™•ì¸
            console.log('í˜¸ìŠ¤íŠ¸ ë³€ê²½ ì•Œë¦¼:', data.message);
        });
        
        // ë¹„ê³µê°œ ë°© ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
        document.addEventListener('DOMContentLoaded', () => {
            // ë³¼ë¥¨ ì»¨íŠ¸ë¡¤ì€ ControlBar.init()ì—ì„œ ì²˜ë¦¬ë¨
            
            // ì €ì¥ëœ ì´ë¦„ ë¶ˆëŸ¬ì˜¤ê¸°
            const savedName = localStorage.getItem('rouletteUserName');
            if (savedName) {
                document.getElementById('globalUserNameInput').value = savedName;
            }
            
            // URL íŒŒë¼ë¯¸í„°ë¡œ ë°© ìƒì„±/ì…ì¥ ìš”ì²­ì´ ì™”ëŠ”ì§€ í™•ì¸
            const urlParams = new URLSearchParams(window.location.search);
            
            // ë°© ìƒì„± ìš”ì²­
            if (urlParams.get('createRoom') === 'true') {
                const pendingRoom = localStorage.getItem('pendingRouletteRoom');
                if (pendingRoom) {
                    const roomData = JSON.parse(pendingRoom);
                    localStorage.removeItem('pendingRouletteRoom');
                    
                    // ì†Œì¼“ ì—°ê²° í›„ ë°© ìƒì„±
                    socket.on('connect', function onConnect() {
                        socket.off('connect', onConnect); // í•œ ë²ˆë§Œ ì‹¤í–‰
                        
                        socket.emit('createRoom', {
                            userName: roomData.userName,
                            roomName: roomData.roomName,
                            isPrivate: roomData.isPrivate,
                            password: roomData.password,
                            gameType: 'roulette',
                            expiryHours: roomData.expiryHours,
                            blockIPPerUser: roomData.blockIPPerUser,
                            deviceId: getDeviceId(),
                            serverId: roomData.serverId || currentServerId,
                            serverName: roomData.serverName || currentServerName,
                            tabId: getTabId()
                        });
                    });

                    // URLì—ì„œ íŒŒë¼ë¯¸í„° ì œê±°
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
            
            // ë°© ì…ì¥ ìš”ì²­
            if (urlParams.get('joinRoom') === 'true') {
                const pendingJoin = localStorage.getItem('pendingRouletteJoin');
                if (pendingJoin) {
                    const joinData = JSON.parse(pendingJoin);
                    localStorage.removeItem('pendingRouletteJoin');
                    
                    // ì—ëŸ¬ ì‹œ ëŒì•„ê°ˆ í”Œë˜ê·¸ ì €ì¥
                    sessionStorage.setItem('rouletteFromDice', 'true');
                    
                    // ì´ë¦„ ì„¤ì •
                    document.getElementById('globalUserNameInput').value = joinData.userName;
                    
                    // ì†Œì¼“ ì—°ê²° í›„ ë°© ì…ì¥
                    socket.on('connect', function onJoinConnect() {
                        socket.off('connect', onJoinConnect); // í•œ ë²ˆë§Œ ì‹¤í–‰
                        
                        if (joinData.isPrivate) {
                            // ë¹„ê³µê°œ ë°©ì´ë©´ ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ í‘œì‹œ
                            pendingRoomId = joinData.roomId;
                            pendingUserName = joinData.userName;
                            document.getElementById('passwordModal').style.display = 'flex';
                            document.getElementById('roomPasswordInput').focus();
                        } else {
                            // ê³µê°œ ë°©ì´ë©´ ë°”ë¡œ ì…ì¥
                            socket.emit('joinRoom', {
                                roomId: joinData.roomId,
                                userName: joinData.userName,
                                isHost: false,
                                password: '',
                                deviceId: getDeviceId(),
                                tabId: getTabId()
                            });
                        }
                    });
                    
                    // URLì—ì„œ íŒŒë¼ë¯¸í„° ì œê±°
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
        });

        // ========== ì£¼ë¬¸ë°›ê¸° (OrderModule ì‚¬ìš©) ==========
        
    </script>
</body>
</html>

