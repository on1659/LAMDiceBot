<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸° (ë©€í‹°í”Œë ˆì´ì–´)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .lobby-section, .game-section, .create-room-section {
            display: none;
        }

        .lobby-section.active, .game-section.active, .create-room-section.active {
            display: block;
        }
        
        .rooms-list {
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
        }
        
        .room-item {
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .room-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .room-item.active {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        
        .room-item.my-room {
            background: #fff3cd;
            border-color: #ffc107;
            border-width: 3px;
        }
        
        .my-room-badge {
            display: inline-block;
            background: #ffc107;
            color: #333;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .room-info {
            flex: 1;
        }
        
        .room-name {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .room-details {
            font-size: 14px;
            color: #666;
        }
        
        .room-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            margin-top: 5px;
            display: inline-block;
        }
        
        .room-status.playing {
            background: #d4edda;
            color: #155724;
        }
        
        .room-status.ordering {
            background: #fff9e6;
            color: #856404;
        }
        
        .room-status.waiting {
            background: #e0e0e0;
            color: #666;
        }
        
        .room-action {
            margin-left: 15px;
        }
        
        .room-action button {
            width: auto;
            padding: 10px 20px;
        }
        
        .create-room-section, .join-room-section {
            background: #f8f9fa;
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .room-name-input-section {
            background: #f8f9fa;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: none;
        }
        
        .room-name-input-section.active {
            display: block;
        }
        
        .room-name-display {
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 10px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        input[type="text"], input[type="number"], textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
        }

        input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .user-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-name {
            font-weight: 600;
            color: #667eea;
            font-size: 18px;
        }

        .host-badge {
            background: #ffc107;
            color: #333;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .connection-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .connection-status.connected {
            background: #28a745;
            color: white;
        }

        .connection-status.disconnected {
            background: #dc3545;
            color: white;
        }

        .game-status {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 18px;
        }

        .game-status.waiting {
            background: #fff3cd;
            color: #856404;
        }

        .game-status.playing {
            background: #d4edda;
            color: #155724;
        }

        .game-status.ordering {
            background: #fff9e6;
            color: #856404;
        }

        .host-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        #clearDataButton {
            grid-column: 1 / -1;
        }

        .dice-container {
            text-align: center;
            margin: 30px 0;
        }

        .dice {
            width: 150px;
            height: 150px;
            background: white;
            border: 3px solid #667eea;
            border-radius: 15px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            margin: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s;
        }

        .dice.rolling {
            animation: roll 0.5s ease-in-out;
        }

        @keyframes roll {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(90deg); }
            50% { transform: rotate(180deg); }
            75% { transform: rotate(270deg); }
        }

        .roll-button {
            margin: 20px 0;
        }

        .users-section {
            margin-bottom: 20px;
        }

        .progress-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #667eea;
        }

        .progress-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .progress-bar-container {
            background: #e0e0e0;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .progress-text {
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 20px;
        }

        .not-rolled-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed #ddd;
        }

        .not-rolled-title {
            font-size: 16px;
            font-weight: 600;
            color: #856404;
            margin-bottom: 12px;
        }

        .not-rolled-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 40px;
        }

        .not-rolled-tag {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .empty-not-rolled {
            color: #28a745;
            text-align: center;
            padding: 10px;
            font-weight: 600;
            width: 100%;
        }

        .users-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
        }

        .users-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 50px;
        }

        .user-tag {
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .user-tag.host {
            background: #667eea;
            color: white;
        }

        /* ì£¼ë¬¸ë°›ê¸° ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .orders-section {
            margin-bottom: 20px;
            display: none;
        }

        .orders-section.active {
            display: block;
        }

        .my-order-box {
            background: #fff9e6;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .my-order-title {
            font-size: 16px;
            font-weight: 600;
            color: #856404;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .order-input-group {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            position: relative;
        }

        .order-input-wrapper {
            position: relative;
            width: 100%;
        }

        .autocomplete-suggestion {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 12px;
            color: #999;
            pointer-events: none;
            font-family: inherit;
            font-size: 16px;
            line-height: 1.5;
            border: 2px solid transparent;
            border-radius: 8px;
            z-index: 1;
        }

        #myOrderInput {
            position: relative;
            z-index: 2;
            background-color: transparent;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            margin-top: 4px;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        .autocomplete-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background-color: #e3f2fd;
        }

        .menu-manager {
            background: #f8f9fa;
            border: 2px solid #667eea;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }

        .menu-manager.active {
            display: block;
        }

        .menu-manager-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .menu-manager-input {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
        }

        .menu-list {
            background: white;
            border-radius: 6px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
        }

        .menu-tag {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 14px;
            margin: 4px;
            position: relative;
        }

        .menu-tag .delete-btn {
            margin-left: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .menu-tag .delete-btn:hover {
            opacity: 0.8;
        }

        .order-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .order-item {
            background: white;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 3px solid #ffc107;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .order-item:last-child {
            margin-bottom: 0;
        }

        .order-item-left {
            flex: 1;
        }

        .order-user {
            font-weight: 600;
            color: #856404;
            margin-bottom: 4px;
        }

        .order-text {
            color: #666;
            font-size: 14px;
            word-break: break-word;
        }

        .order-text.empty {
            color: #999;
            font-style: italic;
        }

        .order-count {
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            margin-left: 15px;
        }

        .history-section {
            margin-top: 30px;
        }

        .history-title-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .history-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .sort-buttons {
            display: flex;
            gap: 5px;
        }

        .sort-button {
            background: #f8f9fa;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: auto;
        }

        .sort-button:hover {
            background: #e3f2fd;
            transform: none;
        }

        .sort-button.active {
            background: #667eea;
            color: white;
        }

        .history-list {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }

        .history-item {
            background: white;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item:last-child {
            margin-bottom: 0;
        }

        .history-user {
            font-weight: 600;
            color: #667eea;
        }

        .history-result {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .history-time {
            font-size: 12px;
            color: #999;
        }

        .history-range {
            font-size: 12px;
            color: #667eea;
            font-weight: 600;
        }

        .empty-history {
            text-align: center;
            color: #999;
            padding: 20px;
        }

        .logout-button {
            background: #dc3545;
            margin-top: 10px;
        }

        .logout-button:hover {
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
        }

        .dice-settings {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #2196f3;
        }

        .dice-settings-title {
            font-size: 16px;
            font-weight: 600;
            color: #1976d2;
            margin-bottom: 10px;
        }

        .dice-range-inputs {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: end;
        }

        .reconnect-notice {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .reconnect-notice strong {
            color: #856404;
            font-size: 16px;
        }

        .reconnect-notice p {
            color: #856404;
            margin-top: 8px;
            font-size: 14px;
        }

        .order-button {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        }

        .order-button:hover {
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.4);
        }

        .clear-data-button {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .clear-data-button:hover {
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ² LAM Dice :)</h1>

        <!-- ëŒ€ê¸°ì‹¤ ì„¹ì…˜ -->
        <div class="lobby-section active" id="lobbySection">
            <div class="create-room-button-section" style="background: #f8f9fa; border: 2px solid #667eea; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h2 style="margin-bottom: 15px; color: #667eea;">ë°© ë§Œë“¤ê¸°</h2>
                <button onclick="showCreateRoomPage()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin-bottom: 15px;">ë°© ìƒì„±í•˜ê¸°</button>
                <div class="input-group" style="margin: 0;">
                    <label for="globalUserNameInput">ì´ë¦„</label>
                    <input type="text" id="globalUserNameInput" placeholder="ì´ë¦„ ì…ë ¥" maxlength="20" />
            </div>
            </div>
            
            <div class="join-room-section">
                <h2 style="margin-bottom: 15px; color: #667eea;">ë°© ëª©ë¡</h2>
                <button onclick="refreshRooms()" style="width: auto; padding: 8px 16px; margin-bottom: 15px; background: #6c757d;">ìƒˆë¡œê³ ì¹¨</button>
                <div class="rooms-list" id="roomsList">
                    <div style="color: #999; text-align: center; padding: 20px;">ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
                
            </div>
            
            <!-- ì—…ë°ì´íŠ¸ ë‚´ì—­ -->
            <div class="update-log-section" style="background: #f8f9fa; border: 2px solid #667eea; border-radius: 12px; padding: 20px; margin-top: 20px;">
                <h2 style="margin-bottom: 15px; color: #667eea;">ğŸ“ ì—…ë°ì´íŠ¸ ë‚´ì—­</h2>
                <div class="update-log-content" id="updateLogContent" style="background: white; border-radius: 8px; padding: 15px; max-height: 300px; overflow-y: auto; white-space: pre-wrap; line-height: 1.8; color: #333; font-size: 14px;">
<b style="color: #667eea;">ğŸ® ìµœì‹  ì—…ë°ì´íŠ¸</b> <span style="color: #999; font-size: 12px; font-weight: normal;">(2025-01-27)</span>

<b>ğŸ”„ ë°© ìƒì„± ë° ì…ì¥ ì‹œìŠ¤í…œ ê°œì„ </b>
â€¢ ë°© ìƒì„± ì‹œ ë°© ì œëª© ìë™ ìƒì„± ("ì´ë¦„ë‹˜ì˜ Dice" í˜•ì‹)
â€¢ í˜¸ìŠ¤íŠ¸ ì´ë¦„ ì…ë ¥ ì‹œ ë°© ì œëª© ì‹¤ì‹œê°„ ìë™ ì—…ë°ì´íŠ¸
â€¢ ë°© ìƒì„± ì „ ë°© ì œëª©ê³¼ í˜¸ìŠ¤íŠ¸ ì´ë¦„ë§Œ ì…ë ¥í•˜ë©´ ê°„í¸í•˜ê²Œ ìƒì„±
â€¢ ì£¼ì‚¬ìœ„ ë²”ìœ„ ë° ê²Œì„ ë£°ì€ ë°© ìƒì„± í›„ ë°© ë‚´ë¶€ì—ì„œ ì„¤ì • ê°€ëŠ¥

<b>ğŸ‘¤ ì „ì—­ ì´ë¦„ ì‹œìŠ¤í…œ</b>
â€¢ ëŒ€ê¸°ì‹¤ì—ì„œ í•œ ë²ˆë§Œ ì´ë¦„ ì…ë ¥í•˜ë©´ ëª¨ë“  ë°©ì— ë™ì¼ ì´ë¦„ìœ¼ë¡œ ì…ì¥
â€¢ ë§ˆì§€ë§‰ ì‚¬ìš©í•œ ì´ë¦„ localStorageì— ìë™ ì €ì¥
â€¢ í˜ì´ì§€ ì¬ì ‘ì† ì‹œ ë§ˆì§€ë§‰ ì´ë¦„ ìë™ ë¶ˆëŸ¬ì˜¤ê¸°
â€¢ ë°© ìƒì„± ì‹œ í˜¸ìŠ¤íŠ¸ ì´ë¦„ì€ ë³„ë„ë¡œ ì…ë ¥ (ì „ì—­ ì´ë¦„ê³¼ ë¶„ë¦¬)

<b>ğŸ‘‘ í˜¸ìŠ¤íŠ¸ ê¶Œí•œ ìë™ ì „ë‹¬ ì‹œìŠ¤í…œ</b>
â€¢ í˜¸ìŠ¤íŠ¸ê°€ ë‚˜ê°€ë„ ë°©ì´ ìë™ìœ¼ë¡œ ìœ ì§€ë¨
â€¢ ë‚¨ì€ ì‚¬ìš©ìê°€ ìˆìœ¼ë©´ ì²« ë²ˆì§¸ ì‚¬ìš©ìì—ê²Œ í˜¸ìŠ¤íŠ¸ ê¶Œí•œ ìë™ ì „ë‹¬
â€¢ í˜¸ìŠ¤íŠ¸ ê¶Œí•œ ì „ë‹¬ ì‹œ ìƒˆ í˜¸ìŠ¤íŠ¸ì—ê²Œ ìë™ ì•Œë¦¼
â€¢ í˜¸ìŠ¤íŠ¸ UI (ë°°ì§€, ë²„íŠ¼) ìë™ ì—…ë°ì´íŠ¸
â€¢ ëª¨ë“  ì‚¬ìš©ì ë‚˜ê°€ë©´ ë°© ìë™ ì‚­ì œ

<b>ğŸšª ë°© ì…ì¥ UX ê°œì„ </b>
â€¢ ë°© ëª©ë¡ì—ì„œ ì…ì¥í•˜ê¸° ë²„íŠ¼ í´ë¦­ë§Œìœ¼ë¡œ ì¦‰ì‹œ ì…ì¥
â€¢ ë³„ë„ ì…ì¥ í™•ì¸ ë‹¨ê³„ ì œê±°ë¡œ ë” ë¹ ë¥¸ ì…ì¥
â€¢ ì „ì—­ ì´ë¦„ìœ¼ë¡œ ìë™ ì…ì¥ (ë§¤ë²ˆ ì´ë¦„ ì…ë ¥ ë¶ˆí•„ìš”)

<b>âœ… ë°© ì‹œìŠ¤í…œ</b>
â€¢ ì—¬ëŸ¬ ë°© ìƒì„± ë° ì…ì¥ ê¸°ëŠ¥
â€¢ ë°© ëª©ë¡ì—ì„œ ì‹¤ì‹œê°„ ìƒíƒœ í™•ì¸ (ëŒ€ê¸° ì¤‘/ê²Œì„ ì§„í–‰ ì¤‘/ì£¼ë¬¸ë°›ê¸° ì¤‘)
â€¢ ë‚´ê°€ ì°¸ì—¬ ì¤‘ì¸ ë°© í‘œì‹œ
â€¢ ë°© ëª©ë¡ ì‹¤ì‹œê°„ ìƒˆë¡œê³ ì¹¨

<b>âœ… ì¤€ë¹„ ì‹œìŠ¤í…œ</b>
â€¢ ê²Œì„ ì‹œì‘ ì „ ì¤€ë¹„ ë²„íŠ¼ìœ¼ë¡œ ì°¸ì—¬ì ì„ íƒ
â€¢ ì¤€ë¹„í•œ ì‚¬ëŒë§Œ ê²Œì„ì— ì°¸ì—¬
â€¢ ì¤€ë¹„ ëª©ë¡ ì‹¤ì‹œê°„ í‘œì‹œ

<b>âœ… ì±„íŒ… ê¸°ëŠ¥</b>
â€¢ ë°© ë‚´ë¶€ì—ì„œ ì‹¤ì‹œê°„ ì±„íŒ… ê°€ëŠ¥
â€¢ í˜¸ìŠ¤íŠ¸ êµ¬ë¶„ í‘œì‹œ (ğŸ‘‘)
â€¢ Enter í‚¤ë¡œ ë¹ ë¥¸ ì „ì†¡

<b>âœ… ë°© ê´€ë¦¬ ê¸°ëŠ¥</b>
â€¢ í˜¸ìŠ¤íŠ¸ê°€ ë°© ì œëª© ë³€ê²½ ê°€ëŠ¥
â€¢ ì´ì „ ê²Œì„ ë°ì´í„° ì‚­ì œ ê¸°ëŠ¥

<b>âœ… ì£¼ë¬¸ë°›ê¸° ì‹œìŠ¤í…œ</b>
â€¢ ê²Œì„ ì¢…ë£Œ í›„ ì£¼ë¬¸ë°›ê¸° ê¸°ëŠ¥
â€¢ ìì£¼ ì“°ëŠ” ë©”ë‰´ ìë™ì™„ì„±
â€¢ ë©”ë‰´ë³„ ê·¸ë£¹í™” ë° ì •ë ¬
                </div>
            </div>
        </div>

        <!-- ë°© ìƒì„± í˜ì´ì§€ -->
        <div class="create-room-section" id="createRoomSection">
            <div style="margin-bottom: 20px;">
                <button onclick="goBackToLobby()" style="width: auto; padding: 10px 20px; margin-bottom: 15px; background: #6c757d;">â† ëŒ€ê¸°ì‹¤ë¡œ ëŒì•„ê°€ê¸°</button>
                <h2 style="margin-bottom: 20px; color: #667eea;">ë°© ë§Œë“¤ê¸°</h2>
            </div>
            
            <!-- ë¡œê³  ë° ì—°ê²° ìƒíƒœ -->
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="display: inline-flex; align-items: center; gap: 10px;">
                    <span style="font-size: 24px;">ğŸ²</span>
                    <span style="font-size: 20px; font-weight: 600; color: #667eea;">LAM Dice :)</span>
                    <span class="connection-status connected" id="createRoomConnectionStatus">â— ì—°ê²°ë¨</span>
                </div>
            </div>
            
            <!-- ë°© ì œëª© ì…ë ¥ -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #667eea;">
                <div class="input-group" style="margin-bottom: 0;">
                    <label for="createRoomNameInput">ë°© ì œëª©</label>
                    <input type="text" id="createRoomNameInput" placeholder="ë°© ì œëª© ì…ë ¥" maxlength="30" />
                </div>
            </div>
            
            <!-- í˜¸ìŠ¤íŠ¸ ì´ë¦„ ì…ë ¥ (ë°© ìƒì„± ì‹œì—ë§Œ ì‚¬ìš©) -->
            <div class="input-group" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #667eea;">
                <label for="createRoomHostNameInput">í˜¸ìŠ¤íŠ¸ ì´ë¦„</label>
                <input type="text" id="createRoomHostNameInput" placeholder="í˜¸ìŠ¤íŠ¸ ì´ë¦„ ì…ë ¥" maxlength="20" />
            </div>
            
            <!-- ë°© ìƒì„±í•˜ê¸° ë²„íŠ¼ (ë§¨ ì•„ë˜) -->
            <button onclick="finalizeRoomCreation()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin-top: 30px; width: 100%;">ë°© ìƒì„±í•˜ê¸°</button>
        </div>

        <!-- ê²Œì„ ì„¹ì…˜ -->
        <div class="game-section" id="gameSection">
            <div class="user-info">
                <div>
                    <span class="user-name" id="currentUser"></span>
                    <span class="host-badge" id="hostBadge" style="display: none;">HOST</span>
                </div>
                <span class="connection-status connected" id="connectionStatus">â— ì—°ê²°ë¨</span>
            </div>
            
            <!-- ë°© ì •ë³´ -->
            <div class="room-info-section" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #667eea;">
                <div id="roomNameDisplay" style="font-size: 18px; font-weight: 600; color: #667eea; margin-bottom: 10px;">
                    <span id="roomNameText">ë°© ì œëª©</span>
                </div>
                <div id="roomNameEditSection" style="display: none;">
                    <div class="input-group" style="margin-bottom: 10px;">
                        <input type="text" id="roomNameInput" placeholder="ë°© ì œëª© ì…ë ¥" maxlength="30" />
                    </div>
                    <button onclick="saveRoomName()" style="width: auto; padding: 8px 16px; margin-right: 10px;">ì €ì¥</button>
                    <button onclick="cancelRoomNameEdit()" style="width: auto; padding: 8px 16px; background: #6c757d;">ì·¨ì†Œ</button>
                </div>
                <button id="editRoomNameButton" onclick="editRoomName()" style="width: auto; padding: 8px 16px; font-size: 14px; display: none;">ë°© ì œëª© ë³€ê²½</button>
            </div>

            <!-- ì¬ì ‘ì† ì•Œë¦¼ -->
            <div class="reconnect-notice" id="reconnectNotice" style="display: none;">
                <strong>ğŸ”„ ì¬ì ‘ì†í•˜ì…¨ìŠµë‹ˆë‹¤!</strong>
                <p id="reconnectMessage"></p>
            </div>

            <!-- ê°œì¸ ì£¼ì‚¬ìœ„ ì„¤ì • (ìµœì†Œê°’ 1 ê³ ì •) -->
            <div class="dice-settings">
                <div class="dice-settings-title">ğŸ¯ ë‚´ ì£¼ì‚¬ìœ„ ë²”ìœ„ ì„¤ì • (1 ~ ìµœëŒ€ê°’)</div>
                <div class="dice-range-inputs">
                    <div class="input-group" style="margin: 0;">
                        <label for="diceMax">ìµœëŒ€ê°’</label>
                        <input type="number" id="diceMax" value="100" min="2" max="100000" />
                    </div>
                    <button onclick="updateMyDiceSettings()" style="width: auto; padding: 12px 20px;">ì„¤ì •</button>
                </div>
                <div style="margin-top: 8px; font-size: 14px; color: #1976d2; font-weight: 600;">
                    í˜„ì¬ ë²”ìœ„: <span id="currentMyRange">1 ~ 100</span>
                </div>
            </div>

            <!-- ê²Œì„ ë£° ì„¹ì…˜ (í˜¸ìŠ¤íŠ¸ë§Œ ìˆ˜ì • ê°€ëŠ¥) -->
            <div class="game-rules-section" id="gameRulesSection" style="display: none;">
                <div class="dice-settings-title">ğŸ“‹ ê²Œì„ ë£°</div>
                <div class="input-group">
                    <textarea 
                        id="gameRulesInput" 
                        placeholder="ê²Œì„ ë£°ì„ ì…ë ¥í•˜ì„¸ìš” (ê²Œì„ ì‹œì‘ ì´í›„ ì„¤ì • ê°€ëŠ¥))"
                        maxlength="500"
                        rows="3"
                        disabled
                    ></textarea>
                </div>
                <button onclick="updateGameRules()" id="gameRulesSaveButton" style="width: auto; padding: 12px 20px;" disabled>ì €ì¥</button>
                <div style="margin-top: 8px; font-size: 12px; color: #999;">
                    ê²Œì„ ì‹œì‘ í›„ ìˆ˜ì • ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤
                </div>
            </div>

            <!-- ì ‘ì†ì ë¦¬ìŠ¤íŠ¸ -->
            <div class="users-section">
                <div class="users-title">ğŸ‘¥ ì ‘ì†ì (<span id="userCount">0</span>ëª…)</div>
                <div class="users-list" id="usersList">
                    <div style="color: #999; text-align: center; padding: 10px; width: 100%;">ì ‘ì†ìê°€ ì—†ìŠµë‹ˆë‹¤</div>
                </div>
            </div>
            
            <!-- ì¤€ë¹„ ìƒíƒœ -->
            <div class="ready-section" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #667eea; display: none;" id="readySection">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="users-title" style="margin: 0;">âœ… ì¤€ë¹„í•œ ì‚¬ëŒ (<span id="readyCount">0</span>ëª…)</div>
                    <button id="readyButton" onclick="toggleReady()" style="width: auto; padding: 10px 20px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">ì¤€ë¹„</button>
                </div>
                <div class="users-list" id="readyUsersList" style="min-height: 50px;">
                    <div style="color: #999; text-align: center; padding: 10px; width: 100%;">ì•„ì§ ì¤€ë¹„í•œ ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤</div>
                </div>
            </div>

            <div class="game-status waiting" id="gameStatus">
                ê²Œì„ ëŒ€ê¸° ì¤‘...
            </div>

            <!-- ì§„í–‰ ìƒí™© í‘œì‹œ -->
            <div class="progress-section" id="progressSection" style="display: none;">
                <div class="progress-title">ğŸ“Š ì§„í–‰ ìƒí™©</div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="progress-text">
                    <span id="progressCount">0/0</span> ëª… ì™„ë£Œ
                </div>
                
                <div class="not-rolled-section">
                    <div class="not-rolled-title">â³ ì£¼ì‚¬ìœ„ë¥¼ êµ´ë¦¬ì§€ ì•Šì€ ì‚¬ëŒ</div>
                    <div class="not-rolled-list" id="notRolledList">
                        <!-- ë¯¸ì™„ë£Œì ëª©ë¡ -->
                    </div>
                </div>
            </div>

            <!-- Host ì „ìš© ì»¨íŠ¸ë¡¤ -->
            <div class="host-controls" id="hostControls" style="display: none;">
                <button onclick="startGame()" id="startButton">ê²Œì„ ì‹œì‘</button>
                <button onclick="endGame()" id="endButton" style="display: none;">ê²Œì„ ì¢…ë£Œ</button>
                <button onclick="startOrder()" id="startOrderButton" class="order-button" style="display: none;">ì£¼ë¬¸ë°›ê¸° ì‹œì‘</button>
                <button onclick="endOrder()" id="endOrderButton" class="order-button" style="display: none;">ì£¼ë¬¸ë°›ê¸° ì¢…ë£Œ</button>
                <button onclick="clearGameData()" id="clearDataButton" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">ì´ì „ ê²Œì„ ë°ì´í„° ì‚­ì œ</button>
            </div>

            <!-- ì£¼ì‚¬ìœ„ ì˜ì—­ -->
            <div class="dice-container">
                <div class="dice" id="dice">?</div>
            </div>

            <button class="roll-button" onclick="rollDice()" id="rollButton" disabled>
                ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸°
            </button>

            <!-- ì£¼ë¬¸ë°›ê¸° ì„¹ì…˜ -->
            <div class="orders-section" id="ordersSection">
                <div class="history-title-wrapper">
                    <div class="users-title">ğŸ” ì£¼ë¬¸ë°›ê¸°</div>
                    <div class="sort-buttons">
                        <button class="sort-button active" id="sortOrderAscBtn" onclick="sortOrders('asc')">ê°€ë‚˜ë‹¤ìˆœ</button>
                        <button class="sort-button" id="sortOrderDescBtn" onclick="sortOrders('desc')">ê°€ë‚˜ë‹¤ ì—­ìˆœ</button>
                    </div>
                </div>
                
                <!-- ë‚´ ì£¼ë¬¸ ì…ë ¥ -->
                <div class="my-order-box">
                    <div class="my-order-title">
                        <span>ğŸ“</span>
                        <span>ë‚´ ì£¼ë¬¸</span>
                        <button onclick="toggleMenuManager()" style="width: auto; padding: 6px 12px; font-size: 12px; margin-left: auto; background: #f8f9fa; color: #667eea; border: 1px solid #667eea;">ë©”ë‰´ ê´€ë¦¬</button>
                    </div>
                    
                    <!-- ìì£¼ ì“°ëŠ” ë©”ë‰´ ê´€ë¦¬ -->
                    <div class="menu-manager" id="menuManager">
                        <div class="menu-manager-title">
                            <span>ğŸ“‹ ìì£¼ ì“°ëŠ” ë©”ë‰´</span>
                            <button onclick="toggleMenuManager()" style="width: auto; padding: 4px 8px; font-size: 12px; background: #dc3545; color: white; border: none; border-radius: 4px;">ë‹«ê¸°</button>
                        </div>
                        <div class="menu-manager-input">
                            <input type="text" id="menuInput" placeholder="ë©”ë‰´ ì¶”ê°€ (ì˜ˆ: ì¹˜í‚¨)" maxlength="50" />
                            <button onclick="addMenu()" style="width: auto; padding: 12px 20px; height: fit-content;">ì¶”ê°€</button>
                        </div>
                        <div class="menu-list" id="menuList">
                            <!-- ë©”ë‰´ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </div>
                    </div>
                    
                    <div class="order-input-group">
                        <div class="order-input-wrapper">
                            <div class="autocomplete-suggestion" id="autocompleteSuggestion"></div>
                            <input 
                                type="text"
                                id="myOrderInput" 
                                placeholder="ì£¼ë¬¸í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì˜¤ì´ˆ, ì˜¤ê³ )"
                                maxlength="100"
                                disabled
                            />
                            <div class="autocomplete-dropdown" id="autocompleteDropdown" style="display: none;"></div>
                        </div>
                        <button onclick="updateMyOrder()" id="orderSaveButton" style="width: auto; padding: 12px 20px; height: fit-content;" disabled>ì €ì¥</button>
                    </div>
                </div>

                <!-- ì „ì²´ ì£¼ë¬¸ ëª©ë¡ -->
                <div class="order-list" id="orderList">
                    <div style="color: #999; text-align: center; padding: 10px;">ì•„ì§ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤</div>
                </div>

                <!-- ì£¼ë¬¸í•˜ì§€ ì•Šì€ ì‚¬ëŒ ëª©ë¡ -->
                <div class="not-ordered-section" id="notOrderedSection" style="display: none;">
                    <div class="not-rolled-title" style="margin-top: 15px;">â³ ì£¼ë¬¸í•˜ì§€ ì•Šì€ ì‚¬ëŒ</div>
                    <div class="not-rolled-list" id="notOrderedList">
                        <!-- ì£¼ë¬¸í•˜ì§€ ì•Šì€ ì‚¬ëŒ ëª©ë¡ -->
                    </div>
                </div>
            </div>

            <!-- ì±„íŒ… ì„¹ì…˜ -->
            <div class="chat-section" style="margin-bottom: 20px;">
                <div class="users-title" style="margin-bottom: 10px;">ğŸ’¬ ì±„íŒ… </div>
                <div class="chat-messages" id="chatMessages" style="background: #f8f9fa; border-radius: 8px; padding: 15px; max-height: 200px; overflow-y: auto; margin-bottom: 10px; border: 2px solid #667eea;">
                    <div style="color: #999; text-align: center; padding: 10px;">ì±„íŒ… ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px;">
                    <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ ì…ë ¥ (ìµœëŒ€ 200ì)" maxlength="200" style="padding: 10px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px;" />
                    <button onclick="sendChatMessage()" style="width: auto; padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">ì „ì†¡</button>
                </div>
            </div>

            <!-- ê¸°ë¡ ì„¹ì…˜ -->
            <div class="history-section">
                <div class="history-title-wrapper">
                    <div class="history-title">ğŸ“‹ ê²Œì„ ê¸°ë¡</div>
                    <div class="sort-buttons">
                        <button class="sort-button" id="sortTimeBtn" onclick="sortHistory('time')">ì‹œê°„ìˆœ</button>
                        <button class="sort-button" id="sortAscBtn" onclick="sortHistory('asc')">ì˜¤ë¦„ì°¨ìˆœ</button>
                        <button class="sort-button active" id="sortDescBtn" onclick="sortHistory('desc')">ë‚´ë¦¼ì°¨ìˆœ</button>
                    </div>
                </div>
                <div class="history-list" id="historyList">
                    <div class="empty-history">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>
                </div>
            </div>

            <button class="logout-button" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        
        let currentUser = '';
        let isHost = false;
        let isGameActive = false;
        let isOrderActive = false;
        let diceMax = 100;
        let myDiceSettings = { max: 100 };
        let hasRolledInCurrentGame = false;
        let historyData = [];
        let currentSortMode = 'desc';
        let ordersData = {};
        let currentOrderSortMode = 'asc'; // ì£¼ë¬¸ ì •ë ¬ ëª¨ë“œ: 'asc' (ê°€ë‚˜ë‹¤ìˆœ), 'desc' (ê°€ë‚˜ë‹¤ ì—­ìˆœ)
        let usersList = []; // ì ‘ì†ì ëª©ë¡
        let frequentMenus = []; // ìì£¼ ì“°ëŠ” ë©”ë‰´ ëª©ë¡
        let readyUsers = []; // ì¤€ë¹„í•œ ì‚¬ìš©ì ëª©ë¡
        let isReady = false; // ë‚´ ì¤€ë¹„ ìƒíƒœ
        let currentSuggestions = []; // í˜„ì¬ ìë™ì™„ì„± ì œì•ˆ ëª©ë¡
        let selectedSuggestionIndex = -1; // ì„ íƒëœ ì œì•ˆ ì¸ë±ìŠ¤
        
        // ì„œë²„ì—ì„œ ìì£¼ ì“°ëŠ” ë©”ë‰´ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadFrequentMenus() {
            socket.emit('getFrequentMenus');
        }
        
        // ì„œë²„ì—ì„œ ë©”ë‰´ ëª©ë¡ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ 
        socket.on('frequentMenusUpdated', (menus) => {
            frequentMenus = menus;
            renderMenuList();
        });
        
        // ë©”ë‰´ ê´€ë¦¬ UI í† ê¸€
        function toggleMenuManager() {
            const menuManager = document.getElementById('menuManager');
            menuManager.classList.toggle('active');
        }
        
        // ë©”ë‰´ ì¶”ê°€
        function addMenu() {
            const menuInput = document.getElementById('menuInput');
            const menu = menuInput.value.trim();
            
            if (menu === '') {
                alert('ë©”ë‰´ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }
            
            // ì„œë²„ì— ë©”ë‰´ ì¶”ê°€ ìš”ì²­
            socket.emit('addFrequentMenu', { menu: menu });
            menuInput.value = '';
        }
        
        // ë©”ë‰´ ì…ë ¥ í•„ë“œì—ì„œ Enter í‚¤ë¡œ ì¶”ê°€
        document.addEventListener('DOMContentLoaded', () => {
            const menuInput = document.getElementById('menuInput');
            if (menuInput) {
                menuInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addMenu();
                    }
                });
            }
        });
        
        // ë©”ë‰´ ì‚­ì œ
        function deleteMenu(menu) {
            // ì„œë²„ì— ë©”ë‰´ ì‚­ì œ ìš”ì²­
            socket.emit('deleteFrequentMenu', { menu: menu });
        }
        
        // ë©”ë‰´ ì—ëŸ¬ ì²˜ë¦¬
        socket.on('menuError', (message) => {
            alert(message);
        });
        
        // ë©”ë‰´ ëª©ë¡ ë Œë”ë§
        function renderMenuList() {
            const menuList = document.getElementById('menuList');
            
            if (frequentMenus.length === 0) {
                menuList.innerHTML = '<div style="color: #999; text-align: center; padding: 10px;">ë“±ë¡ëœ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }
            
            menuList.innerHTML = '';
            frequentMenus.forEach(menu => {
                const tag = document.createElement('span');
                tag.className = 'menu-tag';
                tag.innerHTML = `${menu}<span class="delete-btn" onclick="deleteMenu('${menu}')">Ã—</span>`;
                menuList.appendChild(tag);
            });
        }
        
        // ìë™ì™„ì„± ì œì•ˆ ì°¾ê¸° (ëª¨ë“  ì¼ì¹˜ í•­ëª©)
        function findAutocompleteSuggestions(text) {
            if (!text || text.trim() === '') {
                return [];
            }
            
            const lowerText = text.toLowerCase();
            const suggestions = [];
            
            // ë©”ë‰´ ëª©ë¡ì—ì„œ ì¼ì¹˜í•˜ëŠ” ëª¨ë“  í•­ëª© ì°¾ê¸°
            for (const menu of frequentMenus) {
                if (menu.toLowerCase().startsWith(lowerText)) {
                    // ì´ë¯¸ ì™„ì „íˆ ì…ë ¥í•œ ê²½ìš°ëŠ” ì œì•ˆí•˜ì§€ ì•ŠìŒ
                    if (menu.toLowerCase() !== lowerText) {
                        suggestions.push(menu);
                    }
                }
            }
            
            return suggestions;
        }
        
        // ìë™ì™„ì„± ì œì•ˆ ì—…ë°ì´íŠ¸
        function updateAutocompleteSuggestion() {
            const orderInput = document.getElementById('myOrderInput');
            const suggestionDiv = document.getElementById('autocompleteSuggestion');
            const dropdownDiv = document.getElementById('autocompleteDropdown');
            const text = orderInput.value;
            
            currentSuggestions = findAutocompleteSuggestions(text);
            selectedSuggestionIndex = -1;
            
            if (currentSuggestions.length > 0) {
                // ì²« ë²ˆì§¸ ì œì•ˆì„ íšŒìƒ‰ í…ìŠ¤íŠ¸ë¡œ í‘œì‹œ
                const firstSuggestion = currentSuggestions[0];
                const remainingText = firstSuggestion.substring(text.length);
                suggestionDiv.textContent = text + remainingText;
                suggestionDiv.style.display = 'block';
                
                // ì—¬ëŸ¬ ê°œì˜ ì œì•ˆì´ ìˆìœ¼ë©´ ë“œë¡­ë‹¤ìš´ í‘œì‹œ
                if (currentSuggestions.length > 1) {
                    renderAutocompleteDropdown();
                    dropdownDiv.style.display = 'block';
                } else {
                    dropdownDiv.style.display = 'none';
                }
            } else {
                suggestionDiv.textContent = '';
                suggestionDiv.style.display = 'none';
                dropdownDiv.style.display = 'none';
            }
        }
        
        // ìë™ì™„ì„± ë“œë¡­ë‹¤ìš´ ë Œë”ë§
        function renderAutocompleteDropdown() {
            const dropdownDiv = document.getElementById('autocompleteDropdown');
            const orderInput = document.getElementById('myOrderInput');
            const text = orderInput.value;
            
            dropdownDiv.innerHTML = '';
            
            currentSuggestions.forEach((menu, index) => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item' + (index === selectedSuggestionIndex ? ' selected' : '');
                item.textContent = menu;
                
                // ì…ë ¥ëœ ë¶€ë¶„ ê°•ì¡°
                const prefix = document.createElement('strong');
                prefix.textContent = menu.substring(0, text.length);
                const suffix = document.createElement('span');
                suffix.textContent = menu.substring(text.length);
                
                item.innerHTML = '';
                item.appendChild(prefix);
                item.appendChild(suffix);
                
                item.addEventListener('click', () => {
                    applySuggestion(menu);
                });
                
                dropdownDiv.appendChild(item);
            });
        }
        
        // ì œì•ˆ ì ìš©
        function applySuggestion(menu) {
            const orderInput = document.getElementById('myOrderInput');
            orderInput.value = menu;
            currentSuggestions = [];
            selectedSuggestionIndex = -1;
            document.getElementById('autocompleteSuggestion').style.display = 'none';
            document.getElementById('autocompleteDropdown').style.display = 'none';
            orderInput.focus();
        }
        
        // Tab í‚¤ë¡œ ìë™ì™„ì„± ì ìš©
        function setupAutocomplete() {
            const orderInput = document.getElementById('myOrderInput');
            const dropdownDiv = document.getElementById('autocompleteDropdown');
            
            orderInput.addEventListener('input', () => {
                updateAutocompleteSuggestion();
            });
            
            orderInput.addEventListener('keydown', (e) => {
                // Enter í‚¤ ì²˜ë¦¬
                if (e.key === 'Enter') {
                    // ìë™ì™„ì„± ë“œë¡­ë‹¤ìš´ì´ ì—´ë ¤ìˆìœ¼ë©´ ìë™ì™„ì„± ì ìš©
                    if (currentSuggestions.length > 0) {
                        e.preventDefault();
                        const menuToApply = selectedSuggestionIndex >= 0 
                            ? currentSuggestions[selectedSuggestionIndex] 
                            : currentSuggestions[0];
                        applySuggestion(menuToApply);
                        return;
                    }
                    // ë“œë¡­ë‹¤ìš´ì´ ì—†ìœ¼ë©´ ì£¼ë¬¸ ì €ì¥
                    e.preventDefault();
                    updateMyOrder();
                    return;
                }
                
                // Tabìœ¼ë¡œ ìë™ì™„ì„± ì ìš©
                if (e.key === 'Tab' && currentSuggestions.length > 0) {
                    e.preventDefault();
                    const menuToApply = selectedSuggestionIndex >= 0 
                        ? currentSuggestions[selectedSuggestionIndex] 
                        : currentSuggestions[0];
                    applySuggestion(menuToApply);
                    return;
                }
                
                // ë°©í–¥í‚¤ë¡œ ì œì•ˆ ì„ íƒ
                if (e.key === 'ArrowDown' && currentSuggestions.length > 0) {
                    e.preventDefault();
                    selectedSuggestionIndex = (selectedSuggestionIndex + 1) % currentSuggestions.length;
                    renderAutocompleteDropdown();
                    updateSuggestionDisplay();
                    return;
                }
                
                if (e.key === 'ArrowUp' && currentSuggestions.length > 0) {
                    e.preventDefault();
                    selectedSuggestionIndex = selectedSuggestionIndex <= 0 
                        ? currentSuggestions.length - 1 
                        : selectedSuggestionIndex - 1;
                    renderAutocompleteDropdown();
                    updateSuggestionDisplay();
                    return;
                }
                
                // Escapeë¡œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
                if (e.key === 'Escape') {
                    currentSuggestions = [];
                    selectedSuggestionIndex = -1;
                    dropdownDiv.style.display = 'none';
                    document.getElementById('autocompleteSuggestion').style.display = 'none';
                    return;
                }
            });
            
            // í¬ì»¤ìŠ¤ ìƒì„ ë•Œ ì œì•ˆ ìˆ¨ê¸°ê¸°
            orderInput.addEventListener('blur', () => {
                setTimeout(() => {
                    document.getElementById('autocompleteSuggestion').style.display = 'none';
                    dropdownDiv.style.display = 'none';
                }, 200);
            });
            
            // í¬ì»¤ìŠ¤ ë°›ì„ ë•Œ ì œì•ˆ ì—…ë°ì´íŠ¸
            orderInput.addEventListener('focus', () => {
                updateAutocompleteSuggestion();
            });
        }
        
        // ì„ íƒëœ ì œì•ˆì— ë§ê²Œ íšŒìƒ‰ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        function updateSuggestionDisplay() {
            const suggestionDiv = document.getElementById('autocompleteSuggestion');
            const orderInput = document.getElementById('myOrderInput');
            const text = orderInput.value;
            
            if (selectedSuggestionIndex >= 0 && currentSuggestions[selectedSuggestionIndex]) {
                const selectedMenu = currentSuggestions[selectedSuggestionIndex];
                const remainingText = selectedMenu.substring(text.length);
                suggestionDiv.textContent = text + remainingText;
                suggestionDiv.style.display = 'block';
            } else if (currentSuggestions.length > 0) {
                const firstMenu = currentSuggestions[0];
                const remainingText = firstMenu.substring(text.length);
                suggestionDiv.textContent = text + remainingText;
                suggestionDiv.style.display = 'block';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        let currentRoomId = null;
        let selectedRoomId = null;
        let roomsList = [];
        
        // ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§ ë° ì´ˆê¸°í™”
        socket.on('connect', () => {
            document.getElementById('connectionStatus').textContent = 'â— ì—°ê²°ë¨';
            document.getElementById('connectionStatus').className = 'connection-status connected';
            
            const createRoomConnectionStatus = document.getElementById('createRoomConnectionStatus');
            if (createRoomConnectionStatus) {
                createRoomConnectionStatus.textContent = 'â— ì—°ê²°ë¨';
                createRoomConnectionStatus.className = 'connection-status connected';
            }
            
            // ë°© ëª©ë¡ ìš”ì²­
            if (document.getElementById('lobbySection').classList.contains('active')) {
                refreshRooms();
            }
        });

        socket.on('disconnect', () => {
            document.getElementById('connectionStatus').textContent = 'â— ì—°ê²° ëŠê¹€';
            document.getElementById('connectionStatus').className = 'connection-status disconnected';
            
            const createRoomConnectionStatus = document.getElementById('createRoomConnectionStatus');
            if (createRoomConnectionStatus) {
                createRoomConnectionStatus.textContent = 'â— ì—°ê²° ëŠê¹€';
                createRoomConnectionStatus.className = 'connection-status disconnected';
            }
        });

        // ë°© ëª©ë¡ ì—…ë°ì´íŠ¸
        socket.on('roomsList', (rooms) => {
            roomsList = rooms;
            renderRoomsList();
        });
        
        socket.on('roomsListUpdated', (rooms) => {
            roomsList = rooms;
            renderRoomsList();
        });
        
        // ë°© ëª©ë¡ ë Œë”ë§
        function renderRoomsList() {
            const roomsListEl = document.getElementById('roomsList');
            
            if (roomsList.length === 0) {
                roomsListEl.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">ìƒì„±ëœ ë°©ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }
            
            roomsListEl.innerHTML = '';
            
            roomsList.forEach(room => {
                const roomItem = document.createElement('div');
                const isMyRoom = room.roomId === currentRoomId;
                let className = 'room-item';
                if (isMyRoom) {
                    className += ' my-room';
                } else if (room.roomId === selectedRoomId) {
                    className += ' active';
                }
                roomItem.className = className;
                
                let statusClass = 'waiting';
                let statusText = 'ëŒ€ê¸° ì¤‘';
                if (room.isGameActive) {
                    statusClass = 'playing';
                    statusText = 'ê²Œì„ ì§„í–‰ ì¤‘';
                } else if (room.isOrderActive) {
                    statusClass = 'ordering';
                    statusText = 'ì£¼ë¬¸ë°›ê¸° ì¤‘';
                }
                
                const roomNameHtml = isMyRoom 
                    ? `${room.roomName}<span class="my-room-badge">ì°¸ì—¬ ì¤‘</span>`
                    : room.roomName;
                
                const buttonText = isMyRoom ? 'ì¬ì…ì¥' : 'ì…ì¥í•˜ê¸°';
                
                roomItem.innerHTML = `
                    <div class="room-info">
                        <div class="room-name">${roomNameHtml}</div>
                        <div class="room-details">
                            í˜¸ìŠ¤íŠ¸: ${room.hostName} | ì¸ì›: ${room.playerCount}ëª…
                        </div>
                        <span class="room-status ${statusClass}">${statusText}</span>
                    </div>
                    <div class="room-action">
                        <button onclick="joinRoomDirectly('${room.roomId}')">${buttonText}</button>
                    </div>
                `;
                
                roomsListEl.appendChild(roomItem);
            });
        }
        
        // ë°© ë°”ë¡œ ì…ì¥
        function joinRoomDirectly(roomId) {
            selectedRoomId = roomId;
            
            const globalNameInput = document.getElementById('globalUserNameInput');
            const userName = globalNameInput ? globalNameInput.value.trim() : '';
            
            if (userName === '') {
                alert('âš ï¸ ì´ë¦„ì„ ì…ë ¥í•´ì•¼ ì…ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                if (globalNameInput) {
                    globalNameInput.focus();
                }
                return;
            }
            
            // ê¸°ì¡´ ë°©ì— ì…ì¥í•  ë•ŒëŠ” í•­ìƒ ì¼ë°˜ ì‚¬ìš©ìë¡œ ì…ì¥ (í˜¸ìŠ¤íŠ¸ëŠ” ë°© ìƒì„± ì‹œì—ë§Œ ì„¤ì •)
            socket.emit('joinRoom', {
                roomId: roomId,
                userName: userName,
                isHost: false
            });
        }
        
        // ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        function refreshRooms() {
            socket.emit('getRooms');
        }
        
        // ë°© ìƒì„± í˜ì´ì§€ë¡œ ì´ë™
        function showCreateRoomPage() {
            document.getElementById('lobbySection').classList.remove('active');
            document.getElementById('createRoomSection').classList.add('active');
            
            // ê¸°ë³¸ê°’ ì„¤ì •
            document.getElementById('createRoomNameInput').value = '';
            document.getElementById('createRoomHostNameInput').value = '';
            
            // ì „ì—­ ì´ë¦„ ì…ë ¥ê°’ì„ ê°€ì ¸ì™€ì„œ í˜¸ìŠ¤íŠ¸ ì´ë¦„ ì…ë ¥ì¹¸ì— ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì • (ìˆìœ¼ë©´)
            const globalNameInput = document.getElementById('globalUserNameInput');
            if (globalNameInput && globalNameInput.value.trim()) {
                const hostName = globalNameInput.value.trim();
                document.getElementById('createRoomHostNameInput').value = hostName;
                // ë°© ì œëª© ìë™ ìƒì„±
                document.getElementById('createRoomNameInput').value = `${hostName}ë‹˜ì˜ Dice`;
            }
            
            // í˜¸ìŠ¤íŠ¸ ì´ë¦„ ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
            setTimeout(() => {
                document.getElementById('createRoomHostNameInput').focus();
            }, 100);
        }
        
        // ëŒ€ê¸°ì‹¤ë¡œ ëŒì•„ê°€ê¸°
        function goBackToLobby() {
            document.getElementById('createRoomSection').classList.remove('active');
            document.getElementById('lobbySection').classList.add('active');
        }
        
        // ë°© ìƒì„± ìµœì¢… í™•ì¸ ë° ìƒì„±
        function finalizeRoomCreation() {
            const hostNameInput = document.getElementById('createRoomHostNameInput');
            const roomNameInput = document.getElementById('createRoomNameInput');
            
            const hostName = hostNameInput.value.trim();
            const roomName = roomNameInput.value.trim();
            
            if (roomName === '') {
                alert('âš ï¸ ë°© ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                roomNameInput.focus();
                return;
            }
            
            if (hostName === '') {
                alert('âš ï¸ í˜¸ìŠ¤íŠ¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                hostNameInput.focus();
                return;
            }
            
            // ë°© ìƒì„± (ì£¼ì‚¬ìœ„ ë²”ìœ„ì™€ ê²Œì„ ë£°ì€ ë°© ìƒì„± í›„ ì„¤ì •)
            socket.emit('createRoom', { 
                userName: hostName,
                roomName: roomName
            });
        }
        
        // ë°© ì…ì¥
        function joinSelectedRoom() {
            if (!selectedRoomId) {
                alert('ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }
            
            const globalNameInput = document.getElementById('globalUserNameInput');
            const userName = globalNameInput.value.trim();
            
            if (userName === '') {
                alert('âš ï¸ ì´ë¦„ì„ ì…ë ¥í•´ì•¼ ì…ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                globalNameInput.focus();
                return;
            }
            
            // ê¸°ì¡´ ë°©ì— ì…ì¥í•  ë•ŒëŠ” í•­ìƒ ì¼ë°˜ ì‚¬ìš©ìë¡œ ì…ì¥ (í˜¸ìŠ¤íŠ¸ëŠ” ë°© ìƒì„± ì‹œì—ë§Œ ì„¤ì •)
            socket.emit('joinRoom', {
                roomId: selectedRoomId,
                userName: userName,
                isHost: false
            });
        }
        
        // ì „ì—­ ì´ë¦„ ì…ë ¥ì°½ ì´ˆê¸°í™” (localStorageì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°)
        document.addEventListener('DOMContentLoaded', () => {
            const globalNameInput = document.getElementById('globalUserNameInput');
            if (globalNameInput) {
                // localStorageì—ì„œ ì´ë¦„ ë¶ˆëŸ¬ì˜¤ê¸°
                const savedName = localStorage.getItem('diceGameUserName');
                if (savedName) {
                    globalNameInput.value = savedName;
                }
                
                // ì´ë¦„ì´ ë³€ê²½ë  ë•Œë§ˆë‹¤ localStorageì— ì €ì¥
                globalNameInput.addEventListener('input', () => {
                    const userName = globalNameInput.value.trim();
                    if (userName) {
                        localStorage.setItem('diceGameUserName', userName);
                    }
                });
            }
            
            // í˜¸ìŠ¤íŠ¸ ì´ë¦„ ì…ë ¥ì°½ì—ì„œ ë°© ì œëª© ìë™ ì—…ë°ì´íŠ¸
            const hostNameInput = document.getElementById('createRoomHostNameInput');
            const roomNameInput = document.getElementById('createRoomNameInput');
            if (hostNameInput && roomNameInput) {
                let isUpdating = false;
                hostNameInput.addEventListener('input', () => {
                    if (isUpdating) return;
                    const hostName = hostNameInput.value.trim();
                    // ë°© ì œëª©ì´ ê¸°ë³¸ í˜•ì‹ì´ê±°ë‚˜ ë¹„ì–´ìˆì„ ë•Œë§Œ ìë™ ì—…ë°ì´íŠ¸
                    const currentRoomName = roomNameInput.value.trim();
                    if (!currentRoomName || currentRoomName.endsWith('ë‹˜ì˜ Dice')) {
                        isUpdating = true;
                        roomNameInput.value = hostName ? `${hostName}ë‹˜ì˜ Dice` : '';
                        isUpdating = false;
                    }
                });
            }
        });
        
        // ë°© ìƒì„± ì„±ê³µ
        socket.on('roomCreated', (data) => {
            currentRoomId = data.roomId;
            // ë°© ìƒì„± ì‹œ ì…ë ¥í•œ í˜¸ìŠ¤íŠ¸ ì´ë¦„ ì‚¬ìš©
            const hostNameInput = document.getElementById('createRoomHostNameInput');
            currentUser = hostNameInput ? hostNameInput.value.trim() : data.userName;
            isHost = true;
            
            document.getElementById('lobbySection').classList.remove('active');
            document.getElementById('createRoomSection').classList.remove('active');
            document.getElementById('gameSection').classList.add('active');
            
            initializeGameScreen(data);
        });
        
        // ë°© ì…ì¥ ì„±ê³µ
        socket.on('roomJoined', (data) => {
            currentRoomId = data.roomId;
            const globalNameInput = document.getElementById('globalUserNameInput');
            currentUser = globalNameInput ? globalNameInput.value.trim() : data.userName; // ì „ì—­ ì´ë¦„ ì‚¬ìš©
            isHost = data.isHost;
            
            document.getElementById('lobbySection').classList.remove('active');
            document.getElementById('gameSection').classList.add('active');
            
            initializeGameScreen(data);
        });
        
        // ê²Œì„ í™”ë©´ ì´ˆê¸°í™”
        function initializeGameScreen(data) {
            hasRolledInCurrentGame = data.hasRolled;
            myDiceSettings = data.diceSettings || { max: 100 };
            isGameActive = data.isGameActive;
            isOrderActive = data.isOrderActive;
            
            // ë°© ì œëª© í‘œì‹œ
            document.getElementById('roomNameText').textContent = data.roomName || 'ë°©';
            
            // í˜¸ìŠ¤íŠ¸ë©´ ë°© ì œëª© ë³€ê²½ ë²„íŠ¼ í‘œì‹œ
            if (isHost) {
                document.getElementById('editRoomNameButton').style.display = 'inline-block';
            } else {
                document.getElementById('editRoomNameButton').style.display = 'none';
            }
            
            document.getElementById('currentUser').textContent = currentUser;
            
            // ë‚´ ì£¼ì‚¬ìœ„ ì„¤ì • ì ìš©
            document.getElementById('diceMax').value = myDiceSettings.max;
            document.getElementById('currentMyRange').textContent = `1 ~ ${myDiceSettings.max}`;

            // ë‚´ ì£¼ë¬¸ ë¶ˆëŸ¬ì˜¤ê¸°
            document.getElementById('myOrderInput').value = data.myOrder || '';

            if (isHost) {
                document.getElementById('hostBadge').style.display = 'inline-block';
                document.getElementById('hostControls').style.display = 'grid';
            }
            
            // ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ê²Œì„ ë£° ì„¹ì…˜ í‘œì‹œ (ì½ê¸° ì „ìš©)
            document.getElementById('gameRulesSection').style.display = 'block';
            
            // ê²Œì„ ë£° ë¶ˆëŸ¬ì˜¤ê¸°
            if (data.gameRules !== undefined) {
                document.getElementById('gameRulesInput').value = data.gameRules || '';
                updateGameRulesUI();
            }
            
            // ìì£¼ ì“°ëŠ” ë©”ë‰´ ë¶ˆëŸ¬ì˜¤ê¸°
            if (data.frequentMenus !== undefined) {
                frequentMenus = data.frequentMenus;
                renderMenuList();
            } else {
                loadFrequentMenus();
            }
            
            // ì¤€ë¹„ ìƒíƒœ ì´ˆê¸°í™”
            readyUsers = data.readyUsers || [];
            isReady = data.isReady || false;
            renderReadyUsers();
            updateReadyButton();
            
            // ê²Œì„ì´ ì‹œì‘ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì¤€ë¹„ ì„¹ì…˜ í‘œì‹œ
            if (!isGameActive) {
                document.getElementById('readySection').style.display = 'block';
            } else {
                document.getElementById('readySection').style.display = 'none';
            }
            
            // ê²Œì„ ìƒíƒœ ë°˜ì˜
            if (data.gameState) {
                historyData = data.gameState.history || [];
                ordersData = data.gameState.userOrders || {};
                usersList = data.gameState.users || [];
                renderHistory();
                renderOrders();
                updateUsers(usersList);
            }
            
            // ì£¼ë¬¸ë°›ê¸°ê°€ í™œì„±í™”ëœ ìƒíƒœë©´ ì£¼ë¬¸í•˜ì§€ ì•Šì€ ì‚¬ëŒ ëª©ë¡ë„ í‘œì‹œ
            if (isOrderActive) {
                setTimeout(() => {
                    renderNotOrderedUsers();
                }, 100);
            }

            // ì¬ì ‘ì† ì²˜ë¦¬
            if (isGameActive && data.isGamePlayer) {
                document.getElementById('gameStatus').textContent = 'ê²Œì„ ì§„í–‰ ì¤‘!';
                document.getElementById('gameStatus').classList.remove('waiting');
                document.getElementById('gameStatus').classList.add('playing');
                document.getElementById('progressSection').style.display = 'block';
                
                if (isHost) {
                    document.getElementById('startButton').style.display = 'none';
                    document.getElementById('endButton').style.display = 'block';
                }
                
                const rollButton = document.getElementById('rollButton');
                const diceElement = document.getElementById('dice');
                const reconnectNotice = document.getElementById('reconnectNotice');
                const reconnectMessage = document.getElementById('reconnectMessage');
                
                if (data.hasRolled && data.myResult) {
                    diceElement.textContent = data.myResult.result;
                    rollButton.textContent = `ê²°ê³¼: ${data.myResult.result}`;
                    rollButton.disabled = true;
                    
                    reconnectNotice.style.display = 'block';
                    reconnectMessage.textContent = `ì´ë¯¸ ì£¼ì‚¬ìœ„ë¥¼ êµ´ë ¸ìŠµë‹ˆë‹¤. ê²°ê³¼: ${data.myResult.result}`;
                } else {
                    diceElement.textContent = '?';
                    rollButton.textContent = 'ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸°';
                    rollButton.disabled = false;
                    hasRolledInCurrentGame = false;
                    
                    reconnectNotice.style.display = 'block';
                    reconnectMessage.textContent = 'ì•„ì§ ì£¼ì‚¬ìœ„ë¥¼ êµ´ë¦¬ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ êµ´ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤!';
                    reconnectMessage.style.color = '#155724';
                    reconnectNotice.style.background = '#d4edda';
                    reconnectNotice.style.borderColor = '#28a745';
                }
            }
            
            // ì£¼ë¬¸ë°›ê¸° ìƒíƒœ ë°˜ì˜
            if (isOrderActive) {
                document.getElementById('ordersSection').classList.add('active');
                document.getElementById('myOrderInput').disabled = false;
                document.getElementById('orderSaveButton').disabled = false;
                document.getElementById('gameStatus').textContent = 'ì£¼ë¬¸ë°›ê¸° ì§„í–‰ ì¤‘!';
                document.getElementById('gameStatus').classList.add('ordering');
                
                if (isHost) {
                    document.getElementById('startOrderButton').style.display = 'none';
                    document.getElementById('endOrderButton').style.display = 'block';
                }
            } else if (isHost && !isGameActive) {
                // ê²Œì„ì´ ë¹„í™œì„±í™”ë˜ê³  ì£¼ë¬¸ë°›ê¸°ë„ ë¹„í™œì„±í™”ëœ ìƒíƒœì—ì„œ Hostì—ê²Œ ì£¼ë¬¸ë°›ê¸° ì‹œì‘ ë²„íŠ¼ í‘œì‹œ
                document.getElementById('startOrderButton').style.display = 'block';
                document.getElementById('endOrderButton').style.display = 'none';
            }
        }
        
        // ë°© ì—ëŸ¬ ì²˜ë¦¬
        socket.on('roomError', (message) => {
            alert(message);
        });
        
        // ë°© ì‚­ì œ ì•Œë¦¼ (ëª¨ë“  ì‚¬ìš©ìê°€ ë‚˜ê°)
        socket.on('roomDeleted', (data) => {
            alert(data.message || 'ëª¨ë“  ì‚¬ìš©ìê°€ ë°©ì„ ë– ë‚¬ìŠµë‹ˆë‹¤.');
            document.getElementById('gameSection').classList.remove('active');
            document.getElementById('lobbySection').classList.add('active');
            currentRoomId = null;
            currentUser = '';
            isHost = false;
            refreshRooms();
        });
        
        // í˜¸ìŠ¤íŠ¸ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateHostUI() {
            if (isHost) {
                // í˜¸ìŠ¤íŠ¸ ë°°ì§€ í‘œì‹œ
                const hostBadge = document.getElementById('hostBadge');
                if (hostBadge) {
                    hostBadge.style.display = 'inline-block';
                }
                
                // í˜¸ìŠ¤íŠ¸ ì „ìš© ì»¨íŠ¸ë¡¤ í‘œì‹œ
                const hostControls = document.getElementById('hostControls');
                if (hostControls) {
                    hostControls.style.display = 'grid';
                }
                
                // ë°© ì œëª© ë³€ê²½ ë²„íŠ¼ í‘œì‹œ
                const editRoomNameButton = document.getElementById('editRoomNameButton');
                if (editRoomNameButton) {
                    editRoomNameButton.style.display = 'inline-block';
                }
                
                // ê²Œì„ ìƒíƒœì— ë”°ë¼ ë²„íŠ¼ í‘œì‹œ
                if (!isGameActive && !isOrderActive) {
                    const startOrderButton = document.getElementById('startOrderButton');
                    if (startOrderButton) {
                        startOrderButton.style.display = 'block';
                    }
                }
                
                // ê²Œì„ ë£° ì €ì¥ ë²„íŠ¼ í‘œì‹œ
                updateGameRulesUI();
            } else {
                // í˜¸ìŠ¤íŠ¸ ë°°ì§€ ìˆ¨ê¹€
                const hostBadge = document.getElementById('hostBadge');
                if (hostBadge) {
                    hostBadge.style.display = 'none';
                }
                
                // í˜¸ìŠ¤íŠ¸ ì „ìš© ì»¨íŠ¸ë¡¤ ìˆ¨ê¹€
                const hostControls = document.getElementById('hostControls');
                if (hostControls) {
                    hostControls.style.display = 'none';
                }
                
                // ë°© ì œëª© ë³€ê²½ ë²„íŠ¼ ìˆ¨ê¹€
                const editRoomNameButton = document.getElementById('editRoomNameButton');
                if (editRoomNameButton) {
                    editRoomNameButton.style.display = 'none';
                }
                
                // ê²Œì„ ë£° ì €ì¥ ë²„íŠ¼ ìˆ¨ê¹€
                updateGameRulesUI();
            }
        }
        
        // í˜¸ìŠ¤íŠ¸ ê¶Œí•œ ì „ë‹¬ ì•Œë¦¼
        socket.on('hostTransferred', (data) => {
            alert(data.message || 'í˜¸ìŠ¤íŠ¸ ê¶Œí•œì´ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
            isHost = true;
            // í˜¸ìŠ¤íŠ¸ ì „ìš© UI ì—…ë°ì´íŠ¸
            updateHostUI();
        });
        
        // í˜¸ìŠ¤íŠ¸ ë³€ê²½ ì•Œë¦¼
        socket.on('hostChanged', (data) => {
            // ìƒˆ í˜¸ìŠ¤íŠ¸ IDëŠ” socket.idê°€ ì•„ë‹ˆë¼ ì‚¬ìš©ì IDì´ë¯€ë¡œ ë‹¤ë¥¸ ë°©ì‹ìœ¼ë¡œ í™•ì¸ í•„ìš”
            // ì„œë²„ì—ì„œ ë³´ë‚¸ newHostIdë¥¼ ì‚¬ìš©ìì˜ socket.idì™€ ë¹„êµí•˜ê¸° ìœ„í•´ 
            // updateUsers ì´ë²¤íŠ¸ë¥¼ í†µí•´ í™•ì¸
            console.log('í˜¸ìŠ¤íŠ¸ ë³€ê²½ ì•Œë¦¼:', data.message);
        });
        
        // í˜¸ìŠ¤íŠ¸ ìƒíƒœ ë³€ê²½ ì¶”ì  ë³€ìˆ˜
        let lastHostStatus = false;
        
        // ë°© ì œëª© ì—…ë°ì´íŠ¸
        socket.on('roomNameUpdated', (roomName) => {
            document.getElementById('roomNameText').textContent = roomName;
            cancelRoomNameEdit();
        });
        
        // ë°© ì œëª© í¸ì§‘
        function editRoomName() {
            const currentName = document.getElementById('roomNameText').textContent;
            document.getElementById('roomNameInput').value = currentName;
            document.getElementById('roomNameDisplay').style.display = 'none';
            document.getElementById('roomNameEditSection').style.display = 'block';
            document.getElementById('editRoomNameButton').style.display = 'none';
        }
        
        // ë°© ì œëª© ì €ì¥
        function saveRoomName() {
            const newName = document.getElementById('roomNameInput').value.trim();
            
            if (newName === '') {
                alert('ë°© ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            socket.emit('updateRoomName', { roomName: newName });
        }
        
        // ë°© ì œëª© í¸ì§‘ ì·¨ì†Œ
        function cancelRoomNameEdit() {
            document.getElementById('roomNameDisplay').style.display = 'block';
            document.getElementById('roomNameEditSection').style.display = 'none';
            if (isHost) {
                document.getElementById('editRoomNameButton').style.display = 'inline-block';
            }
        }

        // ë¡œê·¸ì¸ ì„±ê³µ (í•˜ìœ„ í˜¸í™˜ì„± ìœ ì§€, ì‚¬ìš© ì•ˆ í•¨)
        socket.on('loginSuccess', (data) => {
            hasRolledInCurrentGame = data.hasRolled;
            myDiceSettings = data.diceSettings;
            isGameActive = data.isGameActive;
            isOrderActive = data.isOrderActive;
            
            document.getElementById('loginSection').classList.remove('active');
            document.getElementById('gameSection').classList.add('active');
            document.getElementById('currentUser').textContent = currentUser;
            
            // ë‚´ ì£¼ì‚¬ìœ„ ì„¤ì • ì ìš©
            document.getElementById('diceMax').value = myDiceSettings.max;
            document.getElementById('currentMyRange').textContent = `1 ~ ${myDiceSettings.max}`;

            // ë‚´ ì£¼ë¬¸ ë¶ˆëŸ¬ì˜¤ê¸°
            document.getElementById('myOrderInput').value = data.myOrder || '';

            if (isHost) {
                document.getElementById('hostBadge').style.display = 'inline-block';
                document.getElementById('hostControls').style.display = 'grid';
            }
            
            // ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ê²Œì„ ë£° ì„¹ì…˜ í‘œì‹œ (ì½ê¸° ì „ìš©)
            document.getElementById('gameRulesSection').style.display = 'block';
            
            // ê²Œì„ ë£° ë¶ˆëŸ¬ì˜¤ê¸°
            if (data.gameRules !== undefined) {
                document.getElementById('gameRulesInput').value = data.gameRules || '';
                updateGameRulesUI();
            }
            
            // ìì£¼ ì“°ëŠ” ë©”ë‰´ ë¶ˆëŸ¬ì˜¤ê¸° (ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ë°ì´í„° ì‚¬ìš©)
            if (data.frequentMenus !== undefined) {
                frequentMenus = data.frequentMenus;
                renderMenuList();
            } else {
                // ì„œë²„ì—ì„œ ê°€ì ¸ì˜¤ê¸°
                loadFrequentMenus();
            }
            
            // ì£¼ë¬¸ë°›ê¸°ê°€ í™œì„±í™”ëœ ìƒíƒœë©´ ì£¼ë¬¸í•˜ì§€ ì•Šì€ ì‚¬ëŒ ëª©ë¡ë„ í‘œì‹œ
            if (isOrderActive) {
                setTimeout(() => {
                    renderNotOrderedUsers();
                }, 100);
            }

            // ì¬ì ‘ì† ì²˜ë¦¬
            if (isGameActive && data.isGamePlayer) {
                document.getElementById('gameStatus').textContent = 'ê²Œì„ ì§„í–‰ ì¤‘!';
                document.getElementById('gameStatus').classList.remove('waiting');
                document.getElementById('gameStatus').classList.add('playing');
                document.getElementById('progressSection').style.display = 'block';
                
                if (isHost) {
                    document.getElementById('startButton').style.display = 'none';
                    document.getElementById('endButton').style.display = 'block';
                }
                
                const rollButton = document.getElementById('rollButton');
                const diceElement = document.getElementById('dice');
                const reconnectNotice = document.getElementById('reconnectNotice');
                const reconnectMessage = document.getElementById('reconnectMessage');
                
                if (data.hasRolled && data.myResult) {
                    diceElement.textContent = data.myResult.result;
                    rollButton.textContent = `ê²°ê³¼: ${data.myResult.result}`;
                    rollButton.disabled = true;
                    
                    reconnectNotice.style.display = 'block';
                    reconnectMessage.textContent = `ì´ë¯¸ ì£¼ì‚¬ìœ„ë¥¼ êµ´ë ¸ìŠµë‹ˆë‹¤. ê²°ê³¼: ${data.myResult.result}`;
                } else {
                    diceElement.textContent = '?';
                    rollButton.textContent = 'ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸°';
                    rollButton.disabled = false;
                    hasRolledInCurrentGame = false;
                    
                    reconnectNotice.style.display = 'block';
                    reconnectMessage.textContent = 'ì•„ì§ ì£¼ì‚¬ìœ„ë¥¼ êµ´ë¦¬ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ êµ´ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤!';
                    reconnectMessage.style.color = '#155724';
                    reconnectNotice.style.background = '#d4edda';
                    reconnectNotice.style.borderColor = '#28a745';
                }
            }

            // ì£¼ë¬¸ë°›ê¸° ìƒíƒœ ë°˜ì˜
            if (isOrderActive) {
                document.getElementById('ordersSection').classList.add('active');
                document.getElementById('myOrderInput').disabled = false;
                document.getElementById('orderSaveButton').disabled = false;
                document.getElementById('gameStatus').textContent = 'ì£¼ë¬¸ë°›ê¸° ì§„í–‰ ì¤‘!';
                document.getElementById('gameStatus').classList.add('ordering');
                
                if (isHost) {
                    document.getElementById('startOrderButton').style.display = 'none';
                    document.getElementById('endOrderButton').style.display = 'block';
                }
            } else if (isHost && !isGameActive) {
                // ê²Œì„ì´ ë¹„í™œì„±í™”ë˜ê³  ì£¼ë¬¸ë°›ê¸°ë„ ë¹„í™œì„±í™”ëœ ìƒíƒœì—ì„œ Hostì—ê²Œ ì£¼ë¬¸ë°›ê¸° ì‹œì‘ ë²„íŠ¼ í‘œì‹œ
                document.getElementById('startOrderButton').style.display = 'block';
                document.getElementById('endOrderButton').style.display = 'none';
            }
        });

        // ë¡œê·¸ì¸ ì—ëŸ¬
        socket.on('loginError', (message) => {
            alert(message);
            logout();
        });

        // ë¡œê·¸ì•„ì›ƒ (ë°© ë‚˜ê°€ê¸°)
        function logout() {
            if (currentRoomId) {
                socket.emit('leaveRoom');
            } else {
            socket.disconnect();
            location.reload();
            }
        }
        
        // ë°© ë‚˜ê°€ê¸° ì™„ë£Œ
        socket.on('roomLeft', () => {
            currentRoomId = null;
            currentUser = '';
            isHost = false;
            document.getElementById('gameSection').classList.remove('active');
            document.getElementById('lobbySection').classList.add('active');
            refreshRooms();
        });

        // ì£¼ë¬¸ë°›ê¸° ì‹œì‘
        function startOrder() {
            socket.emit('startOrder');
        }

        socket.on('orderStarted', () => {
            isOrderActive = true;
            document.getElementById('ordersSection').classList.add('active');
            const orderInput = document.getElementById('myOrderInput');
            orderInput.disabled = false;
            orderInput.value = '';
            document.getElementById('orderSaveButton').disabled = false;
            document.getElementById('gameStatus').textContent = 'ì£¼ë¬¸ë°›ê¸° ì§„í–‰ ì¤‘!';
            document.getElementById('gameStatus').classList.remove('waiting');
            document.getElementById('gameStatus').classList.add('ordering');
            
            // ìë™ì™„ì„± ê¸°ëŠ¥ í™œì„±í™”
            setupAutocomplete();
            
            if (isHost) {
                document.getElementById('startOrderButton').style.display = 'none';
                document.getElementById('endOrderButton').style.display = 'block';
            }
            
            // ì£¼ë¬¸í•˜ì§€ ì•Šì€ ì‚¬ëŒ ëª©ë¡ í‘œì‹œ
            renderNotOrderedUsers();
            
            console.log('ì£¼ë¬¸ë°›ê¸°ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!');
        });

        // ì£¼ë¬¸ë°›ê¸° ì¢…ë£Œ
        function endOrder() {
            socket.emit('endOrder');
        }

        socket.on('orderEnded', () => {
            isOrderActive = false;
            document.getElementById('myOrderInput').disabled = true;
            document.getElementById('orderSaveButton').disabled = true;
            document.getElementById('gameStatus').textContent = 'ê²Œì„ ëŒ€ê¸° ì¤‘...';
            document.getElementById('gameStatus').classList.remove('ordering');
            document.getElementById('gameStatus').classList.add('waiting');
            
            if (isHost) {
                document.getElementById('startButton').style.display = 'block';
                document.getElementById('endButton').style.display = 'none';
                // ê²Œì„ì´ ë¹„í™œì„±í™”ëœ ìƒíƒœë©´ ì£¼ë¬¸ë°›ê¸° ì‹œì‘ ë²„íŠ¼ í‘œì‹œ
                if (!isGameActive) {
                    document.getElementById('startOrderButton').style.display = 'block';
                } else {
                    document.getElementById('startOrderButton').style.display = 'none';
                }
                document.getElementById('endOrderButton').style.display = 'none';
            }
            
            alert('ì£¼ë¬¸ë°›ê¸°ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
        });

        // ì£¼ë¬¸ ì—…ë°ì´íŠ¸
        function updateMyOrder() {
            const orderInput = document.getElementById('myOrderInput');
            const order = orderInput.value.trim();

            socket.emit('updateOrder', {
                userName: currentUser,
                order: order
            });
        }

        socket.on('orderUpdated', (data) => {
            console.log('ì£¼ë¬¸ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤:', data.order);
        });

        socket.on('orderError', (message) => {
            alert(message);
        });

        // ì£¼ë¬¸ ëª©ë¡ ì—…ë°ì´íŠ¸
        socket.on('updateOrders', (orders) => {
            ordersData = orders;
            renderOrders();
        });

        // ì£¼ë¬¸ ëª©ë¡ì„ ë©”ë‰´ë³„ë¡œ ê·¸ë£¹í™”í•˜ê³  ì •ë ¬
        function groupOrdersByMenu(data, mode) {
            const entries = Object.entries(data).filter(([name, order]) => order && order.trim() !== '');
            
            // ë©”ë‰´ë³„ë¡œ ê·¸ë£¹í™”
            const grouped = {};
            entries.forEach(([userName, order]) => {
                const menuKey = order.trim().toLowerCase(); // ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´ ê·¸ë£¹í™”
                if (!grouped[menuKey]) {
                    grouped[menuKey] = {
                        menu: order.trim(),
                        users: []
                    };
                }
                grouped[menuKey].users.push(userName);
            });
            
            // ê°€ë‚˜ë‹¤ìˆœ ë˜ëŠ” ì—­ìˆœ ì •ë ¬ (ë©”ë‰´ëª… ê¸°ì¤€)
            const sortedGroups = Object.values(grouped).sort((a, b) => {
                if (mode === 'desc') {
                    return b.menu.localeCompare(a.menu, 'ko'); // ì—­ìˆœ
                } else {
                    return a.menu.localeCompare(b.menu, 'ko'); // ê°€ë‚˜ë‹¤ìˆœ
                }
            });
            
            return sortedGroups;
        }

        // ì£¼ë¬¸ ì •ë ¬ ë²„íŠ¼ í´ë¦­
        function sortOrders(mode) {
            currentOrderSortMode = mode;
            
            document.querySelectorAll('#ordersSection .sort-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (mode === 'asc') {
                document.getElementById('sortOrderAscBtn').classList.add('active');
            } else if (mode === 'desc') {
                document.getElementById('sortOrderDescBtn').classList.add('active');
            }
            
            renderOrders();
        }

        // ì£¼ë¬¸ ëª©ë¡ ë Œë”ë§ (ê·¸ë£¹í™”ëœ í˜•íƒœ)
        function renderOrders() {
            const orderList = document.getElementById('orderList');
            const notOrderedSection = document.getElementById('notOrderedSection');
            const notOrderedList = document.getElementById('notOrderedList');
            
            const entries = Object.entries(ordersData).filter(([name, order]) => order && order.trim() !== '');
            
            if (entries.length === 0) {
                orderList.innerHTML = '<div style="color: #999; text-align: center; padding: 10px;">ì•„ì§ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                // ì£¼ë¬¸í•˜ì§€ ì•Šì€ ì‚¬ëŒ ëª©ë¡ í‘œì‹œ
                renderNotOrderedUsers();
                return;
            }
            
            // ë©”ë‰´ë³„ë¡œ ê·¸ë£¹í™”ëœ ì£¼ë¬¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            const groupedOrders = groupOrdersByMenu(ordersData, currentOrderSortMode);
            
            orderList.innerHTML = '';
            
            groupedOrders.forEach(group => {
                // ê°™ì€ ë©”ë‰´ë¥¼ ì£¼ë¬¸í•œ ì‚¬ëŒë“¤ì´ ì—¬ëŸ¬ ëª…ì´ë©´ í•˜ë‚˜ì˜ í•­ëª©ìœ¼ë¡œ í‘œì‹œ
                const item = document.createElement('div');
                item.className = 'order-item';
                
                // ì™¼ìª½ ì˜ì—­
                const leftDiv = document.createElement('div');
                leftDiv.className = 'order-item-left';
                
                // ì‚¬ìš©ì ëª©ë¡ ìƒì„± (ë‚´ ì£¼ë¬¸ì´ë©´ ë§¨ ì•ì—)
                const sortedUsers = [...group.users].sort((a, b) => {
                    if (a === currentUser) return -1;
                    if (b === currentUser) return 1;
                    return 0;
                });
                
                const userNames = sortedUsers.map(name => 
                    name + (name === currentUser ? ' (ë‚˜)' : '')
                ).join(', ');
                
                const userDiv = document.createElement('div');
                userDiv.className = 'order-user';
                userDiv.textContent = userNames;
                
                const orderDiv = document.createElement('div');
                orderDiv.className = 'order-text';
                orderDiv.textContent = group.menu;
                
                leftDiv.appendChild(userDiv);
                leftDiv.appendChild(orderDiv);
                
                // ì˜¤ë¥¸ìª½ ì¸ì›ìˆ˜ (ì£¼ì‚¬ìœ„ ìˆ«ìì²˜ëŸ¼ í¬ê²Œ í‘œì‹œ)
                const countDiv = document.createElement('div');
                countDiv.className = 'order-count';
                countDiv.textContent = group.users.length;
                
                item.appendChild(leftDiv);
                item.appendChild(countDiv);
                orderList.appendChild(item);
            });
            
            // ì£¼ë¬¸í•˜ì§€ ì•Šì€ ì‚¬ëŒ ëª©ë¡ í‘œì‹œ
            renderNotOrderedUsers();
        }

        // ì£¼ë¬¸í•˜ì§€ ì•Šì€ ì‚¬ëŒ ëª©ë¡ ë Œë”ë§
        function renderNotOrderedUsers() {
            const notOrderedSection = document.getElementById('notOrderedSection');
            const notOrderedList = document.getElementById('notOrderedList');
            
            if (!isOrderActive) {
                notOrderedSection.style.display = 'none';
                return;
            }
            
            // ì£¼ë¬¸í•œ ì‚¬ëŒ ëª©ë¡
            const orderedUsers = Object.entries(ordersData)
                .filter(([name, order]) => order && order.trim() !== '')
                .map(([name]) => name);
            
            // ì£¼ë¬¸í•˜ì§€ ì•Šì€ ì‚¬ëŒ ëª©ë¡ (ì ‘ì†ì ì¤‘ì—ì„œ ì£¼ë¬¸í•˜ì§€ ì•Šì€ ì‚¬ëŒ)
            const notOrderedUsers = usersList
                .map(user => user.name)
                .filter(name => !orderedUsers.includes(name));
            
            if (notOrderedUsers.length === 0) {
                notOrderedSection.style.display = 'none';
                return;
            }
            
            notOrderedSection.style.display = 'block';
            notOrderedList.innerHTML = '';
            
            notOrderedUsers.forEach(name => {
                const tag = document.createElement('div');
                tag.className = 'not-rolled-tag';
                tag.textContent = name + (name === currentUser ? ' (ë‚˜)' : '');
                notOrderedList.appendChild(tag);
            });
        }

        // ë‚´ ì£¼ì‚¬ìœ„ ì„¤ì • ì—…ë°ì´íŠ¸
        function updateMyDiceSettings() {
            const max = parseInt(document.getElementById('diceMax').value);

            if (isNaN(max)) {
                alert('ì˜¬ë°”ë¥¸ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            if (max < 2) {
                alert('ìµœëŒ€ê°’ì€ 2 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤!');
                return;
            }

            if (max > 100000) {
                alert('ìµœëŒ€ê°’ì€ 100000 ì´í•˜ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”!');
                return;
            }

            socket.emit('updateUserDiceSettings', {
                userName: currentUser,
                max: max
            });
        }

        socket.on('settingsUpdated', (settings) => {
            myDiceSettings = settings;
            document.getElementById('currentMyRange').textContent = `1 ~ ${settings.max}`;
            alert(`ì£¼ì‚¬ìœ„ ë²”ìœ„ê°€ 1 ~ ${settings.max}ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        });

        socket.on('settingsError', (message) => {
            alert(message);
        });

        // ê²Œì„ ë£° ì—…ë°ì´íŠ¸
        function updateGameRules() {
            const rulesInput = document.getElementById('gameRulesInput');
            const rules = rulesInput.value.trim();

            socket.emit('updateGameRules', {
                rules: rules
            });
        }

        // ê²Œì„ ë£° UI ì—…ë°ì´íŠ¸ (ê²Œì„ ì‹œì‘ ìƒíƒœì— ë”°ë¼ í¸ì§‘ ê°€ëŠ¥ ì—¬ë¶€ ê²°ì •)
        function updateGameRulesUI() {
            const rulesInput = document.getElementById('gameRulesInput');
            const rulesSaveButton = document.getElementById('gameRulesSaveButton');
            
            // ì €ì¥ ë²„íŠ¼ì€ í˜¸ìŠ¤íŠ¸ë§Œ ë³´ì´ê²Œ
            if (isHost) {
                rulesSaveButton.style.display = 'inline-block';
            } else {
                rulesSaveButton.style.display = 'none';
            }
            
            // í˜¸ìŠ¤íŠ¸ì´ê³  ê²Œì„ì´ ì‹œì‘ë˜ì§€ ì•Šì•˜ì„ ë•Œë§Œ í¸ì§‘ ê°€ëŠ¥
            if (isHost && !isGameActive) {
                rulesInput.disabled = false;
                rulesSaveButton.disabled = false;
            } else {
                rulesInput.disabled = true;
                rulesSaveButton.disabled = true;
            }
        }

        // ê²Œì„ ë£° ì—…ë°ì´íŠ¸ ìˆ˜ì‹ 
        socket.on('gameRulesUpdated', (rules) => {
            document.getElementById('gameRulesInput').value = rules || '';
            console.log('ê²Œì„ ë£°ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤:', rules);
        });

        socket.on('rulesError', (message) => {
            alert(message);
        });

        // ê²Œì„ ì‹œì‘
        function startGame() {
            // í˜¸ìŠ¤íŠ¸ì¸ ê²½ìš° ê²Œì„ ì‹œì‘ ì „ í˜„ì¬ ì…ë ¥ëœ ë£°ì„ ì„œë²„ì— ì €ì¥
            if (isHost) {
                const rulesInput = document.getElementById('gameRulesInput');
                const currentRules = rulesInput.value.trim();
                
                // ë£°ì´ ì…ë ¥ë˜ì–´ ìˆìœ¼ë©´ ì„œë²„ì— ì €ì¥ ìš”ì²­
                if (currentRules) {
                    socket.emit('updateGameRules', {
                        rules: currentRules
                    });
                }
            }
            
            socket.emit('startGame');
        }

        socket.on('gameStarted', (data) => {
            isGameActive = true;
            hasRolledInCurrentGame = false;
            historyData = [];
            
            // ì¤€ë¹„ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.getElementById('readySection').style.display = 'none';
            
            document.getElementById('reconnectNotice').style.display = 'none';
            
            document.getElementById('gameStatus').textContent = 'ê²Œì„ ì§„í–‰ ì¤‘!';
            document.getElementById('gameStatus').classList.remove('waiting');
            document.getElementById('gameStatus').classList.remove('ordering');
            document.getElementById('gameStatus').classList.add('playing');
            document.getElementById('startButton').style.display = 'none';
            document.getElementById('endButton').style.display = 'block';
            
            // ê²Œì„ ì‹œì‘ ì‹œ ì£¼ë¬¸ë°›ê¸° ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            if (isHost) {
                document.getElementById('startOrderButton').style.display = 'none';
                document.getElementById('endOrderButton').style.display = 'none';
            }
            
            // ê²Œì„ ì‹œì‘ ì‹œ ë£° ìˆ˜ì • ë¶ˆê°€ëŠ¥í•˜ë„ë¡ UI ì—…ë°ì´íŠ¸
            updateGameRulesUI();
            
            const rollButton = document.getElementById('rollButton');
            rollButton.disabled = false;
            rollButton.textContent = 'ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸°';
            
            document.getElementById('dice').textContent = '?';
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('progressBar').style.background = 'linear-gradient(90deg, #667eea 0%, #764ba2 100%)';
            
            // ì£¼ë¬¸ë°›ê¸° ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.getElementById('ordersSection').classList.remove('active');
            
            renderHistory();
        });

        // ê²Œì„ ì¢…ë£Œ
        function endGame() {
            socket.emit('endGame');
        }

        // ì´ì „ ê²Œì„ ë°ì´í„° ì‚­ì œ
        function clearGameData() {
            if (!confirm('ì •ë§ë¡œ ì´ì „ ê²Œì„ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê²Œì„ ê¸°ë¡, ì£¼ë¬¸ ë‚´ì—­, ê²Œì„ ë£°ì´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤)')) {
                return;
            }
            
            socket.emit('clearGameData');
        }

        // ê²Œì„ ë°ì´í„° ì‚­ì œ ì„±ê³µ
        socket.on('gameDataCleared', () => {
            historyData = [];
            ordersData = {};
            
            renderHistory();
            renderOrders();
            
            // ê²Œì„ ë£° ì´ˆê¸°í™”
            document.getElementById('gameRulesInput').value = '';
            
            alert('ì´ì „ ê²Œì„ ë°ì´í„°ê°€ ëª¨ë‘ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
        });

        // ê²Œì„ ë°ì´í„° ì‚­ì œ ì—ëŸ¬
        socket.on('clearDataError', (message) => {
            alert(message);
        });

        socket.on('gameEnded', (history) => {
            isGameActive = false;
            hasRolledInCurrentGame = false;
            historyData = history;
            
            // ê²Œì„ ì¢…ë£Œ ì‹œ ì¤€ë¹„ ì„¹ì…˜ ë‹¤ì‹œ í‘œì‹œ
            document.getElementById('readySection').style.display = 'block';
            
            document.getElementById('gameStatus').textContent = 'ê²Œì„ ì¢…ë£Œë¨ - ì£¼ë¬¸ë°›ê¸°ë¥¼ ì‹œì‘í•˜ì„¸ìš”!';
            document.getElementById('gameStatus').classList.remove('playing');
            document.getElementById('gameStatus').classList.add('waiting');
            document.getElementById('startButton').style.display = 'block';
            document.getElementById('endButton').style.display = 'none';
            document.getElementById('rollButton').disabled = true;
            document.getElementById('progressSection').style.display = 'none';
            
            // ì£¼ë¬¸ë°›ê¸° ì‹œì‘ ë²„íŠ¼ í‘œì‹œ (Hostë§Œ)
            if (isHost) {
                document.getElementById('startOrderButton').style.display = 'block';
            }
            
            // ê²Œì„ ì¢…ë£Œ ì‹œ ë£° ìˆ˜ì • ê°€ëŠ¥í•˜ë„ë¡ UI ì—…ë°ì´íŠ¸ (í˜¸ìŠ¤íŠ¸ë§Œ)
            updateGameRulesUI();
            
            let resultsText = 'ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\n=== ìµœì¢… ê²°ê³¼ ===\n\n';
            
            const sortedHistory = sortHistoryData([...history], currentSortMode);
            
            sortedHistory.forEach((record, index) => {
                resultsText += `${index + 1}. ${record.user}: ${record.result} (ë²”ìœ„: ${record.range})\n`;
            });
            
            resultsText += `\nì´ ${history.length}ë²ˆì˜ ì£¼ì‚¬ìœ„ê°€ êµ´ë ¤ì¡ŒìŠµë‹ˆë‹¤.`;
            
            alert(resultsText);
            
            const myRecord = history.find(r => r.user === currentUser);
            if (myRecord) {
                const diceElement = document.getElementById('dice');
                const rollButton = document.getElementById('rollButton');
                
                diceElement.textContent = myRecord.result;
                rollButton.textContent = `ë‚´ ê²°ê³¼: ${myRecord.result}`;
            }
        });

        // í´ë¼ì´ì–¸íŠ¸ ì‹œë“œ ìƒì„±
        function generateClientSeed() {
            return Date.now().toString() + Math.random().toString(36).substring(2);
        }

        // ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸°
        let diceAnimationInterval = null;

        function rollDice() {
            if (!isGameActive) {
                alert('ê²Œì„ì´ ì§„í–‰ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤!');
                return;
            }

            if (hasRolledInCurrentGame) {
                alert('ì´ë¯¸ ì£¼ì‚¬ìœ„ë¥¼ êµ´ë ¸ìŠµë‹ˆë‹¤!');
                return;
            }

            const rollButton = document.getElementById('rollButton');
            rollButton.disabled = true;
            rollButton.textContent = 'êµ´ë¦¬ëŠ” ì¤‘...';

            const diceElement = document.getElementById('dice');
            diceElement.classList.add('rolling');
            diceElement.textContent = 'ğŸ²';
            
            let dots = 0;
            diceAnimationInterval = setInterval(() => {
                dots = (dots + 1) % 4;
                diceElement.textContent = 'ğŸ²' + '.'.repeat(dots);
            }, 200);

            const clientSeed = generateClientSeed();
            socket.emit('requestRoll', { 
                userName: currentUser,
                clientSeed: clientSeed
            });
        }

        // ì£¼ì‚¬ìœ„ ê²°ê³¼ ìˆ˜ì‹ 
        socket.on('diceRolled', (record) => {
            historyData.push(record);
            
            if (record.user === currentUser) {
                hasRolledInCurrentGame = true;
                
                if (diceAnimationInterval) {
                    clearInterval(diceAnimationInterval);
                    diceAnimationInterval = null;
                }

                const diceElement = document.getElementById('dice');
                diceElement.textContent = record.result;
                diceElement.classList.remove('rolling');
                
                diceElement.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    diceElement.style.transform = 'scale(1)';
                }, 300);
                
                const rollButton = document.getElementById('rollButton');
                rollButton.textContent = `ê²°ê³¼: ${record.result}`;
                rollButton.disabled = true;
            }
            
            renderHistory();
        });

        // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
        socket.on('rollProgress', (progress) => {
            updateProgress(progress);
        });

        // ëª¨ë‘ ì™„ë£Œ ì•Œë¦¼
        socket.on('allPlayersRolled', (data) => {
            alert(data.message);
            document.getElementById('progressBar').style.background = 'linear-gradient(90deg, #28a745 0%, #20c997 100%)';
        });

        // ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸° ì—ëŸ¬
        socket.on('rollError', (message) => {
            alert(message);
            
            const rollButton = document.getElementById('rollButton');
            const diceElement = document.getElementById('dice');
            
            if (diceAnimationInterval) {
                clearInterval(diceAnimationInterval);
                diceAnimationInterval = null;
            }
            
            if (!message.includes('ì´ë¯¸ ì£¼ì‚¬ìœ„ë¥¼ êµ´ë ¸ìŠµë‹ˆë‹¤')) {
                rollButton.disabled = false;
                rollButton.textContent = 'ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸°';
            } else {
                rollButton.textContent = 'ì´ë¯¸ êµ´ë ¸ìŠµë‹ˆë‹¤';
                rollButton.disabled = true;
            }
            
            diceElement.classList.remove('rolling');
        });

        // ì—ëŸ¬ ì²˜ë¦¬
        socket.on('connectionError', (message) => {
            alert(message);
            setTimeout(() => location.reload(), 2000);
        });

        socket.on('rateLimitError', (message) => {
            alert(message);
        });

        socket.on('permissionError', (message) => {
            alert(message);
        });

        socket.on('rangeError', (message) => {
            alert(message);
        });

        // ì‚¬ìš©ì ëª©ë¡ ì—…ë°ì´íŠ¸
        socket.on('updateUsers', (users) => {
            // í˜¸ìŠ¤íŠ¸ ìƒíƒœ í™•ì¸ ë° ì—…ë°ì´íŠ¸
            const myUser = users.find(u => u.name === currentUser);
            if (myUser && myUser.isHost !== isHost) {
                const wasHost = isHost;
                isHost = myUser.isHost;
                if (isHost && !wasHost && lastHostStatus !== isHost) {
                    // í˜¸ìŠ¤íŠ¸ ê¶Œí•œì´ ì „ë‹¬ë˜ì—ˆì„ ë•Œ
                    alert('í˜¸ìŠ¤íŠ¸ ê¶Œí•œì´ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    updateHostUI();
                } else if (!isHost && wasHost) {
                    // í˜¸ìŠ¤íŠ¸ ê¶Œí•œì´ ì œê±°ë˜ì—ˆì„ ë•Œ
                    updateHostUI();
                }
                lastHostStatus = isHost;
            }
            
            usersList = users;
            updateUsers(users);
            updateHostCheckbox(users);
            // ì£¼ë¬¸ë°›ê¸°ê°€ í™œì„±í™”ëœ ìƒíƒœë©´ ì£¼ë¬¸í•˜ì§€ ì•Šì€ ì‚¬ëŒ ëª©ë¡ë„ ì—…ë°ì´íŠ¸
            if (isOrderActive) {
                renderNotOrderedUsers();
            }
        });

        function updateUsers(users) {
            const usersList = document.getElementById('usersList');
            const userCount = document.getElementById('userCount');
            
            userCount.textContent = users.length;
            
            if (users.length === 0) {
                usersList.innerHTML = '<div style="color: #999; text-align: center; padding: 10px; width: 100%;">ì ‘ì†ìê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }
            
            usersList.innerHTML = '';
            
            users.forEach((user) => {
                const userTag = document.createElement('div');
                userTag.className = 'user-tag' + (user.isHost ? ' host' : '');
                
                let content = user.name;
                if (user.isHost) {
                    content += ' ğŸ‘‘';
                }
                
                if (user.name === currentUser) {
                    content += ' (ë‚˜)';
                }
                
                userTag.textContent = content;
                usersList.appendChild(userTag);
            });
        }
        
        // ì¤€ë¹„ ìƒíƒœ í† ê¸€
        function toggleReady() {
            socket.emit('toggleReady');
        }
        
        // ì¤€ë¹„ ìƒíƒœ ë³€ê²½ ìˆ˜ì‹ 
        socket.on('readyStateChanged', (data) => {
            isReady = data.isReady;
            updateReadyButton();
        });
        
        // ì¤€ë¹„ ëª©ë¡ ì—…ë°ì´íŠ¸
        socket.on('readyUsersUpdated', (users) => {
            readyUsers = users;
            renderReadyUsers();
        });
        
        // ì¤€ë¹„ ì—ëŸ¬ ì²˜ë¦¬
        socket.on('readyError', (message) => {
            alert(message);
        });
        
        // ì¤€ë¹„í•œ ì‚¬ëŒ ëª©ë¡ ë Œë”ë§
        function renderReadyUsers() {
            const readyUsersList = document.getElementById('readyUsersList');
            const readyCount = document.getElementById('readyCount');
            
            readyCount.textContent = readyUsers.length;
            
            if (readyUsers.length === 0) {
                readyUsersList.innerHTML = '<div style="color: #999; text-align: center; padding: 10px; width: 100%;">ì•„ì§ ì¤€ë¹„í•œ ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }
            
            readyUsersList.innerHTML = '';
            
            readyUsers.forEach((userName) => {
                const userTag = document.createElement('div');
                userTag.className = 'user-tag';
                userTag.style.background = '#d4edda';
                userTag.style.borderColor = '#28a745';
                userTag.style.color = '#155724';
                
                let content = userName;
                if (userName === currentUser) {
                    content += ' (ë‚˜)';
                }
                
                userTag.textContent = content;
                readyUsersList.appendChild(userTag);
            });
        }
        
        // ì¤€ë¹„ ë²„íŠ¼ ì—…ë°ì´íŠ¸
        function updateReadyButton() {
            const readyButton = document.getElementById('readyButton');
            if (isReady) {
                readyButton.textContent = 'ì¤€ë¹„ ì·¨ì†Œ';
                readyButton.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
            } else {
                readyButton.textContent = 'ì¤€ë¹„';
                readyButton.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
            }
        }
        
        // ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡
        function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (message === '') {
                return;
            }
            
            socket.emit('sendMessage', { message: message });
            chatInput.value = '';
        }
        
        // ì±„íŒ… ì…ë ¥ì°½ì—ì„œ Enter í‚¤ë¡œ ì „ì†¡
        document.addEventListener('DOMContentLoaded', () => {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        sendChatMessage();
                    }
                });
            }
        });
        
        // ìƒˆ ë©”ì‹œì§€ ìˆ˜ì‹ 
        socket.on('newMessage', (chatMessage) => {
            const chatMessages = document.getElementById('chatMessages');
            
            // ì²« ë©”ì‹œì§€ë©´ ë¹ˆ ìƒíƒœ ë©”ì‹œì§€ ì œê±°
            if (chatMessages.children.length === 1 && chatMessages.children[0].textContent === 'ì±„íŒ… ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤') {
                chatMessages.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = 'margin-bottom: 10px; padding: 8px; background: white; border-radius: 6px; border-left: 3px solid #667eea;';
            
            const userNameSpan = document.createElement('span');
            userNameSpan.style.cssText = 'font-weight: 600; color: #667eea; margin-right: 8px;';
            userNameSpan.textContent = chatMessage.isHost ? `ğŸ‘‘ ${chatMessage.userName}` : chatMessage.userName;
            if (chatMessage.userName === currentUser) {
                userNameSpan.textContent += ' (ë‚˜)';
                userNameSpan.style.color = '#764ba2';
            }
            
            const messageSpan = document.createElement('span');
            messageSpan.style.color = '#333';
            messageSpan.textContent = chatMessage.message;
            
            const timeSpan = document.createElement('span');
            timeSpan.style.cssText = 'font-size: 11px; color: #999; margin-left: 8px;';
            timeSpan.textContent = chatMessage.time;
            
            messageDiv.appendChild(userNameSpan);
            messageDiv.appendChild(messageSpan);
            messageDiv.appendChild(document.createElement('br'));
            messageDiv.appendChild(timeSpan);
            
            chatMessages.appendChild(messageDiv);
            
            // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });
        
        // ì±„íŒ… ì—ëŸ¬ ì²˜ë¦¬
        socket.on('chatError', (message) => {
            alert(message);
        });

        function updateHostCheckbox(users) {
            const hostCheckbox = document.getElementById('hostCheckbox');
            const hasHost = users.some(user => user.isHost === true);
            
            if (hasHost) {
                hostCheckbox.disabled = true;
                hostCheckbox.checked = false;
                const label = document.querySelector('label[for="hostCheckbox"]');
                if (label) {
                    label.textContent = 'Hostë¡œ ì…ì¥ (ì´ë¯¸ í˜¸ìŠ¤íŠ¸ê°€ ìˆìŠµë‹ˆë‹¤)';
                    label.style.color = '#999';
                }
            } else {
                hostCheckbox.disabled = false;
                const label = document.querySelector('label[for="hostCheckbox"]');
                if (label) {
                    label.textContent = 'Hostë¡œ ì…ì¥';
                    label.style.color = '';
                }
            }
        }

        function updateProgress(progress) {
            const { rolled, total, notRolledYet } = progress;
            const percentage = total > 0 ? (rolled / total) * 100 : 0;
            
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percentage + '%';
            progressBar.textContent = Math.round(percentage) + '%';
            
            document.getElementById('progressCount').textContent = `${rolled}/${total}`;
            
            const notRolledList = document.getElementById('notRolledList');
            
            if (notRolledYet.length === 0) {
                notRolledList.innerHTML = '<div class="empty-not-rolled">âœ… ëª¨ë‘ ì™„ë£Œ!</div>';
            } else {
                notRolledList.innerHTML = '';
                notRolledYet.forEach(name => {
                    const tag = document.createElement('div');
                    tag.className = 'not-rolled-tag';
                    tag.textContent = name;
                    if (name === currentUser) {
                        tag.textContent += ' (ë‚˜)';
                    }
                    notRolledList.appendChild(tag);
                });
            }
        }

        // íˆìŠ¤í† ë¦¬ ì •ë ¬ í•¨ìˆ˜
        function sortHistoryData(data, mode) {
            const sorted = [...data];
            
            if (mode === 'asc') {
                sorted.sort((a, b) => a.result - b.result);
            } else if (mode === 'desc') {
                sorted.sort((a, b) => b.result - a.result);
            } else if (mode === 'time') {
                sorted.reverse();
            }
            
            return sorted;
        }

        // ì •ë ¬ ë²„íŠ¼ í´ë¦­
        function sortHistory(mode) {
            currentSortMode = mode;
            
            document.querySelectorAll('.sort-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (mode === 'time') {
                document.getElementById('sortTimeBtn').classList.add('active');
            } else if (mode === 'asc') {
                document.getElementById('sortAscBtn').classList.add('active');
            } else if (mode === 'desc') {
                document.getElementById('sortDescBtn').classList.add('active');
            }
            
            renderHistory();
        }

        // íˆìŠ¤í† ë¦¬ ë Œë”ë§
        function renderHistory() {
            const historyList = document.getElementById('historyList');
            
            if (historyData.length === 0) {
                historyList.innerHTML = '<div class="empty-history">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }
            
            const sortedData = sortHistoryData(historyData, currentSortMode);
            
            historyList.innerHTML = '';
            
            sortedData.forEach(record => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <div>
                        <div class="history-user">${record.user}</div>
                        <div class="history-range">${record.range || '1~100'}</div>
                        <div class="history-time">${record.time}</div>
                    </div>
                    <div class="history-result">ğŸ² ${record.result}</div>
                `;
                historyList.appendChild(item);
            });
        }
    </script>
</body>
</html>
