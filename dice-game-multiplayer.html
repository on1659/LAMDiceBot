<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>LAM Dice :)</title>
    <!-- Google Fonts - ê·€ì—¬ìš´ í°íŠ¸ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Yeon+Sung&display=swap" rel="stylesheet">
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1608259764663412" crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            position: relative;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px auto;
        }
        
        /* ë¡œë¹„ ì„¹ì…˜ì´ í™œì„±í™”ë˜ì–´ ìˆì„ ë•ŒëŠ” ì¤‘ì•™ ì •ë ¬ */
        body.lobby-active .container {
            margin-left: auto;
            margin-right: auto;
        }
        
        /* ê²Œì„ ì„¹ì…˜ì´ í™œì„±í™”ë˜ì–´ ìˆì„ ë•Œ ì»¨í…Œì´ë„ˆë¥¼ ì¤‘ì•™ì— ë°°ì¹˜ */
        body.game-active .container {
            /* ì»¨í…Œì´ë„ˆë¥¼ í™”ë©´ ì¤‘ì•™ì— ë°°ì¹˜ (ì˜¤ë¥¸ìª½ìœ¼ë¡œ 160px ì¶”ê°€ ì´ë™)
               - ì»¨í…Œì´ë„ˆ ë„ˆë¹„: 800px
               - ê¸°ë¡ ì„¹ì…˜ ë„ˆë¹„: 320px
               - ì»¨í…Œì´ë„ˆì™€ ê¸°ë¡ ì„¹ì…˜ ì‚¬ì´ ì—¬ë°±: 20px
               ì´ ë„ˆë¹„: 800px + 20px + 320px = 1140px
               ì¤‘ì•™ ì •ë ¬: (100vw - 1140px) / 2 + 160px
            */
            margin-left: calc((100vw - 1140px) / 2 + 160px);
            margin-right: auto;
            max-width: 800px;
        }
        
        /* ë°© ì…ì¥ ì‹œ í—¤ë”ì™€ í‘¸í„° ìˆ¨ê¸°ê¸° */
        body.game-active header,
        body.game-active footer {
            display: none;
        }

        /* ì„œë²„ ì„ íƒ ì˜¤ë²„ë ˆì´ í‘œì‹œ ì¤‘ ë³¸ë¬¸ ìˆ¨ê¸°ê¸° */
        body.server-select-active .container {
            display: none;
        }
        
        .chat-history-wrapper {
            margin-top: 20px;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .lobby-section, .game-section, .create-room-section {
            display: none;
        }

        .lobby-section.active, .game-section.active, .create-room-section.active {
            display: block;
        }
        
        .rooms-list {
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
        }
        
        .room-item {
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .room-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        /* ê²½ë§ˆ ë²„íŠ¼ íˆ´íŒ */
        #horseRaceLabel {
            position: relative;
        }
        
        #horseRaceLabel::after {
            content: 'ì´ë¦„ ì¶”ì²œë°›ì•„ìš”~ ë¬¸ì˜í•˜ê¸°ì— ë‚¨ê²¨ì£¼ì„¸ìš”!';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 8px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            font-size: 12px;
            white-space: nowrap;
            border-radius: 6px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        #horseRaceLabel::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 2px;
            border: 6px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.85);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }
        
        #horseRaceLabel:hover::after,
        #horseRaceLabel:hover::before {
            opacity: 1;
        }
        
        .room-item.active {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        
        .room-item.my-room {
            background: #fff3cd;
            border-color: #ffc107;
            border-width: 3px;
        }
        
        .my-room-badge {
            display: inline-block;
            background: #ffc107;
            color: #333;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .room-info {
            flex: 1;
        }
        
        .room-name {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .room-details {
            font-size: 14px;
            color: #666;
        }
        
        .room-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            margin-top: 5px;
            display: inline-block;
        }
        
        .room-status.playing {
            background: #d4edda;
            color: #155724;
        }
        
        .room-status.ordering {
            background: #fff9e6;
            color: #856404;
        }
        
        .room-status.waiting {
            background: #e0e0e0;
            color: #666;
        }
        
        .room-action {
            margin-left: 15px;
        }
        
        .room-action button {
            width: auto;
            padding: 10px 20px;
        }
        
        .create-room-section, .join-room-section {
            background: #f8f9fa;
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .room-name-input-section {
            background: #f8f9fa;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: none;
        }
        
        .room-name-input-section.active {
            display: block;
        }
        
        .room-name-display {
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 10px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        input[type="text"], input[type="number"], textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
        }

        input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .user-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-name {
            font-weight: 600;
            color: #667eea;
            font-size: 18px;
        }

        .host-badge {
            background: #ffc107;
            color: #333;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .connection-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .connection-status.connected {
            background: #28a745;
            color: white;
        }

        .connection-status.disconnected {
            background: #dc3545;
            color: white;
        }

        .connection-sound-row {
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        .connection-sound-row label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #555;
            cursor: pointer;
        }
        .connection-sound-row input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        .volume-control {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #555;
        }
        .volume-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 2px 4px;
            border-radius: 4px;
            transition: background 0.2s;
            width: auto;
        }
        .volume-btn:hover {
            background: rgba(0,0,0,0.1);
        }
        .volume-slider {
            width: 60px;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: #ddd;
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: #667eea;
            border-radius: 50%;
            cursor: pointer;
        }
        .volume-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: #667eea;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        .volume-slider.muted {
            opacity: 0.5;
        }

        .game-status {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 18px;
        }

        .game-status.waiting {
            background: #fff3cd;
            color: #856404;
        }

        .game-status.playing {
            background: #d4edda;
            color: #155724;
        }

        .game-status.ordering {
            background: #fff9e6;
            color: #856404;
        }

        .host-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        #clearDataButton {
            grid-column: 1 / -1;
        }

        .dice-container {
            text-align: center;
            margin: 30px 0;
        }

        .dice {
            width: 150px;
            height: 150px;
            background: white;
            border: 3px solid #667eea;
            border-radius: 15px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            margin: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s, opacity 0.3s;
            position: relative;
        }
        
        .dice::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: 15px;
            pointer-events: none;
        }

        .dice.rolling {
            animation: roll 0.3s infinite, shake 0.15s infinite, pulse 0.4s infinite;
            filter: drop-shadow(0 0 15px rgba(102, 126, 234, 0.9));
        }
        
        .dice.rolling .dice-content {
            animation: fadeInOut 0.5s infinite;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }

        @keyframes roll {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(90deg) scale(1.15); }
            50% { transform: rotate(180deg) scale(1.3); }
            75% { transform: rotate(270deg) scale(1.15); }
            100% { transform: rotate(360deg) scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0) translateY(0); }
            25% { transform: translateX(-8px) translateY(-5px); }
            50% { transform: translateX(8px) translateY(5px); }
            75% { transform: translateX(-5px) translateY(8px); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; filter: brightness(1); }
            50% { opacity: 0.8; filter: brightness(1.3); }
        }

        .roll-button {
            margin: 20px 0;
        }

        .users-section {
            margin-bottom: 20px;
        }

        .progress-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #667eea;
        }

        .progress-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .progress-bar-container {
            background: #e0e0e0;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .progress-text {
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 20px;
        }

        .not-rolled-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed #ddd;
        }

        .not-ordered-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed #ddd;
        }

        .not-rolled-title {
            font-size: 16px;
            font-weight: 600;
            color: #856404;
            margin-bottom: 12px;
        }

        .not-rolled-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 40px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .empty-not-rolled {
            color: #28a745;
            text-align: center;
            padding: 10px;
            font-weight: 600;
            width: 100%;
        }

        .users-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
        }

        .users-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 50px;
        }

        .user-tag {
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .user-tag.host {
            background: #667eea;
            color: white;
        }

        /* ì£¼ë¬¸ë°›ê¸° ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .orders-section {
            margin-bottom: 20px;
            display: none;
        }

        .orders-section.active {
            display: block;
        }

        .my-order-box {
            background: #fff9e6;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .my-order-title {
            font-size: 16px;
            font-weight: 600;
            color: #856404;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .order-input-group {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            position: relative;
        }

        .order-input-wrapper {
            position: relative;
            width: 100%;
        }

        .autocomplete-suggestion {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 12px;
            color: #999;
            pointer-events: none;
            font-family: inherit;
            font-size: 16px;
            line-height: 1.5;
            border: 2px solid transparent;
            border-radius: 8px;
            z-index: 1;
        }

        #myOrderInput {
            position: relative;
            z-index: 2;
            background-color: transparent;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            margin-top: 4px;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        .autocomplete-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background-color: #e3f2fd;
        }

        .menu-manager {
            background: #f8f9fa;
            border: 2px solid #667eea;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }

        .menu-manager.active {
            display: block;
        }

        .menu-manager-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .menu-manager-input {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
        }

        .menu-list {
            background: white;
            border-radius: 6px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
        }

        .menu-tag {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 14px;
            margin: 4px;
            position: relative;
        }

        .menu-tag .delete-btn {
            margin-left: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .menu-tag .delete-btn:hover {
            opacity: 0.8;
        }

        .order-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .order-item {
            background: white;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 3px solid #ffc107;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .order-item:last-child {
            margin-bottom: 0;
        }

        .order-item-left {
            flex: 1;
        }

        .order-user {
            font-weight: 600;
            color: #856404;
            margin-bottom: 4px;
        }

        .order-text {
            color: #666;
            font-size: 20px;
            font-weight: 600;
            word-break: break-word;
        }

        .order-text.empty {
            color: #999;
            font-style: italic;
        }

        .order-count {
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            margin-left: 15px;
        }

        .history-section {
            position: fixed;
            top: 20px;
            width: 320px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 20px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            z-index: 1000;
            display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€, ë°© ì…ì¥ ì‹œì—ë§Œ í‘œì‹œ */
        }
        
        /* ê²Œì„ ì„¹ì…˜ì´ í™œì„±í™”ë˜ì–´ ìˆì„ ë•Œ ê¸°ë¡ ì„¹ì…˜ì„ ì»¨í…Œì´ë„ˆ ë°”ë¡œ ì˜†ì— ë°°ì¹˜ */
        body.game-active .history-section {
            /* ì»¨í…Œì´ë„ˆ ì˜¤ë¥¸ìª½ ë ìœ„ì¹˜: (100vw - 1140px) / 2 + 160px + 800px
               ì»¨í…Œì´ë„ˆì™€ ê¸°ë¡ ì„¹ì…˜ ì‚¬ì´ ì—¬ë°±: 20px
               ê¸°ë¡ ì„¹ì…˜ ì™¼ìª½ ìœ„ì¹˜: (100vw - 1140px) / 2 + 160px + 800px + 20px
            */
            left: calc((100vw - 1140px) / 2 + 160px + 800px + 20px);
            right: auto;
        }
        
        .history-section.visible {
            display: block;
        }
        
        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ */
        @media (max-width: 768px) {
            /* ëª¨ë°”ì¼ì—ì„œëŠ” ì»¨í…Œì´ë„ˆë¥¼ ì „ì²´ ë„ˆë¹„ë¡œ ì‚¬ìš© */
            .container {
                max-width: 95vw;
                width: 95vw;
                margin: 20px auto;
                padding: 20px;
            }
            
            /* ëª¨ë°”ì¼ì—ì„œëŠ” ê²Œì„ ì„¹ì…˜ë„ ì¤‘ì•™ ì •ë ¬ */
            body.game-active .container {
                margin-left: auto;
                margin-right: auto;
                max-width: 95vw;
                width: 95vw;
            }
            
            /* ëª¨ë°”ì¼ì—ì„œëŠ” ê²Œì„ ê¸°ë¡ ì„¹ì…˜ì„ ìˆ¨ê¸°ê±°ë‚˜ í•˜ë‹¨ì— ë°°ì¹˜ */
            .history-section {
                position: relative;
                top: auto;
                left: auto;
                right: auto;
                width: 100%;
                max-width: 95vw;
                margin: 20px auto;
                max-height: 400px;
            }
            
            body.game-active .history-section {
                position: relative;
                left: auto;
                right: auto;
                width: 100%;
                max-width: 95vw;
                margin: 20px auto;
            }
        }
        
        .chat-section {
            margin-bottom: 0;
        }
        
        /* ì£¼ì‚¬ìœ„ ê²°ê³¼ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes diceRoll {
            0% {
                transform: scale(0.5) rotate(-180deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) rotate(0deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }
        
        .dice-result-animated {
            display: inline-block;
            animation: diceRoll 0.5s ease-out;
        }

        .history-title-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .history-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            white-space: nowrap; /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
        }

        .sort-buttons {
            display: flex;
            gap: 5px;
        }

        .sort-button {
            background: #f8f9fa;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: auto;
        }

        .sort-button:hover {
            background: #e3f2fd;
            transform: none;
        }

        .sort-button.active {
            background: #667eea;
            color: white;
        }

        .history-list {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            background: #f8f9fa;
            position: relative;
            z-index: 1;
            border-radius: 8px;
            padding: 15px;
        }

        .history-item {
            background: white;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .history-item:last-child {
            margin-bottom: 0;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        @keyframes slideDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .history-item.top-player-new {
            animation: fadeIn 0.5s ease-out;
        }

        .history-item.winner-glow {
            position: relative;
            background: linear-gradient(135deg, #fff9e6 0%, #ffffff 50%, #fff9e6 100%);
            border-left: 4px solid #28a745;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2), 0 0 30px rgba(255, 215, 0, 0.15);
            animation: winnerPulse 2s ease-in-out infinite;
            transform: scale(1);
        }

        @keyframes winnerPulse {
            0%, 100% {
                box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2), 0 0 30px rgba(255, 215, 0, 0.15);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 6px 20px rgba(40, 167, 69, 0.35), 0 0 40px rgba(255, 215, 0, 0.25);
                transform: scale(1.02);
            }
        }

        .history-item.winner-glow::before {
            content: 'âœ¨';
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 20px;
            animation: sparkle 1.5s ease-in-out infinite;
            z-index: 1;
            filter: drop-shadow(0 0 3px rgba(255, 215, 0, 0.8));
        }

        @keyframes sparkle {
            0%, 100% {
                opacity: 0.6;
                transform: scale(0.8) rotate(0deg);
            }
            50% {
                opacity: 1;
                transform: scale(1.2) rotate(180deg);
            }
        }

        .history-item.winner-glow::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 6px;
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(255, 255, 255, 0.3) 50%,
                transparent 70%
            );
            background-size: 200% 200%;
            animation: shimmer 3s linear infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }

        .history-item.winner-glow > * {
            position: relative;
            z-index: 1;
        }

        .history-user {
            font-weight: 600;
            color: #667eea;
        }

        .top-player-badge {
            display: inline-flex;
            align-items: center;
            background: #ff6b6b;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 6px;
        }

        .winner-badge {
            display: inline-flex;
            align-items: center;
            background: #28a745;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 6px;
        }

        .history-result {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .history-time {
            font-size: 12px;
            color: #999;
        }

        .history-range {
            font-size: 12px;
            color: #667eea;
            font-weight: 600;
        }

        .empty-history {
            text-align: center;
            color: #999;
            padding: 20px;
        }

        .logout-button {
            background: #dc3545;
            margin-top: 10px;
        }

        .logout-button:hover {
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
        }

        .dice-settings {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #2196f3;
        }

        .dice-settings-title {
            font-size: 16px;
            font-weight: 600;
            color: #1976d2;
            margin-bottom: 10px;
        }

        .dice-range-inputs {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: end;
        }

        .reconnect-notice {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .reconnect-notice strong {
            color: #856404;
            font-size: 16px;
        }

        .reconnect-notice p {
            color: #856404;
            margin-top: 8px;
            font-size: 14px;
        }

        .order-button {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        }

        .order-button:hover {
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.4);
        }

        .clear-data-button {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .clear-data-button:hover {
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
        }
        @keyframes newBadgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
    </style>
</head>
<body>
    <header style="background-color: #f8f9fa; padding: 15px 20px; border-bottom: 1px solid #e7e7e7;">
        <nav style="display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto;">
            <h1 style="margin: 0; font-size: 1.5em;"><a href="/" style="text-decoration: none; color: #333;">LAMDice ì£¼ì‚¬ìœ„ ê²Œì„</a></h1>
            <div class="nav-links">
                <a href="dice-rules-guide.html" style="margin-left: 20px; text-decoration: none; color: #007bff;">ë‹¤ì–‘í•œ ì£¼ì‚¬ìœ„ ê·œì¹™</a>
                <a href="probability-analysis.html" style="margin-left: 20px; text-decoration: none; color: #007bff;">í™•ë¥  ë¶„ì„ ë° íŒ</a>
                <a href="about-us.html" style="margin-left: 20px; text-decoration: none; color: #007bff;">ì‚¬ì´íŠ¸ ì†Œê°œ</a>
            </div>
        </nav>
    </header>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h1 style="margin: 0;">ğŸ² LAM Dice :)</h1>
            <div id="visitorStats" style="text-align: right; color: #667eea; font-size: 14px; line-height: 1.6;">
                <div style="font-size:11px;color:#999;margin-bottom:2px;">ì „ì²´ ì„œë²„ í†µí•©</div>
                <div>ì˜¤ëŠ˜ ë°©ë¬¸ì ìˆ˜: <strong id="todayVisitorCount">0</strong>ëª…</div>
                <div>ì˜¤ëŠ˜ í”Œë ˆì´ íšŸìˆ˜: <strong id="todayPlayCount">0</strong>íšŒ</div>
                <div>ì´ í”Œë ˆì´ íšŸìˆ˜: <strong id="totalPlayCount">0</strong>íšŒ</div>
            </div>
        </div>

        <!-- ëŒ€ê¸°ì‹¤ ì„¹ì…˜ -->
        <div class="lobby-section" id="lobbySection">
            <!-- ì„œë²„ ì •ë³´ ë°” (ì„œë²„ ì„ íƒ ì‹œ í‘œì‹œ) -->
            <div id="serverInfoBar" style="display:none; background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border: 1px solid #667eea; border-radius: 8px; padding: 10px 15px; margin-bottom: 15px; align-items: center; justify-content: space-between;">
                <button onclick="ServerSelectModule.show()" style="width: auto; padding: 6px 12px; font-size: 13px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">â† ì„œë²„ ëª©ë¡</button>
                <span id="serverInfoName" style="font-weight: bold; color: #667eea;"></span>
                <span id="serverInfoUserName" style="font-weight: 600; color: #764ba2; display: none;">ğŸ‘¤ </span>
                <button id="serverMembersBtn" onclick="ServerSelectModule.showMembersModal()" style="width: auto; padding: 6px 12px; font-size: 13px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">ğŸ‘¥ ë©¤ë²„</button>
            </div>
            <div class="create-room-button-section" style="background: #f8f9fa; border: 2px solid #667eea; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h2 style="margin-bottom: 15px; color: #667eea;">ë°© ë§Œë“¤ê¸°</h2>
                <button onclick="showCreateRoomPage()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin-bottom: 15px;">ë°© ìƒì„±í•˜ê¸°</button>
                <button onclick="RankingModule.show()" style="background: white; border: 2px solid #667eea; color: #667eea; margin-bottom: 15px; font-weight: 600;">ë­í‚¹</button>
                <div class="input-group" style="margin: 0; display: none;">
                    <label for="globalUserNameInput">ì´ë¦„</label>
                    <input type="text" id="globalUserNameInput" placeholder="ì´ë¦„ ì…ë ¥" maxlength="20" />
                    <div id="userNameError" style="color: #dc3545; font-size: 12px; margin-top: 5px; display: none;"></div>
                </div>
            </div>
            
            <div class="join-room-section">
                <h2 style="margin-bottom: 15px; color: #667eea;">ë°© ëª©ë¡</h2>
                <button onclick="refreshRooms()" style="width: auto; padding: 8px 16px; margin-bottom: 15px; background: #6c757d;">ìƒˆë¡œê³ ì¹¨</button>
                <div class="rooms-list" id="roomsList">
                    <div style="color: #999; text-align: center; padding: 20px;">ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
                
                <!-- Google AdSense ê´‘ê³ : ë°˜ì‘í˜• ë°•ìŠ¤ -->
                <div style="margin: 20px 0; text-align: center;">
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-1608259764663412"
                         data-ad-slot="YOUR_SLOT_ID"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>
                        (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
                
            </div>
            
            <!-- ì—…ë°ì´íŠ¸ ë‚´ì—­ -->
            <div class="update-log-section" style="background: #f8f9fa; border: 2px solid #667eea; border-radius: 12px; padding: 20px; margin-top: 20px;">
                <h2 style="margin-bottom: 15px; color: #667eea;">ğŸ“ ì—…ë°ì´íŠ¸ ë‚´ì—­</h2>
                <div class="update-log-content" id="updateLogContent" style="background: white; border-radius: 8px; padding: 15px; max-height: 300px; overflow-y: auto; white-space: pre-wrap; line-height: 1.8; color: #333; font-size: 14px;">
ì—…ë°ì´íŠ¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </div>
            </div>
        </div>

        <!-- ë°© ìƒì„± í˜ì´ì§€ -->
        <div class="create-room-section" id="createRoomSection">
            <div style="margin-bottom: 20px;">
                <button onclick="goBackToLobby()" style="width: auto; padding: 10px 20px; margin-bottom: 15px; background: #6c757d;">â† ëŒ€ê¸°ì‹¤ë¡œ ëŒì•„ê°€ê¸°</button>
                <h2 style="margin-bottom: 20px; color: #667eea;">ë°© ë§Œë“¤ê¸°</h2>
            </div>
            
            <!-- ë¡œê³  ë° ì—°ê²° ìƒíƒœ -->
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="display: inline-flex; align-items: center; gap: 10px;">
                    <span style="font-size: 24px;">ğŸ²</span>
                    <span style="font-size: 20px; font-weight: 600; color: #667eea;">LAM Dice :)</span>
                    <span class="connection-status connected" id="createRoomConnectionStatus">â— ì—°ê²°ë¨</span>
                </div>
            </div>
            
            <!-- ë°© ì œëª© ì…ë ¥ -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #667eea;">
                <div class="input-group" style="margin-bottom: 0;">
                    <label for="createRoomNameInput">ë°© ì œëª©</label>
                    <input type="text" id="createRoomNameInput" placeholder="ë°© ì œëª© ì…ë ¥" maxlength="30" />
                </div>
            </div>
            
            <!-- ê³µê°œ/ë¹„ê³µê°œ ì„¤ì • -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #667eea;">
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                    <input type="checkbox" id="createRoomPrivateCheckbox" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;" />
                    <label for="createRoomPrivateCheckbox" style="cursor: pointer; font-weight: 500; margin: 0;">ë¹„ê³µê°œ ë°©</label>
                </div>
                <div id="createRoomPasswordContainer" style="display: none;">
                    <div class="input-group" style="margin-bottom: 0;">
                        <label for="createRoomPasswordInput">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="createRoomPasswordInput" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ (4~20ì)" maxlength="20" />
                    </div>
                </div>
            </div>
            
            <!-- ë°© ìœ ì§€ ì‹œê°„ ì„¤ì • -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #667eea;">
                <label style="display: block; margin-bottom: 10px; font-weight: 500;">â° ë°© ìœ ì§€ ì‹œê°„</label>
                <div style="display: flex; gap: 10px;">
                    <label style="display: flex; align-items: center; cursor: pointer; flex: 1;">
                        <input type="radio" name="roomExpiryTime" value="1" style="width: 20px; height: 20px; margin-right: 8px; cursor: pointer;" />
                        <span>1ì‹œê°„</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; flex: 1;">
                        <input type="radio" name="roomExpiryTime" value="3" checked style="width: 20px; height: 20px; margin-right: 8px; cursor: pointer;" />
                        <span>3ì‹œê°„ (ê¸°ë³¸)</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; flex: 1;">
                        <input type="radio" name="roomExpiryTime" value="6" style="width: 20px; height: 20px; margin-right: 8px; cursor: pointer;" />
                        <span>6ì‹œê°„</span>
                    </label>
                </div>
            </div>
            
            <!-- ê²Œì„ íƒ€ì… ì„ íƒ -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #667eea;">
                <label style="display: block; margin-bottom: 10px; font-weight: 500;">ğŸ® ê²Œì„ íƒ€ì…</label>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; cursor: pointer; flex: 1; min-width: 120px; padding: 15px; background: white; border-radius: 8px; border: 2px solid #667eea;">
                        <input type="radio" name="gameType" value="dice" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;" />
                        <span style="font-size: 24px; margin-right: 8px;">ğŸ²</span>
                        <span style="font-weight: 600;">ì£¼ì‚¬ìœ„</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; flex: 1; min-width: 120px; padding: 15px; background: white; border-radius: 8px; border: 2px solid #e91e63;">
                        <input type="radio" name="gameType" value="roulette" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;" />
                        <span style="font-size: 24px; margin-right: 8px;">ğŸ°</span>
                        <span style="font-weight: 600;">ë£°ë ›</span>
                    </label>
                    <label id="horseRaceLabel" style="display: flex; align-items: center; cursor: pointer; flex: 1; min-width: 120px; padding: 15px; background: white; border-radius: 8px; border: 2px solid #8b4513; position: relative;">
                        <input type="radio" name="gameType" value="horse-race" id="horseRaceRadio" checked style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;" />
                        <span style="font-size: 24px; margin-right: 8px;">ğŸ</span>
                        <span style="font-weight: 600;">ê²½ë§ˆ</span>
                        <span id="horseRaceNewBadge" style="position: absolute; top: -8px; right: -8px; background: #e94560; color: #fff; font-size: 10px; font-weight: bold; padding: 2px 8px; border-radius: 10px; letter-spacing: 1px; box-shadow: 0 2px 6px rgba(233,69,96,0.4); animation: newBadgePulse 2s ease-in-out infinite;">NEW</span>
                    </label>
                                   
                </div>
                <div id="gameTypeInfo" style="margin-top: 8px; font-size: 12px; color: #666;">
                    ë£°ë ›/ê²½ë§ˆë¥¼ ì„ íƒí•˜ë©´ ì „ìš© í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.
                </div>
                <script>
                    // ê²Œì„ íƒ€ì… ì„ íƒ ì‹œ ì‹œê°ì  ê°•ì¡° (ì€ì€í•œ í‹´íŠ¸)
                    (function() {
                        const colorMap = { dice: '#667eea', roulette: '#e91e63', 'horse-race': '#8b4513' };
                        function updateGameTypeStyle() {
                            document.querySelectorAll('input[name="gameType"]').forEach(radio => {
                                const label = radio.closest('label');
                                const color = colorMap[radio.value] || '#667eea';
                                if (radio.checked) {
                                    label.style.background = `${color}12`;
                                    label.style.color = '';
                                    label.style.borderColor = color;
                                    label.style.borderWidth = '2.5px';
                                    label.style.boxShadow = `0 2px 8px ${color}20`;
                                    label.querySelectorAll('span:not([id])').forEach(s => s.style.color = '');
                                } else {
                                    label.style.background = 'white';
                                    label.style.color = '';
                                    label.style.borderColor = '#e0e0e0';
                                    label.style.borderWidth = '1px';
                                    label.style.boxShadow = 'none';
                                    label.querySelectorAll('span:not([id])').forEach(s => s.style.color = '');
                                }
                            });
                        }
                        document.querySelectorAll('input[name="gameType"]').forEach(r => r.addEventListener('change', updateGameTypeStyle));
                        updateGameTypeStyle();
                    })();
                    // ê²½ë§ˆ NEW ë°°ì§€ + íˆ´íŒ: 2026-02-08 ì´í›„ ìˆ¨ê¹€
                    (function() {
                        const hideDate = new Date('2026-02-08T00:00:00+09:00');
                        if (new Date() > hideDate) {
                            const badge = document.getElementById('horseRaceNewBadge');
                            if (badge) badge.style.display = 'none';
                            // íˆ´íŒ CSS ì œê±°
                            const style = document.createElement('style');
                            style.textContent = '#horseRaceLabel::after, #horseRaceLabel::before { display: none !important; }';
                            document.head.appendChild(style);
                        }
                    })();
                </script>
            </div>
            
            <!-- ë°© ìƒì„±í•˜ê¸° ë²„íŠ¼ (ë§¨ ì•„ë˜) -->
            <button onclick="finalizeRoomCreation()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin-top: 30px; width: 100%;">ë°© ìƒì„±í•˜ê¸°</button>
        </div>

        <!-- ê²Œì„ ì„¹ì…˜ -->
        <div class="game-section" id="gameSection">
            <div class="user-info">
                <div>
                    <span class="user-name" id="currentUser"></span>
                    <span class="host-badge" id="hostBadge" style="display: none;">HOST</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span id="roomStatusIcons" style="display: flex; align-items: center; gap: 5px;"></span>
                    <span class="connection-sound-row">
                        <span class="connection-status connected" id="connectionStatus">â— ì—°ê²°ë¨</span>
                        <div class="volume-control" id="volumeControl">
                            <button class="volume-btn" id="volumeBtn" title="ìŒì†Œê±° í† ê¸€">ğŸ”‡</button>
                            <input type="range" class="volume-slider muted" id="volumeSlider" min="0" max="100" value="50">
                        </div>
                    </span>
                    <span id="roomPasswordDisplay" style="font-size: 12px; color: #667eea; font-weight: 500; display: none;"></span>
                </div>
            </div>
            
            <!-- ì¬ì ‘ì† ì•Œë¦¼ -->
            <div class="reconnect-notice" id="reconnectNotice" style="display: none;">
                <strong>ğŸ”„ ì¬ì ‘ì†í•˜ì…¨ìŠµë‹ˆë‹¤!</strong>
                <p id="reconnectMessage"></p>
            </div>

            <!-- 1. ë°© ì œëª© -->
            <div class="room-info-section" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #667eea;">
                <div id="roomNameDisplay" style="font-size: 18px; font-weight: 600; color: #667eea; margin-bottom: 10px;">
                    <span id="roomNameText">ë°© ì œëª©</span>
                </div>
                <div id="roomNameEditSection" style="display: none;">
                    <div class="input-group" style="margin-bottom: 10px;">
                        <input type="text" id="roomNameInput" placeholder="ë°© ì œëª© ì…ë ¥" maxlength="30" />
                    </div>
                    <button onclick="saveRoomName()" style="width: auto; padding: 8px 16px; margin-right: 10px;">ì €ì¥</button>
                    <button onclick="cancelRoomNameEdit()" style="width: auto; padding: 8px 16px; background: #6c757d;">ì·¨ì†Œ</button>
                </div>
                <button id="editRoomNameButton" onclick="editRoomName()" style="width: auto; padding: 8px 16px; font-size: 14px; display: none;">ë°© ì œëª© ë³€ê²½</button>
            </div>

            <!-- 2. ê²Œì„ ë£° ì„¹ì…˜ -->
            <div class="game-rules-section" id="gameRulesSection" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #667eea;">
                <div class="dice-settings-title">ğŸ“‹ ê²Œì„ ë£°</div>
                
                <!-- ë°©ì¥ ì „ìš©: ê²Œì„ ë£° ì„ íƒ ë¼ë””ì˜¤ ë²„íŠ¼ -->
                <div id="gameRulesRadioSection" style="display: none; margin-bottom: 15px;">
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="display: flex; align-items: center; padding: 10px; background: white; border: 2px solid #667eea; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                            <input type="radio" name="gameRule" value="high" id="gameRuleHigh" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;" />
                            <span style="font-weight: 500;">í•˜ì´ - ë‚®ì€ ì‚¬ëŒì´ ê±¸ë¦¼</span>
                        </label>
                        <label style="display: flex; align-items: center; padding: 10px; background: white; border: 2px solid #667eea; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                            <input type="radio" name="gameRule" value="low" id="gameRuleLow" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;" />
                            <span style="font-weight: 500;">ë¡œìš° - ë†’ì€ ì‚¬ëŒì´ ê±¸ë¦¼</span>
                        </label>
                        <label style="display: flex; align-items: center; padding: 10px; background: white; border: 2px solid #667eea; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                            <input type="radio" name="gameRule" value="near" id="gameRuleNear" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;" />
                            <span style="font-weight: 500;">ë‹ˆì–´ - Nì— ê°€ê¹Œìš´ ì‚¬ëŒ ê±¸ë¦¬ê¸°</span>
                        </label>
                        <div id="gameNearNumberContainer" style="display: none; margin-left: 30px; margin-top: 5px;">
                            <div class="input-group" style="margin-bottom: 0;">
                                <input type="number" id="gameNearNumberInput" placeholder="ìˆ«ì ì…ë ¥" min="1" max="100000" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                            </div>
                        </div>
                        <label style="display: flex; align-items: center; padding: 10px; background: white; border: 2px solid #667eea; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                            <input type="radio" name="gameRule" value="custom" id="gameRuleCustom" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;" />
                            <span style="font-weight: 500;">ê¸°íƒ€ - ì§ì ‘ ë£° ì ê¸°</span>
                        </label>
                        <div id="gameCustomRuleContainer" style="display: none; margin-left: 30px; margin-top: 5px;">
                            <div class="input-group" style="margin-bottom: 0;">
                                <textarea id="gameCustomRuleInput" placeholder="ê²Œì„ ë£°ì„ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”" maxlength="500" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ì„ íƒëœ ë£° í‘œì‹œ (ëª¨ë“  ì‚¬ìš©ìì—ê²Œ í‘œì‹œ) -->
                <div class="input-group">
                    <textarea 
                        id="gameRulesInput" 
                        placeholder="ê²Œì„ ë£°ì„ ì…ë ¥í•˜ì„¸ìš”. (í•˜ì´,ë¡œìš°,ë‹ˆì–´ ë“± ë‹¤ì–‘í•˜ê²Œ ì ìœ¼ì‹œë©´ ë©ë‹ˆë‹¤.) "
                        maxlength="500"
                        rows="3"
                        disabled
                    ></textarea>
                </div>
                <button onclick="updateGameRules()" id="gameRulesSaveButton" style="width: auto; padding: 12px 20px; display: none;" disabled>ì €ì¥</button>
                <div style="margin-top: 8px; font-size: 12px; color: #999;">
                    ê²Œì„ ì‹œì‘ ì „ì—ë§Œ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤
                </div>
            </div>


            <!-- ì ‘ì†ì ë¦¬ìŠ¤íŠ¸ -->
            <div class="users-section">
                <div class="users-title">
                    ğŸ‘¥ ì ‘ì†ì (<span id="userCount">0</span>ëª…)
                    <span id="dragHint" style="display: none; font-size: 12px; color: #667eea; font-weight: normal; margin-left: 10px;">
                        ğŸ’¡ ë“œë˜ê·¸ë¡œ ì¤€ë¹„ ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </span>
                </div>
                <div class="users-list" id="usersList">
                    <div style="color: #999; text-align: center; padding: 10px; width: 100%;">ì ‘ì†ìê°€ ì—†ìŠµë‹ˆë‹¤</div>
                </div>
            </div>
            
            <!-- ë°© í­íŒŒê¹Œì§€ ë‚¨ì€ ì‹œê°„ -->
            <div class="room-expiry-section" id="roomExpirySection" style="display: none; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 12px; margin-bottom: 20px; text-align: center;">
                <div style="color: #856404; font-weight: bold; font-size: 14px;">
                    â° ë°© í­íŒŒê¹Œì§€ ë‚¨ì€ ì‹œê°„: <span id="roomExpiryCountdown" style="color: #d9534f;">--:--:--</span>
                </div>
            </div>
            
            <!-- ì¤€ë¹„ ìƒíƒœ -->
            <div class="ready-section" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #667eea; display: none;" id="readySection">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="users-title" style="margin: 0;">âœ… ì¤€ë¹„í•œ ì‚¬ëŒ (<span id="readyCount">0</span>ëª…)</div>
                    <button id="readyButton" onclick="toggleReady()" style="width: auto; padding: 10px 20px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">ì¤€ë¹„</button>
                </div>
                <div class="users-list" id="readyUsersList" style="min-height: 50px;">
                    <div style="color: #999; text-align: center; padding: 10px; width: 100%;">ì•„ì§ ì¤€ë¹„í•œ ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤</div>
                </div>
            </div>

            <!-- Host ì „ìš© ì»¨íŠ¸ë¡¤ -->
            <div class="host-controls" id="hostControls" style="display: none;">
                <button onclick="startGame()" id="startButton">ê²Œì„ ì‹œì‘</button>
                <button onclick="endGame()" id="endButton" style="display: none;">ê²Œì„ ì¢…ë£Œ</button>
                <button onclick="OrderModule.startOrder()" id="startOrderButton" class="order-button" style="display: none;">ì£¼ë¬¸ë°›ê¸° ì‹œì‘</button>
                <button onclick="OrderModule.endOrder()" id="endOrderButton" class="order-button" style="display: none;">ì£¼ë¬¸ë°›ê¸° ì¢…ë£Œ</button>
                <button onclick="clearGameData()" id="clearDataButton" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">ì´ì „ ê²Œì„ ë°ì´í„° ì‚­ì œ</button>
            </div>

            <!-- ì£¼ë¬¸ë°›ê¸° ì„¹ì…˜ -->
            <div class="orders-section" id="ordersSection">
                <div class="history-title-wrapper">
                    <div class="users-title">ğŸ” ì£¼ë¬¸ë°›ê¸°</div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button onclick="OrderModule.showOrderList()" id="showOrderListButton" class="order-button" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 8px 16px; font-size: 14px;">ğŸ“‹ ì£¼ë¬¸ë¦¬ìŠ¤íŠ¸ ë³´ê¸°</button>
                        <div class="sort-buttons">
                            <button class="sort-button active" id="sortOrderAscBtn" onclick="OrderModule.sortOrders('asc')">ê°€ë‚˜ë‹¤ìˆœ</button>
                            <button class="sort-button" id="sortOrderDescBtn" onclick="OrderModule.sortOrders('desc')">ê°€ë‚˜ë‹¤ ì—­ìˆœ</button>
                            <button class="sort-button" id="sortOrderCountBtn" onclick="OrderModule.sortOrders('count')">ì£¼ë¬¸ ë§ì€ ìˆœ</button>
                        </div>
                    </div>
                </div>
                
                <!-- ì£¼ë¬¸í•˜ì§€ ì•Šì€ ì‚¬ëŒ ëª©ë¡ -->
                <div class="not-ordered-section" id="notOrderedSection" style="display: none;">
                    <div class="not-rolled-title" style="margin-top: 15px;">â³ ì£¼ë¬¸í•˜ì§€ ì•Šì€ ì‚¬ëŒ</div>
                    <div class="not-rolled-list" id="notOrderedList">
                        <!-- ì£¼ë¬¸í•˜ì§€ ì•Šì€ ì‚¬ëŒ ëª©ë¡ -->
                    </div>
                </div>

                <!-- ë‚´ ì£¼ë¬¸ ì…ë ¥ -->
                <div class="my-order-box">
                    <div class="my-order-title">
                        <span>ğŸ“</span>
                        <span>ë‚´ ì£¼ë¬¸</span>
                        <button onclick="OrderModule.toggleMenuManager()" style="width: auto; padding: 6px 12px; font-size: 12px; margin-left: auto; background: #f8f9fa; color: #667eea; border: 1px solid #667eea;">ë©”ë‰´ ê´€ë¦¬</button>
                    </div>
                    
                    <!-- ìì£¼ ì“°ëŠ” ë©”ë‰´ ê´€ë¦¬ -->
                    <div class="menu-manager" id="menuManager">
                        <div class="menu-manager-title">
                            <span>ğŸ“‹ ìì£¼ ì“°ëŠ” ë©”ë‰´</span>
                            <button onclick="OrderModule.toggleMenuManager()" style="width: auto; padding: 4px 8px; font-size: 12px; background: #dc3545; color: white; border: none; border-radius: 4px;">ë‹«ê¸°</button>
                        </div>
                        <div class="menu-manager-input">
                            <input type="text" id="menuInput" placeholder="ë©”ë‰´ ì¶”ê°€ (ì˜ˆ: ì¹˜í‚¨)" maxlength="50" />
                            <button onclick="OrderModule.addMenu()" style="width: auto; padding: 12px 20px; height: fit-content;">ì¶”ê°€</button>
                        </div>
                        <div class="menu-list" id="menuList">
                            <!-- ë©”ë‰´ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </div>
                    </div>
                    
                    <div class="order-input-group">
                        <div class="order-input-wrapper">
                            <div class="autocomplete-suggestion" id="autocompleteSuggestion"></div>
                            <input 
                                type="text"
                                id="myOrderInput" 
                                placeholder="ì£¼ë¬¸í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì˜¤ì´ˆ, ì˜¤ê³ )"
                                maxlength="100"
                                disabled
                            />
                            <div class="autocomplete-dropdown" id="autocompleteDropdown" style="display: none;"></div>
                        </div>
                        <button onclick="OrderModule.updateMyOrder()" id="orderSaveButton" style="width: auto; padding: 12px 20px; height: fit-content;" disabled>ì €ì¥</button>
                    </div>
                </div>

                <!-- ì „ì²´ ì£¼ë¬¸ ëª©ë¡ -->
                <div class="order-list" id="orderList">
                    <div style="color: #999; text-align: center; padding: 10px;">ì•„ì§ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤</div>
                </div>
                
                <!-- ê´€ì „ì ì£¼ë¬¸ ëª©ë¡ -->
                <div class="spectator-orders-section" id="spectatorOrdersSection" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                    <div class="users-title" style="margin-bottom: 15px; color: #999; font-size: 14px;">ğŸ‘ï¸ ê´€ì „ì ì£¼ë¬¸ (ê²Œì„ ì°¸ì—¬ í›„ ë©”ë‰´ë¥¼ ë‹¤ì‹œ ê³¨ë¼ì£¼ì‹œë©´ë©ë‹ˆë‹¤)</div>
                    <div class="order-list" id="spectatorOrderList">
                    </div>
                </div>
            </div>

            <!-- ê²Œì„ ìƒíƒœ í‘œì‹œ -->
            <div class="game-status waiting" id="gameStatus">
                ê²Œì„ ëŒ€ê¸° ì¤‘...
            </div>

            <!-- ì§„í–‰ ìƒí™© í‘œì‹œ -->
            <div class="progress-section" id="progressSection" style="display: none;">
                <div class="progress-title">ğŸ“Š ì§„í–‰ ìƒí™©</div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="progress-text">
                    <span id="progressCount">0/0</span> ëª… ì™„ë£Œ
                </div>
            </div>

            <!-- ì£¼ì‚¬ìœ„ë¥¼ êµ´ë¦¬ì§€ ì•Šì€ ì‚¬ëŒ -->
            <div class="not-rolled-section" id="notRolledSection" style="display: none;">
                <div class="not-rolled-title">â³ ì£¼ì‚¬ìœ„ë¥¼ êµ´ë¦¬ì§€ ì•Šì€ ì‚¬ëŒ</div>
                <div class="not-rolled-list" id="notRolledList">
                    <!-- ë¯¸ì™„ë£Œì ëª©ë¡ -->
                </div>
            </div>

            <!-- ì±„íŒ… ì„¹ì…˜ -->
            <div class="chat-history-wrapper">
                <div class="chat-section">
                    <div class="users-title" style="margin-bottom: 10px;">ğŸ’¬ ì±„íŒ… </div>
                    <div class="chat-messages" id="chatMessages" style="background: #f8f9fa; border-radius: 8px; padding: 15px; max-height: 480px; overflow-y: auto; margin-bottom: 10px; border: 2px solid #667eea;">
                        <div style="color: #999; text-align: center; padding: 10px;">ì±„íŒ… ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px;">
                        <div style="position: relative;">
                            <div class="autocomplete-suggestion" id="chatAutocompleteSuggestion" style="position: absolute; top: 10px; left: 10px; pointer-events: none; z-index: 10;"></div>
                            <input type="text" id="chatInput" placeholder="/ì£¼ì‚¬ìœ„ - ì…ë ¥í•˜ì‹œë©´ ì£¼ì‚¬ìœ„ë¥¼ êµ´ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤." maxlength="200" style="padding: 10px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px; position: relative; background: transparent;" />
                            <div class="autocomplete-dropdown" id="chatAutocompleteDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1000;"></div>
                        </div>
                        <button onclick="sendChatMessage()" style="width: auto; padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">ì „ì†¡</button>
                    </div>
                </div>
            </div>

            <button class="logout-button" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <!-- ê¸°ë¡ ì„¹ì…˜ (ì˜¤ë¥¸ìª½ ê³ ì •) -->
    <div class="history-section">
        <div class="history-title-wrapper">
            <div class="history-title" id="historyTitle">ğŸ“‹ ê²Œì„ ê¸°ë¡ - ì—°ìŠµê²½ê¸°</div>
            <div class="sort-buttons">
                <button class="sort-button active" id="sortTimeBtn" onclick="sortHistory('time')">ì‹œê°„ìˆœ</button>
                <button class="sort-button" id="sortAscBtn" onclick="sortHistory('asc')">ì˜¤ë¦„ì°¨ìˆœ</button>
                <button class="sort-button" id="sortDescBtn" onclick="sortHistory('desc')">ë‚´ë¦¼ì°¨ìˆœ</button>
            </div>
        </div>
        <div class="history-list" id="historyList">
            <div class="empty-history">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>
        </div>
        <div class="rolled-users-info" id="rolledUsersInfo" style="text-align: right; margin-top: 10px; padding-top: 10px; border-top: 1px solid #e0e0e0; color: #666; font-size: 14px;">
            ì´ ê¸°ë¡: <span id="rolledUsersCount">0</span>
        </div>
    </div>

    <!-- ë””ë²„ê·¸ ë¡œê·¸ ì„¹ì…˜ -->
    <div class="debug-log-section" id="debugLogSection" style="position: fixed; bottom: 20px; right: 20px; width: 400px; max-height: 300px; background: rgba(0, 0, 0, 0.9); color: #0f0; border-radius: 8px; padding: 15px; font-family: 'Courier New', monospace; font-size: 11px; z-index: 10000; overflow-y: auto; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #0f0; padding-bottom: 5px;">
            <div style="font-weight: bold; color: #0f0;">ğŸ› ë””ë²„ê·¸ ë¡œê·¸</div>
            <div style="display: flex; gap: 5px;">
                <button onclick="clearDebugLog()" style="background: #333; color: #0f0; border: 1px solid #0f0; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;">ì§€ìš°ê¸°</button>
                <button onclick="toggleDebugLog()" style="background: #333; color: #0f0; border: 1px solid #0f0; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;">ìˆ¨ê¸°ê¸°</button>
            </div>
        </div>
        <div id="debugLogContent" style="line-height: 1.4;"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/page-history-shared.js"></script>
    <script src="/server-select-shared.js"></script>
    <script src="/chat-shared.js"></script>
    <script src="/ready-shared.js"></script>
    <script src="/order-shared.js"></script>
    <script src="/ranking-shared.js"></script>
    <script src="/assets/sounds/sound-manager.js"></script>
    <script>
        const socket = io();
        let currentServerId = null;
        let currentServerName = null;

        // ì„œë²„ ì„ íƒ UI ì´ˆê¸°í™”
        ServerSelectModule.init(socket, (selection) => {
            document.body.classList.remove('server-select-active');
            currentServerId = selection.serverId;
            currentServerName = selection.serverName || null;
            // ì„¸ì…˜ì— ì„œë²„ ì„ íƒ ì €ì¥ (ìƒˆë¡œê³ ì¹¨ ì‹œ ë¡œë¹„ ìœ ì§€)
            sessionStorage.setItem('diceSession', JSON.stringify({
                serverId: selection.serverId,
                serverName: selection.serverName,
                hostName: selection.hostName
            }));
            if (selection.serverName) {
                document.title = `${selection.serverName} - LAM Dice :)`;
            }
            // ì„œë²„ ì •ë³´ ë°” í‘œì‹œ (í•­ìƒ í‘œì‹œ - ì„œë²„ ëª©ë¡ ë³µê·€ ë²„íŠ¼ í¬í•¨)
            const infoBar = document.getElementById('serverInfoBar');
            infoBar.style.display = 'flex';
            const membersBtn = document.getElementById('serverMembersBtn');
            const userNameSpan = document.getElementById('serverInfoUserName');
            const userName = localStorage.getItem('userName') || '';
            if (selection.serverId && selection.serverName) {
                document.getElementById('serverInfoName').textContent = `ğŸ–¥ï¸ ${selection.serverName}`;
                document.getElementById('serverInfoName').style.display = '';
                if (membersBtn) membersBtn.style.display = '';
            } else {
                document.getElementById('serverInfoName').style.display = 'none';
                if (membersBtn) membersBtn.style.display = 'none';
            }
            if (userName && userNameSpan) {
                userNameSpan.textContent = `ğŸ‘¤ ${userName}`;
                userNameSpan.style.display = '';
            }
            // globalUserNameInputì— ì´ë¦„ ë™ê¸°í™”
            const globalInput = document.getElementById('globalUserNameInput');
            if (globalInput && userName && !globalInput.value) globalInput.value = userName;
            document.getElementById('lobbySection').classList.add('active');
            RankingModule.init(selection.serverId, userName || document.getElementById('globalUserNameInput')?.value || '');
        }, () => {
            document.body.classList.add('server-select-active');
            document.getElementById('lobbySection').classList.remove('active');
            sessionStorage.removeItem('diceSession');
        });
        // íˆìŠ¤í† ë¦¬ ë§¤ë‹ˆì € ì´ˆê¸°í™”
        PageHistoryManager.init({
            onServerSelect: function () {
                sessionStorage.removeItem('diceSession');
                document.body.classList.add('server-select-active');
                document.getElementById('lobbySection').classList.remove('active');
                document.getElementById('createRoomSection').classList.remove('active');
                document.getElementById('gameSection').classList.remove('active');
                document.body.classList.remove('game-active');
                document.body.classList.add('lobby-active');
                ServerSelectModule.show();
            },
            onLobby: function () {
                document.getElementById('createRoomSection').classList.remove('active');
                document.getElementById('gameSection').classList.remove('active');
                document.getElementById('lobbySection').classList.add('active');
                document.body.classList.remove('game-active');
                document.body.classList.add('lobby-active');
            },
            onLeaveRoom: function () {
                if (currentRoomId) {
                    socket.emit('leaveRoom');
                }
            },
            onHideRanking: function () {
                RankingModule.forceHide();
            },
            getCurrentPage: function () {
                if (document.getElementById('ranking-overlay')) return 'ranking';
                if (document.getElementById('gameSection').classList.contains('active')) return 'gameRoom';
                if (document.getElementById('createRoomSection').classList.contains('active')) return 'createRoom';
                if (document.getElementById('serverSelectOverlay')) return 'serverSelect';
                return 'lobby';
            }
        });

        // í˜ì´ì§€ ë¡œë“œ/ìƒˆë¡œê³ ì¹¨ ì‹œ í•­ìƒ ì„œë²„ ì„ íƒ í™”ë©´ í‘œì‹œ (ë¡œë¹„ ë³µì› ì•ˆ í•¨)
        sessionStorage.removeItem('returnToLobby');
        document.body.classList.add('server-select-active');
        document.getElementById('lobbySection').classList.remove('active');
        ServerSelectModule.show();

        // ì•„ì´ë”” ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜ (í•œê¸€, ì˜ë¬¸ ì†Œë¬¸ì, ìˆ«ì, _, - í—ˆìš©)
        function validateUserId(userId) {
            if (!userId || typeof userId !== 'string') return false;
            // í—ˆìš© ë¬¸ì: í•œê¸€(ì™„ì„±í˜•+ìëª¨ìŒ), ì˜ë¬¸ ì†Œë¬¸ì, ìˆ«ì, ì–¸ë”ë°”(_), í•˜ì´í”ˆ(-)
            // ê³µë°± ë° íŠ¹ìˆ˜ë¬¸ì(!, @, #, *, (, ) ë“±) ê¸ˆì§€
            const pattern = /^[ê°€-í£ã„±-ã…ã…-ã…£a-z0-9_-]+$/;
            return pattern.test(userId);
        }
        
        // ë””ë²„ê·¸ ë¡œê·¸ í•¨ìˆ˜ (localhost ë“± ë¡œì»¬ì—ì„œë§Œ í™œì„±í™”, í¬íŠ¸ ë¬´ê´€)
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.hostname === '';
        let debugLogEnabled = isLocalhost;
        const MAX_LOG_LINES = 100;
        
        // ë¡œì»¬ì´ ì•„ë‹ˆë©´ ë””ë²„ê·¸ ë¡œê·¸ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
        if (!isLocalhost) {
            const debugLogSection = document.getElementById('debugLogSection');
            if (debugLogSection) {
                debugLogSection.style.display = 'none';
            }
        }
        
        // ë¡œì»¬ì—ì„œëŠ” ë°© ì œëª© ê¸°ë³¸ê°’ì„ "test"ë¡œ ì„¤ì •
        if (isLocalhost) {
            const roomNameInput = document.getElementById('createRoomNameInput');
            if (roomNameInput) {
                roomNameInput.value = 'test';
            }
        }
        
        function addDebugLog(message, type = 'info') {
            if (!debugLogEnabled) return;
            
            const logSection = document.getElementById('debugLogSection');
            const logContent = document.getElementById('debugLogContent');
            
            if (!logSection || !logContent) return;
            
            const timestamp = new Date().toLocaleTimeString('ko-KR', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3 });
            const colors = {
                'info': '#0f0',
                'warn': '#ff0',
                'error': '#f00',
                'animation': '#0ff',
                'gameEnd': '#ff0'
            };
            const color = colors[type] || '#0f0';
            
            const logLine = document.createElement('div');
            logLine.style.color = color;
            logLine.style.marginBottom = '2px';
            logLine.innerHTML = `[${timestamp}] ${message}`;
            
            logContent.appendChild(logLine);
            
            // ìµœëŒ€ ë¡œê·¸ ë¼ì¸ ìˆ˜ ì œí•œ
            while (logContent.children.length > MAX_LOG_LINES) {
                logContent.removeChild(logContent.firstChild);
            }
            
            // ìë™ ìŠ¤í¬ë¡¤
            logContent.scrollTop = logContent.scrollHeight;
            
            // ë¡œê·¸ ì„¹ì…˜ í‘œì‹œ
            logSection.style.display = 'block';
        }
        
        function clearDebugLog() {
            const logContent = document.getElementById('debugLogContent');
            if (logContent) {
                logContent.innerHTML = '';
            }
        }
        
        function toggleDebugLog() {
            const logSection = document.getElementById('debugLogSection');
            if (logSection) {
                logSection.style.display = logSection.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        // emojiConfigëŠ” ChatModuleì—ì„œ ê´€ë¦¬ (í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•´ getter ì œê³µ)
        Object.defineProperty(window, 'emojiConfig', {
            get: () => ChatModule.getEmojiConfig()
        });

        // ì±„íŒ… ëª¨ë“ˆ ì´ˆê¸°í™” (roomCreated/roomJoined í›„ í˜¸ì¶œ)
        let chatModuleInitialized = false;
        function initChatModule() {
            if (chatModuleInitialized) return;
            chatModuleInitialized = true;
            ChatModule.init(socket, currentUser, {
                customDisplayMessage: (data) => displayChatMessage(data),
                onCommand: (message) => {
                    if (message.startsWith('/í…ŒìŠ¤íŠ¸')) {
                        handleTestCommand(message);
                        return true;
                    }
                    return false;
                },
                onDiceRoll: (min, max) => rollDiceWithRange(min, max),
                getRoomUsers: () => users
            });

            OrderModule.init(socket, currentUser, {
                isHost: () => isHost,
                isGameActive: () => isGameActive,
                getEverPlayedUsers: () => everPlayedUsers,
                getUsersList: () => usersList,
                showCustomAlert: showCustomAlert,
                onOrderStarted: () => { isOrderActive = true; },
                onOrderEnded: () => { isOrderActive = false; },
                onOrdersUpdated: (data) => { ordersData = data; },
            });
        }
        
        // ë””ë°”ì´ìŠ¤ íƒ€ì… ê°ì§€
        function getDeviceType() {
            const userAgent = navigator.userAgent;
            if (/iPhone|iPad|iPod/i.test(userAgent)) {
                return 'ios';
            } else if (/Android/i.test(userAgent)) {
                return 'android';
            } else {
                return 'pc';
            }
        }
        
        // ë””ë°”ì´ìŠ¤ íƒ€ì…ì— ë”°ë¥¸ ì•„ì´ì½˜ ë°˜í™˜
        function getDeviceIcon(deviceType) {
            switch(deviceType) {
                case 'ios':
                    return 'ğŸ';
                case 'android':
                    return 'ğŸ“±';
                case 'pc':
                default:
                    return 'ğŸ’»';
            }
        }
        
        // ì£¼ì‚¬ìœ„ ì—°ì¶œ íš¨ê³¼ í•¨ìˆ˜ë“¤
        const diceAnimationEffects = {
            // 0. ë§ˆì§€ë§‰ ì‚¬ëŒìš© ê³ ì • ì‹œê°„ ì• ë‹ˆë©”ì´ì…˜ (3.5ì´ˆ ê³ ì •: 3ì´ˆ ì• ë‹ˆë©”ì´ì…˜ + 0.5ì´ˆ ëŒ€ê¸°)
            fixedDuration: function(diceResultSpan, diceIcon, finalResult, onComplete) {
                const ANIMATION_DURATION = 3000; // 3ì´ˆ ì• ë‹ˆë©”ì´ì…˜
                const WAIT_AFTER_ANIMATION = 500; // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ 0.5ì´ˆ ëŒ€ê¸°
                const TOTAL_DURATION = ANIMATION_DURATION + WAIT_AFTER_ANIMATION; // ì´ 3.5ì´ˆ
                
                const startTime = Date.now();
                let currentNum = 1;
                const maxNum = Math.min(finalResult, 100);
                
                const interval = setInterval(() => {
                    const elapsed = Date.now() - startTime;
                    
                    if (elapsed < ANIMATION_DURATION) {
                        // ì• ë‹ˆë©”ì´ì…˜ ë‹¨ê³„: ì§„í–‰ë¥ ì— ë”°ë¼ ìˆ«ì ì—…ë°ì´íŠ¸
                        const progress = elapsed / ANIMATION_DURATION;
                        currentNum = Math.floor(1 + (maxNum - 1) * progress);
                        diceResultSpan.textContent = diceIcon + currentNum;
                    } else {
                        // ëŒ€ê¸° ë‹¨ê³„: ìµœì¢… ê²°ê³¼ í‘œì‹œ
                        diceResultSpan.textContent = diceIcon + finalResult;
                        
                        // ì •í™•íˆ 3.5ì´ˆ í›„ ì™„ë£Œ
                        if (elapsed >= TOTAL_DURATION) {
                            clearInterval(interval);
                            onComplete();
                        }
                    }
                }, 16); // ì•½ 60fps
            },
            
            // 1. ì¹´ìš´íŠ¸ì—… ì• ë‹ˆë©”ì´ì…˜
            countUp: function(diceResultSpan, diceIcon, finalResult, onComplete) {
                let currentNum = 1;
                const maxNum = Math.min(finalResult, 100);
                const steps = 50;
                const increment = Math.max(1, Math.floor(maxNum / steps));
                const interval = setInterval(() => {
                    currentNum += increment;
                    if (currentNum >= maxNum) {
                        currentNum = finalResult;
                        clearInterval(interval);
                        onComplete();
                    }
                    diceResultSpan.textContent = diceIcon + currentNum;
                }, 60);
            },
            
            // 2. ì˜¬ë¼ê°”ë‹¤ê°€ ë‚´ë ¤ì˜¤ëŠ” ì• ë‹ˆë©”ì´ì…˜
            upAndDown: function(diceResultSpan, diceIcon, finalResult, onComplete) {
                const targetNum = Math.min(finalResult, 100);
                const maxNum = 100;
                let currentNum = 1;
                
                // 1ë‹¨ê³„: ë¹ ë¥´ê²Œ 100ê¹Œì§€ ì˜¬ë¼ê°€ê¸°
                const upSteps = 30;
                const upIncrement = Math.max(1, Math.floor(maxNum / upSteps));
                const upInterval = setInterval(() => {
                    currentNum += upIncrement;
                    if (currentNum >= maxNum) {
                        currentNum = maxNum;
                        clearInterval(upInterval);
                        diceResultSpan.textContent = diceIcon + maxNum;
                        
                        // 2ë‹¨ê³„: 0.3ì´ˆ ëŒ€ê¸°
                        setTimeout(() => {
                            // 3ë‹¨ê³„: ê²°ê³¼ ìˆ«ìê¹Œì§€ ë‚´ë ¤ì˜¤ê¸° (ë„ì°© ì§ì „ì— ì²œì²œíˆ)
                            let downNum = maxNum;
                            let downDelay = 30; // ì´ˆê¸° ë”œë ˆì´
                            const downSteps = 40; // ë‚´ë ¤ì˜¤ëŠ” ë‹¨ê³„ ìˆ˜
                            const downIncrement = Math.max(1, Math.floor((maxNum - targetNum) / downSteps));
                            
                            const countDown = () => {
                                downNum -= downIncrement;
                                
                                // ë„ì°© ì§ì „ (targetNum + 40% ë²”ìœ„)ì— ë“¤ì–´ê°€ë©´ ì²œì²œíˆ
                                const slowDownThreshold = targetNum + (maxNum - targetNum) * 0.4;
                                if (downNum <= slowDownThreshold) {
                                    // ë” ë§ì´ ëŠë ¤ì§€ê²Œ (ì¦ê°€ëŸ‰ì„ í¬ê²Œ)
                                    downDelay = Math.min(downDelay + 8, 200); // ì ì  ëŠë ¤ì§€ê²Œ (ìµœëŒ€ 200ms)
                                }
                                
                                // ë§ˆì§€ë§‰ 10% ë²”ìœ„ì—ì„œëŠ” ë”ìš± ì²œì²œíˆ
                                const verySlowThreshold = targetNum + (maxNum - targetNum) * 0.1;
                                if (downNum <= verySlowThreshold) {
                                    downDelay = Math.min(downDelay + 10, 300); // ë§¤ìš° ì²œì²œíˆ (ìµœëŒ€ 300ms)
                                }
                                
                                if (downNum <= targetNum) {
                                    downNum = targetNum;
                                    diceResultSpan.textContent = diceIcon + targetNum;
                                    setTimeout(() => {
                                        onComplete();
                                    }, 200);
                                } else {
                                    diceResultSpan.textContent = diceIcon + downNum;
                                    setTimeout(countDown, downDelay);
                                }
                            };
                            
                            countDown();
                        }, 150); // 0.15ì´ˆ ëŒ€ê¸°
                    } else {
                        diceResultSpan.textContent = diceIcon + currentNum;
                    }
                }, 30); // ë¹ ë¥´ê²Œ ì˜¬ë¼ê°€ê¸°
            },
            
            // 3. í•œ ìë¦¬ì”© ë³´ì—¬ì£¼ëŠ” ì• ë‹ˆë©”ì´ì…˜
            digitByDigit: function(diceResultSpan, diceIcon, finalResult, onComplete) {
                const targetNum = Math.min(finalResult, 99); // ìµœëŒ€ 99ê¹Œì§€
                const onesDigit = targetNum % 10; // 1ì˜ ìë¦¬
                const tensDigit = Math.floor(targetNum / 10); // 10ì˜ ìë¦¬
                
                // í•œ ìë¦¬ìˆ˜ì¸ ê²½ìš° (0~9)
                if (targetNum < 10) {
                    // ì²˜ìŒì— ? í‘œì‹œ
                    diceResultSpan.textContent = diceIcon + '?';
                    
                    // 1ì˜ ìë¦¬ë§Œ ì• ë‹ˆë©”ì´ì…˜
                    let onesCurrent = 0;
                    let onesDelay = 100; // ì´ˆê¸° ë”œë ˆì´ (ì²œì²œíˆ)
                    let passedTarget = false; // ëª©í‘œ ìˆ«ìë¥¼ ì§€ë‚˜ì³¤ëŠ”ì§€
                    let spinCount = 0; // ëª‡ ë°”í€´ ëŒì•˜ëŠ”ì§€
                    const minSpins = 2; // ìµœì†Œ ëª‡ ë°”í€´ ëŒê¸°
                    
                    const animateOnes = () => {
                        onesCurrent++;
                        if (onesCurrent > 9) {
                            onesCurrent = 0;
                            if (passedTarget) spinCount++;
                        }
                        
                        // ëª©í‘œ ìˆ«ìë¥¼ ì§€ë‚˜ì³¤ëŠ”ì§€ í™•ì¸
                        if (onesCurrent === onesDigit && !passedTarget) {
                            passedTarget = true;
                        }
                        
                        diceResultSpan.textContent = diceIcon + onesCurrent;
                        
                        // ëª©í‘œ ìˆ«ìì— ë„ë‹¬í•˜ê³  ìµœì†Œ ë°”í€´ ìˆ˜ë¥¼ ëŒì•˜ìœ¼ë©´
                        if (onesCurrent === onesDigit && passedTarget && spinCount >= minSpins) {
                            diceResultSpan.textContent = diceIcon + targetNum;
                            
                            // í™•ëŒ€/ì¶•ì†Œ ì—°ì¶œ ì¶”ê°€
                            diceResultSpan.style.transition = 'transform 0.1s ease-out';
                            diceResultSpan.style.transform = 'scale(1.3)';
                            
                            setTimeout(() => {
                                diceResultSpan.style.transform = 'scale(1)';
                                setTimeout(() => {
                                    onComplete();
                                }, 100);
                            }, 100);
                        } else {
                            // ë„ì°© ì§ì „ì— ì²œì²œíˆ (ëª©í‘œ ìˆ«ì - 3 ë²”ìœ„)
                            if (passedTarget && spinCount >= minSpins - 1) {
                                const distance = (onesDigit - onesCurrent + 10) % 10;
                                if (distance <= 3 && distance > 0) {
                                    onesDelay = Math.min(onesDelay + 30, 200); // ì ì  ëŠë ¤ì§€ê²Œ
                                }
                            }
                            setTimeout(animateOnes, onesDelay);
                        }
                    };
                    
                    setTimeout(animateOnes, onesDelay);
                } else {
                    // ë‘ ìë¦¬ìˆ˜ì¸ ê²½ìš° (10~99)
                    // ì²˜ìŒì— ?? í‘œì‹œ
                    diceResultSpan.textContent = diceIcon + '??';
                    
                    // 1ì˜ ìë¦¬ ì• ë‹ˆë©”ì´ì…˜ (ì²œì²œíˆ ë–¨ì–´ì§€ëŠ” íš¨ê³¼ ì—†ìŒ - ë¹ ë¥´ê²Œ ì§„í–‰)
                    let onesCurrent = 0;
                    let onesDelay = 60; // ë¹ ë¥¸ ë”œë ˆì´
                    let onesPassedTarget = false;
                    let onesSpinCount = 0;
                    const onesMinSpins = 2;
                    
                    const animateOnes = () => {
                        onesCurrent++;
                        if (onesCurrent > 9) {
                            onesCurrent = 0;
                            if (onesPassedTarget) onesSpinCount++;
                        }
                        
                        if (onesCurrent === onesDigit && !onesPassedTarget) {
                            onesPassedTarget = true;
                        }
                        
                        diceResultSpan.textContent = diceIcon + '?' + onesCurrent;
                        
                        // 1ì˜ ìë¦¬ê°€ ëª©í‘œ ìˆ«ìì— ë„ë‹¬í•˜ê³  ìµœì†Œ ë°”í€´ ìˆ˜ë¥¼ ëŒì•˜ìœ¼ë©´
                        if (onesCurrent === onesDigit && onesPassedTarget && onesSpinCount >= onesMinSpins) {
                            diceResultSpan.textContent = diceIcon + '?' + onesDigit;
                            
                            // ì ì‹œ ëŒ€ê¸° í›„ 10ì˜ ìë¦¬ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
                            setTimeout(() => {
                                let tensCurrent = 0;
                                let tensDelay = 100; // ì´ˆê¸° ë”œë ˆì´
                                let tensPassedTarget = false;
                                let tensSpinCount = 0;
                                const tensMinSpins = 2;
                                
                                const animateTens = () => {
                                    tensCurrent++;
                                    if (tensCurrent > 9) {
                                        tensCurrent = 0;
                                        if (tensPassedTarget) tensSpinCount++;
                                    }
                                    
                                    if (tensCurrent === tensDigit && !tensPassedTarget) {
                                        tensPassedTarget = true;
                                    }
                                    
                                    diceResultSpan.textContent = diceIcon + tensCurrent + onesDigit;
                                    
                                    // 10ì˜ ìë¦¬ê°€ ëª©í‘œ ìˆ«ìì— ë„ë‹¬í•˜ê³  ìµœì†Œ ë°”í€´ ìˆ˜ë¥¼ ëŒì•˜ìœ¼ë©´
                                    if (tensCurrent === tensDigit && tensPassedTarget && tensSpinCount >= tensMinSpins) {
                                        diceResultSpan.textContent = diceIcon + targetNum;
                                        
                                        // í™•ëŒ€/ì¶•ì†Œ ì—°ì¶œ ì¶”ê°€
                                        diceResultSpan.style.transition = 'transform 0.1s ease-out';
                                        diceResultSpan.style.transform = 'scale(1.3)';
                                        
                                        setTimeout(() => {
                                            diceResultSpan.style.transform = 'scale(1)';
                                            setTimeout(() => {
                                                onComplete();
                                            }, 100);
                                        }, 100);
                                    } else {
                                        // ë„ì°© ì§ì „ì— ì²œì²œíˆ (ëª©í‘œ ìˆ«ì - 3 ë²”ìœ„) - ê°€ì¥ í° ìë¦¬ìˆ˜ë§Œ
                                        if (tensPassedTarget && tensSpinCount >= tensMinSpins - 1) {
                                            const distance = (tensDigit - tensCurrent + 10) % 10;
                                            if (distance <= 3 && distance > 0) {
                                                tensDelay = Math.min(tensDelay + 30, 200); // ì ì  ëŠë ¤ì§€ê²Œ
                                            }
                                        }
                                        setTimeout(animateTens, tensDelay);
                                    }
                                };
                                
                                setTimeout(animateTens, tensDelay);
                            }, 200); // 1ì˜ ìë¦¬ì™€ 10ì˜ ìë¦¬ ì‚¬ì´ ëŒ€ê¸° ì‹œê°„
                        } else {
                            // 1ì˜ ìë¦¬ëŠ” ì²œì²œíˆ ë–¨ì–´ì§€ëŠ” íš¨ê³¼ ì—†ìŒ - ë¹ ë¥´ê²Œ ì§„í–‰
                            setTimeout(animateOnes, onesDelay);
                        }
                    };
                    
                    setTimeout(animateOnes, onesDelay);
                }
            }
        };
        
        // ëœë¤ìœ¼ë¡œ ì—°ì¶œ íš¨ê³¼ ì„ íƒ (ë˜ëŠ” íŠ¹ì • íš¨ê³¼ ì„ íƒ)
        function playRandomDiceAnimation(diceResultSpan, diceIcon, finalResult, onComplete, animationIndex = null) {
            const effectNames = Object.keys(diceAnimationEffects);
            let selectedEffect;
            
            // íŠ¹ì • ì• ë‹ˆë©”ì´ì…˜ ì¸ë±ìŠ¤ê°€ ì§€ì •ëœ ê²½ìš° (í…ŒìŠ¤íŠ¸ìš©: 1001~1006)
            if (animationIndex !== null && animationIndex >= 0 && animationIndex < effectNames.length) {
                selectedEffect = effectNames[animationIndex];
                console.log(`í…ŒìŠ¤íŠ¸ ì• ë‹ˆë©”ì´ì…˜ ì„ íƒ: ì¸ë±ìŠ¤ ${animationIndex} â†’ ${selectedEffect}`);
            } else {
                // ê²°ê³¼ì— ë”°ë¼ ì• ë‹ˆë©”ì´ì…˜ ì„ íƒ
                // 80 ë¯¸ë§Œì¼ ë•Œë§Œ ë‘ ë²ˆì§¸ ì• ë‹ˆë©”ì´ì…˜(upAndDown) ì‚¬ìš© ê°€ëŠ¥
                if (finalResult < 80 && effectNames.includes('upAndDown')) {
                    // 80 ë¯¸ë§Œì´ë©´ ëœë¤ìœ¼ë¡œ ì„ íƒ (countUp ë˜ëŠ” upAndDown)
                    selectedEffect = effectNames[Math.floor(Math.random() * effectNames.length)];
                } else {
                    // 80 ì´ìƒì´ë©´ ì²« ë²ˆì§¸ ì• ë‹ˆë©”ì´ì…˜(countUp)ë§Œ ì‚¬ìš©
                    selectedEffect = 'countUp';
                }
            }
            
            diceAnimationEffects[selectedEffect](diceResultSpan, diceIcon, finalResult, onComplete);
        }
        
        // ëª¨ë°”ì¼ ì ‘ì† ê°ì§€
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   (window.innerWidth <= 768);
        }
        
        let currentUser = '';
        let isHost = false;
        let isGameActive = false;
        let gameGeneration = 0; // ê²Œì„ ì„¸ëŒ€ ì¹´ìš´í„° (ê²Œì„ ê°„ ì• ë‹ˆë©”ì´ì…˜ í”Œë˜ê·¸ ì¶©ëŒ ë°©ì§€)
        let gameEndWaitInterval = null; // ê²Œì„ ì¢…ë£Œ ëŒ€ê¸° ì¸í„°ë²Œ (ì „ì—­ ê´€ë¦¬)
        let gameEndWaitTimeout = null; // ê²Œì„ ì¢…ë£Œ ëŒ€ê¸° íƒ€ì„ì•„ì›ƒ (ì „ì—­ ê´€ë¦¬)
        let isOrderActive = false;
        let ordersData = {};
        let diceMax = 100;
        let myDiceSettings = { max: 100 };
        let hasRolledInCurrentGame = false;
        let rolledUsersInGame = []; // ê²Œì„ ì¤‘ êµ´ë¦° ì‚¬ìš©ì ëª©ë¡ ì¶”ì 
        let historyData = [];
        let lastTopPlayerKeys = new Set(); // ì´ì „ ë Œë”ë§ì—ì„œ ìœ ë ¥í–ˆë˜ ì‚¬ëŒë“¤ ì¶”ì 
        let lastWinnerKeys = new Set(); // ì´ì „ ë Œë”ë§ì—ì„œ ë‹¹ì²¨ìì˜€ë˜ ì‚¬ëŒë“¤ ì¶”ì 
        let currentSortMode = 'time'; // ê¸°ë³¸ê°’ì„ ì‹œê°„ìˆœìœ¼ë¡œ ë³€ê²½
        let usersList = []; // ì ‘ì†ì ëª©ë¡
        let gamePlayers = []; // ê²Œì„ì— ì°¸ì—¬í•œ ì‚¬ëŒ ëª©ë¡
        let everPlayedUsers = []; // ë°©ì— ì…ì¥í•œ í›„ í•œë²ˆì´ë¼ë„ ê²Œì„ì— ì°¸ì—¬í•œ ì‚¬ëŒ ëª©ë¡ (ëˆ„ì )
        let readyUsers = []; // ì¤€ë¹„í•œ ì‚¬ìš©ì ëª©ë¡
        let isReady = false; // ë‚´ ì¤€ë¹„ ìƒíƒœ
        // clientChatHistoryëŠ” ChatModule ë‚´ë¶€ íˆìŠ¤í† ë¦¬ ì°¸ì¡° (í•˜ìœ„ í˜¸í™˜ì„±)
        Object.defineProperty(window, 'clientChatHistory', {
            get: () => ChatModule.getChatHistory()
        });

        // ê¸°ê¸° ì‹ë³„ ì •ë³´ ìƒì„± í•¨ìˆ˜
        function getDeviceId() {
            const info = {
                userAgent: navigator.userAgent || '',
                platform: navigator.platform || '',
                hardwareConcurrency: navigator.hardwareConcurrency || 0,
                screenWidth: screen.width || 0,
                screenHeight: screen.height || 0,
                language: navigator.language || '',
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || ''
            };
            // ì •ë³´ë¥¼ ë¬¸ìì—´ë¡œ ì¡°í•©í•˜ì—¬ ê°„ë‹¨í•œ í•´ì‹œ ìƒì„±
            const infoString = JSON.stringify(info);
            // ê°„ë‹¨í•œ í•´ì‹œ í•¨ìˆ˜ (ì‹¤ì œë¡œëŠ” ë” ë³µì¡í•œ í•´ì‹œë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ)
            let hash = 0;
            for (let i = 0; i < infoString.length; i++) {
                const char = infoString.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // 32bit ì •ìˆ˜ë¡œ ë³€í™˜
            }
            return hash.toString();
        }
        
        // ì£¼ì‚¬ìœ„ ì‚¬ìš´ë“œ ë³¼ë¥¨ ê´€ë¦¬ (ê²½ë§ˆì™€ ë™ì¼í•œ íŒ¨í„´)
        const DICE_SOUND_KEY = 'diceSoundEnabled';
        const DICE_VOLUME_KEY = 'diceSoundVolume';
        var diceMasterVolume = 0; // 0 = ìŒì†Œê±° (ê¸°ë³¸)
        var diceStoredVolume = 0.5; // ìŒì†Œê±° í•´ì œ ì‹œ ë³µì›í•  ë³¼ë¥¨ (ê¸°ë³¸ 50%)

        function getDiceSoundEnabled() { return diceMasterVolume > 0; }
        function getDiceMasterVolume() { return diceMasterVolume; }

        function initDiceVolumeFromStorage() {
            const storedMuted = localStorage.getItem(DICE_SOUND_KEY);
            const storedVolume = localStorage.getItem(DICE_VOLUME_KEY);
            diceStoredVolume = storedVolume ? parseFloat(storedVolume) : 0.5;
            const isEnabled = storedMuted === 'true';
            diceMasterVolume = isEnabled ? diceStoredVolume : 0;
        }

        function updateDiceVolumeUI() {
            const isMuted = diceMasterVolume === 0;
            const volumePercent = Math.round(diceStoredVolume * 100);
            const btn = document.getElementById('volumeBtn');
            const slider = document.getElementById('volumeSlider');
            if (btn) btn.textContent = isMuted ? 'ğŸ”‡' : (diceMasterVolume < 0.5 ? 'ğŸ”ˆ' : 'ğŸ”Š');
            if (slider) {
                slider.value = volumePercent;
                slider.classList.toggle('muted', isMuted);
            }
        }

        function toggleDiceMute() {
            if (diceMasterVolume > 0) {
                diceMasterVolume = 0;
                localStorage.setItem(DICE_SOUND_KEY, 'false');
            } else {
                diceMasterVolume = diceStoredVolume;
                localStorage.setItem(DICE_SOUND_KEY, 'true');
            }
            updateDiceVolumeUI();
            if (window.SoundManager) SoundManager.applyMasterVolume();
        }

        function setDiceMasterVolume(volumePercent) {
            const vol = volumePercent / 100;
            diceStoredVolume = vol;
            diceMasterVolume = vol;
            localStorage.setItem(DICE_VOLUME_KEY, vol.toString());
            localStorage.setItem(DICE_SOUND_KEY, vol > 0 ? 'true' : 'false');
            updateDiceVolumeUI();
            if (window.SoundManager) SoundManager.applyMasterVolume();
        }

        document.addEventListener('DOMContentLoaded', () => {
            initDiceVolumeFromStorage();
            updateDiceVolumeUI();
            const btn = document.getElementById('volumeBtn');
            const slider = document.getElementById('volumeSlider');
            if (btn) btn.addEventListener('click', toggleDiceMute);
            if (slider) slider.addEventListener('input', () => setDiceMasterVolume(parseInt(slider.value)));
            // SoundManagerì— ë§ˆìŠ¤í„° ë³¼ë¥¨ getter ë“±ë¡
            if (window.SoundManager) SoundManager.setMasterVolumeGetter(getDiceMasterVolume);
        });
        
        // ì±„íŒ… ì…ë ¥ì°½ìš© ìë™ì™„ì„± ì œì•ˆ ì°¾ê¸°
        function findChatAutocompleteSuggestions(text) {
            if (!text || text.trim() === '') {
                return [];
            }

            const trimmedText = text.trim();

            // /, /ã…ˆ, /ì£¼, /ì£¼ã……, /ì£¼ì‚¬, /ì£¼ì‚¬ã…‡, /ì£¼ì‚¬ìš° ë“±ìœ¼ë¡œ ì‹œì‘í•˜ë©´ /ì£¼ì‚¬ìœ„ ì œì•ˆ
            // í•œê¸€ ìëª¨ ì…ë ¥ì„ ê³ ë ¤í•œ íŒ¨í„´ ë§¤ì¹­
            if (trimmedText === '/' ||
                trimmedText === '/ã…ˆ' ||
                trimmedText.startsWith('/ì£¼') ||
                trimmedText.startsWith('/ì£¼ì‚¬')) {
                // /ì£¼ì‚¬ìœ„ë¡œ ì™„ì„±ë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ì œì•ˆ
                if (trimmedText !== '/ì£¼ì‚¬ìœ„' && !trimmedText.startsWith('/ì£¼ì‚¬ìœ„')) {
                    return ['/ì£¼ì‚¬ìœ„'];
                }
            }

            return [];
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        let currentRoomId = null;
        let selectedRoomId = null;
        let roomsList = [];
        let roomExpiryInterval = null; // ë°© í­íŒŒ ì¹´ìš´íŠ¸ë‹¤ìš´ ì¸í„°ë²Œ
        let roomListRefreshInterval = null; // ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ì¸í„°ë²Œ
        
        // ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§ ë° ì´ˆê¸°í™”
        socket.on('connect', () => {
            document.getElementById('connectionStatus').textContent = 'â— ì—°ê²°ë¨';
            document.getElementById('connectionStatus').className = 'connection-status connected';
            
            const createRoomConnectionStatus = document.getElementById('createRoomConnectionStatus');
            if (createRoomConnectionStatus) {
                createRoomConnectionStatus.textContent = 'â— ì—°ê²°ë¨';
                createRoomConnectionStatus.className = 'connection-status connected';
            }
            
            // ë°© ëª©ë¡ ìš”ì²­ ë° ì´ˆê¸° body í´ë˜ìŠ¤ ì„¤ì •
            if (document.getElementById('lobbySection').classList.contains('active')) {
                document.body.classList.add('lobby-active');
                refreshRooms();
                refreshVisitorStats();
            }
        });

        socket.on('disconnect', () => {
            document.getElementById('connectionStatus').textContent = 'â— ì—°ê²° ëŠê¹€';
            document.getElementById('connectionStatus').className = 'connection-status disconnected';
            
            const createRoomConnectionStatus = document.getElementById('createRoomConnectionStatus');
            if (createRoomConnectionStatus) {
                createRoomConnectionStatus.textContent = 'â— ì—°ê²° ëŠê¹€';
                createRoomConnectionStatus.className = 'connection-status disconnected';
            }
        });

        // ë°© ëª©ë¡ ì—…ë°ì´íŠ¸
        socket.on('roomsList', (rooms) => {
            roomsList = rooms;
            renderRoomsList();
        });
        
        socket.on('roomsListUpdated', (rooms) => {
            roomsList = rooms;
            renderRoomsList();
        });
        
        // ì—…ë°ì´íŠ¸ ë‚´ì—­ íŒŒì¼ ë¡œë“œ
        function loadUpdateLog() {
            const updateLogContent = document.getElementById('updateLogContent');
            if (!updateLogContent) return;
            
            fetch('update-log.txt')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('ì—…ë°ì´íŠ¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                    return response.text();
                })
                .then(text => {
                    updateLogContent.innerHTML = text;
                })
                .catch(error => {
                    console.error('ì—…ë°ì´íŠ¸ ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨:', error);
                    updateLogContent.innerHTML = 'ì—…ë°ì´íŠ¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                });
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì—…ë°ì´íŠ¸ ë‚´ì—­ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', () => {
            loadUpdateLog();
        });
        
        // ë°© ëª©ë¡ ë Œë”ë§
        function renderRoomsList() {
            const roomsListEl = document.getElementById('roomsList');
            
            if (roomsList.length === 0) {
                roomsListEl.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">ìƒì„±ëœ ë°©ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }
            
            roomsListEl.innerHTML = '';
            
            roomsList.forEach(room => {
                const roomItem = document.createElement('div');
                const isMyRoom = room.roomId === currentRoomId;
                let className = 'room-item';
                if (isMyRoom) {
                    className += ' my-room';
                } else if (room.roomId === selectedRoomId) {
                    className += ' active';
                }
                roomItem.className = className;
                
                let statusClass = 'waiting';
                let statusText = 'ëŒ€ê¸° ì¤‘';
                if (room.isGameActive) {
                    statusClass = 'playing';
                    statusText = 'ê²Œì„ ì§„í–‰ ì¤‘';
                } else if (room.isOrderActive) {
                    statusClass = 'ordering';
                    statusText = 'ì£¼ë¬¸ë°›ê¸° ì¤‘';
                }
                
                const serverTag = room.serverName ? `<span style="color: #667eea; font-weight: 600; margin-right: 4px;">[${room.serverName}]</span>` : '';
                const roomNameHtml = isMyRoom
                    ? `${serverTag}${room.roomName}<span class="my-room-badge">ì°¸ì—¬ ì¤‘</span>`
                    : `${serverTag}${room.roomName}`;
                
                // ë¹„ê³µê°œ ë°© í‘œì‹œ
                const privateBadge = room.isPrivate 
                    ? '<span style="color: #ff6b6b; font-weight: bold; margin-left: 5px;">ğŸ”’ ë¹„ê³µê°œ</span>' 
                    : '';
                
                // ê²Œì„ íƒ€ì… íƒœê·¸ í‘œì‹œ
                let gameTypeIcon = 'ğŸ²';
                let gameTypeLabel = 'ì£¼ì‚¬ìœ„';
                let gameTypeColor = '#667eea';
                if (room.gameType === 'roulette') {
                    gameTypeIcon = 'ğŸ°';
                    gameTypeLabel = 'ë£°ë ›';
                    gameTypeColor = '#7c4dff';
                } else if (room.gameType === 'horse-race') {
                    gameTypeIcon = 'ğŸ';
                    gameTypeLabel = 'ê²½ë§ˆ';
                    gameTypeColor = '#8b4513';
                }
                const gameTypeBadge = `<span style="display: inline-flex; align-items: center; background: ${gameTypeColor}; color: white; padding: 3px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; margin-right: 8px;">${gameTypeIcon} ${gameTypeLabel}</span>`;
                
                // ë‚¨ì€ ì‹œê°„ í‘œì‹œ
                let remainingTimeText = '';
                if (room.createdAt) {
                    const createdAt = new Date(room.createdAt);
                    const now = new Date();
                    const expiryHours = room.expiryHours || 3; // ê¸°ë³¸ê°’ 3ì‹œê°„
                    const expiryHoursInMs = expiryHours * 60 * 60 * 1000;
                    const expiryTime = createdAt.getTime() + expiryHoursInMs;
                    const remaining = expiryTime - now.getTime();
                    
                    // ë‚¨ì€ ì‹œê°„ ê³„ì‚°
                    if (remaining > 0) {
                        const hours = Math.floor(remaining / (1000 * 60 * 60));
                        const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                        remainingTimeText = ` | ë‚¨ì€ ì‹œê°„: ${hours}ì‹œê°„ ${minutes}ë¶„`;
                    } else {
                        remainingTimeText = ` | <span style="color: #dc3545; font-weight: bold;">í­íŒŒ ì˜ˆì •</span>`;
                    }
                }
                
                const buttonText = isMyRoom ? 'ì¬ì…ì¥' : 'ì…ì¥í•˜ê¸°';
                
                roomItem.innerHTML = `
                    <div class="room-info">
                        <div class="room-name">${roomNameHtml}${privateBadge}</div>
                        <div class="room-details">
                            í˜¸ìŠ¤íŠ¸: ${room.hostName} | ì¸ì›: ${room.playerCount}ëª…${remainingTimeText}
                        </div>
                        <span class="room-status ${statusClass}">${statusText}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        ${gameTypeBadge}
                        <div class="room-action">
                            <button onclick="joinRoomDirectly('${room.roomId}')">${buttonText}</button>
                        </div>
                    </div>
                `;
                
                roomsListEl.appendChild(roomItem);
            });
            
            // ë¡œë¹„ ì„¹ì…˜ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ì£¼ê¸°ì ìœ¼ë¡œ ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ë‚¨ì€ ì‹œê°„ ì—…ë°ì´íŠ¸)
            const lobbySection = document.getElementById('lobbySection');
            if (lobbySection && lobbySection.classList.contains('active')) {
                // ê¸°ì¡´ ì¸í„°ë²Œ ì •ë¦¬
                if (roomListRefreshInterval) {
                    clearInterval(roomListRefreshInterval);
                }
                // 30ì´ˆë§ˆë‹¤ ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                roomListRefreshInterval = setInterval(() => {
                    if (lobbySection.classList.contains('active')) {
                        refreshRooms();
                    } else {
                        clearInterval(roomListRefreshInterval);
                        roomListRefreshInterval = null;
                    }
                }, 30000); // 30ì´ˆë§ˆë‹¤
            }
        }
        
        // ë°© ë°”ë¡œ ì…ì¥
        function joinRoomDirectly(roomId) {
            selectedRoomId = roomId;
            
            const globalNameInput = document.getElementById('globalUserNameInput');
            const userName = globalNameInput ? globalNameInput.value.trim() : '';
            
            if (userName === '') {
                showCustomAlert('ì´ë¦„ì„ ì…ë ¥í•´ì•¼ ì…ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'warning');
                if (globalNameInput) {
                    globalNameInput.focus();
                }
                return;
            }
            
            // ìœ íš¨ì„± ê²€ì‚¬
            if (!validateUserId(userName)) {
                showCustomAlert('í•œê¸€, ì˜ë¬¸ ì†Œë¬¸ì, ìˆ«ì, _, -ë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'warning');
                if (globalNameInput) {
                    globalNameInput.focus();
                }
                return;
            }
            
            // ë°© ì •ë³´ í™•ì¸
            const room = roomsList.find(r => r.roomId === roomId);
            
            // ë£°ë › ë°©ì´ë©´ ë£°ë › í˜ì´ì§€ë¡œ ì´ë™
            if (room && room.gameType === 'roulette') {
                localStorage.setItem('rouletteUserName', userName);
                localStorage.setItem('pendingRouletteJoin', JSON.stringify({
                    roomId: roomId,
                    userName: userName,
                    isPrivate: room.isPrivate,
                    serverId: currentServerId,
                    serverName: currentServerName
                }));
                window.location.href = '/roulette-game-multiplayer.html?joinRoom=true';
                return;
            }

            // ê²½ë§ˆ ë°©ì´ë©´ ê²½ë§ˆ í˜ì´ì§€ë¡œ ì´ë™
            if (room && room.gameType === 'horse-race') {
                localStorage.setItem('horseRaceUserName', userName);
                localStorage.setItem('pendingHorseRaceJoin', JSON.stringify({
                    roomId: roomId,
                    userName: userName,
                    isPrivate: room.isPrivate,
                    serverId: currentServerId,
                    serverName: currentServerName
                }));
                window.location.href = '/horse-race-multiplayer.html?joinRoom=true';
                return;
            }
            
            // ë¹„ê³µê°œ ë°©ì¸ì§€ ì²´í¬
            if (room && room.isPrivate) {
                // ë¹„ê³µê°œ ë°©ì´ë©´ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ëª¨ë‹¬ í‘œì‹œ
                showPasswordModal(roomId, userName);
            } else {
                // ê³µê°œ ë°©ì´ë©´ ë°”ë¡œ ì…ì¥
                socket.emit('joinRoom', {
                    roomId: roomId,
                    userName: userName,
                    isHost: false,
                    password: '',
                    deviceId: getDeviceId()
                });
            }
        }
        
        // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ëª¨ë‹¬ í‘œì‹œ
        function showPasswordModal(roomId, userName) {
            const password = prompt('ğŸ”’ ë¹„ê³µê°œ ë°©ì…ë‹ˆë‹¤.\në¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:');
            
            if (password === null) {
                // ì·¨ì†Œ
                return;
            }
            
            if (password === '') {
                showCustomAlert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!', 'warning');
                showPasswordModal(roomId, userName); // ë‹¤ì‹œ ëª¨ë‹¬ í‘œì‹œ
                return;
            }
            
            // ë¹„ë°€ë²ˆí˜¸ì™€ í•¨ê»˜ ì…ì¥ ìš”ì²­
            socket.emit('joinRoom', {
                roomId: roomId,
                userName: userName,
                isHost: false,
                password: password,
                deviceId: getDeviceId()
            });
        }
        
        // ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        function refreshRooms() {
            socket.emit('getRooms');
            refreshVisitorStats();
        }
        
        // ë°©ë¬¸ì í†µê³„ ìƒˆë¡œê³ ì¹¨
        function refreshVisitorStats() {
            socket.emit('getVisitorStats');
        }
        
        // ë°©ë¬¸ì/í”Œë ˆì´ í†µê³„ ìˆ˜ì‹ 
        socket.on('visitorStats', (stats) => {
            document.getElementById('todayVisitorCount').textContent = stats.todayVisitors ?? 0;
            document.getElementById('todayPlayCount').textContent = stats.todayPlays ?? 0;
            document.getElementById('totalPlayCount').textContent = stats.totalPlays ?? 0;
        });
        
        // ì»¤ìŠ¤í…€ ì–¼ëŸ¿ í•¨ìˆ˜
        function showCustomAlert(message, type = 'info') {
            // ê¸°ì¡´ ì–¼ëŸ¿ì´ ìˆìœ¼ë©´ ì œê±°
            const existingAlert = document.getElementById('customAlert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            // íƒ€ì…ì— ë”°ë¥¸ ìƒ‰ìƒ ì„¤ì •
            let bgColor, borderColor, icon;
            switch(type) {
                case 'error':
                    bgColor = '#fee';
                    borderColor = '#f66';
                    icon = 'âš ï¸';
                    break;
                case 'warning':
                    bgColor = '#fff9e6';
                    borderColor = '#ffa500';
                    icon = 'âš ï¸';
                    break;
                case 'success':
                    bgColor = '#e8f5e9';
                    borderColor = '#4caf50';
                    icon = 'âœ…';
                    break;
                default:
                    bgColor = '#e3f2fd';
                    borderColor = '#2196f3';
                    icon = 'â„¹ï¸';
            }
            
            // ì–¼ëŸ¿ ì˜¤ë²„ë ˆì´ ìƒì„±
            const alertOverlay = document.createElement('div');
            alertOverlay.id = 'customAlert';
            alertOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.4);
                z-index: 10001;
                display: flex;
                justify-content: center;
                align-items: center;
                animation: fadeIn 0.2s ease-out;
            `;
            
            // ì–¼ëŸ¿ ì»¨í…ì¸  ìƒì„±
            const alertContent = document.createElement('div');
            alertContent.style.cssText = `
                background: white;
                border-radius: 16px;
                padding: 25px 30px;
                max-width: 500px;
                width: 90vw;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
                border: 2px solid ${borderColor};
                animation: slideDown 0.3s ease-out;
            `;
            
            // ì•„ì´ì½˜ê³¼ ë©”ì‹œì§€
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                font-size: 16px;
                line-height: 1.6;
                color: #333;
                white-space: pre-wrap;
                word-break: break-word;
                text-align: center;
                margin-bottom: 20px;
            `;
            messageDiv.innerHTML = `<span style="font-size: 24px; margin-right: 8px;">${icon}</span>${message}`;
            
            // í™•ì¸ ë²„íŠ¼
            const confirmButton = document.createElement('button');
            confirmButton.textContent = 'í™•ì¸';
            confirmButton.style.cssText = `
                padding: 10px 30px;
                background: linear-gradient(135deg, ${borderColor} 0%, ${borderColor}dd 100%);
                color: white;
                border: none;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                width: 100%;
                transition: transform 0.1s, box-shadow 0.1s;
            `;
            confirmButton.onmouseenter = () => {
                confirmButton.style.transform = 'scale(1.02)';
                confirmButton.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
            };
            confirmButton.onmouseleave = () => {
                confirmButton.style.transform = 'scale(1)';
                confirmButton.style.boxShadow = 'none';
            };
            confirmButton.onclick = () => {
                alertOverlay.style.animation = 'fadeOut 0.2s ease-out';
                setTimeout(() => alertOverlay.remove(), 200);
            };
            
            // ESC í‚¤ë¡œ ë‹«ê¸°
            const handleEsc = (e) => {
                if (e.key === 'Escape') {
                    alertOverlay.style.animation = 'fadeOut 0.2s ease-out';
                    setTimeout(() => {
                        alertOverlay.remove();
                        document.removeEventListener('keydown', handleEsc);
                    }, 200);
                }
            };
            document.addEventListener('keydown', handleEsc);
            
            // ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ë‹«ê¸°
            alertOverlay.onclick = (e) => {
                if (e.target === alertOverlay) {
                    alertOverlay.style.animation = 'fadeOut 0.2s ease-out';
                    setTimeout(() => {
                        alertOverlay.remove();
                        document.removeEventListener('keydown', handleEsc);
                    }, 200);
                }
            };
            
            alertContent.appendChild(messageDiv);
            alertContent.appendChild(confirmButton);
            alertOverlay.appendChild(alertContent);
            document.body.appendChild(alertOverlay);
            
            // í¬ì»¤ìŠ¤ ì„¤ì •
            confirmButton.focus();
        }
        
        // ì»¤ìŠ¤í…€ Confirm í•¨ìˆ˜ (Promise ë°˜í™˜)
        function showCustomConfirm(message, type = 'warning') {
            return new Promise((resolve) => {
                // ê¸°ì¡´ confirmì´ ìˆìœ¼ë©´ ì œê±°
                const existingConfirm = document.getElementById('customConfirm');
                if (existingConfirm) {
                    existingConfirm.remove();
                }
                
                // íƒ€ì…ì— ë”°ë¥¸ ìƒ‰ìƒ ì„¤ì •
                let bgColor, borderColor, icon;
                switch(type) {
                    case 'error':
                        bgColor = '#fee';
                        borderColor = '#f66';
                        icon = 'âš ï¸';
                        break;
                    case 'warning':
                        bgColor = '#fff9e6';
                        borderColor = '#ffa500';
                        icon = 'âš ï¸';
                        break;
                    case 'success':
                        bgColor = '#e8f5e9';
                        borderColor = '#4caf50';
                        icon = 'âœ…';
                        break;
                    default:
                        bgColor = '#e3f2fd';
                        borderColor = '#2196f3';
                        icon = 'â„¹ï¸';
                }
                
                // Confirm ì˜¤ë²„ë ˆì´ ìƒì„±
                const confirmOverlay = document.createElement('div');
                confirmOverlay.id = 'customConfirm';
                confirmOverlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.4);
                    z-index: 10002;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    animation: fadeIn 0.2s ease-out;
                `;
                
                // Confirm ì»¨í…ì¸  ìƒì„±
                const confirmContent = document.createElement('div');
                confirmContent.style.cssText = `
                    background: white;
                    border-radius: 16px;
                    padding: 25px 30px;
                    max-width: 500px;
                    width: 90vw;
                    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
                    border: 2px solid ${borderColor};
                    animation: slideDown 0.3s ease-out;
                `;
                
                // ì•„ì´ì½˜ê³¼ ë©”ì‹œì§€
                const messageDiv = document.createElement('div');
                messageDiv.style.cssText = `
                    font-size: 16px;
                    line-height: 1.6;
                    color: #333;
                    white-space: pre-wrap;
                    word-break: break-word;
                    text-align: center;
                    margin-bottom: 25px;
                `;
                messageDiv.innerHTML = `<span style="font-size: 24px; margin-right: 8px;">${icon}</span>${message}`;
                
                // ë²„íŠ¼ ì»¨í…Œì´ë„ˆ
                const buttonContainer = document.createElement('div');
                buttonContainer.style.cssText = `
                    display: flex;
                    gap: 10px;
                    justify-content: center;
                `;
                
                // ì·¨ì†Œ ë²„íŠ¼
                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'ì·¨ì†Œ';
                cancelButton.style.cssText = `
                    padding: 10px 25px;
                    background: #f5f5f5;
                    color: #666;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: transform 0.1s, box-shadow 0.1s;
                    flex: 1;
                `;
                cancelButton.onmouseenter = () => {
                    cancelButton.style.transform = 'scale(1.02)';
                    cancelButton.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                };
                cancelButton.onmouseleave = () => {
                    cancelButton.style.transform = 'scale(1)';
                    cancelButton.style.boxShadow = 'none';
                };
                cancelButton.onclick = () => {
                    confirmOverlay.style.animation = 'fadeOut 0.2s ease-out';
                    setTimeout(() => {
                        confirmOverlay.remove();
                        resolve(false);
                    }, 200);
                };
                
                // í™•ì¸ ë²„íŠ¼
                const confirmButton = document.createElement('button');
                confirmButton.textContent = 'í™•ì¸';
                confirmButton.style.cssText = `
                    padding: 10px 25px;
                    background: linear-gradient(135deg, ${borderColor} 0%, ${borderColor}dd 100%);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: transform 0.1s, box-shadow 0.1s;
                    flex: 1;
                `;
                confirmButton.onmouseenter = () => {
                    confirmButton.style.transform = 'scale(1.02)';
                    confirmButton.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
                };
                confirmButton.onmouseleave = () => {
                    confirmButton.style.transform = 'scale(1)';
                    confirmButton.style.boxShadow = 'none';
                };
                confirmButton.onclick = () => {
                    confirmOverlay.style.animation = 'fadeOut 0.2s ease-out';
                    setTimeout(() => {
                        confirmOverlay.remove();
                        resolve(true);
                    }, 200);
                };
                
                // ESC í‚¤ë¡œ ë‹«ê¸° (ì·¨ì†Œë¡œ ì²˜ë¦¬)
                const handleEsc = (e) => {
                    if (e.key === 'Escape') {
                        confirmOverlay.style.animation = 'fadeOut 0.2s ease-out';
                        setTimeout(() => {
                            confirmOverlay.remove();
                            document.removeEventListener('keydown', handleEsc);
                            resolve(false);
                        }, 200);
                    }
                };
                document.addEventListener('keydown', handleEsc);
                
                // ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ë‹«ê¸° (ì·¨ì†Œë¡œ ì²˜ë¦¬)
                confirmOverlay.onclick = (e) => {
                    if (e.target === confirmOverlay) {
                        confirmOverlay.style.animation = 'fadeOut 0.2s ease-out';
                        setTimeout(() => {
                            confirmOverlay.remove();
                            document.removeEventListener('keydown', handleEsc);
                            resolve(false);
                        }, 200);
                    }
                };
                
                buttonContainer.appendChild(cancelButton);
                buttonContainer.appendChild(confirmButton);
                confirmContent.appendChild(messageDiv);
                confirmContent.appendChild(buttonContainer);
                confirmOverlay.appendChild(confirmContent);
                document.body.appendChild(confirmOverlay);
                
                // í¬ì»¤ìŠ¤ ì„¤ì •
                cancelButton.focus();
            });
        }
        
        // í”Œë ˆì´ì–´ ì•¡ì…˜ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ (í˜¸ìŠ¤íŠ¸ì„ëª…, ì œì™¸ì‹œí‚¤ê¸°, ì·¨ì†Œ)
        function showPlayerActionDialog(playerName) {
            return new Promise((resolve) => {
                // ê¸°ì¡´ ë‹¤ì´ì–¼ë¡œê·¸ê°€ ìˆìœ¼ë©´ ì œê±°
                const existingDialog = document.getElementById('playerActionDialog');
                if (existingDialog) {
                    existingDialog.remove();
                }
                
                // ë‹¤ì´ì–¼ë¡œê·¸ ì˜¤ë²„ë ˆì´ ìƒì„±
                const dialogOverlay = document.createElement('div');
                dialogOverlay.id = 'playerActionDialog';
                dialogOverlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.4);
                    z-index: 10002;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    animation: fadeIn 0.2s ease-out;
                `;
                
                // ë‹¤ì´ì–¼ë¡œê·¸ ì»¨í…ì¸  ìƒì„±
                const dialogContent = document.createElement('div');
                dialogContent.style.cssText = `
                    background: white;
                    border-radius: 16px;
                    padding: 25px 30px;
                    max-width: 500px;
                    width: 90vw;
                    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
                    border: 2px solid #ffa500;
                    animation: slideDown 0.3s ease-out;
                `;
                
                // ë©”ì‹œì§€
                const messageDiv = document.createElement('div');
                messageDiv.style.cssText = `
                    font-size: 18px;
                    line-height: 1.6;
                    color: #333;
                    white-space: pre-wrap;
                    word-break: break-word;
                    text-align: center;
                    margin-bottom: 25px;
                    font-weight: 600;
                `;
                messageDiv.innerHTML = `<span style="font-size: 24px; margin-right: 8px;">ğŸ‘¤</span>${playerName}ë‹˜ì—ê²Œ ì–´ë–¤ í–‰ë™ì„ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
                
                // ë²„íŠ¼ ì»¨í…Œì´ë„ˆ
                const buttonContainer = document.createElement('div');
                buttonContainer.style.cssText = `
                    display: flex;
                    flex-direction: column;
                    gap: 12px;
                `;
                
                // í˜¸ìŠ¤íŠ¸ì„ëª… ë²„íŠ¼
                const hostButton = document.createElement('button');
                hostButton.textContent = 'í˜¸ìŠ¤íŠ¸ì„ëª…';
                hostButton.style.cssText = `
                    padding: 12px 25px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: transform 0.1s, box-shadow 0.1s;
                `;
                hostButton.onmouseenter = () => {
                    hostButton.style.transform = 'scale(1.02)';
                    hostButton.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.3)';
                };
                hostButton.onmouseleave = () => {
                    hostButton.style.transform = 'scale(1)';
                    hostButton.style.boxShadow = 'none';
                };
                hostButton.onclick = () => {
                    dialogOverlay.style.animation = 'fadeOut 0.2s ease-out';
                    setTimeout(() => {
                        dialogOverlay.remove();
                        document.removeEventListener('keydown', handleEsc);
                        resolve('host');
                    }, 200);
                };
                
                // ì œì™¸ì‹œí‚¤ê¸° ë²„íŠ¼
                const kickButton = document.createElement('button');
                kickButton.textContent = 'ì œì™¸ì‹œí‚¤ê¸°';
                kickButton.style.cssText = `
                    padding: 12px 25px;
                    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: transform 0.1s, box-shadow 0.1s;
                `;
                kickButton.onmouseenter = () => {
                    kickButton.style.transform = 'scale(1.02)';
                    kickButton.style.boxShadow = '0 4px 12px rgba(255, 107, 107, 0.3)';
                };
                kickButton.onmouseleave = () => {
                    kickButton.style.transform = 'scale(1)';
                    kickButton.style.boxShadow = 'none';
                };
                kickButton.onclick = () => {
                    dialogOverlay.style.animation = 'fadeOut 0.2s ease-out';
                    setTimeout(() => {
                        dialogOverlay.remove();
                        document.removeEventListener('keydown', handleEsc);
                        resolve('kick');
                    }, 200);
                };
                
                // ì·¨ì†Œ ë²„íŠ¼
                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'ì·¨ì†Œ';
                cancelButton.style.cssText = `
                    padding: 12px 25px;
                    background: #f5f5f5;
                    color: #666;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: transform 0.1s, box-shadow 0.1s;
                `;
                cancelButton.onmouseenter = () => {
                    cancelButton.style.transform = 'scale(1.02)';
                    cancelButton.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                };
                cancelButton.onmouseleave = () => {
                    cancelButton.style.transform = 'scale(1)';
                    cancelButton.style.boxShadow = 'none';
                };
                cancelButton.onclick = () => {
                    dialogOverlay.style.animation = 'fadeOut 0.2s ease-out';
                    setTimeout(() => {
                        dialogOverlay.remove();
                        document.removeEventListener('keydown', handleEsc);
                        resolve('cancel');
                    }, 200);
                };
                
                // ESC í‚¤ë¡œ ë‹«ê¸° (ì·¨ì†Œë¡œ ì²˜ë¦¬)
                const handleEsc = (e) => {
                    if (e.key === 'Escape') {
                        dialogOverlay.style.animation = 'fadeOut 0.2s ease-out';
                        setTimeout(() => {
                            dialogOverlay.remove();
                            document.removeEventListener('keydown', handleEsc);
                            resolve('cancel');
                        }, 200);
                    }
                };
                document.addEventListener('keydown', handleEsc);
                
                // ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ë‹«ê¸° (ì·¨ì†Œë¡œ ì²˜ë¦¬)
                dialogOverlay.onclick = (e) => {
                    if (e.target === dialogOverlay) {
                        dialogOverlay.style.animation = 'fadeOut 0.2s ease-out';
                        setTimeout(() => {
                            dialogOverlay.remove();
                            document.removeEventListener('keydown', handleEsc);
                            resolve('cancel');
                        }, 200);
                    }
                };
                
                buttonContainer.appendChild(hostButton);
                buttonContainer.appendChild(kickButton);
                buttonContainer.appendChild(cancelButton);
                dialogContent.appendChild(messageDiv);
                dialogContent.appendChild(buttonContainer);
                dialogOverlay.appendChild(dialogContent);
                document.body.appendChild(dialogOverlay);
                
                // í¬ì»¤ìŠ¤ ì„¤ì •
                hostButton.focus();
            });
        }
        
        // ë°© ìƒì„± í˜ì´ì§€ë¡œ ì´ë™
        function showCreateRoomPage() {
            // ì „ì—­ ì´ë¦„ ì…ë ¥ê°’ ê²€ì¦ (ë°© ìƒì„± ì „ í•„ìˆ˜ ì…ë ¥)
            const globalNameInput = document.getElementById('globalUserNameInput');
            const hostName = globalNameInput ? globalNameInput.value.trim() : '';
            
            if (hostName === '') {
                showCustomAlert('ì´ë¦„ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!', 'warning');
                if (globalNameInput) {
                    globalNameInput.focus();
                }
                return;
            }
            
            // ìœ íš¨ì„± ê²€ì‚¬
            if (!validateUserId(hostName)) {
                showCustomAlert('í•œê¸€, ì˜ë¬¸ ì†Œë¬¸ì, ìˆ«ì, _, -ë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'warning');
                if (globalNameInput) {
                    globalNameInput.focus();
                }
                return;
            }
            
            document.getElementById('lobbySection').classList.remove('active');
            document.getElementById('createRoomSection').classList.add('active');
            PageHistoryManager.pushPage('createRoom');

            // ê¸°ë³¸ê°’ ì„¤ì •
            document.getElementById('createRoomPrivateCheckbox').checked = false;
            document.getElementById('createRoomPasswordInput').value = '';
            document.getElementById('createRoomPasswordContainer').style.display = 'none';
            // IP ì°¨ë‹¨ ì˜µì…˜ UI ì œê±°ë¨ (blockIPPerUserëŠ” í•­ìƒ false)
            
            // ë°© ì œëª© ìë™ ìƒì„± (ë¡œì»¬ì—ì„œëŠ” "test", ê·¸ ì™¸ì—ëŠ” ì „ì—­ ì´ë¦„ ì‚¬ìš©)
            if (isLocalhost) {
                document.getElementById('createRoomNameInput').value = 'test';
            } else {
                document.getElementById('createRoomNameInput').value = `${hostName}ë‹˜ì˜ Dice`;
            }
            
            // ë°© ì œëª© ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
            setTimeout(() => {
                document.getElementById('createRoomNameInput').focus();
            }, 100);
        }
        
        // ê²Œì„ ì„¹ì…˜ì˜ ê²Œì„ ë£° ë¼ë””ì˜¤ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.addEventListener('DOMContentLoaded', () => {
            // ê²Œì„ ì„¹ì…˜ì˜ ê²Œì„ ë£° ë¼ë””ì˜¤ ë²„íŠ¼
            const gameRuleRadios = document.querySelectorAll('input[name="gameRule"]');
            gameRuleRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const nearContainer = document.getElementById('gameNearNumberContainer');
                    const customContainer = document.getElementById('gameCustomRuleContainer');
                    
                    if (this.value === 'near') {
                        nearContainer.style.display = 'block';
                        customContainer.style.display = 'none';
                        document.getElementById('gameCustomRuleInput').value = '';
                        updateGameRuleFromRadio();
                        updateGameRulesSaveButtonState();
                    } else if (this.value === 'custom') {
                        nearContainer.style.display = 'none';
                        customContainer.style.display = 'block';
                        document.getElementById('gameNearNumberInput').value = '';
                        updateGameRuleFromRadio();
                        updateGameRulesSaveButtonState();
                    } else {
                        nearContainer.style.display = 'none';
                        customContainer.style.display = 'none';
                        document.getElementById('gameNearNumberInput').value = '';
                        document.getElementById('gameCustomRuleInput').value = '';
                        updateGameRuleFromRadio();
                        updateGameRulesSaveButtonState();
                    }
                });
            });
            
            // ë‹ˆì–´ ìˆ«ì ì…ë ¥ ì´ë²¤íŠ¸
            const gameNearNumberInput = document.getElementById('gameNearNumberInput');
            if (gameNearNumberInput) {
                gameNearNumberInput.addEventListener('input', function() {
                    updateGameRuleFromRadio();
                    updateGameRulesSaveButtonState();
                });
            }
            
            // ê¸°íƒ€ ë£° ì…ë ¥ ì´ë²¤íŠ¸
            const gameCustomRuleInput = document.getElementById('gameCustomRuleInput');
            if (gameCustomRuleInput) {
                gameCustomRuleInput.addEventListener('input', function() {
                    updateGameRuleFromRadio();
                    updateGameRulesSaveButtonState();
                });
            }
        });
        
        // ì €ì¥ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” ìƒíƒœ í™•ì¸
        function updateGameRulesSaveButtonState() {
            const rulesSaveButton = document.getElementById('gameRulesSaveButton');
            if (!rulesSaveButton) return;
            
            const selectedRule = document.querySelector('input[name="gameRule"]:checked');
            
            // ë¼ë””ì˜¤ ë²„íŠ¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìœ¼ë©´ ë¹„í™œì„±í™”
            if (!selectedRule) {
                rulesSaveButton.disabled = true;
                return;
            }
            
            // ë‹ˆì–´ ì„ íƒ ì‹œ ìˆ«ì ì…ë ¥ í™•ì¸
            if (selectedRule.value === 'near') {
                const nearNumber = document.getElementById('gameNearNumberInput').value.trim();
                rulesSaveButton.disabled = !nearNumber || nearNumber === '';
                return;
            }
            
            // ê¸°íƒ€ ì„ íƒ ì‹œ í…ìŠ¤íŠ¸ ì…ë ¥ í™•ì¸
            if (selectedRule.value === 'custom') {
                const customRule = document.getElementById('gameCustomRuleInput').value.trim();
                rulesSaveButton.disabled = !customRule || customRule === '';
                return;
            }
            
            // í•˜ì´/ë¡œìš°ëŠ” í•­ìƒ í™œì„±í™”
            rulesSaveButton.disabled = false;
        }
        
        // ê²Œì„ ì„¹ì…˜ì—ì„œ ë¼ë””ì˜¤ ë²„íŠ¼ ì„ íƒì— ë”°ë¼ ë£° í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        function updateGameRuleFromRadio() {
            const selectedRule = document.querySelector('input[name="gameRule"]:checked');
            if (!selectedRule) {
                updateGameRulesSaveButtonState();
                return;
            }
            
            const rulesInput = document.getElementById('gameRulesInput');
            if (!rulesInput) return;
            
            let ruleText = '';
            
            if (selectedRule.value === 'high') {
                ruleText = 'í•˜ì´ - ë‚®ì€ ì‚¬ëŒì´ ê±¸ë¦¼';
            } else if (selectedRule.value === 'low') {
                ruleText = 'ë¡œìš° - ë†’ì€ ì‚¬ëŒì´ ê±¸ë¦¼';
            } else if (selectedRule.value === 'near') {
                const nearNumber = document.getElementById('gameNearNumberInput').value.trim();
                if (nearNumber) {
                    ruleText = `ë‹ˆì–´ ${nearNumber} - ${nearNumber}ì— ê°€ê¹Œìš´ ì‚¬ëŒ ê±¸ë¦¬ê¸°`;
                } else {
                    ruleText = 'ë‹ˆì–´ - Nì— ê°€ê¹Œìš´ ì‚¬ëŒ ê±¸ë¦¬ê¸°';
                }
            } else if (selectedRule.value === 'custom') {
                ruleText = document.getElementById('gameCustomRuleInput').value.trim();
            }
            
            rulesInput.value = ruleText;
            updateGameRulesSaveButtonState();
        }
        
        // ë¹„ê³µê°œ ë°© ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
        document.addEventListener('DOMContentLoaded', () => {
            const privateCheckbox = document.getElementById('createRoomPrivateCheckbox');
            const passwordContainer = document.getElementById('createRoomPasswordContainer');
            
            if (privateCheckbox && passwordContainer) {
                privateCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        passwordContainer.style.display = 'block';
                        document.getElementById('createRoomPasswordInput').focus();
                    } else {
                        passwordContainer.style.display = 'none';
                        document.getElementById('createRoomPasswordInput').value = '';
                    }
                });
            }
            
            // localhostì—ì„œ ê²½ë§ˆ ë²„íŠ¼ í™œì„±í™”
            checkAndEnableHorseRace();
        });
        
        // ëŒ€ê¸°ì‹¤ë¡œ ëŒì•„ê°€ê¸°
        function goBackToLobby() {
            history.back();
        }
        
        // ê²½ë§ˆ ë²„íŠ¼ì€ HTMLì—ì„œ ì´ë¯¸ í™œì„±í™” ìƒíƒœ (ë³„ë„ ì²˜ë¦¬ ë¶ˆí•„ìš”)
        function checkAndEnableHorseRace() {
        }
        
        // ë°© ìƒì„± ìµœì¢… í™•ì¸ ë° ìƒì„±
        function finalizeRoomCreation() {
            const globalNameInput = document.getElementById('globalUserNameInput');
            const roomNameInput = document.getElementById('createRoomNameInput');
            
            const hostName = globalNameInput ? globalNameInput.value.trim() : '';
            const roomName = roomNameInput.value.trim();
            
            if (hostName === '') {
                showCustomAlert('ì´ë¦„ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”! ëŒ€ê¸°ì‹¤ë¡œ ëŒì•„ê°€ì„œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.', 'warning');
                goBackToLobby();
                if (globalNameInput) {
                    globalNameInput.focus();
                }
                return;
            }
            
            // ìœ íš¨ì„± ê²€ì‚¬
            if (!validateUserId(hostName)) {
                showCustomAlert('í•œê¸€, ì˜ë¬¸ ì†Œë¬¸ì, ìˆ«ì, _, -ë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'warning');
                goBackToLobby();
                if (globalNameInput) {
                    globalNameInput.focus();
                }
                return;
            }
            
            if (roomName === '') {
                showCustomAlert('ë°© ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!', 'warning');
                roomNameInput.focus();
                return;
            }
            
            // ë¹„ê³µê°œ ë°© ì„¤ì • í™•ì¸
            const isPrivate = document.getElementById('createRoomPrivateCheckbox').checked;
            const password = document.getElementById('createRoomPasswordInput').value.trim();
            
            if (isPrivate) {
                if (password === '') {
                    showCustomAlert('ë¹„ê³µê°œ ë°©ì€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!', 'warning');
                    document.getElementById('createRoomPasswordInput').focus();
                    return;
                }
                
                if (password.length < 4 || password.length > 20) {
                    showCustomAlert('ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒ 20ì ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤!', 'warning');
                    document.getElementById('createRoomPasswordInput').focus();
                    return;
                }
            }
            
            // ë°© ìœ ì§€ ì‹œê°„ ê°€ì ¸ì˜¤ê¸° (ê¸°ë³¸ê°’: 3ì‹œê°„)
            const expiryTimeRadio = document.querySelector('input[name="roomExpiryTime"]:checked');
            const expiryHours = expiryTimeRadio ? parseInt(expiryTimeRadio.value) : 3;
            
            // IP ì°¨ë‹¨ ì˜µì…˜ ê°€ì ¸ì˜¤ê¸° (ê¸°ë³¸ê°’: false)
            const ipBlockCheckbox = document.getElementById('createRoomIPBlockCheckbox');
            const blockIPPerUser = ipBlockCheckbox ? ipBlockCheckbox.checked : false;
            
            // ê²Œì„ íƒ€ì… ê°€ì ¸ì˜¤ê¸° (disabled ìƒíƒœì™€ ê´€ê³„ì—†ì´ ì²´í¬ëœ ë¼ë””ì˜¤ ë²„íŠ¼ ì°¾ê¸°)
            let gameType = 'dice';
            const gameTypeRadios = document.querySelectorAll('input[name="gameType"]');
            const checkedRadio = Array.from(gameTypeRadios).find(r => r.checked);
            
            if (checkedRadio) {
                gameType = checkedRadio.value;
            }
            
            // ë””ë²„ê¹…: ëª¨ë“  ë¼ë””ì˜¤ ë²„íŠ¼ ìƒíƒœ í™•ì¸
            console.log('ê²Œì„ íƒ€ì… ì„ íƒ ìƒíƒœ:', {
                gameType: gameType,
                checkedRadio: checkedRadio ? { value: checkedRadio.value, disabled: checkedRadio.disabled } : null,
                allRadios: Array.from(gameTypeRadios).map(r => ({
                    value: r.value,
                    checked: r.checked,
                    disabled: r.disabled
                }))
            });
            
            // ë£°ë › ê²Œì„ì´ë©´ ë£°ë › í˜ì´ì§€ë¡œ ì´ë™
            if (gameType === 'roulette') {
                // ì´ë¦„ì„ ì €ì¥í•˜ê³  ë£°ë › í˜ì´ì§€ë¡œ ì´ë™
                localStorage.setItem('rouletteUserName', hostName);
                localStorage.setItem('pendingRouletteRoom', JSON.stringify({
                    userName: hostName,
                    roomName: roomName,
                    isPrivate: isPrivate,
                    password: isPrivate ? password : '',
                    expiryHours: expiryHours,
                    blockIPPerUser: blockIPPerUser,
                    serverId: currentServerId,
                    serverName: currentServerName
                }));
                window.location.href = '/roulette-game-multiplayer.html?createRoom=true';
                return;
            }

            // ê²½ë§ˆ ê²Œì„ì´ë©´ ê²½ë§ˆ í˜ì´ì§€ë¡œ ì´ë™
            if (gameType === 'horse-race') {
                // ì´ë¦„ì„ ì €ì¥í•˜ê³  ê²½ë§ˆ í˜ì´ì§€ë¡œ ì´ë™
                localStorage.setItem('horseRaceUserName', hostName);
                localStorage.setItem('pendingHorseRaceRoom', JSON.stringify({
                    userName: hostName,
                    roomName: roomName,
                    isPrivate: isPrivate,
                    password: isPrivate ? password : '',
                    expiryHours: expiryHours,
                    blockIPPerUser: blockIPPerUser,
                    serverId: currentServerId,
                    serverName: currentServerName
                }));
                window.location.href = '/horse-race-multiplayer.html?createRoom=true';
                return;
            }
            
            // ë°© ìƒì„± (ê²Œì„ ë£°ì€ ë°© ìƒì„± í›„ ì„¤ì •)
            socket.emit('createRoom', {
                userName: hostName,
                roomName: roomName,
                isPrivate: isPrivate,
                password: isPrivate ? password : '',
                gameType: 'dice', // ê²Œì„ íƒ€ì… (ì£¼ì‚¬ìœ„ ê²Œì„)
                expiryHours: expiryHours, // ë°© ìœ ì§€ ì‹œê°„ (ì‹œê°„ ë‹¨ìœ„)
                blockIPPerUser: blockIPPerUser, // IPë‹¹ í•˜ë‚˜ì˜ ì•„ì´ë””ë§Œ ì…ì¥ í—ˆìš©
                serverId: currentServerId, // ì„œë²„ ì†Œì†
                serverName: currentServerName // ì„œë²„ ì´ë¦„
            });
        }
        
        // ë°© ì…ì¥
        function joinSelectedRoom() {
            if (!selectedRoomId) {
                showCustomAlert('ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”!', 'warning');
                return;
            }
            
            const globalNameInput = document.getElementById('globalUserNameInput');
            const userName = globalNameInput.value.trim();
            
            if (userName === '') {
                showCustomAlert('ì´ë¦„ì„ ì…ë ¥í•´ì•¼ ì…ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'warning');
                globalNameInput.focus();
                return;
            }
            
            // ë°© ì •ë³´ í™•ì¸ (ë¹„ê³µê°œ ë°©ì¸ì§€ ì²´í¬)
            const room = roomsList.find(r => r.roomId === selectedRoomId);
            
            // ë£°ë › ë°©ì´ë©´ ë£°ë › í˜ì´ì§€ë¡œ ì´ë™
            if (room && room.gameType === 'roulette') {
                localStorage.setItem('rouletteUserName', userName);
                localStorage.setItem('pendingRouletteJoin', JSON.stringify({
                    roomId: selectedRoomId,
                    userName: userName,
                    isPrivate: room.isPrivate,
                    serverId: currentServerId,
                    serverName: currentServerName
                }));
                window.location.href = '/roulette-game-multiplayer.html?joinRoom=true';
                return;
            }
            
            // ê²½ë§ˆ ë°©ì´ë©´ ê²½ë§ˆ í˜ì´ì§€ë¡œ ì´ë™
            if (room && room.gameType === 'horse-race') {
                localStorage.setItem('horseRaceUserName', userName);
                localStorage.setItem('pendingHorseRaceJoin', JSON.stringify({
                    roomId: selectedRoomId,
                    userName: userName,
                    isPrivate: room.isPrivate,
                    serverId: currentServerId,
                    serverName: currentServerName
                }));
                window.location.href = '/horse-race-multiplayer.html?joinRoom=true';
                return;
            }
            
            if (room && room.isPrivate) {
                // ë¹„ê³µê°œ ë°©ì´ë©´ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ëª¨ë‹¬ í‘œì‹œ
                showPasswordModal(selectedRoomId, userName);
            } else {
                // ê³µê°œ ë°©ì´ë©´ ë°”ë¡œ ì…ì¥
                socket.emit('joinRoom', {
                    roomId: selectedRoomId,
                    userName: userName,
                    isHost: false,
                    password: '',
                    deviceId: getDeviceId()
                });
            }
        }
        
        // ì „ì—­ ì´ë¦„ ì…ë ¥ì°½ ì´ˆê¸°í™” (localStorageì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°)
        document.addEventListener('DOMContentLoaded', () => {
            const globalNameInput = document.getElementById('globalUserNameInput');
            const userNameError = document.getElementById('userNameError');
            
            if (globalNameInput) {
                // localStorageì—ì„œ ì´ë¦„ ë¶ˆëŸ¬ì˜¤ê¸°
                const savedName = localStorage.getItem('diceGameUserName');
                if (savedName) {
                    globalNameInput.value = savedName;
                }
                
                // ì´ë¦„ì´ ë³€ê²½ë  ë•Œë§ˆë‹¤ ìœ íš¨ì„± ê²€ì‚¬ ë° localStorageì— ì €ì¥
                globalNameInput.addEventListener('input', () => {
                    const userName = globalNameInput.value.trim();
                    
                    // ìœ íš¨ì„± ê²€ì‚¬
                    if (userName && !validateUserId(userName)) {
                        if (userNameError) {
                            userNameError.textContent = 'í•œê¸€, ì˜ë¬¸ ì†Œë¬¸ì, ìˆ«ì, _, -ë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤. (ê³µë°±/íŠ¹ìˆ˜ë¬¸ì ë¶ˆê°€)';
                            userNameError.style.display = 'block';
                        }
                        globalNameInput.style.borderColor = '#dc3545';
                    } else {
                        if (userNameError) {
                            userNameError.style.display = 'none';
                        }
                        globalNameInput.style.borderColor = '';
                        
                        // ìœ íš¨í•œ ì´ë¦„ë§Œ localStorageì— ì €ì¥
                        if (userName) {
                            localStorage.setItem('diceGameUserName', userName);
                        }
                    }
                });
                
                // í¬ì»¤ìŠ¤ ì•„ì›ƒ ì‹œ ìœ íš¨í•˜ì§€ ì•Šì€ ë¬¸ì ìë™ ì œê±° (ì‚¬ìš©ì í¸ì˜)
                globalNameInput.addEventListener('blur', () => {
                    const userName = globalNameInput.value.trim();
                    if (userName && !validateUserId(userName)) {
                        // ìœ íš¨í•˜ì§€ ì•Šì€ ë¬¸ì ì œê±° (í•œê¸€+ìëª¨ìŒ, ì˜ë¬¸ ì†Œë¬¸ì, ìˆ«ì, _, - ìœ ì§€)
                        const cleaned = userName.toLowerCase().replace(/[^ê°€-í£ã„±-ã…ã…-ã…£a-z0-9_-]/g, '');
                        globalNameInput.value = cleaned;
                        if (cleaned) {
                            localStorage.setItem('diceGameUserName', cleaned);
                        }
                        if (userNameError) {
                            userNameError.style.display = 'none';
                        }
                        globalNameInput.style.borderColor = '';
                    }
                });
            }
            
            // ë°© ì œëª© ì…ë ¥ì°½ì—ì„œ ì´ë¦„ ê¸°ë°˜ ìë™ ì—…ë°ì´íŠ¸
            const roomNameInput = document.getElementById('createRoomNameInput');
            if (globalNameInput && roomNameInput) {
                let isUpdating = false;
                globalNameInput.addEventListener('input', () => {
                    if (isUpdating) return;
                    // ë¡œì»¬ì—ì„œëŠ” ìë™ ì—…ë°ì´íŠ¸ ì•ˆ í•¨
                    if (isLocalhost) return;
                    
                    const hostName = globalNameInput.value.trim();
                    // ë°© ì œëª©ì´ ê¸°ë³¸ í˜•ì‹ì´ê±°ë‚˜ ë¹„ì–´ìˆì„ ë•Œë§Œ ìë™ ì—…ë°ì´íŠ¸ (ë°© ìƒì„± í˜ì´ì§€ê°€ ì—´ë ¤ìˆì„ ë•Œë§Œ)
                    const createRoomSection = document.getElementById('createRoomSection');
                    if (!createRoomSection || !createRoomSection.classList.contains('active')) return;
                    
                    const currentRoomName = roomNameInput.value.trim();
                    if (!currentRoomName || currentRoomName.endsWith('ë‹˜ì˜ Dice')) {
                        isUpdating = true;
                        roomNameInput.value = hostName ? `${hostName}ë‹˜ì˜ Dice` : '';
                        isUpdating = false;
                    }
                });
            }
        });
        
        // ë°© ìƒì„± ì„±ê³µ
        socket.on('roomCreated', (data) => {
            currentRoomId = data.roomId;
            // ë°© ìƒì„± ì‹œ ì…ë ¥í•œ ì´ë¦„ ì‚¬ìš© (globalUserNameInput)
            const globalNameInput = document.getElementById('globalUserNameInput');
            currentUser = globalNameInput ? globalNameInput.value.trim() : data.userName;
            initChatModule();
            isHost = true;
            
            document.getElementById('lobbySection').classList.remove('active');
            document.getElementById('createRoomSection').classList.remove('active');
            document.getElementById('gameSection').classList.add('active');

            // body í´ë˜ìŠ¤ ë³€ê²½
            document.body.classList.remove('lobby-active');
            document.body.classList.add('game-active');
            PageHistoryManager.pushPage('gameRoom');

            // ê²Œì„ ê¸°ë¡ ì„¹ì…˜ í‘œì‹œ
            document.querySelector('.history-section').classList.add('visible');

            initializeGameScreen(data);
        });

        // ë°© ì…ì¥ ì„±ê³µ
        socket.on('roomJoined', (data) => {
            currentRoomId = data.roomId;
            // ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ì´ë¦„ ì‚¬ìš© (ì¤‘ë³µ ì‹œ _1, _2 ë“±ì´ ë¶™ì„ ìˆ˜ ìˆìŒ)
            currentUser = data.userName;
            initChatModule();
            isHost = data.isHost;
            
            // ì´ë¦„ì´ ë³€ê²½ë˜ì—ˆìœ¼ë©´ ì•Œë¦¼ í‘œì‹œ ë° ë¡œì»¬ ì €ì¥ì†Œ ì—…ë°ì´íŠ¸
            const globalNameInput = document.getElementById('globalUserNameInput');
            const originalName = globalNameInput ? globalNameInput.value.trim() : '';
            if (originalName && originalName !== data.userName) {
                showCustomAlert(`ì¤‘ë³µëœ ì´ë¦„ì´ ìˆì–´ "${data.userName}"(ìœ¼)ë¡œ ì…ì¥í•©ë‹ˆë‹¤.`, 'info');
                // ë¡œì»¬ ì €ì¥ì†Œì—ë„ ë³€ê²½ëœ ì´ë¦„ ì €ì¥
                localStorage.setItem('diceGameUserName', data.userName);
                if (globalNameInput) {
                    globalNameInput.value = data.userName;
                }
            }
            
            document.getElementById('lobbySection').classList.remove('active');
            document.getElementById('gameSection').classList.add('active');

            // body í´ë˜ìŠ¤ ë³€ê²½
            document.body.classList.remove('lobby-active');
            document.body.classList.add('game-active');
            PageHistoryManager.pushPage('gameRoom');

            // ê²Œì„ ê¸°ë¡ ì„¹ì…˜ í‘œì‹œ
            document.querySelector('.history-section').classList.add('visible');

            initializeGameScreen(data);
        });

        // ê²Œì„ í™”ë©´ ì´ˆê¸°í™”
        function initializeGameScreen(data) {
            // ì„œë²„ì—ì„œ ë°›ì€ ëˆ„ì  ì°¸ì—¬ì ëª©ë¡ ë³µì›
            if (data.everPlayedUsers && Array.isArray(data.everPlayedUsers)) {
                everPlayedUsers = [...data.everPlayedUsers];
            } else if (data.gameState && data.gameState.everPlayedUsers && Array.isArray(data.gameState.everPlayedUsers)) {
                everPlayedUsers = [...data.gameState.everPlayedUsers];
            } else {
                everPlayedUsers = [];
            }
            
            hasRolledInCurrentGame = data.hasRolled;
            myDiceSettings = data.diceSettings || { max: 100 };
            isGameActive = data.isGameActive;
            isOrderActive = data.isOrderActive;
            OrderModule.setIsOrderActive(isOrderActive);

            // ê²Œì„ ê¸°ë¡ ì œëª© ì„¤ì •
            const historyTitle = document.getElementById('historyTitle');
            if (historyTitle) {
                historyTitle.textContent = isGameActive ? 'ğŸ“‹ ê²Œì„' : 'ğŸ“‹ ì—°ìŠµ';
            }
            
            // ë¹„ê³µê°œ ë°© ë¹„ë°€ë²ˆí˜¸ í‘œì‹œ
            const passwordDisplay = document.getElementById('roomPasswordDisplay');
            if (data.isPrivate && data.password) {
                passwordDisplay.textContent = `ë¹„ë°€ë²ˆí˜¸: ${data.password}`;
                passwordDisplay.style.display = 'inline-block';
            } else {
                passwordDisplay.style.display = 'none';
            }
            
            // ë°© ìƒíƒœ ì•„ì´ì½˜ í‘œì‹œ (IP ì°¨ë‹¨ë§Œ)
            const roomStatusIcons = document.getElementById('roomStatusIcons');
            roomStatusIcons.innerHTML = '';
            
            // IP ì°¨ë‹¨ ì˜µì…˜ì´ í™œì„±í™”ëœ ê²½ìš°ì—ë§Œ ì•„ì´ì½˜ í‘œì‹œ
            if (data.blockIPPerUser) {
                const ipBlockIcon = document.createElement('span');
                ipBlockIcon.textContent = 'ğŸ”';
                ipBlockIcon.title = 'IPë‹¹ í•˜ë‚˜ì˜ ì•„ì´ë””ë§Œ ì…ì¥ í—ˆìš©';
                ipBlockIcon.style.fontSize = '16px';
                roomStatusIcons.appendChild(ipBlockIcon);
                roomStatusIcons.style.display = 'flex';
            } else {
                roomStatusIcons.style.display = 'none';
            }
            
            // ë°© ì œëª© í‘œì‹œ (ì„œë²„ ì´ë¦„ í¬í•¨)
            const _serverTag = currentServerName ? `[${currentServerName}] ` : '';
            document.getElementById('roomNameText').textContent = _serverTag + (data.roomName || 'ë°©');
            
            // í˜¸ìŠ¤íŠ¸ë©´ ë°© ì œëª© ë³€ê²½ ë²„íŠ¼ í‘œì‹œ
            if (isHost) {
                document.getElementById('editRoomNameButton').style.display = 'inline-block';
            } else {
                document.getElementById('editRoomNameButton').style.display = 'none';
            }
            
            document.getElementById('currentUser').textContent = currentUser;

            // ë‚´ ì£¼ë¬¸ ë¶ˆëŸ¬ì˜¤ê¸°
            document.getElementById('myOrderInput').value = data.myOrder || '';

            if (isHost) {
                document.getElementById('hostBadge').style.display = 'inline-block';
                document.getElementById('hostControls').style.display = 'grid';
                
                // í˜¸ìŠ¤íŠ¸ ì»¨íŠ¸ë¡¤ í‘œì‹œ í›„ ì£¼ë¬¸ë°›ê¸° ë²„íŠ¼ ìƒíƒœ í™•ì¸
                setTimeout(() => {
                    if (!isOrderActive && !isGameActive) {
                        const startOrderBtn = document.getElementById('startOrderButton');
                        const endOrderBtn = document.getElementById('endOrderButton');
                        if (startOrderBtn) {
                            startOrderBtn.style.display = 'block';
                        }
                        if (endOrderBtn) {
                            endOrderBtn.style.display = 'none';
                        }
                    }
                }, 100);
            }
            
            // ê²Œì„ ë£° ë¶ˆëŸ¬ì˜¤ê¸°
            if (data.gameRules !== undefined) {
                document.getElementById('gameRulesInput').value = data.gameRules || '';
            }
            
            // ìì£¼ ì“°ëŠ” ë©”ë‰´ ë¶ˆëŸ¬ì˜¤ê¸°
            if (data.frequentMenus !== undefined) {
                frequentMenus = data.frequentMenus;
                OrderModule.renderMenuList();
            } else {
                OrderModule.loadFrequentMenus();
            }
            
            // ì¤€ë¹„ ìƒíƒœ ì´ˆê¸°í™”
            readyUsers = data.readyUsers || [];
            isReady = data.isReady || false;
            
            // ê²Œì„ ë£° UI ì—…ë°ì´íŠ¸ (ì´ˆê¸°í™” í›„ ë°˜ë“œì‹œ í˜¸ì¶œ)
            setTimeout(() => {
                updateGameRulesUI();
            }, 100);
            renderReadyUsers();
            updateReadyButton();
            
            // ê²Œì„ì´ ì‹œì‘ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì¤€ë¹„ ì„¹ì…˜ í‘œì‹œ
            if (!isGameActive) {
                document.getElementById('readySection').style.display = 'block';
            } else {
                document.getElementById('readySection').style.display = 'none';
            }
            
            // í˜¸ìŠ¤íŠ¸ UI ì—…ë°ì´íŠ¸ (ë“œë˜ê·¸ ì•ˆë‚´ ë©˜íŠ¸ í¬í•¨)
            updateHostUI();
            
            // ê²Œì„ ìƒíƒœ ë°˜ì˜
            if (data.gameState) {
                historyData = data.gameState.history || [];
                ordersData = data.gameState.userOrders || {};
                OrderModule.setOrdersData(ordersData);
                usersList = data.gameState.users || [];
                gamePlayers = data.gameState.gamePlayers || []; // ê²Œì„ ì°¸ì—¬ì ëª©ë¡ ì €ì¥
                
                // ê²Œì„ ì§„í–‰ ì¤‘ì¼ ë•Œ rolledUsers ë³µì›
                if (isGameActive && data.gameState.rolledUsers) {
                    rolledUsersInGame = [...data.gameState.rolledUsers];
                } else {
                    rolledUsersInGame = [];
                }
                
                renderHistory();
                OrderModule.renderOrders();
                updateUsers(usersList);
                
                // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
                if (isGameActive && gamePlayers.length > 0) {
                    const rolled = rolledUsersInGame.length;
                    const total = gamePlayers.length;
                    updateProgress({
                        rolled: rolled,
                        total: total,
                        notRolledYet: gamePlayers.filter(p => !rolledUsersInGame.includes(p))
                    });
                }
                
                // êµ´ë¦° ì¸ì› ìˆ˜ ì—…ë°ì´íŠ¸
                updateRolledUsersCount();
            }
            
            // ì£¼ë¬¸ë°›ê¸°ê°€ í™œì„±í™”ëœ ìƒíƒœë©´ ì£¼ë¬¸í•˜ì§€ ì•Šì€ ì‚¬ëŒ ëª©ë¡ë„ í‘œì‹œ
            if (isOrderActive) {
                setTimeout(() => {
                    OrderModule.renderNotOrderedUsers();
                }, 100);
            }
            
            // ì±„íŒ… ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (í•­ìƒ ì´ˆê¸°í™”)
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                chatMessages.innerHTML = ''; // ê¸°ì¡´ ë©”ì‹œì§€ ì´ˆê¸°í™”
                clientChatHistory = []; // í´ë¼ì´ì–¸íŠ¸ ì±„íŒ… ê¸°ë¡ ì´ˆê¸°í™”
                
                if (data.chatHistory && data.chatHistory.length > 0) {
                    // ì±„íŒ… ê¸°ë¡ì„ ìˆœì„œëŒ€ë¡œ í‘œì‹œ
                    data.chatHistory.forEach((chatMessage, index) => {
                        // reactions í•„ë“œ ì´ˆê¸°í™”
                        if (!chatMessage.reactions) {
                            chatMessage.reactions = {};
                        }
                        clientChatHistory.push(chatMessage);
                        displayChatMessage(chatMessage);
                    });
                    
                    // ê³ ì • ë©”ì‹œì§€ ì¬ê³„ì‚°
                    ChatModule.recalculatePins();

                    // ì±„íŒ… ì˜ì—­ ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
                    setTimeout(() => {
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }, 100);
                } else {
                    // ì±„íŒ… ê¸°ë¡ì´ ì—†ìœ¼ë©´ ë¹ˆ ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
                    const emptyMessage = document.createElement('div');
                    emptyMessage.textContent = 'ì±„íŒ… ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤';
                    emptyMessage.style.textAlign = 'center';
                    emptyMessage.style.color = '#999';
                    emptyMessage.style.padding = '20px';
                    chatMessages.appendChild(emptyMessage);
                }
            }

            // ë°© í­íŒŒ ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
            if (data.createdAt) {
                const expiryHours = data.expiryHours || 3; // ê¸°ë³¸ê°’ 3ì‹œê°„
                startRoomExpiryCountdown(data.createdAt, expiryHours);
            }

            // ì¬ì ‘ì† ì²˜ë¦¬
            if (isGameActive && data.isGamePlayer) {
                document.getElementById('gameStatus').textContent = 'ê²Œì„ ì§„í–‰ ì¤‘!';
                document.getElementById('gameStatus').classList.remove('waiting');
                document.getElementById('gameStatus').classList.add('playing');
                document.getElementById('progressSection').style.display = 'block';
                
                // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸ (ì¬ì ‘ì† ì‹œì—ë„)
                if (gamePlayers.length > 0) {
                    const rolled = rolledUsersInGame.length;
                    const total = gamePlayers.length;
                    updateProgress({
                        rolled: rolled,
                        total: total,
                        notRolledYet: gamePlayers.filter(p => !rolledUsersInGame.includes(p))
                    });
                }
                
                if (isHost) {
                    document.getElementById('startButton').style.display = 'none';
                    document.getElementById('endButton').style.display = 'block';
                }
                
                const reconnectNotice = document.getElementById('reconnectNotice');
                const reconnectMessage = document.getElementById('reconnectMessage');
                
                if (data.hasRolled && data.myResult) {
                    reconnectNotice.style.display = 'block';
                    reconnectMessage.textContent = `ì´ë¯¸ ì£¼ì‚¬ìœ„ë¥¼ êµ´ë ¸ìŠµë‹ˆë‹¤. ê²°ê³¼: ${data.myResult.result}`;
                } else {
                    hasRolledInCurrentGame = false;
                    
                    reconnectNotice.style.display = 'block';
                    reconnectMessage.textContent = 'ì•„ì§ ì£¼ì‚¬ìœ„ë¥¼ êµ´ë¦¬ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. /ì£¼ì‚¬ìœ„ ëª…ë ¹ì–´ë¡œ êµ´ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤!';
                    reconnectMessage.style.color = '#155724';
                    reconnectNotice.style.background = '#d4edda';
                    reconnectNotice.style.borderColor = '#28a745';
                }
            }
            
            // ì£¼ë¬¸ë°›ê¸° ì„¹ì…˜ í•­ìƒ í‘œì‹œ
            document.getElementById('ordersSection').style.display = 'block';
            
            // ì£¼ë¬¸ë°›ê¸° ìƒíƒœ ë°˜ì˜
            if (isOrderActive) {
                document.getElementById('ordersSection').classList.add('active');
                document.getElementById('myOrderInput').disabled = false;
                document.getElementById('orderSaveButton').disabled = false;
                document.getElementById('gameStatus').textContent = 'ì£¼ë¬¸ë°›ê¸° ì§„í–‰ ì¤‘!';
                document.getElementById('gameStatus').classList.remove('waiting');
                document.getElementById('gameStatus').classList.remove('playing');
                document.getElementById('gameStatus').classList.add('ordering');
                
                if (isHost) {
                    document.getElementById('startOrderButton').style.display = 'none';
                    document.getElementById('endOrderButton').style.display = 'block';
                }
                
                // ì£¼ë¬¸ ëª©ë¡ê³¼ ì£¼ë¬¸í•˜ì§€ ì•Šì€ ì‚¬ëŒ ëª©ë¡ í‘œì‹œ
                OrderModule.renderOrders();
                OrderModule.renderNotOrderedUsers();
            } else {
                // ì£¼ë¬¸ë°›ê¸°ê°€ ë¹„í™œì„±í™”ëœ ìƒíƒœ
                document.getElementById('ordersSection').classList.remove('active');
                document.getElementById('myOrderInput').disabled = true;
                document.getElementById('orderSaveButton').disabled = true;
                
                if (!isGameActive) {
                    document.getElementById('gameStatus').textContent = 'ê²Œì„ ëŒ€ê¸° ì¤‘...';
                    document.getElementById('gameStatus').classList.remove('ordering');
                    document.getElementById('gameStatus').classList.remove('playing');
                    document.getElementById('gameStatus').classList.add('waiting');
                }
                
                if (isHost && !isGameActive) {
                    // ê²Œì„ì´ ë¹„í™œì„±í™”ë˜ê³  ì£¼ë¬¸ë°›ê¸°ë„ ë¹„í™œì„±í™”ëœ ìƒíƒœì—ì„œ Hostì—ê²Œ ì£¼ë¬¸ë°›ê¸° ì‹œì‘ ë²„íŠ¼ í‘œì‹œ
                    const startOrderBtn = document.getElementById('startOrderButton');
                    const endOrderBtn = document.getElementById('endOrderButton');
                    if (startOrderBtn) {
                        startOrderBtn.style.display = 'block';
                    }
                    if (endOrderBtn) {
                        endOrderBtn.style.display = 'none';
                    }
                } else if (isHost) {
                    // ê²Œì„ ì§„í–‰ ì¤‘ì´ë©´ ì£¼ë¬¸ë°›ê¸° ë²„íŠ¼ ìˆ¨ê¹€
                    const startOrderBtn = document.getElementById('startOrderButton');
                    const endOrderBtn = document.getElementById('endOrderButton');
                    if (startOrderBtn) {
                        startOrderBtn.style.display = 'none';
                    }
                    if (endOrderBtn) {
                        endOrderBtn.style.display = 'none';
                    }
                }
                
                // ì£¼ë¬¸ë°›ê¸°ê°€ ì¢…ë£Œë˜ì–´ë„ ì£¼ë¬¸ ëª©ë¡ì€ í‘œì‹œ
                OrderModule.renderOrders();
                OrderModule.renderNotOrderedUsers();
            }
            
            // í˜¸ìŠ¤íŠ¸ì´ê³  ê²Œì„ì´ ì§„í–‰ ì¤‘ì´ ì•„ë‹ˆê³  ì£¼ë¬¸ë°›ê¸°ë„ ë¹„í™œì„±í™”ëœ ê²½ìš° ì£¼ë¬¸ë°›ê¸° ì‹œì‘ ë²„íŠ¼ ê°•ì œ í‘œì‹œ
            if (isHost && !isGameActive && !isOrderActive) {
                setTimeout(() => {
                    const startOrderBtn = document.getElementById('startOrderButton');
                    const hostControls = document.getElementById('hostControls');
                    if (startOrderBtn && hostControls && hostControls.style.display !== 'none') {
                        startOrderBtn.style.display = 'block';
                        console.log('ì£¼ë¬¸ë°›ê¸° ì‹œì‘ ë²„íŠ¼ í‘œì‹œ:', isHost, isGameActive, isOrderActive);
                    }
                }, 200);
            }
        }
        
        // ë°© ì—ëŸ¬ ì²˜ë¦¬
        socket.on('roomError', (message) => {
            showCustomAlert(message, 'info');
        });
        
        // ë°© ì‚­ì œ ì•Œë¦¼ (ëª¨ë“  ì‚¬ìš©ìê°€ ë‚˜ê°)
        socket.on('roomDeleted', (data) => {
            showCustomAlert(data.message || data.reason || 'ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            
            // ì¹´ìš´íŠ¸ë‹¤ìš´ ì¤‘ì§€
            if (roomExpiryInterval) {
                clearInterval(roomExpiryInterval);
                roomExpiryInterval = null;
            }
            
            document.getElementById('gameSection').classList.remove('active');
            document.getElementById('lobbySection').classList.add('active');

            // body í´ë˜ìŠ¤ ë³€ê²½
            document.body.classList.remove('game-active');
            document.body.classList.add('lobby-active');
            PageHistoryManager.replacePage('lobby');

            currentRoomId = null;
            currentUser = '';
            isHost = false;
            refreshRooms();
        });
        
        // ë°© í­íŒŒ ì¹´ìš´íŠ¸ë‹¤ìš´ í•¨ìˆ˜
        function startRoomExpiryCountdown(createdAt, expiryHours) {
            // ê¸°ì¡´ ì¸í„°ë²Œ ì •ë¦¬
            if (roomExpiryInterval) {
                clearInterval(roomExpiryInterval);
            }
            
            const expirySection = document.getElementById('roomExpirySection');
            const countdownElement = document.getElementById('roomExpiryCountdown');
            
            if (!expirySection || !countdownElement) return;
            
            expirySection.style.display = 'block';
            
            const expiryHoursValue = expiryHours || 3; // ê¸°ë³¸ê°’ 3ì‹œê°„
            
            function updateCountdown() {
                const now = new Date();
                const createdAtDate = new Date(createdAt);
                const expiryHoursInMs = expiryHoursValue * 60 * 60 * 1000;
                const expiryTime = createdAtDate.getTime() + expiryHoursInMs;
                const remaining = expiryTime - now.getTime();
                
                if (remaining <= 0) {
                    countdownElement.textContent = '00:00:00';
                    expirySection.style.background = '#f8d7da';
                    expirySection.style.borderColor = '#dc3545';
                    countdownElement.style.color = '#721c24';
                    if (roomExpiryInterval) {
                        clearInterval(roomExpiryInterval);
                        roomExpiryInterval = null;
                    }
                    return;
                }
                
                const hours = Math.floor(remaining / (1000 * 60 * 60));
                const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
                
                countdownElement.textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
            
            updateCountdown(); // ì¦‰ì‹œ ì‹¤í–‰
            roomExpiryInterval = setInterval(updateCountdown, 1000); // 1ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
        }
        
        // í˜¸ìŠ¤íŠ¸ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateHostUI() {
            const dragHint = document.getElementById('dragHint');
            
            if (isHost) {
                // í˜¸ìŠ¤íŠ¸ ë°°ì§€ í‘œì‹œ
                const hostBadge = document.getElementById('hostBadge');
                if (hostBadge) {
                    hostBadge.style.display = 'inline-block';
                }
                
                // í˜¸ìŠ¤íŠ¸ ì „ìš© ì»¨íŠ¸ë¡¤ í‘œì‹œ
                const hostControls = document.getElementById('hostControls');
                if (hostControls) {
                    hostControls.style.display = 'grid';
                }
                
                // ë°© ì œëª© ë³€ê²½ ë²„íŠ¼ í‘œì‹œ
                const editRoomNameButton = document.getElementById('editRoomNameButton');
                if (editRoomNameButton) {
                    editRoomNameButton.style.display = 'inline-block';
                }
                
                // ë“œë˜ê·¸ ì•ˆë‚´ ë©˜íŠ¸ í‘œì‹œ (ê²Œì„ ì§„í–‰ ì¤‘ì´ ì•„ë‹ ë•Œ)
                if (dragHint) {
                    if (!isGameActive) {
                        dragHint.style.display = 'inline';
                        console.log('ë“œë˜ê·¸ ì•ˆë‚´ ë©˜íŠ¸ í‘œì‹œ (í˜¸ìŠ¤íŠ¸, ê²Œì„ ë¹„í™œì„±)');
                    } else {
                        dragHint.style.display = 'none';
                        console.log('ë“œë˜ê·¸ ì•ˆë‚´ ë©˜íŠ¸ ìˆ¨ê¹€ (ê²Œì„ í™œì„±)');
                    }
                } else {
                    console.log('dragHint ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
                // ì£¼ë¬¸ë°›ê¸° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                const startOrderBtn = document.getElementById('startOrderButton');
                const endOrderBtn = document.getElementById('endOrderButton');
                if (isOrderActive) {
                    // ì£¼ë¬¸ë°›ê¸° ì§„í–‰ ì¤‘
                    if (startOrderBtn) startOrderBtn.style.display = 'none';
                    if (endOrderBtn) endOrderBtn.style.display = 'block';
                } else if (!isGameActive) {
                    // ê²Œì„ ë¹„í™œì„±í™” ìƒíƒœì—ì„œ ì£¼ë¬¸ë°›ê¸° ì‹œì‘ ë²„íŠ¼ í‘œì‹œ
                    if (startOrderBtn) startOrderBtn.style.display = 'block';
                    if (endOrderBtn) endOrderBtn.style.display = 'none';
                } else {
                    // ê²Œì„ ì§„í–‰ ì¤‘ì´ë©´ ì£¼ë¬¸ë°›ê¸° ë²„íŠ¼ ìˆ¨ê¹€
                    if (startOrderBtn) startOrderBtn.style.display = 'none';
                    if (endOrderBtn) endOrderBtn.style.display = 'none';
                }
                
                // ê²Œì„ ë£° ì €ì¥ ë²„íŠ¼ í‘œì‹œ
                updateGameRulesUI();
            } else {
                // í˜¸ìŠ¤íŠ¸ ë°°ì§€ ìˆ¨ê¹€
                const hostBadge = document.getElementById('hostBadge');
                if (hostBadge) {
                    hostBadge.style.display = 'none';
                }
                
                // í˜¸ìŠ¤íŠ¸ ì „ìš© ì»¨íŠ¸ë¡¤ ìˆ¨ê¹€
                const hostControls = document.getElementById('hostControls');
                if (hostControls) {
                    hostControls.style.display = 'none';
                }
                
                // ë°© ì œëª© ë³€ê²½ ë²„íŠ¼ ìˆ¨ê¹€
                const editRoomNameButton = document.getElementById('editRoomNameButton');
                if (editRoomNameButton) {
                    editRoomNameButton.style.display = 'none';
                }
                
                // ë“œë˜ê·¸ ì•ˆë‚´ ë©˜íŠ¸ ìˆ¨ê¹€
                if (dragHint) {
                    dragHint.style.display = 'none';
                }
                
                // ê²Œì„ ë£° ì €ì¥ ë²„íŠ¼ ìˆ¨ê¹€
                updateGameRulesUI();
            }
        }
        
        // í˜¸ìŠ¤íŠ¸ ê¶Œí•œ ì „ë‹¬ ì•Œë¦¼
        socket.on('hostTransferred', (data) => {
            showCustomAlert(data.message || 'í˜¸ìŠ¤íŠ¸ ê¶Œí•œì´ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            isHost = true;
            // í˜¸ìŠ¤íŠ¸ ì „ìš© UI ì—…ë°ì´íŠ¸
            updateHostUI();
            // ê²Œì„ ë£° UI ì—…ë°ì´íŠ¸
            updateGameRulesUI();
        });
        
        // í˜¸ìŠ¤íŠ¸ ë³€ê²½ ì•Œë¦¼
        socket.on('hostChanged', (data) => {
            // ìƒˆ í˜¸ìŠ¤íŠ¸ IDëŠ” socket.idê°€ ì•„ë‹ˆë¼ ì‚¬ìš©ì IDì´ë¯€ë¡œ ë‹¤ë¥¸ ë°©ì‹ìœ¼ë¡œ í™•ì¸ í•„ìš”
            // ì„œë²„ì—ì„œ ë³´ë‚¸ newHostIdë¥¼ ì‚¬ìš©ìì˜ socket.idì™€ ë¹„êµí•˜ê¸° ìœ„í•´ 
            // updateUsers ì´ë²¤íŠ¸ë¥¼ í†µí•´ í™•ì¸
            console.log('í˜¸ìŠ¤íŠ¸ ë³€ê²½ ì•Œë¦¼:', data.message);
        });
        
        // í˜¸ìŠ¤íŠ¸ ìƒíƒœ ë³€ê²½ ì¶”ì  ë³€ìˆ˜
        let lastHostStatus = false;
        
        // ë°© ì œëª© ì—…ë°ì´íŠ¸
        socket.on('roomNameUpdated', (roomName) => {
            const sTag = currentServerName ? `[${currentServerName}] ` : '';
            document.getElementById('roomNameText').textContent = sTag + roomName;
            cancelRoomNameEdit();
        });
        
        // ë°© ì œëª© í¸ì§‘
        function editRoomName() {
            const currentName = document.getElementById('roomNameText').textContent;
            document.getElementById('roomNameInput').value = currentName;
            document.getElementById('roomNameDisplay').style.display = 'none';
            document.getElementById('roomNameEditSection').style.display = 'block';
            document.getElementById('editRoomNameButton').style.display = 'none';
        }
        
        // ë°© ì œëª© ì €ì¥
        function saveRoomName() {
            const newName = document.getElementById('roomNameInput').value.trim();
            
            if (newName === '') {
                showCustomAlert('ë°© ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!', 'warning');
                return;
            }

            socket.emit('updateRoomName', { roomName: newName });
        }
        
        // ë°© ì œëª© í¸ì§‘ ì·¨ì†Œ
        function cancelRoomNameEdit() {
            document.getElementById('roomNameDisplay').style.display = 'block';
            document.getElementById('roomNameEditSection').style.display = 'none';
            if (isHost) {
                document.getElementById('editRoomNameButton').style.display = 'inline-block';
            }
        }

        // ë¡œê·¸ì¸ ì„±ê³µ (í•˜ìœ„ í˜¸í™˜ì„± ìœ ì§€, ì‚¬ìš© ì•ˆ í•¨)
        socket.on('loginSuccess', (data) => {
            hasRolledInCurrentGame = data.hasRolled;
            myDiceSettings = data.diceSettings;
            isGameActive = data.isGameActive;
            isOrderActive = data.isOrderActive;
            OrderModule.setIsOrderActive(isOrderActive);

            document.getElementById('loginSection').classList.remove('active');
            document.getElementById('gameSection').classList.add('active');
            document.getElementById('currentUser').textContent = currentUser;

            // ë‚´ ì£¼ë¬¸ ë¶ˆëŸ¬ì˜¤ê¸°
            document.getElementById('myOrderInput').value = data.myOrder || '';

            if (isHost) {
                document.getElementById('hostBadge').style.display = 'inline-block';
                document.getElementById('hostControls').style.display = 'grid';
            }
            
            // ê²Œì„ ë£° ë¶ˆëŸ¬ì˜¤ê¸°
            if (data.gameRules !== undefined) {
                document.getElementById('gameRulesInput').value = data.gameRules || '';
            }
            
            // ìì£¼ ì“°ëŠ” ë©”ë‰´ ë¶ˆëŸ¬ì˜¤ê¸° (ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ë°ì´í„° ì‚¬ìš©)
            if (data.frequentMenus !== undefined) {
                frequentMenus = data.frequentMenus;
                OrderModule.renderMenuList();
            } else {
                // ì„œë²„ì—ì„œ ê°€ì ¸ì˜¤ê¸°
                OrderModule.loadFrequentMenus();
            }
            
            // ê²Œì„ ë£° UI ì—…ë°ì´íŠ¸ (ì´ˆê¸°í™” í›„ ë°˜ë“œì‹œ í˜¸ì¶œ)
            setTimeout(() => {
                updateGameRulesUI();
            }, 100);
            
            // ì£¼ë¬¸ë°›ê¸°ê°€ í™œì„±í™”ëœ ìƒíƒœë©´ ì£¼ë¬¸í•˜ì§€ ì•Šì€ ì‚¬ëŒ ëª©ë¡ë„ í‘œì‹œ
            if (isOrderActive) {
                setTimeout(() => {
                    OrderModule.renderNotOrderedUsers();
                }, 100);
            }

            // ì¬ì ‘ì† ì²˜ë¦¬
            if (isGameActive && data.isGamePlayer) {
                document.getElementById('gameStatus').textContent = 'ê²Œì„ ì§„í–‰ ì¤‘!';
                document.getElementById('gameStatus').classList.remove('waiting');
                document.getElementById('gameStatus').classList.add('playing');
                document.getElementById('progressSection').style.display = 'block';
                
                if (isHost) {
                    document.getElementById('startButton').style.display = 'none';
                    document.getElementById('endButton').style.display = 'block';
                }
                
                const reconnectNotice = document.getElementById('reconnectNotice');
                const reconnectMessage = document.getElementById('reconnectMessage');
                
                if (data.hasRolled && data.myResult) {
                    reconnectNotice.style.display = 'block';
                    reconnectMessage.textContent = `ì´ë¯¸ ì£¼ì‚¬ìœ„ë¥¼ êµ´ë ¸ìŠµë‹ˆë‹¤. ê²°ê³¼: ${data.myResult.result}`;
                } else {
                    hasRolledInCurrentGame = false;
                    
                    reconnectNotice.style.display = 'block';
                    reconnectMessage.textContent = 'ì•„ì§ ì£¼ì‚¬ìœ„ë¥¼ êµ´ë¦¬ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. /ì£¼ì‚¬ìœ„ ëª…ë ¹ì–´ë¡œ êµ´ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤!';
                    reconnectMessage.style.color = '#155724';
                    reconnectNotice.style.background = '#d4edda';
                    reconnectNotice.style.borderColor = '#28a745';
                }
            }

            // ì£¼ë¬¸ë°›ê¸° ì„¹ì…˜ í•­ìƒ í‘œì‹œ
            document.getElementById('ordersSection').style.display = 'block';
            
            // ì£¼ë¬¸ë°›ê¸° ìƒíƒœ ë°˜ì˜
            if (isOrderActive) {
                document.getElementById('ordersSection').classList.add('active');
                document.getElementById('myOrderInput').disabled = false;
                document.getElementById('orderSaveButton').disabled = false;
                document.getElementById('gameStatus').textContent = 'ì£¼ë¬¸ë°›ê¸° ì§„í–‰ ì¤‘!';
                document.getElementById('gameStatus').classList.add('ordering');
                
                if (isHost) {
                    document.getElementById('startOrderButton').style.display = 'none';
                    document.getElementById('endOrderButton').style.display = 'block';
                }
                
                // ì£¼ë¬¸ ëª©ë¡ê³¼ ì£¼ë¬¸í•˜ì§€ ì•Šì€ ì‚¬ëŒ ëª©ë¡ í‘œì‹œ
                OrderModule.renderOrders();
                OrderModule.renderNotOrderedUsers();
            } else if (isHost && !isGameActive) {
                // ê²Œì„ì´ ë¹„í™œì„±í™”ë˜ê³  ì£¼ë¬¸ë°›ê¸°ë„ ë¹„í™œì„±í™”ëœ ìƒíƒœì—ì„œ Hostì—ê²Œ ì£¼ë¬¸ë°›ê¸° ì‹œì‘ ë²„íŠ¼ í‘œì‹œ
                document.getElementById('startOrderButton').style.display = 'block';
                document.getElementById('endOrderButton').style.display = 'none';
                
                // ì£¼ë¬¸ë°›ê¸°ê°€ ì¢…ë£Œë˜ì–´ë„ ì£¼ë¬¸ ëª©ë¡ì€ í‘œì‹œ
                OrderModule.renderOrders();
                OrderModule.renderNotOrderedUsers();
            }
        });

        // ë¡œê·¸ì¸ ì—ëŸ¬
        socket.on('loginError', (message) => {
            showCustomAlert(message, 'info');
            logout();
        });

        // ë¡œê·¸ì•„ì›ƒ (ë°© ë‚˜ê°€ê¸°)
        function logout() {
            if (currentRoomId) {
                socket.emit('leaveRoom');
            } else {
            socket.disconnect();
            location.reload();
            }
        }
        
        // ë°© ë‚˜ê°€ê¸° ì™„ë£Œ
        socket.on('roomLeft', () => {
            // ê²Œì„ ê¸°ë¡ ì„¹ì…˜ ìˆ¨ê¹€
            document.querySelector('.history-section').classList.remove('visible');

            // body í´ë˜ìŠ¤ ë³€ê²½
            document.body.classList.remove('game-active');
            document.body.classList.add('lobby-active');

            currentRoomId = null;
            currentUser = '';
            isHost = false;
            document.getElementById('gameSection').classList.remove('active');
            document.getElementById('lobbySection').classList.add('active');
            PageHistoryManager.replacePage('lobby');

            refreshRooms();
        });

        socket.on('kicked', (message) => {
            showCustomAlert(message, 'info');
            location.reload(); // ê°•í‡´ë‹¹í•˜ë©´ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë¡œë¹„ë¡œ ì´ë™
        });


        // ë‚´ ì£¼ì‚¬ìœ„ ì„¤ì • ì—…ë°ì´íŠ¸
        // ì£¼ì‚¬ìœ„ ì„¤ì • ì—…ë°ì´íŠ¸ (ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ, ëª…ë ¹ì–´ë¡œ ëŒ€ì²´)

        socket.on('settingsError', (message) => {
            showCustomAlert(message, 'info');
        });

        // ê²Œì„ ë£° ì—…ë°ì´íŠ¸
        function updateGameRules() {
            // ë¼ë””ì˜¤ ë²„íŠ¼ì—ì„œ ì„ íƒëœ ë£° ì‚¬ìš©
            const selectedRule = document.querySelector('input[name="gameRule"]:checked');
            let rules = '';
            
            if (selectedRule) {
                if (selectedRule.value === 'high') {
                    rules = 'í•˜ì´ - ë‚®ì€ ì‚¬ëŒì´ ê±¸ë¦¼';
                } else if (selectedRule.value === 'low') {
                    rules = 'ë¡œìš° - ë†’ì€ ì‚¬ëŒì´ ê±¸ë¦¼';
                } else if (selectedRule.value === 'near') {
                    const nearNumber = document.getElementById('gameNearNumberInput').value.trim();
                    if (!nearNumber || nearNumber === '') {
                        showCustomAlert('ë‹ˆì–´ ë£°ì„ ì„ íƒí•œ ê²½ìš° ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!', 'warning');
                        document.getElementById('gameNearNumberInput').focus();
                        return;
                    }
                    rules = `ë‹ˆì–´ ${nearNumber} - ${nearNumber}ì— ê°€ê¹Œìš´ ì‚¬ëŒ ê±¸ë¦¬ê¸°`;
                } else if (selectedRule.value === 'custom') {
                    rules = document.getElementById('gameCustomRuleInput').value.trim();
                    if (!rules || rules === '') {
                        showCustomAlert('ê¸°íƒ€ ë£°ì„ ì„ íƒí•œ ê²½ìš° ë£°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!', 'warning');
                        document.getElementById('gameCustomRuleInput').focus();
                        return;
                    }
                }
            } else {
                // ë¼ë””ì˜¤ ë²„íŠ¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìœ¼ë©´ í…ìŠ¤íŠ¸ ì˜ì—­ì˜ ê°’ ì‚¬ìš©
                const rulesInput = document.getElementById('gameRulesInput');
                rules = rulesInput.value.trim();
            }
            
            // ë£° í…ìŠ¤íŠ¸ ì˜ì—­ë„ ì—…ë°ì´íŠ¸
            document.getElementById('gameRulesInput').value = rules;

            socket.emit('updateGameRules', {
                rules: rules
            });
        }

        // ê²Œì„ ë£° UI ì—…ë°ì´íŠ¸ (ê²Œì„ ì‹œì‘ ìƒíƒœì— ë”°ë¼ í¸ì§‘ ê°€ëŠ¥ ì—¬ë¶€ ê²°ì •)
        function updateGameRulesUI() {
            const rulesInput = document.getElementById('gameRulesInput');
            const rulesSaveButton = document.getElementById('gameRulesSaveButton');
            const rulesRadioSection = document.getElementById('gameRulesRadioSection');
            
            if (!rulesInput || !rulesSaveButton) {
                return; // ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì¢…ë£Œ
            }
            
            // í˜¸ìŠ¤íŠ¸ì´ê³  ê²Œì„ì´ ì‹œì‘ë˜ì§€ ì•Šì•˜ì„ ë•Œë§Œ ë¼ë””ì˜¤ ë²„íŠ¼ ì„¹ì…˜ í‘œì‹œ
            const canEdit = isHost && (isGameActive === false || isGameActive === undefined || !isGameActive);
            
            if (rulesRadioSection) {
                if (canEdit) {
                    rulesRadioSection.style.display = 'block';
                } else {
                    rulesRadioSection.style.display = 'none';
                }
            }
            
            // ì €ì¥ ë²„íŠ¼ì€ í˜¸ìŠ¤íŠ¸ë§Œ ë³´ì´ê²Œ
            if (isHost) {
                rulesSaveButton.style.display = 'inline-block';
            } else {
                rulesSaveButton.style.display = 'none';
            }
            
            // í˜¸ìŠ¤íŠ¸ì´ê³  ê²Œì„ì´ ì‹œì‘ë˜ì§€ ì•Šì•˜ì„ ë•Œë§Œ í¸ì§‘ ê°€ëŠ¥
            // isGameActiveê°€ undefinedì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ëª…ì‹œì ìœ¼ë¡œ ì²´í¬
            // ë°©ì— ì…ì¥í•˜ì§€ ì•Šì€ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ isHostë„ í™•ì¸
            if (canEdit) {
                rulesInput.disabled = false;
                rulesInput.style.cursor = 'text';
                rulesInput.style.backgroundColor = '#ffffff';
                
                // ë£° í…ìŠ¤íŠ¸ë¥¼ íŒŒì‹±í•´ì„œ ë¼ë””ì˜¤ ë²„íŠ¼ ì„ íƒ
                parseGameRulesToRadio();
                
                // ì €ì¥ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                updateGameRulesSaveButtonState();
            } else {
                rulesInput.disabled = true;
                rulesSaveButton.disabled = true;
                rulesInput.style.cursor = 'not-allowed';
                rulesInput.style.backgroundColor = '#f5f5f5';
            }
            
            console.log('ê²Œì„ ë£° UI ì—…ë°ì´íŠ¸:', { isHost, isGameActive, canEdit });
        }
        
        // ë£° í…ìŠ¤íŠ¸ë¥¼ íŒŒì‹±í•´ì„œ ë¼ë””ì˜¤ ë²„íŠ¼ ì„ íƒ
        function parseGameRulesToRadio() {
            const rulesInput = document.getElementById('gameRulesInput');
            if (!rulesInput) return;
            
            const rulesText = rulesInput.value.trim();
            
            // ëª¨ë“  ë¼ë””ì˜¤ ë²„íŠ¼ í•´ì œ
            document.querySelectorAll('input[name="gameRule"]').forEach(radio => {
                radio.checked = false;
            });
            
            // ì»¨í…Œì´ë„ˆ ìˆ¨ê¸°ê¸°
            document.getElementById('gameNearNumberContainer').style.display = 'none';
            document.getElementById('gameCustomRuleContainer').style.display = 'none';
            document.getElementById('gameNearNumberInput').value = '';
            document.getElementById('gameCustomRuleInput').value = '';
            
            if (!rulesText) {
                return; // ë£°ì´ ì—†ìœ¼ë©´ ì•„ë¬´ê²ƒë„ ì„ íƒí•˜ì§€ ì•ŠìŒ
            }
            
            // í•˜ì´ íŒ¨í„´ í™•ì¸
            if (rulesText.includes('í•˜ì´') && rulesText.includes('ë‚®ì€')) {
                document.getElementById('gameRuleHigh').checked = true;
                updateGameRulesSaveButtonState();
                return;
            }
            
            // ë¡œìš° íŒ¨í„´ í™•ì¸
            if (rulesText.includes('ë¡œìš°') && rulesText.includes('ë†’ì€')) {
                document.getElementById('gameRuleLow').checked = true;
                updateGameRulesSaveButtonState();
                return;
            }
            
            // ë‹ˆì–´ íŒ¨í„´ í™•ì¸ (ë‹ˆì–´ ìˆ«ì í˜•ì‹)
            const nearMatch = rulesText.match(/ë‹ˆì–´\s*(\d+)/);
            if (nearMatch) {
                document.getElementById('gameRuleNear').checked = true;
                document.getElementById('gameNearNumberInput').value = nearMatch[1];
                document.getElementById('gameNearNumberContainer').style.display = 'block';
                updateGameRulesSaveButtonState();
                return;
            }
            
            // ë‹ˆì–´ íŒ¨í„´ í™•ì¸ (ë‹ˆì–´ë§Œ ìˆëŠ” ê²½ìš°)
            if (rulesText.includes('ë‹ˆì–´')) {
                document.getElementById('gameRuleNear').checked = true;
                document.getElementById('gameNearNumberContainer').style.display = 'block';
                updateGameRulesSaveButtonState();
                return;
            }
            
            // ìœ„ íŒ¨í„´ì— í•´ë‹¹í•˜ì§€ ì•Šìœ¼ë©´ ê¸°íƒ€ë¡œ ì²˜ë¦¬
            document.getElementById('gameRuleCustom').checked = true;
            document.getElementById('gameCustomRuleInput').value = rulesText;
            document.getElementById('gameCustomRuleContainer').style.display = 'block';
            
            // ì €ì¥ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateGameRulesSaveButtonState();
        }

        // ê²Œì„ ë£° ì—…ë°ì´íŠ¸ ìˆ˜ì‹ 
        socket.on('gameRulesUpdated', (rules) => {
            document.getElementById('gameRulesInput').value = rules || '';
            console.log('ê²Œì„ ë£°ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤:', rules);
            // UI ì—…ë°ì´íŠ¸ (ë¼ë””ì˜¤ ë²„íŠ¼ë„ ì—…ë°ì´íŠ¸)
            updateGameRulesUI();
        });

        socket.on('rulesError', (message) => {
            showCustomAlert(message, 'info');
        });
        
        socket.on('rulesSaved', (message) => {
            showCustomAlert(message, 'info');
        });
        
        socket.on('gameError', (message) => {
            showCustomAlert(message, 'info');
        });

        // ê²Œì„ ì‹œì‘
        function startGame() {
            // í˜¸ìŠ¤íŠ¸ì¸ ê²½ìš° ê²Œì„ ì‹œì‘ ì „ í˜„ì¬ ì…ë ¥ëœ ë£°ì„ ì„œë²„ì— ì €ì¥
            if (isHost) {
                const rulesInput = document.getElementById('gameRulesInput');
                const currentRules = rulesInput.value.trim();
                
                // ë£°ì´ ì…ë ¥ë˜ì–´ ìˆìœ¼ë©´ ì„œë²„ì— ì €ì¥ ìš”ì²­
                if (currentRules) {
                    socket.emit('updateGameRules', {
                        rules: currentRules
                    });
                }
            }
            
            socket.emit('startGame');
        }

        socket.on('gameStarted', (data) => {
            // ê°€ì¥ ë¨¼ì € ì„¸ëŒ€ ì¦ê°€ (ì´ì „ ê²Œì„ì˜ processGameEndê°€ í˜„ì¬ ê²Œì„ì— ì˜í–¥ ì£¼ì§€ ì•Šë„ë¡)
            gameGeneration++;
            const thisGeneration = gameGeneration;
            console.log('ğŸ® [DEBUG] gameStarted ì´ë²¤íŠ¸ ìˆ˜ì‹ ! ìƒˆ ì„¸ëŒ€:', thisGeneration, data);
            
            // ì´ì „ ê²Œì„ì˜ ëŒ€ê¸° ì¤‘ì¸ ì¸í„°ë²Œ/íƒ€ì„ì•„ì›ƒ ì¦‰ì‹œ ì •ë¦¬
            if (gameEndWaitInterval) {
                clearInterval(gameEndWaitInterval);
                gameEndWaitInterval = null;
                console.log('ğŸ§¹ [DEBUG] ì´ì „ ê²Œì„ ì¸í„°ë²Œ ì •ë¦¬ë¨');
            }
            if (gameEndWaitTimeout) {
                clearTimeout(gameEndWaitTimeout);
                gameEndWaitTimeout = null;
                console.log('ğŸ§¹ [DEBUG] ì´ì „ ê²Œì„ íƒ€ì„ì•„ì›ƒ ì •ë¦¬ë¨');
            }
            
            // ì´ì „ ê²Œì„ ìƒíƒœ ì €ì¥ (ë¡œê·¸ ì´ˆê¸°í™” ì „)
            const prevIsGameActive = isGameActive;
            
            clearDebugLog(); // ìƒˆ ê²Œì„ ì‹œì‘ ì‹œ ë¡œê·¸ ì´ˆê¸°í™”
            
            addDebugLog(`ğŸ® ê²Œì„ ì‹œì‘: ì„¸ëŒ€=${thisGeneration}, ì´ì „isGameActive=${prevIsGameActive}`, 'info');
            
            isGameActive = true;
            hasRolledInCurrentGame = false;
            rolledUsersInGame = []; // ê²Œì„ ì‹œì‘ ì‹œ êµ´ë¦° ì‚¬ìš©ì ëª©ë¡ ì´ˆê¸°í™”
            if (window.SoundManager) SoundManager.playLoop('dice_bgm', getDiceSoundEnabled(), 0.3);
            
            // ê²Œì„ ì‹œì‘ ì‹œ ì„œë²„ì—ì„œ ë°›ì€ ê²Œì„ ê¸°ë¡ ì´ˆê¸°í™”
            window.currentGameHistoryFromServer = null;
            
            // ê²Œì„ ì‹œì‘ ì‹œ ì´ì „ ë‹¹ì²¨ì ì •ë³´ ì´ˆê¸°í™”
            window.gameWinners = null;
            
            // ê²Œì„ ì‹œì‘ ì‹œ ì´ì „ ìœ ë ¥í•œ ì‚¬ëŒ ëª©ë¡ ì´ˆê¸°í™”
            lastTopPlayerKeys = new Set();
            
            // ê²Œì„ ì‹œì‘ ì‹œ ì´ì „ ë‹¹ì²¨ì ëª©ë¡ ì´ˆê¸°í™”
            lastWinnerKeys = new Set();

            // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í”Œë˜ê·¸ ì´ˆê¸°í™”
            window.lastRollerAnimationComplete = false;
            window.lastRollerAnimationCompleteTime = null;
            window._lastRollerAnimationStarted = false;
            addDebugLog('ğŸ”„ ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í”Œë˜ê·¸ ì´ˆê¸°í™”', 'info');

            // ê²Œì„ ì‹œì‘ ì‹œ ëª¨ë“  ê²Œì„ ê¸°ë¡ ì‚­ì œ (ì´ì „ ê²Œì„ ê¸°ë¡ í¬í•¨)
            historyData = historyData.filter(record => record.isGameActive === false);
            
            // ê²Œì„ ì°¸ì—¬ì ëª©ë¡ ì—…ë°ì´íŠ¸
            gamePlayers = data.players || [];
            
            // í•œë²ˆì´ë¼ë„ ê²Œì„ì— ì°¸ì—¬í•œ ì‚¬ëŒ ëª©ë¡ì— ì¶”ê°€ (ì¤‘ë³µ ì œê±°)
            if (data.players && data.players.length > 0) {
                data.players.forEach(player => {
                    if (!everPlayedUsers.includes(player)) {
                        everPlayedUsers.push(player);
                    }
                });
            }
            
            // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í”Œë˜ê·¸ ì´ˆê¸°í™” (ê²Œì„ ì¬ì‹œì‘ ì‹œ ì´ì „ ê°’ì´ ë‚¨ì•„ìˆì§€ ì•Šë„ë¡)
            window.lastRollerAnimationComplete = false;
            window.lastRollerAnimationCompleteTime = null;
            window._lastRollerAnimationStarted = false;
            
            // ê²°ê³¼ì°½ í‘œì‹œ í”Œë˜ê·¸ ì´ˆê¸°í™” (ìƒˆ ê²Œì„ ì‹œì‘ ì‹œ)
            window.allRolledMessageShown = false;
            
            // ì´ì „ ê²Œì„ì˜ ê²°ê³¼ì°½ DOM ì‚­ì œ (ë‘ ë²ˆì§¸ ê²Œì„ì—ì„œ ê²°ê³¼ì°½ì´ í‘œì‹œë˜ë„ë¡)
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                const oldResultBanners = Array.from(chatMessages.children).filter(child => {
                    const titleDiv = child.querySelector('div');
                    return titleDiv && (
                        titleDiv.textContent.includes('ì£¼ì‚¬ìœ„ ë‹¤ êµ´ë ¸ìŠµë‹ˆë‹¤') ||
                        titleDiv.textContent.includes('ê²Œì„ì‹œì‘')
                    );
                });
                oldResultBanners.forEach(banner => banner.remove());
                console.log(`ğŸ§¹ [DEBUG] ì´ì „ ê²°ê³¼ì°½ ${oldResultBanners.length}ê°œ ì‚­ì œë¨`);
            }
            
            // ëŒ€ê¸° interval ì •ë¦¬
            if (window.allRolledWaitInterval) {
                clearInterval(window.allRolledWaitInterval);
                window.allRolledWaitInterval = null;
            }
            
            // ê²Œì„ ê¸°ë¡ ì œëª© ë³€ê²½
            document.getElementById('historyTitle').textContent = 'ğŸ“‹ ê²Œì„';
            
            // êµ´ë¦° ì¸ì› ì—…ë°ì´íŠ¸
            updateRolledUsersCount();
            
            // ì¤€ë¹„ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.getElementById('readySection').style.display = 'none';
            
            document.getElementById('reconnectNotice').style.display = 'none';
            
            document.getElementById('gameStatus').textContent = 'ê²Œì„ ì§„í–‰ ì¤‘!';
            document.getElementById('gameStatus').classList.remove('waiting');
            document.getElementById('gameStatus').classList.remove('ordering');
            document.getElementById('gameStatus').classList.add('playing');
            document.getElementById('startButton').style.display = 'none';
            document.getElementById('endButton').style.display = 'block';
            
            // ê²Œì„ ì‹œì‘ ì‹œ ë£° ìˆ˜ì • ë¶ˆê°€ëŠ¥í•˜ë„ë¡ UI ì—…ë°ì´íŠ¸
            updateGameRulesUI();
            
            // ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸° ë²„íŠ¼ì€ ì œê±°ë¨ (ëª…ë ¹ì–´ë¡œ ëŒ€ì²´)
            
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('progressBar').style.background = 'linear-gradient(90deg, #667eea 0%, #764ba2 100%)';
            
            // ê²Œì„ ì‹œì‘ ì‹œ ì´ˆê¸° ì§„í–‰ ìƒí™© ì„¤ì •
            if (data.players && data.players.length > 0) {
                updateProgress({
                    rolled: 0,
                    total: data.players.length,
                    notRolledYet: data.players
                });
            }
            
            // ê²Œì„ ì‹œì‘ ì‹œ ì£¼ë¬¸ë°›ê¸° ì…ë ¥ë§Œ ë¹„í™œì„±í™” (ì£¼ë¬¸ ëª©ë¡ì€ ê³„ì† í‘œì‹œ)
            if (!isOrderActive) {
                document.getElementById('ordersSection').classList.remove('active');
            }
            
            // ê²Œì„ ì‹œì‘ ì‹œ ì£¼ë¬¸ë°›ê¸° ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            if (isHost) {
                document.getElementById('startOrderButton').style.display = 'none';
                document.getElementById('endOrderButton').style.display = 'none';
            }
            
            renderHistory();
        });

        // ê²Œì„ ì¢…ë£Œ
        function endGame() {
            // ê²Œì„ ì¢…ë£Œ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•ŒëŠ” ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œë¥¼ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  ì¦‰ì‹œ ì¢…ë£Œ
            // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í”Œë˜ê·¸ë¥¼ ê°•ì œë¡œ ì„¤ì •í•˜ì—¬ ëŒ€ê¸° ì¤‘ì¸ ì²´í¬ê°€ í†µê³¼í•˜ë„ë¡ í•¨
            if (window.lastRollerAnimationComplete === false) {
                window.lastRollerAnimationComplete = true;
                window.lastRollerAnimationCompleteTime = Date.now();
                addDebugLog('ğŸ”´ ê²Œì„ ì¢…ë£Œ ë²„íŠ¼ í´ë¦­ - ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í”Œë˜ê·¸ ê°•ì œ ì„¤ì •', 'gameEnd');
            }
            socket.emit('endGame');
        }

        // ì´ì „ ê²Œì„ ë°ì´í„° ì‚­ì œ
        async function clearGameData() {
            const result = await showCustomConfirm('ì •ë§ë¡œ ì´ì „ ê²Œì„ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê²Œì„ ê¸°ë¡, ì£¼ë¬¸ ë‚´ì—­, ê²Œì„ ë£°ì´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤)', 'warning');
            if (!result) {
                return;
            }
            
            socket.emit('clearGameData');
        }

        // ê²Œì„ ë°ì´í„° ì‚­ì œ ì„±ê³µ
        socket.on('gameDataCleared', () => {
            historyData = [];
            ordersData = {};
            isOrderActive = false;
            OrderModule.setOrdersData(ordersData);
            OrderModule.setIsOrderActive(false);

            renderHistory();
            OrderModule.renderOrders();
            
            // ê²Œì„ ë£° ì´ˆê¸°í™”
            document.getElementById('gameRulesInput').value = '';
            
            showCustomAlert('ì´ì „ ê²Œì„ ë°ì´í„°ê°€ ëª¨ë‘ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        });

        // ê²Œì„ ë°ì´í„° ì‚­ì œ ì—ëŸ¬
        socket.on('clearDataError', (message) => {
            showCustomAlert(message, 'info');
        });

        socket.on('gameEnded', (currentGameHistory) => {
            console.log('ğŸ [DEBUG] gameEnded ì´ë²¤íŠ¸ ìˆ˜ì‹ !', 'records:', currentGameHistory?.length, 'gen:', gameGeneration, 'active:', isGameActive);
            
            // ë””ë²„ê·¸: gameEnded ì´ë²¤íŠ¸ ìˆ˜ì‹  ë¡œê·¸
            addDebugLog(`ğŸ gameEnded ìˆ˜ì‹ : ê¸°ë¡=${currentGameHistory?.length || 0}ê°œ, ì„¸ëŒ€=${gameGeneration}, isGameActive=${isGameActive}`, 'gameEnd');
            addDebugLog(`ğŸ” í˜„ì¬ í”Œë˜ê·¸: lastRollerAnimationComplete=${window.lastRollerAnimationComplete}, _lastRollerAnimationStarted=${window._lastRollerAnimationStarted}`, 'gameEnd');
            
            // ì„œë²„ì—ì„œ ë°›ì€ ê²Œì„ ê¸°ë¡ì„ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (ë‹¹ì²¨ì ê³„ì‚° ì‹œ ì‚¬ìš©)
            window.currentGameHistoryFromServer = currentGameHistory;
            
            // ë‹¹ì²¨ì ê³„ì‚° ë° ì €ì¥
            const calculateAndStoreWinner = async () => {
                const rulesInput = document.getElementById('gameRulesInput');
                if (!rulesInput) return;
                
                const gameRules = rulesInput.value.trim();
                if (!gameRules) return;
                
                const rulesLower = gameRules.toLowerCase();
                let winners = [];
                
                // í•˜ì´ ë£°: ë‚®ì€ ì‚¬ëŒì´ ê±¸ë¦¼
                if (rulesLower.includes('í•˜ì´') && rulesLower.includes('ë‚®ì€')) {
                    const minResult = Math.min(...currentGameHistory.map(r => r.result));
                    const winnerRecords = currentGameHistory.filter(r => r.result === minResult);
                    winners = winnerRecords.map(r => r.user);
                }
                // ë¡œìš° ë£°: ë†’ì€ ì‚¬ëŒì´ ê±¸ë¦¼
                else if (rulesLower.includes('ë¡œìš°') && rulesLower.includes('ë†’ì€')) {
                    const maxResult = Math.max(...currentGameHistory.map(r => r.result));
                    const winnerRecords = currentGameHistory.filter(r => r.result === maxResult);
                    winners = winnerRecords.map(r => r.user);
                }
                // ë‹ˆì–´ ë£°: íŠ¹ì • ìˆ«ìì— ê°€ê¹Œìš´ ì‚¬ëŒì´ ê±¸ë¦¼
                else if (rulesLower.includes('ë‹ˆì–´')) {
                    const nearMatch = gameRules.match(/ë‹ˆì–´\s*\(?\s*(\d+)\s*\)?/);
                    if (nearMatch) {
                        const targetNumber = parseInt(nearMatch[1]);
                        let minDiff = Infinity;
                        let winnerRecords = [];
                        
                        currentGameHistory.forEach(record => {
                            const diff = Math.abs(record.result - targetNumber);
                            if (diff < minDiff) {
                                minDiff = diff;
                                winnerRecords = [record];
                            } else if (diff === minDiff) {
                                winnerRecords.push(record);
                            }
                        });
                        
                        winners = winnerRecords.map(r => r.user);
                    }
                }
                
                // ë‹¹ì²¨ì ì •ë³´ ì €ì¥
                if (winners.length > 0) {
                    window.gameWinners = winners;
                    if (window.SoundManager) SoundManager.playSound('dice_win', getDiceSoundEnabled());
                }
            };
            
            // ë‹¹ì²¨ì ê³„ì‚°
            calculateAndStoreWinner();
            
            // ì´ gameEnded ì´ë²¤íŠ¸ê°€ ë°œìƒí•œ ì‹œì ì˜ ê²Œì„ ì„¸ëŒ€ë¥¼ ìº¡ì²˜
            const thisGameGeneration = gameGeneration;

            // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œë¥¼ ê¸°ë‹¤ë¦¬ëŠ” í•¨ìˆ˜
            const processGameEnd = () => {
                addDebugLog(`ğŸ¯ processGameEnd í˜¸ì¶œë¨ (ì„¸ëŒ€: ${thisGameGeneration}, í˜„ì¬: ${gameGeneration})`, 'gameEnd');
                addDebugLog(`ğŸ“Š ì• ë‹ˆë©”ì´ì…˜ ìƒíƒœ: complete=${window.lastRollerAnimationComplete}, time=${window.lastRollerAnimationCompleteTime ? new Date(window.lastRollerAnimationCompleteTime).toLocaleTimeString() : 'null'}`, 'gameEnd');

                // ì´ë¯¸ ìƒˆ ê²Œì„ì´ ì‹œì‘ëœ ê²½ìš° UI ë¦¬ì…‹ì„ ê±´ë„ˆëœ€ (í”Œë˜ê·¸ ì¶©ëŒ ë°©ì§€)
                if (thisGameGeneration !== gameGeneration) {
                    addDebugLog(`âš ï¸ ì´ë¯¸ ìƒˆ ê²Œì„(ì„¸ëŒ€ ${gameGeneration})ì´ ì‹œì‘ë¨ - processGameEnd ê±´ë„ˆëœ€ (ì„¸ëŒ€ ${thisGameGeneration})`, 'gameEnd');
                    return;
                }

                isGameActive = false;
                hasRolledInCurrentGame = false;
                rolledUsersInGame = []; // ê²Œì„ ì¢…ë£Œ ì‹œ êµ´ë¦° ì‚¬ìš©ì ëª©ë¡ ì´ˆê¸°í™”
                if (window.SoundManager) SoundManager.stopLoop('dice_bgm');

                // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í”Œë˜ê·¸ ì´ˆê¸°í™” (ê²Œì„ ì¢…ë£Œ ì‹œ)
                window.lastRollerAnimationComplete = false;
                window.lastRollerAnimationCompleteTime = null;
                window._lastRollerAnimationStarted = false;
                addDebugLog('ğŸ”„ ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í”Œë˜ê·¸ ì´ˆê¸°í™”', 'gameEnd');
                
                // ê²°ê³¼ì°½ í‘œì‹œ í”Œë˜ê·¸ ì´ˆê¸°í™” (ë‹¤ìŒ ê²Œì„ì„ ìœ„í•´)
                window.allRolledMessageShown = false;
                
                // ëŒ€ê¸° interval ì •ë¦¬
                if (window.allRolledWaitInterval) {
                    clearInterval(window.allRolledWaitInterval);
                    window.allRolledWaitInterval = null;
                }
                // historyDataëŠ” ëˆ„ì  ê¸°ë¡ì„ ìœ ì§€í•˜ë¯€ë¡œ ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ
                // currentGameHistoryëŠ” í˜„ì¬ ê²Œì„ì˜ ê¸°ë¡ë§Œ í¬í•¨ë¨
                
                // ê²Œì„ ê¸°ë¡ ì œëª©ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ (ê²Œì„ ê¸°ë¡ìœ¼ë¡œ ê³„ì† í‘œì‹œ)
                document.getElementById('historyTitle').textContent = 'ğŸ“‹ ê²Œì„';
                
                // êµ´ë¦° ì¸ì› ì—…ë°ì´íŠ¸
                updateRolledUsersCount();
                
                // ê²Œì„ ì¢…ë£Œ ì‹œ ì¤€ë¹„ ìƒíƒœ ì´ˆê¸°í™”
                isReady = false;
                readyUsers = [];
                renderReadyUsers();
                updateReadyButton();
                
                // ê²Œì„ ì¢…ë£Œ ì‹œ ì¤€ë¹„ ì„¹ì…˜ ë‹¤ì‹œ í‘œì‹œ
                document.getElementById('readySection').style.display = 'block';
                
                // í˜¸ìŠ¤íŠ¸ UI ì—…ë°ì´íŠ¸ (ë“œë˜ê·¸ ì•ˆë‚´ ë©˜íŠ¸ í¬í•¨)
                updateHostUI();
                
                document.getElementById('gameStatus').textContent = 'ê²Œì„ ì¢…ë£Œë¨';
                document.getElementById('gameStatus').classList.remove('playing');
                document.getElementById('gameStatus').classList.add('waiting');
                document.getElementById('startButton').style.display = 'block';
                document.getElementById('endButton').style.display = 'none';
                // ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸° ë²„íŠ¼ì€ ì œê±°ë¨
                document.getElementById('progressSection').style.display = 'none';
                document.getElementById('notRolledSection').style.display = 'none';
                
                // ì£¼ë¬¸ë°›ê¸° ì‹œì‘ ë²„íŠ¼ í‘œì‹œ (Hostë§Œ)
                if (isHost) {
                    document.getElementById('startOrderButton').style.display = 'block';
                }
                
                // ê²Œì„ ì¢…ë£Œ ì‹œ ë£° ìˆ˜ì • ê°€ëŠ¥í•˜ë„ë¡ UI ì—…ë°ì´íŠ¸ (í˜¸ìŠ¤íŠ¸ë§Œ)
                updateGameRulesUI();
                
                renderHistory();
                
                // ì£¼ì‚¬ìœ„ UIê°€ ì œê±°ë˜ì–´ ê²°ê³¼ëŠ” ê²Œì„ ê¸°ë¡ì—ì„œë§Œ í™•ì¸ ê°€ëŠ¥
            };
            
            // ë§ˆì§€ë§‰ êµ´ë¦¬ëŠ” ì‚¬ëŒì˜ ì• ë‹ˆë©”ì´ì…˜ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
            addDebugLog('ğŸ® gameEnded ì´ë²¤íŠ¸ ìˆ˜ì‹ ', 'gameEnd');
            addDebugLog(`ğŸ“Š currentGameHistory ê¸¸ì´: ${currentGameHistory.length}`, 'gameEnd');
            
            const checkAnimationComplete = () => {
                const hasComplete = window.lastRollerAnimationComplete;
                const completeTime = window.lastRollerAnimationCompleteTime;
                const now = Date.now();
                
                addDebugLog(`ğŸ” ì• ë‹ˆë©”ì´ì…˜ ìƒíƒœ ì²´í¬: complete=${hasComplete}, time=${completeTime ? new Date(completeTime).toLocaleTimeString() : 'null'}`, 'animation');
                
                // ì• ë‹ˆë©”ì´ì…˜ì´ ì™„ë£Œë˜ì—ˆê±°ë‚˜, ì• ë‹ˆë©”ì´ì…˜ì´ í•„ìš” ì—†ëŠ” ê²½ìš° ì¦‰ì‹œ ì²˜ë¦¬
                if (hasComplete && completeTime) {
                    // ë§ˆì§€ë§‰ ì‚¬ëŒì˜ ê²½ìš° ê³ ì • ì‹œê°„ ì• ë‹ˆë©”ì´ì…˜ì„ ì‚¬ìš©í•˜ë¯€ë¡œ
                    // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ ì‹œê°„ì—ëŠ” ì´ë¯¸ 0.5ì´ˆ ëŒ€ê¸° ì‹œê°„ì´ í¬í•¨ë˜ì–´ ìˆìŒ
                    // ë”°ë¼ì„œ ì¦‰ì‹œ ì²˜ë¦¬ ê°€ëŠ¥
                    addDebugLog(`âœ… ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ ì¡°ê±´ ë§Œì¡± (ê³ ì • ì‹œê°„ ì• ë‹ˆë©”ì´ì…˜) - processGameEnd í˜¸ì¶œ`, 'gameEnd');
                    processGameEnd();
                    return true;
                } else {
                    addDebugLog('â³ ì• ë‹ˆë©”ì´ì…˜ì´ ì•„ì§ ì™„ë£Œë˜ì§€ ì•ŠìŒ', 'animation');
                }
                // ì• ë‹ˆë©”ì´ì…˜ì´ ì•„ì§ ì™„ë£Œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ëŒ€ê¸°
                return false;
            };
            
            // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œë¥¼ ê¸°ë‹¤ë¦¬ëŠ” í•¨ìˆ˜
            const waitForAnimation = () => {
                addDebugLog('ğŸš€ waitForAnimation ì‹œì‘', 'gameEnd');

                // ì´ë¯¸ processGameEndê°€ í˜¸ì¶œë˜ì—ˆëŠ”ì§€ ì¶”ì 
                let gameEndProcessed = false;
                const safeProcessGameEnd = () => {
                    if (gameEndProcessed) {
                        addDebugLog('âš ï¸ processGameEnd ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€ë¨', 'gameEnd');
                        return;
                    }
                    gameEndProcessed = true;
                    processGameEnd();
                };

                // ì¦‰ì‹œ í™•ì¸ìš© ë˜í¼
                const checkAndProcess = () => {
                    const hasComplete = window.lastRollerAnimationComplete;
                    const completeTime = window.lastRollerAnimationCompleteTime;
                    addDebugLog(`ğŸ” ì• ë‹ˆë©”ì´ì…˜ ìƒíƒœ ì²´í¬: complete=${hasComplete}, time=${completeTime ? new Date(completeTime).toLocaleTimeString() : 'null'}`, 'animation');
                    if (hasComplete && completeTime) {
                        addDebugLog(`âœ… ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ ì¡°ê±´ ë§Œì¡± - safeProcessGameEnd í˜¸ì¶œ`, 'gameEnd');
                        safeProcessGameEnd();
                        return true;
                    }
                    addDebugLog('â³ ì• ë‹ˆë©”ì´ì…˜ì´ ì•„ì§ ì™„ë£Œë˜ì§€ ì•ŠìŒ', 'animation');
                    return false;
                };

                // ì¦‰ì‹œ í™•ì¸
                if (checkAndProcess()) {
                    addDebugLog('âœ… ì¦‰ì‹œ ì™„ë£Œ ì²˜ë¦¬', 'gameEnd');
                    return;
                }

                let checkCount = 0;

                // ì´ì „ ì¸í„°ë²Œ/íƒ€ì„ì•„ì›ƒ ì •ë¦¬
                if (gameEndWaitInterval) {
                    clearInterval(gameEndWaitInterval);
                    gameEndWaitInterval = null;
                }
                if (gameEndWaitTimeout) {
                    clearTimeout(gameEndWaitTimeout);
                    gameEndWaitTimeout = null;
                }

                // ì• ë‹ˆë©”ì´ì…˜ì´ ì§„í–‰ ì¤‘ì´ë©´ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸° (ì „ì—­ ë³€ìˆ˜ì— ì €ì¥)
                gameEndWaitInterval = setInterval(() => {
                    // ì„¸ëŒ€ê°€ ë³€ê²½ë˜ì—ˆìœ¼ë©´ ë” ì´ìƒ ì²´í¬í•˜ì§€ ì•ŠìŒ
                    if (thisGameGeneration !== gameGeneration) {
                        addDebugLog(`âš ï¸ ì„¸ëŒ€ ë³€ê²½ ê°ì§€ (${thisGameGeneration} â†’ ${gameGeneration}) - ëŒ€ê¸° ì¤‘ë‹¨`, 'gameEnd');
                        clearInterval(gameEndWaitInterval);
                        gameEndWaitInterval = null;
                        if (gameEndWaitTimeout) {
                            clearTimeout(gameEndWaitTimeout);
                            gameEndWaitTimeout = null;
                        }
                        return;
                    }

                    checkCount++;
                    if (checkCount % 20 === 0) { // 1ì´ˆë§ˆë‹¤ ë¡œê·¸ (50ms * 20 = 1000ms)
                        addDebugLog(`ğŸ”„ ì• ë‹ˆë©”ì´ì…˜ ëŒ€ê¸° ì¤‘... (${checkCount * 50}ms ê²½ê³¼)`, 'animation');
                    }
                    if (checkAndProcess()) {
                        addDebugLog(`âœ… ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í™•ì¸ - interval/timeout ì •ë¦¬ (ì´ ${checkCount}íšŒ ì²´í¬)`, 'gameEnd');
                        clearInterval(gameEndWaitInterval);
                        gameEndWaitInterval = null;
                        if (gameEndWaitTimeout) {
                            clearTimeout(gameEndWaitTimeout);
                            gameEndWaitTimeout = null;
                        }
                    }
                }, 50); // 50msë§ˆë‹¤ í™•ì¸

                // ìµœëŒ€ 5ì´ˆ ëŒ€ê¸° (ê²Œì„ ì¢…ë£Œ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ë¹ ë¥´ê²Œ ì²˜ë¦¬, ì „ì—­ ë³€ìˆ˜ì— ì €ì¥)
                gameEndWaitTimeout = setTimeout(() => {
                    // ì„¸ëŒ€ê°€ ë³€ê²½ë˜ì—ˆìœ¼ë©´ ê°•ì œ ì¢…ë£Œí•˜ì§€ ì•ŠìŒ
                    if (thisGameGeneration !== gameGeneration) {
                        addDebugLog(`âš ï¸ ì„¸ëŒ€ ë³€ê²½ìœ¼ë¡œ íƒ€ì„ì•„ì›ƒ ë¬´ì‹œ (${thisGameGeneration} â†’ ${gameGeneration})`, 'gameEnd');
                        if (gameEndWaitInterval) {
                            clearInterval(gameEndWaitInterval);
                            gameEndWaitInterval = null;
                        }
                        gameEndWaitTimeout = null;
                        return;
                    }

                    addDebugLog('â° íƒ€ì„ì•„ì›ƒ ë°œìƒ (5ì´ˆ ê²½ê³¼)', 'warn');
                    if (gameEndWaitInterval) {
                        clearInterval(gameEndWaitInterval);
                        gameEndWaitInterval = null;
                    }
                    if (!window.lastRollerAnimationComplete) {
                        addDebugLog('âš ï¸ ì• ë‹ˆë©”ì´ì…˜ì´ ì•„ì§ ì‹œì‘ë˜ì§€ ì•ŠìŒ - ì¶”ê°€ 0.5ì´ˆ ëŒ€ê¸°', 'warn');
                        setTimeout(() => {
                            // ì¶”ê°€ ëŒ€ê¸° í›„ì—ë„ ì„¸ëŒ€ ì²´í¬
                            if (thisGameGeneration !== gameGeneration) {
                                addDebugLog(`âš ï¸ ì„¸ëŒ€ ë³€ê²½ìœ¼ë¡œ ê°•ì œ ì¢…ë£Œ ì·¨ì†Œ (${thisGameGeneration} â†’ ${gameGeneration})`, 'gameEnd');
                                return;
                            }
                            addDebugLog('âš ï¸ ê°•ì œ safeProcessGameEnd í˜¸ì¶œ (íƒ€ì„ì•„ì›ƒ)', 'error');
                            safeProcessGameEnd();
                        }, 500);
                    } else {
                        addDebugLog('âš ï¸ ê°•ì œ safeProcessGameEnd í˜¸ì¶œ (íƒ€ì„ì•„ì›ƒ, ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œë¨)', 'warn');
                        safeProcessGameEnd();
                    }
                    gameEndWaitTimeout = null;
                }, 5000);
            };
            
            waitForAnimation();
        });

        // í´ë¼ì´ì–¸íŠ¸ ì‹œë“œ ìƒì„±
        function generateClientSeed() {
            return Date.now().toString() + Math.random().toString(36).substring(2);
        }

        // ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸°
        let diceAnimationInterval = null;

        // rollDice í•¨ìˆ˜ëŠ” ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ (ëª…ë ¹ì–´ë¡œ ëŒ€ì²´)
        function rollDice() {
            // ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸°ëŠ” /ì£¼ì‚¬ìœ„ ëª…ë ¹ì–´ë¡œë§Œ ê°€ëŠ¥
            showCustomAlert('ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸°ëŠ” /ì£¼ì‚¬ìœ„ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”!\nì˜ˆ: /ì£¼ì‚¬ìœ„ 100', 'info');
        }

        // ì£¼ì‚¬ìœ„ ê²°ê³¼ ìˆ˜ì‹ 
        socket.on('diceRolled', (record) => {
            // ë””ë²„ê·¸: diceRolled ì´ë²¤íŠ¸ ìˆ˜ì‹  ë¡œê·¸ (ë§ˆì§€ë§‰ ì‚¬ëŒë§Œ)
            if (record.isLastRoller) {
                console.log('ğŸ² [DEBUG] ë§ˆì§€ë§‰ ì‚¬ëŒ diceRolled:', record.user, record.result);
            }
            addDebugLog(`ğŸ“¥ diceRolled ìˆ˜ì‹ : user=${record.user}, result=${record.result}, isLastRoller=${record.isLastRoller}, ì„¸ëŒ€=${gameGeneration}`, 'dice');

            // ChatModuleì˜ chatHistoryì— ì£¼ì‚¬ìœ„ ê²°ê³¼ ì—…ë°ì´íŠ¸ (ê³ ì • ë©”ì‹œì§€ í‘œì‹œìš©)
            ChatModule.updateDiceResult(record.user, {
                result: record.result,
                range: record.range,
                isNotReady: record.isNotReady,
                deviceType: record.deviceType,
                isLastRoller: record.isLastRoller,
                isHighGameAnimation: record.isHighGameAnimation,
                isLowGameAnimation: record.isLowGameAnimation,
                isNearGameAnimation: record.isNearGameAnimation
            });

            // ì‚¬ìš´ë“œëŠ” rollDiceWithRangeì—ì„œ ëª…ë ¹ì–´ ì…ë ¥ ì¦‰ì‹œ ì¬ìƒë¨
            // ì¤€ë¹„í•˜ì§€ ì•Šì€ ì‚¬ëŒì¸ì§€ í™•ì¸
            const isNotReady = record.isNotReady === true;
            
            // ê²Œì„ ì§„í–‰ ì¤‘ì´ë©´ ìµœì´ˆ 1íšŒë§Œ ê¸°ë¡ì— ì €ì¥ (ì¤€ë¹„í•˜ì§€ ì•Šì€ ì‚¬ëŒ ì œì™¸)
            const isFirstRollInGame = isGameActive && !rolledUsersInGame.includes(record.user) && !isNotReady;
            const isNotGameActive = !isGameActive;
            
            // ë””ë²„ê·¸: ìƒíƒœ ë¡œê·¸
            addDebugLog(`ğŸ“Š ìƒíƒœ: isGameActive=${isGameActive}, isFirstRollInGame=${isFirstRollInGame}, rolledUsersInGame=[${rolledUsersInGame.join(',')}]`, 'dice');
            
            // ê²Œì„ ì¢…ë£Œ í›„ì—ëŠ” ì—°ìŠµ ê¸°ë¡ì„ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
            // ì—°ìŠµ ê¸°ë¡ì€ ìµœì´ˆ ë°© ì…ì¥ ì‹œë‚˜ ê²Œì„ ë°ì´í„° ì‚­ì œ í›„ì—ë§Œ ì¶”ê°€ ê°€ëŠ¥
            const hasGameEndedBefore = historyData.some(r => r.isGameActive === true);
            const shouldSaveToHistory = (isNotGameActive || isFirstRollInGame) && !isNotReady && !(isNotGameActive && hasGameEndedBefore);
            const isLastRoller = record.isLastRoller === true;
            const isHighGameAnimation = record.isHighGameAnimation === true;
            const isLowGameAnimation = record.isLowGameAnimation === true;
            const isNearGameAnimation = record.isNearGameAnimation === true;
            const hasSpecialAnimation = isHighGameAnimation || isLowGameAnimation || isNearGameAnimation;
            
            // ë§ˆì§€ë§‰ êµ´ë¦¬ëŠ” ì‚¬ëŒ ë˜ëŠ” í•˜ì´/ë¡œìš°/ë‹ˆì–´ ì• ë‹ˆë©”ì´ì…˜ì´ ìˆëŠ” ì‚¬ëŒì€ ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ê¸°ë¡ì— ì €ì¥ (ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì—ëŠ” ì €ì¥í•˜ì§€ ì•ŠìŒ)
            // ë‹¤ë¥¸ ì‚¬ëŒë“¤ì€ ì¦‰ì‹œ ê¸°ë¡ì— ì €ì¥
            if (shouldSaveToHistory && !((isLastRoller || hasSpecialAnimation) && isGameActive)) {
                historyData.push(record);
            }
            
            // ê²Œì„ ì§„í–‰ ì¤‘ì´ê³  í•´ë‹¹ ì‚¬ìš©ìê°€ ì²˜ìŒ êµ´ë ¸ë‹¤ë©´ ëª©ë¡ì— ì¶”ê°€ (ì¤€ë¹„í•˜ì§€ ì•Šì€ ì‚¬ëŒ ì œì™¸)
            if (isGameActive && !rolledUsersInGame.includes(record.user) && !isNotReady) {
                rolledUsersInGame.push(record.user);
            }
            
            // í˜„ì¬ ì‚¬ìš©ìê°€ êµ´ë ¸ë‹¤ë©´ hasRolledInCurrentGame í”Œë˜ê·¸ ì„¤ì •
            if (isGameActive && record.user === currentUser) {
                hasRolledInCurrentGame = true;
            }
            
            // êµ´ë¦° ì¸ì› ì—…ë°ì´íŠ¸
            updateRolledUsersCount();
            
            // /ì£¼ì‚¬ìœ„ ëª…ë ¹ì–´ ë©”ì‹œì§€ë¥¼ ì°¾ì•„ì„œ ì£¼ì‚¬ìœ„ ê²°ê³¼ ì¶”ê°€ ë° ì´ë¦„ ì•ì— ë””ë°”ì´ìŠ¤ ì•„ì´ì½˜ ì¶”ê°€
            const chatMessages = document.getElementById('chatMessages');
            const diceCommandMessages = Array.from(chatMessages.children).filter(div =>
                div.getAttribute('data-dice-command') === 'true' &&
                div.getAttribute('data-user-name') === record.user
            );

            if (isLastRoller) {
                addDebugLog(`ğŸ¯ ë§ˆì§€ë§‰ ì‚¬ëŒ diceRolled: user=${record.user}, diceCommandMessages=${diceCommandMessages.length}, shouldSaveToHistory=${shouldSaveToHistory}, isGameActive=${isGameActive}`, 'animation');
            }

            // ì£¼ì‚¬ìœ„ ê²°ê³¼ëŠ” í•­ìƒ í‘œì‹œí•˜ë˜, ê¸°ë¡ì— ì €ì¥ë˜ëŠ” ê²½ìš°ì—ë§Œ ì•„ì´ì½˜ í‘œì‹œ
            if (diceCommandMessages.length > 0) {
                // ë§ˆì§€ë§‰ /ì£¼ì‚¬ìœ„ ë©”ì‹œì§€ë¥¼ ì°¾ì•„ì„œ ê²°ê³¼ ì¶”ê°€
                const lastDiceCommandMsg = diceCommandMessages[diceCommandMessages.length - 1];
                
                // ì´ë¦„ ì•ì— ë””ë°”ì´ìŠ¤ ì•„ì´ì½˜ ì¶”ê°€ (í•­ìƒ í‘œì‹œ)
                const userNameSpan = lastDiceCommandMsg.querySelector('span[data-user-name-display="' + record.user + '"]');
                if (userNameSpan && record.deviceType) {
                    const deviceIcon = getDeviceIcon(record.deviceType);
                    const currentText = userNameSpan.textContent;
                    // ì•„ì´ì½˜ì´ ì—†ìœ¼ë©´ ì¶”ê°€ (í•­ìƒ í‘œì‹œë˜ë„ë¡ ë³´ì¥)
                    if (!currentText.includes(deviceIcon)) {
                        // í˜¸ìŠ¤íŠ¸ ì•„ì´ì½˜ì´ ìˆìœ¼ë©´ ê·¸ ë’¤ì—, ì—†ìœ¼ë©´ ë§¨ ì•ì— ë””ë°”ì´ìŠ¤ ì•„ì´ì½˜ ì¶”ê°€
                        if (currentText.includes('ğŸ‘‘')) {
                            userNameSpan.textContent = currentText.replace('ğŸ‘‘', `ğŸ‘‘ ${deviceIcon}`);
                        } else {
                            userNameSpan.textContent = `${deviceIcon} ${currentText}`;
                        }
                    } else {
                        // ì•„ì´ì½˜ì´ ì´ë¯¸ ìˆì§€ë§Œ ì‚¬ë¼ì¡Œì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë‹¤ì‹œ í™•ì¸í•˜ì—¬ ì¶”ê°€
                        // (ë‚˜) í…ìŠ¤íŠ¸ë¥¼ ì œì™¸í•œ ìˆœìˆ˜ ì´ë¦„ ë¶€ë¶„ì— ì•„ì´ì½˜ì´ ìˆëŠ”ì§€ í™•ì¸
                        const nameWithoutMe = currentText.replace(' (ë‚˜)', '');
                        if (!nameWithoutMe.includes(deviceIcon)) {
                            if (currentText.includes('ğŸ‘‘')) {
                                userNameSpan.textContent = currentText.replace('ğŸ‘‘', `ğŸ‘‘ ${deviceIcon}`);
                            } else {
                                userNameSpan.textContent = `${deviceIcon} ${currentText}`;
                            }
                        }
                    }
                }
                
                const resultContainer = lastDiceCommandMsg.querySelector('span[data-dice-result-container="true"]');
                if (resultContainer) {
                    // ì´ë¯¸ ì£¼ì‚¬ìœ„ ê²°ê³¼ê°€ ì¶”ê°€ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                    const existingResult = resultContainer.querySelector('span[data-dice-result]');
                    if (!existingResult) {
                        // ì£¼ì‚¬ìœ„ ê²°ê³¼ë¥¼ ì˜¤ë¥¸ìª½ ì»¨í…Œì´ë„ˆì— ì¶”ê°€
                        const diceResultSpan = document.createElement('span');
                        diceResultSpan.setAttribute('data-dice-result', 'true');
                        // ì¤€ë¹„í•˜ì§€ ì•Šì€ ì‚¬ëŒì´ê±°ë‚˜ ê¸°ë¡ì— ì €ì¥ë˜ì§€ ì•ŠëŠ” ê²½ìš° ìˆ«ìë§Œ í‘œì‹œ
                        const isNotReady = record.isNotReady === true;
                        
                        const finalResult = record.result;
                        const diceIcon = (shouldSaveToHistory && !isNotReady) ? 'ğŸ² ' : '';
                        
                        // ì• ë‹ˆë©”ì´ì…˜ í”Œë˜ê·¸ í™•ì¸
                        const isLastRoller = record.isLastRoller === true;
                        const isHighGameAnimation = record.isHighGameAnimation === true;
                        const isLowGameAnimation = record.isLowGameAnimation === true;
                        const isNearGameAnimation = record.isNearGameAnimation === true;
                        const hasSpecialAnimation = isHighGameAnimation || isLowGameAnimation || isNearGameAnimation;
                        const isTestAnimation = finalResult >= 1001 && finalResult <= 1006;
                        
                        // ì• ë‹ˆë©”ì´ì…˜ì€ ë³¸ê²Œì„ì—ì„œ ìµœì´ˆ 1íšŒë§Œ ì¬ìƒ (ê¸°ë¡ì— ì €ì¥ë˜ëŠ” ê²½ìš°ì—ë§Œ)
                        // í•˜ì´/ë¡œìš°/ë‹ˆì–´ ì• ë‹ˆë©”ì´ì…˜ì´ ìˆëŠ” ê²½ìš°ì—ë„ ì• ë‹ˆë©”ì´ì…˜ì„ ì¬ìƒí•´ì•¼ í•˜ë¯€ë¡œ
                        // shouldSaveToHistoryê°€ falseì—¬ë„ ì• ë‹ˆë©”ì´ì…˜ í”Œë˜ê·¸ê°€ ìˆìœ¼ë©´ ì¬ìƒ
                        const shouldAnimate = (shouldSaveToHistory && !isNotReady) || (hasSpecialAnimation && !isNotReady && isGameActive);
                        
                        // ë””ë²„ê·¸: ì• ë‹ˆë©”ì´ì…˜ ì¡°ê±´ ë¡œê·¸
                        if (isLastRoller) {
                            addDebugLog(`ğŸ” ì• ë‹ˆë©”ì´ì…˜ ì¡°ê±´: shouldAnimate=${shouldAnimate}, shouldSaveToHistory=${shouldSaveToHistory}, isGameActive=${isGameActive}`, 'animation');
                        }
                        
                        // ì´ˆê¸° ìŠ¤íƒ€ì¼ ì„¤ì •
                        if (shouldSaveToHistory && !isNotReady) {
                            diceResultSpan.style.cssText = 'font-weight: 600; color: #333;';
                            diceResultSpan.textContent = diceIcon;
                        } else {
                            diceResultSpan.style.cssText = 'font-weight: 600; color: #333;';
                            diceResultSpan.textContent = '';
                            // resultContainerë¥¼ ì˜¤ë¥¸ìª½ ëì— ë¶™ë„ë¡ ìŠ¤íƒ€ì¼ ì¡°ì •
                            resultContainer.style.cssText = 'min-width: 60px; display: flex; justify-content: flex-end;';
                        }
                        resultContainer.appendChild(diceResultSpan);
                        
                        // ì• ë‹ˆë©”ì´ì…˜ì€ ë§ˆì§€ë§‰ êµ´ë¦¬ëŠ” ì‚¬ëŒ ë˜ëŠ” í•˜ì´/ë¡œìš°/ë‹ˆì–´ ê²Œì„ ì¡°ê±´ ë§Œì¡± ì‹œ ì¬ìƒ (í…ŒìŠ¤íŠ¸ìš© 1001~1006ì€ ì˜ˆì™¸)
                        if (shouldAnimate && (isLastRoller || hasSpecialAnimation || isTestAnimation)) {
                            // ë§ˆì§€ë§‰ ì‚¬ëŒì˜ ì• ë‹ˆë©”ì´ì…˜ì´ ì‹œì‘ë˜ë©´ ì´ì „ ì™„ë£Œ í”Œë˜ê·¸ ë¦¬ì…‹
                            if (isLastRoller) {
                                addDebugLog(`ğŸ”„ ë§ˆì§€ë§‰ ì‚¬ëŒ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ - ì´ì „ ì™„ë£Œ í”Œë˜ê·¸ ë¦¬ì…‹`, 'animation');
                                window.lastRollerAnimationComplete = false;
                                window.lastRollerAnimationCompleteTime = null;
                                window._lastRollerAnimationStarted = true;
                            }
                            
                            addDebugLog(`ğŸ¬ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘: user=${record.user}, result=${finalResult}, isLastRoller=${isLastRoller}`, 'animation');
                            
                            // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ ì½œë°± í•¨ìˆ˜
                            const onAnimationComplete = () => {
                                const completeTime = Date.now();
                                if (window.SoundManager) SoundManager.playSound('dice_result', getDiceSoundEnabled());
                                addDebugLog(`âœ… ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ: user=${record.user}, isLastRoller=${isLastRoller}, time=${new Date(completeTime).toLocaleTimeString()}`, 'animation');
                                
                                // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ê¸°ë¡ì— ì €ì¥ ë° ì¢…ë£Œ ë©”ì‹œì§€ í‘œì‹œ í”Œë˜ê·¸ ì„¤ì •
                                // ë§ˆì§€ë§‰ ì‚¬ëŒì¸ ê²½ìš°ì—ë§Œ í”Œë˜ê·¸ ì„¤ì • (ì¤‘ìš”!)
                                if (isLastRoller) {
                                    window.lastRollerAnimationComplete = true;
                                    window.lastRollerAnimationCompleteTime = completeTime;
                                    addDebugLog(`ğŸ“ lastRollerAnimationComplete ì„¤ì •: true (ë§ˆì§€ë§‰ ì‚¬ëŒ), time=${completeTime}`, 'animation');
                                } else {
                                    addDebugLog(`â„¹ï¸ ë§ˆì§€ë§‰ ì‚¬ëŒì´ ì•„ë‹ˆë¯€ë¡œ í”Œë˜ê·¸ ì„¤ì • ì•ˆ í•¨`, 'animation');
                                }
                                
                                // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ê¸°ë¡ì— ì €ì¥
                                if (shouldSaveToHistory && !isNotReady) {
                                    historyData.push(record);
                                    updateRolledUsersCount();
                                    renderHistory();
                                }
                            };
                            
                            // í…ŒìŠ¤íŠ¸ìš©: 1001~1006 ë²”ìœ„ë©´ í•´ë‹¹ ì• ë‹ˆë©”ì´ì…˜ ê°•ì œ ì„ íƒ
                            let animationIndex = null;
                            if (finalResult >= 1001 && finalResult <= 1006) {
                                animationIndex = finalResult - 1001; // 1001â†’0, 1002â†’1, ..., 1006â†’5
                            }
                            
                            // ë§ˆì§€ë§‰ ì‚¬ëŒì˜ ê²½ìš° ê³ ì • ì‹œê°„ ì• ë‹ˆë©”ì´ì…˜ ì‚¬ìš©
                            if (isLastRoller) {
                                addDebugLog(`â±ï¸ ë§ˆì§€ë§‰ ì‚¬ëŒ - ê³ ì • ì‹œê°„ ì• ë‹ˆë©”ì´ì…˜ ì‚¬ìš© (3ì´ˆ)`, 'animation');
                                diceAnimationEffects.fixedDuration(diceResultSpan, diceIcon, finalResult, onAnimationComplete);
                            } else {
                                // ëœë¤ìœ¼ë¡œ ì—°ì¶œ íš¨ê³¼ ì„ íƒí•˜ì—¬ ì¬ìƒ (ë˜ëŠ” í…ŒìŠ¤íŠ¸ìš© íŠ¹ì • íš¨ê³¼)
                                playRandomDiceAnimation(diceResultSpan, diceIcon, finalResult, onAnimationComplete, animationIndex);
                            }
                        } else {
                            // ì• ë‹ˆë©”ì´ì…˜ ì—†ì´ ë°”ë¡œ ìµœì¢… ìˆ«ì í‘œì‹œ
                            if (isLastRoller) {
                                addDebugLog(`âš ï¸ ë§ˆì§€ë§‰ ì‚¬ëŒì´ì§€ë§Œ ì• ë‹ˆë©”ì´ì…˜ ì¡°ê±´ ë¶ˆë§Œì¡± - ì¦‰ì‹œ ìˆ«ì í‘œì‹œ`, 'warn');
                            }
                            diceResultSpan.textContent = diceIcon + finalResult;
                        }
                    }
                }
            }
            
            // ì•ˆì „ì¥ì¹˜: ë§ˆì§€ë§‰ ì‚¬ëŒì¸ë° ì• ë‹ˆë©”ì´ì…˜ì´ ì‹œì‘ë˜ì§€ ì•Šì€ ê²½ìš° (DOM ë¯¸ë°œê²¬, ê¸°ì¡´ ê²°ê³¼ ì¡´ì¬ ë“±)
            // lastRollerAnimationComplete í”Œë˜ê·¸ë¥¼ ì¦‰ì‹œ ì„¤ì •í•˜ì—¬ ê²Œì„ ì¢…ë£Œê°€ ì§„í–‰ë˜ë„ë¡ í•¨
            if (isLastRoller && isGameActive && !window.lastRollerAnimationComplete && !window._lastRollerAnimationStarted) {
                addDebugLog(`âš ï¸ ì•ˆì „ì¥ì¹˜ ë°œë™: isGameActive=${isGameActive}, lastRollerAnimationComplete=${window.lastRollerAnimationComplete}, _started=${window._lastRollerAnimationStarted}`, 'warn');
                window.lastRollerAnimationComplete = true;
                window.lastRollerAnimationCompleteTime = Date.now();
            }

            if (record.user === currentUser) {
                // ì£¼ì‚¬ìœ„ëŠ” ììœ ë¡­ê²Œ êµ´ë¦´ ìˆ˜ ìˆìŒ (hasRolledInCurrentGame ì‚¬ìš© ì•ˆí•¨)

                if (diceAnimationInterval) {
                    clearInterval(diceAnimationInterval);
                    diceAnimationInterval = null;
                }

                // ì£¼ì‚¬ìœ„ UIê°€ ì œê±°ë˜ì–´ ê²°ê³¼ëŠ” ê²Œì„ ê¸°ë¡ì—ì„œë§Œ í™•ì¸ ê°€ëŠ¥

                // ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸° ë²„íŠ¼ì€ ì œê±°ë¨ (ëª…ë ¹ì–´ë¡œ ëŒ€ì²´)
            }

            renderHistory();
        });

        // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
        socket.on('rollProgress', (progress) => {
            updateProgress(progress);
            updateRolledUsersCount();
        });

        // ëª¨ë‘ ì™„ë£Œ ì•Œë¦¼
        socket.on('allPlayersRolled', (data) => {
            // íŒì—… ì œê±° - ë°©ì¥ì´ ê²Œì„ì¢…ë£Œ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œë§Œ íŒì—… í‘œì‹œ
            document.getElementById('progressBar').style.background = 'linear-gradient(90deg, #28a745 0%, #20c997 100%)';
        });

        // ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸° ì—ëŸ¬
        socket.on('rollError', (message) => {
            showCustomAlert(message, 'info');
            
            if (diceAnimationInterval) {
                clearInterval(diceAnimationInterval);
                diceAnimationInterval = null;
            }
        });

        // ì—ëŸ¬ ì²˜ë¦¬
        socket.on('connectionError', (message) => {
            showCustomAlert(message, 'info');
            setTimeout(() => location.reload(), 2000);
        });

        socket.on('rateLimitError', (message) => {
            showCustomAlert(message, 'info');
        });

        socket.on('permissionError', (message) => {
            showCustomAlert(message, 'info');
        });

        socket.on('rangeError', (message) => {
            showCustomAlert(message, 'info');
        });

        // ì‚¬ìš©ì ëª©ë¡ ì—…ë°ì´íŠ¸
        socket.on('updateUsers', (users) => {
            if (window.SoundManager) SoundManager.playSound('common_notification', getDiceSoundEnabled());
            // í˜¸ìŠ¤íŠ¸ ìƒíƒœ í™•ì¸ ë° ì—…ë°ì´íŠ¸
            const myUser = users.find(u => u.name === currentUser);
            if (myUser && myUser.isHost !== isHost) {
                const wasHost = isHost;
                isHost = myUser.isHost;
                if (isHost && !wasHost && lastHostStatus !== isHost) {
                    // í˜¸ìŠ¤íŠ¸ ê¶Œí•œì´ ì „ë‹¬ë˜ì—ˆì„ ë•Œ
                    showCustomAlert('í˜¸ìŠ¤íŠ¸ ê¶Œí•œì´ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    updateHostUI();
                } else if (!isHost && wasHost) {
                    // í˜¸ìŠ¤íŠ¸ ê¶Œí•œì´ ì œê±°ë˜ì—ˆì„ ë•Œ
                    updateHostUI();
                }
                lastHostStatus = isHost;
            }
            
            usersList = users;
            ChatModule.updateConnectedUsers(users);
            updateUsers(users);
            updateHostCheckbox(users);
            // ì£¼ë¬¸ë°›ê¸°ê°€ í™œì„±í™”ëœ ìƒíƒœë©´ ì£¼ë¬¸í•˜ì§€ ì•Šì€ ì‚¬ëŒ ëª©ë¡ë„ ì—…ë°ì´íŠ¸
            if (isOrderActive) {
                OrderModule.renderNotOrderedUsers();
            }
        });

        function updateUsers(users) {
            const usersList = document.getElementById('usersList');
            const userCount = document.getElementById('userCount');
            
            userCount.textContent = users.length;
            
            if (users.length === 0) {
                usersList.innerHTML = '<div style="color: #999; text-align: center; padding: 10px; width: 100%;">ì ‘ì†ìê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }
            
            usersList.innerHTML = '';
            
            users.forEach((user) => {
                const userTag = document.createElement('div');
                userTag.className = 'user-tag' + (user.isHost ? ' host' : '');
                
                let content = user.name;
                if (user.isHost) {
                    content += ' ğŸ‘‘';
                }
                
                if (user.name === currentUser) {
                    content += ' (ë‚˜)';
                }
                
                userTag.textContent = content;
                
                // í˜¸ìŠ¤íŠ¸ê°€ ë‹¤ë¥¸ ì‚¬ìš©ìë¥¼ í´ë¦­í•˜ë©´ ì•¡ì…˜ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
                if (isHost && user.name !== currentUser) {
                    userTag.style.cursor = 'pointer';
                    userTag.title = 'í´ë¦­í•˜ì—¬ í˜¸ìŠ¤íŠ¸ì„ëª… ë˜ëŠ” ì œì™¸';
                    userTag.addEventListener('click', () => {
                        showPlayerActionDialog(user.name).then(action => {
                            if (action === 'host') {
                                // í˜¸ìŠ¤íŠ¸ì„ëª…
                                socket.emit('transferHost', user.name);
                            } else if (action === 'kick') {
                                // ì œì™¸ì‹œí‚¤ê¸°
                                showCustomConfirm(`${user.name}ë‹˜ì„ ê²Œì„ì—ì„œ ì œì™¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, 'warning').then(result => {
                                    if (result) {
                                        socket.emit('kickPlayer', user.name);
                                    }
                                });
                            }
                            // 'cancel'ì¸ ê²½ìš° ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
                        });
                    });
                }
                
                // í˜¸ìŠ¤íŠ¸ë§Œ ë“œë˜ê·¸ ê°€ëŠ¥í•˜ê²Œ ì„¤ì • (ê²Œì„ ì§„í–‰ ì¤‘ì´ ì•„ë‹ ë•Œ)
                if (isHost && !isGameActive) {
                    userTag.draggable = true;
                    userTag.style.cursor = 'grab';
                    userTag.setAttribute('data-user-name', user.name);
                    
                    // ë“œë˜ê·¸ ì‹œì‘
                    userTag.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', user.name);
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('source', 'users'); // ì ‘ì†ì ëª©ë¡ì—ì„œ ë“œë˜ê·¸í•˜ëŠ” ê²ƒ í‘œì‹œ
                        userTag.style.opacity = '0.5';
                    });
                    
                    // ë“œë˜ê·¸ ì¢…ë£Œ
                    userTag.addEventListener('dragend', (e) => {
                        userTag.style.opacity = '1';
                    });
                } else {
                    userTag.draggable = false;
                    userTag.style.cursor = 'default';
                }
                
                usersList.appendChild(userTag);
            });
            
            // ë“œë˜ê·¸ ì•ˆë‚´ ë©˜íŠ¸ ì—…ë°ì´íŠ¸
            const dragHint = document.getElementById('dragHint');
            if (dragHint) {
                if (isHost && !isGameActive) {
                    dragHint.style.display = 'inline';
                    console.log('ë“œë˜ê·¸ ì•ˆë‚´ ë©˜íŠ¸ í‘œì‹œ (updateUsersì—ì„œ)');
                } else {
                    dragHint.style.display = 'none';
                }
            }
        }
        
        // ì¤€ë¹„ ìƒíƒœ í† ê¸€
        function toggleReady() {
            socket.emit('toggleReady');
        }
        
        // ì¤€ë¹„ ìƒíƒœ ë³€ê²½ ìˆ˜ì‹ 
        socket.on('readyStateChanged', (data) => {
            isReady = data.isReady;
            updateReadyButton();
        });
        
        // ì¤€ë¹„ ëª©ë¡ ì—…ë°ì´íŠ¸
        socket.on('readyUsersUpdated', (users) => {
            readyUsers = users || [];
            renderReadyUsers();
            console.log('ì¤€ë¹„í•œ ì‚¬ëŒ ëª©ë¡ ì—…ë°ì´íŠ¸:', readyUsers);
            
            // ì¤€ë¹„ ì„¹ì…˜ í‘œì‹œ (ê²Œì„ ì§„í–‰ ì¤‘ì´ ì•„ë‹ ë•Œ)
            if (!isGameActive) {
                const readySection = document.getElementById('readySection');
                if (readySection) {
                    readySection.style.display = 'block';
                }
            }
        });
        
        // ì¤€ë¹„ ì—ëŸ¬ ì²˜ë¦¬
        socket.on('readyError', (message) => {
            showCustomAlert(message, 'info');
        });
        
        // ì¤€ë¹„í•œ ì‚¬ëŒ ëª©ë¡ ë Œë”ë§
        function renderReadyUsers() {
            const readyUsersList = document.getElementById('readyUsersList');
            const readyCount = document.getElementById('readyCount');
            
            if (!readyUsersList || !readyCount) return;
            
            readyCount.textContent = readyUsers.length;
            
            console.log('ì¤€ë¹„í•œ ì‚¬ëŒ ëª©ë¡ ë Œë”ë§:', readyUsers);
            
            if (readyUsers.length === 0) {
                readyUsersList.innerHTML = '<div style="color: #999; text-align: center; padding: 10px; width: 100%;">ì•„ì§ ì¤€ë¹„í•œ ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤</div>';
                // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì • (ë¹ˆ ìƒíƒœì¼ ë•Œë„)
                if (isHost && !isGameActive) {
                    setupDragAndDrop();
                }
                return;
            }
            
            readyUsersList.innerHTML = '';
            
            // ê°€ë‚˜ë‹¤ìˆœìœ¼ë¡œ ì •ë ¬
            const sortedReadyUsers = [...readyUsers].sort((a, b) => a.localeCompare(b, 'ko'));
            
            sortedReadyUsers.forEach((userName) => {
                const userTag = document.createElement('div');
                userTag.className = 'user-tag';
                userTag.style.background = '#d4edda';
                userTag.style.borderColor = '#28a745';
                userTag.style.color = '#155724';
                
                let content = userName;
                if (userName === currentUser) {
                    content += ' (ë‚˜)';
                }
                
                userTag.textContent = content;
                
                // í˜¸ìŠ¤íŠ¸ë§Œ ë“œë˜ê·¸ ê°€ëŠ¥í•˜ê²Œ ì„¤ì • (ê²Œì„ ì§„í–‰ ì¤‘ì´ ì•„ë‹ ë•Œ)
                if (isHost && !isGameActive) {
                    userTag.draggable = true;
                    userTag.style.cursor = 'grab';
                    userTag.setAttribute('data-user-name', userName);
                    
                    // ë“œë˜ê·¸ ì‹œì‘
                    userTag.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', userName);
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('source', 'ready'); // ì¤€ë¹„ ëª©ë¡ì—ì„œ ë“œë˜ê·¸í•˜ëŠ” ê²ƒ í‘œì‹œ
                        userTag.style.opacity = '0.5';
                        // ì „ì—­ ë³€ìˆ˜ì— ë“œë˜ê·¸ ì¤‘ì¸ ì‚¬ìš©ì ì €ì¥
                        window.draggedReadyUser = userName;
                    });
                    
                    // ë“œë˜ê·¸ ì¢…ë£Œ
                    userTag.addEventListener('dragend', (e) => {
                        userTag.style.opacity = '1';
                        // ë“œë¡­ì´ ì¤€ë¹„ ì„¹ì…˜ ë°–ì—ì„œ ì¼ì–´ë‚¬ëŠ”ì§€ í™•ì¸
                        // dragend ì´ë²¤íŠ¸ëŠ” ë“œë¡­ í›„ì— ë°œìƒí•˜ë¯€ë¡œ, ë“œë¡­ ìœ„ì¹˜ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŒ
                        // ëŒ€ì‹  ì „ì—­ ë“œë¡­ í”Œë˜ê·¸ë¥¼ ì‚¬ìš©
                        if (window.draggedReadyUser && !window.droppedInReadySection) {
                            // ì¤€ë¹„ ì„¹ì…˜ ë°–ì—ì„œ ë“œë¡­ë¨ - ì¤€ë¹„ ì·¨ì†Œ
                            if (isHost && !isGameActive) {
                                socket.emit('setUserReady', {
                                    userName: window.draggedReadyUser,
                                    isReady: false
                                });
                            }
                        }
                        // ì´ˆê¸°í™”
                        window.draggedReadyUser = null;
                        window.droppedInReadySection = false;
                    });
                } else {
                    userTag.draggable = false;
                    userTag.style.cursor = 'default';
                }
                
                readyUsersList.appendChild(userTag);
            });
            
            // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì •
            if (isHost && !isGameActive) {
                setupDragAndDrop();
            }
        }
        
        // ì¤€ë¹„ ë²„íŠ¼ ì—…ë°ì´íŠ¸
        function updateReadyButton() {
            const readyButton = document.getElementById('readyButton');
            if (isReady) {
                readyButton.textContent = 'ì¤€ë¹„ ì·¨ì†Œ';
                readyButton.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
            } else {
                readyButton.textContent = 'ì¤€ë¹„';
                readyButton.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
            }
        }
        
        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • (í˜¸ìŠ¤íŠ¸ë§Œ) - ì¤€ë¹„ ì„¹ì…˜ì„ ë“œë¡­ ì¡´ìœ¼ë¡œ
        function setupDragAndDrop() {
            const readyUsersList = document.getElementById('readyUsersList');
            const readySection = document.getElementById('readySection');
            
            if (!readyUsersList || !readySection) return;
            
            // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆê°€ ìˆìœ¼ë©´ ì œê±°í•˜ì§€ ì•Šê³  ì¶”ê°€ë§Œ í•¨ (ì¤‘ë³µ ë°©ì§€)
            if (readyUsersList.hasAttribute('data-drag-setup')) {
                return;
            }
            readyUsersList.setAttribute('data-drag-setup', 'true');
            
            // ë“œë¡­ ì¡´ ì„¤ì • (ì ‘ì†ì ëª©ë¡ì—ì„œ ë“œë˜ê·¸í•˜ëŠ” ê²½ìš°)
            readyUsersList.addEventListener('dragover', (e) => {
                e.preventDefault();
                const source = e.dataTransfer.getData('source');
                // ì ‘ì†ì ëª©ë¡ì—ì„œ ë“œë˜ê·¸í•˜ëŠ” ê²½ìš°ë§Œ í—ˆìš©
                if (source === 'users' && isHost && !isGameActive) {
                    e.dataTransfer.dropEffect = 'move';
                    readyUsersList.style.backgroundColor = '#e8f5e9';
                    readyUsersList.style.border = '2px dashed #28a745';
                }
            });
            
            readyUsersList.addEventListener('dragleave', (e) => {
                readyUsersList.style.backgroundColor = '';
                readyUsersList.style.border = '';
            });
            
            readyUsersList.addEventListener('drop', (e) => {
                e.preventDefault();
                readyUsersList.style.backgroundColor = '';
                readyUsersList.style.border = '';
                
                // ì¤€ë¹„ ì„¹ì…˜ ë‚´ë¶€ì—ì„œ ë“œë¡­ë¨ì„ í‘œì‹œ
                window.droppedInReadySection = true;
                
                if (!isHost || isGameActive) {
                    return;
                }
                
                const userName = e.dataTransfer.getData('text/plain');
                const source = e.dataTransfer.getData('source');
                
                // ì ‘ì†ì ëª©ë¡ì—ì„œ ë“œë˜ê·¸í•œ ê²½ìš°ë§Œ ì²˜ë¦¬
                if (source === 'users' && userName) {
                    // ì´ë¯¸ ì¤€ë¹„ ìƒíƒœì¸ì§€ í™•ì¸
                    const isAlreadyReady = readyUsers.includes(userName);
                    
                    if (!isAlreadyReady) {
                        // ì„œë²„ì— ì¤€ë¹„ ìƒíƒœ ì„¤ì • ìš”ì²­
                        socket.emit('setUserReady', {
                            userName: userName,
                            isReady: true
                        });
                    }
                }
            });
            
            // ì¤€ë¹„ ì„¹ì…˜ ì „ì²´ì— ë“œë¡­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ì¤€ë¹„ ëª©ë¡ì—ì„œ ë“œë˜ê·¸í•œ ê²½ìš° ì„¹ì…˜ ë‚´ë¶€ì—ì„œ ë“œë¡­ë˜ë©´ ì·¨ì†Œí•˜ì§€ ì•ŠìŒ)
            readySection.addEventListener('drop', (e) => {
                // ì¤€ë¹„ ì„¹ì…˜ ë‚´ë¶€ì—ì„œ ë“œë¡­ë¨ì„ í‘œì‹œ
                window.droppedInReadySection = true;
            });
            
            // ì „ì—­ ë“œë¡­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì¤€ë¹„ ì„¹ì…˜ ë°–ì—ì„œ ë“œë¡­ë˜ë©´ ì·¨ì†Œ)
            if (!document.documentElement.hasAttribute('data-global-drop-setup')) {
                document.documentElement.setAttribute('data-global-drop-setup', 'true');
                
                document.addEventListener('dragover', (e) => {
                    const source = e.dataTransfer.getData('source');
                    // ì¤€ë¹„ ëª©ë¡ì—ì„œ ë“œë˜ê·¸í•˜ëŠ” ê²½ìš°
                    if (source === 'ready' && isHost && !isGameActive) {
                        // ì¤€ë¹„ ì„¹ì…˜ ë°–ì— ìˆëŠ”ì§€ í™•ì¸
                        const readySection = document.getElementById('readySection');
                        if (readySection && !readySection.contains(e.target)) {
                            e.dataTransfer.dropEffect = 'move';
                            // ì‹œê°ì  í”¼ë“œë°± (ì„ íƒì‚¬í•­)
                        }
                    }
                });
                
                document.addEventListener('drop', (e) => {
                    const source = e.dataTransfer.getData('source');
                    const userName = e.dataTransfer.getData('text/plain');
                    
                    // ì¤€ë¹„ ëª©ë¡ì—ì„œ ë“œë˜ê·¸í•œ ê²½ìš°
                    if (source === 'ready' && userName && isHost && !isGameActive) {
                        const readySection = document.getElementById('readySection');
                        // ì¤€ë¹„ ì„¹ì…˜ ë°–ì—ì„œ ë“œë¡­ëœ ê²½ìš°
                        if (!readySection || !readySection.contains(e.target)) {
                            e.preventDefault();
                            // ì¤€ë¹„ ì·¨ì†Œ
                            socket.emit('setUserReady', {
                                userName: userName,
                                isReady: false
                            });
                        }
                    }
                });
            }
        }
        
        // ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡ (ChatModule ìœ„ì„)
        function sendChatMessage() {
            ChatModule.sendMessage();
        }

        // ì´ë¯¸ì§€ ì—…ë¡œë“œ
        function uploadImage() {
            ChatModule.showImageUploadModal((imageData, caption) => {
                socket.emit('sendImage', { imageData, caption });
            });
        }
        
        // í…ŒìŠ¤íŠ¸ ëª…ë ¹ì–´ ì²˜ë¦¬ (ì• ë‹ˆë©”ì´ì…˜ í…ŒìŠ¤íŠ¸ìš©)
        function handleTestCommand(command) {
            const parts = command.trim().split(/\s+/);
            if (parts.length < 2) {
                showCustomAlert('ì‚¬ìš©ë²•: /í…ŒìŠ¤íŠ¸ [ì• ë‹ˆë©”ì´ì…˜ë²ˆí˜¸]\nì˜ˆ: /í…ŒìŠ¤íŠ¸ 1001, /í…ŒìŠ¤íŠ¸ 1002, /í…ŒìŠ¤íŠ¸ 1003', 'info');
                return;
            }
            
            const animationNum = parseInt(parts[1]);
            if (isNaN(animationNum) || (animationNum < 1001 || animationNum > 1003)) {
                showCustomAlert('ì• ë‹ˆë©”ì´ì…˜ ë²ˆí˜¸ëŠ” 1001, 1002, 1003 ì¤‘ í•˜ë‚˜ì—¬ì•¼ í•©ë‹ˆë‹¤.', 'warning');
                return;
            }
            
            // ëœë¤ ìˆ«ì ìƒì„± (1~99)
            const randomResult = Math.floor(Math.random() * 99) + 1;
            
            // ì±„íŒ… ë©”ì‹œì§€ ë¨¼ì € ì „ì†¡
            socket.emit('sendMessage', { message: `/í…ŒìŠ¤íŠ¸ ${animationNum}` });
            
            // ê°€ì§œ ì£¼ì‚¬ìœ„ ê²°ê³¼ ìƒì„± (ì• ë‹ˆë©”ì´ì…˜ í…ŒìŠ¤íŠ¸ìš©)
            const testRecord = {
                user: currentUser,
                result: randomResult,
                time: new Date().toLocaleTimeString('ko-KR', { timeZone: 'Asia/Seoul' }),
                seed: 'test',
                range: '1~100',
                isNotReady: false,
                deviceType: isMobileDevice() ? (/iPhone|iPad|iPod/i.test(navigator.userAgent) ? 'ios' : 'android') : 'pc',
                isLastRoller: true // ì• ë‹ˆë©”ì´ì…˜ì„ ì¬ìƒí•˜ê¸° ìœ„í•´ trueë¡œ ì„¤ì •
            };
            
            // diceRolled ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë¡œì§ì„ ì§ì ‘ ì‹¤í–‰ (í…ŒìŠ¤íŠ¸ìš©)
            setTimeout(() => {
                // socket.on('diceRolled') í•¸ë“¤ëŸ¬ì˜ ë¡œì§ì„ ì§ì ‘ ì‹¤í–‰
                const isNotReady = testRecord.isNotReady === true;
                const isFirstRollInGame = isGameActive && !rolledUsersInGame.includes(testRecord.user) && !isNotReady;
                const isNotGameActive = !isGameActive;
                const shouldSaveToHistory = (isNotGameActive || isFirstRollInGame) && !isNotReady;
                
                // ì£¼ì‚¬ìœ„ ê²°ê³¼ í‘œì‹œ ë¡œì§ ì‹¤í–‰
                const chatMessages = document.getElementById('chatMessages');
                const diceCommandMessages = Array.from(chatMessages.children).filter(div => 
                    div.getAttribute('data-dice-command') === 'true' && 
                    div.getAttribute('data-user-name') === testRecord.user
                );
                
                if (diceCommandMessages.length > 0) {
                    const lastDiceCommandMsg = diceCommandMessages[diceCommandMessages.length - 1];
                    const resultContainer = lastDiceCommandMsg.querySelector('span[data-dice-result-container="true"]');
                    if (resultContainer) {
                        const existingResult = resultContainer.querySelector('span[data-dice-result]');
                        if (!existingResult) {
                            const diceResultSpan = document.createElement('span');
                            diceResultSpan.setAttribute('data-dice-result', 'true');
                            const finalResult = testRecord.result;
                            const diceIcon = (shouldSaveToHistory && !isNotReady) ? 'ğŸ² ' : '';
                            
                            diceResultSpan.style.cssText = 'font-weight: 600; color: #333;';
                            diceResultSpan.textContent = diceIcon;
                            resultContainer.appendChild(diceResultSpan);
                            
                            // í…ŒìŠ¤íŠ¸ìš© ì• ë‹ˆë©”ì´ì…˜ ì¬ìƒ
                            const onAnimationComplete = () => {
                                window.lastRollerAnimationComplete = true;
                                window.lastRollerAnimationCompleteTime = Date.now();
                            };
                            
                            const animationIndex = animationNum - 1001; // 1001â†’0, 1002â†’1, 1003â†’2
                            playRandomDiceAnimation(diceResultSpan, diceIcon, finalResult, onAnimationComplete, animationIndex);
                        }
                    }
                }
            }, 500); // ì±„íŒ… ë©”ì‹œì§€ê°€ ë¨¼ì € ë Œë”ë§ë˜ë„ë¡ ì•½ê°„ì˜ ì§€ì—°
        }
        
        // handleDiceCommandëŠ” ChatModuleì—ì„œ ì²˜ë¦¬ (onDiceRoll ì½œë°±ìœ¼ë¡œ rollDiceWithRange í˜¸ì¶œ)
        
        // ì§€ì •í•œ ë²”ìœ„ë¡œ ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸°
        function rollDiceWithRange(min, max) {
            // ì£¼ì‚¬ìœ„ UIê°€ ì œê±°ë˜ì–´ ì• ë‹ˆë©”ì´ì…˜ ì—†ì´ ë°”ë¡œ ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸° ìš”ì²­ ì „ì†¡
            if (diceAnimationInterval) {
                clearInterval(diceAnimationInterval);
                diceAnimationInterval = null;
            }

            // ëª…ë ¹ì–´ ì…ë ¥ ì¦‰ì‹œ ì‚¬ìš´ë“œ ì¬ìƒ (ì„œë²„ ì‘ë‹µ ì „)
            if (window.SoundManager) SoundManager.playSound('dice_roll', getDiceSoundEnabled());

            const clientSeed = generateClientSeed();
            socket.emit('requestRoll', { 
                userName: currentUser,
                clientSeed: clientSeed,
                min: min,
                max: max
            });
        }
        
        // ì±„íŒ… ì…ë ¥ì°½ ìë™ì™„ì„± ê´€ë ¨ ë³€ìˆ˜
        let chatCurrentSuggestions = [];
        let chatSelectedSuggestionIndex = -1;
        
        // ì±„íŒ… ì…ë ¥ì°½ ìë™ì™„ì„± ë“œë¡­ë‹¤ìš´ ë Œë”ë§
        function renderChatAutocompleteDropdown() {
            const dropdownDiv = document.getElementById('chatAutocompleteDropdown');
            const chatInput = document.getElementById('chatInput');
            const text = chatInput.value;
            
            dropdownDiv.innerHTML = '';
            
            chatCurrentSuggestions.forEach((suggestion, index) => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item' + (index === chatSelectedSuggestionIndex ? ' selected' : '');
                item.textContent = suggestion;
                
                // ì…ë ¥ëœ ë¶€ë¶„ ê°•ì¡°
                const prefix = document.createElement('strong');
                prefix.textContent = suggestion.substring(0, text.length);
                const suffix = document.createElement('span');
                suffix.textContent = suggestion.substring(text.length);
                
                item.innerHTML = '';
                item.appendChild(prefix);
                item.appendChild(suffix);
                
                item.addEventListener('click', () => {
                    applyChatSuggestion(suggestion);
                });
                
                dropdownDiv.appendChild(item);
            });
        }
        
        // ì±„íŒ… ì…ë ¥ì°½ ìë™ì™„ì„± ì—…ë°ì´íŠ¸
        function updateChatAutocompleteSuggestion() {
            const chatInput = document.getElementById('chatInput');
            const suggestionDiv = document.getElementById('chatAutocompleteSuggestion');
            const dropdownDiv = document.getElementById('chatAutocompleteDropdown');
            const text = chatInput.value;
            
            chatCurrentSuggestions = findChatAutocompleteSuggestions(text);
            chatSelectedSuggestionIndex = -1;
            
            if (chatCurrentSuggestions.length > 0) {
                if (isMobileDevice()) {
                    // ëª¨ë°”ì¼: ë“œë¡­ë‹¤ìš´ë§Œ í‘œì‹œ
                    suggestionDiv.style.display = 'none';
                    renderChatAutocompleteDropdown();
                    dropdownDiv.style.display = 'block';
                } else {
                    // PC: ë“œë¡­ë‹¤ìš´ í‘œì‹œ (íšŒìƒ‰ í…ìŠ¤íŠ¸ëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ)
                    suggestionDiv.style.display = 'none';
                    renderChatAutocompleteDropdown();
                    dropdownDiv.style.display = 'block';
                }
            } else {
                suggestionDiv.textContent = '';
                suggestionDiv.style.display = 'none';
                dropdownDiv.style.display = 'none';
            }
        }
        
        // ì±„íŒ… ì…ë ¥ì°½ ìë™ì™„ì„± ì ìš©
        function applyChatSuggestion(suggestion) {
            const chatInput = document.getElementById('chatInput');
            chatInput.value = suggestion;
            chatCurrentSuggestions = [];
            chatSelectedSuggestionIndex = -1;
            document.getElementById('chatAutocompleteSuggestion').style.display = 'none';
            document.getElementById('chatAutocompleteDropdown').style.display = 'none';
            chatInput.focus();
        }
        
        // ì±„íŒ… ì…ë ¥ì°½ì—ì„œ Enter í‚¤ë¡œ ì „ì†¡ ë° ìë™ì™„ì„±
        document.addEventListener('DOMContentLoaded', () => {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                // /, /ã…ˆ, /ì£¼, /ì£¼ã……, /ì£¼ì‚¬, /ì£¼ì‚¬ã…‡, /ì£¼ì‚¬ìš° ë“±ìœ¼ë¡œ ì‹œì‘í•  ë•Œë§Œ ìë™ì™„ì„± ì‘ë™
                chatInput.addEventListener('input', () => {
                    const text = chatInput.value.trim();
                    if (text === '/' ||
                        text === '/ã…ˆ' ||
                        text.startsWith('/ì£¼') ||
                        text.startsWith('/ì£¼ì‚¬')) {
                        updateChatAutocompleteSuggestion();
                    } else {
                        // í•´ë‹¹í•˜ì§€ ì•Šìœ¼ë©´ ìë™ì™„ì„± ìˆ¨ê¸°ê¸°
                        const suggestionDiv = document.getElementById('chatAutocompleteSuggestion');
                        const dropdownDiv = document.getElementById('chatAutocompleteDropdown');
                        if (suggestionDiv) suggestionDiv.style.display = 'none';
                        if (dropdownDiv) dropdownDiv.style.display = 'none';
                        chatCurrentSuggestions = [];
                        chatSelectedSuggestionIndex = -1;
                    }
                });
                
                chatInput.addEventListener('keydown', (e) => {
                    // Tabìœ¼ë¡œ ìë™ì™„ì„± ì ìš©
                    if (e.key === 'Tab' && chatCurrentSuggestions.length > 0) {
                        e.preventDefault();
                        const suggestionToApply = chatSelectedSuggestionIndex >= 0 
                            ? chatCurrentSuggestions[chatSelectedSuggestionIndex] 
                            : chatCurrentSuggestions[0];
                        applyChatSuggestion(suggestionToApply);
                        return;
                    }
                    
                    // ë°©í–¥í‚¤ë¡œ ì œì•ˆ ì„ íƒ
                    if (e.key === 'ArrowDown' && chatCurrentSuggestions.length > 0) {
                        e.preventDefault();
                        chatSelectedSuggestionIndex = (chatSelectedSuggestionIndex + 1) % chatCurrentSuggestions.length;
                        renderChatAutocompleteDropdown();
                        return;
                    }
                    
                    if (e.key === 'ArrowUp' && chatCurrentSuggestions.length > 0) {
                        e.preventDefault();
                        chatSelectedSuggestionIndex = chatSelectedSuggestionIndex <= 0 
                            ? chatCurrentSuggestions.length - 1 
                            : chatSelectedSuggestionIndex - 1;
                        renderChatAutocompleteDropdown();
                        return;
                    }
                    
                    // Escapeë¡œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
                    if (e.key === 'Escape') {
                        chatCurrentSuggestions = [];
                        chatSelectedSuggestionIndex = -1;
                        document.getElementById('chatAutocompleteSuggestion').style.display = 'none';
                        document.getElementById('chatAutocompleteDropdown').style.display = 'none';
                        return;
                    }
                    
                    // Enter í‚¤ ì²˜ë¦¬
                    if (e.key === 'Enter') {
                        // ìë™ì™„ì„± ë“œë¡­ë‹¤ìš´ì´ ì—´ë ¤ìˆìœ¼ë©´ ìë™ì™„ì„± ì ìš©
                        if (chatCurrentSuggestions.length > 0) {
                            e.preventDefault();
                            const suggestionToApply = chatSelectedSuggestionIndex >= 0 
                                ? chatCurrentSuggestions[chatSelectedSuggestionIndex] 
                                : chatCurrentSuggestions[0];
                            applyChatSuggestion(suggestionToApply);
                            return;
                        }
                        e.preventDefault();
                        sendChatMessage();
                    }
                });
            }
            
        });
        
        // ìƒˆ ë©”ì‹œì§€ ìˆ˜ì‹ 
        // ì±„íŒ… ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜ (ì¬ì‚¬ìš© ê°€ëŠ¥)
        function displayChatMessage(chatMessage, forceScroll = false) {
            const chatMessages = document.getElementById('chatMessages');
            
            // ì²« ë©”ì‹œì§€ë©´ ë¹ˆ ìƒíƒœ ë©”ì‹œì§€ ì œê±°
            if (chatMessages.children.length === 1 && chatMessages.children[0].textContent === 'ì±„íŒ… ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤') {
                chatMessages.innerHTML = '';
            }
            
            // ìŠ¤í¬ë¡¤ì´ ë§¨ ì•„ë˜ì— ìˆëŠ”ì§€ í™•ì¸ (10px ì—¬ìœ )
            const isScrolledToBottom = chatMessages.scrollHeight - chatMessages.scrollTop - chatMessages.clientHeight < 10;
            
            const messageDiv = document.createElement('div');
            
            // ì‹œìŠ¤í…œ ë©”ì‹œì§€ì¸ì§€ í™•ì¸
            const isSystemMessage = chatMessage.isSystemMessage || chatMessage.userName === 'ì‹œìŠ¤í…œ';
            
            // AI ë©”ì‹œì§€ì¸ì§€ í™•ì¸
            const isAI = chatMessage.isAI || chatMessage.userName === 'Gemini AI';
            
            // /ì£¼ì‚¬ìœ„ ë˜ëŠ” /í…ŒìŠ¤íŠ¸ ëª…ë ¹ì–´ì¸ì§€ í™•ì¸
            const isDiceCommand = chatMessage.message.startsWith('/ì£¼ì‚¬ìœ„') || chatMessage.message.startsWith('/í…ŒìŠ¤íŠ¸');
            
            // ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì²˜ë¦¬
            if (isSystemMessage) {
                messageDiv.style.cssText = 'margin: 20px 0; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
                
                // ê²Œì„ ì‹œì‘ ë©”ì‹œì§€ íŒŒì‹±
                const lines = chatMessage.message.split('\n');
                const titleLine = lines.find(line => line.includes('ê²Œì„ì‹œì‘'));
                // êµ¬ë¶„ì„ ê³¼ ì œëª©ì„ ì œì™¸í•œ ëª¨ë“  ë£° ì¤„ ì¶”ì¶œ
                const rulesLines = lines.filter(line => 
                    !line.includes('---') && 
                    !line.includes('ê²Œì„ì‹œì‘') && 
                    line.trim().length > 0
                );
                
                // ëª¨ë“  ì°¸ì—¬ìê°€ ì£¼ì‚¬ìœ„ë¥¼ êµ´ë ¸ë‹¤ëŠ” ë©”ì‹œì§€ì¸ì§€ í™•ì¸
                const isAllRolledMessage = chatMessage.message.includes('ëª¨ë“  ì°¸ì—¬ìê°€ ì£¼ì‚¬ìœ„ë¥¼ êµ´ë ¸ìŠµë‹ˆë‹¤');
                
                // ì»¤ìŠ¤í…€ ë£°ì˜ ê²½ìš° ì±„íŒ… ë©”ì‹œì§€ì—ì„œ ë‹¹ì²¨ì ì •ë³´ ì €ì¥
                if (chatMessage.winnerInfo && chatMessage.winnerInfo.winners) {
                    window.gameWinners = chatMessage.winnerInfo.winners;
                }
                
                if (isAllRolledMessage) {
                    // ì „ì—­ í”Œë˜ê·¸ë¡œ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€ (gameStartedì—ì„œ ì´ˆê¸°í™”ë¨)
                    if (window.allRolledMessageShown) {
                        console.log('âš ï¸ [DEBUG] allRolledMessageShown=true, ê²°ê³¼ì°½ í‘œì‹œ ê±´ë„ˆëœ€');
                        return; // ì´ë¯¸ í‘œì‹œë¨
                    }
                    
                    // DOM ì²´í¬ ì œê±° - gameStartedì—ì„œ ì´ì „ ê²°ê³¼ì°½ì„ ì‚­ì œí•˜ë¯€ë¡œ ë¶ˆí•„ìš”
                    // í”Œë˜ê·¸ë§Œìœ¼ë¡œ ì¤‘ë³µ ë°©ì§€
                    
                    // ì „ì—­ í”Œë˜ê·¸ ì„¤ì •
                    window.allRolledMessageShown = true;
                    
                    // ë©”ì‹œì§€ divëŠ” ë¨¼ì € ì¶”ê°€í•˜ë˜ ë‚´ìš©ì€ ë¹„ì›Œë‘ 
                    messageDiv.style.display = 'none'; // ë¨¼ì € ìˆ¨ê¹€
                    chatMessages.appendChild(messageDiv);
                    
                    // ë‹¹ì²¨ì ê³„ì‚° í•¨ìˆ˜ (ì„œë²„ì—ì„œ ë°›ì€ winnerInfo ìš°ì„  ì‚¬ìš©)
                    const calculateWinner = async () => {
                        // ì„œë²„ì—ì„œ ë°›ì€ ê²Œì„ ê¸°ë¡ ì‚¬ìš© (ë§ˆì§€ë§‰ ì‚¬ëŒì˜ ê¸°ë¡ì´ í¬í•¨ë˜ë„ë¡)
                        let currentGameHistory = window.currentGameHistoryFromServer || [];
                        
                        // ì„œë²„ì—ì„œ ë°›ì€ ê¸°ë¡ì´ ì—†ìœ¼ë©´ ë¡œì»¬ historyData ì‚¬ìš© (í•˜ìœ„ í˜¸í™˜ì„±)
                        // gameEnded ì´ë²¤íŠ¸ê°€ ì•„ì§ ë°œìƒí•˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ historyDataë„ í™•ì¸
                        if (currentGameHistory.length === 0) {
                            // historyDataì—ì„œ isGameActive === trueì¸ ê¸°ë¡ë§Œ í•„í„°ë§
                            // ë§ˆì§€ë§‰ ì‚¬ëŒì˜ ê¸°ë¡ë„ í¬í•¨ë˜ë„ë¡ ìµœì‹  ê¸°ë¡ê¹Œì§€ ëª¨ë‘ í¬í•¨
                            currentGameHistory = historyData.filter(record => record.isGameActive === true);
                            
                            // ë§Œì•½ historyDataì—ë„ ê¸°ë¡ì´ ì—†ê±°ë‚˜ ë¶€ì¡±í•˜ë©´ ì ì‹œ ëŒ€ê¸° í›„ ë‹¤ì‹œ ì‹œë„
                            if (currentGameHistory.length === 0) {
                                // gameEnded ì´ë²¤íŠ¸ê°€ ë°œìƒí•  ë•Œê¹Œì§€ ì ì‹œ ëŒ€ê¸° (ìµœëŒ€ 1ì´ˆ)
                                await new Promise(resolve => setTimeout(resolve, 100));
                                currentGameHistory = window.currentGameHistoryFromServer || 
                                                    historyData.filter(record => record.isGameActive === true);
                            }
                        }
                        
                        console.log('[calculateWinner] currentGameHistory:', currentGameHistory);
                        if (currentGameHistory.length === 0) {
                            console.log('[calculateWinner] ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
                            return null;
                        }
                        
                        // ì„œë²„ì—ì„œ ë°›ì€ winnerInfoê°€ ìˆìœ¼ë©´ ì‚¬ìš© (ì»¤ìŠ¤í…€ ë£°ì¸ ê²½ìš°)
                        if (chatMessage.winnerInfo && chatMessage.winnerInfo.winners) {
                            const rulesInput = document.getElementById('gameRulesInput');
                            const gameRules = rulesInput ? rulesInput.value.trim() : '';
                            
                            const winners = chatMessage.winnerInfo.winners;
                            const winnerRecords = currentGameHistory.filter(record => 
                                winners.includes(record.user)
                            );
                            
                            if (winners.length === 1) {
                                const winnerRecord = winnerRecords[0];
                                return { 
                                    type: 'ì»¤ìŠ¤í…€', 
                                    winner: winners[0],
                                    winnerResult: winnerRecord ? winnerRecord.result : null,
                                    gameRules: gameRules,
                                    reason: chatMessage.winnerInfo.reason,
                                    isCustom: true
                                };
                            } else {
                                const winnersWithResults = winners.map(winnerName => {
                                    const record = winnerRecords.find(r => r.user === winnerName);
                                    return {
                                        name: winnerName,
                                        result: record ? record.result : null
                                    };
                                });
                                
                                return { 
                                    type: 'ì»¤ìŠ¤í…€', 
                                    winners: winners,
                                    winnersWithResults: winnersWithResults,
                                    gameRules: gameRules,
                                    reason: chatMessage.winnerInfo.reason,
                                    isTie: true,
                                    isCustom: true
                                };
                            }
                        }
                        
                        // ì„œë²„ì—ì„œ winnerInfoê°€ ì—†ìœ¼ë©´ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ê³„ì‚° (í•˜ì´/ë¡œìš°/ë‹ˆì–´)
                        const rulesInput = document.getElementById('gameRulesInput');
                        if (!rulesInput) {
                            console.log('[calculateWinner] rulesInputì´ ì—†ìŠµë‹ˆë‹¤.');
                            return null;
                        }
                        
                        const gameRules = rulesInput.value.trim();
                        console.log('[calculateWinner] gameRules:', gameRules);
                        if (!gameRules) {
                            console.log('[calculateWinner] gameRulesê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                            return null;
                        }
                        
                        const rulesLower = gameRules.toLowerCase();
                        console.log('[calculateWinner] rulesLower:', rulesLower, 'includes í•˜ì´:', rulesLower.includes('í•˜ì´'), 'includes ë‚®ì€:', rulesLower.includes('ë‚®ì€'));
                        
                        // í•˜ì´ ë£°: ë‚®ì€ ì‚¬ëŒì´ ê±¸ë¦¼
                        if (rulesLower.includes('í•˜ì´') && rulesLower.includes('ë‚®ì€')) {
                            const minResult = Math.min(...currentGameHistory.map(r => r.result));
                            const winners = currentGameHistory.filter(r => r.result === minResult);
                            console.log('[calculateWinner] í•˜ì´ ë£° - minResult:', minResult, 'winners:', winners);
                            if (winners.length >= 1) {
                                if (winners.length === 1) {
                                    return { type: 'í•˜ì´', winner: winners[0].user, result: minResult };
                                } else {
                                    return { type: 'í•˜ì´', winners: winners.map(w => w.user), result: minResult, isTie: true };
                                }
                            }
                        }
                        
                        // ë¡œìš° ë£°: ë†’ì€ ì‚¬ëŒì´ ê±¸ë¦¼
                        if (rulesLower.includes('ë¡œìš°') && rulesLower.includes('ë†’ì€')) {
                            const maxResult = Math.max(...currentGameHistory.map(r => r.result));
                            const winners = currentGameHistory.filter(r => r.result === maxResult);
                            console.log('[calculateWinner] ë¡œìš° ë£° - maxResult:', maxResult, 'winners:', winners);
                            if (winners.length >= 1) {
                                if (winners.length === 1) {
                                    return { type: 'ë¡œìš°', winner: winners[0].user, result: maxResult };
                                } else {
                                    return { type: 'ë¡œìš°', winners: winners.map(w => w.user), result: maxResult, isTie: true };
                                }
                            }
                        }
                        
                        // ë‹ˆì–´ ë£°: íŠ¹ì • ìˆ«ìì— ê°€ê¹Œìš´ ì‚¬ëŒì´ ê±¸ë¦¼
                        const nearMatch = gameRules.match(/ë‹ˆì–´\s*\(?\s*(\d+)\s*\)?/);
                        if (nearMatch) {
                            const targetNumber = parseInt(nearMatch[1]);
                            let minDiff = Infinity;
                            let winners = [];
                            
                            currentGameHistory.forEach(record => {
                                const diff = Math.abs(record.result - targetNumber);
                                if (diff < minDiff) {
                                    minDiff = diff;
                                    winners = [record];
                                } else if (diff === minDiff) {
                                    winners.push(record);
                                }
                            });
                            
                            if (winners.length >= 1) {
                                if (winners.length === 1) {
                                    return { type: 'ë‹ˆì–´', winner: winners[0].user, result: winners[0].result, target: targetNumber };
                                } else {
                                    return { type: 'ë‹ˆì–´', winners: winners.map(w => w.user), result: winners[0].result, target: targetNumber, isTie: true };
                                }
                            }
                        }
                        
                        console.log('[calculateWinner] ë£° ë§¤ì¹­ ì‹¤íŒ¨ - rulesLower:', rulesLower, 'currentGameHistory:', currentGameHistory);
                        return null;
                    };
                    
                    // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ 3ì´ˆ ë’¤ì— ë©”ì‹œì§€ í‘œì‹œ
                    const showMessage = async () => {
                        // ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€ - ì´ë¯¸ ë©”ì‹œì§€ê°€ í‘œì‹œë˜ì—ˆëŠ”ì§€ í™•ì¸
                        if (messageDiv.querySelector('div') && messageDiv.style.display !== 'none') {
                            return; // ì´ë¯¸ í‘œì‹œë¨
                        }
                        
                        // ì „ì—­ í”Œë˜ê·¸ ë‹¤ì‹œ í™•ì¸
                        if (window.allRolledMessageShown && messageDiv.querySelector('div')) {
                            return; // ì´ë¯¸ í‘œì‹œë¨
                        }
                        
                        const titleDiv = document.createElement('div');
                        titleDiv.style.cssText = 'font-size: 18px; font-weight: bold; color: white; margin-bottom: 12px; text-shadow: 0 2px 4px rgba(0,0,0,0.2);';
                        titleDiv.textContent = 'ğŸ‰ ì£¼ì‚¬ìœ„ ë‹¤ êµ´ë ¸ìŠµë‹ˆë‹¤!';
                        messageDiv.appendChild(titleDiv);
                        
                        // gameEnded ì´ë²¤íŠ¸ê°€ ë°œìƒí•  ë•Œê¹Œì§€ ìµœëŒ€ 3ì´ˆ ëŒ€ê¸° (ì„œë²„ì—ì„œ currentGameHistoryë¥¼ ë°›ê¸° ìœ„í•´)
                        let retryCount = 0;
                        let winnerInfo = null;
                        while (retryCount < 30 && !winnerInfo) {
                            // gameEnded ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆëŠ”ì§€ í™•ì¸
                            if (!window.currentGameHistoryFromServer && retryCount < 30) {
                                await new Promise(resolve => setTimeout(resolve, 100));
                                retryCount++;
                                continue;
                            }
                            
                            winnerInfo = await calculateWinner();
                            console.log('[showMessage] calculateWinner ê²°ê³¼:', winnerInfo, 'retryCount:', retryCount, 'currentGameHistoryFromServer:', window.currentGameHistoryFromServer?.length);
                            
                            if (!winnerInfo) {
                                // winnerInfoê°€ nullì´ë©´ ì ì‹œ ëŒ€ê¸° í›„ ì¬ì‹œë„
                                await new Promise(resolve => setTimeout(resolve, 100));
                                retryCount++;
                            } else {
                                break;
                            }
                        }
                        
                        // ë‹¹ì²¨ì ì •ë³´ í‘œì‹œ (ë¹„ë™ê¸° ì²˜ë¦¬)
                        if (winnerInfo) {
                            console.log('[showMessage] ë‹¹ì²¨ì ì •ë³´ í‘œì‹œ:', winnerInfo);
                            const winnerDiv = document.createElement('div');
                            winnerDiv.style.cssText = 'font-size: 16px; font-weight: bold; color: #ffd700; margin-top: 8px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);';
                            
                            if (winnerInfo.error) {
                                // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                                winnerDiv.style.color = '#ff6b6b';
                                winnerDiv.textContent = `âš ï¸ ${winnerInfo.error}`;
                            } else if (winnerInfo.isCustom) {
                                // ì»¤ìŠ¤í…€ ë£° (GPT íŒë‹¨)
                                // ê²Œì„ ë£° ê°€ì ¸ì˜¤ê¸°
                                const rulesInput = document.getElementById('gameRulesInput');
                                const gameRulesText = rulesInput ? rulesInput.value.trim() : '';
                                
                                // ë‘ ë²ˆì§¸ ì¤„: ë£° (GPT íŒë‹¨)
                                const ruleDiv = document.createElement('div');
                                ruleDiv.style.cssText = 'font-size: 16px; font-weight: bold; color: #ffd700; margin-top: 8px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);';
                                ruleDiv.textContent = `${winnerInfo.gameRules || gameRulesText} (GPT íŒë‹¨)`;
                                messageDiv.appendChild(ruleDiv);
                                
                                // ì„¸ ë²ˆì§¸ ì¤„: ë‹¹ì²¨ì ì´ë¦„ê³¼ ìˆ«ì
                                winnerDiv.style.cssText = 'font-size: 16px; font-weight: bold; color: #ffd700; margin-top: 4px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);';
                                if (winnerInfo.isTie) {
                                    // ì—¬ëŸ¬ ëª…ì¸ ê²½ìš°
                                    const winnerText = winnerInfo.winnersWithResults
                                        .map(w => `${w.name} (${w.result})`)
                                        .join(', ');
                                    winnerDiv.textContent = `ë‹¹ì²¨ : ${winnerText}`;
                                } else {
                                    // í•œ ëª…ì¸ ê²½ìš°
                                    winnerDiv.textContent = `ë‹¹ì²¨ : ${winnerInfo.winner} (${winnerInfo.winnerResult})`;
                                }
                            } else if (winnerInfo.isTie) {
                                if (winnerInfo.type === 'í•˜ì´') {
                                    winnerDiv.textContent = `ğŸ† ë‹¹ì²¨: ${winnerInfo.winners.join(', ')} (${winnerInfo.result}, ë™ì )`;
                                } else if (winnerInfo.type === 'ë¡œìš°') {
                                    winnerDiv.textContent = `ğŸ† ë‹¹ì²¨: ${winnerInfo.winners.join(', ')} (${winnerInfo.result}, ë™ì )`;
                                } else if (winnerInfo.type === 'ë‹ˆì–´') {
                                    winnerDiv.textContent = `ğŸ† ë‹¹ì²¨: ${winnerInfo.winners.join(', ')} (${winnerInfo.result}, ${winnerInfo.target}ì— ê°€ì¥ ê°€ê¹Œì›€, ë™ì )`;
                                }
                            } else {
                                if (winnerInfo.type === 'í•˜ì´') {
                                    winnerDiv.textContent = `ğŸ† ë‹¹ì²¨: ${winnerInfo.winner} (${winnerInfo.result})`;
                                } else if (winnerInfo.type === 'ë¡œìš°') {
                                    winnerDiv.textContent = `ğŸ† ë‹¹ì²¨: ${winnerInfo.winner} (${winnerInfo.result})`;
                                } else if (winnerInfo.type === 'ë‹ˆì–´') {
                                    winnerDiv.textContent = `ğŸ† ë‹¹ì²¨: ${winnerInfo.winner} (${winnerInfo.result}, ${winnerInfo.target}ì— ê°€ì¥ ê°€ê¹Œì›€)`;
                                }
                            }
                            
                            messageDiv.appendChild(winnerDiv);
                        } else {
                            // ë‹¹ì²¨ì ì •ë³´ë¥¼ ê³„ì‚°í•  ìˆ˜ ì—†ëŠ” ê²½ìš°
                            console.log('[showMessage] ë‹¹ì²¨ì ì •ë³´ë¥¼ ê³„ì‚°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                            const currentHistory = window.currentGameHistoryFromServer || historyData.filter(r => r.isGameActive === true);
                            const rulesInput = document.getElementById('gameRulesInput');
                            const gameRules = rulesInput ? rulesInput.value.trim() : '';
                            console.log('[showMessage] ë””ë²„ê·¸ ì •ë³´:', {
                                currentHistoryLength: currentHistory.length,
                                currentHistory: currentHistory,
                                gameRules: gameRules,
                                rulesInputExists: !!rulesInput
                            });
                            
                            const errorDiv = document.createElement('div');
                            errorDiv.style.cssText = 'font-size: 14px; color: #ff6b6b; margin-top: 8px;';
                            errorDiv.textContent = 'âš ï¸ ë‹¹ì²¨ì ì •ë³´ë¥¼ ê³„ì‚°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ê¸°ë¡: ' + currentHistory.length + 'ê°œ, ë£°: ' + (gameRules || 'ì—†ìŒ') + ')';
                            messageDiv.appendChild(errorDiv);
                        }
                        
                        messageDiv.style.display = 'block'; // í‘œì‹œ
                        if (forceScroll || isScrolledToBottom) {
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }
                    };
                    
                    // ì „ì—­ waitInterval ê´€ë¦¬ (ì¤‘ë³µ ìƒì„± ë°©ì§€)
                    if (!window.allRolledWaitInterval) {
                        window.allRolledWaitInterval = null;
                    }
                    
                    // ê¸°ì¡´ intervalì´ ìˆìœ¼ë©´ ì •ë¦¬
                    if (window.allRolledWaitInterval) {
                        clearInterval(window.allRolledWaitInterval);
                        window.allRolledWaitInterval = null;
                    }
                    
                    addDebugLog('ğŸ’¬ ì±„íŒ… ë©”ì‹œì§€ í‘œì‹œ ë¡œì§ ì‹œì‘: "ëª¨ë“  ì°¸ì—¬ìê°€ ì£¼ì‚¬ìœ„ë¥¼ êµ´ë ¸ìŠµë‹ˆë‹¤"', 'info');
                    addDebugLog(`ğŸ“Š í˜„ì¬ ì• ë‹ˆë©”ì´ì…˜ ìƒíƒœ: complete=${window.lastRollerAnimationComplete}, time=${window.lastRollerAnimationCompleteTime ? new Date(window.lastRollerAnimationCompleteTime).toLocaleTimeString() : 'null'}`, 'info');
                    
                    const checkAndShow = () => {
                        // ì´ë¯¸ í‘œì‹œë˜ì—ˆëŠ”ì§€ í™•ì¸
                        if (messageDiv.querySelector('div') && messageDiv.style.display !== 'none') {
                            addDebugLog('âœ… ë©”ì‹œì§€ ì´ë¯¸ í‘œì‹œë¨', 'info');
                            return true; // ì´ë¯¸ í‘œì‹œë¨
                        }
                        
                        // ì• ë‹ˆë©”ì´ì…˜ì´ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
                        // ë§ˆì§€ë§‰ ì‚¬ëŒì˜ ì• ë‹ˆë©”ì´ì…˜ì´ ì™„ë£Œë˜ì–´ì•¼ í•¨
                        // ë§ˆì§€ë§‰ ì‚¬ëŒì€ ê³ ì • ì‹œê°„ ì• ë‹ˆë©”ì´ì…˜ì„ ì‚¬ìš©í•˜ë¯€ë¡œ ì™„ë£Œ ì‹œ ì¦‰ì‹œ í‘œì‹œ ê°€ëŠ¥
                        if (window.lastRollerAnimationComplete && window.lastRollerAnimationCompleteTime) {
                            addDebugLog('âœ… ë©”ì‹œì§€ í‘œì‹œ ì¡°ê±´ ë§Œì¡± (ê³ ì • ì‹œê°„ ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ) - showMessage í˜¸ì¶œ', 'info');
                            showMessage();
                            return true;
                        } else {
                            addDebugLog('â³ ë§ˆì§€ë§‰ ì‚¬ëŒì˜ ì• ë‹ˆë©”ì´ì…˜ì´ ì•„ì§ ì™„ë£Œë˜ì§€ ì•ŠìŒ - ëŒ€ê¸° ì¤‘', 'animation');
                        }
                        // ì• ë‹ˆë©”ì´ì…˜ì´ ì•„ì§ ì™„ë£Œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ëŒ€ê¸°
                        return false;
                    };
                    
                    // ì¦‰ì‹œ í™•ì¸ (ì´ë¯¸ ì‹œê°„ì´ ì§€ë‚¬ì„ ìˆ˜ ìˆìŒ)
                    if (!checkAndShow()) {
                        addDebugLog('ğŸ”„ ë©”ì‹œì§€ í‘œì‹œ ëŒ€ê¸° ì‹œì‘', 'info');
                        let checkCount = 0;
                        // ì•„ì§ ì‹œê°„ì´ ì•ˆ ì§€ë‚¬ìœ¼ë©´ ëŒ€ê¸°
                        window.allRolledWaitInterval = setInterval(() => {
                            checkCount++;
                            if (checkCount % 20 === 0) { // 1ì´ˆë§ˆë‹¤ ë¡œê·¸
                                addDebugLog(`ğŸ”„ ë©”ì‹œì§€ í‘œì‹œ ëŒ€ê¸° ì¤‘... (${checkCount * 50}ms ê²½ê³¼)`, 'info');
                            }
                            if (checkAndShow()) {
                                addDebugLog(`âœ… ë©”ì‹œì§€ í‘œì‹œ ì™„ë£Œ - interval ì •ë¦¬ (ì´ ${checkCount}íšŒ ì²´í¬)`, 'info');
                                if (window.allRolledWaitInterval) {
                                    clearInterval(window.allRolledWaitInterval);
                                    window.allRolledWaitInterval = null;
                                }
                            }
                        }, 50);
                        
                        // ìµœëŒ€ 10ì´ˆ ëŒ€ê¸° (ì‚¬ëŒì´ ë§ì„ ë•Œë¥¼ ê³ ë ¤í•˜ì—¬ íƒ€ì„ì•„ì›ƒ ì¦ê°€)
                        setTimeout(() => {
                            addDebugLog('â° ë©”ì‹œì§€ í‘œì‹œ íƒ€ì„ì•„ì›ƒ (10ì´ˆ ê²½ê³¼)', 'warn');
                            if (window.allRolledWaitInterval) {
                                clearInterval(window.allRolledWaitInterval);
                                window.allRolledWaitInterval = null;
                            }
                            // íƒ€ì„ì•„ì›ƒì´ ë°œìƒí•´ë„ ë©”ì‹œì§€ í‘œì‹œ (ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´)
                            if (!messageDiv.querySelector('div') || messageDiv.style.display === 'none') {
                                addDebugLog('âš ï¸ íƒ€ì„ì•„ì›ƒìœ¼ë¡œ ì¸í•œ ê°•ì œ ë©”ì‹œì§€ í‘œì‹œ', 'warn');
                                showMessage();
                            }
                        }, 10000);
                        
                        // ìµœëŒ€ 5ì´ˆ ëŒ€ê¸° í›„ ê°•ì œ í‘œì‹œ
                        setTimeout(() => {
                            if (window.allRolledWaitInterval) {
                                clearInterval(window.allRolledWaitInterval);
                                window.allRolledWaitInterval = null;
                            }
                            // ì´ë¯¸ í‘œì‹œë˜ì§€ ì•Šì•˜ì„ ë•Œë§Œ í‘œì‹œ
                            if (!messageDiv.querySelector('div') || messageDiv.style.display === 'none') {
                                showMessage();
                            }
                        }, 5000);
                    } else {
                        showMessage();
                    }
                    
                    return; // ì—¬ê¸°ì„œ ì¢…ë£Œí•˜ì—¬ ì•„ë˜ ì½”ë“œ ì‹¤í–‰ ë°©ì§€
                } else if (titleLine) {
                    const titleDiv = document.createElement('div');
                    titleDiv.style.cssText = 'font-size: 18px; font-weight: bold; color: white; margin-bottom: 12px; text-shadow: 0 2px 4px rgba(0,0,0,0.2);';
                    titleDiv.textContent = 'ğŸ® ê²Œì„ ì‹œì‘';
                    messageDiv.appendChild(titleDiv);
                }
                
                if (rulesLines.length > 0) {
                    const rulesDiv = document.createElement('div');
                    rulesDiv.style.cssText = 'font-size: 15px; color: #fff; background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px; margin: 8px 0; backdrop-filter: blur(10px); line-height: 1.6; white-space: pre-wrap; word-break: break-word; text-align: center;';
                    // ëª¨ë“  ë£° ì¤„ì„ ì¤„ë°”ê¿ˆìœ¼ë¡œ ì—°ê²°
                    rulesDiv.textContent = rulesLines.map(line => line.trim()).join('\n');
                    messageDiv.appendChild(rulesDiv);
                }
                
                chatMessages.appendChild(messageDiv);
                if (forceScroll || isScrolledToBottom) {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
                return;
            }
            
            // AI ë©”ì‹œì§€ ì²˜ë¦¬
            if (isAI) {
                messageDiv.style.cssText = 'margin: 10px 0; padding: 12px; background: #f0f4f8; border-radius: 12px; border-left: 4px solid #4285f4; box-shadow: 0 2px 4px rgba(0,0,0,0.05);';
                
                const headerDiv = document.createElement('div');
                headerDiv.style.cssText = 'display: flex; align-items: center; margin-bottom: 6px;';
                
                const aiIcon = document.createElement('span');
                aiIcon.textContent = 'âœ¨';
                aiIcon.style.marginRight = '6px';
                
                const userNameSpan = document.createElement('span');
                userNameSpan.style.cssText = 'font-weight: 600; color: #4285f4;';
                userNameSpan.textContent = chatMessage.userName;
                
                headerDiv.appendChild(aiIcon);
                headerDiv.appendChild(userNameSpan);
                messageDiv.appendChild(headerDiv);
                
                const messageSpan = document.createElement('span');
                messageSpan.style.cssText = 'color: #333; line-height: 1.5; white-space: pre-wrap; word-break: break-all;';
                messageSpan.textContent = chatMessage.message;
                messageDiv.appendChild(messageSpan);
                
                const timeSpan = document.createElement('div');
                timeSpan.style.cssText = 'font-size: 11px; color: #999; margin-top: 6px; text-align: right;';
                timeSpan.textContent = chatMessage.time;
                messageDiv.appendChild(timeSpan);
                
                chatMessages.appendChild(messageDiv);
                if (forceScroll || isScrolledToBottom) {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
                return;
            }

            // ì¼ë°˜ ë©”ì‹œì§€ëŠ” ì™¼ìª½ ì •ë ¬
            messageDiv.style.cssText = 'margin-bottom: 10px; padding: 8px; background: white; border-radius: 6px; border-left: 3px solid #667eea;';
            
            // /ì£¼ì‚¬ìœ„ ëª…ë ¹ì–´ì¸ ê²½ìš° ë‚˜ì¤‘ì— ê²°ê³¼ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆë„ë¡ í‘œì‹œ
            if (isDiceCommand) {
                messageDiv.setAttribute('data-dice-command', 'true');
                messageDiv.setAttribute('data-user-name', chatMessage.userName);
                // /ì£¼ì‚¬ìœ„ ëª…ë ¹ì–´ëŠ” ì²« ì¤„ì„ flexë¡œ ë§Œë“¤ì–´ì„œ ê²°ê³¼ë¥¼ ì˜¤ë¥¸ìª½ ëìœ¼ë¡œ ì •ë ¬
                messageDiv.style.cssText = 'margin-bottom: 10px; padding: 8px; background: white; border-radius: 6px; border-left: 3px solid #667eea; display: flex; flex-direction: column;';
                const firstLineDiv = document.createElement('div');
                firstLineDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; width: 100%;';
                messageDiv.appendChild(firstLineDiv);
                
                const leftContentSpan = document.createElement('span');
                leftContentSpan.style.cssText = 'display: flex; align-items: center;';
                
                const userNameSpan = document.createElement('span');
                userNameSpan.style.cssText = 'font-weight: 600; color: #667eea; margin-right: 8px;';
                userNameSpan.setAttribute('data-user-name-display', chatMessage.userName);
                // ë””ë°”ì´ìŠ¤ ì•„ì´ì½˜ ì¶”ê°€
                let userNameText = chatMessage.isHost ? `ğŸ‘‘ ${chatMessage.userName}` : chatMessage.userName;
                if (chatMessage.deviceType) {
                    const deviceIcon = getDeviceIcon(chatMessage.deviceType);
                    if (chatMessage.isHost) {
                        userNameText = `ğŸ‘‘ ${deviceIcon} ${chatMessage.userName}`;
                    } else {
                        userNameText = `${deviceIcon} ${chatMessage.userName}`;
                    }
                }
                userNameSpan.textContent = userNameText;
                if (chatMessage.userName === currentUser) {
                    userNameSpan.textContent += ' (ë‚˜)';
                    userNameSpan.style.color = '#764ba2';
                }
                
                const messageSpan = document.createElement('span');
                messageSpan.style.color = '#333';
                messageSpan.textContent = chatMessage.message;
                messageSpan.setAttribute('data-dice-message', 'true');
                
                leftContentSpan.appendChild(userNameSpan);
                leftContentSpan.appendChild(messageSpan);
                firstLineDiv.appendChild(leftContentSpan);
                
                // ì˜¤ë¥¸ìª½ì— ì£¼ì‚¬ìœ„ ê²°ê³¼ë¥¼ ë„£ì„ ê³µê°„ì„ ë¯¸ë¦¬ ì¤€ë¹„ (ë‚˜ì¤‘ì— ì±„ì›Œì§)
                const rightContentSpan = document.createElement('span');
                rightContentSpan.setAttribute('data-dice-result-container', 'true');
                rightContentSpan.style.cssText = 'min-width: 60px;';
                firstLineDiv.appendChild(rightContentSpan);
                
                // ì±„íŒ… ê¸°ë¡ì—ì„œ ë¶ˆëŸ¬ì˜¨ ê²½ìš° ì£¼ì‚¬ìœ„ ê²°ê³¼ê°€ ìˆìœ¼ë©´ í‘œì‹œ
                if (chatMessage.diceResult) {
                    const diceResultSpan = document.createElement('span');
                    diceResultSpan.setAttribute('data-dice-result', 'true');
                    diceResultSpan.style.cssText = 'font-weight: 600; color: #333;';
                    
                    // isNotReadyì¸ ê²½ìš° ì•„ì´ì½˜ ì—†ì´ ìˆ«ìë§Œ í‘œì‹œ
                    const diceIcon = chatMessage.diceResult.isNotReady ? '' : 'ğŸ² ';
                    diceResultSpan.textContent = diceIcon + chatMessage.diceResult.result;
                    
                    rightContentSpan.appendChild(diceResultSpan);
                }
                
                // íƒ€ì„ìŠ¤íƒ¬í”„ì™€ ì´ëª¨í‹°ì½˜ì„ ê°™ì€ ì¤„ì— í‘œì‹œí•˜ê¸° ìœ„í•œ ì»¨í…Œì´ë„ˆ
                const timeReactionsContainer = document.createElement('span');
                timeReactionsContainer.className = 'time-reactions-container';
                timeReactionsContainer.style.cssText = 'display: inline-flex; align-items: center; gap: 6px; margin-top: 4px;';
                
                const timeSpan = document.createElement('span');
                timeSpan.style.cssText = 'font-size: 11px; color: #999;';
                timeSpan.textContent = chatMessage.time;
                
                timeReactionsContainer.appendChild(timeSpan);
                
                // ë°˜ì‘ì´ ìˆëŠ” ì´ëª¨í‹°ì½˜ í‘œì‹œ ì˜ì—­ (í•­ìƒ í‘œì‹œ)
                const activeReactionsDiv = document.createElement('span');
                activeReactionsDiv.className = 'active-reactions';
                activeReactionsDiv.style.cssText = 'display: inline-flex; align-items: center; gap: 4px;';
                
                // í˜¸ë²„ ì‹œ ë‚˜íƒ€ë‚˜ëŠ” ì´ëª¨í‹°ì½˜ ë²„íŠ¼ë“¤ (ê¸°ë³¸ ìˆ¨ê¹€)
                const hoverReactionsDiv = document.createElement('span');
                hoverReactionsDiv.className = 'hover-reactions';
                hoverReactionsDiv.style.cssText = 'display: inline-flex; align-items: center; gap: 4px; opacity: 0; transition: opacity 0.2s; pointer-events: none;';
                
                // ì´ëª¨í‹°ì½˜ ì„¤ì • (ì „ì—­ ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°)
                const defaultEmojis = Object.keys(emojiConfig);
                
                // ë°˜ì‘ì´ ìˆëŠ” ì´ëª¨í‹°ì½˜ í‘œì‹œ
                if (chatMessage.reactions && Object.keys(chatMessage.reactions).length > 0) {
                    Object.entries(chatMessage.reactions).forEach(([emoji, users]) => {
                        if (users.length > 0 && defaultEmojis.includes(emoji)) {
                            const reactionBtn = document.createElement('button');
                            reactionBtn.className = 'reaction-button active';
                            
                            const hasReacted = users.includes(currentUser);
                            
                            reactionBtn.style.cssText = `
                                height: 20px;
                                border-radius: 10px;
                                background: ${hasReacted ? '#333' : '#555'};
                                border: none;
                                color: #ffffff !important;
                                font-size: 12px;
                                cursor: pointer;
                                display: inline-flex;
                                align-items: center;
                                justify-content: center;
                                padding: 0 6px;
                                gap: 4px;
                                transition: all 0.2s;
                                vertical-align: middle;
                                line-height: 1;
                            `;
                            
                            const emojiSpan = document.createElement('span');
                            emojiSpan.textContent = emoji;
                            emojiSpan.style.cssText = 'font-size: 12px; line-height: 1;';
                            
                            const countSpan = document.createElement('span');
                            countSpan.textContent = users.length;
                            countSpan.style.cssText = 'font-size: 12px; color: #ffffff !important; font-weight: 600; line-height: 1; display: inline-block;';
                            
                            reactionBtn.appendChild(emojiSpan);
                            reactionBtn.appendChild(countSpan);
                            reactionBtn.title = emojiConfig[emoji] || emoji;
                            
                            reactionBtn.onclick = () => {
                                const messageIndex = parseInt(messageDiv.dataset.messageIndex);
                                socket.emit('toggleReaction', { messageIndex, emoji });
                            };
                            
                            activeReactionsDiv.appendChild(reactionBtn);
                        }
                    });
                }
                
                // í˜¸ë²„ ì‹œ ë‚˜íƒ€ë‚˜ëŠ” ì´ëª¨í‹°ì½˜ ë²„íŠ¼ë“¤
                defaultEmojis.forEach(emoji => {
                    // ì´ë¯¸ ë°˜ì‘ì´ ìˆëŠ” ì´ëª¨í‹°ì½˜ì€ í˜¸ë²„ ë²„íŠ¼ì— í‘œì‹œí•˜ì§€ ì•ŠìŒ
                    const hasReaction = chatMessage.reactions && 
                                      chatMessage.reactions[emoji] && 
                                      chatMessage.reactions[emoji].length > 0;
                    if (hasReaction) return;
                    
                    const reactionBtn = document.createElement('button');
                    reactionBtn.className = 'reaction-button hover';
                    
                    reactionBtn.style.cssText = `
                        width: 16px;
                        height: 16px;
                        border-radius: 50%;
                        background: #000;
                        border: 1px solid #333;
                        color: white;
                        font-size: 10px;
                        cursor: pointer;
                        display: inline-flex;
                        align-items: center;
                        justify-content: center;
                        padding: 0;
                        transition: all 0.2s;
                        vertical-align: middle;
                    `;
                    
                    reactionBtn.textContent = emoji;
                    reactionBtn.title = emojiConfig[emoji] || emoji;
                    
                    reactionBtn.onclick = () => {
                        const messageIndex = parseInt(messageDiv.dataset.messageIndex);
                        socket.emit('toggleReaction', { messageIndex, emoji });
                    };
                    
                    hoverReactionsDiv.appendChild(reactionBtn);
                });
                
                timeReactionsContainer.appendChild(activeReactionsDiv);
                timeReactionsContainer.appendChild(hoverReactionsDiv);
                
                messageDiv.appendChild(timeReactionsContainer);
                
                // ë©”ì‹œì§€ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ í˜¸ë²„ ì´ëª¨í‹°ì½˜ í‘œì‹œ
                messageDiv.onmouseenter = () => {
                    hoverReactionsDiv.style.opacity = '0.7';
                    hoverReactionsDiv.style.pointerEvents = 'auto';
                };
                messageDiv.onmouseleave = () => {
                    hoverReactionsDiv.style.opacity = '0';
                    hoverReactionsDiv.style.pointerEvents = 'none';
                };
            } else {
                // ì¼ë°˜ ë©”ì‹œì§€ëŠ” ì™¼ìª½ ì •ë ¬
                const userNameSpan = document.createElement('span');
                userNameSpan.style.cssText = 'font-weight: 600; color: #667eea; margin-right: 8px;';
                // ë””ë°”ì´ìŠ¤ ì•„ì´ì½˜ ì¶”ê°€
                let userNameText = chatMessage.isHost ? `ğŸ‘‘ ${chatMessage.userName}` : chatMessage.userName;
                if (chatMessage.deviceType) {
                    const deviceIcon = getDeviceIcon(chatMessage.deviceType);
                    if (chatMessage.isHost) {
                        userNameText = `ğŸ‘‘ ${deviceIcon} ${chatMessage.userName}`;
                    } else {
                        userNameText = `${deviceIcon} ${chatMessage.userName}`;
                    }
                }
                userNameSpan.textContent = userNameText;
                if (chatMessage.userName === currentUser) {
                    userNameSpan.textContent += ' (ë‚˜)';
                    userNameSpan.style.color = '#764ba2';
                }
                
                const messageSpan = document.createElement('span');
                messageSpan.style.color = '#333';
                messageSpan.textContent = chatMessage.message;
                
                const timeSpan = document.createElement('span');
                timeSpan.style.cssText = 'font-size: 11px; color: #999; margin-left: 8px;';
                timeSpan.textContent = chatMessage.time;
                
                messageDiv.appendChild(userNameSpan);
                messageDiv.appendChild(messageSpan);
                messageDiv.appendChild(document.createElement('br'));
                
                // íƒ€ì„ìŠ¤íƒ¬í”„ì™€ ì´ëª¨í‹°ì½˜ì„ ê°™ì€ ì¤„ì— í‘œì‹œí•˜ê¸° ìœ„í•œ ì»¨í…Œì´ë„ˆ
                const timeReactionsContainer = document.createElement('span');
                timeReactionsContainer.className = 'time-reactions-container';
                timeReactionsContainer.style.cssText = 'display: inline-flex; align-items: center; gap: 6px;';
                
                timeReactionsContainer.appendChild(timeSpan);
                
                // ë°˜ì‘ì´ ìˆëŠ” ì´ëª¨í‹°ì½˜ í‘œì‹œ ì˜ì—­ (í•­ìƒ í‘œì‹œ)
                const activeReactionsDiv = document.createElement('span');
                activeReactionsDiv.className = 'active-reactions';
                activeReactionsDiv.style.cssText = 'display: inline-flex; align-items: center; gap: 4px;';
                
                // í˜¸ë²„ ì‹œ ë‚˜íƒ€ë‚˜ëŠ” ì´ëª¨í‹°ì½˜ ë²„íŠ¼ë“¤ (ê¸°ë³¸ ìˆ¨ê¹€)
                const hoverReactionsDiv = document.createElement('span');
                hoverReactionsDiv.className = 'hover-reactions';
                hoverReactionsDiv.style.cssText = 'display: inline-flex; align-items: center; gap: 4px; opacity: 0; transition: opacity 0.2s; pointer-events: none;';
                
                // ì´ëª¨í‹°ì½˜ ì„¤ì • (ì „ì—­ ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°)
                const defaultEmojis = Object.keys(emojiConfig);
                
                // ë°˜ì‘ì´ ìˆëŠ” ì´ëª¨í‹°ì½˜ í‘œì‹œ
                if (chatMessage.reactions && Object.keys(chatMessage.reactions).length > 0) {
                    Object.entries(chatMessage.reactions).forEach(([emoji, users]) => {
                        if (users.length > 0 && defaultEmojis.includes(emoji)) {
                            const reactionBtn = document.createElement('button');
                            reactionBtn.className = 'reaction-button active';
                            
                            const hasReacted = users.includes(currentUser);
                            
                            reactionBtn.style.cssText = `
                                height: 20px;
                                border-radius: 10px;
                                background: ${hasReacted ? '#333' : '#555'};
                                border: none;
                                color: #ffffff !important;
                                font-size: 12px;
                                cursor: pointer;
                                display: inline-flex;
                                align-items: center;
                                justify-content: center;
                                padding: 0 6px;
                                gap: 4px;
                                transition: all 0.2s;
                                vertical-align: middle;
                                line-height: 1;
                            `;
                            
                            const emojiSpan = document.createElement('span');
                            emojiSpan.textContent = emoji;
                            emojiSpan.style.cssText = 'font-size: 12px; line-height: 1;';
                            
                            const countSpan = document.createElement('span');
                            countSpan.textContent = users.length;
                            countSpan.style.cssText = 'font-size: 12px; color: #ffffff !important; font-weight: 600; line-height: 1; display: inline-block;';
                            
                            reactionBtn.appendChild(emojiSpan);
                            reactionBtn.appendChild(countSpan);
                            reactionBtn.title = emojiConfig[emoji] || emoji;
                            
                            reactionBtn.onclick = () => {
                                const messageIndex = parseInt(messageDiv.dataset.messageIndex);
                                socket.emit('toggleReaction', { messageIndex, emoji });
                            };
                            
                            activeReactionsDiv.appendChild(reactionBtn);
                        }
                    });
                }
                
                // í˜¸ë²„ ì‹œ ë‚˜íƒ€ë‚˜ëŠ” ì´ëª¨í‹°ì½˜ ë²„íŠ¼ë“¤
                defaultEmojis.forEach(emoji => {
                    // ì´ë¯¸ ë°˜ì‘ì´ ìˆëŠ” ì´ëª¨í‹°ì½˜ì€ í˜¸ë²„ ë²„íŠ¼ì— í‘œì‹œí•˜ì§€ ì•ŠìŒ
                    const hasReaction = chatMessage.reactions && 
                                      chatMessage.reactions[emoji] && 
                                      chatMessage.reactions[emoji].length > 0;
                    if (hasReaction) return;
                    
                    const reactionBtn = document.createElement('button');
                    reactionBtn.className = 'reaction-button hover';
                    
                    reactionBtn.style.cssText = `
                        width: 16px;
                        height: 16px;
                        border-radius: 50%;
                        background: #000;
                        border: 1px solid #333;
                        color: white;
                        font-size: 10px;
                        cursor: pointer;
                        display: inline-flex;
                        align-items: center;
                        justify-content: center;
                        padding: 0;
                        transition: all 0.2s;
                        vertical-align: middle;
                    `;
                    
                    reactionBtn.textContent = emoji;
                    reactionBtn.title = emojiConfig[emoji] || emoji;
                    
                    reactionBtn.onclick = () => {
                        const messageIndex = parseInt(messageDiv.dataset.messageIndex);
                        socket.emit('toggleReaction', { messageIndex, emoji });
                    };
                    
                    hoverReactionsDiv.appendChild(reactionBtn);
                });
                
                timeReactionsContainer.appendChild(activeReactionsDiv);
                timeReactionsContainer.appendChild(hoverReactionsDiv);
                
                messageDiv.appendChild(timeReactionsContainer);
                
                // ë©”ì‹œì§€ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ í˜¸ë²„ ì´ëª¨í‹°ì½˜ í‘œì‹œ
                messageDiv.onmouseenter = () => {
                    hoverReactionsDiv.style.opacity = '0.7';
                    hoverReactionsDiv.style.pointerEvents = 'auto';
                };
                messageDiv.onmouseleave = () => {
                    hoverReactionsDiv.style.opacity = '0';
                    hoverReactionsDiv.style.pointerEvents = 'none';
                };
            }
            
            // reactions í•„ë“œ ì´ˆê¸°í™”
            if (!chatMessage.reactions) {
                chatMessage.reactions = {};
            }
            
            // í´ë¼ì´ì–¸íŠ¸ ì±„íŒ… ê¸°ë¡ì— ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
            let messageIndex = clientChatHistory.findIndex(msg => 
                msg.userName === chatMessage.userName && 
                msg.message === chatMessage.message && 
                msg.time === chatMessage.time
            );
            
            if (messageIndex === -1) {
                messageIndex = clientChatHistory.length;
                clientChatHistory.push(chatMessage);
            } else {
                // ê¸°ì¡´ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸ (reactions í¬í•¨)
                clientChatHistory[messageIndex] = chatMessage;
            }
            
            messageDiv.dataset.messageIndex = messageIndex;
            
            chatMessages.appendChild(messageDiv);
            
            // ìŠ¤í¬ë¡¤ì´ ë§¨ ì•„ë˜ì— ìˆê±°ë‚˜ ê°•ì œ ìŠ¤í¬ë¡¤ì´ë©´ ìŠ¤í¬ë¡¤
            if (forceScroll || isScrolledToBottom) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }
        
        // ì±„íŒ… ë©”ì‹œì§€ ìˆ˜ì‹ , ì´ëª¨í‹°ì½˜ ë°˜ì‘, ì—ëŸ¬ ì²˜ë¦¬ëŠ” ChatModuleì—ì„œ ì²˜ë¦¬ (initChatModuleì—ì„œ ë°”ì¸ë”©)

        function updateHostCheckbox(users) {
            const hostCheckbox = document.getElementById('hostCheckbox');
            
            // hostCheckbox ìš”ì†Œê°€ ì—†ìœ¼ë©´ í•¨ìˆ˜ ì¢…ë£Œ (ë¡œë¹„ í™”ë©´ì´ ì•„ë‹ ìˆ˜ ìˆìŒ)
            if (!hostCheckbox) {
                return;
            }
            
            const hasHost = users.some(user => user.isHost === true);
            
            if (hasHost) {
                hostCheckbox.disabled = true;
                hostCheckbox.checked = false;
                const label = document.querySelector('label[for="hostCheckbox"]');
                if (label) {
                    label.textContent = 'Hostë¡œ ì…ì¥ (ì´ë¯¸ í˜¸ìŠ¤íŠ¸ê°€ ìˆìŠµë‹ˆë‹¤)';
                    label.style.color = '#999';
                }
            } else {
                hostCheckbox.disabled = false;
                const label = document.querySelector('label[for="hostCheckbox"]');
                if (label) {
                    label.textContent = 'Hostë¡œ ì…ì¥';
                    label.style.color = '';
                }
            }
        }

        function updateProgress(progress) {
            const { rolled, total, notRolledYet } = progress;
            const percentage = total > 0 ? (rolled / total) * 100 : 0;
            
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percentage + '%';
            progressBar.textContent = Math.round(percentage) + '%';
            
            document.getElementById('progressCount').textContent = `${rolled}/${total}`;
            
            const notRolledSection = document.getElementById('notRolledSection');
            const notRolledList = document.getElementById('notRolledList');
            
            if (notRolledYet.length === 0) {
                notRolledSection.style.display = 'none';
            } else {
                notRolledSection.style.display = 'block';
                notRolledList.innerHTML = '';
                // ê°€ë‚˜ë‹¤ìˆœìœ¼ë¡œ ì •ë ¬
                const sortedNotRolledYet = [...notRolledYet].sort((a, b) => a.localeCompare(b, 'ko'));
                sortedNotRolledYet.forEach(name => {
                    const tag = document.createElement('div');
                    tag.className = 'not-rolled-tag';
                    tag.textContent = name;
                    if (name === currentUser) {
                        tag.textContent += ' (ë‚˜)';
                    }
                    notRolledList.appendChild(tag);
                });
            }
        }

        // íˆìŠ¤í† ë¦¬ ì •ë ¬ í•¨ìˆ˜
        function sortHistoryData(data, mode) {
            if (data.length === 0) return { sorted: [], topPlayerKeys: new Set() };
            
            const sorted = [...data];
            
            // ê²Œì„ ì§„í–‰ ì¤‘ì¼ ë•Œ ìœ ë ¥í•œ ì‚¬ëŒ, ê²Œì„ ì¢…ë£Œ í›„ ë‹¹ì²¨ì ìƒë‹¨ í‘œì‹œ (ì •ë ¬ ì „ì— ì°¾ê¸°)
            let topPlayerKeys = new Set(); // ìœ ë ¥í•œ ì‚¬ëŒë“¤ì˜ ê³ ìœ  í‚¤ (ë™ì ì¼ ìˆ˜ ìˆìŒ)
            
            // ê²Œì„ ì§„í–‰ ì¤‘: ìœ ë ¥í•œ ì‚¬ëŒ ì°¾ê¸°
            if (isGameActive && gamePlayers.length > 0 && sorted.length > 0) {
                const rulesInput = document.getElementById('gameRulesInput');
                const gameRules = rulesInput ? rulesInput.value.trim().toLowerCase() : '';
                
                // í•˜ì´ ë£°: ê°€ì¥ ë‚®ì€ ì‚¬ëŒì´ ìœ ë ¥
                if (gameRules.includes('í•˜ì´') && gameRules.includes('ë‚®ì€')) {
                    const minResult = Math.min(...sorted.map(r => r.result));
                    sorted.forEach(r => {
                        if (r.result === minResult) {
                            topPlayerKeys.add(`${r.user}-${r.result}-${r.time}`);
                        }
                    });
                }
                // ë¡œìš° ë£°: ê°€ì¥ ë†’ì€ ì‚¬ëŒì´ ìœ ë ¥
                else if (gameRules.includes('ë¡œìš°') && gameRules.includes('ë†’ì€')) {
                    const maxResult = Math.max(...sorted.map(r => r.result));
                    sorted.forEach(r => {
                        if (r.result === maxResult) {
                            topPlayerKeys.add(`${r.user}-${r.result}-${r.time}`);
                        }
                    });
                }
                // ë‹ˆì–´ ë£°: íƒ€ê²Ÿ ìˆ«ìì— ê°€ì¥ ê°€ê¹Œìš´ ì‚¬ëŒì´ ìœ ë ¥
                else if (gameRules.includes('ë‹ˆì–´')) {
                    const nearMatch = gameRules.match(/ë‹ˆì–´\s*(\d+)/);
                    if (nearMatch) {
                        const targetNumber = parseInt(nearMatch[1]);
                        let minDiff = Infinity;
                        sorted.forEach(record => {
                            const diff = Math.abs(record.result - targetNumber);
                            if (diff < minDiff) {
                                minDiff = diff;
                            }
                        });
                        sorted.forEach(r => {
                            if (Math.abs(r.result - targetNumber) === minDiff) {
                                topPlayerKeys.add(`${r.user}-${r.result}-${r.time}`);
                            }
                        });
                    }
                }
            }
            
            // ê²Œì„ ì¢…ë£Œ í›„: ë‹¹ì²¨ìë„ ìƒë‹¨ìœ¼ë¡œ ì˜¬ë¦¬ê¸°
            if (!isGameActive && window.gameWinners && window.gameWinners.length > 0 && sorted.length > 0) {
                sorted.forEach(r => {
                    if (window.gameWinners.includes(r.user)) {
                        topPlayerKeys.add(`${r.user}-${r.result}-${r.time}`);
                    }
                });
            }
            
            // ì •ë ¬ ìˆ˜í–‰
            if (mode === 'asc') {
                sorted.sort((a, b) => a.result - b.result);
            } else if (mode === 'desc') {
                sorted.sort((a, b) => b.result - a.result);
            } else if (mode === 'time') {
                sorted.reverse();
            }
            
            // ìœ ë ¥í•œ ì‚¬ëŒë“¤ì´ ìˆìœ¼ë©´ ë§¨ ìœ„ë¡œ ì´ë™
            if (topPlayerKeys.size > 0) {
                // ìœ ë ¥í•œ ì‚¬ëŒë“¤ì„ ë°°ì—´ì—ì„œ ì œê±°
                const topPlayerRecords = [];
                for (let i = sorted.length - 1; i >= 0; i--) {
                    const record = sorted[i];
                    const recordKey = `${record.user}-${record.result}-${record.time}`;
                    if (topPlayerKeys.has(recordKey)) {
                        topPlayerRecords.push(sorted.splice(i, 1)[0]);
                    }
                }
                
                // ìœ ë ¥í•œ ì‚¬ëŒë“¤ì„ ë§¨ ì•ì— ì¶”ê°€ (ê°€ë‚˜ë‹¤ìˆœ ì •ë ¬)
                if (topPlayerRecords.length > 0) {
                    topPlayerRecords.sort((a, b) => a.user.localeCompare(b.user, 'ko'));
                    sorted.unshift(...topPlayerRecords);
                }
            }
            
            return { sorted, topPlayerKeys };
        }

        // ì •ë ¬ ë²„íŠ¼ í´ë¦­
        function sortHistory(mode) {
            currentSortMode = mode;
            
            document.querySelectorAll('.sort-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (mode === 'time') {
                document.getElementById('sortTimeBtn').classList.add('active');
            } else if (mode === 'asc') {
                document.getElementById('sortAscBtn').classList.add('active');
            } else if (mode === 'desc') {
                document.getElementById('sortDescBtn').classList.add('active');
            }
            
            renderHistory();
        }

        // êµ´ë¦° ì¸ì› ì—…ë°ì´íŠ¸
        function updateRolledUsersCount() {
            const rolledUsersCountElement = document.getElementById('rolledUsersCount');
            if (!rolledUsersCountElement) return;
            
            let count = 0;
            if (isGameActive) {
                // ê²Œì„ ì§„í–‰ ì¤‘ì¼ ë•ŒëŠ” ê²Œì„ ì¤‘ êµ´ë¦° ì‚¬ìš©ì ìˆ˜ í‘œì‹œ
                count = rolledUsersInGame.length;
            } else {
                // ê²Œì„ ì§„í–‰ ì¤‘ì´ ì•„ë‹ ë•ŒëŠ” ì „ì²´ ê¸°ë¡ ìˆ˜ í‘œì‹œ
                count = historyData.length;
            }
            
            rolledUsersCountElement.textContent = count;
        }

        // íˆìŠ¤í† ë¦¬ ë Œë”ë§
        function renderHistory() {
            const historyList = document.getElementById('historyList');
            
            // ê²Œì„ ì§„í–‰ ì¤‘ì¼ ë•ŒëŠ” í˜„ì¬ ê²Œì„ì˜ ê¸°ë¡ë§Œ í•„í„°ë§í•´ì„œ í‘œì‹œ
            let displayData = historyData;
            if (isGameActive && gamePlayers.length > 0) {
                // í˜„ì¬ ê²Œì„ì˜ ì°¸ì—¬ìê°€ êµ´ë¦° ê¸°ë¡ë§Œ í•„í„°ë§ (ì—°ìŠµ ê¸°ë¡ ì œì™¸)
                displayData = historyData.filter(record => {
                    // ê²Œì„ ì§„í–‰ ì¤‘ì¼ ë•Œ êµ´ë¦° ì£¼ì‚¬ìœ„ì´ê³ , í˜„ì¬ ê²Œì„ ì°¸ì—¬ìì¸ ê²½ìš°ë§Œ í‘œì‹œ
                    // isGameActive === falseì¸ ì—°ìŠµ ê¸°ë¡ì€ ì œì™¸
                    return record.isGameActive === true && gamePlayers.includes(record.user);
                });
            } else if (!isGameActive) {
                // ê²Œì„ ì§„í–‰ ì¤‘ì´ ì•„ë‹ ë•Œ
                const hasGameEndedBefore = historyData.some(r => r.isGameActive === true);
                if (hasGameEndedBefore) {
                    // ê²Œì„ì´ í•œ ë²ˆì´ë¼ë„ ì¢…ë£Œëœ ì ì´ ìˆìœ¼ë©´ ê²Œì„ ê¸°ë¡ë§Œ í‘œì‹œ (ì—°ìŠµ ê¸°ë¡ ì œì™¸)
                    displayData = historyData.filter(record => {
                        return record.isGameActive === true;
                    });
                } else {
                    // ê²Œì„ì´ í•œ ë²ˆë„ ì‹œì‘ë˜ì§€ ì•Šì•˜ê±°ë‚˜, ê²Œì„ ë°ì´í„°ê°€ ì‚­ì œëœ ê²½ìš°ì—ë§Œ ì—°ìŠµ ê¸°ë¡ í‘œì‹œ
                    displayData = historyData.filter(record => {
                        return record.isGameActive === false;
                    });
                }
            }
            
            if (displayData.length === 0) {
                historyList.innerHTML = '<div class="empty-history">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                updateRolledUsersCount();
                return;
            }
            
            const { sorted: sortedData, topPlayerKeys } = sortHistoryData(displayData, currentSortMode);
            
            historyList.innerHTML = '';
            
            sortedData.forEach(record => {
                const recordKey = `${record.user}-${record.result}-${record.time}`;
                const isTopPlayer = topPlayerKeys.has(recordKey);
                const isNewTopPlayer = isTopPlayer && isGameActive && !lastTopPlayerKeys.has(recordKey);
                
                // ê²Œì„ì´ ì¢…ë£Œëœ ìƒíƒœì´ê³  ë‹¹ì²¨ìê°€ ìˆìœ¼ë©´ ë‹¹ì²¨ ë°°ì§€ í‘œì‹œ, ì•„ë‹ˆë©´ ìœ ë ¥ ë°°ì§€ í‘œì‹œ
                let badgeHtml = '';
                if (!isGameActive && window.gameWinners && window.gameWinners.includes(record.user)) {
                    // ê²Œì„ ì¢…ë£Œ í›„ ë‹¹ì²¨ìì—ê²ŒëŠ” ì´ˆë¡ìƒ‰ "ë‹¹ì²¨" ë°°ì§€
                    badgeHtml = '<span class="winner-badge">ë‹¹ì²¨</span>';
                } else if (isTopPlayer && isGameActive) {
                    // ê²Œì„ ì§„í–‰ ì¤‘ ìœ ë ¥í•œ í›„ë³´ì—ê²ŒëŠ” ë¹¨ê°„ìƒ‰ "ìœ ë ¥" ë°°ì§€
                    badgeHtml = '<span class="top-player-badge">ìœ ë ¥</span>';
                }
                
                const item = document.createElement('div');
                item.className = 'history-item';
                
                // ìƒˆë¡œ ìœ ë ¥í•´ì§„ ì‚¬ëŒì—ê²Œ ì• ë‹ˆë©”ì´ì…˜ ì ìš©
                if (isNewTopPlayer) {
                    item.classList.add('top-player-new');
                }
                
                // ë‹¹ì²¨ì ì²´í¬ ë° ì™¸ê³½ì„  ì• ë‹ˆë©”ì´ì…˜ ì ìš©
                const isWinner = !isGameActive && window.gameWinners && window.gameWinners.includes(record.user);
                const isNewWinner = isWinner && !lastWinnerKeys.has(recordKey);
                
                if (isNewWinner) {
                    item.classList.add('winner-glow');
                } else if (isWinner) {
                    // ì´ë¯¸ ë‹¹ì²¨ìì˜€ë˜ ê²½ìš°ì—ë„ ê³„ì† ì• ë‹ˆë©”ì´ì…˜ ìœ ì§€
                    item.classList.add('winner-glow');
                }
                
                item.innerHTML = `
                    <div>
                        <div class="history-user">${record.user}${badgeHtml}</div>
                        <div class="history-range">${record.range ? (record.range.includes('~') ? record.range.split('~')[1] : record.range) : '100'}</div>
                        <div class="history-time">${record.time}</div>
                    </div>
                    <div class="history-result">ğŸ² ${record.result}</div>
                `;
                historyList.appendChild(item);
            });
            
            // í˜„ì¬ ìœ ë ¥í•œ ì‚¬ëŒë“¤ì„ ì €ì¥ (ë‹¤ìŒ ë Œë”ë§ì—ì„œ ë¹„êµìš©)
            lastTopPlayerKeys = new Set(topPlayerKeys);
            
            // í˜„ì¬ ë‹¹ì²¨ìë“¤ì„ ì €ì¥ (ë‹¤ìŒ ë Œë”ë§ì—ì„œ ë¹„êµìš©)
            if (!isGameActive && window.gameWinners && window.gameWinners.length > 0) {
                const currentWinnerKeys = new Set();
                sortedData.forEach(record => {
                    const recordKey = `${record.user}-${record.result}-${record.time}`;
                    if (window.gameWinners.includes(record.user)) {
                        currentWinnerKeys.add(recordKey);
                    }
                });
                lastWinnerKeys = currentWinnerKeys;
            } else {
                lastWinnerKeys = new Set();
            }
            
            updateRolledUsersCount();
        }
    </script>
    <hr>
    <footer style="text-align: center; padding: 20px 0; font-size: 0.9em; color: #555;">
        <p>Copyright Â© 2025 LAMDice. All rights reserved.</p>
        <div style="margin-top: 10px;">
            <a href="privacy-policy.html" style="margin: 0 10px; text-decoration: none; color: #007bff;">ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨</a> |
            <a href="terms-of-service.html" style="margin: 0 10px; text-decoration: none; color: #007bff;">ì´ìš© ì•½ê´€</a> |
            <a href="contact.html" style="margin: 0 10px; text-decoration: none; color: #007bff;">ë¬¸ì˜í•˜ê¸°</a>
        </div>
    </footer>
</body>
</html>
