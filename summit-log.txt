========================================
📋 Summit Log - 2026-02-05 (3)
========================================

## 변경 파일
- horse-race-multiplayer.html: 7954줄 → 370줄 (CSS/JS 외부 분리)
- css/horse-race.css: 새로 생성 (1514줄, 스타일 추출)
- js/horse-race.js: 새로 생성 (6071줄, 로직 추출)
- test-file-separation.js: HTTP 기반 파일 분리 검증 테스트 (12개 테스트)
- test-browser.js: Puppeteer E2E 브라우저 테스트 (20개 테스트)
- test-ranking.js: 순위 계산 검증 테스트 (100회 시뮬레이션)

## 상세 변경 내역

### [파일 분리 리팩토링] (horse-race-multiplayer.html → css/ + js/)
- 목적: 411KB 단일 파일을 관리 가능한 모듈로 분리
- CSS 추출:
  - Lines 14-1526, 1540-1543 → css/horse-race.css
  - @keyframes 애니메이션 포함
- JS 추출:
  - Lines 1873-7920, 7936-7956 → js/horse-race.js
  - let/const → var 변환 (전역 변수 54개)
  - 8-space indentation 제거
- HTML 정리:
  - 인라인 <style>, <script> 제거
  - <link rel="stylesheet" href="/css/horse-race.css"> 추가
  - <script src="/js/horse-race.js"> 추가
  - 370줄로 축소

### [테스트 스크립트 추가]
- test-file-separation.js:
  - HTTP 요청으로 파일 로드 검증
  - 인라인 코드 없음 확인
  - 전역 변수 var 선언 확인
  - 파일 크기 범위 검증
- test-browser.js:
  - Puppeteer로 실제 브라우저 테스트
  - DOM 요소 존재 확인
  - 전역 함수 정의 확인
  - 콘솔/네트워크 에러 확인
  - 반응형 레이아웃 테스트
- test-ranking.js:
  - 서버 순위 시뮬레이션 100회 검증
  - finishJudgedTime 기반 순위 정확성 확인

### [Gap 분석 결과]
- 파일 분리: Match Rate 100%
- Deterministic-Race: Match Rate 85% (Date.now() → frameCount 미구현)

========================================

========================================
📋 Summit Log - 2026-02-05 (2)
========================================

## 변경 파일
- horse-race-multiplayer.html: 다시보기 카운트다운/트랙옵션 추가, 슬로우모션 해제 조건 수정
- socket/rooms.js: 트랙 프리셋 하드코딩 제거, config 파일에서 로드
- config/horse/race.json: short 트랙 500m → 100m 변경

## 상세 변경 내역

### [다시보기 기능 수정] (horse-race-multiplayer.html)
- 문제 1: 다시보기 시 3-2-1-START 카운트다운 없이 바로 출발
- 수정: setTimeout 딜레이 0ms → 4000ms 변경 (line 6602)
- 문제 2: 다시보기 시 trackDistanceMeters 미전달 → 500m 기본값 사용 → 속도 불일치
- 수정: startRaceAnimation에 trackOptions 파라미터 추가 (line 6599-6602)
  - trackDistanceMeters, weatherSchedule, weatherConfig 전달

### [슬로우모션 해제 조건 수정] (horse-race-multiplayer.html)
- 문제: 꼴등 슬로우모션이 결승선 닿아도 안 끝나는 경우 있음
- 기존: loserCameraTarget.finished (왼쪽 끝 통과 시)
- 수정: loserCameraTarget.finishJudged (오른쪽 끝 터치 시)

### [트랙 프리셋 하드코딩 제거] (socket/rooms.js)
- 문제: rooms.js가 `{ short: 500, medium: 700, long: 1000 }` 하드코딩
- config/horse/race.json은 short: 100m인데 클라이언트에 500m 전송됨
- 수정:
  - 파일 상단에 config 로드 추가
  - trackMetersFromConfig 전역 변수로 프리셋 저장
  - 3곳(line 396, 610, 829)에서 하드코딩 → trackMetersFromConfig 사용
  - horseSelectionReady 이벤트에 trackPresets 필드 추가

### [클라이언트 하드코딩 제거] (horse-race-multiplayer.html)
- line 7072: 하드코딩된 trackMeters → trackPresetsFromServer 사용

========================================

========================================
📋 Summit Log - 2026-02-05
========================================

## 변경 파일
- socket/horse.js: 루저 슬로우모션 로직 추가, 도착 판정 개선 (+163줄)
- horse-race-multiplayer.html: 클라이언트 동기화 개선 (+81줄)
- config/horse/race.json: 슬로우모션 설정 조정
- package.json: puppeteer 의존성 추가

## 상세 변경 내역

### [서버에 루저 슬로우모션 로직 추가] (socket/horse.js)
- 기존: 서버에는 leader 슬로우모션만 있고 loser 슬로우모션 없었음
- 문제: 클라이언트는 꼴등 슬로우모션 연출하는데 서버는 안함 → 순위 타이밍 불일치 가능
- 수정:
  - smConf에 loser 설정 추가: `{ triggerDistanceM: 10, factor: 0.4 }`
  - loserSlowMotionTriggered, loserSlowMotionActive, loserCameraTargetIndex 변수 추가
  - 꼴등 직전 말이 결승선 10m 이내일 때 발동
  - 카메라 타겟(꼴등 직전 말)이 완주하면 해제

### [도착 판정 2단계 시스템] (socket/horse.js)
- finishJudged: 말의 오른쪽 끝이 결승선 터치 → 순위 확정
- finished: 말의 왼쪽 끝이 결승선 통과 → 완전 정지
- visualWidth 함수 추가: 탈것별 시각적 너비 반영 (car:50, rocket:60 등)
- 순위는 finishJudgedTime 기준으로 정렬

### [슬로우모션 해제 조건 통일]
- 기존: leader가 currentPos >= finishLine일 때 해제
- 변경: 어떤 말이라도 finishJudged 되면 해제 (클라이언트와 동일)

### [200회 시뮬레이션 검증 완료]
- 서버-클라이언트 시뮬레이션 로직 추출하여 독립 비교 테스트
- 순위 일치율: 100%
- 리더 슬로우모션 타이밍 일치율: 100%
- 루저 슬로우모션 타이밍 일치율: 100% (서버 로직 추가 후)

========================================

========================================
📋 Summit Log - 2026-02-03 (7)
========================================

## 변경 파일
- horse-race-multiplayer.html: 4가지 버그 수정

## 상세 변경 내역

### 버그 1: 다시보기 규칙 완화 (라인 1748, 5984-6010, 6018-6030)
- 원인: 카운트다운 시점에 한 번만 체크하고 고정 → 잠깐 나갔다가 돌아와도 다시보기로 처리됨
- 수정: 카운트다운 중 visibilitychange + focus 리스너 등록
- countdownVisibilityHandler로 탭 복귀 시 missedAtCountdown = false 복구
- 조건 완화: `!missedAtCountdown || (isVisible && hasFocus)` (한번이라도 봤거나 출발 시점에 보면 OK)

### 버그 2: 트랙 변경 즉시 반영 (라인 2235-2252)
- 원인: 버튼 클릭 시 UI만 변경하고 currentTrackLength 변수 미갱신
- 수정: 클릭 시 즉시 currentTrackLength, currentTrackDistanceMeters 갱신 + renderTrackForSelection() 호출

### 버그 3: 꼴등 자동준비 미작동 (라인 6152-6157)
- 원인: horseRaceEnded에서 isReady = false 강제 초기화 → 서버의 readyStateChanged와 충돌
- 수정: isReady 직접 초기화 제거, mySelectedHorse만 초기화 → 서버 이벤트에 위임

### 버그 4: 경기결과 패널 오류 (라인 6128-6132)
- 원인: 클라이언트가 horseRaceHistory.push() + 서버가 horseRaceEnded로 덮어쓰기 → 호스트 중복, 라운드 번호 오류
- 수정: 클라이언트 직접 push 제거, 서버 데이터(horseRaceEnded)만 사용

========================================

========================================
📋 Summit Log - 2026-02-03 (6)
========================================

## 변경 파일
- config/horse/race.json: 기믹 category 필드 추가, 배율/지속시간 조정
- socket/horse.js: 같은 category 연속 방지 로직 추가

## 상세 변경 내역

### 기믹 category 분류 체계 도입
- 각 기믹에 `category` 필드 추가: boost, slow, stop, reverse 4종
- boost: sprint, item_boost, reverse_boost
- slow: slow, wobble
- stop: stop, obstacle, item_trap
- reverse: slip, reverse
- 향후 새 기믹 추가 시 category만 지정하면 연속 방지 자동 적용

### 같은 category 연속 방지 (socket/horse.js ~line 157-167)
- 기믹 생성 루프에서 직전 기믹의 category 추적
- 같은 category가 뽑히면 최대 3회 재뽑기
- boost→boost, stop→stop 등 극단적 연속 기믹 방지

### 배율/지속시간 밸런스 조정
- sprint: [1.3, 2.0] → [1.2, 1.5] (최대 가속 40% 감소)
- item_boost: [1.5, 2.0] → [1.3, 1.6] (최대 가속 25% 감소)
- reverse_boost: [2.0, 3.0] → [1.5, 2.0] (최대 가속 33% 감소)
- obstacle duration: [1000, 3000] → [500, 1500] (최대 정지 50% 감소)
- reverse duration: [2000, 3000] → [1000, 2000] (최대 후진 33% 감소)

========================================

========================================
📋 Summit Log - 2026-02-03 (5)
========================================

## 변경 파일
- horse-race-multiplayer.html: 상세 통계 표시 → 추천 뱃지로 변경

## 상세 변경 내역

### 말 선택 버튼 통계 표시 변경 (renderHorseSelection)
- 기존: 각 탈것 버튼에 "1등 X% | 꼴등 Y%" + "N회 등장" 또는 "기록 없음" 표시
- 변경: 1등 비율이 가장 낮은 탈것 1개에만 빨간색 "추천!" 뱃지 표시
- 목적: 승률 평준화 — 약한 탈것을 추천하여 유저 선택 유도
- 조건: appearance_count >= 5 이상인 탈것만 대상, 없으면 추천 없음
- forEach 루프 직전에 recommendedVehicleId 계산 로직 추가

========================================

========================================
📋 Summit Log - 2026-02-03 (4)
========================================

## 변경 파일
- horse-race-multiplayer.html: 미완주 말 순위 이중 카운팅 버그 수정

## 상세 변경 내역

### 비석 순위 이중 카운팅 수정 (line ~3555)
- 원인: 미완주 말 순위 계산 시 `actualFinishOrder.length + idx`에서 `.push()`로 length가 매 반복 증가하여 이중 카운팅
- 예: 6마리 중 4완주 2미완주 시 → 2번째 미완주가 "7등"으로 표시
- 수정: 루프 전 `baseFinishOrder = actualFinishOrder.length` 캐싱 후 `baseFinishOrder + idx` 사용

========================================

========================================
📋 Summit Log - 2026-02-03 (3)
========================================

## 변경 파일
- horse-race-multiplayer.html: 놓친 경주 다시보기 스포일러 방지, 트랙 길이 변경 즉시 반영

## 상세 변경 내역

### 놓친 경주 다시보기 결과 스포일러 방지
- 원인: 서버가 12초 타이머로 결과 채팅 메시지(isHorseRaceWinner)를 전송, 화면 안 봐도 도착
- 수정: pendingRaceResultMessages 큐 추가
- ChatModule.init에 messageFilter 옵션 추가: missedHorseRace && isHorseRaceWinner 메시지 보관
- replayMissedRace() onComplete에서 보관 메시지 표시
- horseSelectionReady에서 다시보기 안 하고 넘어간 경우 보관 메시지 즉시 표시

### 트랙 길이 변경 즉시 반영
- trackLengthChanged 이벤트에서 renderHorseSelection() 호출 추가
- 방장이 트랙 길이 바꾸면 비호스트 유저 UI 즉시 갱신

========================================

========================================
📋 Summit Log - 2026-02-03 (2)
========================================

## 변경 파일
- config/horse/race.json: 트랙 거리 300/500/700 → 500/700/1000 변경
- socket/horse.js: 기본 트랙 short→medium, trackPresets 정보를 클라이언트에 전송
- horse-race-multiplayer.html: 클라이언트-서버 속도 동기화 개선, 트랙 거리 UI 동적 생성

## 상세 변경 내역

### 트랙 거리 변경
- race.json: short 500m, medium 700m, long 1000m
- 서버/클라이언트 기본값 'short' → 'medium' (500m 기본)
- 클라이언트 하드코딩된 fallback 300 → 500으로 변경 (4곳)

### 트랙 거리 UI config 연동
- 서버가 TRACK_PRESETS의 meters 값을 horseSelectionReady, trackLengthChanged 이벤트에 포함
- 클라이언트 trackPresetsFromServer 변수로 수신, 버튼 텍스트 동적 생성
- config만 변경하면 클라이언트 코드 수정 없이 거리 반영

### 비호스트 트랙 거리 표시 개선
- 기존: 작은 회색 텍스트 "트랙: 500m"
- 변경: 배지 스타일 (🏁 + 파란색 강조 + 배경 그라데이션)

### 클라이언트-서버 속도 동기화 개선
- 미사용 pseudoRandom 코드 제거 (9301/49297 상수)
- state.simElapsed 추가: 서버와 동일한 16ms 고정 스텝으로 속도 변동 interval 계산
- lerp 보간 프레임 독립화: speedDiff * 0.05 → speedDiff * (1 - 0.95^(deltaTime/16))

========================================

========================================
📋 Summit Log - 2026-02-03
========================================

## 변경 파일
- db/init.js: vehicle_stats 테이블 CREATE TABLE 추가
- db/vehicle-stats.js (신규): 탈것 통계 CRUD 모듈 (DB + 파일 fallback)
- socket/horse.js: 경기 종료 시 통계 저장 호출, horseSelectionReady에 인기말 데이터 추가
- horse-race-multiplayer.html: popularVehicles 변수 추가, 말 선택 버튼에 "인기" 뱃지 표시
- config/horse/race.json: 기믹 설정 조정
- update-log.txt: 업데이트 내역 추가

## 상세 변경 내역

### [탈것 통계 DB 저장 시스템]
- vehicle_stats 테이블: server_id, vehicle_id, appearance_count, pick_count, rank_1~rank_6
- UPSERT 방식으로 경기마다 집계 누적
- PostgreSQL 사용 불가 시 config/vehicle-stats.json 파일 fallback
- db/menus.js의 DB+파일 병행 패턴 참고하여 동일 구조 적용

### [경기 종료 시 저장]
- socket/horse.js 2개 코드 경로에 recordVehicleRaceResult() 호출 추가
  - 메인 경주 경로 (타이머 기반 결과 처리)
  - 자동 준비 경주 경로 (allSelected 기반)
- rankings, selectedVehicleTypes, userHorseBets 데이터로 각 탈것의 등장/순위/선택 집계

### [인기말 표시]
- horseSelectionReady 이벤트 3곳에 popularVehicles 배열 추가 전송
- getPopularVehicles(): pick_rate(선택률) 상위 2개, 최소 등장 5회 이상 조건
- 클라이언트: 말 선택 버튼에 주황색 "인기" 뱃지 표시

### [BGM 변경]
- assets/sounds/horse-race/back_bgm.mp3 삭제
- assets/sounds/horse-race/bgm.mp3 변경

========================================
