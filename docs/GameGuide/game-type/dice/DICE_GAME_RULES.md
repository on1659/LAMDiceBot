# 주사위 게임 룰 시스템

주사위 게임의 룰, 승자 판정, 공정성 메커니즘을 정리한 문서입니다.

## 게임 플로우

```
1. 호스트가 방 생성 (gameType: 'dice')
2. 플레이어들 입장
3. 호스트가 게임 룰 설정 (자유 텍스트, 500자 이내)
4. 플레이어들 "준비" 클릭
5. 호스트가 "게임 시작" 클릭 → readyUsers가 gamePlayers로 복사
6. 각 플레이어가 주사위 굴리기 (1회)
7. 진행 상황 실시간 표시 (X/Y명 완료)
8. 모든 gamePlayers 굴림 완료 → 자동 게임 종료
9. 클라이언트에서 승자 판정 및 표시
```

### 최소 인원
- 게임 시작: 2명 이상 준비 필요
- 자유 굴리기: 게임 미진행 시 제한 없이 굴릴 수 있음

### 미준비 플레이어
- 게임 진행 중 미준비 플레이어도 주사위를 굴릴 수 있음
- 단, `isNotReady: true` 플래그가 설정되어 기록에 포함되지 않음
- 승자 판정에서 제외됨

## 주사위 범위 설정

- **최소값**: 항상 1 (고정)
- **최대값**: 사용자별 설정 가능 (기본 100, 최대 100,000)
- **저장**: `gameState.userDiceSettings[userName] = {max}`
- **채팅 명령어**: `/주사위` 또는 `/주사위 1 50` (범위 직접 지정)

## Seeded Random - 공정성 메커니즘

서버 측에서 SHA-256 해시 기반 난수를 생성하여 조작을 방지합니다 (`server.js:804`).

```javascript
function seededRandom(seed, min, max) {
    const hash = crypto.createHash('sha256').update(seed).digest();
    const num = hash.readBigUInt64BE(0);     // 첫 8바이트를 BigInt로
    const range = BigInt(max - min + 1);
    const result = Number(num % range) + min;
    return result;
}
```

**동작 방식**:
1. 클라이언트가 `clientSeed` (타임스탬프 기반) 전송
2. 서버가 시드를 SHA-256 해시하여 결정론적 난수 생성
3. 클라이언트/서버 모두 결과를 조작할 수 없음

## 게임 룰 (승자 판정)

### 3가지 기본 룰

승자 판정은 클라이언트 측(`dice-game-multiplayer.html`)에서 수행됩니다.

#### 1. 하이 (HIGH) - 낮은 사람이 걸림
- **조건**: 룰 텍스트에 "하이"와 "낮은" 포함
- **판정**: 가장 낮은 결과값의 플레이어가 당첨(패배)
- **예시 룰**: `"하이 - 낮은 사람이 걸림"`

#### 2. 로우 (LOW) - 높은 사람이 걸림
- **조건**: 룰 텍스트에 "로우"와 "높은" 포함
- **판정**: 가장 높은 결과값의 플레이어가 당첨(패배)
- **예시 룰**: `"로우 - 높은 사람이 걸림"`

#### 3. 니어 (NEAR) - 목표값에 가장 가까운 사람
- **조건**: 룰 텍스트에 `니어(숫자)` 또는 `니어 숫자` 패턴
- **판정**: 목표 숫자와의 거리(`Math.abs`)가 가장 작은 플레이어
- **예시 룰**: `"니어(50)"`, `"니어 30"`
- **패턴 정규식**: `/니어\s*\(?\s*(\d+)\s*\)?/`

### 커스텀 룰 (GPT 판정)

기본 3가지 패턴에 매칭되지 않으면 OpenAI API로 판정합니다.

- **엔드포인트**: `POST /api/calculate-custom-winner` (`server.js:599`)
- **모델**: gpt-5-nano (우선) → gpt-4o-mini (폴백)
- **프롬프트**: `룰:"규칙텍스트" 결과:user1:num,user2:num 적용 JSON:{"winners":[],"reason":""}`
- **응답**: `{winners: ["당첨자이름"], reason: "판정 이유"}`

### 동점 처리

- 동일한 결과값을 가진 플레이어가 여러 명이면 모두 당첨자로 표시
- 주사위 게임에는 재경주(재굴림) 시스템이 없음 (경마 게임과 다름)

## 애니메이션 시스템

### 마지막 굴림 애니메이션
- **조건**: 게임 진행 중 마지막 참여자가 굴릴 때 (`isLastRoller: true`)
- **효과**: 드라마틱 주사위 공개 연출

### 하이 게임 애니메이션 (`server.js:4046-4084`)
- **트리거 조건**: 4명 이상, 4번째 이후 굴림
- **확정 트리거**: 현재 결과가 기존 최저값보다 낮을 때 (새로운 최저!)
- **확률 트리거**: 두 번째로 낮은 값 = 10%, 세 번째로 낮은 값 = 5%

### 로우 게임 애니메이션 (`server.js:4086-4124`)
- **트리거 조건**: 4명 이상, 4번째 이후 굴림
- **확정 트리거**: 현재 결과가 기존 최고값보다 높을 때 (새로운 최고!)
- **확률 트리거**: 두 번째로 높은 값 = 10%, 세 번째로 높은 값 = 5%

### 니어 게임 애니메이션 (`server.js:4126-4177`)
- **트리거 조건**: 4명 이상, 4번째 이후 굴림
- **확정 트리거**: 현재 거리가 기존 최소 거리보다 작을 때 (더 가까운!)
- **확률 트리거**: 두 번째로 가까운 거리 = 10%, 세 번째로 가까운 거리 = 5%

### 클라이언트 애니메이션 효과
- `fixedDuration`: 빠른 숫자 플래싱 (0.3초)
- `countUp`: 점진적 숫자 증가
- `upAndDown`: 올라갔다 내려오기
- `digitByDigit`: 자릿수별 슬롯머신 회전

## 채팅-주사위 연동

- `/주사위` 채팅 명령어로 굴리기 가능
- 채팅 기록에 주사위 결과가 자동 연결 (`msg.diceResult`)
- `/테스트` 명령어도 동일하게 동작
