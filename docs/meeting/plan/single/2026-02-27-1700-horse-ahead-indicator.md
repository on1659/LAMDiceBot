# LAMDiceBot 팀 회의록 (Single)

**일시**: 2026-02-27 17:00
**주제**: 경마 앞서는 말 인디케이터 — 기획 확정
**참석자 (관점)**:
- 피디: PD
- 기획팀: 기획 팀장 (A1), 기획 사원 (A2)
- 개발팀: 개발 팀장 (B1), 개발 사원 (B2)
- 디자인팀: UI/UX 디자이너 (C)
- 품질팀: QA 엔지니어 (E)
**회의 방식**: 1인 순차 분석 (경량 버전)
**게임 대상**: 경마
**절대 원칙**: 동기화 (서버 사전 계산 → 클라이언트 재생) + 공정성 (모든 말 동등 조건)

---

## 1. 현황 요약

### 기존 인디케이터 시스템

현재 경마에는 **뒤처진 말 인디케이터**(offscreenIndicator)가 존재한다.

- 카메라가 특정 말을 따라갈 때, 화면 왼쪽 밖으로 사라진 뒤처진 말의 레인 **왼쪽**에 `◀ 584m` 형태로 1등과의 거리 표시
- 위치: 해당 말의 `lane` 요소에 `position: absolute; left: 2px` 고정
- **방향: 항상 왼쪽에서만 표시됨** — 화면 오른쪽(앞서는 말)에 대한 정보는 없음

### 비어 있는 영역

- **앞서는 말 정보 부재**: 카메라가 꼴등이나 중위권 말을 따라갈 때, 앞에 달리는 말들이 얼마나 앞에 있는지 알 수 없음
- **출발 안 한 말 상태 불명**: 아직 출발하지 않은 말(시작 위치에 머무는 말)의 상태가 표시되지 않음
- **완주 말 결과 미표시**: 이미 완주한 말의 순위가 레인에서 바로 확인 불가

---

## 2. 관점별 분석

### PD

뒤처진 말에만 거리 인디케이터가 있는 건 정보 비대칭이다. 카메라가 꼴등을 비출 때 "앞에 있는 애들은 어디쯤 있지?"라는 궁금증을 해소할 수단이 없다.

- **제안**: offscreenIndicator의 반대편 — 레인 오른쪽에 앞서는 말의 거리 차이를 고정 표시. 기존 시스템과 완전 대칭 구조.

### 기획 팀장 (A1)

단순히 거리만 보여주면 밋밋하다. 말의 상태에 따라 다른 정보를 보여주면 더 풍부하다.

- **제안**: 3가지 상태 분기
  1. 달리는 중 → `+19m ▶` (카메라 타겟과의 거리 차이)
  2. 출발 안 함 → 😴 (시작 위치에 정지)
  3. 완주함 → `🏁1등` (확정 순위)

### 기획 사원 (A2)

기존 offscreenIndicator는 1등 기준 거리(`leaderPos - state.currentPos`)를 쓴다. 새 인디케이터는 **카메라 타겟 기준** 거리(`state.currentPos - cameraTarget.currentPos`)를 써야 한다. "앞에 있는 애가 나한테서 얼마나 앞인지"가 핵심이니까.

- **제안**: 거리 계산 기준 = 카메라 타겟(현재 보고 있는 말). 카메라 모드(leader / myHorse / loser)에 따라 타겟이 바뀌어도 동일 로직.

### 개발 팀장 (B1)

구현상 핵심 주의점 3가지:

1. **`cameraTarget` 스코프**: 현재 `let cameraTarget`이 `if/else` 블록 안에서 선언됨. `horseStates.forEach`는 그 블록 바깥. 스코프를 올려야 함.
2. **lane width**: `track.style.width`가 5000px+ (결승선 위치). `lane`은 `width: 100%`로 이걸 상속. `right: 2px`는 5000px 지점에 위치 → 화면에 안 보임. 반드시 `left`로 매 프레임 뷰포트 오른쪽 끝 좌표를 계산해야 함.
3. **인디케이터 부착 대상**: `horse` 요소(80px)에 넣으면 스프라이트에 가려짐. `lane`에 넣어야 함.

- **결론**: offscreenIndicator와 완전히 동일한 패턴 — `lane`에 append, `left` 좌표로 뷰포트 오른쪽 고정.

### 개발 사원 (B2)

뷰포트 오른쪽 끝 좌표 계산:
```
viewportRight = -bgScrollOffset + trackWidth - 여백
```
- `bgScrollOffset`: 현재 스크롤 오프셋 (음수)
- `trackWidth`: 컨테이너 뷰포트 너비 (~700px)
- 이 값을 매 프레임 `ai.style.left`에 적용

성능: 매 프레임 DOM 업데이트를 줄이기 위해 `_lastDistAhead`, `_lastAheadText` 캐싱 적용.

### UI/UX 디자이너 (C)

기존 offscreenIndicator와 시각적으로 대칭되어야 한다.

| 요소 | offscreenIndicator (뒤처진 말) | aheadIndicator (앞선 말) |
|------|------|------|
| 위치 | 레인 왼쪽 (`left: 2px` 고정) | 레인 오른쪽 (뷰포트 기준 `left` 계산) |
| 색상 | `var(--yellow-400)` | `var(--green-400)` |
| 크기 | `font-size: 10px` | `font-size: 10px` |
| 그림자 | `text-shadow: 0 0 4px rgba(0,0,0,0.8)` | 동일 |
| 방향 | `◀ 584m` | `+19m ▶` |

- 초록색은 "앞서 있다"는 긍정적 의미, 노란색은 "뒤처져 있다"는 경고 의미로 자연스러운 대비.

### QA 엔지니어 (E)

테스트해야 할 시나리오:

1. **기본 동작**: 5마리 경주, 카메라가 꼴등 → 나머지 4마리 레인 오른쪽에 `+Xm ▶` 표시
2. **카메라 타겟 자신**: 인디케이터 없음
3. **출발 안 한 말**: 😴 표시
4. **완주한 말**: `🏁N등` 표시
5. **카메라 모드 전환**: leader → myHorse → loser 전환 시 인디케이터 정상 갱신
6. **panningToLoser**: 1등 완주 후 꼴등으로 패닝 중에도 동작
7. **거리 0**: 같은 위치에 있는 말은 인디케이터 숨김
8. **경주 재시작**: `track.innerHTML = ''`로 인디케이터 클린업 확인

---

## 3. 결론

### 채택 사항

- offscreenIndicator의 반대편으로 **aheadIndicator** 추가
- 레인 오른쪽 (뷰포트 기준) 고정 배치
- 3가지 상태: 달리는 중 (+Xm ▶), 출발 안 함 (😴), 완주 (🏁N등)
- 거리 기준: 카메라 타겟

### 기각 사항

- 말 스프라이트 위/옆에 표시 → 스프라이트에 가려짐, 좌표 계산 복잡
- `right: 2px` 고정 → lane이 5000px+라서 화면에 안 보임
- 라이브 랭킹 패널에 표시 → 요청과 다름 (레인 위에 보여야 함)

### 변경 범위

- **서버**: 변경 없음
- **클라이언트**: `js/horse-race.js` 1개 파일, 2곳 수정
- **CSS**: 변경 없음
- **DB**: 변경 없음

---

## 4. 위험 요소

| 위험 | 확률 | 대응 |
|------|------|------|
| `cameraTarget` 스코프 오류 → 애니메이션 루프 사망 | 높음 | 반드시 `if/else` 블록 밖으로 호이스팅 |
| `right` 속성 사용 시 화면 밖 위치 | 높음 | `left` + 뷰포트 좌표 계산 필수 |
| `horse` 요소에 인디케이터 부착 시 가려짐 | 높음 | `lane`에 부착 |
| panningToLoser 시 cameraTarget 미정의 | 중간 | 호이스팅으로 기본값 leaderState 유지 |

---

## 5. 구현 문서

→ [impl](../../impl/2026-02-27-ahead-indicator-impl.md)

구현 추천 모델: **Sonnet** (단일 파일, 위치 명확, 코드 작성 위주)
