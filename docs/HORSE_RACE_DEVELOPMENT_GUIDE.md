# 경마 게임 개발 가이드

경마 게임의 현재 구현 상태와 개발 계획을 정리한 문서입니다.

## 현재 구현 상태

### 완료된 부분

- **클라이언트**: `horse-race-multiplayer.html` 구현 완료
  - 말 선택 UI
  - 경주 트랙 애니메이션
  - 순위 팝업
  - 채팅/주문/순위 시스템 통합

- **서버**: `server.js`에 경마 게임 핸들러 구현 완료
  - `startHorseRace`: 경마 시작
  - `selectHorse`: 말 선택 처리
  - `calculateHorseRaceResult`: 경주 결과 계산
  - `getWinnersByRule`: 룰에 따른 당첨자 결정
  - `endHorseRace`: 경마 종료

- **메인페이지**: `dice-game-multiplayer.html`에서 경마 게임 선택 가능
  - 게임 타입 선택 UI에 경마 옵션 추가
  - 경마 페이지로 이동하는 분기 구현

## 완벽하지 않은 부분 (알려진 이슈)

### 1. 게임 시작 이슈 (중요)
- **문제**: 두 번째 플레이어 입장 시 말 선택 UI가 표시되지 않음
- **증상**: 
  - 방 생성 시점(플레이어 1명)에만 `horseSelectionReady` 전송
  - 두 번째 플레이어 입장 후 재전송되지 않아 말 선택 불가
  - 결과적으로 시작 버튼이 활성화되지 않음
- **상태**: 부분 수정됨 (완전히 해결되지 않음)

### 2. 방 생성/입장 흐름
- **문제**: 메인페이지에서 방 타입 선택 후 생성 즉시 입장하는 흐름이 완전히 구현되지 않음
- **요구사항**: 룰렛 입장 흐름 참고하여 동일하게 구현 필요
- **현재**: 경마 페이지로 이동은 되지만, 흐름이 룰렛과 완전히 일치하지 않음

### 3. 루트 경로 접근
- **문제**: `localhost:3000` 루트에서 경마 게임 접근 불가
- **현재**: 직접 URL 입력 필요 (`/horse-race-multiplayer.html`)
- **향후 개선**: 루트 경로에서 게임 타입 선택 페이지 제공

### 4. 애니메이션 동기화
- **가능성**: 서버와 클라이언트 간 애니메이션 타이밍 이슈 가능성
- **상태**: 기본 구현은 완료되었으나 완전히 테스트되지 않음

### 5. 재경주 로직
- **상태**: 구현은 되어 있으나 완전히 테스트되지 않음
- **기능**: 당첨자가 2명 이상일 경우 재경주 진행

## 개발 계획 (초기 계획 요약)

### 기본 구조
- 주사위/룰렛 게임과 동일한 구조로 구현
- 준비/채팅/주문/순위 시스템 유지
- 게임 룰만 경마 방식으로 변경

### 게임 룰
- **말 수**: 4~6마리 랜덤 (서버에서 결정)
- **베팅 방식**: 1인 1말 선택 (포인트 없음)
- **경주 진행**: 자동 랜덤 (서버에서 순위 결정 후 애니메이션 재생)
- **최소 인원**: 2명 이상
- **게임 모드**: 'first' (1등 찾기) 또는 'last' (꼴등 찾기)

### 게임 플로우
1. 참가자들이 말 선택
2. 호스트가 "경마 시작" 버튼 클릭
3. 서버에서 말 수 결정 (4~6마리)
4. 각 참가자가 말 선택 (베팅)
5. 모든 참가자가 선택 완료 시 경주 시작
6. 서버에서 순위 결정 (랜덤)
7. 클라이언트에서 애니메이션 재생
8. 모든 말이 도착하면 순위 팝업 표시

## 참고 파일

- `roulette-game-multiplayer.html`: UI 구조 참고
- `dice-game-multiplayer.html`: 순위 시스템 참고
- `server.js`: 룰렛 게임 핸들러 참고

## 리소스 스펙

자세한 리소스 스펙은 `docs/RESOURCES.md` 참고:
- 말 애니메이션 스프라이트 (8프레임)
- 경기장 트랙 배경
- UI 컴포넌트

## 향후 작업

1. 게임 시작 이슈 완전 해결
2. 방 생성/입장 흐름 룰렛과 동일하게 구현
3. 루트 경로 접근 개선
4. 애니메이션 동기화 테스트 및 개선
5. 재경주 로직 완전 테스트

---

## 재경주 룰 요구사항 및 구현 상태

### 재경주 룰 요구사항

#### 기본 규칙
1. **동점 발생 시**: 당첨자가 2명 이상일 경우 재경주 진행
2. **재경주 대상자**: 동점으로 당첨된 플레이어들만 재경주에 참여
3. **라운드 증가**: 재경주마다 `raceRound` 값이 1씩 증가
4. **호스트 제어**: 재경주 준비 및 시작은 호스트만 가능

#### 재경주 플로우
1. 경주 종료 후 당첨자 2명 이상 확인
2. 서버에서 `raceRound++`, `currentRoundPlayers = winners` 설정
3. 호스트에게 "재경주 준비" 버튼 표시 (`reraceReady` 이벤트)
4. 호스트가 "재경주 준비" 버튼 클릭 (`requestReraceReady`)
5. 재경주 대상자에게만 말 선택 UI 표시 (`horseSelectionReady` with `isRerace: true`)
6. 재경주 대상자들이 탈것 선택
7. 모든 재경주 대상자가 선택 완료 시 호스트에게 "재경주" 버튼 활성화
8. 호스트가 "재경주" 버튼 클릭 (`startRerace`)
9. 재경주 진행 (기존 경주와 동일한 로직)
10. 재경주 결과에 따라:
    - 당첨자 1명: 게임 종료, `raceRound = 1` 초기화
    - 당첨자 2명 이상: 다시 재경주 진행 (2-9 반복)

### 현재 구현된 부분

#### 서버 측 (`server.js`)
- ✅ 동점 감지 및 재경주 준비 상태 설정 (3497-3528줄)
- ✅ `raceRound` 증가 및 `currentRoundPlayers` 설정 (3499-3500줄)
- ✅ 재경주 준비 버튼 핸들러 (`requestReraceReady`, 3598-3679줄)
- ✅ 재경주 시작 핸들러 (`startRerace`, 3682-3821줄)
- ✅ 재경주 대상자만 말 선택 가능하도록 필터링
- ✅ 재경주 시 탈것 타입 랜덤 재설정 (3657-3664줄)
- ✅ 재경주 기록 저장 (`horseRaceHistory`에 저장)
- ✅ 게임 종료 시 `raceRound = 1` 초기화 (3469줄, 3848줄)

#### 클라이언트 측 (`horse-race-multiplayer.html`)
- ✅ 재경주 준비 버튼 표시 (3646-3658줄, 4394-4409줄)
- ✅ 재경주 상태 관리 (`isReraceActive` 변수)
- ✅ 재경주 대상자 필터링 (2232줄, 2240줄, 2295줄)
- ✅ 재경주 대상자가 아닌 사용자에게 안내 메시지 (2295-2297줄)
- ✅ 재경주 버튼 업데이트 로직 (`updateReraceButton`, 3677-3704줄)
- ✅ 재경주 라운드 번호 표시 (`raceRound` 변수 사용)

### 구현되지 않았거나 개선이 필요한 부분

#### 1. 재경주 연속 발생 처리
- **현재 상태**: 재경주에서도 동점이 나올 수 있으나, 연속 재경주가 제대로 처리되는지 테스트 필요
- **확인 필요**: 
  - 재경주 결과에서 다시 동점이 나왔을 때 `reraceReady` 이벤트가 정상적으로 발생하는지
  - 여러 라운드 연속 재경주 시 `raceRound`가 올바르게 증가하는지
- **위치**: `server.js` 3497-3528줄 (재경주 필요 분기)

#### 2. 재경주 대상자가 아닌 사용자 UI 상태
- **현재 상태**: 재경주 대상자가 아닌 사용자에게 안내 메시지는 표시되지만, 관찰자 모드 UI가 명확하지 않음
- **개선 필요**:
  - 재경주 대상자가 아닌 사용자에게 "관찰자 모드" 표시
  - 재경주 진행 상황을 실시간으로 볼 수 있는 UI (예: 재경주 대상자 선택 현황)
- **위치**: `horse-race-multiplayer.html` 2295-2297줄

#### 3. 재경주 라운드 번호 UI 표시
- **현재 상태**: `raceRound` 변수는 관리되지만, UI에 명확히 표시되지 않을 수 있음
- **개선 필요**:
  - 말 선택 화면에 "재경주 N라운드" 표시
  - 경주 진행 중 라운드 번호 표시
  - 결과 화면에 라운드 번호 표시
- **위치**: `horse-race-multiplayer.html` (말 선택 섹션, 경주 트랙, 결과 오버레이)

#### 4. 재경주 중 새 플레이어 입장 처리
- **현재 상태**: 재경주 진행 중 새 플레이어가 입장했을 때의 처리 로직 확인 필요
- **확인 필요**:
  - 재경주 중 입장한 플레이어는 `currentRoundPlayers`에 포함되지 않아야 함
  - 재경주 중 입장한 플레이어에게 적절한 안내 메시지 표시
- **위치**: `server.js` `roomJoined` 핸들러 (1258-1280줄)

#### 5. 재경주 기록 히스토리 표시
- **현재 상태**: 재경주 기록은 `horseRaceHistory`에 저장되지만, 히스토리 UI에서 재경주임을 명확히 표시하는지 확인 필요
- **개선 필요**:
  - 히스토리에서 재경주 라운드임을 표시 (예: "2라운드 (재경주)")
  - 재경주 라운드들을 그룹화하여 표시
- **위치**: `horse-race-multiplayer.html` 히스토리 렌더링 부분

#### 6. 재경주 준비 상태 복구
- **현재 상태**: 재경주 준비 상태(`isReraceReady`)가 설정되었지만, 클라이언트 재접속 시 복구되는지 확인 필요
- **확인 필요**:
  - `roomJoined` 이벤트에서 재경주 준비 상태를 클라이언트에 전송하는지
  - 재경주 준비 상태일 때 호스트에게 버튼이 표시되는지
- **위치**: `server.js` `roomJoined` 핸들러

#### 7. 재경주 중 게임 종료 처리
- **현재 상태**: 재경주 중 호스트가 게임 종료 버튼을 눌렀을 때의 처리 확인 필요
- **확인 필요**:
  - 재경주 중 게임 종료 시 `raceRound` 초기화
  - 재경주 대상자 상태 초기화
- **위치**: `server.js` `endHorseRace` 핸들러 (3823-3848줄) - 이미 구현되어 있음

#### 8. 재경주 대상자 선택 완료 알림
- **현재 상태**: 재경주 대상자가 아닌 사용자에게는 선택 완료 알림이 없을 수 있음
- **개선 필요**:
  - 재경주 대상자가 모두 선택했을 때 모든 사용자에게 알림
  - 재경주 시작 시 모든 사용자에게 알림
- **위치**: `server.js` `startRerace` 핸들러

### 테스트 시나리오

#### 시나리오 1: 기본 재경주
1. 4명이 경주 참여
2. 2명이 동점으로 당첨
3. 호스트가 재경주 준비 버튼 클릭
4. 동점 2명만 말 선택
5. 재경주 진행
6. 1명 당첨 → 게임 종료

#### 시나리오 2: 연속 재경주
1. 4명이 경주 참여
2. 2명이 동점으로 당첨
3. 재경주 진행
4. 재경주에서도 2명 동점
5. 2차 재경주 진행
6. 1명 당첨 → 게임 종료

#### 시나리오 3: 재경주 중 새 플레이어 입장
1. 4명이 경주 참여
2. 2명이 동점으로 당첨
3. 재경주 준비 중 새 플레이어 입장
4. 새 플레이어는 재경주에 참여하지 않음
5. 재경주 진행

#### 시나리오 4: 재경주 중 게임 종료
1. 재경주 진행 중
2. 호스트가 게임 종료 버튼 클릭
3. 모든 상태 초기화 (`raceRound = 1`)

### 관련 코드 위치

- **서버 재경주 로직**: `server.js` 3497-3821줄
- **클라이언트 재경주 UI**: `horse-race-multiplayer.html` 3646-3704줄, 4394-4410줄
- **재경주 상태 관리**: 
  - 서버: `server.js` 357줄 (`isReraceReady`), 362줄 (`currentRoundPlayers`), 363줄 (`raceRound`)
  - 클라이언트: `horse-race-multiplayer.html` 1559줄 (`isReraceActive`), 1556줄 (`currentRoundPlayers`), 1557줄 (`raceRound`)
