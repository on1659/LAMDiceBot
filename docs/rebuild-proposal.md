# LAMDiceBot 리빌드 제안서

> 작성일: 2026-02-13  
> 분석 브랜치: `feature/quick-win-scalability`  
> 총 코드량: ~27,000줄 (서버 ~7,700 / 프론트 HTML ~15,200 / 공유 JS ~11,100)

---

## 1. 현재 기능 전체 목록

### 🎮 게임 시스템

| 게임 | 파일 | 주요 기능 |
|------|------|-----------|
| **주사위** | `socket/dice.js`, `dice-game-multiplayer.html` | 범위 설정(N~M), 굴리기, 높은/낮은 수 승리, 게임 규칙 변경, 결과 판정, 서버 기록 저장 |
| **경마** | `socket/horse.js`, `js/horse-race.js`, `horse-race-multiplayer.html` | 11종 탈것, 트랙 길이(short/medium/long), 말 선택/랜덤 선택, 서버측 시뮬레이션, 클라이언트 애니메이션, 1등/꼴등 모드, 기믹 시스템, 탈것 통계, 사진판정 |
| **룰렛** | `socket/roulette.js`, `roulette-game-multiplayer.html` | 색상 선택, 터보 애니메이션, 룰렛 스핀 결과, 사운드 |
| **팀전** | `team-game-multiplayer.html` | 팀 기반 대전 |

### 🏠 방 시스템 (`socket/rooms.js` — 1,394줄)

- 방 생성/참가/퇴장/삭제
- 비밀번호 방 (비공개)
- 방장 이전, 강퇴
- 방 이름 변경
- 방 만료 시간 (자동 삭제, 1분 주기 체크)
- 로그인 (닉네임 + deviceId)
- 방 목록 실시간 브로드캐스트 (디바운싱 200ms)
- 서버별 방 필터링 (비공개방은 같은 서버만 노출)
- 공개방 최대 10개 제한

### 🖥️ 서버 시스템 (`socket/server.js`, `routes/server.js`, `db/servers.js`)

- 서버 생성/조회/삭제
- 서버 가입/탈퇴
- 멤버 관리 (승인/거부/제거)
- 서버별 게임 기록
- 온라인 멤버 추적
- 호스트 코드, 비밀번호

### 💬 채팅 (`socket/chat.js`, `chat-shared.js` — 2,239줄)

- 텍스트 메시지 (XSS 방지)
- 이미지 전송 (4MB 자동 압축)
- 이모지 리액션 (커스텀 이모지 설정)
- 메시지 고정
- @멘션 자동완성
- 시스템 메시지 (입장/퇴장/게임 결과)
- 디바이스별 아이콘 (iOS/Android/PC)
- 탭 비활성 시 타이틀 깜박임

### 📋 주문 시스템 (`socket/shared.js`, `order-shared.js`)

- 주문 시작/종료 (방장)
- 주문 입력/수정/삭제
- 자주 쓰는 메뉴 (DB 저장)
- 주문 통계/랭킹

### 🏆 랭킹 (`db/ranking.js`, `ranking-shared.js`)

- 종합 랭킹: 최다 플레이, 최다 승리, 승률, 평균 등수
- 게임별 랭킹: 주사위/경마/룰렛 세부 통계
- 서버별 랭킹 + 자유 랭킹
- 주문 랭킹 (가장 많이 시킨 메뉴)

### 📊 통계 (`db/stats.js`, `statistics.html`)

- 방문자 통계 (일별 IP, 누적 참여)
- 게임별 플레이 횟수
- 최근 플레이 목록
- 탈것별 출현/선택/등수 통계 (`db/vehicle-stats.js`)

### 🔐 인증 (`db/auth.js`, `utils/auth.js`)

- 사용자 등록/로그인 (이름 + PIN)
- PIN bcrypt 해싱
- 관리자 JWT 토큰

### 📝 게시판 (`socket/board.js`, `db/suggestions.js`)

- 건의사항 CRUD (비밀번호 보호)
- Gemini AI 챗봇 연동

### 🔧 관리자 (`admin.html`, `routes/server.js`)

- 관리자 토큰 인증
- 서버 목록/삭제
- 유저 목록/삭제
- 통계 대시보드

### 🎵 사운드 시스템

- 게임별 BGM, 효과음 (주사위/경마/룰렛/팀)
- 사운드 매니저 (`assets/sounds/sound-manager.js`)
- 사운드 설정 JSON

### 기타

- 확률 분석 페이지, 주사위 규칙 가이드
- About/연락처/개인정보/이용약관 페이지
- GIF 레코더 (Web Worker)
- 서버 선택 UI (`server-select-shared.js`)
- 준비 시스템 (`ready-shared.js`)
- AutoTest 봇 (Playwright/Socket.io 기반)

---

## 2. 현재 아키텍처 문제점

### 🔴 심각

| 문제 | 설명 |
|------|------|
| **모놀리식 HTML** | `dice-game-multiplayer.html`이 7,126줄. HTML+CSS+JS 한 파일에 모든 UI 로직 포함. 유지보수 불가 수준 |
| **인메모리 방 관리** | `rooms = {}` — 서버 재시작 시 모든 방/게임 상태 소실. 수평 확장 불가 |
| **프론트엔드 빌드 없음** | 번들링/트랜스파일/코드분할 없음. shared JS를 `<script>`로 직접 로드 |
| **타입 안전성 없음** | 전체 순수 JS. 소켓 이벤트 이름 오타 = 런타임 버그 |

### 🟡 중요

| 문제 | 설명 |
|------|------|
| **소켓 이벤트 ~40개** | 이벤트 이름 문자열 기반, 문서화 없음. 클라이언트-서버 간 계약이 암묵적 |
| **중복 코드** | 각 게임 HTML에 유사한 방 관리/채팅/주문 UI 반복 |
| **DB 이중 구조** | Postgres 있으면 DB, 없으면 파일시스템 — 두 경로 모두 유지 필요 |
| **정적 파일 서빙** | Express로 직접 서빙. CDN/리버스 프록시 없음 |
| **테스트 부족** | AutoTest는 E2E 봇 테스트만. 유닛 테스트 없음 |

### 🟢 개선 가능

| 문제 | 설명 |
|------|------|
| **CSS 관리** | 인라인 스타일 + 개별 CSS 파일. 디자인 시스템 없음 |
| **에러 처리** | try-catch 산발적. 통합 에러 핸들링 없음 |
| **환경 설정** | `config.js` 최소화 (PORT만). 환경별 설정 관리 없음 |
| **보안** | Rate limiting 있으나, 소켓 레벨 인증이 약함 (닉네임+deviceId만) |

---

## 3. 새 기술스택 제안

### 프론트엔드

| 옵션 | 추천 | 이유 |
|------|:----:|------|
| **React + Vite** | ⭐ | 컴포넌트 재사용으로 중복 해결, 생태계 최대, 인력 구하기 쉬움 |
| Next.js (App Router) | | SSR 필요 없는 실시간 게임에 오버킬 |
| Svelte + SvelteKit | | 번들 작고 빠르지만 생태계 작음 |

**추가 추천:** TypeScript 필수, Tailwind CSS, Zustand (상태), socket.io-client 유지

### 백엔드

| 옵션 | 추천 | 이유 |
|------|:----:|------|
| **NestJS + Socket.io** | ⭐ | 구조화된 모듈/서비스 패턴, TypeScript 네이티브, 데코레이터 기반 소켓 핸들러 |
| Fastify + Socket.io | | Express보다 빠르고 스키마 검증 내장. 가벼운 선택 |
| Express 유지 + 리팩터 | | 마이그레이션 비용 최소지만 구조적 한계 동일 |

**추가 추천:** Redis (방 상태 + pub/sub), Zod (이벤트 스키마 검증)

### 데이터베이스

| 옵션 | 추천 | 이유 |
|------|:----:|------|
| **PostgreSQL + Prisma** | ⭐ | 이미 Postgres 사용 중, Prisma로 타입 안전 쿼리 + 마이그레이션 |
| PostgreSQL + Drizzle | | Prisma보다 가볍고 SQL에 가까움 |
| Supabase | | Postgres + Auth + Realtime 올인원. 관리 부담 줄임 |

### 상태 관리 (게임/방)

| 옵션 | 추천 | 이유 |
|------|:----:|------|
| **Redis** | ⭐ | 인메모리 방 상태 → Redis로 이동. 서버 재시작 안전, 수평 확장 가능 |
| Redis + Bull (큐) | | 게임 시뮬레이션 등 비동기 작업 처리 |

### 배포

| 옵션 | 추천 | 이유 |
|------|:----:|------|
| **Railway (현행 유지)** | ⭐ | 이미 사용 중, Postgres/Redis 애드온 제공 |
| Fly.io | | WebSocket 지원 좋고 멀티리전 가능 |
| Docker + VPS | | 비용 효율적이지만 관리 부담 |

---

## 4. 리빌드 단계 제안

### Phase 1: 기반 구축 (2주)

```
├── 모노레포 설정 (pnpm workspace)
│   ├── packages/shared     — 타입 정의, 소켓 이벤트 계약, 상수
│   ├── packages/server     — NestJS 백엔드
│   └── packages/web        — React + Vite 프론트
├── Prisma 스키마 정의 (기존 DB 테이블 그대로 마이그레이션)
├── Redis 연동 (방 상태 관리)
└── 소켓 이벤트 타입 정의 (TypeScript interface)
```

### Phase 2: 핵심 시스템 (2주)

```
├── 인증 시스템 (JWT + PIN → 적절한 세션 관리)
├── 방 시스템 (생성/참가/퇴장/목록)
├── 서버 시스템 (CRUD + 멤버 관리)
├── 채팅 시스템 (메시지/이미지/리액션)
└── 주문 시스템
```

### Phase 3: 게임 로직 (3주)

```
├── 주사위 게임 (가장 단순 → 먼저)
├── 룰렛 게임
├── 경마 게임 (가장 복잡 — 시뮬레이션 + 애니메이션)
│   ├── 서버: 레이스 시뮬레이션 엔진
│   └── 클라이언트: Canvas/CSS 애니메이션
└── 팀전 게임
```

### Phase 4: 부가 기능 (1.5주)

```
├── 랭킹 시스템 (종합/게임별/서버별)
├── 통계 대시보드
├── 관리자 페이지
├── 게시판 + Gemini 챗봇
├── 사운드 시스템
└── 사운드/이모지/메뉴 설정 관리
```

### Phase 5: 품질 + 배포 (1.5주)

```
├── 유닛 테스트 (Vitest — 게임 로직)
├── E2E 테스트 (Playwright — 기존 AutoTest 대체)
├── CI/CD (GitHub Actions → Railway)
├── 모니터링 (에러 트래킹)
└── 성능 최적화 (코드 분할, 레이지 로딩)
```

---

## 5. 예상 작업량

| Phase | 기간 | 인력 (풀타임) | 비고 |
|-------|------|:---:|------|
| 1. 기반 구축 | 2주 | 1명 | 보일러플레이트 + DB 마이그레이션 |
| 2. 핵심 시스템 | 2주 | 1~2명 | 방/서버/채팅/주문 |
| 3. 게임 로직 | 3주 | 1~2명 | 경마가 가장 큰 비중 (~40%) |
| 4. 부가 기능 | 1.5주 | 1명 | 랭킹/통계/관리자 |
| 5. 품질 + 배포 | 1.5주 | 1명 | 테스트/CI/CD |
| **합계** | **~10주** | **1~2명** | |

### 참고

- 1인 개발 시: **10~12주** (2.5~3개월)
- 2인 개발 시: **6~8주** (1.5~2개월)  
- 기존 기능을 100% 동일하게 재현하는 기준
- 경마 게임 애니메이션이 전체 난이도의 핵심 (현재 `js/horse-race.js` 6,322줄)

### 대안: 점진적 마이그레이션

전면 리빌드 대신, 단계적으로:

1. TypeScript 도입 (기존 코드에 `.ts` 전환)
2. 프론트만 React로 교체 (백엔드 소켓 API 유지)
3. Prisma 도입 (기존 raw SQL → ORM)
4. Redis 도입 (인메모리 → Redis)

이 경우 **각 단계를 독립 배포** 가능하여 리스크 낮음. 총 기간은 비슷하지만 중간에 운영 가능.
