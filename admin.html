<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 - LAMDice</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
        .back-link { display: inline-block; margin-bottom: 20px; color: #007bff; text-decoration: none; }
        .back-link:hover { text-decoration: underline; }

        .login-box { max-width: 400px; margin: 60px auto; text-align: center; }
        .login-box input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 12px; }
        .login-box input:focus { border-color: #667eea; outline: none; }
        .login-box button { width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; }
        .login-box button:hover { background: #5a6fd6; }

        .admin-panel { display: none; }
        .server-card { background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .server-card.inactive { opacity: 0.5; }
        .server-info h3 { margin: 0 0 4px 0; font-size: 1.1em; }
        .server-info p { margin: 0; color: #666; font-size: 0.9em; }
        .server-meta { display: flex; gap: 12px; font-size: 0.85em; color: #888; margin-top: 4px; }
        .btn-danger { padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em; }
        .btn-danger:hover { background: #c82333; }
        .btn-sm { padding: 6px 12px; font-size: 0.85em; }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; color: white; }
        .badge-active { background: #28a745; }
        .badge-inactive { background: #dc3545; }
        .badge-private { background: #ffc107; color: #333; }
        .empty-state { text-align: center; padding: 40px; color: #999; }
        .error-msg { color: #dc3545; margin-top: 8px; font-size: 0.9em; }
        .stats-row { display: flex; gap: 16px; margin-bottom: 20px; }
        .stat-box { flex: 1; background: #f0f0ff; padding: 16px; border-radius: 8px; text-align: center; }
        .stat-box .num { font-size: 2em; font-weight: bold; color: #667eea; }
        .stat-box .label { font-size: 0.85em; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-link">&larr; 메인으로</a>
        <h1>관리자 패널</h1>

        <div class="login-box" id="loginBox">
            <p style="color: #666; margin-bottom: 20px;">관리자 비밀번호를 입력하세요</p>
            <input type="password" id="adminPassword" placeholder="비밀번호" />
            <button onclick="adminLogin()">로그인</button>
            <p class="error-msg" id="loginError" style="display:none;"></p>
        </div>

        <div class="admin-panel" id="adminPanel">
            <div class="stats-row" id="statsRow">
                <div class="stat-box"><div class="num" id="totalServers">-</div><div class="label">전체 서버</div></div>
                <div class="stat-box"><div class="num" id="activeServers">-</div><div class="label">활성 서버</div></div>
            </div>

            <h2>서버 목록</h2>
            <div id="serverList"><div class="empty-state">로딩 중...</div></div>
        </div>
    </div>

    <script>
        let adminToken = null;

        async function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            const errorEl = document.getElementById('loginError');
            errorEl.style.display = 'none';

            try {
                const res = await fetch('/api/admin/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                const data = await res.json();
                if (!res.ok) {
                    errorEl.textContent = data.error || '인증 실패';
                    errorEl.style.display = 'block';
                    return;
                }
                adminToken = data.token;
                document.getElementById('loginBox').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                loadServers();
            } catch (e) {
                errorEl.textContent = '서버 연결 오류';
                errorEl.style.display = 'block';
            }
        }

        document.getElementById('adminPassword').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') adminLogin();
        });

        async function loadServers() {
            try {
                const res = await fetch('/api/admin/servers', {
                    headers: { 'X-Admin-Token': adminToken }
                });
                if (!res.ok) { document.getElementById('serverList').innerHTML = '<div class="empty-state">인증 만료</div>'; return; }
                const servers = await res.json();

                document.getElementById('totalServers').textContent = servers.length;
                document.getElementById('activeServers').textContent = servers.filter(s => s.is_active).length;

                if (servers.length === 0) {
                    document.getElementById('serverList').innerHTML = '<div class="empty-state">등록된 서버가 없습니다.</div>';
                    return;
                }

                document.getElementById('serverList').innerHTML = servers.map(s => `
                    <div class="server-card ${s.is_active ? '' : 'inactive'}">
                        <div class="server-info">
                            <h3>${escapeHtml(s.name)} ${s.is_active ? '<span class="badge badge-active">활성</span>' : '<span class="badge badge-inactive">비활성</span>'}</h3>
                            <p>${escapeHtml(s.description || '설명 없음')}</p>
                            <div class="server-meta">
                                <span>호스트: ${escapeHtml(s.host_name)}</span>
                                <span>멤버: ${s.member_count || 0}명</span>
                                <span>${new Date(s.created_at).toLocaleDateString('ko-KR')}</span>
                            </div>
                        </div>
                        <div>
                            <a href="/server-members.html?id=${s.id}" class="btn-danger btn-sm" style="background:#667eea;text-decoration:none;color:white;margin-right:8px;">멤버 관리</a>
                            <button class="btn-danger btn-sm" onclick="deleteServer(${s.id}, '${escapeHtml(s.name)}')">삭제</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                document.getElementById('serverList').innerHTML = '<div class="empty-state">서버 목록 로드 실패</div>';
            }
        }

        async function deleteServer(id, name) {
            if (!confirm(`"${name}" 서버를 삭제하시겠습니까?\n멤버와 기록이 모두 삭제됩니다.`)) return;
            try {
                const res = await fetch(`/api/admin/servers/${id}`, {
                    method: 'DELETE',
                    headers: { 'X-Admin-Token': adminToken }
                });
                if (res.ok) loadServers();
                else alert('삭제 실패');
            } catch (e) {
                alert('서버 연결 오류');
            }
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }
    </script>
</body>
</html>
