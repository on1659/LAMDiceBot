<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì - LAMDice</title>

    <!-- FOUC Prevention: Always use light theme -->
    <script>
      (function() {
        // Always use light mode regardless of system preference
        document.documentElement.setAttribute('data-theme', 'light');
      })();
    </script>

    <!-- Theme Variables -->
    <link rel="stylesheet" href="/css/theme.css">

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; max-width: 900px; margin: 0 auto; padding: 20px; background: var(--gray-100); }
        .container { background: var(--bg-white); padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: var(--dice-accent); border-bottom: 2px solid var(--dice-accent); padding-bottom: 10px; }
        .back-link { display: inline-block; margin-bottom: 20px; color: var(--dice-accent); text-decoration: none; }
        .back-link:hover { text-decoration: underline; }

        .login-box { max-width: 400px; margin: 60px auto; text-align: center; }
        .login-box input { width: 100%; padding: 12px; border: 2px solid var(--gray-300); border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 12px; }
        .login-box input:focus { border-color: var(--dice-accent); outline: none; }
        .login-box button { width: 100%; padding: 12px; background: var(--dice-accent); color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; }
        .login-box button:hover { background: var(--purple-600); }

        .admin-panel { display: none; }
        .stats-row { display: flex; gap: 16px; margin-bottom: 20px; }
        .stat-box { flex: 1; background: var(--purple-50); padding: 16px; border-radius: 8px; text-align: center; }
        .stat-box .num { font-size: 2em; font-weight: bold; color: var(--dice-accent); }
        .stat-box .label { font-size: 0.85em; color: var(--text-secondary); }

        .section { margin-bottom: 24px; }
        .section h2 { display: flex; align-items: center; justify-content: space-between; }
        .refresh-btn { padding: 4px 12px; border: 1px solid var(--gray-300); border-radius: 6px; background: var(--bg-white); cursor: pointer; font-size: 0.8em; color: var(--text-secondary); }
        .refresh-btn:hover { background: var(--gray-100); }

        table { width: 100%; border-collapse: collapse; margin-top: 12px; }
        th { text-align: left; padding: 10px 12px; font-size: 0.8em; color: var(--text-muted); border-bottom: 2px solid var(--gray-200); font-weight: 600; }
        td { padding: 12px; border-bottom: 1px solid var(--gray-100); font-size: 0.9em; }
        tr:hover td { background: var(--bg-primary); }

        .badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; color: white; }
        .badge-active { background: var(--btn-ready); }
        .badge-inactive { background: var(--btn-danger); }
        .btn-danger { padding: 6px 12px; background: var(--btn-danger); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85em; }
        .btn-danger:hover { background: var(--btn-danger-hover); }
        .btn-info { padding: 6px 12px; background: var(--dice-accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85em; }
        .btn-info:hover { background: var(--purple-600); }
        .bulk-bar { display: none; align-items: center; gap: 12px; padding: 10px 16px; background: var(--red-50); border: 1px solid var(--red-200); border-radius: 8px; margin-bottom: 12px; }
        .bulk-bar .count { font-weight: bold; color: var(--red-500); }
        .bulk-bar .btn-danger { padding: 8px 16px; }
        .bulk-bar .btn-cancel { padding: 8px 16px; border: 1px solid var(--gray-300); border-radius: 6px; background: var(--bg-white); cursor: pointer; font-size: 0.85em; color: var(--text-secondary); }
        .bulk-bar .btn-cancel:hover { background: var(--gray-100); }
        table input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; accent-color: var(--dice-accent); }
        .empty-state { text-align: center; padding: 40px; color: var(--text-muted); }
        .error-msg { color: var(--red-500); margin-top: 8px; font-size: 0.9em; }
        .logout-btn { float: right; padding: 6px 14px; border: 1px solid var(--gray-300); border-radius: 6px; background: var(--bg-white); color: var(--text-secondary); cursor: pointer; font-size: 0.85em; }
        .logout-btn:hover { background: var(--gray-100); }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-link">&larr; ë©”ì¸ìœ¼ë¡œ</a>
        <h1>ê´€ë¦¬ì íŒ¨ë„ <button class="logout-btn" id="logoutBtn" style="display:none;" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button></h1>

        <div class="login-box" id="loginBox">
            <p style="color: var(--text-secondary); margin-bottom: 20px;">ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸</p>
            <input type="text" id="adminId" placeholder="ê´€ë¦¬ì ID" />
            <input type="password" id="adminPw" placeholder="ë¹„ë°€ë²ˆí˜¸" />
            <button onclick="doLogin()">ë¡œê·¸ì¸</button>
            <p class="error-msg" id="loginError" style="display:none;"></p>
        </div>

        <div class="admin-panel" id="adminPanel">
            <div class="stats-row" id="statsRow">
                <div class="stat-box"><div class="num" id="totalServers">-</div><div class="label">ì „ì²´ ì„œë²„</div></div>
                <div class="stat-box"><div class="num" id="activeServers">-</div><div class="label">í™œì„± ì„œë²„</div></div>
                <div class="stat-box"><div class="num" id="totalUsers">-</div><div class="label">ì „ì²´ ìœ ì €</div></div>
            </div>

            <div class="section">
                <h2>ì„œë²„ ê´€ë¦¬ <button class="refresh-btn" onclick="loadServers()">ìƒˆë¡œê³ ì¹¨</button></h2>
                <div class="bulk-bar" id="bulkBar">
                    <span><span class="count" id="selectedCount">0</span>ê°œ ì„ íƒë¨</span>
                    <button class="btn-danger" onclick="bulkDeleteServers()">ì„ íƒ ì‚­ì œ</button>
                    <button class="btn-cancel" onclick="clearSelection()">ì·¨ì†Œ</button>
                </div>
                <div id="serverList"><div class="empty-state">ë¡œë”© ì¤‘...</div></div>
            </div>

            <div class="section">
                <h2>ìœ ì € ê´€ë¦¬ <button class="refresh-btn" onclick="loadUsers()">ìƒˆë¡œê³ ì¹¨</button></h2>
                <div id="userList"><div class="empty-state">ë¡œë”© ì¤‘...</div></div>
            </div>
        </div>
    </div>

    <script>
        let adminToken = sessionStorage.getItem('adminToken') || '';

        if (adminToken) verifyAndShow();

        document.getElementById('adminId').addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('adminPw').focus(); });
        document.getElementById('adminPw').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });

        async function doLogin() {
            const id = document.getElementById('adminId').value.trim();
            const pw = document.getElementById('adminPw').value;
            const errEl = document.getElementById('loginError');
            errEl.style.display = 'none';
            if (!id || !pw) { errEl.textContent = 'IDì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'; errEl.style.display = 'block'; return; }
            try {
                const res = await fetch('/api/admin/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, password: pw })
                });
                const data = await res.json();
                if (!res.ok) { errEl.textContent = data.error; errEl.style.display = 'block'; return; }
                adminToken = data.token;
                sessionStorage.setItem('adminToken', adminToken);
                showDashboard();
            } catch (e) {
                errEl.textContent = 'ì„œë²„ ì—°ê²° ì˜¤ë¥˜'; errEl.style.display = 'block';
            }
        }

        async function verifyAndShow() {
            try {
                const res = await fetch('/api/admin/servers', { headers: { 'x-admin-token': adminToken } });
                if (res.ok) showDashboard();
                else { sessionStorage.removeItem('adminToken'); adminToken = ''; }
            } catch (e) { sessionStorage.removeItem('adminToken'); adminToken = ''; }
        }

        function showDashboard() {
            document.getElementById('loginBox').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            document.getElementById('logoutBtn').style.display = 'inline-block';
            loadServers();
            loadUsers();
        }

        function doLogout() {
            adminToken = '';
            sessionStorage.removeItem('adminToken');
            document.getElementById('loginBox').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'none';
        }

        // â”€â”€â”€ ì„œë²„ ê´€ë¦¬ â”€â”€â”€

        async function loadServers() {
            try {
                const res = await fetch('/api/admin/servers', { headers: { 'x-admin-token': adminToken } });
                if (!res.ok) return;
                const servers = await res.json();
                document.getElementById('totalServers').textContent = servers.length;
                document.getElementById('activeServers').textContent = servers.filter(s => s.is_active).length;

                if (servers.length === 0) {
                    document.getElementById('serverList').innerHTML = '<div class="empty-state">ì„œë²„ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                    return;
                }
                document.getElementById('serverList').innerHTML = `
                    <table>
                        <thead><tr><th><input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)"></th><th>ID</th><th>ì´ë¦„</th><th>í˜¸ìŠ¤íŠ¸</th><th>ë©¤ë²„</th><th>ìƒíƒœ</th><th>ìƒì„±ì¼</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody>${servers.map(s => `
                            <tr>
                                <td><input type="checkbox" class="server-check" value="${s.id}" onchange="updateBulkBar()"></td>
                                <td>${s.id}</td>
                                <td>${esc(s.name)}</td>
                                <td>${esc(s.host_name)}</td>
                                <td>${s.member_count || 0}ëª…</td>
                                <td><span class="badge ${s.is_active ? 'badge-active' : 'badge-inactive'}">${s.is_active ? 'í™œì„±' : 'ë¹„í™œì„±'}</span></td>
                                <td>${new Date(s.created_at).toLocaleDateString('ko')}</td>
                                <td>
                                    <button class="btn-info" onclick="viewMembers(${s.id},'${esc(s.name)}')">ë©¤ë²„</button>
                                    <button class="btn-danger" onclick="deleteServer(${s.id},'${esc(s.name)}')">ì‚­ì œ</button>
                                </td>
                            </tr>`).join('')}
                        </tbody>
                    </table>`;
                clearSelection();
            } catch (e) {}
        }

        function toggleSelectAll(el) {
            document.querySelectorAll('.server-check').forEach(cb => cb.checked = el.checked);
            updateBulkBar();
        }

        function updateBulkBar() {
            const checked = document.querySelectorAll('.server-check:checked');
            const bar = document.getElementById('bulkBar');
            document.getElementById('selectedCount').textContent = checked.length;
            bar.style.display = checked.length > 0 ? 'flex' : 'none';
            const all = document.querySelectorAll('.server-check');
            const selectAll = document.getElementById('selectAll');
            if (selectAll) selectAll.checked = all.length > 0 && checked.length === all.length;
        }

        function clearSelection() {
            document.querySelectorAll('.server-check').forEach(cb => cb.checked = false);
            const selectAll = document.getElementById('selectAll');
            if (selectAll) selectAll.checked = false;
            document.getElementById('bulkBar').style.display = 'none';
        }

        async function bulkDeleteServers() {
            const ids = [...document.querySelectorAll('.server-check:checked')].map(cb => parseInt(cb.value));
            if (ids.length === 0) return;
            if (!confirm(`ì„ íƒí•œ ${ids.length}ê°œ ì„œë²„ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            try {
                const res = await fetch('/api/admin/servers/bulk-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-admin-token': adminToken },
                    body: JSON.stringify({ ids })
                });
                if (res.ok) {
                    const data = await res.json();
                    alert(`${data.deleted}ê°œ ì„œë²„ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    loadServers();
                } else alert('ì¼ê´„ ì‚­ì œ ì‹¤íŒ¨');
            } catch (e) { alert('ì¼ê´„ ì‚­ì œ ì‹¤íŒ¨'); }
        }

        async function deleteServer(id, name) {
            if (!confirm(`"${name}" ì„œë²„ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            try {
                const res = await fetch(`/api/admin/servers/${id}`, { method: 'DELETE', headers: { 'x-admin-token': adminToken } });
                if (res.ok) loadServers(); else alert('ì‚­ì œ ì‹¤íŒ¨');
            } catch (e) { alert('ì‚­ì œ ì‹¤íŒ¨'); }
        }

        async function viewMembers(serverId, serverName) {
            try {
                const res = await fetch(`/api/server/${serverId}/members`);
                const members = await res.json();
                let msg = `"${serverName}" ë©¤ë²„ (${members.length}ëª…)\n\n`;
                members.forEach(m => { msg += `${m.isOnline ? 'ğŸŸ¢' : 'âšª'} ${m.user_name}${m.is_approved ? '' : ' (ëŒ€ê¸°)'}\n`; });
                alert(msg);
            } catch (e) { alert('ë©¤ë²„ ì¡°íšŒ ì‹¤íŒ¨'); }
        }

        // â”€â”€â”€ ìœ ì € ê´€ë¦¬ â”€â”€â”€

        async function loadUsers() {
            try {
                const res = await fetch('/api/admin/users', { headers: { 'x-admin-token': adminToken } });
                if (!res.ok) return;
                const users = await res.json();
                document.getElementById('totalUsers').textContent = users.length;

                if (users.length === 0) {
                    document.getElementById('userList').innerHTML = '<div class="empty-state">ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                    return;
                }
                document.getElementById('userList').innerHTML = `
                    <table>
                        <thead><tr><th>ID</th><th>ì´ë¦„</th><th>ê´€ë¦¬ì</th><th>ê°€ì…ì¼</th><th>ë§ˆì§€ë§‰ ë¡œê·¸ì¸</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody>${users.map(u => `
                            <tr>
                                <td>${u.id}</td>
                                <td>${esc(u.name)}</td>
                                <td>${u.is_admin ? 'âœ…' : ''}</td>
                                <td>${new Date(u.created_at).toLocaleDateString('ko')}</td>
                                <td>${u.last_login_at ? new Date(u.last_login_at).toLocaleDateString('ko') : '-'}</td>
                                <td><button class="btn-danger" onclick="deleteUser(${u.id},'${esc(u.name)}')">ì‚­ì œ</button></td>
                            </tr>`).join('')}
                        </tbody>
                    </table>`;
            } catch (e) {}
        }

        async function deleteUser(id, name) {
            if (!confirm(`"${name}" ìœ ì €ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            try {
                const res = await fetch(`/api/admin/users/${id}`, { method: 'DELETE', headers: { 'x-admin-token': adminToken } });
                if (res.ok) { loadUsers(); loadServers(); } else alert('ì‚­ì œ ì‹¤íŒ¨');
            } catch (e) { alert('ì‚­ì œ ì‹¤íŒ¨'); }
        }

        function esc(str) {
            if (!str) return '';
            return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/'/g,'&#39;').replace(/"/g,'&quot;');
        }
    </script>
</body>
</html>
