<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ğŸ² íŒ€ ëœë¤ ë°°ì • - LAM</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .header-left h1 {
            margin: 0;
            text-align: left;
            color: #667eea;
            font-size: 2rem;
        }

        .header-right {
            text-align: right;
        }

        .connection-sound-row {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 6px;
        }
        .connection-sound-row .connection-status {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
        }
        .connection-sound-row .connection-status.connected { color: #28a745; background: transparent; }
        .connection-sound-row .connection-status.disconnected { color: #dc3545; background: transparent; }
        .connection-sound-row label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #555;
            cursor: pointer;
        }
        .connection-sound-row input[type="checkbox"] { width: auto; margin: 0; }

        .stats {
            font-size: 14px;
            color: #666;
        }

        .stats div {
            margin-bottom: 5px;
        }

        h3 {
            color: #333;
            margin-bottom: 15px;
        }

        h3 span {
            color: #667eea;
            font-size: 0.9em;
            font-weight: 600;
        }

        h4 {
            color: #555;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .section {
            margin-bottom: 20px;
        }

        .room-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .room-section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }

        .form-group label {
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }

        .form-group input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group input:focus {
            border-color: #667eea;
            outline: none;
        }

        .nickname-guide {
            font-size: 14px;
            color: #6c757d;
            font-style: italic;
        }

        .room-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .room-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .room-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .room-info h4 {
            margin: 0 0 5px 0;
            color: #667eea;
            font-size: 1.1rem;
        }

        .room-info p {
            margin: 3px 0;
            color: #666;
            font-size: 14px;
        }

        .empty-message {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 40px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5568d3;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-large {
            width: 100%;
            padding: 20px;
            font-size: 20px;
            margin-top: 10px;
        }

        /* ì„¸ì…˜ ì„¹ì…˜ */
        .session-info {
            text-align: center;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .role-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .role-badge.host {
            background: #667eea;
            color: white;
        }

        .role-badge.viewer {
            background: #6c757d;
            color: white;
        }

        .participants-section {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border: 2px solid #4CAF50;
            border-radius: 12px;
        }

        .participants-section h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1rem;
        }

        .participants-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .participant-badge {
            background: #E8F5E9;
            border: 1px solid #4CAF50;
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 14px;
            color: #2E7D32;
            font-weight: 500;
        }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .control-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .player-input,
        .team-config-input,
        .restriction-input {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        .player-input input,
        .team-config-input input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .player-input input:focus,
        .team-config-input input:focus {
            border-color: #667eea;
            outline: none;
        }

        .player-input-guide {
            margin-top: 8px;
            font-size: 12px;
            color: #6c757d;
            font-style: italic;
        }

        #players-list,
        #team-config-list,
        #restrictions-list {
            margin-bottom: 15px;
        }

        .player-item,
        .team-item,
        .restriction-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #ddd;
        }

        .player-item strong,
        .team-item strong,
        .restriction-item strong {
            color: #667eea;
        }

        /* ì²´í¬ë°•ìŠ¤ ì˜ì—­ */
        .checkbox-area {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 8px;
            padding: 10px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .checkbox-area label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .checkbox-area label:hover {
            background-color: #f0f0f0;
        }

        .checkbox-area input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* ê²°ê³¼ ì„¹ì…˜ */
        #result-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            display: none;
        }

        #result-message {
            text-align: center;
            padding: 15px;
            background: #d4edda;
            color: #155724;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        #result-message.error {
            background: #f8d7da;
            color: #721c24;
        }

        #result-teams {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .result-team {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 3px solid #667eea;
        }

        .result-team h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3rem;
            text-align: center;
        }

        .result-team ul {
            list-style: none;
        }

        .result-team li {
            padding: 8px 12px;
            background: #f8f9fa;
            margin-bottom: 6px;
            border-radius: 6px;
            font-weight: 500;
        }

        /* ë‹¤ë¥¸ ê²Œì„ ë§í¬ */
        .other-games {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .other-games a {
            color: #667eea;
            text-decoration: none;
            margin: 0 15px;
            font-weight: 500;
        }

        .other-games a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-right {
                margin-top: 10px;
                text-align: left;
            }

            .player-input,
            .team-config-input,
            .restriction-input {
                flex-direction: column;
            }

            .room-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            #result-teams {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Gaegu:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/team-pastel.css">
</head>
<body>
    <!-- ë¡œë”© í™”ë©´ -->
    <div id="loadingScreen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #10b981 0%, #059669 100%); z-index: 9999; flex-direction: column; justify-content: center; align-items: center;">
        <div style="text-align: center; color: white;">
            <div style="font-size: 80px; margin-bottom: 20px; animation: bounce 1s infinite;">ğŸ‘¥</div>
            <h2 style="font-size: 24px; margin-bottom: 10px;">ë°©ì— ì…ì¥ ì¤‘...</h2>
            <p style="font-size: 16px; opacity: 0.8;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
            <div style="margin-top: 30px;">
                <div style="width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
            </div>
        </div>
    </div>
    <style>
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
    </style>

    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>ğŸ² íŒ€ ëœë¤ ë°°ì •</h1>
            </div>
            <div class="header-right">
                <div class="connection-sound-row">
                    <span class="connection-status connected" id="teamConnectionStatus">â— ì—°ê²°ë¨</span>
                    <label><input type="checkbox" id="teamSoundCheckbox"> ğŸ”Š ì‚¬ìš´ë“œ</label>
                    <button type="button" id="ui-toggle-btn" class="ui-toggle-btn">ğŸ¨ OFF</button>
                </div>
                <div class="stats">
                    <div>í™œì„± ë°©: <span id="active-room-count">0</span>ê°œ</div>
                </div>
            </div>
        </div>

        <!-- ëœë”© ì„¹ì…˜ -->
        <div id="landing-section" class="section">
            <!-- ë‹‰ë„¤ì„ ì…ë ¥ -->
            <div class="room-section">
                <h2>ë‹‰ë„¤ì„ ì…ë ¥</h2>
                <div class="form-group">
                    <label for="nickname-input">ë‹‰ë„¤ì„</label>
                    <input type="text" id="nickname-input" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="20">
            </div>
                <p class="nickname-guide">ğŸ’¡ ë‹‰ë„¤ì„ì„ ì…ë ¥í•œ í›„ ë°©ì„ ìƒì„±í•˜ê±°ë‚˜ ì…ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            
            <!-- ë°© ë§Œë“¤ê¸° -->
            <div class="room-section">
                <h2>ë°© ë§Œë“¤ê¸°</h2>
                <div class="form-group">
                    <label for="room-name-input">ë°© ì´ë¦„</label>
                    <input type="text" id="room-name-input" placeholder="ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="30">
                </div>
                <button type="button" id="create-room-btn" class="btn btn-primary btn-large">ë°© ìƒì„±í•˜ê¸°</button>
            </div>
            
            <!-- ë°© ëª©ë¡ -->
            <div class="room-section">
                <div class="room-list-header">
                    <h2>ë°© ëª©ë¡</h2>
                    <button type="button" id="refresh-rooms-btn" class="btn btn-secondary">ìƒˆë¡œê³ ì¹¨</button>
                </div>
                <div id="room-list" class="room-list">
                    <p class="empty-message">ìƒì„±ëœ ë°©ì´ ì—†ìŠµë‹ˆë‹¤</p>
            </div>
            </div>

            <!-- ë‹¤ë¥¸ ê²Œì„ ë§í¬ -->
            <div class="other-games">
                <a href="/dice-game-multiplayer.html">ğŸ² ì£¼ì‚¬ìœ„ ê²Œì„</a>
                <a href="/roulette-game-multiplayer.html">ğŸ° ë£°ë › ê²Œì„</a>
                </div>
            </div>

        <!-- ì„¸ì…˜ ì„¹ì…˜ -->
        <div id="session-section" class="section" style="display: none;">
            <div class="session-info">
                <div class="session-header">
                    <div>
                        <h3>ë°©: <span id="current-room-name"></span></h3>
                        <p>í˜¸ìŠ¤íŠ¸: <span id="current-host-name"></span></p>
                        <p class="role-badge" id="role-badge"></p>
                </div>
                    <div>
                        <button type="button" id="leave-room-btn" class="btn btn-secondary">ë‚˜ê°€ê¸°</button>
                        <button type="button" id="delete-room-btn" class="btn btn-danger" style="display: none;">ë°© ì‚­ì œ</button>
            </div>
            </div>
                <div class="participants-section">
                    <h4>ì°¸ê°€ì ëª©ë¡ (<span id="participants-count">0</span>ëª…)</h4>
                    <div id="participants-list" class="participants-list"></div>
                </div>
            </div>

            <!-- í˜¸ìŠ¤íŠ¸ ì»¨íŠ¸ë¡¤ -->
            <div id="host-controls">
                <!-- Pastel UI Tab Navigation -->
                <div id="pastel-tabs">
                    <button type="button" class="pastel-tab active" data-panel="panel-players">ğŸ‘¥ í”Œë ˆì´ì–´</button>
                    <button type="button" class="pastel-tab" data-panel="panel-teams">âš™ï¸ íŒ€ êµ¬ì„±</button>
                    <button type="button" class="pastel-tab" data-panel="panel-restrictions">ğŸš« ì œì•½ì¡°ê±´</button>
                </div>

                <!-- 1. í”Œë ˆì´ì–´ ì„¤ì • -->
                <div id="panel-players" class="control-panel">
                    <h3>1ï¸âƒ£ í”Œë ˆì´ì–´ ì„¤ì • <span id="player-count-badge">(ì´ 0ëª…)</span></h3>
                    <div id="players-list"></div>
                    <div class="player-input">
                        <input type="text" id="player-name-input" placeholder="í”Œë ˆì´ì–´ ì´ë¦„ (ì˜ˆ: ì´ë”,í˜ì´ì»¤,Lip,êµ¬ë§ˆìœ ì‹œ ë“±ë“±)">
                        <button type="button" id="add-player-btn" class="btn btn-primary">í”Œë ˆì´ì–´ ì¶”ê°€</button>
                    </div>
                    <p class="player-input-guide">ğŸ’¡ ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„í•˜ì—¬ ì—¬ëŸ¬ ëª…ì„ í•œ ë²ˆì— ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
            </div>

                <!-- 2. íŒ€ êµ¬ì„± ì„¤ì • -->
                <div id="panel-teams" class="control-panel">
                    <h3>2ï¸âƒ£ íŒ€ êµ¬ì„± ì„¤ì • <span id="team-assignment-badge">(0/0)</span></h3>
                    <div id="team-config-list"></div>
                    <div class="team-config-input">
                        <input type="text" id="team-name-input" placeholder="íŒ€ ì´ë¦„">
                        <input type="number" id="team-size-input" placeholder="ì¸ì›" min="1" style="width: 80px;">
                        <button type="button" id="add-team-btn" class="btn btn-primary">íŒ€ ì¶”ê°€</button>
                    </div>
                    <div style="margin-top: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">í•„ìˆ˜ í”Œë ˆì´ì–´ ì„ íƒ:</label>
                        <div id="required-players-checkboxes" class="checkbox-area"></div>
                        <button type="button" id="add-required-players-btn" class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;">í•„ìˆ˜ í”Œë ˆì´ì–´ ì¶”ê°€</button>
                </div>
            </div>

                <!-- 3. ê°™ì€ íŒ€ ê¸ˆì§€ ì„¤ì • -->
                <div id="panel-restrictions" class="control-panel">
                    <h3>3ï¸âƒ£ ê°™ì€ íŒ€ ê¸ˆì§€ ì„¤ì •</h3>
                    <div id="restrictions-list"></div>
                    <div style="margin-top: 10px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">ê°™ì€ íŒ€ì— ë“¤ì–´ê°€ë©´ ì•ˆ ë˜ëŠ” í”Œë ˆì´ì–´ ì„ íƒ (2ëª… ì´ìƒ):</label>
                        <div id="restriction-players-checkboxes" class="checkbox-area"></div>
                        <button type="button" id="add-restriction-btn" class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;">ì œì•½ ì¶”ê°€</button>
                </div>
            </div>

                <!-- íŒ€ ë°°ì • ë²„íŠ¼ -->
                <div class="control-panel">
                    <button type="button" id="assign-teams-btn" class="btn btn-success btn-large">ğŸ² íŒ€ ë°°ì •í•˜ê¸°</button>
                    <div id="team-assignment-count" style="text-align: center; margin-top: 10px; color: #666; font-size: 14px;"></div>
                    <button type="button" id="reset-btn" class="btn btn-secondary" style="display: none; width: 100%; margin-top: 10px;">ì´ˆê¸°í™”</button>
                </div>
            </div>

            <!-- ê²°ê³¼ ì„¹ì…˜ -->
            <div id="result-section" class="section">
                <h3>ğŸ‰ ë°°ì • ê²°ê³¼</h3>
                <div id="result-message"></div>
                <div id="result-teams"></div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/assets/sounds/sound-manager.js"></script>
    <script>
        // ë””ë²„ê·¸ ë¡œê·¸ í•¨ìˆ˜
        function debugLog(msg) {
            console.log('[TEAM DEBUG]', msg);
        }
        
        // ì†Œì¼“ ì—°ê²° (polling ìš°ì„ ìœ¼ë¡œ ì•ˆì •ì„± í™•ë³´)
        const socket = io({
            transports: ['polling', 'websocket'],
            upgrade: true,
            reconnection: true,
            reconnectionAttempts: Infinity,
            reconnectionDelay: 500,
            reconnectionDelayMax: 5000,
            timeout: 30000,
            forceNew: false
        });
        
        debugLog('ğŸš€ ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘ë¨');

        // ìƒíƒœ ë³€ìˆ˜ (localStorageì—ì„œ ë³µì›)
        let currentRoomId = sessionStorage.getItem('teamCurrentRoomId') || null;
        let isHost = sessionStorage.getItem('teamIsHost') === 'true';
        let currentUsers = [];
        let sessionData = {
            players: [],
            teamConfig: [],
            restrictions: [],
            restrictionGroups: [],
            result: null
        };
        let currentTeamIndexForRequiredPlayers = null;
        
        // ìƒíƒœ ì €ì¥ í•¨ìˆ˜
        function saveRoomState() {
            if (currentRoomId) {
                sessionStorage.setItem('teamCurrentRoomId', currentRoomId);
                sessionStorage.setItem('teamIsHost', isHost.toString());
            } else {
                sessionStorage.removeItem('teamCurrentRoomId');
                sessionStorage.removeItem('teamIsHost');
            }
        }
        
        // ìƒíƒœ ì´ˆê¸°í™” í•¨ìˆ˜
        function clearRoomState() {
            currentRoomId = null;
            isHost = false;
            sessionStorage.removeItem('teamCurrentRoomId');
            sessionStorage.removeItem('teamIsHost');
        }

        // DOM ìš”ì†Œ
        const landingSection = document.getElementById('landing-section');
        const sessionSection = document.getElementById('session-section');
        const nicknameInput = document.getElementById('nickname-input');
        const roomNameInput = document.getElementById('room-name-input');
        const createRoomBtn = document.getElementById('create-room-btn');
        const refreshRoomsBtn = document.getElementById('refresh-rooms-btn');
        const roomList = document.getElementById('room-list');
        const activeRoomCount = document.getElementById('active-room-count');
        const currentRoomName = document.getElementById('current-room-name');
        const currentHostName = document.getElementById('current-host-name');
        const roleBadge = document.getElementById('role-badge');
        const hostControls = document.getElementById('host-controls');
        const participantsList = document.getElementById('participants-list');
        const participantsCount = document.getElementById('participants-count');
        const leaveRoomBtn = document.getElementById('leave-room-btn');
        const deleteRoomBtn = document.getElementById('delete-room-btn');

        // í˜¸ìŠ¤íŠ¸ ì»¨íŠ¸ë¡¤ ìš”ì†Œ
        const playersList = document.getElementById('players-list');
        const playerCountBadge = document.getElementById('player-count-badge');
        const playerNameInput = document.getElementById('player-name-input');
        const addPlayerBtn = document.getElementById('add-player-btn');
        const teamConfigList = document.getElementById('team-config-list');
        const teamAssignmentBadge = document.getElementById('team-assignment-badge');
        const teamNameInput = document.getElementById('team-name-input');
        const teamSizeInput = document.getElementById('team-size-input');
        const addTeamBtn = document.getElementById('add-team-btn');
        const requiredPlayersCheckboxes = document.getElementById('required-players-checkboxes');
        const addRequiredPlayersBtn = document.getElementById('add-required-players-btn');
        const restrictionsList = document.getElementById('restrictions-list');
        const restrictionPlayersCheckboxes = document.getElementById('restriction-players-checkboxes');
        const addRestrictionBtn = document.getElementById('add-restriction-btn');
        const assignTeamsBtn = document.getElementById('assign-teams-btn');
        const teamAssignmentCount = document.getElementById('team-assignment-count');
        const resetBtn = document.getElementById('reset-btn');

        // ê²°ê³¼ ìš”ì†Œ
        const resultSection = document.getElementById('result-section');
        const resultMessage = document.getElementById('result-message');
        const resultTeams = document.getElementById('result-teams');

        // ë””ë°”ì´ìŠ¤ ID
        function getDeviceId() {
            let deviceId = localStorage.getItem('teamDeviceId');
            if (!deviceId) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('teamDeviceId', deviceId);
            }
            return deviceId;
        }

        // localStorageì—ì„œ ë‹‰ë„¤ì„ ë¶ˆëŸ¬ì˜¤ê¸°
        const savedNickname = localStorage.getItem('teamUserName');
        if (savedNickname && nicknameInput) {
            nicknameInput.value = savedNickname;
            updateRoomNameFromNickname();
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°©ì— ìˆì—ˆë‹¤ë©´ ì„¸ì…˜ í™”ë©´ ë¨¼ì € í‘œì‹œ (ê¹œë¹¡ì„ ë°©ì§€)
        if (currentRoomId) {
            console.log('í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ë°© ì •ë³´ ë°œê²¬:', currentRoomId);
            landingSection.style.display = 'none';
            sessionSection.style.display = 'block';
        }

        function updateRoomNameFromNickname() {
            if (!nicknameInput || !roomNameInput) return;
            const nickname = nicknameInput.value.trim();
            if (nickname && !roomNameInput.value.trim()) {
                roomNameInput.value = `${nickname}ì˜ ë°©ì…ë‹ˆë‹¤`;
            }
        }

        // ë‹‰ë„¤ì„ ì…ë ¥ ì‹œ ì €ì¥
        if (nicknameInput) {
            nicknameInput.addEventListener('input', () => {
                localStorage.setItem('teamUserName', nicknameInput.value.trim());
                if (roomNameInput && !roomNameInput.value.trim()) {
                    updateRoomNameFromNickname();
                }
            });
        }
        
        debugLog('ğŸ“Œ DOM ìš”ì†Œ ë¡œë“œ ì™„ë£Œ');
        debugLog('createRoomBtn: ' + (createRoomBtn ? 'ì°¾ìŒ' : 'ì—†ìŒ'));

        // ë°© ìƒì„±
        createRoomBtn.addEventListener('click', () => {
            debugLog('ğŸ”˜ ë°© ìƒì„± ë²„íŠ¼ í´ë¦­!');
            debugLog('socket.connected: ' + socket.connected);
            debugLog('socket.id: ' + socket.id);
            
            const nickname = nicknameInput.value.trim();
            let roomName = roomNameInput.value.trim();

            if (!nickname) {
                debugLog('âŒ ë‹‰ë„¤ì„ ì—†ìŒ');
                alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”');
                nicknameInput.focus();
                return;
            }

            if (!roomName) {
                roomName = `${nickname}ì˜ ë°©ì…ë‹ˆë‹¤`;
            }

            localStorage.setItem('teamUserName', nickname);

            debugLog('ğŸ“¤ createRoom emit ì‹œì‘...');
            debugLog('userName: ' + nickname + ', roomName: ' + roomName);
            
            socket.emit('createRoom', {
                userName: nickname,
                roomName: roomName,
                isPrivate: false,
                password: '',
                gameType: 'team',
                expiryHours: 3,
                blockIPPerUser: false,
                deviceId: getDeviceId()
            });
            
            debugLog('âœ… createRoom emit ì™„ë£Œ!');
        });

        // Enter í‚¤ë¡œ ë°© ìƒì„±
        roomNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                createRoomBtn.click();
            }
        });

        debugLog('âœ… ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');

        // ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        refreshRoomsBtn.addEventListener('click', () => {
            socket.emit('getRooms');
        });

        // ë°© ë‚˜ê°€ê¸°
        leaveRoomBtn.addEventListener('click', () => {
            if (confirm('ì •ë§ ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                socket.emit('leaveRoom');
            }
        });

        // ë°© ì‚­ì œ (í˜¸ìŠ¤íŠ¸ë§Œ)
        deleteRoomBtn.addEventListener('click', () => {
            if (confirm('ì •ë§ ì´ ë°©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëª¨ë“  ì°¸ê°€ìê°€ ë‚˜ê°€ê²Œ ë©ë‹ˆë‹¤.')) {
                socket.emit('leaveRoom');
            }
        });

        // í”Œë ˆì´ì–´ ì¶”ê°€
        addPlayerBtn.addEventListener('click', () => {
            const input = playerNameInput.value.trim();
            if (!input) {
                alert('í”Œë ˆì´ì–´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            const names = input.split(',').map(n => n.trim()).filter(n => n.length > 0);
            if (names.length === 0) {
                alert('í”Œë ˆì´ì–´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            const newPlayers = [...sessionData.players];
            const duplicateNames = [];
            const addedNames = [];

            names.forEach(name => {
                if (sessionData.players.includes(name)) {
                    duplicateNames.push(name);
                } else {
                    newPlayers.push(name);
                    addedNames.push(name);
                }
            });

            if (duplicateNames.length > 0) {
                alert(`ì´ë¯¸ ì¶”ê°€ëœ í”Œë ˆì´ì–´: ${duplicateNames.join(', ')}`);
            }

            if (addedNames.length > 0) {
                socket.emit('updateTeamPlayers', { players: newPlayers });
            }

            playerNameInput.value = '';
        });

        playerNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addPlayerBtn.click();
            }
        });

        // íŒ€ ì¶”ê°€
        addTeamBtn.addEventListener('click', () => {
            const totalPlayers = sessionData.players.length;
            const assignedPlayers = sessionData.teamConfig.reduce((sum, t) => sum + (t.size || t.count || 0), 0);
            const remainingPlayers = totalPlayers - assignedPlayers;

            if (remainingPlayers === 0 && totalPlayers > 0) {
                alert('íŒ€ êµ¬ì„±ì´ ì´ë¯¸ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                return;
            }

            let name = teamNameInput.value.trim();
            const size = parseInt(teamSizeInput.value);

            if (!size || size < 1) {
                alert('ì¸ì›ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            if (!name) {
                const teamCount = sessionData.teamConfig.length;
                name = `${teamCount + 1}íŒ€`;
            }

            if (size > remainingPlayers && remainingPlayers > 0) {
                alert(`ë‚¨ì€ ì¸ì›(${remainingPlayers}ëª…)ë³´ë‹¤ ë§ì€ ì¸ì›ì„ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                return;
            }

            const newConfig = [...sessionData.teamConfig, { name, size, requiredPlayers: [] }];
            socket.emit('updateTeamConfig', { config: newConfig });

            teamNameInput.value = '';
            teamSizeInput.value = '';
        });

        // í•„ìˆ˜ í”Œë ˆì´ì–´ ì¶”ê°€
        addRequiredPlayersBtn.addEventListener('click', () => {
            if (currentTeamIndexForRequiredPlayers === null) {
                alert('ë¨¼ì € íŒ€ì„ ì„ íƒí•˜ì„¸ìš”. íŒ€ í•­ëª©ì˜ "í•„ìˆ˜ í”Œë ˆì´ì–´ ì„¤ì •" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.');
                return;
            }

            const selectedPlayers = [];
            const checkboxes = requiredPlayersCheckboxes.querySelectorAll('input[type="checkbox"]:checked:not(:disabled)');
            checkboxes.forEach(cb => selectedPlayers.push(cb.value));

            if (selectedPlayers.length === 0) {
                alert('í•„ìˆ˜ í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            const team = sessionData.teamConfig[currentTeamIndexForRequiredPlayers];
            if (!team) {
                currentTeamIndexForRequiredPlayers = null;
                return;
            }

            const currentRequired = team.requiredPlayers || [];
            const newRequired = [...new Set([...currentRequired, ...selectedPlayers])];

            if (newRequired.length > (team.size || team.count)) {
                alert(`í•„ìˆ˜ í”Œë ˆì´ì–´ ìˆ˜ê°€ íŒ€ ì¸ì›(${team.size || team.count}ëª…)ë³´ë‹¤ ë§ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                return;
            }

            const newConfig = [...sessionData.teamConfig];
            newConfig[currentTeamIndexForRequiredPlayers] = {
                ...team,
                requiredPlayers: newRequired
            };

            socket.emit('updateTeamConfig', { config: newConfig });

            checkboxes.forEach(cb => cb.checked = false);
            currentTeamIndexForRequiredPlayers = null;
            addRequiredPlayersBtn.textContent = 'í•„ìˆ˜ í”Œë ˆì´ì–´ ì¶”ê°€';
        });

        // ì œì•½ ì¡°ê±´ ì¶”ê°€
        addRestrictionBtn.addEventListener('click', () => {
            const checkboxes = restrictionPlayersCheckboxes.querySelectorAll('input[type="checkbox"]:checked');
            const selectedPlayers = Array.from(checkboxes).map(cb => cb.value);

            if (selectedPlayers.length < 2) {
                alert('ìµœì†Œ 2ëª… ì´ìƒ ì„ íƒí•˜ì„¸ìš”');
                return;
            }

            const sortedPlayers = [...selectedPlayers].sort((a, b) => a.localeCompare(b, 'ko'));

            // ì„ íƒëœ í”Œë ˆì´ì–´ë“¤ ê°„ì˜ ëª¨ë“  ìŒ ìƒì„±
            const newRestrictions = [...sessionData.restrictions];
            let addedCount = 0;

            for (let i = 0; i < sortedPlayers.length; i++) {
                for (let j = i + 1; j < sortedPlayers.length; j++) {
                    const exists = newRestrictions.some(r =>
                        (r[0] === sortedPlayers[i] && r[1] === sortedPlayers[j]) ||
                        (r[0] === sortedPlayers[j] && r[1] === sortedPlayers[i])
                    );
                    if (!exists) {
                        newRestrictions.push([sortedPlayers[i], sortedPlayers[j]]);
                        addedCount++;
                    }
                }
            }

            if (addedCount === 0) {
                alert('ì„ íƒí•œ í”Œë ˆì´ì–´ë“¤ ê°„ì˜ ì œì•½ ì¡°ê±´ì´ ì´ë¯¸ ëª¨ë‘ ì¶”ê°€ë˜ì–´ ìˆìŠµë‹ˆë‹¤');
                return;
            }

            const newGroups = [...(sessionData.restrictionGroups || [])];
            newGroups.push({ members: sortedPlayers });

            socket.emit('updateTeamRestrictions', {
                restrictions: newRestrictions,
                restrictionGroups: newGroups
            });

            checkboxes.forEach(cb => cb.checked = false);
        });

        // íŒ€ ë°°ì • ì‹¤í–‰
        assignTeamsBtn.addEventListener('click', () => {
            if (sessionData.players.length === 0) {
                alert('í”Œë ˆì´ì–´ë¥¼ ë¨¼ì € ì„¤ì •í•˜ì„¸ìš”');
                return;
            }

            if (sessionData.teamConfig.length === 0) {
                alert('íŒ€ êµ¬ì„±ì„ ë¨¼ì € ì„¤ì •í•˜ì„¸ìš”');
                return;
            }

            const totalSlots = sessionData.teamConfig.reduce((sum, t) => sum + (t.size || t.count || 0), 0);
            if (sessionData.players.length !== totalSlots) {
                alert(`í”Œë ˆì´ì–´ ìˆ˜(${sessionData.players.length})ì™€ íŒ€ ì¸ì› ìˆ˜(${totalSlots})ê°€ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
                return;
            }

            socket.emit('assignTeams');
        });

        // ê²°ê³¼ ì´ˆê¸°í™”
        resetBtn.addEventListener('click', () => {
            if (confirm('ê²°ê³¼ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                socket.emit('resetTeamResult');
            }
        });

        // ë°© ì°¸ê°€ í•¨ìˆ˜
        function joinRoom(roomId) {
            const nickname = nicknameInput.value.trim();
            if (!nickname) {
                alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”');
                nicknameInput.focus();
                return;
            }

            localStorage.setItem('teamUserName', nickname);

            socket.emit('joinRoom', {
                roomId: roomId,
                userName: nickname,
                isHost: false,
                password: '',
                deviceId: getDeviceId()
            });
        }
        window.joinRoom = joinRoom;

        // í”Œë ˆì´ì–´ ì‚­ì œ
        function removePlayer(index) {
            const newPlayers = sessionData.players.filter((_, i) => i !== index);
            socket.emit('updateTeamPlayers', { players: newPlayers });
        }
        window.removePlayer = removePlayer;

        // íŒ€ ì‚­ì œ
        function removeTeam(index) {
            if (currentTeamIndexForRequiredPlayers === index) {
                currentTeamIndexForRequiredPlayers = null;
                addRequiredPlayersBtn.textContent = 'í•„ìˆ˜ í”Œë ˆì´ì–´ ì¶”ê°€';
            }
            const newConfig = sessionData.teamConfig.filter((_, i) => i !== index);
            socket.emit('updateTeamConfig', { config: newConfig });
        }
        window.removeTeam = removeTeam;

        // í•„ìˆ˜ í”Œë ˆì´ì–´ íŒ€ ì„ íƒ
        function selectTeamForRequiredPlayers(teamIndex) {
            currentTeamIndexForRequiredPlayers = teamIndex;
            updateRequiredPlayersCheckboxes();
            const team = sessionData.teamConfig[teamIndex];
            if (team) {
                addRequiredPlayersBtn.textContent = `${team.name}ì— í•„ìˆ˜ í”Œë ˆì´ì–´ ì¶”ê°€`;
            }
        }
        window.selectTeamForRequiredPlayers = selectTeamForRequiredPlayers;

        // ì œì•½ ê·¸ë£¹ ì‚­ì œ
        function removeRestrictionGroup(groupIndex) {
            if (!sessionData.restrictionGroups || groupIndex >= sessionData.restrictionGroups.length) return;

            const group = sessionData.restrictionGroups[groupIndex];
            const newGroups = sessionData.restrictionGroups.filter((_, i) => i !== groupIndex);

            // í•´ë‹¹ ê·¸ë£¹ì˜ ì œì•½ ì¡°ê±´ ì œê±°
            const newRestrictions = sessionData.restrictions.filter(r => {
                const isInGroup = group.members.includes(r[0]) && group.members.includes(r[1]);
                if (!isInGroup) return true;

                // ë‹¤ë¥¸ ê·¸ë£¹ì—ë„ ì†í•´ìˆìœ¼ë©´ ìœ ì§€
                return newGroups.some(g => g.members.includes(r[0]) && g.members.includes(r[1]));
            });

            socket.emit('updateTeamRestrictions', {
                restrictions: newRestrictions,
                restrictionGroups: newGroups
            });
        }
        window.removeRestrictionGroup = removeRestrictionGroup;

        // UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤
        function updateRoomList(rooms) {
            if (!roomList) return;
            roomList.innerHTML = '';

            const teamRooms = rooms.filter(r => r.gameType === 'team');

            if (teamRooms.length === 0) {
                roomList.innerHTML = '<p class="empty-message">ìƒì„±ëœ ë°©ì´ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }

            if (activeRoomCount) {
                activeRoomCount.textContent = teamRooms.length;
            }

            teamRooms.forEach(room => {
                const roomItem = document.createElement('div');
                roomItem.className = 'room-item';
                roomItem.innerHTML = `
                    <div class="room-info">
                        <h4>${room.roomName}</h4>
                        <p>í˜¸ìŠ¤íŠ¸: ${room.hostName || 'ì•Œ ìˆ˜ ì—†ìŒ'}</p>
                        <p>ì°¸ê°€ì: ${room.playerCount}ëª…</p>
                    </div>
                    <button class="btn btn-primary" onclick="joinRoom('${room.roomId}')">ì°¸ê°€</button>
                `;
                roomList.appendChild(roomItem);
            });
        }

        function showSession(hostName, roomName) {
            debugLog('ğŸ”„ showSession í˜¸ì¶œ - hostName: ' + hostName + ', roomName: ' + roomName);
            landingSection.style.display = 'none';
            sessionSection.style.display = 'block';
            debugLog('âœ… ì„¸ì…˜ í™”ë©´ í‘œì‹œë¨!');

            if (currentHostName) currentHostName.textContent = hostName || 'ì•Œ ìˆ˜ ì—†ìŒ';
            if (currentRoomName) currentRoomName.textContent = roomName || 'ë°©';

            if (isHost) {
                roleBadge.textContent = 'í˜¸ìŠ¤íŠ¸';
                roleBadge.className = 'role-badge host';
                if (deleteRoomBtn) deleteRoomBtn.style.display = 'block';
            } else {
                roleBadge.textContent = 'ê´€ì „ì';
                roleBadge.className = 'role-badge viewer';
                if (deleteRoomBtn) deleteRoomBtn.style.display = 'none';
            }

            updateHostUI();
        }

        function updateParticipants() {
            if (!participantsList || !participantsCount) return;
            participantsCount.textContent = currentUsers.length;
            participantsList.innerHTML = '';

            if (currentUsers.length === 0) {
                participantsList.innerHTML = '<p class="empty-message">ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }

            currentUsers.forEach(user => {
                const badge = document.createElement('div');
                badge.className = 'participant-badge';
                const hostIcon = user.isHost ? 'ğŸ‘‘ ' : '';
                badge.textContent = `${hostIcon}${user.name}`;
                participantsList.appendChild(badge);
            });
        }

        function updateHostUI() {
            // í˜¸ìŠ¤íŠ¸ê°€ ì•„ë‹ˆë©´ ì…ë ¥ ìš”ì†Œ ìˆ¨ê¸°ê¸°
            if (!isHost) {
                const inputs = hostControls.querySelectorAll('input');
                inputs.forEach(el => el.style.display = 'none');

                const buttons = hostControls.querySelectorAll('#add-player-btn, #add-team-btn, #add-restriction-btn, #assign-teams-btn, #reset-btn, #add-required-players-btn');
                buttons.forEach(btn => btn.style.display = 'none');

                const guide = hostControls.querySelector('.player-input-guide');
                if (guide) guide.style.display = 'none';
            } else {
                const elements = hostControls.querySelectorAll('input, button, .player-input-guide');
                elements.forEach(el => el.style.display = '');
            }

            // í”Œë ˆì´ì–´ ëª©ë¡
            playerCountBadge.textContent = `(ì´ ${sessionData.players.length}ëª…)`;
            playersList.innerHTML = '';
            sessionData.players.forEach((player, index) => {
                const div = document.createElement('div');
                div.className = 'player-item';
                const deleteBtn = isHost ? `<button class="btn btn-danger" onclick="removePlayer(${index})">ì‚­ì œ</button>` : '';
                div.innerHTML = `<span><strong>${player}</strong></span>${deleteBtn}`;
                playersList.appendChild(div);
            });

            // íŒ€ êµ¬ì„± ë°°ì§€
            const totalPlayers = sessionData.players.length;
            const assignedPlayers = sessionData.teamConfig.reduce((sum, t) => sum + (t.size || t.count || 0), 0);
            const remaining = totalPlayers - assignedPlayers;
            teamAssignmentBadge.textContent = `(${remaining}/${totalPlayers})`;
            teamAssignmentBadge.style.color = remaining === 0 ? '#28a745' : remaining < 0 ? '#dc3545' : '#667eea';

            // íŒ€ ëª©ë¡
            teamConfigList.innerHTML = '';
            sessionData.teamConfig.forEach((team, index) => {
                const div = document.createElement('div');
                div.className = 'team-item';
                const size = team.size || team.count || 0;
                const required = team.requiredPlayers && team.requiredPlayers.length > 0
                    ? ` (í•„ìˆ˜: ${team.requiredPlayers.join(', ')})`
                    : '';
                const deleteBtn = isHost ? `<button class="btn btn-danger" onclick="removeTeam(${index})">ì‚­ì œ</button>` : '';
                const requiredBtn = isHost ? `<button class="btn btn-secondary" onclick="selectTeamForRequiredPlayers(${index})" style="margin-right: 5px;">í•„ìˆ˜ í”Œë ˆì´ì–´ ì„¤ì •</button>` : '';
                div.innerHTML = `
                    <span><strong>${team.name}</strong> - ${size}ëª…${required}</span>
                    <div>${requiredBtn}${deleteBtn}</div>
                `;
                teamConfigList.appendChild(div);
            });

            // ì œì•½ ì¡°ê±´ ëª©ë¡
            updateRestrictionsList();

            // ì²´í¬ë°•ìŠ¤ ì˜ì—­ ì—…ë°ì´íŠ¸
            updateRequiredPlayersCheckboxes();
            updateRestrictionCheckboxes();

            // ê²½ìš°ì˜ ìˆ˜ ê³„ì‚°
            updateTeamAssignmentCount();
        }

        function updateRequiredPlayersCheckboxes() {
            if (!requiredPlayersCheckboxes) return;
            requiredPlayersCheckboxes.innerHTML = '';

            if (sessionData.players.length === 0) {
                requiredPlayersCheckboxes.innerHTML = '<p style="color: #999; font-style: italic; text-align: center; padding: 20px;">í”Œë ˆì´ì–´ë¥¼ ë¨¼ì € ì¶”ê°€í•˜ì„¸ìš”</p>';
                return;
            }

            // ì´ë¯¸ ì„ íƒëœ í”Œë ˆì´ì–´ ë§µ
            const playerTeamMap = new Map();
            sessionData.teamConfig.forEach(team => {
                if (team.requiredPlayers) {
                    team.requiredPlayers.forEach(p => playerTeamMap.set(p, team.name));
                }
            });

            sessionData.players.forEach(player => {
                const isAlreadySelected = playerTeamMap.has(player);
                const currentTeam = currentTeamIndexForRequiredPlayers !== null
                    ? sessionData.teamConfig[currentTeamIndexForRequiredPlayers]
                    : null;
                const isInCurrentTeam = currentTeam && currentTeam.requiredPlayers && currentTeam.requiredPlayers.includes(player);
                const isDisabled = isAlreadySelected && !isInCurrentTeam;

                const label = document.createElement('label');
                const statusText = isDisabled ? ` (${playerTeamMap.get(player)})` : '';
                label.innerHTML = `
                    <input type="checkbox" value="${player}" ${isDisabled ? 'disabled' : ''} style="opacity: ${isDisabled ? '0.5' : '1'}">
                    <span style="opacity: ${isDisabled ? '0.5' : '1'}">${player}${statusText}</span>
                `;
                requiredPlayersCheckboxes.appendChild(label);
            });
        }

        function updateRestrictionCheckboxes() {
            if (!restrictionPlayersCheckboxes) return;
            restrictionPlayersCheckboxes.innerHTML = '';

            if (sessionData.players.length === 0) {
                restrictionPlayersCheckboxes.innerHTML = '<p style="color: #999; font-style: italic; text-align: center; padding: 20px;">í”Œë ˆì´ì–´ë¥¼ ë¨¼ì € ì¶”ê°€í•˜ì„¸ìš”</p>';
                return;
            }

            sessionData.players.forEach(player => {
                const label = document.createElement('label');
                label.innerHTML = `
                    <input type="checkbox" value="${player}">
                    <span>${player}</span>
                `;
                restrictionPlayersCheckboxes.appendChild(label);
            });
        }

        function updateRestrictionsList() {
            if (!restrictionsList) return;
            restrictionsList.innerHTML = '';

            if (!sessionData.restrictionGroups || sessionData.restrictionGroups.length === 0) {
                restrictionsList.innerHTML = '<p style="color: #999; font-style: italic; text-align: center; padding: 10px;">ì œì•½ ì¡°ê±´ì´ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }

            sessionData.restrictionGroups.forEach((group, index) => {
                if (!group.members || group.members.length === 0) return;

                const sortedMembers = [...group.members].sort((a, b) => a.localeCompare(b, 'ko'));
                const div = document.createElement('div');
                div.className = 'restriction-item';
                const deleteBtn = isHost ? `<button class="btn btn-danger" onclick="removeRestrictionGroup(${index})">ì‚­ì œ</button>` : '';
                div.innerHTML = `
                    <span><strong>${sortedMembers.join(', ')}</strong> (ê°™ì€ íŒ€ ë¶ˆê°€)</span>
                    ${deleteBtn}
                `;
                restrictionsList.appendChild(div);
            });
        }

        function updateTeamAssignmentCount() {
            if (!teamAssignmentCount) return;

            const players = sessionData.players;
            const teamConfig = sessionData.teamConfig;
            const restrictions = sessionData.restrictions;

            if (players.length === 0 || teamConfig.length === 0) {
                teamAssignmentCount.textContent = '';
                    return;
                }

            const totalSlots = teamConfig.reduce((sum, t) => sum + (t.size || t.count || 0), 0);
            if (players.length !== totalSlots) {
                teamAssignmentCount.textContent = '';
                return;
            }

            // ê°„ë‹¨í•œ ê²½ìš°ì˜ ìˆ˜ ê³„ì‚° (íŒ©í† ë¦¬ì–¼ ê¸°ë°˜)
            const factorial = n => n <= 1 ? 1 : n * factorial(n - 1);
            let denominator = 1;
            teamConfig.forEach(t => {
                const size = t.size || t.count || 0;
                const requiredCount = t.requiredPlayers ? t.requiredPlayers.length : 0;
                denominator *= factorial(size - requiredCount);
            });

            const remainingPlayers = players.length - teamConfig.reduce((sum, t) => (t.requiredPlayers ? t.requiredPlayers.length : 0), 0);
            const combinations = Math.floor(factorial(remainingPlayers) / denominator);

            teamAssignmentCount.textContent = `(ì´ ${combinations.toLocaleString('ko-KR')}ê°€ì§€)`;
        }

        function showResult(result) {
            resultSection.style.display = 'block';
            if (isHost) resetBtn.style.display = 'block';

            if (result.success) {
                resultMessage.className = '';
                resultMessage.textContent = result.message || `${result.attempts || 1}ë²ˆ ì‹œë„ í›„ ì„±ê³µ`;

                resultTeams.innerHTML = '';
                result.teams.forEach(team => {
                    const sortedMembers = [...team.members].sort((a, b) => a.localeCompare(b, 'ko'));
                    const div = document.createElement('div');
                    div.className = 'result-team';
                    div.innerHTML = `
                        <h4>${team.name}</h4>
                        <ul>
                            ${sortedMembers.map(m => `<li>${m}</li>`).join('')}
                        </ul>
                    `;
                    resultTeams.appendChild(div);
                });
                    } else {
                resultMessage.className = 'error';
                resultMessage.innerHTML = 'âŒ ' + (result.message || result.error || 'íŒ€ ë°°ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                resultTeams.innerHTML = '';
            }
        }

        function hideResult() {
            resultSection.style.display = 'none';
            resetBtn.style.display = 'none';
        }

        // ì†Œì¼“ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        socket.on('connect', () => {
            const el = document.getElementById('teamConnectionStatus');
            if (el) { el.textContent = 'â— ì—°ê²°ë¨'; el.className = 'connection-status connected'; }
            debugLog('ğŸŸ¢ ì„œë²„ ì—°ê²°ë¨!');
            debugLog('socket.id: ' + socket.id);
            socket.emit('getRooms');
            
            // URLì— createRoom=trueê°€ ìˆê³  pendingTeamRoomì´ ìˆìœ¼ë©´ ë°© ìë™ ìƒì„±
            const urlParams = new URLSearchParams(window.location.search);
            const shouldCreateRoom = urlParams.get('createRoom') === 'true';
            const pendingRoomData = localStorage.getItem('pendingTeamRoom');
            
            debugLog('createRoom íŒŒë¼ë¯¸í„°: ' + shouldCreateRoom);
            debugLog('pendingTeamRoom: ' + (pendingRoomData ? 'ìˆìŒ' : 'ì—†ìŒ'));
            
            if (shouldCreateRoom && pendingRoomData) {
                try {
                    const roomData = JSON.parse(pendingRoomData);
                    debugLog('ğŸ  ìë™ ë°© ìƒì„± ì‹œì‘: ' + roomData.roomName);
                    
                    // pendingTeamRoom ì‚­ì œ (ì¤‘ë³µ ìƒì„± ë°©ì§€)
                    localStorage.removeItem('pendingTeamRoom');
                    
                    // URLì—ì„œ createRoom íŒŒë¼ë¯¸í„° ì œê±°
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    // ë‹‰ë„¤ì„ ì…ë ¥ë€ì— ê°’ ì„¤ì •
                    if (nicknameInput) nicknameInput.value = roomData.userName;
                    if (roomNameInput) roomNameInput.value = roomData.roomName;
                    
                    // ë°© ìƒì„± ìš”ì²­
                    socket.emit('createRoom', {
                        userName: roomData.userName,
                        roomName: roomData.roomName,
                        isPrivate: roomData.isPrivate || false,
                        password: roomData.password || '',
                        gameType: 'team',
                        expiryHours: roomData.expiryHours || 3,
                        blockIPPerUser: roomData.blockIPPerUser || false,
                        deviceId: getDeviceId()
                    });
                    
                    debugLog('âœ… ë°© ìƒì„± ìš”ì²­ ì™„ë£Œ!');
                    return; // ë‹¤ë¥¸ ì²˜ë¦¬ ê±´ë„ˆë›°ê¸°
                } catch (e) {
                    debugLog('âŒ pendingTeamRoom íŒŒì‹± ì˜¤ë¥˜: ' + e.message);
                    localStorage.removeItem('pendingTeamRoom');
                }
            }
            
            // URLì— joinRoom=trueê°€ ìˆê³  pendingTeamJoinì´ ìˆìœ¼ë©´ ë°© ìë™ ì…ì¥
            const shouldJoinRoom = urlParams.get('joinRoom') === 'true';
            const pendingJoinData = localStorage.getItem('pendingTeamJoin');
            
            if (shouldJoinRoom && pendingJoinData) {
                try {
                    const joinData = JSON.parse(pendingJoinData);
                    debugLog('ğŸšª ìë™ ë°© ì…ì¥ ì‹œì‘: ' + joinData.roomId);
                    
                    // pendingTeamJoin ì‚­ì œ (ì¤‘ë³µ ì…ì¥ ë°©ì§€)
                    localStorage.removeItem('pendingTeamJoin');
                    
                    // URLì—ì„œ joinRoom íŒŒë¼ë¯¸í„° ì œê±°
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    // ì—ëŸ¬ ì‹œ ëŒì•„ê°ˆ í”Œë˜ê·¸ ì €ì¥
                    sessionStorage.setItem('teamFromDice', 'true');
                    
                    // ë¡œë”© í™”ë©´ í‘œì‹œ
                    document.getElementById('loadingScreen').style.display = 'flex';
                    landingSection.style.display = 'none';
                    
                    // ë‹‰ë„¤ì„ ì…ë ¥ë€ì— ê°’ ì„¤ì •
                    if (nicknameInput) nicknameInput.value = joinData.userName;
                    
                    // ë¹„ê³µê°œ ë°©ì¸ ê²½ìš° ë¹„ë°€ë²ˆí˜¸ ì…ë ¥
                    let password = '';
                    if (joinData.isPrivate) {
                        password = prompt('ğŸ”’ ë¹„ê³µê°œ ë°©ì…ë‹ˆë‹¤.\në¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:');
                        if (password === null) {
                            // ì·¨ì†Œì‹œ ì£¼ì‚¬ìœ„ ë©”ì¸ìœ¼ë¡œ
                            sessionStorage.removeItem('teamFromDice');
                            window.location.href = '/dice-game-multiplayer.html';
                            return;
                        }
                    }
                    
                    // ë°© ì…ì¥ ìš”ì²­
                    socket.emit('joinRoom', {
                        roomId: joinData.roomId,
                        userName: joinData.userName,
                        isHost: false,
                        password: password,
                        deviceId: getDeviceId()
                    });
                    
                    debugLog('âœ… ë°© ì…ì¥ ìš”ì²­ ì™„ë£Œ!');
                    return; // ë‹¤ë¥¸ ì²˜ë¦¬ ê±´ë„ˆë›°ê¸°
                } catch (e) {
                    debugLog('âŒ pendingTeamJoin íŒŒì‹± ì˜¤ë¥˜: ' + e.message);
                    localStorage.removeItem('pendingTeamJoin');
                }
            }
            
            // sessionStorageì—ì„œ ë°© ì •ë³´ ë³µì›
            const savedRoomId = sessionStorage.getItem('teamCurrentRoomId');
            const savedIsHost = sessionStorage.getItem('teamIsHost') === 'true';
            debugLog('ì €ì¥ëœ ë°©: ' + savedRoomId);
            
            // ë°©ì— ìˆì—ˆë‹¤ë©´ ì¬ì—°ê²° ì‹œë„
            if (savedRoomId) {
                const nickname = localStorage.getItem('teamUserName') || '';
                if (nickname) {
                    debugLog('ğŸ”„ ë°© ì¬ì—°ê²° ì‹œë„: ' + savedRoomId);
                    currentRoomId = savedRoomId;
                    isHost = savedIsHost;
                    
                    socket.emit('joinRoom', {
                        roomId: savedRoomId,
                        userName: nickname,
                        isHost: savedIsHost,
                        password: '',
                        deviceId: getDeviceId()
                    });
                }
            }
        });

        socket.on('disconnect', (reason) => {
            const el = document.getElementById('teamConnectionStatus');
            if (el) { el.textContent = 'â— ì—°ê²° ëŠê¹€'; el.className = 'connection-status disconnected'; }
            debugLog('ğŸ”´ ì—°ê²° ëŠê¹€: ' + reason);
            // ì¬ì—°ê²°ì„ ìœ„í•´ ìƒíƒœ ìœ ì§€ (ë°”ë¡œ ëœë”©ìœ¼ë¡œ ëŒì•„ê°€ì§€ ì•ŠìŒ)
        });

        socket.on('roomsList', (rooms) => {
            updateRoomList(rooms);
        });

        socket.on('roomsListUpdated', (rooms) => {
            updateRoomList(rooms);
        });

        socket.on('roomCreated', (data) => {
            debugLog('ğŸ‰ roomCreated ì´ë²¤íŠ¸ ìˆ˜ì‹ !');
            debugLog('roomId: ' + data.roomId);
            debugLog('gameType: ' + data.gameType);
            currentRoomId = data.roomId;
            isHost = true;
            saveRoomState(); // ìƒíƒœ ì €ì¥
            debugLog('âœ… ë°© ìƒì„± ì™„ë£Œ! ì„¸ì…˜ í™”ë©´ìœ¼ë¡œ ì „í™˜...');
            
            const hostName = nicknameInput.value.trim() || data.userName;
            currentUsers = [{ name: hostName, isHost: true, id: socket.id }];
            
            sessionData = {
                players: data.teamPlayers || [],
                teamConfig: (data.teamConfig || []).map(c => ({
                    name: c.name,
                    size: c.size || c.count || 0,
                    requiredPlayers: c.requiredPlayers || []
                })),
                restrictions: data.teamRestrictions || [],
                restrictionGroups: data.teamRestrictionGroups || [],
                result: null
            };

            // ëœë”© ì„¹ì…˜ ìˆ¨ê¸°ê³  ì„¸ì…˜ ì„¹ì…˜ í‘œì‹œ
            landingSection.style.display = 'none';
            sessionSection.style.display = 'block';
            
            // í˜¸ìŠ¤íŠ¸ ì •ë³´ í‘œì‹œ
            if (currentHostName) currentHostName.textContent = hostName;
            if (currentRoomName) currentRoomName.textContent = data.roomName || 'ë°©';
            
            // ì—­í•  ë°°ì§€
            roleBadge.textContent = 'í˜¸ìŠ¤íŠ¸';
            roleBadge.className = 'role-badge host';
            if (deleteRoomBtn) deleteRoomBtn.style.display = 'block';
            
            updateParticipants();
            updateHostUI();
            
            console.log('ë°© ìƒì„± ì™„ë£Œ, ì„¸ì…˜ ì§„ì…:', data.roomId);
        });

        socket.on('roomJoined', (data) => {
            debugLog('ğŸ“¥ roomJoined ì´ë²¤íŠ¸ ìˆ˜ì‹ !');
            debugLog('roomId: ' + data.roomId + ', isHost: ' + data.isHost);
            
            // ì„±ê³µ ì‹œ ì—ëŸ¬ í”Œë˜ê·¸ ì œê±°
            sessionStorage.removeItem('teamFromDice');
            
            // ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê¸°
            document.getElementById('loadingScreen').style.display = 'none';
            
            currentRoomId = data.roomId;
            isHost = data.isHost;
            saveRoomState(); // ìƒíƒœ ì €ì¥
            currentUsers = data.gameState?.users || [];
            
            // íŒ€ ë°°ì • ë°ì´í„° ë¡œë“œ
            sessionData = {
                players: data.teamPlayers || [],
                teamConfig: (data.teamConfig || []).map(c => ({
                    name: c.name,
                    size: c.size || c.count || 0,
                    requiredPlayers: c.requiredPlayers || []
                })),
                restrictions: data.teamRestrictions || [],
                restrictionGroups: data.teamRestrictionGroups || [],
                result: data.teamResult || null
            };

            // ì„¸ì…˜ í™”ë©´ìœ¼ë¡œ ì „í™˜
            landingSection.style.display = 'none';
            sessionSection.style.display = 'block';
            
            showSession(data.gameState?.users?.find(u => u.isHost)?.name || 'ì•Œ ìˆ˜ ì—†ìŒ', data.roomName);
            updateParticipants();

            if (sessionData.result && sessionData.result.success) {
                showResult(sessionData.result);
            }
            
            console.log('ë°© ì…ì¥ ì™„ë£Œ, ì„¸ì…˜ ì§„ì…:', data.roomId);
        });

        socket.on('roomLeft', () => {
            clearRoomState(); // ìƒíƒœ ì´ˆê¸°í™”
            currentUsers = [];
            sessionData = { players: [], teamConfig: [], restrictions: [], restrictionGroups: [], result: null };
            // ì£¼ì‚¬ìœ„ ë©”ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™
            window.location.href = '/dice-game-multiplayer.html';
        });

        socket.on('roomDeleted', (data) => {
            alert(data.message || 'ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            clearRoomState(); // ìƒíƒœ ì´ˆê¸°í™”
            // ì£¼ì‚¬ìœ„ ë©”ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™
            window.location.href = '/dice-game-multiplayer.html';
        });

        socket.on('roomError', (message) => {
            debugLog('âŒ roomError: ' + message);
            
            // ë‹¤ë¥¸ í˜ì´ì§€ì—ì„œ ì˜¨ ê²½ìš° ì£¼ì‚¬ìœ„ ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°
            const fromDice = sessionStorage.getItem('teamFromDice');
            if (fromDice === 'true') {
                sessionStorage.removeItem('teamFromDice');
                alert(message);
                window.location.href = '/dice-game-multiplayer.html';
                return;
            }
            
            // ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê³  ë¡œë¹„ ë³´ì—¬ì£¼ê¸°
            document.getElementById('loadingScreen').style.display = 'none';
            landingSection.style.display = 'block';
            alert(message);
            
            // ë°©ì´ ì—†ë‹¤ëŠ” ì˜¤ë¥˜ë©´ ìƒíƒœ ì´ˆê¸°í™”
            if (message.includes('ì°¾ì„ ìˆ˜ ì—†') || message.includes('ì¡´ì¬í•˜ì§€ ì•Š') || message.includes('ì¤‘ë³µ')) {
                clearRoomState();
                sessionSection.style.display = 'none';
            }
        });

        socket.on('updateUsers', (users) => {
            if (window.SoundManager) SoundManager.playSound('common_notification', getTeamSoundEnabled());
            currentUsers = users;
            updateParticipants();
            
            // í˜¸ìŠ¤íŠ¸ ë³€ê²½ í™•ì¸
            const me = users.find(u => u.id === socket.id);
            if (me && me.isHost !== isHost) {
                isHost = me.isHost;
                showSession(users.find(u => u.isHost)?.name, currentRoomName?.textContent);
                if (isHost) alert('í˜¸ìŠ¤íŠ¸ ê¶Œí•œì´ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        });

        socket.on('teamPlayersUpdated', (players) => {
            sessionData.players = players;
            updateHostUI();
        });

        socket.on('teamConfigUpdated', (config) => {
            sessionData.teamConfig = config.map(c => ({
                name: c.name,
                size: c.size || c.count || 0,
                requiredPlayers: c.requiredPlayers || []
            }));
            updateHostUI();
        });

        socket.on('teamRestrictionsUpdated', (restrictions) => {
            sessionData.restrictions = restrictions;
            updateHostUI();
        });

        socket.on('teamRestrictionGroupsUpdated', (data) => {
            sessionData.restrictionGroups = data.restrictionGroups || [];
            if (data.restrictions) {
                sessionData.restrictions = data.restrictions;
            }
            updateHostUI();
        });

        socket.on('teamAssigned', (result) => {
            sessionData.result = result;
            showResult(result);
        });

        socket.on('teamResultReset', () => {
            sessionData.result = null;
            hideResult();
        });

        socket.on('teamError', (message) => {
            alert(message);
        });

        socket.on('newMessage', (data) => {
            // ì±„íŒ… ë©”ì‹œì§€ (ì±„íŒ… UI ì¶”ê°€ ì‹œ ChatModule.initìœ¼ë¡œ ì—°ê²° ê°€ëŠ¥)
        });

        // ì‚¬ìš´ë“œ ì²´í¬ë°•ìŠ¤ (ê¸°ë³¸ ë”, localStorage)
        const TEAM_SOUND_KEY = 'teamSoundEnabled';
        function getTeamSoundEnabled() { return localStorage.getItem(TEAM_SOUND_KEY) === 'true'; }
        function setTeamSoundCheckbox() {
            const c = document.getElementById('teamSoundCheckbox');
            if (c) c.checked = getTeamSoundEnabled();
        }
        document.addEventListener('DOMContentLoaded', () => {
            setTeamSoundCheckbox();
            const tc = document.getElementById('teamSoundCheckbox');
            if (tc) tc.addEventListener('change', () => {
                localStorage.setItem(TEAM_SOUND_KEY, tc.checked ? 'true' : 'false');
            });
        });

        // === Pastel Forest UI Toggle ===
        (function() {
            const UI_KEY = 'teamPastelUI';
            const toggleBtn = document.getElementById('ui-toggle-btn');
            const tabsEl = document.getElementById('pastel-tabs');
            let pastelOn = localStorage.getItem(UI_KEY) === 'true';
            let activeTab = 'panel-players';
            const panelIds = ['panel-players', 'panel-teams', 'panel-restrictions'];

            function setPastel(on) {
                pastelOn = on;
                localStorage.setItem(UI_KEY, on ? 'true' : 'false');
                document.body.classList.toggle('pastel-ui', on);
                toggleBtn.textContent = on ? 'ğŸ¨ ON' : 'ğŸ¨ OFF';
                toggleBtn.classList.toggle('active', on);

                if (on) {
                    switchTab(activeTab);
                } else {
                    panelIds.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.style.display = '';
                    });
                }
            }

            function switchTab(panelId) {
                activeTab = panelId;
                tabsEl.querySelectorAll('.pastel-tab').forEach(t => {
                    t.classList.toggle('active', t.dataset.panel === panelId);
                });
                panelIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = (pastelOn && id !== panelId) ? 'none' : '';
                });
            }

            toggleBtn.addEventListener('click', () => setPastel(!pastelOn));

            tabsEl.querySelectorAll('.pastel-tab').forEach(t => {
                t.addEventListener('click', () => {
                    if (pastelOn) switchTab(t.dataset.panel);
                });
            });

            setPastel(pastelOn);
        })();
    </script>
</body>
</html>
