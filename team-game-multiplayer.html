<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>íŒ€ ëœë¤ ë°°ì • - LAM</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/js/tailwind-config.js"></script>
    <link rel="stylesheet" href="/css/shared.css">
    <style>
        body { background: linear-gradient(170deg, #e8ecf4 0%, #f0f2f7 40%, #f7f5f2 100%); }
        .tab-btn { position: relative; }
        .tab-btn.active { color: #4f46e5; }
        .tab-btn.active::after {
            content: ''; position: absolute; bottom: -1px; left: 0; right: 0;
            height: 2px; background: #4f46e5; border-radius: 1px;
        }
        .tab-btn .dot {
            width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-left: 4px;
        }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; animation: fadeIn 0.2s ease-out; }
    </style>
</head>
<body class="min-h-screen font-body text-slate-700">

    <!-- Loading -->
    <div id="loadingScreen" class="loading-overlay">
        <div class="text-center text-white">
            <div class="text-7xl mb-5 animate-bounce">ğŸ‘¥</div>
            <h2 class="text-xl font-semibold mb-2">ë°©ì— ì…ì¥ ì¤‘...</h2>
            <p class="text-sm text-white/60">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
            <div class="mt-8"><div class="loading-spinner mx-auto"></div></div>
        </div>
    </div>

    <div class="max-w-xl mx-auto px-4 pt-8 pb-12">

        <!-- ======== LANDING ======== -->
        <div id="landing-section">

            <!-- Hero -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-display text-slate-800 mb-1">íŒ€ ë°°ì •</h1>
                <p class="text-sm text-slate-400">ê³µì •í•œ ëœë¤ íŒ€ ë°°ì •</p>
            </div>

            <!-- Quick start card -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
                    <div>
                        <label for="nickname-input" class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">ë‹‰ë„¤ì„</label>
                        <input type="text" id="nickname-input" placeholder="ì´ë¦„ ì…ë ¥" maxlength="20"
                               class="w-full px-3.5 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-slate-800
                                      placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500/30 focus:border-indigo-400 transition text-[15px]">
                    </div>
                    <div>
                        <label for="room-name-input" class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">ë°© ì´ë¦„</label>
                        <input type="text" id="room-name-input" placeholder="ë°© ì´ë¦„ ì…ë ¥" maxlength="30"
                               class="w-full px-3.5 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-slate-800
                                      placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500/30 focus:border-indigo-400 transition text-[15px]">
                    </div>
                </div>
                <button type="button" id="create-room-btn"
                        class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800
                               text-white font-bold rounded-xl transition shadow-md shadow-indigo-200 text-[15px]">
                    ë°© ë§Œë“¤ê¸°
                </button>
            </div>

            <!-- Room list -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <div class="flex items-center justify-between px-5 py-3 border-b border-slate-100">
                    <span class="text-sm font-bold text-slate-700">ë°© ëª©ë¡</span>
                    <div class="flex items-center gap-3">
                        <span class="text-xs text-slate-400"><span id="active-room-count" class="font-bold text-slate-600">0</span>ê°œ</span>
                        <button type="button" id="refresh-rooms-btn"
                                class="text-xs font-bold text-indigo-600 hover:text-indigo-800 transition">ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                </div>
                <div id="room-list">
                    <p class="text-center text-slate-400 text-sm py-10">ìƒì„±ëœ ë°©ì´ ì—†ìŠµë‹ˆë‹¤</p>
                </div>
            </div>

            <!-- Status + links -->
            <div class="flex items-center justify-between mt-4 px-1">
                <span id="teamConnectionStatus" class="flex items-center gap-1.5 text-xs text-emerald-600">
                    <span class="status-dot connected"></span>ì—°ê²°ë¨
                </span>
                <div class="flex gap-4 text-xs">
                    <a href="/dice-game-multiplayer.html" class="text-slate-400 hover:text-indigo-600 transition">ì£¼ì‚¬ìœ„</a>
                    <a href="/roulette-game-multiplayer.html" class="text-slate-400 hover:text-indigo-600 transition">ë£°ë ›</a>
                </div>
                <label class="flex items-center gap-1 text-xs text-slate-400 cursor-pointer">
                    <input type="checkbox" id="teamSoundCheckbox" class="w-3.5 h-3.5 rounded border-slate-300 text-indigo-600">
                    ì‚¬ìš´ë“œ
                </label>
            </div>
        </div>

        <!-- ======== SESSION ======== -->
        <div id="session-section" style="display: none;">

            <!-- Compact room bar -->
            <div class="flex items-center justify-between bg-white rounded-xl shadow px-4 py-2.5 mb-3">
                <div class="flex items-center gap-2 min-w-0">
                    <span class="text-sm font-bold text-slate-800 truncate" id="current-room-name"></span>
                    <span id="role-badge" class="role-badge shrink-0"></span>
                </div>
                <div class="flex items-center gap-2 shrink-0">
                    <span class="text-xs text-slate-400">í˜¸ìŠ¤íŠ¸: <span id="current-host-name" class="font-semibold text-slate-600"></span></span>
                    <button type="button" id="leave-room-btn" class="text-xs font-bold text-slate-400 hover:text-slate-700 transition">ë‚˜ê°€ê¸°</button>
                    <button type="button" id="delete-room-btn" style="display:none;" class="text-xs font-bold text-red-500 hover:text-red-700 transition">ì‚­ì œ</button>
                </div>
            </div>

            <!-- Participants row -->
            <div class="flex items-center gap-2 flex-wrap bg-white/60 rounded-xl px-4 py-2.5 mb-4">
                <span class="text-xs font-bold text-slate-500 shrink-0">ì°¸ê°€ì <span id="participants-count" class="text-indigo-600">0</span></span>
                <div id="participants-list" class="flex flex-wrap gap-1.5"></div>
            </div>

            <!-- Result (shown above tabs when available) -->
            <div id="result-section" style="display:none;" class="mb-4">
                <div class="bg-white rounded-2xl shadow-lg p-5 border-l-4 border-indigo-500">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-base font-bold text-slate-800">ë°°ì • ê²°ê³¼</h3>
                        <button type="button" id="reset-btn" style="display:none;"
                                class="text-xs font-bold text-slate-400 hover:text-red-500 transition">ì´ˆê¸°í™”</button>
                    </div>
                    <div id="result-message" class="text-center px-3 py-2 rounded-lg text-sm font-semibold mb-4"></div>
                    <div id="result-teams" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
                </div>
            </div>

            <!-- Tab navigation -->
            <div id="host-controls">
                <div class="flex border-b border-slate-200 bg-white rounded-t-2xl px-2">
                    <button type="button" class="tab-btn active flex items-center gap-1 px-4 py-3 text-sm font-bold transition" data-tab="tab-players">
                        í”Œë ˆì´ì–´ <span id="player-count-badge" class="text-xs font-normal text-slate-400">0</span>
                    </button>
                    <button type="button" class="tab-btn flex items-center gap-1 px-4 py-3 text-sm font-bold text-slate-400 transition" data-tab="tab-teams">
                        íŒ€ êµ¬ì„± <span id="team-assignment-badge" class="text-xs font-normal">(0/0)</span>
                    </button>
                    <button type="button" class="tab-btn flex items-center gap-1 px-4 py-3 text-sm font-bold text-slate-400 transition" data-tab="tab-restrict">
                        ì œì•½ì¡°ê±´
                    </button>
                </div>

                <div class="bg-white rounded-b-2xl shadow-lg">

                    <!-- TAB 1: Players -->
                    <div id="tab-players" class="tab-panel active p-5">
                        <div id="players-list" class="space-y-1 mb-3"></div>
                        <div class="player-input flex gap-2">
                            <input type="text" id="player-name-input" placeholder="ì´ë¦„ (ì‰¼í‘œë¡œ ì—¬ëŸ¬ëª…)"
                                   class="flex-1 px-3.5 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm text-slate-800
                                          placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500/30 focus:border-indigo-400 transition">
                            <button type="button" id="add-player-btn"
                                    class="px-5 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold rounded-xl transition shrink-0">ì¶”ê°€</button>
                        </div>
                        <p class="player-input-guide text-[11px] text-slate-400 mt-1.5">ì‰¼í‘œ(,)ë¡œ ì—¬ëŸ¬ ëª… í•œ ë²ˆì— ì¶”ê°€ ê°€ëŠ¥</p>
                    </div>

                    <!-- TAB 2: Team config -->
                    <div id="tab-teams" class="tab-panel p-5">
                        <div id="team-config-list" class="space-y-1 mb-3"></div>
                        <div class="team-config-input flex gap-2 mb-4">
                            <input type="text" id="team-name-input" placeholder="íŒ€ ì´ë¦„"
                                   class="flex-1 px-3.5 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm text-slate-800
                                          placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500/30 focus:border-indigo-400 transition">
                            <input type="number" id="team-size-input" placeholder="ì¸ì›" min="1"
                                   class="w-20 px-3.5 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm text-slate-800 text-center
                                          placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500/30 focus:border-indigo-400 transition">
                            <button type="button" id="add-team-btn"
                                    class="px-5 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold rounded-xl transition shrink-0">ì¶”ê°€</button>
                        </div>
                        <div class="border-t border-slate-100 pt-3">
                            <p class="text-xs font-bold text-slate-500 mb-2">í•„ìˆ˜ í”Œë ˆì´ì–´ ì„ íƒ</p>
                            <div id="required-players-checkboxes"
                                 class="grid grid-cols-2 sm:grid-cols-3 gap-0.5 p-2.5 bg-slate-50 border border-slate-200 rounded-xl max-h-36 overflow-y-auto mb-2"></div>
                            <button type="button" id="add-required-players-btn"
                                    class="px-3.5 py-1.5 text-xs font-bold text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-lg transition">í•„ìˆ˜ í”Œë ˆì´ì–´ ì¶”ê°€</button>
                        </div>
                    </div>

                    <!-- TAB 3: Restrictions -->
                    <div id="tab-restrict" class="tab-panel p-5">
                        <div id="restrictions-list" class="space-y-1 mb-3"></div>
                        <p class="text-xs font-bold text-slate-500 mb-2">ê°™ì€ íŒ€ ë¶ˆê°€ í”Œë ˆì´ì–´ (2ëª… ì´ìƒ)</p>
                        <div id="restriction-players-checkboxes"
                             class="grid grid-cols-2 sm:grid-cols-3 gap-0.5 p-2.5 bg-slate-50 border border-slate-200 rounded-xl max-h-36 overflow-y-auto mb-2"></div>
                        <button type="button" id="add-restriction-btn"
                                class="px-3.5 py-1.5 text-xs font-bold text-red-600 bg-red-50 hover:bg-red-100 rounded-lg transition">ì œì•½ ì¶”ê°€</button>
                    </div>
                </div>

                <!-- Action button (always visible below tabs) -->
                <div class="mt-3">
                    <button type="button" id="assign-teams-btn"
                            class="w-full py-3.5 bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800
                                   text-white font-bold text-[15px] rounded-xl transition shadow-md shadow-indigo-200">
                        íŒ€ ë°°ì •í•˜ê¸°
                    </button>
                    <div id="team-assignment-count" class="text-center mt-1.5 text-xs text-slate-400"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/assets/sounds/sound-manager.js"></script>
    <script>
        function debugLog(msg) { console.log('[TEAM DEBUG]', msg); }

        // --- Tab logic ---
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('active'); b.classList.add('text-slate-400'); });
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                btn.classList.add('active');
                btn.classList.remove('text-slate-400');
                document.getElementById(btn.dataset.tab).classList.add('active');
            });
        });

        const socket = io({
            transports: ['polling', 'websocket'], upgrade: true, reconnection: true,
            reconnectionAttempts: Infinity, reconnectionDelay: 500, reconnectionDelayMax: 5000, timeout: 30000, forceNew: false
        });

        let currentRoomId = sessionStorage.getItem('teamCurrentRoomId') || null;
        let isHost = sessionStorage.getItem('teamIsHost') === 'true';
        let currentUsers = [];
        let sessionData = { players: [], teamConfig: [], restrictions: [], restrictionGroups: [], result: null };
        let currentTeamIndexForRequiredPlayers = null;

        function saveRoomState() { if (currentRoomId) { sessionStorage.setItem('teamCurrentRoomId', currentRoomId); sessionStorage.setItem('teamIsHost', isHost.toString()); } else { sessionStorage.removeItem('teamCurrentRoomId'); sessionStorage.removeItem('teamIsHost'); } }
        function clearRoomState() { currentRoomId = null; isHost = false; sessionStorage.removeItem('teamCurrentRoomId'); sessionStorage.removeItem('teamIsHost'); }

        const landingSection = document.getElementById('landing-section');
        const sessionSection = document.getElementById('session-section');
        const nicknameInput = document.getElementById('nickname-input');
        const roomNameInput = document.getElementById('room-name-input');
        const createRoomBtn = document.getElementById('create-room-btn');
        const refreshRoomsBtn = document.getElementById('refresh-rooms-btn');
        const roomList = document.getElementById('room-list');
        const activeRoomCount = document.getElementById('active-room-count');
        const currentRoomName = document.getElementById('current-room-name');
        const currentHostName = document.getElementById('current-host-name');
        const roleBadge = document.getElementById('role-badge');
        const hostControls = document.getElementById('host-controls');
        const participantsList = document.getElementById('participants-list');
        const participantsCount = document.getElementById('participants-count');
        const leaveRoomBtn = document.getElementById('leave-room-btn');
        const deleteRoomBtn = document.getElementById('delete-room-btn');
        const playersList = document.getElementById('players-list');
        const playerCountBadge = document.getElementById('player-count-badge');
        const playerNameInput = document.getElementById('player-name-input');
        const addPlayerBtn = document.getElementById('add-player-btn');
        const teamConfigList = document.getElementById('team-config-list');
        const teamAssignmentBadge = document.getElementById('team-assignment-badge');
        const teamNameInput = document.getElementById('team-name-input');
        const teamSizeInput = document.getElementById('team-size-input');
        const addTeamBtn = document.getElementById('add-team-btn');
        const requiredPlayersCheckboxes = document.getElementById('required-players-checkboxes');
        const addRequiredPlayersBtn = document.getElementById('add-required-players-btn');
        const restrictionsList = document.getElementById('restrictions-list');
        const restrictionPlayersCheckboxes = document.getElementById('restriction-players-checkboxes');
        const addRestrictionBtn = document.getElementById('add-restriction-btn');
        const assignTeamsBtn = document.getElementById('assign-teams-btn');
        const teamAssignmentCount = document.getElementById('team-assignment-count');
        const resetBtn = document.getElementById('reset-btn');
        const resultSection = document.getElementById('result-section');
        const resultMessage = document.getElementById('result-message');
        const resultTeams = document.getElementById('result-teams');

        function getDeviceId() { let d = localStorage.getItem('teamDeviceId'); if (!d) { d = 'device_'+Date.now()+'_'+Math.random().toString(36).substr(2,9); localStorage.setItem('teamDeviceId', d); } return d; }

        const savedNickname = localStorage.getItem('teamUserName');
        if (savedNickname && nicknameInput) { nicknameInput.value = savedNickname; updateRoomNameFromNickname(); }
        if (currentRoomId) { landingSection.style.display = 'none'; sessionSection.style.display = 'block'; }

        function updateRoomNameFromNickname() { if (!nicknameInput||!roomNameInput) return; const n = nicknameInput.value.trim(); if (n && !roomNameInput.value.trim()) roomNameInput.value = `${n}ì˜ ë°©ì…ë‹ˆë‹¤`; }
        if (nicknameInput) nicknameInput.addEventListener('input', () => { localStorage.setItem('teamUserName', nicknameInput.value.trim()); if (roomNameInput && !roomNameInput.value.trim()) updateRoomNameFromNickname(); });

        createRoomBtn.addEventListener('click', () => {
            const nickname = nicknameInput.value.trim(); let roomName = roomNameInput.value.trim();
            if (!nickname) { alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”'); nicknameInput.focus(); return; }
            if (!roomName) roomName = `${nickname}ì˜ ë°©ì…ë‹ˆë‹¤`;
            localStorage.setItem('teamUserName', nickname);
            socket.emit('createRoom', { userName: nickname, roomName, isPrivate: false, password: '', gameType: 'team', expiryHours: 3, blockIPPerUser: false, deviceId: getDeviceId() });
        });
        roomNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') createRoomBtn.click(); });
        refreshRoomsBtn.addEventListener('click', () => socket.emit('getRooms'));
        leaveRoomBtn.addEventListener('click', () => { if (confirm('ì •ë§ ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) socket.emit('leaveRoom'); });
        deleteRoomBtn.addEventListener('click', () => { if (confirm('ì •ë§ ì´ ë°©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëª¨ë“  ì°¸ê°€ìê°€ ë‚˜ê°€ê²Œ ë©ë‹ˆë‹¤.')) socket.emit('leaveRoom'); });

        addPlayerBtn.addEventListener('click', () => {
            const input = playerNameInput.value.trim(); if (!input) { alert('í”Œë ˆì´ì–´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
            const names = input.split(',').map(n=>n.trim()).filter(n=>n.length>0); if (!names.length) { alert('í”Œë ˆì´ì–´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
            const np = [...sessionData.players]; const dupes = []; const added = [];
            names.forEach(name => { if (sessionData.players.includes(name)) dupes.push(name); else { np.push(name); added.push(name); } });
            if (dupes.length) alert(`ì´ë¯¸ ì¶”ê°€ëœ í”Œë ˆì´ì–´: ${dupes.join(', ')}`);
            if (added.length) socket.emit('updateTeamPlayers', { players: np });
            playerNameInput.value = '';
        });
        playerNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addPlayerBtn.click(); });

        addTeamBtn.addEventListener('click', () => {
            const total = sessionData.players.length; const assigned = sessionData.teamConfig.reduce((s,t)=>s+(t.size||t.count||0),0); const rem = total-assigned;
            if (rem===0 && total>0) { alert('íŒ€ êµ¬ì„±ì´ ì´ë¯¸ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'); return; }
            let name = teamNameInput.value.trim(); const size = parseInt(teamSizeInput.value);
            if (!size||size<1) { alert('ì¸ì›ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”'); return; }
            if (!name) name = `${sessionData.teamConfig.length+1}íŒ€`;
            if (size>rem && rem>0) { alert(`ë‚¨ì€ ì¸ì›(${rem}ëª…)ë³´ë‹¤ ë§ì€ ì¸ì›ì„ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`); return; }
            socket.emit('updateTeamConfig', { config: [...sessionData.teamConfig, { name, size, requiredPlayers: [] }] });
            teamNameInput.value = ''; teamSizeInput.value = '';
        });

        addRequiredPlayersBtn.addEventListener('click', () => {
            if (currentTeamIndexForRequiredPlayers===null) { alert('ë¨¼ì € íŒ€ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
            const sel = []; requiredPlayersCheckboxes.querySelectorAll('input[type="checkbox"]:checked:not(:disabled)').forEach(cb=>sel.push(cb.value));
            if (!sel.length) { alert('í•„ìˆ˜ í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; }
            const team = sessionData.teamConfig[currentTeamIndexForRequiredPlayers]; if (!team) { currentTeamIndexForRequiredPlayers=null; return; }
            const newReq = [...new Set([...(team.requiredPlayers||[]),...sel])];
            if (newReq.length>(team.size||team.count)) { alert(`í•„ìˆ˜ í”Œë ˆì´ì–´ ìˆ˜ê°€ íŒ€ ì¸ì›(${team.size||team.count}ëª…)ë³´ë‹¤ ë§ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`); return; }
            const cfg = [...sessionData.teamConfig]; cfg[currentTeamIndexForRequiredPlayers] = { ...team, requiredPlayers: newReq };
            socket.emit('updateTeamConfig', { config: cfg });
            requiredPlayersCheckboxes.querySelectorAll('input:checked').forEach(cb=>cb.checked=false);
            currentTeamIndexForRequiredPlayers = null; addRequiredPlayersBtn.textContent = 'í•„ìˆ˜ í”Œë ˆì´ì–´ ì¶”ê°€';
        });

        addRestrictionBtn.addEventListener('click', () => {
            const cbs = restrictionPlayersCheckboxes.querySelectorAll('input[type="checkbox"]:checked');
            const sel = Array.from(cbs).map(cb=>cb.value); if (sel.length<2) { alert('ìµœì†Œ 2ëª… ì´ìƒ ì„ íƒí•˜ì„¸ìš”'); return; }
            const sorted = [...sel].sort((a,b)=>a.localeCompare(b,'ko'));
            const nr = [...sessionData.restrictions]; let cnt = 0;
            for (let i=0;i<sorted.length;i++) for (let j=i+1;j<sorted.length;j++) { if (!nr.some(r=>(r[0]===sorted[i]&&r[1]===sorted[j])||(r[0]===sorted[j]&&r[1]===sorted[i]))) { nr.push([sorted[i],sorted[j]]); cnt++; } }
            if (!cnt) { alert('ì´ë¯¸ ëª¨ë‘ ì¶”ê°€ë˜ì–´ ìˆìŠµë‹ˆë‹¤'); return; }
            const ng = [...(sessionData.restrictionGroups||[])]; ng.push({ members: sorted });
            socket.emit('updateTeamRestrictions', { restrictions: nr, restrictionGroups: ng }); cbs.forEach(cb=>cb.checked=false);
        });

        assignTeamsBtn.addEventListener('click', () => {
            if (!sessionData.players.length) { alert('í”Œë ˆì´ì–´ë¥¼ ë¨¼ì € ì„¤ì •í•˜ì„¸ìš”'); return; }
            if (!sessionData.teamConfig.length) { alert('íŒ€ êµ¬ì„±ì„ ë¨¼ì € ì„¤ì •í•˜ì„¸ìš”'); return; }
            const slots = sessionData.teamConfig.reduce((s,t)=>s+(t.size||t.count||0),0);
            if (sessionData.players.length!==slots) { alert(`í”Œë ˆì´ì–´ ìˆ˜(${sessionData.players.length})ì™€ íŒ€ ì¸ì› ìˆ˜(${slots})ê°€ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.`); return; }
            socket.emit('assignTeams');
        });
        resetBtn.addEventListener('click', () => { if (confirm('ê²°ê³¼ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) socket.emit('resetTeamResult'); });

        function joinRoom(roomId) {
            const nickname = nicknameInput.value.trim(); if (!nickname) { alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”'); nicknameInput.focus(); return; }
            localStorage.setItem('teamUserName', nickname);
            socket.emit('joinRoom', { roomId, userName: nickname, isHost: false, password: '', deviceId: getDeviceId() });
        }
        window.joinRoom = joinRoom;
        function removePlayer(i) { socket.emit('updateTeamPlayers', { players: sessionData.players.filter((_,idx)=>idx!==i) }); }
        window.removePlayer = removePlayer;
        function removeTeam(i) { if (currentTeamIndexForRequiredPlayers===i) { currentTeamIndexForRequiredPlayers=null; addRequiredPlayersBtn.textContent='í•„ìˆ˜ í”Œë ˆì´ì–´ ì¶”ê°€'; } socket.emit('updateTeamConfig', { config: sessionData.teamConfig.filter((_,idx)=>idx!==i) }); }
        window.removeTeam = removeTeam;
        function selectTeamForRequiredPlayers(ti) { currentTeamIndexForRequiredPlayers=ti; updateRequiredPlayersCheckboxes(); const t=sessionData.teamConfig[ti]; if(t) addRequiredPlayersBtn.textContent=`${t.name}ì— í•„ìˆ˜ ì¶”ê°€`; }
        window.selectTeamForRequiredPlayers = selectTeamForRequiredPlayers;
        function removeRestrictionGroup(gi) {
            if (!sessionData.restrictionGroups||gi>=sessionData.restrictionGroups.length) return;
            const grp = sessionData.restrictionGroups[gi]; const ng = sessionData.restrictionGroups.filter((_,i)=>i!==gi);
            const nr = sessionData.restrictions.filter(r => { const inG = grp.members.includes(r[0])&&grp.members.includes(r[1]); if (!inG) return true; return ng.some(g=>g.members.includes(r[0])&&g.members.includes(r[1])); });
            socket.emit('updateTeamRestrictions', { restrictions: nr, restrictionGroups: ng });
        }
        window.removeRestrictionGroup = removeRestrictionGroup;

        // --- UI ---
        function updateRoomList(rooms) {
            if (!roomList) return; roomList.innerHTML = '';
            const tr = rooms.filter(r=>r.gameType==='team');
            if (!tr.length) { roomList.innerHTML = '<p class="text-center text-slate-400 text-sm py-10">ìƒì„±ëœ ë°©ì´ ì—†ìŠµë‹ˆë‹¤</p>'; return; }
            if (activeRoomCount) activeRoomCount.textContent = tr.length;
            tr.forEach(room => {
                const d = document.createElement('div');
                d.className = 'flex items-center justify-between px-5 py-3 border-b border-slate-50 last:border-0 hover:bg-slate-50 transition cursor-pointer';
                d.innerHTML = `<div class="min-w-0"><div class="text-sm font-bold text-slate-700 truncate">${room.roomName}</div><div class="text-xs text-slate-400">${room.hostName||'?'} Â· ${room.playerCount}ëª…</div></div><button class="shrink-0 ml-3 px-3 py-1.5 text-xs font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg transition" onclick="joinRoom('${room.roomId}')">ì°¸ê°€</button>`;
                roomList.appendChild(d);
            });
        }

        function showSession(hostName, roomName) {
            landingSection.style.display = 'none'; sessionSection.style.display = 'block';
            if (currentHostName) currentHostName.textContent = hostName||'?';
            if (currentRoomName) currentRoomName.textContent = roomName||'ë°©';
            if (isHost) {
                roleBadge.textContent = 'í˜¸ìŠ¤íŠ¸'; roleBadge.className = 'inline-block px-1.5 py-0.5 rounded text-[10px] font-bold bg-indigo-100 text-indigo-700';
                if (deleteRoomBtn) deleteRoomBtn.style.display = 'inline';
            } else {
                roleBadge.textContent = 'ê´€ì „ì'; roleBadge.className = 'inline-block px-1.5 py-0.5 rounded text-[10px] font-bold bg-slate-100 text-slate-500';
                if (deleteRoomBtn) deleteRoomBtn.style.display = 'none';
            }
            updateHostUI();
        }

        function updateParticipants() {
            if (!participantsList||!participantsCount) return;
            participantsCount.textContent = currentUsers.length; participantsList.innerHTML = '';
            if (!currentUsers.length) { participantsList.innerHTML = '<span class="text-xs text-slate-400">ì—†ìŒ</span>'; return; }
            currentUsers.forEach(u => {
                const b = document.createElement('span');
                b.className = 'inline-block px-2 py-0.5 bg-indigo-50 text-indigo-700 text-xs font-semibold rounded-full';
                b.textContent = `${u.isHost?'ğŸ‘‘ ':''}${u.name}`;
                participantsList.appendChild(b);
            });
        }

        function updateHostUI() {
            if (!isHost) {
                hostControls.querySelectorAll('input').forEach(el=>el.style.display='none');
                hostControls.querySelectorAll('#add-player-btn,#add-team-btn,#add-restriction-btn,#assign-teams-btn,#reset-btn,#add-required-players-btn').forEach(b=>b.style.display='none');
                const g = hostControls.querySelector('.player-input-guide'); if (g) g.style.display = 'none';
            } else {
                hostControls.querySelectorAll('input,button,.player-input-guide').forEach(el=>el.style.display='');
            }

            playerCountBadge.textContent = sessionData.players.length;
            playersList.innerHTML = '';
            sessionData.players.forEach((p,i) => {
                const d = document.createElement('div');
                d.className = 'flex items-center justify-between px-3 py-1.5 bg-slate-50 rounded-lg group';
                const del = isHost ? `<button class="text-[11px] font-bold text-red-400 opacity-0 group-hover:opacity-100 transition" onclick="removePlayer(${i})">ì‚­ì œ</button>` : '';
                d.innerHTML = `<span class="text-sm text-slate-700">${p}</span>${del}`;
                playersList.appendChild(d);
            });

            const total = sessionData.players.length, assigned = sessionData.teamConfig.reduce((s,t)=>s+(t.size||t.count||0),0), rem = total-assigned;
            teamAssignmentBadge.textContent = `(${rem}/${total})`;
            teamAssignmentBadge.style.color = rem===0?'#16a34a':rem<0?'#dc2626':'#6366f1';

            teamConfigList.innerHTML = '';
            sessionData.teamConfig.forEach((t,i) => {
                const d = document.createElement('div');
                d.className = 'flex items-center justify-between px-3 py-1.5 bg-slate-50 rounded-lg group';
                const sz=t.size||t.count||0; const req=t.requiredPlayers?.length?` Â· í•„ìˆ˜: ${t.requiredPlayers.join(',')}` :'';
                const del = isHost?`<button class="text-[11px] font-bold text-red-400 hover:text-red-600 transition" onclick="removeTeam(${i})">ì‚­ì œ</button>`:'';
                const reqBtn = isHost?`<button class="text-[11px] font-bold text-indigo-500 hover:text-indigo-700 transition mr-2" onclick="selectTeamForRequiredPlayers(${i})">í•„ìˆ˜</button>`:'';
                d.innerHTML = `<span class="text-sm"><span class="font-bold text-indigo-600">${t.name}</span> <span class="text-slate-400">â€” ${sz}ëª…${req}</span></span><div class="flex items-center">${reqBtn}${del}</div>`;
                teamConfigList.appendChild(d);
            });
            updateRestrictionsList(); updateRequiredPlayersCheckboxes(); updateRestrictionCheckboxes(); updateTeamAssignmentCount();
        }

        function updateRequiredPlayersCheckboxes() {
            if (!requiredPlayersCheckboxes) return; requiredPlayersCheckboxes.innerHTML = '';
            if (!sessionData.players.length) { requiredPlayersCheckboxes.innerHTML = '<p class="col-span-full text-center text-xs text-slate-400 py-3">í”Œë ˆì´ì–´ë¥¼ ë¨¼ì € ì¶”ê°€í•˜ì„¸ìš”</p>'; return; }
            const pm = new Map(); sessionData.teamConfig.forEach(t=>{if(t.requiredPlayers)t.requiredPlayers.forEach(p=>pm.set(p,t.name));});
            sessionData.players.forEach(p => {
                const taken=pm.has(p); const cur=currentTeamIndexForRequiredPlayers!==null?sessionData.teamConfig[currentTeamIndexForRequiredPlayers]:null; const inCur=cur?.requiredPlayers?.includes(p); const dis=taken&&!inCur;
                const l = document.createElement('label');
                l.className = `flex items-center gap-1.5 px-2 py-1 rounded cursor-pointer text-xs transition ${dis?'opacity-40':'hover:bg-slate-100 text-slate-700'}`;
                l.innerHTML = `<input type="checkbox" value="${p}" ${dis?'disabled':''} class="w-3.5 h-3.5 rounded border-slate-300 text-indigo-600"><span>${p}${dis?` (${pm.get(p)})`:''}</span>`;
                requiredPlayersCheckboxes.appendChild(l);
            });
        }
        function updateRestrictionCheckboxes() {
            if (!restrictionPlayersCheckboxes) return; restrictionPlayersCheckboxes.innerHTML = '';
            if (!sessionData.players.length) { restrictionPlayersCheckboxes.innerHTML = '<p class="col-span-full text-center text-xs text-slate-400 py-3">í”Œë ˆì´ì–´ë¥¼ ë¨¼ì € ì¶”ê°€í•˜ì„¸ìš”</p>'; return; }
            sessionData.players.forEach(p => {
                const l = document.createElement('label');
                l.className = 'flex items-center gap-1.5 px-2 py-1 rounded cursor-pointer hover:bg-slate-100 text-xs text-slate-700 transition';
                l.innerHTML = `<input type="checkbox" value="${p}" class="w-3.5 h-3.5 rounded border-slate-300 text-red-500"><span>${p}</span>`;
                restrictionPlayersCheckboxes.appendChild(l);
            });
        }
        function updateRestrictionsList() {
            if (!restrictionsList) return; restrictionsList.innerHTML = '';
            if (!sessionData.restrictionGroups?.length) { restrictionsList.innerHTML = '<p class="text-center text-xs text-slate-400 py-2">ì œì•½ ì¡°ê±´ ì—†ìŒ</p>'; return; }
            sessionData.restrictionGroups.forEach((g,i) => {
                if (!g.members?.length) return; const sorted=[...g.members].sort((a,b)=>a.localeCompare(b,'ko'));
                const d = document.createElement('div'); d.className = 'flex items-center justify-between px-3 py-1.5 bg-slate-50 rounded-lg group';
                const del = isHost?`<button class="text-[11px] font-bold text-red-400 opacity-0 group-hover:opacity-100 transition" onclick="removeRestrictionGroup(${i})">ì‚­ì œ</button>`:'';
                d.innerHTML = `<span class="text-xs"><span class="font-bold text-red-500">${sorted.join(', ')}</span> <span class="text-slate-400">ê°™ì€ íŒ€ ë¶ˆê°€</span></span>${del}`;
                restrictionsList.appendChild(d);
            });
        }
        function updateTeamAssignmentCount() {
            if (!teamAssignmentCount) return; const p=sessionData.players,tc=sessionData.teamConfig;
            if(!p.length||!tc.length){teamAssignmentCount.textContent='';return;}
            const slots=tc.reduce((s,t)=>s+(t.size||t.count||0),0); if(p.length!==slots){teamAssignmentCount.textContent='';return;}
            const f=n=>n<=1?1:n*f(n-1); let den=1; tc.forEach(t=>{den*=f((t.size||t.count||0)-(t.requiredPlayers?.length||0));});
            const rem=p.length-tc.reduce((s,t)=>s+(t.requiredPlayers?.length||0),0);
            teamAssignmentCount.textContent=`(ì´ ${Math.floor(f(rem)/den).toLocaleString('ko-KR')}ê°€ì§€)`;
        }

        function showResult(result) {
            resultSection.style.display = 'block'; if (isHost) resetBtn.style.display = 'inline';
            if (result.success) {
                resultMessage.className = 'text-center px-3 py-2 rounded-lg text-sm font-semibold mb-4 bg-emerald-50 text-emerald-700 border border-emerald-200';
                resultMessage.textContent = result.message||`${result.attempts||1}ë²ˆ ì‹œë„ í›„ ì„±ê³µ`;
                resultTeams.innerHTML = '';
                result.teams.forEach(team => {
                    const sorted=[...team.members].sort((a,b)=>a.localeCompare(b,'ko'));
                    const d = document.createElement('div');
                    d.className = 'p-4 bg-indigo-50 border border-indigo-200 rounded-xl';
                    d.innerHTML = `<h4 class="text-center text-sm font-bold text-indigo-700 mb-2">${team.name}</h4><ul class="space-y-1">${sorted.map(m=>`<li class="px-2.5 py-1.5 bg-white rounded-lg text-xs font-medium text-slate-700">${m}</li>`).join('')}</ul>`;
                    resultTeams.appendChild(d);
                });
            } else {
                resultMessage.className = 'text-center px-3 py-2 rounded-lg text-sm font-semibold mb-4 bg-red-50 text-red-700 border border-red-200';
                resultMessage.innerHTML = 'âŒ '+(result.message||result.error||'íŒ€ ë°°ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                resultTeams.innerHTML = '';
            }
        }
        function hideResult() { resultSection.style.display = 'none'; resetBtn.style.display = 'none'; }

        // --- Socket ---
        socket.on('connect', () => {
            const el=document.getElementById('teamConnectionStatus');
            if(el){el.innerHTML='<span class="status-dot connected"></span>ì—°ê²°ë¨';el.className='flex items-center gap-1.5 text-xs text-emerald-600';}
            socket.emit('getRooms');
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('createRoom')==='true') { const pd=localStorage.getItem('pendingTeamRoom'); if(pd){try{const rd=JSON.parse(pd);localStorage.removeItem('pendingTeamRoom');window.history.replaceState({},document.title,window.location.pathname);if(nicknameInput)nicknameInput.value=rd.userName;if(roomNameInput)roomNameInput.value=rd.roomName;socket.emit('createRoom',{userName:rd.userName,roomName:rd.roomName,isPrivate:rd.isPrivate||false,password:rd.password||'',gameType:'team',expiryHours:rd.expiryHours||3,blockIPPerUser:rd.blockIPPerUser||false,deviceId:getDeviceId()});return;}catch(e){localStorage.removeItem('pendingTeamRoom');}}}
            if (urlParams.get('joinRoom')==='true') { const pd=localStorage.getItem('pendingTeamJoin'); if(pd){try{const jd=JSON.parse(pd);localStorage.removeItem('pendingTeamJoin');window.history.replaceState({},document.title,window.location.pathname);sessionStorage.setItem('teamFromDice','true');document.getElementById('loadingScreen').style.display='flex';landingSection.style.display='none';if(nicknameInput)nicknameInput.value=jd.userName;let pw='';if(jd.isPrivate){pw=prompt('ğŸ”’ ë¹„ê³µê°œ ë°©ì…ë‹ˆë‹¤.\në¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:');if(pw===null){sessionStorage.removeItem('teamFromDice');window.location.href='/dice-game-multiplayer.html';return;}}socket.emit('joinRoom',{roomId:jd.roomId,userName:jd.userName,isHost:false,password:pw,deviceId:getDeviceId()});return;}catch(e){localStorage.removeItem('pendingTeamJoin');}}}
            const sr=sessionStorage.getItem('teamCurrentRoomId'); if(sr){const nn=localStorage.getItem('teamUserName')||'';if(nn){currentRoomId=sr;isHost=sessionStorage.getItem('teamIsHost')==='true';socket.emit('joinRoom',{roomId:sr,userName:nn,isHost,password:'',deviceId:getDeviceId()});}}
        });
        socket.on('disconnect', () => { const el=document.getElementById('teamConnectionStatus'); if(el){el.innerHTML='<span class="status-dot disconnected"></span>ì—°ê²° ëŠê¹€';el.className='flex items-center gap-1.5 text-xs text-red-500';} });
        socket.on('roomsList', updateRoomList);
        socket.on('roomsListUpdated', updateRoomList);
        socket.on('roomCreated', (data) => {
            currentRoomId=data.roomId;isHost=true;saveRoomState();
            const hn=nicknameInput.value.trim()||data.userName; currentUsers=[{name:hn,isHost:true,id:socket.id}];
            sessionData={players:data.teamPlayers||[],teamConfig:(data.teamConfig||[]).map(c=>({name:c.name,size:c.size||c.count||0,requiredPlayers:c.requiredPlayers||[]})),restrictions:data.teamRestrictions||[],restrictionGroups:data.teamRestrictionGroups||[],result:null};
            landingSection.style.display='none';sessionSection.style.display='block';
            if(currentHostName)currentHostName.textContent=hn;if(currentRoomName)currentRoomName.textContent=data.roomName||'ë°©';
            roleBadge.textContent='í˜¸ìŠ¤íŠ¸';roleBadge.className='inline-block px-1.5 py-0.5 rounded text-[10px] font-bold bg-indigo-100 text-indigo-700';
            if(deleteRoomBtn)deleteRoomBtn.style.display='inline'; updateParticipants();updateHostUI();
        });
        socket.on('roomJoined', (data) => {
            sessionStorage.removeItem('teamFromDice');document.getElementById('loadingScreen').style.display='none';
            currentRoomId=data.roomId;isHost=data.isHost;saveRoomState();currentUsers=data.gameState?.users||[];
            sessionData={players:data.teamPlayers||[],teamConfig:(data.teamConfig||[]).map(c=>({name:c.name,size:c.size||c.count||0,requiredPlayers:c.requiredPlayers||[]})),restrictions:data.teamRestrictions||[],restrictionGroups:data.teamRestrictionGroups||[],result:data.teamResult||null};
            landingSection.style.display='none';sessionSection.style.display='block';
            showSession(data.gameState?.users?.find(u=>u.isHost)?.name||'?',data.roomName);updateParticipants();
            if(sessionData.result?.success)showResult(sessionData.result);
        });
        socket.on('roomLeft', ()=>{clearRoomState();currentUsers=[];sessionData={players:[],teamConfig:[],restrictions:[],restrictionGroups:[],result:null};window.location.href='/dice-game-multiplayer.html';});
        socket.on('roomDeleted', (d)=>{alert(d.message||'ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');clearRoomState();window.location.href='/dice-game-multiplayer.html';});
        socket.on('roomError', (msg)=>{
            if(sessionStorage.getItem('teamFromDice')==='true'){sessionStorage.removeItem('teamFromDice');alert(msg);window.location.href='/dice-game-multiplayer.html';return;}
            document.getElementById('loadingScreen').style.display='none';landingSection.style.display='block';alert(msg);
            if(msg.includes('ì°¾ì„ ìˆ˜ ì—†')||msg.includes('ì¡´ì¬í•˜ì§€ ì•Š')||msg.includes('ì¤‘ë³µ')){clearRoomState();sessionSection.style.display='none';}
        });
        socket.on('updateUsers', (users)=>{
            if(window.SoundManager)SoundManager.playSound('common_notification',getTeamSoundEnabled());
            currentUsers=users;updateParticipants();
            const me=users.find(u=>u.id===socket.id);if(me&&me.isHost!==isHost){isHost=me.isHost;showSession(users.find(u=>u.isHost)?.name,currentRoomName?.textContent);if(isHost)alert('í˜¸ìŠ¤íŠ¸ ê¶Œí•œì´ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤!');}
        });
        socket.on('teamPlayersUpdated', (p)=>{sessionData.players=p;updateHostUI();});
        socket.on('teamConfigUpdated', (c)=>{sessionData.teamConfig=c.map(x=>({name:x.name,size:x.size||x.count||0,requiredPlayers:x.requiredPlayers||[]}));updateHostUI();});
        socket.on('teamRestrictionsUpdated', (r)=>{sessionData.restrictions=r;updateHostUI();});
        socket.on('teamRestrictionGroupsUpdated', (d)=>{sessionData.restrictionGroups=d.restrictionGroups||[];if(d.restrictions)sessionData.restrictions=d.restrictions;updateHostUI();});
        socket.on('teamAssigned', (r)=>{sessionData.result=r;showResult(r);});
        socket.on('teamResultReset', ()=>{sessionData.result=null;hideResult();});
        socket.on('teamError', (m)=>alert(m));
        socket.on('newMessage', ()=>{});

        const TEAM_SOUND_KEY='teamSoundEnabled';
        function getTeamSoundEnabled(){return localStorage.getItem(TEAM_SOUND_KEY)==='true';}
        document.addEventListener('DOMContentLoaded',()=>{const c=document.getElementById('teamSoundCheckbox');if(c)c.checked=getTeamSoundEnabled();if(c)c.addEventListener('change',()=>localStorage.setItem(TEAM_SOUND_KEY,c.checked?'true':'false'));});
    </script>
</body>
</html>
